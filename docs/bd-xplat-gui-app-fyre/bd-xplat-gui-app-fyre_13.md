# 第十章：*第十章*：分发 – 应用商店及其他

跨平台开发的最终挑战是如何将您的应用程序分发到系统应用商店、移动市场和下载站点。无论您是想通过平台特定的应用商店、包管理器还是通过简单的下载站点进行分发，都需要做更多的工作。本章探讨了将应用程序分发给系统应用商店、移动市场和下载站点的步骤。

本章将涵盖以下主题：

+   为发布构建应用程序

+   将应用程序分发到桌面应用商店

+   将应用程序上传到 Google Play 和 iOS 应用商店

到本章结束时，您应该具备将您的应用程序分发到任何平台的知识。

# 技术要求

本章与*第三章*的要求相同，*窗口、画布和绘图*，即需要安装**Fyne**工具包，并且**Go**和**C**编译器正在运行。更多信息，请参阅该章节。

对于部署到**Android**设备，您需要安装**Android SDK**和**NDK**（见*附录 B*，*移动构建工具的安装*）。要为**iOS**设备构建，您还需要在您的**Macintosh**计算机上安装**Xcode**（由于许可原因，需要苹果 Mac）。

本章的完整源代码可以在[`github.com/PacktPublishing/Building-Cross-Platform-GUI-Applications-with-Fyne/tree/master/Chapter10`](https://github.com/PacktPublishing/Building-Cross-Platform-GUI-Applications-with-Fyne/tree/master/Chapter10)找到。

# 为发布构建应用程序

正如我们在*第九章*中看到的，*捆绑资源和准备发布*，`fyne package`命令将我们的应用程序二进制文件和元数据打包成可以在`fyne release`上安装的格式。

在本节中，我们将学习如何使用`release`命令为共享准备应用程序。

## 运行发布命令

就像我们在*第九章*中看到的`fyne` `package`命令一样，*捆绑资源和准备发布*，这个新的`release`命令负责将我们的应用程序及其元数据打包。然而，`release`命令会对应用程序进行更改，以准备分发。具体更改将根据操作系统而有所不同，但通常包括以下内容：

+   关闭任何调试输出

+   指示应用程序使用*生产*身份验证的 Web 服务

+   将应用程序打包成特定于分发的存档

+   申请应用商店所需的认证

在我们学习本章的过程中，我们将查看每个平台特有的选项，但在本节中，我们可以探索如何为任何操作系统适配应用程序的发布构建。

让我们假设在我们的应用程序中有一个名为`connectToServer()`的函数，它将启动与公司服务之一的网络连接。在整个开发过程中，它一直连接到开发服务器，但对我们分发的应用程序，我们希望使用**生产**（有时称为*实时*）服务器。

以下步骤演示了如何使用此类构建来适当地调整代码以适应发布：

1.  为了构建这个演示，我们创建一个新的`main.go`文件，定义了两种不同的服务器认证密钥，`serverKeyDevelopment`和`serverKeyProduction`：

    ```go
    const (
        serverKeyDevelopment = "DEVELOPMENT_KEY"
        serverKeyProduction  = "PRODUCTION_KEY"
    )
    ```

1.  接下来，我们添加一个简单的函数，该函数打开一个对话框窗口，显示将要使用的认证密钥：

    ```go
    func connectToServer(a fyne.App, w fyne.Window) {
        key := serverKeyDevelopment
        if a.Settings().BuildType() == fyne.BuildRelease {
            key = serverKeyProduction
        }
        dialog.ShowInformation("Connect to server",
            "Using key: "+key, w)
    }
    ```

    如您所见，此函数接受当前的`fyne.App`作为参数之一，这样我们就可以使用`BuildType()`函数查询构建类型。第二个是当前的`fyne.Window`参数，我们使用它来显示此示例的对话框。此类函数通常会返回服务器连接，但这只是一个简单的演示。

1.  就像之前的示例一样，我们还需要创建一个基本的`main`函数来运行示例。在这种情况下，我们打开一个新窗口，显示简单的`connectToServer`方法，将演示构建类型：

    ```go
    func main() {
        a := app.New()
        w := a.NewWindow("Server key demo")
        w.SetContent(widget.NewLabel("Connecting..."))
        w.Resize(fyne.NewSize(300, 160))
        connectToServer(a, w)
        w.ShowAndRun()
    }
    ```

1.  现在我们简单地运行应用程序：

    ```go
    $ go run .
    ```

    您应该看到它创建了一个窗口，如下面的截图所示：

    ![图 10.1 – 开发模式下的运行

    ![图 10.1 – 开发模式下的运行

    图 10.1 – 开发模式下的运行

1.  接下来，让我们构建用于发布的应用程序。由于我们现在正在打包应用程序元数据，我们需要一个图标文件。书中包含了示例文件`Icon.png`，但您也可以添加任何喜欢的图标，将其放置在`main.go`旁边。然后我们可以使用`fyne`工具准备发布版本：

    ```go
    $ fyne release
    ```

1.  通过双击应用程序运行打包的应用程序，您应该看到不同的输出：

![图 10.2 – 发布模式下的运行

![图 10.2 – 发布模式下的运行

图 10.2 – 发布模式下的运行

上述示例是关于`release`命令及其如何调整应用程序行为的简单介绍。随着我们在本章中使用它，您将看到各种系统为认证和其他功能所需的附加参数。我们本可以在此处添加有关版本和构建号（使用`-appVersion`和`-appBuild`）的信息，但对于大多数桌面发布来说，这是可选的。我们将在本章的后面部分开始将其添加到命令中。

现在应用程序已在此部分捆绑，我们可以将其分发给*测试人员*或小型社区，他们愿意通过从网络下载来管理自己的软件安装。

## 在网络上分享您的应用

现在应用程序已设置好，在适当的地方使用生产值，我们可以开始制定分发计划。在许多情况下，`fyne release`创建的文件将与`fyne package`（因为此命令专注于应用程序商店和市场分发）的文件格式不同。要将发布参数应用于之前的包格式，您可以使用`fyne package –release`。

如果您想在不用平台官方分发的情况下分享您的应用程序，可以通过将`release`命令的结果上传到网站或文件共享平台来实现。在大多数情况下，这只是一个简单地将文件复制或上传到您想要分享的地方。然而，在某些系统（主要是 macOS）中，应用程序是一个包或目录，这可能无法通过网站链接下载。在这些情况下，将文件集压缩或归档成一个可下载的单个文件是一个好主意。

在您的 mac（macOS 应用程序通常创建的地方）中，您可以在**Finder**中打开应用程序文件夹，右键单击包，然后从上下文菜单中选择**压缩 <filename>**选项，如下所示：

![图 10.3 – 压缩 macOS 应用程序包以便在网络上共享]

![img/Figure_10.3_B16820.jpg]

图 10.3 – 压缩 macOS 应用程序包以便在网络上共享

生成的`.zip`文件可以更容易地从网站共享，下载它的人只需双击文件即可展开您的应用程序，然后可以像平常一样运行。

在本节中，我们了解了如何打包应用程序以供发布，以及如何共享生成的文件，以便他人可以安装我们的软件。然而，对于大多数应用程序来说，通过提供的商店或市场进行分发将更有益。在接下来的几节中，我们将逐步介绍这一过程，针对最常见的操作系统。

# 将应用程序分发到桌面应用程序商店

大多数桌面操作系统现在都有一个用于发现和安装应用程序的中心位置。苹果创建了**Mac App Store**，Windows 有**Microsoft Store**，每个 Linux 发行版都有自己的首选包管理器。将应用程序列在（并由平台市场托管）可以显著增加您预期的用户数量，并降低相关的托管成本。当与精心准备的元数据（如第九章，*捆绑资源和准备发布*）相结合时，市场可以轻松成为您最大的分发渠道。

在本节中，我们将逐步介绍 macOS 和 Windows 商店的过程。我们将在本章的后面部分回到 Linux 和 BSD 分发，因为它们不太主流，而且更加复杂。

## Mac App Store

Mac App Store 是苹果公司著名的 iOS App Store 的桌面版本。它提供了成千上万的应用程序可供购买和下载，或赠送给他人。此外，还有精选内容，包括各种类别中最受欢迎的应用程序列表，以及员工精选和推荐软件。不幸的是，Mac App Store 不能在线浏览，因为它需要预安装在兼容 Mac 电脑上的 App Store 软件。

要在 App Store 上分发应用程序，你需要安装开发工具（参见*附录 B*，*移动构建工具的安装*)），但你还需要注册**Apple Developer Program**。如果你还不是会员，你可以在[developer.apple.com/programs/enroll/](http://developer.apple.com/programs/enroll/)注册。开发资源是免费访问的，但为了访问代码签名工具，你需要支付年度订阅费用，这些工具是完成我们即将探讨的发布过程所必需的。

### 打包 macOS 发布版本

将发布版本打包上传到 Mac App Store 的过程类似于我们在本章前面探索的发布过程，但我们还必须提供适用于对应用程序进行**代码签名**的认证细节。

代码签名是一个复杂的设置过程，因此在本描述中，我们假设你已经安装了分发证书。有关下载证书的进一步说明，请参阅苹果公司的文档[developer.apple.com/support/certificates/](http://developer.apple.com/support/certificates/)。你需要注意证书的名称（稍后使用`build`命令时需要。你还需要注意你正在使用的配置文件。与证书一样，这应该已经下载并安装在你的电脑上，但你需要注意其名称（你可以在苹果开发者门户[developer.apple.com/account/resources/certificates/](http://developer.apple.com/account/resources/certificates/)上找到更多详细信息）。

一旦你确定了证书名称和配置文件，你就可以使用以下命令中的详细信息：

```go
$ fyne release -appVersion 1.0 -appBuild 1 -certificate "CertificateName" -profile "ProfileName"
```

生成的应用包已准备好上传到**App Store Connect**网站进行验证。

### 上传到 Mac App Store

App Store 应用程序通过 App Store Connect 网站（[appstoreconnect.apple.com/](http://appstoreconnect.apple.com/)）进行管理。使用你的苹果开发者账户登录并创建一个新的应用程序（如果你还没有这样做）。这是你添加将在商店中显示的元数据的地方——务必仔细检查信息，因为一些数据在发布后无法更改。

选择的描述和截图将有助于您的应用程序更容易被发现。在此应用程序定义中，您需要开始准备一个新版本，包括适当的版本号和相关支持信息。您可能会注意到您还不能选择构建版本——为了启用此功能，我们首先需要上传编译包。

苹果公司最近创建了一个名为**Transporter**的新应用程序，目前这是上传新构建版本最简单的方式。您可以按照以下步骤进行操作：

1.  打开 Transporter 应用程序，并使用您的**Apple ID**登录。

1.  登录后，您将被要求选择要上传的应用程序——选择上一节中由`release`命令创建的应用程序包，然后进行上传。

1.  一旦完成，构建版本将出现在 App Store Connect 网站上（您可能需要刷新页面）。如果您更喜欢使用命令行工具来管理上传进度，可以使用**xcrun altool**，它提供相同的功能。无论您以何种方式上传包，您都需要在网站上的应用程序详情中选择相应的构建版本。

1.  一旦选择了这个新构建版本，您就可以点击**提交审查**按钮开始审查流程。

我们现在将进入下一节，了解审查流程。

### Mac App Store 审查流程

一旦应用程序提交审查，它就会通过一系列自动的代码检查。这个过程验证应用程序不包含元数据或代码签名中的明显错误，并执行代码分析以确保您没有使用苹果公司专有的或受限制的 API。假设这些自动检查通过，那么应用程序将被发送给 App Store 审查团队的成员进行最终接受。

审查团队会检查您的应用程序的质量、可靠性、是否符合**人类界面指南**（**HIG**：[developer.apple.com/app-store/review/](http://developer.apple.com/app-store/review/)），以及它是否符合商店收录的其他标准。这个过程通常需要一两天，但新应用程序的首个版本可能需要更长的时间。一旦这个过程完成，您的软件将可在 App Store 上购买或下载。在您的第一周分发期间，它甚至可能被包含在**新功能和值得注意**部分。

既然我们已经了解了 Mac App Store 的流程，让我们看看微软商店的流程。

## 微软商店

**微软商店**是查找和安装所有当前**Windows**、**Windows Phone**和**Xbox**设备软件、应用程序和游戏的官方位置。它提供托管和搜索功能，以及处理付费软件的支付，还支持折扣和优惠券。您可以在网上浏览微软商店的内容（在[www.microsoft.com/store/apps](http://www.microsoft.com/store/apps)），或者通过使用它支持的每个系统上的商店应用程序。

要将应用程序提交到微软商店，你需要一个微软账户（如果你已经登录过 Windows、Xbox 或 **Office 365**，你可能已经有了账户）。你还需要开始一个年度订阅，以便访问合作伙伴门户的相关部分。你可以在 [partner.microsoft.com/en-US/dashboard/apps/signup](http://partner.microsoft.com/en-US/dashboard/apps/signup) 登录和注册。

### Windows 发布打包

准备微软商店的发布包与之前我们做的打包过程非常相似，但作为一个发布资产，它将需要应用版本号。就像在 macOS 应用商店一样，我们需要对软件进行签名。如果你还没有这样做，请确保下载你的证书，并注意其名称。Windows 应用使用一个组合版本号，例如 `1.2.3.4`，但 `fyne` 工具将其分为两部分。为了打包特定版本的软件，将最后一个数字作为 `-appBuild` 传递，其余版本作为 `-appVersion`，如下所示：

```go
$ fyne release -appVersion 1.2.3 -appBuild 4 –certificate "CertificateName" -password "MyPassword"
```

此命令的输出将是一个 `.appx` 文件。此文件是上传到商店所需的包类型，不应以其他方式共享。

### 上传到微软商店

完成的包应上传到合作伙伴门户的 **包** 页面。在准备上传时，请确保你的所有应用程序元数据都已添加到正确的位置，以便人们可以轻松找到你的软件。一旦包上传，它将检查可能阻止其发布的各种错误。如果你遇到任何警告，你需要从门户中删除已上传的构建版本，修复问题，并上传一个新的包以重新测试。

### 微软商店审查流程

一旦你的包上传并通过初步验证，它将被添加到队列中等待审查。微软工作人员将审查你的应用程序的正确性和适用性，并验证其是否具有足够高的质量，可以包含在商店中。假设所有这些检查都通过，他们将在你提交过程中指定的设备上发布它。

在下一节中，我们将了解 Linux 和 BSD 发行版。

## Linux 和 BSD 发行版

Linux 和 BSD 发行版在处理包分发方面享有良好声誉；桌面系统可能有一个图形包管理应用程序，它提供易于搜索的索引，包含数千个包。尽管有数百种不同的 Linux 和 BSD 发行版，但它们都基于类似的二进制文件和文件结构。

### Linux/Unix 打包

在本章开头“为发布构建”部分创建的`.tar.gz`文件是 Linux 和 BSD 系统打包 Fyne 应用的基础。该文件的内容将在打包目标分发时进行适配。通过添加平台特定的元数据和运行文件的包命令，您可以创建适合您首选分发的包。

### Linux 软件包的审核流程

一旦为系统创建了包，应用程序开发者可以将其提交到包列表。对于每个系统，请求添加的方法可能不同，但通常可以在项目文档中找到。然而，由于 Linux 和 BSD 是开源系统，您可能会发现现有的包维护者可能愿意为您做这件事。

在本节中，我们看到了如何使用可用的工具完成 Linux 和 BSD 的打包。结合*Mac App Store*和*Microsoft Store*部分，涵盖了如何在大多数主要桌面操作系统上分发您的应用。接下来，我们将看到如何调整这种方法以将移动应用程序上传到适当的分发渠道。

# 上传应用到 Google Play 和 iOS App Store

管理移动平台的发布可能稍微复杂一些，因为应用不能直接在我们构建它们的设备上进行测试。然而，Fyne 发布流程旨在涵盖所有平台，因此在本节中，我们将看到如何使用相同的工具发布到移动设备商店。

## iOS App Store

为 iOS 打包应用与本章前面描述的 macOS 分发流程非常相似。您需要安装**Xcode**，并从 Apple 开发者门户[developer.apple.com/account/resources/certificates/](http://developer.apple.com/account/resources/certificates/)准备和下载分发证书和配置文件。

### 打包 iOS 发布版本

对于 iOS 发布包命令，我们在我们的 Mac 系统上运行以下命令，记得添加`-os ios`参数：

```go
$ fyne release -os ios -appVersion 1.0 -appBuild 1 -certificate "CertificateName" -profile "ProfileName"
```

前面命令生成的文件将是一个`.ipa`文件，这是上传 iOS 应用到 App Store 所需的格式。一旦您有了这个文件，就可以使用本章前面*Mac App Store*部分中描述的相同流程上传。

### iOS App Store 审核流程

iOS 应用的审核流程与 Mac App Store 非常相似。提交构建版本将启动一个自动检查流程，通常只需几分钟。之后，将进行人工审核，这可能需要几天时间，但在繁忙时期对复杂应用的审核通常在一周内完成。

在下一节中，我们将查看 Google Play Store 流程。

## Google Play Store

将 Android 应用打包到 Google Play 商店需要我们将版本信息和我们的认证应用到包文件中。再次强调，`fyne release` 命令将处理此操作，但我们需要收集相关信息。版本信息可以像之前构建那样传递，但 Android 的认证不同。

### 打包 Android 发布版本

Android 应用的认证信息存储在 `.keystore` 文件中。如果您之前已经分发过 Android 应用，您可能已经有一个。如果是第一次，您需要设置您的开发者凭据，包括私钥和证书。更多详细信息可在官方文档[developer.android.com/studio/publish/app-signing](http://developer.android.com/studio/publish/app-signing)中找到。请确保您的 **keystore** 安全，因为它将用于发布您应用的未来版本。

一旦找到包含此信息的 keystore，您就可以开始发布流程。使用与其他构建相同的版本信息，我们将运行带有额外 `-keyStore` 参数的 `fyne release` 命令，该参数后面跟着文件的路径。完整的命令看起来可能如下所示：

```go
$ fyne release -os android -appVersion 1.0 -appBuild 1 -keyStore "path/to/file.keystore"
```

确保您有密码和可选的密钥别名在手，因为命令将要求提供额外信息以完成签名过程。这将产生一个类似于之前开发打包的 `.apk` 文件，但带有为上传准备的签名细节。您可以考虑将文件重命名为标记其为发布版本，这样在您再次开始开发时就不会产生混淆。

### 上传到 Play Console

要将您的应用程序上传到 Google Play 商店，您需要登录到 **Play Console**（如果您尚未注册，将收取少量费用）[play.google.com/console/](http://play.google.com/console/)。登录后，您就可以开始创建新应用程序的过程。在这里，您将上传元数据、图标和其他营销材料，就像之前探索的 Apple iOS 应用商店一样。

在 `release` 命令中，确保文件与在线元数据匹配。填写完信息后，找到 `.apk` 文件（或轻触 **上传** 按钮选择它）。上传完成后，它将经过一些自动化检查以确认兼容性。如果在此阶段有任何问题，您可以返回项目进行更改，以发布模式重新构建文件，并上传替换文件。

### Play 商店审查流程

一旦您的应用程序提交到 Google Play Console，您就可以通过审查过程跟踪其进度。检查过程中有一些手动环节，可能会导致等待时间约为一天或两天。**谷歌**指出，在某些情况下，可能需要进行额外的检查，这可能需要长达 7 天或更长时间。这通常发生在新用户账户或应用程序首次发布时。一旦批准，您的应用程序将在所有支持的 Android 设备上的 Play 商店中可见。

# 摘要

在最后一章中，我们探讨了如何使用 Fyne 工具打包和分发图形应用程序。与命令行或系统工具的分发不同，交付 GUI 应用程序的过程需要额外的元数据和打包，以便与每个操作系统良好集成。我们看到了基本发布流程如何创建一个适用于分发到我们开发和测试团队成员之外的应用程序包。

为不同平台打包可能会很复杂，因此我们详细介绍了构建原生外观的图形包的步骤，包括适用于 macOS、Windows 和 Linux 的图形包，以及适用于 iOS 和 Android 的移动打包。每个包都有自己的元数据格式和包结构，但这些都是通过使用 `fyne` `release` 工具自动生成的。

我们还看到了如何构建用于在官方商店分发的发布包，以及如何将这些包提交到将在用户设备上预先安装的应用商店或市场。Windows、macOS、iOS 和 Android 商店为应用程序在发布后赚取收入提供了机会，而 Linux 软件列表将有助于提高我们软件包的可见性。

在学习了使用 Fyne 开发图形应用程序的各个方面之后，我们已经完成了从开发到发布的全过程。希望这个指南对您有所帮助，并使您能够创建您一直想要构建的应用程序，并在各种操作系统上让它在您的所有设备上运行。

如果您想将您的应用程序分发给社区，请考虑通过访问 [developer.fyne.io/submit](http://developer.fyne.io/submit) 在 Fyne 应用列表中分享它。
