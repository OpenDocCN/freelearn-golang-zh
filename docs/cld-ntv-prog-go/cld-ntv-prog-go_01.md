# 现代微服务架构

在计算和软件领域，我们几乎每周都会听到许多新的、酷炫的技术和框架。有些技术会留存并持续发展，而其他一些则无法经受时间的考验而消失。毫无疑问，云计算非常舒适地属于前一类。我们生活在一个云计算几乎支配着一切需要严肃的后端计算能力的世界，从检查冰箱温度的物联网设备到向你展示多人游戏中实时得分与同伴相比较的视频游戏。

云计算使遍布全球的大型企业以及在咖啡店写代码的两个人的小型初创公司受益匪浅。有大量的材料解释了为什么云计算对现代信息技术如此重要。为了效率起见，我们将直接回答这个问题，而不会列出长长的要点、图表和冗长的段落。对于企业来说，一切都是为了赚钱和节省成本。云计算显著降低了大多数组织的成本。这是因为云计算节省了建立自己数据中心的成本。不需要购买昂贵的硬件，也不需要委托昂贵的带有花哨空调系统的建筑。此外，几乎所有的云计算服务都可以让你只支付你使用的部分。云计算还为软件工程师和 IT 管理员提供了巨大的灵活性，使他们能够快速高效地完成工作，从而实现开发人员的幸福和增加生产力。

在本章中，我们将涵盖以下主题：

+   云原生应用的设计目标，尤其是可扩展性

+   不同的云服务模型

+   十二要素应用

+   微服务架构

+   通信模式，尤其是同步与异步通信

# 为什么选择 Go？

Go（或 Golang）是一种相对较新的编程语言，正在以其独特之处席卷软件开发世界。它是由谷歌开发的，旨在简化其后端软件服务的构建。然而，现在许多企业和初创公司都在使用它来编写强大的应用程序。Go 的独特之处在于，它从头开始构建，旨在提供与 C/C++等非常强大的语言竞争的性能，同时支持类似 JavaScript 等动态语言的相对简单的语法。Go 运行时提供垃圾回收；但它不依赖虚拟机来实现。Go 程序被编译成本机代码。在调用 Go 编译器时，你只需选择构建时希望二进制文件在哪个平台（Windows、Mac 等）上运行。编译器将会生成适用于该平台的单个二进制文件。这使得 Go 能够进行交叉编译并生成本机二进制文件。

Go 语言非常适合微服务架构，这在未来会变得非常普遍。微服务架构是一种架构，其中你将应用程序的责任分配给只专注于特定任务的较小服务。这些服务可以相互通信，以获取它们需要产生结果的信息。

Go 是一种新的编程语言，是在云计算时代开发的，考虑了现代软件技术。由于 Go 程序大多编译为单个二进制文件，使得在生产环境中几乎不需要依赖和虚拟机，因此 Go 被优化用于便携式微服务架构。Go 也是容器技术的先驱。**Docker**，软件容器的顶级名称，就是用 Go 编写的。由于 Go 的流行，主要云提供商以及第三方贡献者正在努力确保 Go 获得其在不同云平台所需的 API 支持。

本书的目标是在 Go 编程语言和现代计算的云技术之间建立知识桥梁。在本书中，您将获得关于 Go 微服务架构、消息队列、容器、云平台 Go API、SaaS 应用程序设计、监控云应用程序等方面的实际知识。

# 基本设计目标

为了充分利用现代云平台的优势，我们在开发应用程序时需要考虑其特性属性。

云应用程序的主要设计目标之一是**可扩展性**。一方面，这意味着根据需要增加应用程序的资源，以有效地为所有用户提供服务。另一方面，它还意味着在不再需要这些资源时将资源缩减到适当的水平。这使您能够以成本效益的方式运行应用程序，而无需不断地为高峰工作负载进行过度配置。

为了实现这一点，典型的云部署通常使用托管应用程序的小型虚拟机实例，并通过添加（或移除）更多这些实例来进行扩展。这种扩展方法称为**水平扩展**或**横向扩展**，与**垂直扩展**或**纵向扩展**相对应，后者不增加实例数量，而是为现有实例提供更多资源。出于几个原因，水平扩展通常优于垂直扩展。首先，水平扩展承诺无限的线性可扩展性。另一方面，由于现有服务器可以添加的资源数量不能无限增长，垂直扩展存在其限制。其次，水平扩展通常更具成本效益，因为您可以使用廉价的通用硬件（或在云环境中使用较小的实例类型），而较大的服务器通常会呈指数增长地更加昂贵。

![](img/0d2cad23-ebf1-486b-8494-78877ecf4fff.png)

水平扩展与垂直扩展；前者通过添加更多实例并在它们之间平衡工作负载来工作，而后者通过向现有实例添加更多资源来工作

所有主要的云提供商都提供根据应用程序当前资源利用率自动执行水平扩展的能力。这个功能称为**自动扩展**。不幸的是，您并不能免费获得水平扩展。为了能够进行扩展，您的应用程序需要遵循一些非常重要的设计目标，这些目标通常需要从一开始就考虑，如下所示：

+   **无状态性**：云应用程序的每个实例都不应该有任何内部状态（这意味着任何类型的数据都保存在内存中或文件系统上以备后用）。在扩展场景中，后续请求可能由应用程序的另一个实例提供服务，因此必须不依赖于之前请求中存在任何状态。为了实现这一点，通常需要将任何类型的持久存储（如数据库和文件系统）外部化。数据库服务和文件存储通常由您在应用程序中使用的云提供商作为托管服务提供。

当然，这并不意味着你不能将有状态的应用部署到云上。它们只是会更难以扩展，阻碍你充分利用云计算环境。

+   **部署简便性**：在扩展时，您需要快速部署应用程序的新实例。创建新实例不应该需要任何手动设置，而应尽可能自动化（理想情况下完全自动化）。

+   **弹性**：在云环境中，特别是在使用自动扩展时，实例可能会在瞬间被关闭。此外，大多数云服务提供商不保证单个实例的极高可用性（并建议进行扩展，可选地跨多个可用区）。因此，终止和突然死亡（无论是有意的，例如自动扩展，还是无意的，例如故障）是我们在云环境中始终需要预期的事情，应用程序必须相应地处理。

实现这些设计目标并不总是容易的。云服务提供商通常通过提供托管服务（例如高度可扩展的数据库服务或分布式文件存储）来支持您完成这项任务，否则您将不得不自己担心这些问题。关于您的实际应用程序，有**十二要素应用**方法论（我们将在后面的部分详细介绍），它描述了构建可扩展和有弹性的应用程序的一套规则。

# 云服务模型

在云计算提供中，有三种主要的服务模型可供您考虑：

+   **IaaS**（**基础设施即服务**）：这是云服务提供商为您提供云上基础设施的模型，例如服务器（虚拟和裸金属）、网络、防火墙和存储设备。当您只需要云提供商为您管理基础设施并摆脱维护的麻烦和成本时，您可以使用 IaaS。创业公司和希望对应用程序层拥有完全控制的组织使用 IaaS。大多数 IaaS 提供都带有动态或弹性扩展选项，根据您的消耗来扩展您的基础设施。这实际上可以节省组织的成本，因为他们只支付他们使用的部分。

+   **PaaS**（**平台即服务**）：这是从 IaaS 上一层的服务。PaaS 提供了您运行应用程序所需的计算平台。PaaS 通常包括您开发应用程序所需的操作系统、数据库、Web 层（如果需要）和编程语言执行环境。使用 PaaS，您不必担心应用程序环境的更新和补丁；这些都由云服务提供商来处理。假设您编写了一个强大的.NET 应用程序，希望在云中运行。PaaS 解决方案将提供您运行应用程序所需的.NET 环境，结合 Windows 服务器操作系统和 IIS Web 服务器。它还将负责大型应用程序的负载平衡和扩展。想象一下，通过采用 PaaS 平台而不是在内部进行努力，您可以节省多少金钱和精力。

+   **SaaS**（**软件即服务**）：这是作为云解决方案可以获得的最高层。SaaS 解决方案是指通过网络交付的完全功能的软件。您可以从 Web 浏览器访问 SaaS 解决方案。SaaS 解决方案通常由软件的普通用户使用，而不是程序员或软件专业人员。一个非常著名的 SaaS 平台的例子是 Netflix——一个复杂的软件，托管在云中，可以通过网络访问。另一个流行的例子是 Salesforce。Salesforce 解决方案通过 Web 浏览器以速度和效率交付给客户。

# 云应用架构模式

通常，在云环境中开发应用程序并不比常规应用程序开发有太大的不同。然而，在针对云环境时，有一些特别常见的架构模式，你将在下一节中学到。

# 十二要素应用

十二要素应用方法论是一组用于构建可扩展和具有弹性的云应用程序的规则。它由 Heroku 发布，是主要的 PaaS 提供商之一。然而，它可以应用于各种云应用程序，独立于具体的基础设施或平台提供商。它也独立于编程语言和持久化服务，并且同样适用于 Go 编程和例如 Node.js 编程。十二要素应用方法论描述了（不出所料的）十二个因素，你应该在应用程序中考虑这些因素，以便它易于扩展、具有弹性并且独立于平台。你可以在[`12factor.net`](https://12factor.net/)上阅读每个因素的完整描述。在本书中，我们将重点介绍一些我们认为特别重要的因素：

+   **因素 II：依赖-明确声明和隔离依赖**：这个因素值得特别提及，因为在 Go 编程中它实际上并不像在其他语言中那么重要。通常，云应用程序不应该依赖于系统上已经存在的任何必需的库或外部工具。依赖应该被明确声明（例如，使用 Node.js 应用程序的 npm `package.json`文件），这样一个包管理器在部署应用程序的新实例时可以拉取所有这些依赖。在 Go 中，一个应用程序通常部署为一个已经包含所有必需库的静态编译二进制文件。然而，即使是一个 Go 应用程序也可能依赖于外部系统工具（例如，它可以调用像 ImageMagick 这样的工具）或现有的 C 库。理想情况下，你应该将这些工具与你的应用程序一起部署。这就是容器引擎（如 Docker）的优势所在。

+   **因素 III：配置-在环境中存储配置**：配置是可能因不同部署而变化的任何类型的数据，例如外部服务和数据库的连接数据和凭据。这些类型的数据应该通过环境变量传递给应用程序。在 Go 应用程序中，获取这些数据就像调用`os.Getenv("VARIABLE_NAME")`一样简单。在更复杂的情况下（例如，当你有许多配置变量时），你也可以使用诸如`github.com/tomazk/envcfg`或`github.com/caarlos0/env`这样的库。对于繁重的工作，你可以使用`github.com/spf13/viper`库。

+   **因素 IV：后备服务-将后备服务视为附加资源**：确保应用程序依赖的服务（如数据库、消息系统或外部 API）可以通过配置轻松替换。例如，你的应用程序可以接受一个环境变量，比如`DATABASE_URL`，它可能包含`mysql://root:root@localhost/test`用于本地开发部署，以及`mysql://root:XXX@prod.XXXX.eu-central-1.rds.amazonaws.com`用于生产环境设置。

+   **因素 VI：进程-将应用程序作为一个或多个无状态进程执行**：运行应用程序实例应该是无状态的；任何需要持久化超出单个请求/事务的数据都需要存储在外部持久化服务中。

在构建可扩展和具有弹性的云应用程序时，有一个重要的案例需要牢记，那就是 Web 应用程序中的用户会话。通常，用户会话数据存储在进程的内存中（或者持久化到本地文件系统），期望同一用户的后续请求将由应用程序的同一实例提供。相反，尝试保持用户会话无状态，或者将会话状态移入外部数据存储，比如 Redis 或 Memcached。

+   **第九因素：可处置性-通过快速启动和优雅关闭最大限度地提高鲁棒性：**在云环境中，需要预期突然终止（无论是有意的，例如在缩减规模的情况下，还是无意的，在失败的情况下）。十二因素应用程序应具有快速的启动时间（通常在几秒钟的范围内），使其能够快速部署新实例。此外，快速启动和优雅终止是另一个要求。当服务器关闭时，操作系统通常会通过发送**SIGTERM**信号告诉您的应用程序关闭，应用程序可以捕获并做出相应反应（例如，停止监听服务端口，完成当前正在处理的请求，然后退出）。

+   **第十一因素：日志-将日志视为事件流：**日志数据通常用于调试和监视应用程序的行为。但是，十二因素应用程序不应关心其自己日志数据的路由或存储。最简单的解决方案是将日志流写入进程的标准输出流（例如，只需使用`fmt.Println(...)`）。将事件流式传输到`stdout`允许开发人员在开发应用程序时简单地观看事件流。在生产环境中，您可以配置执行环境以捕获进程输出并将日志流发送到可以处理的地方（这里的可能性是无限的-您可以将它们存储在服务器的**journald**中，将它们发送到 syslog 服务器，将日志存储在 ELK 设置中，或将它们发送到外部云服务）。

# 什么是微服务？

当一个应用程序在较长时间内由许多不同的开发人员维护时，它往往会变得越来越复杂。错误修复、新的或变化的需求以及不断变化的技术变化导致您的软件不断增长和变化。如果不加控制，这种软件演变将导致您的应用程序变得更加复杂和越来越难以维护。

防止这种软件侵蚀的目标是过去几年中出现的微服务架构范式。在微服务架构中，软件系统被分割成一组（可能很多）独立和隔离的服务。这些作为单独的进程运行，并使用网络协议进行通信（当然，这些服务中的每一个本身都应该是一个十二因素应用程序）。有关该主题的更全面介绍，我们可以推荐 Lewis 和 Fowler 在[`martinfowler.com/articles/microservices.html`](https://martinfowler.com/articles/microservices.html)上关于微服务架构的原始文章。

与传统的面向服务的架构（SOA）相比，这种架构已经存在了相当长的时间，微服务架构注重简单性。复杂的基础设施组件，如 ESB，应尽一切可能避免，而复杂的通信协议，如 SOAP，更倾向于更简单的通信方式，如 REST Web 服务（关于这一点，您将在第二章中了解更多，*使用 Rest API 构建微服务*）或 AMQP 消息传递（参见第四章，*使用消息队列的异步微服务架构*）。

将复杂软件拆分为单独的组件有几个好处。例如，不同的服务可以构建在不同的技术堆栈上。对于一个服务，使用 Go 作为运行时和 MongoDB 作为持久层可能是最佳选择，而对于其他组件，使用 Node.js 运行时和 MySQL 持久层可能是更好的选择。将功能封装在单独的服务中允许开发团队为正确的工作选择正确的工具。在组织层面上，微服务的其他优势是每个微服务可以由组织内的不同团队拥有。每个团队可以独立开发、部署和操作他们的服务，使他们能够以非常灵活的方式调整他们的软件。

# 部署微服务

由于它们专注于无状态和水平扩展，微服务与现代云环境非常匹配。然而，选择微服务架构时，总体上部署应用程序将变得更加复杂，因为您将需要部署更多不同的应用程序（这更加坚定了坚持十二要素应用程序方法论的理由）。

然而，每个单独的服务将比一个大型的单体应用程序更容易部署。根据服务的大小，将更容易将服务升级到新的运行时，或者完全替换为新的实现。此外，您可以单独扩展每个微服务。这使您能够在保持使用较少的组件成本高效的同时，扩展应用程序中使用频繁的部分。当然，这要求每个服务都支持水平扩展。

部署微服务在不同服务使用不同技术时变得更加复杂。现代容器运行时（如 Docker 或 RKT）提供了这个问题的一个可能解决方案。使用容器，您可以将应用程序及其所有依赖项打包到一个容器映像中，然后使用该映像快速生成一个在任何可以运行 Docker（或 RKT）容器的服务器上运行您的应用程序的容器。（让我们回到十二要素应用程序——在容器中部署应用程序是**要素 II**规定的依赖项隔离的最彻底解释之一。）

许多主要云提供商（如 AWS 的**弹性容器服务**、**Azure 容器服务**或**Google 容器引擎**）提供运行容器工作负载的服务。除此之外，还有容器编排引擎，如**Docker Swarm**、**Kubernetes**或**Apache Mesos**，您可以在 IaaS 云平台或自己的硬件上部署。这些编排引擎提供了在整个服务器集群上分发容器工作负载的可能性，并提供了非常高的自动化程度。例如，集群管理器将负责在任意数量的服务器上部署容器，根据它们的资源需求和使用自动分发它们。许多编排引擎还提供自动扩展功能，并且通常与云环境紧密集成。

您将在第六章中了解有关使用 Docker 和 Kubernetes 部署微服务的更多信息，*在容器中部署您的应用程序*。

# REST 网络服务和异步消息

在构建微服务架构时，您的各个服务需要相互通信。微服务通信的一个被广泛接受的事实标准是 RESTful 网络服务（关于这一点，您将在第二章和第三章中了解更多，*使用 Rest API 构建微服务*和*保护微服务*）。这些通常建立在 HTTP 之上（尽管 REST 架构风格本身更多或多少是协议独立的），并遵循请求/回复通信模型的客户端/服务器模型。

![](img/ee12981f-07fd-4efe-b986-a5914fb37798.png)

同步与异步通信模型

这种架构通常易于实现和维护。它适用于许多用例。然而，同步请求/响应模式在实现跨多个服务的复杂流程的系统时可能会受到限制。考虑前图的第一部分。在这里，我们有一个用户服务，管理应用程序的用户数据库。每当创建新用户时，我们需要确保系统中的其他服务也知道这个新用户。使用 RESTful HTTP，用户服务需要通过 REST 调用通知其他服务。这意味着用户服务需要知道所有其他受用户管理领域影响的服务。这导致组件之间的紧耦合，这通常是您希望避免的。

可以解决这些问题的另一种通信模式是发布/订阅模式。在这里，服务发出其他服务可以监听的事件。发出事件的服务不需要知道哪些其他服务实际上正在监听这些事件。再次考虑前图的第二部分—在这里，用户服务发布一个事件，说明刚刚创建了一个新用户。其他服务现在可以订阅此事件，并在创建新用户时得到通知。这些架构通常需要使用一个特殊的基础设施组件：消息代理。该组件接受发布的消息并将其路由到其订阅者（通常使用队列作为中间存储）。

发布/订阅模式是一种非常好的方法，可以将服务解耦—当一个服务发布事件时，它不需要关心它们将去哪里，当另一个服务订阅事件时，它也不知道它们来自哪里。此外，异步架构往往比同步通信更容易扩展。通过将消息分发给多个订阅者，可以轻松实现水平扩展和负载平衡。

不幸的是，没有免费的午餐；这种灵活性和可伸缩性是以额外的复杂性为代价的。此外，跨多个服务调试单个事务变得困难。是否接受这种权衡需要根据具体情况进行评估。

在第四章中，*使用消息队列的异步微服务架构*，您将了解更多关于异步通信模式和消息代理的信息。

# MyEvents 平台

在本书中，我们将构建一个名为*MyEvents*的有用的 SaaS 应用程序。MyEvents 将利用您将学习的技术，成为一个现代、可扩展、云原生和快速的应用程序。MyEvents 是一个活动管理平台，允许用户预订世界各地的活动门票。使用 MyEvents，您将能够为自己和同伴预订音乐会、嘉年华、马戏团等活动的门票。MyEvents 将记录预订、用户和活动举办地的不同位置。它将有效地管理您的预订。

我们将利用微服务、消息队列、ReactJS、MongoDB、AWS 等技术构建 MyEvents。为了更好地理解应用程序，让我们来看看我们的整体应用程序将要管理的逻辑实体。它们将由多个微服务管理，以建立明确的关注点分离，并实现我们需要的灵活性和可伸缩性：

![](img/86218de4-5f52-4787-b4ae-da6793c91daa.png)

我们将有多个用户；每个**用户**可以为事件预订多次，每个**预订**将对应一个**事件**。对于我们的每一个事件，都会有一个**位置**，事件发生的地方。在**位置**内，我们需要确定事件发生的**大厅**或房间。

现在，让我们来看看微服务架构和构成我们应用程序的不同组件：

![](img/0b450d72-d8b9-4a62-9d7a-e8ee0ef54b28.png)

微服务架构

我们将使用 ReactJS 前端与我们应用程序的用户进行交互。ReactJS UI 将使用 API 网关（AWS 或本地）与构成我们应用程序主体的不同微服务进行通信。有两个主要的微服务代表了 MyEvents 的逻辑：

+   **事件服务**：这是处理事件、它们的位置以及发生在它们身上的变化的服务

+   **预订服务**：此服务处理用户的预订

我们所有的服务将使用基于消息队列的发布/订阅架构进行集成。由于我们的目标是为您提供微服务和云计算领域的实用知识，我们将支持多种类型的消息队列。我们将支持**Kafka**、**RabbitMQ**和 AWS 的**SQS**。

持久层还将支持多种数据库技术，以便让您接触到各种实用的数据库引擎，从而增强您的项目。我们将支持**MongoDB**和**DynamoDB**。

我们所有的服务都将支持指标 API，这将允许我们通过**Prometheus**监控我们服务的统计数据。

MyEvents 平台的设计方式将为您构建微服务和云计算强大的知识基础和曝光。

# 摘要

在这个介绍性的章节中，您了解了云原生应用程序开发的基本设计原则。这包括设计目标，如支持（水平）可伸缩性和弹性，以及架构模式，如十二要素应用程序和微服务架构。

在接下来的章节中，您将学习在构建 MyEvents 应用程序时应用许多这些原则。在第二章中，*使用 Rest API 构建微服务*，您将学习如何使用 Go 编程语言实现提供 RESTful web 服务的小型微服务。在接下来的章节中，您将继续扩展这个小应用程序，并学习如何在各种云环境中处理部署和操作这个应用程序。
