# 附录 A：稳定的 Go 环境的良好实践

编写 Go 代码是一种有趣且愉快的体验，其中编译时错误——而不是痛苦——实际上会指导您编写健壮、高质量的代码。然而，偶尔会遇到环境问题，开始妨碍并打断您的工作流程。虽然通常可以在一些搜索和一些微调后解决这些问题，但正确设置开发环境可以大大减少问题，使您能够专注于构建有用的应用程序。

在本章中，我们将在新机器上从头开始安装 Go，并讨论我们拥有的一些环境选项以及它们可能在未来产生的影响。我们还将考虑协作如何影响我们的一些决定，以及开源我们的软件包可能会产生什么影响。

具体来说，我们将：

+   获取 Go 源代码并在开发机器上本地构建它

+   了解`GOPATH`环境变量的用途，并讨论其合理的使用方法

+   了解 Go 工具以及如何使用它们来保持我们代码的质量

+   学习如何使用工具自动管理我们的导入

+   考虑我们的`.go`文件的“保存时”操作，以及我们如何将 Go 工具集成为我们日常开发的一部分。

# 安装 Go

Go 是一个最初用 C 编写的开源项目，这意味着我们可以轻松地从代码中编译我们自己的版本；这仍然是安装 Go 的最佳选项，出于各种原因。它允许我们在需要稍后查找某些内容时浏览源代码，无论是在标准库 Go 代码中还是在工具的 C 代码中。它还允许我们轻松地更新到 Go 的新版本，或者在发布候选版本出现时进行实验，只需从代码存储库中拉取不同的标签或分支并重新构建。当然，如果需要，我们也可以轻松地回滚到早期版本，甚至修复错误并生成拉取请求发送给 Go 核心团队，以便他们考虑对项目的贡献。

### 注意

可以在[`golang.org/doc/install/source`](http://golang.org/doc/install/source)上找到一个不断更新的资源，用于在各种平台上从源代码安装 Go，或者通过搜索`Install Golang from source`。本章将涵盖相同的内容，但如果遇到问题，互联网将成为帮助解决问题的最佳途径。

## 安装 C 工具

由于 Go 工具链是用 C 编写的，因此在构建 Go 安装时实际上会编译 C 代码。这可能看起来有点反直觉；使用一种不同的编程语言编写了一种编程语言，但当然，当 Go 核心团队开始编写 Go 时，Go 并不存在，但 C 存在。更准确地说，用于构建和链接 Go 程序的工具是用 C 编写的。无论如何，现在我们需要能够编译 C 源代码。

### 注意

在 2014 年的丹佛科罗拉多州举行的首届 Gophercon 上，Rob Pike 和他的团队表示，他们的目标之一将是用 Go 编写的程序替换 C 工具链，以便整个堆栈都变成 Go。在撰写本文时，这还没有发生，因此我们将需要 C 工具。

要确定是否需要安装 C 工具，请打开终端并尝试使用`gcc`命令：

```go

gcc -v

```

如果收到`command not found`错误或类似错误，则可能需要安装 C 工具。但是，如果您看到`gcc`的输出给出版本信息（这就是`-v`标志的作用），则可能可以跳过此部分。

安装 C 工具因各种平台而异，并且随时间可能会发生变化，因此本节应该只被视为帮助您获取所需工具的粗略指南。

在运行 OS X 的 Mac 上，工具随 Xcode 一起提供，可在 App Store 免费获取。安装 Xcode 后，您打开**首选项**并导航到**下载**部分。从那里，您可以找到包含构建 Go 所需的 C 工具的命令行工具。

在 Ubuntu 和 Debian 系统上，您可以使用`apt-get`安装工具：

```go

sudo apt-get install gcc libc6-dev

```

对于 RedHat 和 Centos 6 系统，您可以使用`yum`安装工具：

```go

sudo yum install gcc glibc-devel

```

对于 Windows，MinGW 项目提供了一个 Windows 安装程序，可以为您安装工具。转到[`www.mingw.org/`](http://www.mingw.org/)并按照那里的说明开始。

一旦您成功安装了工具，并确保适当的二进制文件包含在您的`PATH`环境变量中，当运行`gcc -v`时，您应该能够看到一些合理的输出：

```go

Apple LLVM version 5.1 (clang-503.0.40) (based on LLVM 3.4svn)

Target: x86_64-apple-darwin13.2.0

Thread model: posix

```

上述片段是在 Apple Mac 计算机上的输出，最重要的是要查看是否缺少`command not found`错误。

## 从源代码下载和构建 Go

Go 源代码托管在 Google Code 的 Mercurial 存储库中，因此我们将使用`hg`命令克隆它以准备构建。

### 注意

如果您没有`hg`命令，您可以从[`mercurial.selenic.com/downloads`](http://mercurial.selenic.com/downloads)下载页面获取 Mercurial。

在终端中，要安装 Go，请转到适当的位置，例如 Unix 系统上的`/opt`，或 Windows 上的`C:\`。

通过输入以下命令获取 Go 的最新版本：

```go

hg clone -u release https://code.google.com/p/go

```

过一会儿，最新的 Go 源代码将下载到一个新的`go`文件夹中。

转到刚刚创建的`go/src`文件夹并运行`all`脚本，这将从源代码构建 Go 的实例。在 Unix 系统上，这是`all.bash`，在 Windows 上是`all.bat`。

一旦所有构建步骤完成，您应该注意到所有测试都已成功通过。

# 配置 Go

现在 Go 已安装，但为了使用工具，我们必须确保它已正确配置。为了更容易调用工具，我们需要将我们的`go/bin`路径添加到`PATH`环境变量中。

### 注意

在 Unix 系统上，您应该将 export `PATH=$PATH:/opt/go/bin`（确保这是您下载源代码时选择的路径）添加到您的`.bashrc`文件中。

在 Windows 上，打开**系统属性**（尝试右键单击**我的电脑**），在**高级**下，单击**环境变量**按钮，并使用 UI 确保`PATH`变量包含到您的`go/bin`文件夹的路径。

在终端中（您可能需要重新启动它以使更改生效），您可以通过打印`PATH`变量的值来确保这一点：

```go

echo $PATH

```

确保打印的值包含正确的路径到您的`go/bin`文件夹，例如，在我的机器上打印为：

```go

/usr/local/bin:/usr/bin:/bin:/opt/go/bin

```

### 注意

路径之间的冒号（在 Windows 上是分号）表明`PATH`变量实际上是一个文件夹列表，而不仅仅是一个文件夹。这表明在输入终端命令时，将搜索每个包含的文件夹。

现在我们可以确保我们刚刚构建的 Go 构建成功运行：

```go

go version

```

执行`go`命令（可以在您的`go/bin`位置找到）如下将为我们打印出当前版本。例如，对于 Go 1.3，您应该看到类似于：

```go

go version go1.3 darwin/amd64

```

## 获取正确的 GOPATH

`GOPATH`是另一个环境变量，用于指定 Go 源代码和已编译二进制包的位置（就像前一节中的`PATH`一样）。在您的 Go 程序中使用`import`命令将导致编译器在`GOPATH`位置查找您所引用的包。使用`go get`和其他命令时，项目将下载到`GOPATH`文件夹中。

虽然`GOPATH`位置可以包含一系列以冒号分隔的文件夹，例如`PATH`，并且您甚至可以根据您正在工作的项目来使用不同的`GOPATH`值，但强烈建议您为所有内容使用单个`GOPATH`位置，这是我们假设您将为本书中的项目所做的。

在您的`Users`文件夹中的某个地方，也许是`Work`子文件夹中，创建一个名为`go`的新文件夹。这将是我们的`GOPATH`目标，也是所有第三方代码和二进制文件的存放地，以及我们将编写 Go 程序和包的地方。使用在上一节设置`PATH`环境变量时使用的相同技术，将`GOPATH`变量设置为新的`go`文件夹。让我们打开一个终端并使用新安装的命令之一来获取一个我们要使用的第三方包：

```go

go get github.com/stretchr/powerwalk 

```

从`Stretchr`获取`powerwalk`库实际上会创建以下文件夹结构；`$GOPATH/src/github.com/stretchr/powerwalk`。您可以看到路径段在 Go 组织事物方面很重要，这有助于命名空间项目并使它们保持唯一。例如，如果您创建了自己的名为`powerwalk`的包，您不会将其保存在`Stretchr`的 GitHub 存储库中，因此路径将不同。

当我们在本书中创建项目时，您应该为它们考虑一个合理的`GOPATH`根目录。例如，我使用了`github.com/matryer/goblueprints`，如果您要`go get`它，实际上会在您的`GOPATH`文件夹中获得本书的所有源代码的完整副本！

# Go 工具

Go 核心团队早期做出的决定是，所有 Go 代码应该对每个说 Go 语言的人看起来熟悉和明显，而不是每个代码库都需要额外的学习才能让新程序员理解或处理它。当考虑到开源项目时，这是一个特别明智的做法，其中一些项目有数百名贡献者不断涌入和离开。

有一系列工具可以帮助我们达到 Go 核心团队设定的高标准，我们将在本节中看到其中一些工具的实际应用。

在您的`GOPATH`位置，创建一个名为`tooling`的新文件夹，并创建一个包含以下代码的新`main.go`文件：

```go
package main
import (
"fmt"
)
func main() {
return
var name string
name = "Mat"
fmt.Println("Hello ", name)
}
```

紧凑的空间和缺乏缩进是故意的，因为我们将要看一个随 Go 一起提供的非常酷的实用工具。

在终端中，导航到您的新文件夹并运行：

```go

go fmt

```

### 注意

在 2014 年的 Gophercon 在科罗拉多州丹佛市，大多数人都了解到，与其将这个小三合一发音为“格式”或“f, m, t”，实际上它是作为一个单词发音的。现在试着对自己说：“fhumt”；似乎计算机程序员没有说一个外星语言的话，他们就不够怪异！

您会注意到，这个小工具实际上已经调整了我们的代码文件，以确保我们的程序布局（或格式）符合 Go 标准。新版本要容易阅读得多：

```go
package main

import (
  "fmt"
)

func main() {
  return
  var name string
  name = "Mat"
  fmt.Println("Hello ", name)
}
```

`go fmt`命令关心缩进、代码块、不必要的空格、不必要的额外换行等。以这种方式格式化代码是一个很好的实践，可以确保您的 Go 代码看起来像所有其他 Go 代码。

接下来，我们将对我们的程序进行审查，以确保我们没有犯任何可能令用户困惑的错误或决定；我们可以使用另一个很棒的免费工具来自动完成这个过程：

```go

go vet

```

我们的小程序的输出指出了一个明显而显眼的错误：

```go

main.go:10: unreachable code

exit status 1

```

我们在函数顶部调用`return`，然后尝试在此之后做其他事情。`go vet`工具已经注意到了这一点，并指出我们的文件中有无法访问的代码。

### 提示

如果您在运行任何 Go 工具时遇到错误，通常意味着您必须获取该命令才能使用它。但是，在 vet 工具的情况下，您只需打开终端并运行：

```go
go get code.google.com/p/go.tools/cmd/vet
```

`go vet`不仅会捕捉到这样的愚蠢错误，它还会寻找程序的更微妙的方面，这将指导您编写尽可能好的 Go 代码。有关 vet 工具将报告的最新列表，请查看[`godoc.org/code.google.com/p/go.tools/cmd/vet`](https://godoc.org/code.google.com/p/go.tools/cmd/vet)上的文档。

我们将要使用的最后一个工具叫做`goimports`，由 Brad Fitzpatrick 编写，用于自动修复（添加或删除）Go 文件的`import`语句。在 Go 中导入一个包而不使用它是一个错误，显然尝试使用一个未导入的包也不会起作用。`goimports`工具将根据我们代码文件的内容自动重写我们的`import`语句。首先，让我们使用熟悉的命令安装`goimports`：

```go

go get code.google.com/p/go.tools/cmd/goimports

```

更新您的程序以导入一些我们不打算使用的包，并删除`fmt`包：

```go
import (
  "net/http"
  "sync"
)
```

当我们尝试通过调用`go run main.go`来运行我们的程序时，我们会看到我们得到了一些错误：

```go

./main.go:4: imported and not used: "net/http"

./main.go:5: imported and not used: "sync"

./main.go:13: undefined: fmt

```

这些错误告诉我们，我们已经导入了我们不使用的包，并且缺少了`fmt`包，为了继续，我们需要进行更正。这就是`goimports`发挥作用的地方：

```go

goimports -w *.go

```

我们正在使用`goimports`命令和`-w`写入标志，这将节省我们对所有以`.go`结尾的文件进行更正的任务。

现在看看您的`main.go`文件，注意`net/http`和`sync`包已被移除，而`fmt`包已被重新放回。

您可以争论切换到终端运行这些命令比手动操作需要更多时间，而在大多数情况下您可能是正确的，这就是为什么强烈建议您将 Go 工具与您的文本编辑器集成。

# 在保存时进行清理、构建和运行测试

由于 Go 核心团队为我们提供了`fmt`、`vet`、`test`和`goimports`等优秀的工具，我们将看一下一个被证明非常有用的开发实践。每当我们保存一个`.go`文件时，我们希望自动执行以下任务：

1.  使用`goimports`和`fmt`来修复我们的导入并格式化代码。

1.  检查代码是否有任何错误，并立即告诉我们。

1.  尝试构建当前包并输出任何构建错误。

1.  如果构建成功，请运行包的测试并输出任何失败。

因为 Go 代码编译速度如此之快（Rob Pike 曾经说过它并不快速构建，但它只是不像其他一切那样慢），所以我们可以在每次保存文件时轻松地构建整个包。对于运行测试也是如此，这有助于我们如果我们以 TDD 风格进行开发，体验非常好。每当我们对代码进行更改时，我们可以立即看到我们是否破坏了某些东西，或者对项目的其他部分产生了意外的影响。我们再也不会看到包导入错误了，因为我们的`import`语句已经被自动修复了，我们的代码也会在我们眼前被正确格式化。

一些编辑器可能不支持响应特定事件运行代码，比如保存文件，这给您留下了两个选择；您可以切换到更好的编辑器，或者编写自己的脚本文件以响应文件系统的更改。后一种解决方案不在本书的范围之内，相反，我们将专注于如何在流行的文本编辑器中实现这个功能。

## Sublime Text 3

Sublime Text 3 是一个在 OS X、Linux 和 Windows 上运行的编写 Go 代码的优秀编辑器，并且具有非常强大的扩展模型，这使得它易于定制和扩展。您可以从[`www.sublimetext.com/`](http://www.sublimetext.com/)下载 Sublime Text，并在决定是否购买之前免费试用。

感谢**DisposaBoy**（参见[`github.com/DisposaBoy`](https://github.com/DisposaBoy)），已经为 Go 创建了一个 Sublime 扩展包，实际上为我们提供了许多 Go 程序员实际上错过的功能和功能。我们将安装这个`GoSublime`包，然后在此基础上添加我们想要的保存功能。

在安装`GoSublime`之前，我们需要将 Package Control 安装到 Sublime Text 中。前往[`sublime.wbond.net/`](https://sublime.wbond.net/)，点击**Installation**链接，获取有关如何安装 Package Control 的说明。在撰写本文时，只需复制单行命令，并将其粘贴到 Sublime 控制台中即可，控制台可以通过从菜单中导航到**View** | **Show Console**来打开。

完成后，按*shift* + *command* + *P*，然后键入`Package Control: Install Package`，选择该选项后按*return*。稍等片刻（Package Control 正在更新其列表），将出现一个框，允许您通过输入并选择 GoSublime 来搜索并安装 GoSublime，然后按*return*。如果一切顺利，GoSublime 将被安装，编写 Go 代码将变得更加容易。

### 提示

现在您已经安装了 GoSublime，您可以按*command* + *.*，*command* + *2*（同时按下*command*键和句点，然后按下*command*键和数字*2*）打开一个包含该包详细信息的简短帮助文件。

Tyler Bunnell 是 Go 开源社区中另一个知名人物（参见[`github.com/tylerb`](https://github.com/tylerb)），我们将使用他的自定义来实现我们的保存功能。

按*command* + *.*，*command* + *5*打开 GoSublime 设置，并向对象添加以下条目：

```go
"on_save": [
  {
    "cmd": "gs9o_open", 
    "args": {
      "run": ["sh", "go build . errors && go test -i && go test && go vet && golint"],
      "focus_view": false
    }
  }
]
```

### 提示

注意，设置文件实际上是一个 JSON 对象，因此在添加`on_save`属性时，请确保不要损坏文件。例如，如果在之前和之后有属性，请确保逗号放置在适当的位置。

上述设置将告诉 Sublime Text 在保存文件时构建代码以查找错误，安装测试依赖项，运行测试并检查代码。保存设置文件（暂时不要关闭它），让我们看看它的效果。

从菜单中导航到**选择文件** | **打开…**并选择要打开的文件夹-现在让我们打开我们的`tooling`文件夹。Sublime Text 的简单用户界面清楚地表明，我们目前项目中只有一个文件，`main.go`。单击文件，添加一些额外的换行符，并添加和删除一些缩进。然后从菜单中导航到**文件** | **保存**，或按*command* + *S*。注意代码立即被清理了，只要你没有删除`main.go`中奇怪放置的`return`语句，你会注意到控制台已经出现，并且由于`go vet`的原因报告了问题：

```go

main.go:8: unreachable code

```

按住*command* + *shift*，双击控制台中无法到达的代码行将打开文件并将光标跳转到相关行。随着您继续编写 Go 代码，您会看到这个功能有多么有用。

如果您向文件添加了不需要的导入，您会注意到在使用`on_save`时会收到有关问题的通知，但它不会自动修复。这是因为我们还需要进行另一个调整。在与您添加`on_save`属性的相同设置文件中，添加以下属性：

```go
"fmt_cmd": ["goimports"]
```

这告诉 GoSublime 使用`goimports`命令而不是`go fmt`。再次保存此文件并返回到`main.go`。再次将`net/http`添加到导入中，删除`fmt`导入，并保存文件。注意未使用的包已被移除，`fmt`再次被放回。

# 摘要

在这个附录中，我们从源代码安装了自己的 Go 构建，这意味着我们可以轻松使用`hg`命令来保持我们的安装最新，或者在发布之前测试我们的测试功能。在孤独的夜晚，有整个 Go 语言代码供我们浏览也是很不错的。

你了解了`GOPATH`环境变量，并发现了将一个值用于所有项目的常见做法。这种方法极大地简化了在 Go 项目上的工作，否则你可能会继续遇到棘手的失败。

我们发现了 Go 工具集如何真正帮助我们生成高质量、符合社区标准的代码，任何其他程序员都可以轻松上手并进行开发，几乎不需要额外学习。更重要的是，我们看到了如何自动化使用这些工具意味着我们可以真正专注于编写应用程序和解决问题，这正是开发人员真正想要做的事情。

# 读累了记得休息一会哦~

公众号：古德猫宁李

+   电子书搜索下载

+   书单分享

+   书友学习交流

网站：沉金书屋 https://www.chenjin5.com

+   电子书搜索下载

+   电子书打包资源分享

+   学习资源分享
