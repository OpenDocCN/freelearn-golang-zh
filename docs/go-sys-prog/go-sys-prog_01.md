# 第一章：使用 Go 和 Unix 系统编程入门

操作系统是一种允许您与硬件通信的软件，这意味着没有操作系统，您无法使用硬件。Unix 是一种具有许多变体的操作系统，它们有许多共同点，包括它们的编程接口。

Unix 操作系统主要是用 C 语言编程的，而不是完全用汇编语言，这使得它可以在其他计算机架构上移植，而无需从头开始重写所有内容。重要的是要理解，即使您在 Unix 机器上开发 Go 程序，最终您的代码也会被翻译成 C 函数和系统调用，因为这是直接与 Unix 内核通信的唯一方式。与编写 C 代码相比，编写 Go 代码的主要好处是程序更小，bug 更少。您将在第三章中了解更多关于这个的内容，*高级 Go 特性*。

由于本书将使用 Go 语言，您需要在 Unix 机器上安装 Go 的一个版本。好消息是，几乎所有现代 Unix 系统，包括 macOS、Linux 和 FreeBSD 都有 Go 编程语言的端口。Windows 也有一个 Go 端口，但本书不涉及 Microsoft Windows。

尽管您的 Unix 变体很可能有一个 Go 软件包，但您也可以从[`golang.org/dl/`](https://golang.org/dl/)获取 Go。

在本章中，您将学习以下主题：

+   系统编程

+   Go 的优缺点

+   Unix 进程的状态

+   两个 Go 工具：`gofmt`和`godoc`

+   最新 Go 版本（1.8）的特性

# 本书的结构

本书分为三个部分。第一部分，包括本章，是关于 Go 和在开发系统软件时可能有用的 Go 特性：这并不意味着您在开发程序时应该使用所有这些特性。第二部分是关于文件、目录和进程编程，这是最常见的系统软件类型。第三部分探讨了在 Go 中使用 goroutines、Web 应用程序和网络编程，这是最高级的系统软件类型。好消息是，您不需要立即阅读本书的第三部分。

# 什么是系统编程？

系统编程是 Unix 机器上的一个特殊编程领域。请注意，系统编程并不局限于 Unix 机器：本书只涉及 Unix 操作系统。大多数与系统管理任务有关的命令，如磁盘格式化、网络接口配置、模块加载和内核性能跟踪，都是使用系统编程技术实现的。此外，在所有 Unix 系统上都可以找到的`/etc`目录包含处理 Unix 机器及其服务配置的纯文本文件，也是使用系统软件进行操作的。

您可以将系统软件的各个领域和相关系统调用分为以下几类：

+   **文件 I/O**：这个领域涉及文件读写操作，这是操作系统最重要的任务。文件输入和输出必须快速高效，最重要的是可靠。

+   **高级文件 I/O**：除了基本的输入和输出系统调用外，还有更高级的读写文件的方法，包括异步 I/O 和非阻塞 I/O。

+   **系统文件和配置**：这组系统软件包括允许您处理系统文件（如`/etc/passwd`）并获取系统特定信息（如系统时间和 DNS 配置）的函数。

+   **文件和目录**：这个集群包括允许程序员创建和删除目录以及获取文件或目录的所有者和权限等信息的函数和系统调用。

+   **进程控制**：这组软件允许您创建和与 Unix 进程交互。

+   **线程**：当一个进程有多个线程时，它可以执行多个任务。然而，线程必须被创建、终止和同步，这就是这组函数和系统调用的目的。

+   **服务器进程**：这一集合包括允许您开发服务器进程的技术，这些进程可以在后台执行，而无需活动终端。Go 在传统的 Unix 方式下编写服务器进程方面并不那么出色：但让我稍微解释一下。像 Apache 这样的 Unix 服务器使用`fork(2)`来创建一个或多个子进程（这个过程称为**forking**，指的是将父进程克隆成子进程），并继续从同一点执行相同的可执行文件，最重要的是，共享内存。虽然 Go 没有提供与`fork(2)`函数等效的功能，但这并不是问题，因为您可以使用 goroutines 来覆盖大部分`fork(2)`的用途。

+   **进程间通信**：这组函数允许在同一台 Unix 机器上运行的进程使用管道、FIFO、消息队列、信号量和共享内存等特性进行通信。

+   **信号处理**：信号为进程提供了处理异步事件的方法，这可能非常方便。几乎所有服务器进程都有额外的代码，允许它们使用该组的系统调用来处理 Unix 信号。

+   **网络编程**：这是开发利用 TCP/IP 在计算机网络上工作的应用程序的艺术，并不是系统编程本身。然而，大多数 TCP/IP 服务器和客户端都涉及系统资源、用户、文件和目录。因此，大多数情况下，您不能创建网络应用程序而不进行某种形式的系统编程。

系统编程的挑战在于您不能容忍不完整的程序；您要么有一个完全可用、安全的程序，可以在生产系统上使用，要么什么都没有。这主要是因为您不能信任最终用户和黑客。系统编程的关键困难在于错误的系统调用可能会使您的 Unix 机器行为异常，甚至更糟糕的是崩溃！

Unix 系统上的大多数安全问题通常来自错误实现的系统软件，因为系统软件中的错误可能会危及整个系统的安全。最糟糕的是，这可能会在使用某个特定软件多年后发生。

在编写系统软件时，您应该特别注意错误消息和警告，因为它们是帮助您理解发生了什么以及为什么您的程序没有按预期行为的朋友。简而言之，*文件未找到*和*没有足够的权限读取文件*错误消息之间存在着很大的区别。

在 Unix 首次引入时，编写系统软件的唯一方法是使用 C；如今，您可以使用包括 Go 在内的编程语言来编写系统软件，本书将介绍 Go。

您应该明白，使用 C 以外的编程语言开发系统软件的两个主要好处如下：

+   使用现代编程语言及其工具

+   简单性，通常您需要编写、调试和维护更少的代码

除了 Go，用于开发系统工具的其他良好选择包括 Python、Perl、Rust 和 Ruby。

# 学习系统编程

学习系统编程的唯一方法是使用本书作为参考和教程，开发自己的实用程序。起初，你会犯很多荒谬的错误，但随着你的进步，你会犯更少但更聪明和难以调试的错误！然而，在学习时尝试新事物是可以的。事实上，尝试新事物并失败是必要的，因为这意味着你真的在学习新东西。只要确保你不要使用生产 Web 服务器来学习系统编程。

如果你不知道要开发什么，可以从创建自己的版本开始，比如`ls(1)`、`mkdir(1)`、`ln(1)`、`wc(1)`和`which(1)`等现有的 Unix 命令行实用程序。你不必为每个实用程序创建一个功能齐全的版本，支持所有命令行选项；重要的是开发一个稳定和安全的版本，实现主要功能并且没有问题地运行。

能够教你在 C 中进行 Unix 系统编程的最好书籍是*W. Richard Stevens*的*Advanced Unix Programming in the Unix Environment*。它的第三版现在已经可以获取，但所有版本都很有用，包含大量宝贵的细节。

# 关于 Go

Go 是一种现代通用开源编程语言，于 2009 年底正式宣布。它起初是一个谷歌内部项目，受到了包括 C、Pascal、Alef 和 Oberon 在内的许多其他编程语言的启发。它的精神领袖是*Robert Griesemer*、*Ken Thomson*和*Rob Pike*，他们设计 Go 作为专业程序员构建可靠和健壮软件的语言。除了其语法和标准函数外，Go 还配备了一个相当丰富的标准库。

在撰写本书时，最新的稳定 Go 版本是 1.8，其中包括一些方便的新功能，包括以下内容：如果你以前没有使用过 Go，可以跳过这部分。

+   现在存在新的转换规则，允许你在满足一些条件的情况下轻松地在几乎相等的类型之间进行转换。你可以使用`go tool`命令修复`golang.org/x/net/name`形式的导入路径，而无需自己打开源文件。

+   该工具在某些情况下更加严格，在以前会产生误报的情况下更加宽松。

+   当 GOPATH 未定义时，现在有一个 GOPATH 环境变量的默认值。对于 Unix 系统，默认值是$HOME/go。

+   Go 运行时有各种改进，加快了 Go 的速度。

+   有一个`sort.slice()`函数，允许你通过提供比较器回调来对切片进行排序，而不是实现`sort.Interface`。

+   现在`http.Server`有一个`Shutdown`方法。

+   `database/sql`包有各种小改动，让开发人员对查询有更多控制。

+   你可以使用`go bug`命令创建 bug。

# 准备开始 Go

你可以使用这个命令轻松找到你的 Go 版本：

```go
$ go version
go version go1.7.5 darwin/amd64  
```

前面的输出来自 macOS 机器，因此有`darwin`字符串。Linux 机器会给出以下类型的输出：

```go
$ go version
go version go1.3.3 linux/amd64
```

在接下来的章节中，你将学到更多关于`go tool`的知识，你将一直使用它。

我可以想象，你一定迫不及待地想看一些 Go 代码；所以这里是著名的 Hello World 程序的 Go 版本：

```go
package main 

import "fmt" 

// This is a demonstrative comment! 
func main() { 
   fmt.Println("Hello World!") 
} 
```

如果你熟悉 C 或 C++，你会发现 Go 代码非常容易理解。包含 Go 代码的每个文件都以包声明开头，后面是所需的导入声明。包声明显示了该文件所属的包。请注意，除非你想在同一行上放置两个或更多个 Go 语句，否则不需要为成功终止 Go 语句使用分号。

在第二章中，*使用 Go 编写程序*，你将了解如何编译和执行 Go 代码。现在，只需记住 Go 源文件使用`.go`文件扩展名存储：你的任务是选择一个描述性的文件名。

在搜索与 Go 相关的信息时，使用`Golang`或`golang`作为 Go 编程语言的关键词，因为单词 Go 几乎可以在英语中的任何地方找到，这不会帮助你的搜索！

# 两个有用的 Go 工具

Go 发行版附带了大量工具，可以让你作为程序员的生活更轻松。其中最有用的两个是`gofmt`和`godoc`。

请注意，`go tool`本身也可以调用各种工具：你可以通过执行`go tool`来查看它们的列表。

`gofmt`实用程序以给定的方式格式化 Go 程序，这在不同的人要为一个大项目使用相同的代码时非常重要。你可以在[`golang.org/cmd/gofmt/`](https://golang.org/cmd/gofmt/)找到更多关于`gofmt`的信息。

以下是`hw.go`程序的格式不佳的版本，很难阅读和理解：

```go
$ cat unglyHW.go
package main

import
    "fmt"

// This is a demonstrative comment!
        func main() {
  fmt.Println("Hello World!")

}
```

处理前面的代码，保存为`unglyHW.go`并使用`gofmt`，会生成以下易于阅读和理解的输出：

```go
$ gofmt unglyHW.go
package main

import "fmt"

// This is a demonstrative comment!
func main() {
      fmt.Println("Hello World!")

}
```

记住`gofmt`实用程序不会自动保存生成的输出很重要，这意味着你应该使用`-w`选项后跟有效的文件名，或者将`gofmt`的输出重定向到一个新文件。

`godoc`实用程序允许你查看现有 Go 包和函数的文档。你可以在[`godoc.org/golang.org/x/tools/cmd/godoc`](http://godoc.org/golang.org/x/tools/cmd/godoc)找到更多关于`godoc`的信息。

你将经常使用`godoc`，因为它是学习 Go 函数细节的好工具。

以下截图显示了在终端上生成的`godoc`命令的输出，当要求有关`fmt`包的`Println()`函数的信息时：

![](img/b8c6c34f-8a9b-4b23-9ed3-1e5f5efaa474.png)

godoc 命令的输出

`godoc`的另一个方便功能是它可以启动自己的 web 服务器，并允许你使用 web 浏览器查看它的文档：

```go
$ godoc -http=:8080  
```

以下截图显示了在运行前一个命令时，通过访问`http://localhost:8080/pkg/`在 web 浏览器上获得的输出类型。你可以使用任何你想要的端口号，只要它还没有被使用：

![](img/180f5a7f-a97c-418e-a357-3b2149951724.png)

使用 web 浏览器中的 godoc 实用程序

程序员最重要的工具是他们用来编写源代码的编辑器。当我在 Mac 上时，我通常使用 TextMate 编辑器，但当我在不同的 Unix 机器上时，我更喜欢 vi。选择编辑器并不是一件容易的事，因为你将花费很多时间在它上面。然而，只要不在源代码文件中放入任何控制字符，任何文本编辑器都可以胜任。以下截图显示了 TextMate 编辑器的操作：

![](img/5ae80fd5-b3ca-4c88-a509-7f29faae8d5a.png)

TextMate 编辑器显示了一些 Go 代码的外观

# Go 的优缺点

Go 并不完美，但它有一些非常有趣的特性。Go 强大特性的列表包括以下内容：

+   Go 代码易于阅读和理解。

+   Go 希望开发者快乐，因为快乐的开发者写出更好的代码！

+   Go 编译器打印实用的警告和错误消息，帮助你解决实际问题。简而言之，Go 编译器是为了帮助你而不是让你的生活困难！

+   Go 代码是可移植的。

+   Go 是一种现代编程语言。

+   Go 支持过程化、并发和分布式编程。

+   Go 支持**垃圾回收**（**GC**），因此你不必处理内存分配和释放。然而，GC 可能会稍微减慢你的程序。

+   Go 没有预处理器，编译速度很快。因此，Go 可以用作脚本语言。

+   Go 可以构建 Web 应用程序。在 C 中构建 Web 应用程序除非使用非标准的外部库，否则效率不高。此外，Go 为程序员提供了一个简单的 Web 服务器用于测试目的。

+   标准的 Go 库提供了许多简化程序员工作的包。此外，标准的 Go 库中的方法事先经过测试和调试，这意味着它们大多数时间不包含错误。

+   Go 默认使用静态链接，这意味着生成的二进制文件可以轻松地传输到具有相同操作系统的其他计算机上。因此，开发人员不需要担心库、依赖项和不同的库版本。

+   您不需要 GUI 来开发、调试和测试 Go 应用程序，因为可以从命令行中使用 Go。

+   Go 支持 Unicode。这意味着您不需要任何额外的代码来打印多种人类语言的字符。

+   Go 保持概念正交，因为少量正交特性比许多重叠特性更好。

Go 的缺点列表包括以下内容：

+   嗯，Go 不是 C，这意味着您或您的团队应该学习一种新的编程语言来开发系统软件。

+   Go 没有直接支持面向对象的编程，这对于习惯以面向对象方式编写代码的程序员可能是一个问题。尽管如此，您可以在 Go 中使用组合来模拟继承。

+   Unix 首次推出时，C 是编写系统软件的唯一编程语言。如今，您还可以使用 Rust、C++和 Swift 来编写系统软件，这意味着不是每个人都会使用 Go。

+   C 仍然是系统编程中比其他任何编程语言都要快的主要原因是 Unix 是用 C 编写的。

无论编程语言的优点还是缺点，您都可以决定是否喜欢它。重要的是选择一种您喜欢并且能够完成您想要的工作的编程语言！就个人口味而言，我不喜欢 C++，尽管它是一种非常有能力的编程语言，我曾经用 C++编写过 FTP 客户端！此外，我从来不喜欢 Java。在个人口味上没有对错之分，所以不要为自己的选择感到内疚。

# Unix 进程的各种状态

严格来说，进程是一个包含指令、用户数据和系统数据部分以及在运行时获得的其他类型资源的执行环境。程序是一个包含指令和数据的文件，用于初始化进程的指令和用户数据部分。

Unix 操作系统首次推出时，计算机只有单个 CPU，没有多个核心和少量的 RAM。然而，Unix 是一个多用户和多任务操作系统。为了实际上成为一个多用户和多任务系统，它必须能够周期性地运行每个单独的进程，这意味着一个进程应该有多个状态。下图显示了进程的可能状态以及从一个状态到另一个状态的正确路径：

![](img/2c347cf1-0751-465a-8026-557eabace4a5.png)

Unix 进程的各种状态

有三种进程类别：用户进程、内核进程和守护进程：

+   用户进程在用户空间中运行，通常没有特殊的访问权限

+   内核进程仅在内核空间中执行，并且可以完全访问所有内核数据结构

+   守护进程是可以在用户空间中找到并在后台运行而无需终端的程序

意识到你无法控制进程的状态是非常重要的，因为这是运行在内核中的操作系统的**调度程序**的工作。简单来说，你无法预测进程的状态何时会改变，或者进程何时会进入运行状态，所以你的代码不能依赖任何这样的假设！

创建新进程的 C 方式涉及调用`fork()`系统调用。`fork()`的返回值允许程序员区分父进程和子进程。然而，Go 不支持类似的功能。

# 练习

1.  访问 Go 网站：[`golang.org/`](https://golang.org/)。

1.  在你的系统上安装 Go 并找出它的版本。

1.  自己输入 Hello World 程序的代码并将其保存到文件中。

1.  如果你使用的是 Mac，可以从[`macromates.com/`](http://macromates.com/)下载 TextMate。

1.  如果你使用的是 Mac，可以从[`www.barebones.com/products/TextWrangler/`](http://www.barebones.com/products/TextWrangler/)下载 TextWrangler 编辑器并尝试使用它。

1.  如果你还不熟悉其他 Unix 文本编辑器，可以尝试自己学习 vi 或 Emacs。

1.  查看任何你能找到的 Go 代码，并尝试对其进行小的更改。

# 总结

在本章中，你学会了如何在你的计算机上安装 Go，最新 Go 版本的特性，Go 的优缺点，以及`gofmt`和`godoc` Go 工具，以及关于 Unix 操作系统的一些重要内容。

下一章不仅会告诉你如何编译你的 Go 代码，还会讨论其他重要的 Go 主题，比如读取和使用命令行参数，环境变量，编写函数，数据结构，接口，获取用户输入和打印输出。
