# 保护您的网络爬虫

现在您已经构建了一个能够自主从各种网站收集信息的网络爬虫，有一些事情您应该做以确保它的安全运行。应该采取一些重要措施来保护您的网络爬虫。正如您应该知道的，如果您没有完全拥有它，互联网上的任何东西都不应该完全信任。

在本章中，我们将讨论以下工具和技术，这些工具和技术将确保您的网络爬虫的安全：

+   虚拟私人服务器

+   代理

+   虚拟私人网络

+   白名单和黑名单

# 虚拟私人服务器

当您对网站发出 HTTP 请求时，您正在在您的计算机和目标服务器之间建立直接连接。通过这样做，您向他们提供了您计算机的公共 IP 地址，这可以用来确定您的大致位置和您的**互联网服务提供商**（**ISP**）。尽管这不能直接追溯到您的确切位置，但如果它落入错误的手中，它可能被恶意使用。考虑到这一点，最好不要将您的任何个人资产暴露给不受信任的服务器。

在远离您物理位置的计算机上运行您的网络爬虫，并具有某种远程访问，是将您的网络爬虫与个人电脑解耦的好方法。您可以从网络上的各种提供商租用**虚拟私人服务器**（**VPS**）实例。

一些更值得注意的公司包括以下内容：

+   **亚马逊网络服务**（**AWS**）

+   微软 Azure

+   谷歌云

+   DigitalOcean

+   Linode

这些公司将允许您创建一个虚拟机，并为您提供访问实例的凭据。它们有各种不同的产品，取决于您需要的机器大小，并且如果它们在某个特定大小以下，大多数公司都提供一些免费资源。

您需要将您的网络爬虫代码部署到这些机器上，并从 VPS 内运行程序。本书不会详细介绍 Go 应用程序的打包和部署，但以下是一些让您开始的技术：

+   **安全复制协议**（**SCP**）

+   Git

+   Ansible

+   木偶

+   Docker

+   Kubernetes

通过在 VPS 上操作网络爬虫，您可以放心，如果您的机器暴露了，它可以被安全地销毁，而不会危及您的个人电脑。此外，在 VPS 上运行爬虫可以让您轻松扩展以满足您在开始爬取更多网站时的需求。您可以启动多个 VPS 实例并并行运行您的爬虫。

# 代理

代理的作用是在您的系统之上提供额外的保护层。在其核心，代理是一个位于您的网络爬虫和目标网络服务器之间的服务器，并在两者之间传递通信。您的网络爬虫向代理服务器发送请求，然后代理服务器将请求转发到网站。从网站的角度来看，请求只来自代理服务器，而不知道请求的来源。有许多类型的代理可用，每种都有其优缺点。

# 公共和共享代理

一些代理是对公众开放的。然而，它们可以被许多不同的人共享。这会危及您的可靠性，因为如果其他用户通过滥用来危害代理，它可能会危及您的网络爬虫。对于公共代理，速度是另一个问题：通过代理的流量越多，可用带宽就越少。另一方面，这些代理是免费使用的，在测试和调试阶段可能会有用。

以下是一些列出公共代理的网站：

+   [`free-proxy-list.net`](https://free-proxy-list.net)

+   [`hidemyna.me`](https://hidemyna.me)

+   [`proxy-list.download`](https://proxy-list.download)

由于公共代理的成功率不同，您需要确保在生产中尝试之前进行研究。您需要考虑这些代理是否可靠，并且能否访问您的目标网站。您还需要确保在通过它们连接时您的信息得到保护。

# 专用代理

专用代理是确保只有您控制通过代理服务器流动的流量的绝佳方式。有许多公司提供按需和批量销售专用代理。一些值得考虑的公司包括以下内容：

+   风暴代理

+   炽热 SEO

+   Ghost 代理

+   Oxylabs

在选择公司时有一些要考虑的事项。

# 价格

专用代理的定价模型因公司而异。在大多数情况下，您按使用的 IP 地址付费，并且可以随意使用该 IP 地址。有许多公司拥有 IP 地址池，并将根据您的带宽收费。在这种定价模型中，您需要确保尽可能有效地进行调用。

每个 IP 代理的成本可能在每月 1 美元至 6 美元之间。通常，批量购买会获得更大的折扣。一些公司还可能限制您的带宽。

# 位置

偶尔，代理的位置对您可能很重要。许多代理公司在世界各地分布其服务器，以实现更广泛的覆盖范围。如果您在不同国家的网站上爬取数据，可能有必要通过该国家的代理来运行您的爬虫，以避免防火墙或异常流量签名。不同的国家也可能对该国家通过互联网允许的内容有不同的法律，因此在选择此路线之前，您应始终咨询当地法律。

# 类型

您应该了解的两种主要类型的代理是：住宅和数据中心代理。住宅代理具有由注册在住宅区域的 ISP 分配的 IP 地址。这些 IP 地址直接与特定地区相关，许多网站可以根据这些 IP 地址估计您的位置。这就是 Google Analytics 知道网站流量来自何处的方式。从网络爬取的角度来看，如果网站流量来自旧金山而不是伦敦，可能会有所不同。如果您的内容根据您的位置而变化，您可能需要在正确的位置使用住宅代理。

第二种类型的代理是数据中心代理。这些代理由与数据中心相关的 ISP 分配，例如 VSP 提供商。当您创建新的虚拟机时，分配给该机器的 IP 地址很可能是数据中心 IP。这些地址可能会被网站有意地阻止，以防止非住宅访客访问。

# 匿名性

在选择代理提供程序时，匿名性应被视为相当重要。并非所有代理在将数据传递给目标服务器时完全隐藏请求的来源源。

透明代理向目标服务器提供有关您身份的信息，在大多数情况下应该避免使用。这些代理将 HTTP 头传递给目标服务器，例如`X-Forwarded-For`：`<your_ip_address>`，以识别请求的来源源，以及`Via`：`<proxy_server>`以识别代理本身。

匿名代理提供与透明代理相同的头信息，但它们可能提供错误信息以隐藏您的真实身份。在这种情况下，目标服务器将意识到连接是通过代理进行的，但请求的真实来源是未知的。

精英代理是您可以从代理中获得的最高匿名级别。精英代理不会转发有关原始来源的任何信息，也不会透露请求来自代理的事实。相反，该请求对 Web 服务器来说看起来是来自代理的 IP 地址的正常请求。

# Go 中的代理

一旦您收到要使用的代理地址列表，配置 Go HTTP 客户端非常简单。Go HTTP 客户端包含一个称为**传输**的对象。传输负责与 Web 服务器进行低级通信，包括打开和关闭连接，发送和接收数据以及处理 HTTP 1XX 响应代码。您可以通过设置接受`*http.Request`并将代理地址返回为`*url.URL`的函数来设置传输的`Proxy()`方法。

以下是设置`Proxy()`函数的示例：

```go
package main

import (
  "math/rand"
  "net/http"
  "net/url"
)

// Public proxies from https://hidemyna.me
// These proxies are subject to frequent change.
// Please replace them if necessary.
var proxies []string = []string{
 "http://207.154.231.208:8080",
 "http://138.68.230.88:8080",
 "http://162.243.107.45:8080",
}

func GetProxy(_ *http.Request) (*url.URL, error) {
  randomIndex := rand.Int31n(int32(len(proxies)) - int32(1))
  randomProxy := proxies[randomIndex]
  return url.Parse(randomProxy)
}

func main() {
  http.DefaultTransport.(*http.Transport).Proxy = GetProxy
  // Continue with your HTTP requests ...
}
```

`GetProxy()`函数在三个配置的代理之间随机选择，并将字符串转换为`*url.URL`。通过配置`http.DefaultTransport.Proxy`函数，每次使用`http.DefaultClient`时，`GetProxy`将确定使用哪个随机代理。您还可以通过检查`*http.Request`并根据提供的主机名返回所需的代理，为不同的主机使用不同的代理。

# 虚拟私人网络

根据您的需求，您可能需要连接到**虚拟私人网络**（**VPN**）以确保您的网络爬虫流量全部隐藏。代理通过掩盖网络爬虫的 IP 地址提供了一层保护，而 VPN 还通过加密隧道掩盖了网络爬虫和目标站点之间流动的数据。这将使您正在抓取的内容对 ISP 和任何其他访问您网络的人都是不可见的。

并非所有国家都允许使用 VPN。请遵守当地法律。

有许多公司提供 VPN 访问，成本通常在每月 5 美元至 15 美元之间。

以下是一些推荐的公司：

+   Vypr VPN

+   Express VPN

+   IPVanish VPN

+   Nord VPN

配置您的网络爬虫使用 VPN 与代理不同。VPN 通常需要一个特定的客户端将您的机器连接到它们的网络，这不是通过代码完成的。优点是您使用网络爬虫编写的代码将独立于任何网络配置工作。不幸的是，您将无法在代码中使用 shell 命令进行网络的即时更改。

按照 VPN 提供商提供的说明连接到 VPN 网络。

# 边界

当您爬取网站时，您可能并不总是知道自己将去哪里。网页中的许多链接会带您前往您可能不太信任的外部网站。这些链接的页面可能包含无关的信息，也可能被用于恶意目的。重要的是为您的网络爬虫定义边界，以安全地浏览未知来源。

# 白名单

**白名单**域是一种明确允许您的网络爬虫访问某些网站的过程。白名单上列出的任何站点都可以让网络爬虫访问，而未列出的任何站点都将自动跳过。这是一种简单的方法，可以确保您的网络爬虫只访问一小组特定站点的页面，有助于收集非常专注的信息。您甚至可以通过仅允许访问网站的路径来进一步扩展。

使用 Go 构建白名单非常简单，可以使用 URL 和 path 包。让我们以在 Packt Hub 网站（[`hub.packtpub.com/`](https://hub.packtpub.com/)）上索引文章为例。这里发布的许多文章包含指向外部网站的链接，用于注明信息来源。但是，如果我们只对在 Packt Hub 上找到其他文章感兴趣，我们将只列出[hub.packtpub.com](http://hub.packtpub.com)的 URL。

您可能遇到的示例文章链接看起来可能是这样的：[`hub.packtpub.com/8-programming-languages-to-learn-in-2019/`](https://hub.packtpub.com/8-programming-languages-to-learn-in-2019/)。

使用 GoLang URL 包，我们可以查看主机名，以确定是否值得跟踪链接：

```go
parsedUrl, err := url.Parse("https://hub.packtpub.com/8-programming-languages-to-learn-in-2019")

if err != nil {
  panic(err)
}

site := parsedUrl.Host + parsedUrl.Path
```

然后，您可以使用`path.Match()`函数来验证是否匹配，如下所示：

```go
doesMatch, err := path.Match("hub.packtpub.com/*", site)
if err != nil {
  panic(err)
}
if doesMatch {
// Continue scraping …
}
```

# 黑名单

与白名单相反，**黑名单**定义了您的爬虫绝对不应该访问的网站。您可能希望在此处包括一些您知道不包含任何相关信息的地方，或者您对其内容不感兴趣的地方。您还可以暂时将正在遇到性能问题的站点列入黑名单，例如大量的 5XX 错误，如第二章中所讨论的*请求/响应循环*。您可以像前面的示例一样将链接 URL 与其主机名进行匹配。

所需的唯一更改是修改最后的`if`块，如下所示，以便仅在`doesMatch`为 false 时运行：

```go
if !doesMatch {
// Continue scraping …
}
```

# 总结

在本章中，我们回顾了许多不同的技术，以确保我们和我们的网络爬虫在浏览互联网时受到保护。通过使用 VPS，我们可以保护我们的个人资产免受恶意活动和在互联网上的可发现性。代理还有助于限制有关互联网流量来源的信息，提供了一层匿名性。VPN 通过为我们的数据创建加密隧道来增加了代理的额外安全层。最后，创建白名单和黑名单确保您的爬虫不会深入未知和不受欢迎的地方。

在第七章中，*并发爬取*，我们将看看如何使用并发来增加我们的网络爬虫的规模，而无需增加额外的资源成本。
