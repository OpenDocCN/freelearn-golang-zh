# 前言

我就是喜欢新的编程语言。也许是因为对现有语言的熟悉和厌倦，对现有工具、语法、编码约定和性能的挫败感。也许我只是在寻找那个“统治它们所有”的语言。无论原因是什么，每当有新的或实验性的语言发布时，我都会迫不及待地去尝试。

这是一个新语言和语言设计的黄金时代。想想看：C 语言是在 20 世纪 70 年代初发布的——那个时候资源是如此稀缺，以至于冗长、清晰和语法逻辑经常被节俭所取代。今天我们使用的大多数语言要么是在这个时代原创写成的，要么直接受到了这些语言的影响。

自 20 世纪 80 年代末和 90 年代初以来，强大的新语言和范式——Perl、Python、Ruby、PHP 和 JavaScript——已经成为了一个不断扩大的用户群体，并成为最受欢迎的语言之一（与 C、C++和 Java 等老牌语言一样）。多线程、内存缓存和 API 使多个进程、不同的语言、应用程序，甚至是不同的操作系统能够协同工作。

虽然这很棒，但直到最近，有一个领域一直未得到很好的满足：强大的、编译的、跨平台的语言，支持并发，面向系统程序员。

很少有语言符合这些参数。当然，已经有一些低级语言满足了其中的一些特征。Erlang 和 Haskell 在功能和语言设计方面都符合要求，但作为函数式语言，对于从 C/Java 背景转向系统程序员来说，它们构成了一个学习障碍。Objective-C 和 C#相对容易、强大，并且支持并发，但它们与特定操作系统绑定，使得为其他平台编程变得困难。我们刚提到的语言（Python、JavaScript 等）虽然非常流行，但它们大多是解释性语言，将性能放在了次要位置。你可以用它们中的大多数来进行系统编程，但在许多方面，这就像是把方形木栓塞进圆孔。因此，当谷歌在 2009 年宣布推出 Go 时，我的兴趣被激起了。当我看到是谁在项目背后（稍后会详细介绍），我感到非常高兴。当我看到这种语言及其设计的实际运行时，我感到非常幸福。

在过去的几年里，我一直在使用 Go 来替换之前用 C、Java、Perl 和 Python 编写的系统应用程序。我对结果非常满意。几乎在每一个实例中，使用 Go 都改进了这些应用程序。它与 C 的良好兼容性是系统程序员寻求尝试 Go 的另一个巨大卖点。

有一些最优秀的语言设计（以及编程一般）的大脑支持，Go 有着光明的未来。

多年来——实际上是几十年来——编写服务器和网络接口的选择一直不多。如果你被要求编写一个，你可能会选择 C、C++或 Java。虽然它们当然可以处理这个任务，而且它们现在都以某种方式支持并发和并行，但它们并不是为此而设计的。

谷歌汇集了一支团队，其中包括一些编程界的巨头——贝尔实验室的 Rob Pike 和 Ken Thompson 以及曾参与谷歌 JavaScript 实现 V8 的 Robert Griesemer——设计了一种现代的、并发的语言，开发便利性是首要考虑的。

为了做到这一点，团队专注于一些替代方案中的一些痛点，具体如下：

+   动态类型的语言在最近几年变得非常流行。Go 避开了 Java 或 C++的显式“繁琐”类型系统。Go 使用类型推断，这节省了开发时间，但仍然是强类型的。

+   并发性、并行性、指针/内存访问和垃圾回收在上述语言中都很难处理。Go 让这些概念可以像你想要或需要的那样简单或复杂。

+   作为一种较新的语言，Go 专注于多核设计，这在 C++等语言中是必要的事后考虑。

+   Go 的编译器速度超快；它的速度非常快，以至于有一些实现将 Go 代码视为解释执行。

+   尽管 Google 设计 Go 是一种系统语言，但它足够多才多艺，可以以多种方式使用。当然，对先进、廉价的并发性的关注使其成为网络和系统编程的理想选择。

+   Go 的语法比较宽松，但使用上比较严格。这意味着 Go 会让你在一些词法标记上有点懒散，但你仍然必须编写基本紧凑的代码。由于 Go 提供了一个格式化工具来尝试澄清你的代码，因此在编码时你也可以花更少的时间来关注可读性问题。

# 本书涵盖的内容

第一章，“Go 中并发的介绍”，介绍了 goroutines 和通道，并将比较 Go 处理并发的方式与其他语言的方法。我们将利用这些新概念构建一些基本的并发应用程序。

第二章，“理解并发模型”，侧重于资源分配、共享内存（以及何时不共享）和数据。我们将研究通道和通道的通道，并解释 Go 内部如何管理并发。

第三章，“开发并发策略”，讨论了设计应用程序以最佳方式利用 Go 中并发工具的方法。我们将看一些可用的第三方包，它们可以在你的策略中发挥作用。

第四章，“应用程序中的数据完整性”，着眼于确保 goroutines 和通道的委托在单线程和多线程应用程序中保持状态。

第五章，“锁、阻塞和更好的通道”，探讨了 Go 如何在开箱即用时避免死锁，以及在哪里以及何时尽管 Go 的语言设计仍然可能发生死锁。

第六章，“C10K – 一个非阻塞的 Go Web 服务器”，解决了互联网上最著名和最受尊敬的挑战之一，并尝试使用核心 Go 包来解决它。然后我们将完善产品，并使用常见的基准测试工具进行测试。

第七章，“性能和可伸缩性”，侧重于挤出并发 Go 代码的最大潜力，最大限度地利用资源，并考虑和减轻第三方软件对自身的影响。我们将为我们的 Web 服务器添加一些额外的功能，并讨论其他可以使用这些包的方式。

第八章，“并发应用程序架构”，侧重于何时何地实施并发模式，何时如何利用并行性来充分利用先进的硬件，以及如何确保数据一致性。

第九章，“在 Go 中记录和测试并发”，侧重于测试和部署应用程序的特定于操作系统的方法。我们还将探讨 Go 与各种代码存储库的关系。

第十章, *高级并发和最佳实践*，探讨了更复杂和先进的技术，包括复制 Go 核心中不可用的并发特性。

# 您需要为本书做好准备

要跟随本书的示例工作，您需要一台运行 Windows、OS X 或支持 Go 的许多 Linux 变体的计算机。对于本书，我们的 Linux 示例和说明参考了 Ubuntu。

如果您尚未安装 Go 1.3 或更新版本，您需要从[`golang.org/`](http://golang.org/)的二进制下载页面或通过操作系统的软件包管理器获取它。

要使用本书中的所有示例，您还需要安装以下软件：

+   MySQL ([`dev.mysql.com/downloads/`](http://dev.mysql.com/downloads/))

+   Couchbase ([`www.couchbase.com/download`](http://www.couchbase.com/download))

您选择的集成开发环境是个人偏好的问题，任何与开发人员合作过的人都可以证明这一点。也就是说，有些 IDE 比其他语言更适合，有些对 Go 的支持更好。本作者使用 Sublime Text，它非常适合 Go，体积轻巧，并允许您直接在 IDE 内构建。您在哪里看到代码截图，都将来自 Sublime Text 内部。

虽然 Go 代码有很好的内置支持，但 Sublime Text 还有一个名为 GoSublime 的不错的插件集，可在[`github.com/DisposaBoy/GoSublime`](https://github.com/DisposaBoy/GoSublime)上获得。

Sublime Text 并非免费，但有免费的评估版本可供使用，没有时间限制。它在 Windows、OS X 和 Linux 变体上都可用，网址是[`www.sublimetext.com/`](http://www.sublimetext.com/)。

# 本书适合的读者是谁

如果您是具有一定 Go 和并发知识的系统或网络程序员，但想了解用 Go 编写的并发系统的实现，那么这本书适合您。本书的目标是使您能够在 Go 中编写高性能、可扩展、资源节约的系统和网络应用。

在本书中，我们将编写一些基本和稍微不那么基本的网络和系统应用程序。假定您以前曾使用过这些类型的应用程序。如果没有，可能需要进行一些课外学习，以便能够充分消化这些内容。

# 惯例

在本书中，您将找到一些区分不同信息类型的文本样式。以下是一些这些样式的示例，以及它们的含义解释。

文本中的代码字，数据库表名，文件夹名，文件名，文件扩展名，路径名，虚拟 URL，用户输入和 Twitter 句柄显示如下："在每个请求之后调用`setProxy`函数，并且您可以将其视为处理程序中的第一行。"

代码块设置如下：

```go
package main

import
(
"net/http"
"html/template"
"time"
"regexp"
"fmt"
"io/ioutil"
"database/sql"
"log"
"runtime"
_ "github.com/go-sql-driver/mysql"
)
```

当我们希望引起您对代码块的特定部分的注意时，相关行或项目将以粗体显示：

```go
package main

import (
  "fmt"
)

func stringReturn(text string) string {
 return text
}

func main() {
 myText := stringReturn("Here be the code")
  fmt.Println(myText)
}
```

任何命令行输入或输出都以以下方式编写：

```go
go get github.com/go-sql-driver/mysql

```

**新术语**和**重要单词**以粗体显示。例如，屏幕上看到的单词，菜单或对话框中的单词等，会在文本中以这种方式出现："如果您通过将文件拖到**拖放文件到此处上传**框中来上传文件，几秒钟后您会看到文件在 Web 界面中被标记为已更改。"

### 注意

警告或重要说明会以以下方式出现在框中。

### 提示

提示和技巧会以这种方式出现。
