<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer028">
			<h1 id="_idParaDest-41"><em class="italic"><a id="_idTextAnchor041"/>Chapter 2</em>: Building a Traffic Lights Control System</h1>
			<p>In the previous chapter, we set up TinyGo and our IDE, and we now know how to build and flash our programs to the Arduino UNO. We are now going to utilize this knowledge to go one step further.</p>
			<p>In this chapter, we are going to build a traffic lights control system. We are going to split the project into small steps, where we build and test each component. At the end, we are going to put everything together. We will be using multiple LEDs, a breadboard, GPIO ports, and a button to interrupt the normal flow to switch pedestrian lights to green. By the end of the chapter, you will know how to control external LEDs, read the state of a button, use GPIO ports, how to distinguish resistors, and how to utilize Goroutines in TinyGo.</p>
			<p>In this chapter, we are going to cover the following topics:</p>
			<ul>
				<li>Lighting an external LED</li>
				<li>Lighting a single LED when a button is pressed</li>
				<li>Building traffic lights</li>
				<li>Building traffic lights with pedestrian lights</li>
			</ul>
			<h1 id="_idParaDest-42"><a id="_idTextAnchor042"/>Technical requirements</h1>
			<p>To build the traffic lights control system, we are going to need some components. We will need the following to build the complete project:</p>
			<ol>
				<li>An Arduino UNO</li>
				<li>Breadboard</li>
				<li>Five LEDs </li>
				<li>Multiple jumper cables</li>
				<li>Multiple 220 Ohm resistors</li>
				<li>One push button</li>
				<li>One 10K Ohm resistor</li>
			</ol>
			<p>You can find all code examples from this chapter in the following GitHub repository:  <a href="https://github.com/PacktPublishing/Creative-DIY-Microcontroller-Projects-with-TinyGo-and-WebAssembly/tree/master/Chapter02">https://github.com/PacktPublishing/Creative-DIY-Microcontroller-Projects-with-TinyGo-and-WebAssembly/tree/master/Chapter02</a></p>
			<p>The Code in Action video for the chapter can be found here: <a href="https://bit.ly/2RpvF2a">https://bit.ly/2RpvF2a</a></p>
			<h1 id="_idParaDest-43"><a id="_idTextAnchor043"/>Lighting an external LED</h1>
			<p>Before we start to <a id="_idIndexMarker077"/>build a more complex circuit, let's begin with lighting up an external LED. As soon as this is working, we are going to extend the circuit step by step. We begin with a single red LED. Lighting up an external LED is a bit different compared to lighting up an onboard LED. We are going to need something on which we can place the LED, and we will need some wires as well as a basic understanding of resistors, which will help us to prevent the LED from taking damage. That is why we are going to look at each component one by one.</p>
			<h3>Using breadboards</h3>
			<p><strong class="bold">Breadboards</strong> are<a id="_idIndexMarker078"/> used for prototyping, as they do not<a id="_idIndexMarker079"/> require you to directly solder components. We are going to build all our projects using breadboards. </p>
			<p>A breadboard typically consists of two parts:</p>
			<ul>
				<li>The power bus</li>
				<li>Horizontal rows</li>
			</ul>
			<p>Each side of a breadboard has a power bus. The power bus provides a + (positive) lane and a - (ground) lane. The positive lane is colored <em class="italic">red</em> and the ground lane is colored <em class="italic">blue</em>. The individual slots are connected inside the power bus. </p>
			<p>The slots of a single horizontal row are also connected. A signal in one slot is also available in the next slot. Different horizontal rows are not connected, unless we put a cable in there<a id="_idIndexMarker080"/> to create a connection. Here's what a <a id="_idIndexMarker081"/>breadboard looks like:</p>
			<div>
				<div id="_idContainer019" class="IMG---Figure">
					<img src="Images/Figure_2.1_B16555.jpg" alt="Figure 2.1 – A breadboard – image taken from Fritzing&#13;&#10;" width="1115" height="378"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.1 – A breadboard – image taken from Fritzing</p>
			<h3>Understanding LED basics</h3>
			<p>The Arduino <a id="_idIndexMarker082"/>UNO has an operating voltage of 5V, which is too high for most LEDs. So, we need to reduce the voltage to something our LEDs can handle. For that reason, we will be using 220 Ohm resistors to draw current from the line in order to protect the LED from damage. If you do not have 220 Ohm resistors, you can also use 470 Ohm as well; anything between 220 and 1K (1K = 1,000) Ohm will be fine.</p>
			<p>If you want to really make sure that the resistor matches the needs of the LED, you can also calculate the resistor value as follows:</p>
			<p><em class="italic">R = (V</em><em class="italic">s</em><em class="italic"> – V</em><em class="italic">led</em><em class="italic">) / I</em><em class="italic">led</em></p>
			<p>Where:</p>
			<ul>
				<li>R is the resistor value.</li>
				<li>Vs is the source voltage.</li>
				<li>Vled is the voltage drop across the LED.</li>
				<li>Iled is the current through the LED.<p class="callout-heading">Note</p><p class="callout">LEDs have <em class="italic">anode</em> (+) and <em class="italic">cathode</em> (-) leads. The anode lead is longer.</p><p class="callout">Different colors need to be driven with different voltages. When using the same resistors and voltages for the different LED colors, you will notice that some colors will be brighter<a id="_idIndexMarker083"/> compared to others. </p></li>
			</ul>
			<h3>Using GPIO ports</h3>
			<p><strong class="bold">GPIO</strong> stands <a id="_idIndexMarker084"/>for <strong class="bold">General Purpose Input Output</strong>. That<a id="_idIndexMarker085"/> means we can use these pins for input as well as output for digital signals. We can either set a GPIO pin to <em class="italic">High</em> or <em class="italic">Low</em>, or read a <em class="italic">High</em> or <em class="italic">Low</em> value from the port.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">We should never draw more than a maximum of 40.0 mA (milliampere) from a single GPIO port. Otherwise, we could permanently damage the hardware. </p>
			<h3>Building the circuit</h3>
			<p>Now let's build our first circuit on the breadboard:</p>
			<ol>
				<li value="1">Put a red LED in the <em class="italic">G</em> column of the horizontal rows. Put the cathode in <em class="italic">G12</em> and the anode in <em class="italic">G13</em>.</li>
				<li>Connect <em class="italic">F12</em> with the ground lane on the power bus.</li>
				<li>Connect <em class="italic">F13</em> and <em class="italic">E13</em> using a 220 Ohm resistor. (Anything between 220 and 1,000 Ohms is okay.)</li>
				<li>Connect <em class="italic">Pin 13</em> from the GPIO ports to <em class="italic">A13</em>.</li>
				<li>Connect the GND port to the ground lane on the power bus.<p class="callout-heading">Note</p><p class="callout">The descriptions on your breadboard might differ from the ones I am using. If that is the case, you'll need to build the circuit by checking the next figure.</p></li>
			</ol>
			<p>The <a id="_idIndexMarker086"/>circuit<a id="_idIndexMarker087"/> should now look like the following:</p>
			<div>
				<div id="_idContainer020" class="IMG---Figure">
					<img src="Images/Figure_2.2_B16555.jpg" alt="Figure 2.2 – Image of the circuit – image taken from Fritzing&#13;&#10;" width="1133" height="757"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.2 – Image of the circuit – image taken from Fritzing</p>
			<h3>Writing the code</h3>
			<p>We start off by <a id="_idIndexMarker088"/>creating a new folder named <strong class="source-inline">Chapter02</strong> in our project workspace. This folder will be used for all parts of this chapter. Inside the <strong class="source-inline">Chapter02</strong> folder, we create a <strong class="source-inline">blinky-external</strong> folder and create a new <strong class="source-inline">main.go</strong> file inside.</p>
			<p>The structure should look like the following:</p>
			<div>
				<div id="_idContainer021" class="IMG---Figure">
					<img src="Images/Figure_2.3_B16555.jpg" alt="Figure 2.3 - Project structure for writing the code&#13;&#10;" width="247" height="45"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.3 - Project structure for writing the code</p>
			<p>We import the <strong class="source-inline">machine</strong> and <strong class="source-inline">time</strong> packages and put the following code into the <strong class="source-inline">main</strong> function:</p>
			<ol>
				<li value="1">Declare and initialize a variable named <strong class="source-inline">outputConfig</strong> with a new <strong class="source-inline">PinConfig</strong> in output mode:<p class="source-code">outputConfig := machine.PinConfig{Mode: machine.</p><p class="source-code">                PinOutput}</p></li>
				<li>Declare and initialize a variable named <strong class="source-inline">greenLED</strong> with a value of <strong class="source-inline">machine.D13</strong>:<p class="source-code">greenLED := machine.D13</p></li>
				<li>Configure<a id="_idIndexMarker089"/> the LED with the <strong class="source-inline">outputConfig</strong> instance we created earlier, by passing it as a parameter into the <strong class="source-inline">Configure</strong> function:<p class="source-code">redLED.Configure(outputConfig)</p></li>
				<li>We then loop endlessly:<p class="source-code">for {</p></li>
				<li>Set <strong class="source-inline">redLED</strong> to <strong class="source-inline">Low</strong> (off):<p class="source-code">  redLED.Low()</p></li>
				<li>Sleep for half a second. Without sleeping, the LED would be turned on and off at an extremely high rate, so we sleep after each change in a state:<p class="source-code">  time.Sleep(500 * time.Millisecond)</p></li>
				<li>Set the <strong class="source-inline">redLED</strong> to <strong class="source-inline">High</strong> (on):<p class="source-code">  redLED.High()</p></li>
				<li>Sleep for half a second:<p class="source-code">  time.Sleep(500 * time.Millisecond)</p><p class="source-code">}</p></li>
				<li>Now flash the program using the <strong class="source-inline">tinygo flash</strong> command using the following command:<p class="source-code"><strong class="bold">tinygo flash –target=arduino Chapter02/blinky-external/main.go</strong></p></li>
			</ol>
			<p>When the flash progress completes and the Arduino restarts, the red LED should blink at intervals of 500 ms. </p>
			<p>Congratulations, you have just built your first circuit and written your first program to control external <a id="_idIndexMarker090"/>hardware! As we now know how to connect and control external LEDs on a breadboard, we can continue to build a more advanced circuit. Let's do just that in the next section. </p>
			<h1 id="_idParaDest-44"><a id="_idTextAnchor044"/>Lighting an LED when a button is pressed</h1>
			<p>Until now, we<a id="_idIndexMarker091"/> have only used code to directly control hardware components. Let's now try to read the state of a button in order to control an LED. We will need the following components:</p>
			<ul>
				<li>At least 6 jumper wires</li>
				<li>One LED (the color does not matter)</li>
				<li>One 220 Ohm resistor</li>
				<li>One 4-pinned-button (push down button)</li>
				<li>One 10K Ohm resistor</li>
			</ul>
			<p>Now let's go on to build the circuit.</p>
			<h2 id="_idParaDest-45"><a id="_idTextAnchor045"/>Building the circuit</h2>
			<p>The following<a id="_idIndexMarker092"/> circuit extends the one we previously built. So, if you still have the previous circuit assembled, you just have to add the button part. The next circuit consists of two component groups. The first group is used to control an LED, and the second group is used to read the button state. </p>
			<h3>Adding the LED component</h3>
			<p>We start off <a id="_idIndexMarker093"/>with the LED circuit:</p>
			<ol>
				<li value="1">Place an LED with the cathode in G12 and the anode in G13. </li>
				<li>Use a 220 Ohm resistor to connect <em class="italic">F13</em> with <em class="italic">D13</em>.</li>
				<li>Connect port <em class="italic">D13</em> from the GPIO ports with <em class="italic">A13</em> using a jumper wire.</li>
				<li>Connect <em class="italic">F12</em> with the ground lane of the power bus using a jumper wire.</li>
			</ol>
			<h3>Adding the button component</h3>
			<p>Now we <a id="_idIndexMarker094"/>are going to add a button:</p>
			<ol>
				<li value="1">Use a jumper wire to connect <strong class="source-inline">A31</strong> with the positive lane of the power bus. </li>
				<li>Use a 10K Ohm resistor to connect the ground lane of the power bus with <strong class="source-inline">B29</strong>.</li>
				<li>Connect <strong class="source-inline">D29</strong> with port <strong class="source-inline">D2</strong>.</li>
				<li>Place the push button with one pin in <strong class="source-inline">E29</strong>, one in <strong class="source-inline">E31</strong>, one in <strong class="source-inline">F29</strong>, and the last pin in <strong class="source-inline">F31</strong>.</li>
			</ol>
			<p>Our circuit should now look similar to the following:</p>
			<div>
				<div id="_idContainer022" class="IMG---Figure">
					<img src="Images/Figure_2.4_B16555.jpg" alt="Figure 2.4 – The circuit – image taken from Fritzing&#13;&#10;" width="1329" height="809"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.4 – The circuit – image taken from Fritzing</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Before we start <a id="_idIndexMarker095"/>to write the code for this circuit, we need to learn how these buttons work.</p>
			<p class="callout">As the button will not work if you place it incorrectly onto the breadboard, let's have a look at the button again.</p>
			<p class="callout">The 4 pins on the button are grouped into two pins each. So, two pins are connected to each other. Looking at the back of the button, we should be able to see that two opposing pins are connected to each other. So, the button won't work as expected when you place it rotated by 90°.</p>
			<h2 id="_idParaDest-46"><a id="_idTextAnchor046"/>Programming the logic</h2>
			<p>Before diving<a id="_idIndexMarker096"/> into the code, we will create a new folder named <strong class="source-inline">light-button</strong> inside the <strong class="source-inline">Chapter02</strong> folder and create a <strong class="source-inline">main.go</strong> file in it, with an empty <strong class="source-inline">main</strong> function, using the following:</p>
			<div>
				<div id="_idContainer023" class="IMG---Figure">
					<img src="Images/Figure_2.5_B16555.jpg" alt="Figure 2.5 – The folder structure for the logic&#13;&#10;" width="227" height="89"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.5 – The folder structure for the logic</p>
			<p>Let's now look at the <strong class="source-inline">main</strong> function and the pull-up resistor.</p>
			<h3>The main function</h3>
			<p>We want to<a id="_idIndexMarker097"/> light the LED when the button is pressed. To achieve this, we need to read from a pin and check for its state using the following steps:</p>
			<ol>
				<li value="1">Initialize the <strong class="source-inline">outPutConfig</strong> variable with <strong class="source-inline">PinConfig</strong> in <strong class="source-inline">PinOutput</strong> mode. This config is going to be used to control the LED pin:<p class="source-code">outputConfig := machine.PinConfig{Mode: machine.</p><p class="source-code">                PinOutput}</p></li>
				<li>Initialize the <strong class="source-inline">inputConfig</strong> variable with <strong class="source-inline">PinConfig</strong> in <strong class="source-inline">PinInput</strong> mode. This config is being used for the pin that reads the button state and therefore needs to be an input:<p class="source-code">inputConfig := machine.PinConfig{Mode: machine.PinInput}</p></li>
				<li>Initialize the <strong class="source-inline">led</strong> variable with a value of <strong class="source-inline">machine.D13</strong>, which is the pin we have connected to <strong class="source-inline">led</strong>:<p class="source-code">led := machine.D13</p></li>
				<li>Configure <strong class="source-inline">led</strong> as output by passing <strong class="source-inline">outputConfig</strong> as the parameter, which is the pin that is connected to the button:<p class="source-code">led.Configure(outputConfig)</p></li>
				<li>Initialize the <strong class="source-inline">buttonInput</strong> variable with a value of <strong class="source-inline">machine.D2</strong>:<p class="source-code">buttonInput := machine.D2</p></li>
				<li>Configure <strong class="source-inline">buttonInput</strong> as an input by passing <strong class="source-inline">inputConfig</strong> as the parameter:<p class="source-code">buttonInput.Configure(inputConfig)</p></li>
				<li>As we do not want the program to be terminated after checking the button state a<a id="_idIndexMarker098"/> single time, we use an endless loop to repeat and check forever:<p class="source-code">for {</p></li>
				<li>Check the current state of the button. It will be true if the button is pressed:<p class="source-code">  if buttonInput.Get() {</p></li>
				<li>If the button is pressed, we light up the LED:<p class="source-code">    led.High()</p></li>
				<li>We are calling <strong class="source-inline">continue</strong> here, so we do not execute the <strong class="source-inline">led.Low()</strong> call:<p class="source-code">    continue</p><p class="source-code">   }</p></li>
				<li>If the button is not pressed, we turn the LED off:<p class="source-code">    led.Low()</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">Do not forget to import the <strong class="source-inline">machine</strong> package, otherwise the code will not compile.</p></li>
			</ol>
			<p>Now flash the program using the <strong class="source-inline">tinygo flash</strong> command:</p>
			<p class="source-code">tinygo flash –target=arduino Chapter02/light-button/main.go</p>
			<p>After<a id="_idIndexMarker099"/> successfully flashing, the LED should light up when you press the button.</p>
			<h3>The pull-up resistor</h3>
			<p>You may have<a id="_idIndexMarker100"/> wondered why we need a 10K Ohm resistor in the button circuit. The 10K Ohm resistor is used to prevent the signal/pin from floating. Floating pins are bad, as an input pin in a floating state is indeterminate. When trying to read a value from a pin, we expect to get a digital value – 1 or 0, or true or false. Floating means that the value can change rapidly between 1 and 0, which happens without pull-up or pull-down resistors. Here's some further reading on floating pins: <a href="https://www.mouser.com/blog/dont-leave-your-pins-floating">https://www.mouser.com/blog/dont-leave-your-pins-floating</a>.</p>
			<p>As an alternative to the 10K Ohm external resistor, an internal resistor can be used. </p>
			<p>Configuring an input pin to use an internal resistor is done as follows: </p>
			<p class="source-code">inputConfig := machine.PinConfig{</p>
			<p class="source-code">               Mode: machine.PinInputPullup</p>
			<p class="source-code">}</p>
			<p>We have now learned how to control an LED using an input signal, which was given by a button. The next step is to build the traffic lights flow to control three LEDs. </p>
			<h1 id="_idParaDest-47"><a id="_idTextAnchor047"/>Building traffic lights</h1>
			<p>We know how<a id="_idIndexMarker101"/> to light up a single LED, and we also know how to light up an LED using a button input. The next step is to build a circuit using three LEDs and to write the code to light them up in the correct order.</p>
			<h2 id="_idParaDest-48"><a id="_idTextAnchor048"/>Building the circuit</h2>
			<p>To build <a id="_idIndexMarker102"/>the circuit, we need the following components:</p>
			<ul>
				<li>Three LEDs (preferably red, yellow, and green)</li>
				<li>Three 220 Ohm resistors</li>
				<li>Seven jumper wires</li>
			</ul>
			<p>We start by first setting up the components using the following steps:</p>
			<ol>
				<li value="1">Connect <em class="italic">GND</em> from the Arduino to any ground port on the power bus.</li>
				<li>Place the first (red) LED with the cathode in <em class="italic">G12</em> and the anode in <em class="italic">G13</em>.</li>
				<li>Place the second (yellow) LED with the cathode in <em class="italic">G15</em> and the anode in <em class="italic">G16</em>.</li>
				<li>Place the third (green) LED with the cathode in <em class="italic">G18</em> and the anode in <em class="italic">G19</em>.</li>
				<li>Connect <em class="italic">F13</em> with <em class="italic">D13</em> using a 220 Ohm resistor.</li>
				<li>Connect <em class="italic">F16</em> with <em class="italic">D16</em> using a 220 Ohm resistor.</li>
				<li>Connect <em class="italic">F19</em> with <em class="italic">D19</em> using a 220 Ohm resistor.</li>
				<li>Connect <em class="italic">F13</em> to <em class="italic">Ground</em> on the power bus using a jumper wire.</li>
				<li>Connect <em class="italic">F16</em> to <em class="italic">Ground</em> on the power bus using a jumper wire.</li>
				<li>Connect <em class="italic">F19</em> to <em class="italic">Ground</em> on the power bus using a jumper wire.</li>
				<li>Connect<a id="_idIndexMarker103"/> port <em class="italic">D13</em> to <em class="italic">A12</em> using a jumper wire.</li>
				<li>Connect port <em class="italic">D16</em> to <em class="italic">A12</em> using a jumper wire.</li>
				<li>Connect port <em class="italic">D19</em> to <em class="italic">A12</em> using a jumper wire.</li>
			</ol>
			<p>Your circuit should now look similar to the following figure:</p>
			<div>
				<div id="_idContainer024" class="IMG---Figure">
					<img src="Images/Figure_2.6_B16555.jpg" alt="Figure 2.6 – The traffic lights circuit – image taken from Fritzing&#13;&#10;" width="1345" height="943"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.6 – The traffic lights circuit – image taken from Fritzing</p>
			<p>We have now<a id="_idIndexMarker104"/> successfully set up the circuit. Now we can continue to write some code to control the LEDs.</p>
			<h2 id="_idParaDest-49"><a id="_idTextAnchor049"/>Creating a folder structure</h2>
			<p>We start off by<a id="_idIndexMarker105"/> creating a new folder named <strong class="source-inline">traffic-lights-simple</strong> inside the <strong class="source-inline">Chapter02</strong><strong class="bold"> </strong>folder. Also, we create a <strong class="source-inline">main.go</strong> file inside the new folder and start off with an empty <strong class="source-inline">main</strong> function. Your project structure should now look like this:</p>
			<div>
				<div id="_idContainer025" class="IMG---Figure">
					<img src="Images/Figure_2.7_B16555.jpg" alt="Figure 2.7 - Folder structure for the circuit&#13;&#10;" width="237" height="133"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.7 - Folder structure for the circuit</p>
			<h2 id="_idParaDest-50"><a id="_idTextAnchor050"/>Writing the logic</h2>
			<p>We have<a id="_idIndexMarker106"/> successfully set up our project structure to continue. We are going to implement the following flow: </p>
			<p><em class="italic">RED -&gt; RED-YELLOW -&gt; GREEN -&gt; YELLOW -&gt; RED</em></p>
			<p>This is a typical flow for traffic lights with three bulbs. </p>
			<p>We are going to configure three pins as output, and afterward, we want to endlessly loop and light up the LEDs in this flow. </p>
			<p>Inside the <strong class="source-inline">main</strong> function, we write the following:</p>
			<ol>
				<li value="1">Initialize a new variable named <strong class="source-inline">outputConfig</strong> as <strong class="source-inline">PinConfig</strong> using the <strong class="source-inline">PinOutPut</strong> mode:<p class="source-code">outputConfig := machine.PinConfig{Mode: machine.</p><p class="source-code">                PinOutput}</p></li>
				<li>Initialize a new variable named <strong class="source-inline">redLED</strong> with the value <strong class="source-inline">machine.D13</strong> and configure it as output:<p class="source-code">redLED := machine.D13</p><p class="source-code">redLED.Configure(outputConfig)</p></li>
				<li>Initialize a new variable named <strong class="source-inline">yellowLED</strong> with the value <strong class="source-inline">machine.D12</strong> and configure it as output:<p class="source-code">yellowLED := machine.D12</p><p class="source-code">yellowLED.Configure(outputConfig)</p></li>
				<li>Initialize a new variable named <strong class="source-inline">greenLED</strong> with the value <strong class="source-inline">machine.D11</strong> and configure it as output:<p class="source-code">greenLED := machine.D11</p><p class="source-code">greenLED.Configure(outputConfig)</p></li>
			</ol>
			<p>We have now initialized our variables to act as output pins. The next step is to light up the LEDs in the correct order. We basically have four phases, which just need to repeat in order to simulate a real traffic light. Let's go through these one by one:</p>
			<ol>
				<li value="1">We are going to handle the phases in an endless loop:<p class="source-code">for {</p></li>
				<li>For <em class="italic">RED-Phase</em>, turn on the red LED and wait for a second:<p class="source-code">    redLED.High()</p><p class="source-code">    time.Sleep(time.Second)</p></li>
				<li>For <em class="italic">RED-YELLOW-Phase</em>, turn on the yellow LED and wait for a second:<p class="source-code">    yellowLED.High()</p><p class="source-code">    time.Sleep(time.Second)</p></li>
				<li>For <em class="italic">GREEN-PHASE</em>, turn<a id="_idIndexMarker107"/> off the yellow and red LEDs and turn on the green LED and wait for a second:<p class="source-code">    redLED.Low()</p><p class="source-code">    yellowLED.Low()</p><p class="source-code">    greenLED.High()</p><p class="source-code">    time.Sleep(time.Second)</p></li>
				<li>For <em class="italic">YELLOW-Phase</em>, turn off the green LED and turn on the yellow LED, then wait for a second and turn off yellow again, so we can start cleanly with <em class="italic">RED-Phase</em> again:<p class="source-code">    greenLED.Low()</p><p class="source-code">    yellowLED.High()</p><p class="source-code">    time.Sleep(time.Second)</p><p class="source-code">    yellowLED.Low()</p><p class="source-code">}</p></li>
			</ol>
			<p>The complete content of the function is available at the following URL:</p>
			<p><a href="https://github.com/PacktPublishing/Programming-Microcontrollers-and-WebAssembly-with-TinyGo/blob/master/Chapter02/traffic-lights-simple/main.go">https://github.com/PacktPublishing/Programming-Microcontrollers-and-WebAssembly-with-TinyGo/blob/master/Chapter02/traffic-lights-simple/main.go</a></p>
			<p class="callout-heading">Note</p>
			<p class="callout">Don't forget to import the <strong class="source-inline">time</strong> and <strong class="source-inline">machine</strong> packages.</p>
			<p>We have now assembled and programmed a complete traffic lights flow. The next step is to combine <a id="_idIndexMarker108"/>everything we have built to complete our project.</p>
			<h1 id="_idParaDest-51"><a id="_idTextAnchor051"/>Building traffic lights with pedestrian lights</h1>
			<p>We will now <a id="_idIndexMarker109"/>combine everything we have learned and done in this chapter to create an even more realistic traffic lights system. We will do so by assembling a circuit that contains the three-bulb traffic lights from the previous step and adding pedestrian lights with two bulbs that are controlled by a button.</p>
			<h2 id="_idParaDest-52"><a id="_idTextAnchor052"/>Assembling the circuit</h2>
			<p>For our <a id="_idIndexMarker110"/>final project in this chapter, we need the following:</p>
			<ul>
				<li>Five LEDs: preferably two red, one yellow, and two green</li>
				<li>Five 220 Ohm resistors, one for each LED</li>
				<li>One 10K Ohm resistor as a pull-up resistor for our push button</li>
				<li>One 4-pin push button</li>
				<li>14 jumper wires</li>
			</ul>
			<p>We start by setting up the three-bulb traffic lights using the following steps:</p>
			<ol>
				<li value="1">Place the first LED (red) with the cathode on <em class="italic">G12</em> and the anode on <em class="italic">G13</em>.</li>
				<li>Place the second LED (yellow) with the cathode on <em class="italic">G15</em> and the anode on <em class="italic">G16</em>.</li>
				<li>Place the third LED (green) with the cathode on <em class="italic">G18</em> and the anode on <em class="italic">G19</em>.</li>
				<li>Use a 220 Ohm resistor to connect <em class="italic">F13</em> with <em class="italic">D13</em>.</li>
				<li>Use a 220 Ohm resistor to connect <em class="italic">F16</em> with <em class="italic">D16</em>.</li>
				<li>Use a 220 Ohm resistor to connect <em class="italic">F19</em> with <em class="italic">D19</em>.</li>
				<li>Connect pin <em class="italic">D13</em> with <em class="italic">A13</em> using a jumper wire.</li>
				<li>Connect pin <em class="italic">D12</em> with <em class="italic">A16</em> using a jumper wire.</li>
				<li>Connect pin <em class="italic">D11</em> with <em class="italic">A10</em> using a jumper wire.</li>
				<li>Connect <em class="italic">F12</em> with Ground on the power bus using a jumper wire.</li>
				<li>Connect <em class="italic">F15</em> with Ground on the power bus using a jumper wire.</li>
				<li>Connect <em class="italic">F18</em> with Ground on the power bus using a jumper wire.</li>
			</ol>
			<p>Now <a id="_idIndexMarker111"/>assemble the pedestrian lights using the following steps:</p>
			<ol>
				<li value="1">Place the fourth LED (red) with the cathode on <em class="italic">G22</em> and the anode on <em class="italic">G23</em>.</li>
				<li>Place the fifth LED (green) with the cathode on <em class="italic">G25</em> and the anode on <em class="italic">G26</em>.</li>
				<li>Use a 220 Ohm resistor to connect <em class="italic">F23</em> with <em class="italic">D23</em>.</li>
				<li>Use a 220 Ohm resistor to connect <em class="italic">F26</em> with <em class="italic">D26</em>.</li>
				<li>Connect pin <em class="italic">D5</em> with <em class="italic">A23</em> using a jumper wire.</li>
				<li>Connect pin <em class="italic">D4</em> with <em class="italic">A26</em> using a jumper wire.</li>
				<li>Connect <em class="italic">F22</em> with Ground on the power bus using a jumper wire.</li>
				<li>Connect <em class="italic">F24</em> with Ground on the power bus using a jumper wire.</li>
			</ol>
			<p>Now we only need to assemble the button and connect the power bus:</p>
			<ol>
				<li value="1">Place a push button with the left pins in <em class="italic">E29</em> and <em class="italic">F29</em> and the right pins on <em class="italic">E31</em> and <em class="italic">F31</em>.</li>
				<li>Use a 10K Ohm resistor to connect the Ground from the power bus with <em class="italic">B29</em>.</li>
				<li>Connect pin <em class="italic">D2</em> with <em class="italic">C29</em> using a jumper wire.</li>
				<li>Connect <em class="italic">A31</em> with the positive lane on the power bus using a jumper wire.</li>
				<li>Connect the positive lane on the power bus with the 5V port on the Arduino UNO using a jumper wire.</li>
				<li>Connect the ground lane on the power bus with a ground port on the Arduino UNO using a jumper wire.</li>
			</ol>
			<p>When <a id="_idIndexMarker112"/>you've finished assembling, your circuit should look like this:</p>
			<div>
				<div id="_idContainer026" class="IMG---Figure">
					<img src="Images/Figure_2.8_B16555.jpg" alt="Figure 2.8 – Circuit for the traffic lights with pedestrian lights controlled by &#13;&#10;a button – image taken from Fritzing&#13;&#10;" width="1364" height="956"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.8 – Circuit for the traffic lights with pedestrian lights controlled by a button – image taken from Fritzing</p>
			<p>Great, we have now completely assembled our final project for this chapter. We can now write<a id="_idIndexMarker113"/> some code to bring this project to life. </p>
			<h2 id="_idParaDest-53"><a id="_idTextAnchor053"/>Setting up the project structure</h2>
			<p>We start <a id="_idIndexMarker114"/>off by creating a new folder named <strong class="source-inline">traffic-lights-pedestrian</strong> inside the <strong class="source-inline">Chapter02</strong> folder. Inside the new folder, we create a new <strong class="source-inline">main.go</strong> file with an empty <strong class="source-inline">main</strong> function.</p>
			<p>Our project structure should now look like the following:</p>
			<div>
				<div id="_idContainer027" class="IMG---Figure">
					<img src="Images/Figure_2.9_B16555.jpg" alt="Figure 2.9 - Project structure for the project&#13;&#10;" width="237" height="133"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.9 - Project structure for the project</p>
			<h2 id="_idParaDest-54"><a id="_idTextAnchor054"/>Writing the logic</h2>
			<p>We are<a id="_idIndexMarker115"/> going to split the program into three parts:</p>
			<ul>
				<li>Initialization logic</li>
				<li>Main logic</li>
				<li><strong class="source-inline">trafficLights</strong> logic</li>
			</ul>
			<h3>Initializing the logic</h3>
			<p>We need to<a id="_idIndexMarker116"/> initialize a <strong class="source-inline">stopTraffic</strong> variable and configure the pins for the LEDs as output pins using the following steps:</p>
			<ol>
				<li value="1">We start off by declaring a <strong class="source-inline">bool</strong> variable named <strong class="source-inline">stopTraffic</strong> at the package level. This variable is going to be used as a communication channel between our two logic parts:<p class="source-code">var stopTraffic bool</p></li>
				<li>The first thing we do in the <strong class="source-inline">main</strong> method is set the value of <strong class="source-inline">stopTraffic</strong> to <strong class="source-inline">false</strong>:<p class="source-code">stopTraffic = false</p></li>
				<li>We declare and initialize a new variable named <strong class="source-inline">outputConfig</strong> with <strong class="source-inline">PinConfig</strong> in <strong class="source-inline">PinOutput</strong> mode. We are going to pass this config to all LED pins:<p class="source-code">outputConfig := machine.PinConfig{Mode: machine.</p><p class="source-code">                PinOutput}</p></li>
				<li>We initialize some new variables: <strong class="source-inline">greenLED</strong> with the value <strong class="source-inline">machine.D11</strong>, <strong class="source-inline">yellowLED</strong> with the value <strong class="source-inline">machine.D12</strong>, and <strong class="source-inline">redLED</strong> with the value <strong class="source-inline">machine.D13</strong>. Then, we configure each LED variable as output pins:<p class="source-code">greenLED := machine.D11</p><p class="source-code">greenLED.Configure(outputConfig)</p><p class="source-code">yellowLED := machine.D12</p><p class="source-code">yellowLED.Configure(outputConfig)</p><p class="source-code">redLED := machine.D13</p><p class="source-code">redLED.Configure(outputConfig)</p></li>
				<li>We initialize <a id="_idIndexMarker117"/>some new variables: <strong class="source-inline">pedestrianGreen</strong> with the value <strong class="source-inline">machine.D4</strong> and <strong class="source-inline">pedestrianRed</strong> with the value <strong class="source-inline">machine.D5</strong>. Then, we configure each LED variable as output pins:<p class="source-code">pedestrianGreen := machine.D4</p><p class="source-code">pedestrianGreen.Configure(outputConfig)</p><p class="source-code">pedestrianRed := machine.D5</p><p class="source-code">pedestrianRed.Configure(outputConfig)</p></li>
				<li>We declare and initialize a new variable named <strong class="source-inline">inputConfig</strong> with <strong class="source-inline">PinConfig</strong> in <strong class="source-inline">PinInput</strong> mode. Then, we declare and initialize a new variable named <strong class="source-inline">buttonInput</strong> with the value <strong class="source-inline">machine.D2</strong> and configure <strong class="source-inline">buttonInput</strong> as the input pin:<p class="source-code">inputConfig := machine.PinConfig{Mode: machine.PinInput}</p><p class="source-code">buttonInput := machine.D2</p><p class="source-code">buttonInput.Configure(inputConfig)</p></li>
			</ol>
			<p>That's it for the <a id="_idIndexMarker118"/>initialization. We have set up all pins and a Boolean variable at the package level. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">The pin constants, such as <strong class="source-inline">machine.D13</strong>, are of the <strong class="source-inline">machine.Pin</strong> type.</p>
			<h3>Writing the trafficLights logic</h3>
			<p>We will now<a id="_idIndexMarker119"/> write the complete logic to control all the LEDs in our circuit. This is going to be the first time that we have to move some parts of the code into other functions. </p>
			<p>To do that, we start by writing a new function named <strong class="source-inline">trafficLights</strong> that <em class="italic">takes all five LED pins as parameters</em> and has <em class="italic">no return value</em>. Inside the function, we start off with an empty, endless loop. Our function should now look like the following: </p>
			<p class="source-code">func trafficLights(redLED, greenLED, yellowLED, pedestrianRED, </p>
			<p class="source-code">    pedestrianGreen machine.Pin) {</p>
			<p class="source-code">      for {</p>
			<p class="source-code">      }</p>
			<p class="source-code">}</p>
			<p>All the logic will be placed inside the <strong class="source-inline">for</strong> loop. The actual logic in the loop consists of two parts:</p>
			<ul>
				<li>Handling signals from the button to stop the traffic and control the pedestrian lights</li>
				<li>Controlling the normal traffic lights flow</li>
			</ul>
			<p>We start off with handling the signals from the button. To do that, we check <strong class="source-inline">for</strong> <strong class="source-inline">stopTraffic</strong> in <a id="_idIndexMarker120"/>the <strong class="source-inline">if</strong>, and also have an empty <strong class="source-inline">else</strong> branch. It looks like the following:</p>
			<p class="source-code">        if stopTraffic {</p>
			<p class="source-code">    } else {</p>
			<p class="source-code">}</p>
			<p>So, when <strong class="source-inline">stopTraffic</strong> is <strong class="source-inline">true</strong>, we want to set our traffic lights phase to be <em class="italic">red</em>. Also, we want to set the pedestrian lights phase to <em class="italic">green</em> for 3 seconds and then back to <em class="italic">red</em> and set <strong class="source-inline">stopTraffic</strong> to <strong class="source-inline">false</strong> afterward, as we handled the signal one time. </p>
			<p>Let's implement this logic using the following steps:</p>
			<ol>
				<li value="1">Set traffic lights phase to red:<p class="source-code">redLED.High()</p><p class="source-code">yellowLED.Low()</p><p class="source-code">greenLED.Low()</p></li>
				<li> Set the pedestrian lights phase to green for 3 seconds:<p class="source-code">pedestrianGreen.High()</p><p class="source-code">pedestrianRED.Low()</p><p class="source-code">time.Sleep(3 * time.Second)</p></li>
				<li> Set the pedestrian lights phase to <em class="italic">red</em>:<p class="source-code">pedestrianGreen.Low()</p><p class="source-code">pedestrianRED.High()</p></li>
				<li> Set <strong class="source-inline">stopTraffic</strong> to <strong class="source-inline">false</strong>, as we have handled the signal:<p class="source-code">stopTraffic = false</p></li>
				<li>In the <strong class="source-inline">else</strong> block, we just reset the pedestrian lights state to red:<p class="source-code">pedestrianGreen.Low()</p><p class="source-code">pedestrianRED.High()</p></li>
			</ol>
			<p>Okay, that is the part that reacts to <strong class="source-inline">stopTraffic</strong> signals. Underneath that <strong class="source-inline">if-else</strong> block, we are going to implement the actual logic to control the traffic lights flow, which is the same as done earlier. So, we start with the <em class="italic">red</em> phase, transit to the <em class="italic">red-yellow</em> phase, then<a id="_idIndexMarker121"/> to <em class="italic">green</em>, then to <em class="italic">yellow</em>, and then reset <em class="italic">yellow</em> to be able to start clean again, as follows:</p>
			<p class="source-code">redLED.High()</p>
			<p class="source-code">time.Sleep(time.Second)</p>
			<p class="source-code">yellowLED.High()</p>
			<p class="source-code">time.Sleep(time.Second)</p>
			<p class="source-code">redLED.Low()</p>
			<p class="source-code">yellowLED.Low()</p>
			<p class="source-code">greenLED.High()</p>
			<p class="source-code">time.Sleep(time.Second)</p>
			<p class="source-code">greenLED.Low()</p>
			<p class="source-code">yellowLED.High()</p>
			<p class="source-code">time.Sleep(time.Second)</p>
			<p class="source-code">yellowLED.Low()</p>
			<p>That is all that we have to do in the <strong class="source-inline">trafficLights</strong> function.</p>
			<h3>Implementing the main logic</h3>
			<p>Now we<a id="_idIndexMarker122"/> only need to run the <strong class="source-inline">trafficLights</strong> function and handle the button input at the same time. This is <a id="_idIndexMarker123"/>where <strong class="bold">goroutines</strong> come in. As microcontrollers only have one processor core, which works with a single thread, we cannot have real parallel execution of tasks. As we use goroutines on an Arduino UNO, we will need some additional build parameters. We are going to learn about these parameters later, when we flash the program. In our case, we want to have a listener on the button, while still being able to step through the traffic lights process. The logic consists of three steps:</p>
			<ol>
				<li value="1">Initialize the pedestrian lights with the <strong class="source-inline">red</strong> phase.</li>
				<li>Run the <strong class="source-inline">trafficLights</strong> function in a goroutine.</li>
				<li>Handle the button input.</li>
			</ol>
			<p>For the first part, we only have to set the <strong class="source-inline">pedestrianRED</strong> LED to <strong class="source-inline">High</strong> and the <strong class="source-inline">pedestrianGreen</strong> LED to <strong class="source-inline">Low</strong>:</p>
			<p class="source-code">pedestrianRed.High()</p>
			<p class="source-code">pedestrianGreen.Low()</p>
			<p>Now we just call <strong class="source-inline">trafficLights</strong> and pass all necessary parameters using a goroutine:</p>
			<p class="source-code">go trafficLights(redLED, greenLED, yellowLED, pedestrianRed, pedestrianGreen)</p>
			<p>For the last step, we need an endless loop that checks for <strong class="source-inline">buttonInput</strong> and to set <strong class="source-inline">stopTraffic</strong> to <strong class="source-inline">true</strong> if the button is pressed. We also need it to sleep for 50 milliseconds afterward:</p>
			<p class="source-code">for {</p>
			<p class="source-code">  if buttonInput.Get() {</p>
			<p class="source-code">    stopTraffic = true</p>
			<p class="source-code">  }</p>
			<p class="source-code">  time.Sleep(50 * time.Millisecond)</p>
			<p class="source-code">}</p>
			<p class="callout-heading">Note</p>
			<p class="callout">It is necessary to add a sleep time to the loop that handles the button input because the scheduler needs time to run the goroutine. The goroutine is being handled in the time that the main function is sleeping. Also, other blocking functions, such as reading from a channel, can be used to give the scheduler time to work on other tasks.</p>
			<p>As we now have completed our logic, it is time to flash the program onto the controller. As we are using goroutines in this project, we need to pass additional parameters to the <strong class="source-inline">tinygo flash</strong> command:</p>
			<p class="source-code">tinygo flash <strong class="bold">-scheduler tasks</strong> -target=arduino Chapter02/traffic-lights-pedestrian/main.go</p>
			<p>As the ATmega328p has very limited resources, the scheduler is deactivated by default on boards that <a id="_idIndexMarker124"/>use this microcontroller. The Arduino UNO is such a board. When using other microcontrollers, we would normally not need to override the default scheduler by setting this parameter.</p>
			<p>We have now successfully flashed our program to the Arduino Uno. The traffic lights should start looping all phases and the pedestrian lights should remain in the <em class="italic">red</em> phase. When clicking the button, the traffic lights should end their loop and then the pedestrian lights should switch to the <em class="italic">green</em> phase, while the traffic lights remain on the <em class="italic">red</em> phase for 3 seconds. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">Due to the very limited memory on the Arduino Uno, working with goroutines might only work in projects that are not very complex, such as this one.</p>
			<h1 id="_idParaDest-55"><a id="_idTextAnchor055"/>Summary</h1>
			<p>We have learned how to build a fully functional traffic lights system with pedestrian lights controlled by a button. We achieved this by building each part of the project separately and assembling it all together at the end. </p>
			<p>We learned how to use breadboards, how the color codes on resistors work, why we use resistors when controlling LEDs, and how external LEDs are assembled. Also, we learned how to use push buttons, how to prevent floating signals using pullup resistors, and how to utilize goroutines in TinyGo. </p>
			<p>In the next chapter, we are going to learn how to read input from a 4x4 keypad and how to control a servo motor. We are going to utilize this knowledge to build a safety lock that opens when the correct passcode is entered.</p>
			<h1 id="_idParaDest-56"><a id="_idTextAnchor056"/>Questions</h1>
			<ol>
				<li value="1">Why do we place a resistor between an LED anode and the GPIO port?</li>
				<li>How do we stop a signal from floating?</li>
				<li>Why do we sleep after checking a button's state?</li>
				<li>How would you modify the code to achieve the following behavior?<p>a. When the button is pressed, turn off the red and green LEDs of the traffic lights and let the yellow LED blink.</p><p>b. When the button is pressed again: go back to the normal phase rotation.</p></li>
			</ol>
			<h1 id="_idParaDest-57"><a id="_idTextAnchor057"/>Further reading</h1>
			<ul>
				<li>Resistor Color Conversion Calculator: <a href="https://www.digikey.com/en/resources/conversion-calculators/conversion-calculator-resistor-color-code">https://www.digikey.com/en/resources/conversion-calculators/conversion-calculator-resistor-color-code</a></li>
				<li>Goroutines in TinyGo: <a href="https://aykevl.nl/2019/02/tinygo-goroutines">https://aykevl.nl/2019/02/tinygo-goroutines</a></li>
			</ul>
		</div>
	</div></body></html>