<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer063">
			<h1 id="_idParaDest-82"><em class="italic"><a id="_idTextAnchor082"/>Chapter 4</em>: Building a Plant Watering System</h1>
			<p>In the previous chapters, we learned how to write to the serial port and how to monitor the serial port on our computers. Furthermore, we learned how to write drivers for components, which have not yet been implemented by the TinyGo community, and we used this knowledge to write a driver for a 4x4 keypad and a servo motor in <a href="B16555_03_Final_VK_ePub.xhtml#_idTextAnchor058"><em class="italic">Chapter 3</em></a>, <em class="italic">Building a Safety Lock Using a Keypad</em>.</p>
			<p>We are now going to build on top of this knowledge in this chapter by introducing a new type of pin and we are going to build an automated plant watering system using some new devices. We will be able to pump water from a container into a plant's soil, measure the soil's moisture, check the water level of a container, and let a buzzer beep when the water level in the container is below a certain threshold. This will be achieved by splitting the project up into single steps and putting it all together at the end of the chapter.</p>
			<p>After working through this chapter, we will know how to read input from analog pins, how to measure thresholds in sensor data, how to let a buzzer beep, and how to control a pump using relays.</p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Reading soil moisture sensor data</li>
				<li>Reading water level sensor data</li>
				<li>Controlling a buzzer</li>
				<li>Controlling a pump</li>
				<li>Watering your plants</li>
			</ul>
			<h1 id="_idParaDest-83"><a id="_idTextAnchor083"/>Technical requirements</h1>
			<p>We are going to need the following components for this project:</p>
			<ul>
				<li>An Arduino UNO</li>
				<li>Capacitive Soil Moisture Sensor v1.2</li>
				<li>K-0135 Water Level Sensor</li>
				<li>Passive buzzer with 2 pins</li>
				<li>Micro submersible water pump DC 3V-5V</li>
				<li>Breadboard power supply module </li>
				<li>Jumper wires</li>
				<li>One breadboard</li>
				<li>One 100 Ohm resistor</li>
			</ul>
			<p>These components can usually be found in online stores and also in local electronic supply stores. Most components used in this book are also part of so-called <strong class="bold">Arduino Starter Kits</strong>.</p>
			<p>You can find the code for this chapter on GitHub: <a href="https://github.com/PacktPublishing/Creative-DIY-Microcontroller-Projects-with-TinyGo-and-WebAssembly/tree/master/Chapter04">https://github.com/PacktPublishing/Creative-DIY-Microcontroller-Projects-with-TinyGo-and-WebAssembly/tree/master/Chapter04</a></p>
			<p>The Code in Action video for the chapter can be found here: <a href="https://bit.ly/3tlhRnx">https://bit.ly/3tlhRnx</a></p>
			<h1 id="_idParaDest-84"><a id="_idTextAnchor084"/>Reading soil moisture sensor data</h1>
			<p>When <a id="_idIndexMarker192"/>automatically watering plants, we need to know when we have to add water to the soil. An easy way to detect that the soil is too dry is to use a soil moisture sensor. We are going to use a capacitive soil moisture sensor in this project, which provides the readings as an analog signal.</p>
			<p>The sensor has the following technical specifications:</p>
			<ul>
				<li>A 3.3 V to 5.0 V supply range</li>
				<li>A 3.3 V operating range</li>
				<li>An analog output in the range of 1.5 V to 3.3 V</li>
				<li>An operating current of 5 mA</li>
			</ul>
			<p>Sensors from other manufacturers might differ slightly in these specs. Datasheets are usually <a id="_idIndexMarker193"/>provided by the vendor you buy the hardware from. We'll now start off by assembling the circuit.</p>
			<h2 id="_idParaDest-85"><a id="_idTextAnchor085"/>Assembling the circuit</h2>
			<p>We<a id="_idIndexMarker194"/> only need some cables, the sensor itself, and a breadboard to begin with. Depending on the manufacturer of the sensor, the labels on the port of your sensor might differ. The one I use has the following labels:</p>
			<ul>
				<li>AOUT (short for <strong class="bold">Analog out</strong>)</li>
				<li>VCC (+) (short for <strong class="bold">Voltage Common Collector</strong>)</li>
				<li>GND (-) (stands for <strong class="bold">Ground</strong>)</li>
			</ul>
			<p> Now assemble the circuit as per the following list:</p>
			<ol>
				<li value="1">Connect the <em class="italic">GND</em> port to <em class="italic">GND</em> on the power bus using a jumper wire.</li>
				<li>Connect port <em class="italic">D2 </em>to <em class="italic">A1</em> on the breadboard using a jumper wire.</li>
				<li>Connect port <em class="italic">A5 </em>to <em class="italic">A2</em> on the breadboard using a jumper wire.</li>
				<li>Connect <em class="italic">E1 </em>on the breadboard to <em class="italic">AOUT</em> on the sensor.</li>
				<li>Connect <em class="italic">E2 </em>to <em class="italic">VCC</em> on the sensor.</li>
				<li>Connect <em class="italic">GND</em> from the power bus with <em class="italic">GND</em> on the sensor.</li>
			</ol>
			<p>Your circuit should now look similar to the following figure:</p>
			<div>
				<div id="_idContainer046" class="IMG---Figure">
					<img src="Images/Figure_4.1_B16555.jpg" alt="Figure 4.1 – Soil Sensor Circuit  image taken from Fritzing&#13;&#10;" width="1501" height="1233"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.1 – Soil sensor circuit – image taken from Fritzing</p>
			<p class="figure-caption">Figure 4.1 – Soil Sensor Circuit  image taken from Fritzing</p>
			<p>Great! We <a id="_idIndexMarker195"/>have successfully assembled the circuit. We are going to use this circuit to create a small sample project to read values from the sensor.</p>
			<h2 id="_idParaDest-86"><a id="_idTextAnchor086"/>Finding thresholds</h2>
			<p>Our next<a id="_idIndexMarker196"/> task is to find out the values that indicate the following states:</p>
			<ul>
				<li>Dry</li>
				<li>In water</li>
			</ul>
			<p>To check the dryness, we need to create a new folder for this project.</p>
			<p>Start off by creating a new folder named <strong class="source-inline">Chapter04</strong>. Inside this folder, create a new folder named <strong class="source-inline">soil-moisture-sensor-thresholds</strong> and inside this folder, create a new <strong class="source-inline">main.go</strong> file and insert an empty <strong class="source-inline">main()</strong> function. The folder structure should now look like the following:</p>
			<div>
				<div id="_idContainer047" class="IMG---Figure">
					<img src="Images/Figure_4.2_B16555.jpg" alt="Figure 4.2 – Folder structure for Soil moisture sensor threshold&#13;&#10;" width="323" height="40"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.2 – Folder structure for Soil moisture sensor threshold</p>
			<p>Now follow<a id="_idIndexMarker197"/> these steps:</p>
			<ol>
				<li value="1">Import the <strong class="source-inline">machine</strong> package as follows:<p class="source-code">import "machine"</p></li>
				<li>Initialize the registers needed for ADC:<p class="source-code">machine.InitADC()</p></li>
				<li>Create a new variable named <strong class="source-inline">soilSensor</strong> of the type <strong class="source-inline">machine.ADC</strong> with <strong class="source-inline">Pin machine.ADC5</strong>:<p class="source-code">soilSensor := machine.ADC{Pin: machine.ADC5}</p></li>
				<li>Configure the pin so it is able to read analog values:<p class="source-code">soilSensor.Configure()</p></li>
				<li>Configure the machine D2 pin as output and set it to <strong class="source-inline">high</strong>. We do not store this inside a new variable, as we will never change the state of the pin again. We only use it to provide currency:<p class="source-code">machine.D2.Configure(machine.PinConfig{Mode: machine.PinOutput})</p><p class="source-code">machine.D2.High()</p></li>
				<li>Read the sensor value two times a second in an endless loop and print it to the serial port:<p class="source-code">for {</p><p class="source-code">    value := soilSensor.Get()</p><p class="source-code">    println(value)</p><p class="source-code">    time.Sleep(500 * time.Millisecond)</p><p class="source-code">}</p></li>
			</ol>
			<p>Great, we have<a id="_idIndexMarker198"/> successfully written our first program that reads sensor data from an analog pin. Now we need to ascertain threshold values. To do so, first flash the program onto your Arduino using the following command: </p>
			<p class="source-code">tinygo flash –target=arduino Chapter04/soil-moisture-sensor-thresholds/main.go</p>
			<p>Now open up PuTTY and select the microcontroller profile to see the sensor readings. This should look like the following screenshot: </p>
			<div>
				<div id="_idContainer048" class="IMG---Figure">
					<img src="Images/Figure_4.3_B16555.jpg" alt="Figure 4.3 – Soil moisture sensor output in PuTTY&#13;&#10;" width="506" height="363"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.3 – Soil moisture sensor output in PuTTY</p>
			<p>The value is pretty stable at <strong class="bold">37888</strong>. You might notice some small changes in the value between the readings. Just take the highest value you see in that case. </p>
			<p>We are now <a id="_idIndexMarker199"/>going to declare <strong class="bold">37888</strong> as the threshold for dry values. So, everything equal or above this value can be considered completely dry. The values that you receive from your sensor might differ a bit, so you can just do the same; have a look at the values, and take the lowest one as your threshold.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Take care that your sensor is completely dry and clean. Otherwise, you might get in trouble with your dry value.</p>
			<p>Excellent! We just managed to find out the value for completely dry soil. Now we need to find a value for being completely wet (in water).</p>
			<p>Now take a glass of water and put the sensor in there, while watching the sensor readings in PuTTY. <strong class="bold">Be really careful that you only put the sensor so deep in the water that it reaches the white line on it!</strong> Do not let the water touch the electronics above! Check the following figure for this:</p>
			<div>
				<div id="_idContainer049" class="IMG---Figure">
					<img src="Images/Figure_4.4_B16555.jpg" alt="Figure 4.4 – Capacitive Soil Moisture Sensor in a glass of water&#13;&#10;" width="759" height="1012"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.4 – Capacitive Soil Moisture Sensor in a glass of water</p>
			<p>Let's have a<a id="_idIndexMarker200"/> look at the sensor readings in PuTTY – you can find them in the following figure:</p>
			<div>
				<div id="_idContainer050" class="IMG---Figure">
					<img src="Images/Figure_4.5_B16555.jpg" alt="Figure 4.5 – Soil sensor readings from inside a glass of water in PuTTY&#13;&#10;" width="506" height="363"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.5 – Soil sensor readings from inside a glass of water in PuTTY</p>
			<p>This time we take the<a id="_idIndexMarker201"/> highest value we can find in PuTTY as our threshold, which in my case is <strong class="bold">17856</strong>. We have used GPIO pins in all previous chapters, but <a id="_idIndexMarker202"/>we have not yet used the <strong class="bold">Analog Digital Converter</strong>, so let's understand how the <strong class="bold">Analog Digital Converter</strong> (<strong class="bold">ADC</strong>) works on Arduino before we continue to write a library for the sensor.</p>
			<h2 id="_idParaDest-87"><a id="_idTextAnchor087"/>Understanding ADC in TinyGo</h2>
			<p>The Arduino UNO ADC has<a id="_idIndexMarker203"/> 10-bit precision. The value returned by the <strong class="source-inline">Get()</strong> function is of the type <strong class="source-inline">uint16</strong>. So, internally, the <strong class="source-inline">Get()</strong> function tells the ADC to scale the 10-bit value to a 16-bit value.</p>
			<p>In general, we can use the following equation to get an ADC result:</p>
			<p class="source-code">Resolution of the ADC / System Voltage = ADC Value / Analog Voltage measured</p>
			<p>As we know that the Arduino UNO has 10-bit precision and the voltage is about <strong class="source-inline">5V</strong>, we can insert this into the equation to get the following: </p>
			<p class="source-code">1023 / 5V = ADC Value / Analog Voltage Measured</p>
			<p>Let's say the analog voltage measured is <strong class="source-inline">3.33V</strong>. This will result in the following:</p>
			<p class="source-code">1023 / 5V = ADC Value / 3.33V</p>
			<p>Now we do some math equation magic and get this:</p>
			<p class="source-code">1023 / 5V * 3.33V = ADC Value </p>
			<p class="source-code">That resolves to: ADC Value = 681</p>
			<p>This result will now scale to 16 bits, which equals a bit shift left by 6 bits. </p>
			<p>The result we would get from TinyGo would be like the following: </p>
			<p class="source-code">ADC Value = 43584</p>
			<p>Since we have now discovered how ADC works, we can now continue to write a small library that will help us use the sensor later on.</p>
			<h2 id="_idParaDest-88"><a id="_idTextAnchor088"/>Writing a library for the sensor</h2>
			<p>As having<a id="_idIndexMarker204"/> reusable code is a nice thing, we will now go on to write a small library, to reuse it in the last part of this chapter, <em class="italic">Watering your plants</em>. </p>
			<p>To do so, we need to create a new folder named <strong class="source-inline">soil-moisture-sensor</strong> inside the <strong class="source-inline">Chapter04</strong> folder. In our newly created folder, we create a new empty <strong class="source-inline">driver.go</strong> file and name the package <strong class="source-inline">soil</strong>. The structure should now look like the following: </p>
			<div>
				<div id="_idContainer051" class="IMG---Figure">
					<img src="Images/Figure_4.6_B16555.jpg" alt="Figure 4.6 – Folder structure for soil moisture sensor library&#13;&#10;" width="273" height="87"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.6 – Folder structure for soil moisture sensor library</p>
			<p>We want to have an interface that provides a function to get the current <strong class="source-inline">MoistureLevel</strong>, instance which will be an enum-like type. Also, we want to provide functionality to turn the sensor on and off, so it does not draw current all the time.</p>
			<p>To achieve<a id="_idIndexMarker205"/> that, perform the following steps:</p>
			<ol>
				<li value="1">Define a new interface named <strong class="source-inline">SoilSensor</strong> with <strong class="source-inline">Get()</strong>, <strong class="source-inline">Configure()</strong>, <strong class="source-inline">On()</strong>, and <strong class="source-inline">Off()</strong> functions:<p class="source-code">type SoilSensor interface {</p><p class="source-code">    Get() MoistureLevel</p><p class="source-code">    Configure()</p><p class="source-code">    On()</p><p class="source-code">    Off()</p><p class="source-code">}</p></li>
				<li>Define a new struct named <strong class="source-inline">soilSensor</strong>. This struct is going to contain the pin that is being used to turn the sensor on and off and the pin that is being used to read the sensor value. Also, we want to be able to configure thresholds that are used to identify whether the sensor is completely dry or is in water:<p class="source-code">type soilSensor struct {</p></li>
				<li>Add members that save the thresholds for <strong class="source-inline">completelyDry</strong> and <strong class="source-inline">water</strong>:<p class="source-code"> waterThreshold         uint16</p><p class="source-code"> completelyDryThreshold uint16</p><p class="source-code"> category               uint16</p><p class="source-code"> pin                    machine.Pin</p><p class="source-code"> adc                    machine.ADC</p><p class="source-code"> voltage                machine.Pin</p><p class="source-code">}</p></li>
				<li>Define an enum-like type so we can easily check for these values when using the library. We chose six <strong class="source-inline">MoistureLevel</strong><strong class="bold"> </strong>categories here, to have a clear distinction between the different states of the soil:<p class="source-code">type MoistureLevel uint8</p><p class="source-code">const (</p><p class="source-code">    CompletelyDry MoistureLevel = iota</p><p class="source-code">    VeryDry</p><p class="source-code">    Dry</p><p class="source-code">    Wet</p><p class="source-code">    VeryWet</p><p class="source-code">    Water</p><p class="source-code">)</p></li>
				<li>Define a<a id="_idIndexMarker206"/> constructor function that takes <strong class="source-inline">waterThreshold</strong>, <strong class="source-inline">dryThreshold</strong>, <strong class="source-inline">dataPin</strong>, and <strong class="source-inline">voltagePin</strong> and returns <strong class="source-inline">SoilSensor</strong>:<p class="source-code">func NewSoilSensor(waterThreshold, dryThreshold, dataPin, voltagePin machine.Pin) SoilSensor {</p></li>
				<li>Use the thresholds and create <strong class="source-inline">category</strong>, which will later be used to calculate the <strong class="source-inline">category</strong> value. As we want to have six categories, we divide the values by six, which have been read from where the sensor lies:<p class="source-code">category := (dryThreshold - waterThreshold) <strong class="bold">/ 6</strong></p></li>
				<li>Set all values and return a pointer to a new instance of <strong class="source-inline">soilSensor</strong>:<p class="source-code">return &amp;soilSensor{</p><p class="source-code">    waterThreshold: waterThreshold,</p><p class="source-code">    completelyDryThreshold: dryThreshold,</p><p class="source-code">    category: category,</p><p class="source-code">    pin: dataPin,</p><p class="source-code">    voltage: voltagePin,</p><p class="source-code">}</p><p class="source-code">}</p></li>
				<li>Define a <a id="_idIndexMarker207"/>new <strong class="source-inline">func</strong> named <strong class="source-inline">Get</strong>, which is in a function receiver to a pointer to <strong class="source-inline">soilSensor</strong> and returns <strong class="source-inline">MoistureLevel</strong>:<p class="source-code">func (sensor *soilSensor) Get() MoistureLevel {</p></li>
				<li>Read the value from <strong class="source-inline">sensor</strong> and save it the new variable value of type <strong class="source-inline">float32</strong>:<p class="source-code">value := sensor.adc.Get()</p></li>
				<li>Check whether the value is greater than or equal to <strong class="source-inline">completelyDryThreshold</strong>:<p class="source-code">switch {</p><p class="source-code">case value &gt;= sensor.completelyDryThreshold:</p><p class="source-code">    return CompletelyDry</p></li>
				<li>Check whether <strong class="source-inline">value</strong> falls into the second category:<p class="source-code">case value &gt;= sensor.completelyDryThreshold-sensor.category:</p><p class="source-code">   return VeryDry</p></li>
				<li>Check whether <strong class="source-inline">value</strong> falls into the third category:<p class="source-code">case value &gt;= sensor.completelyDryThreshold-sensor.category*2:</p><p class="source-code">   return Dry</p></li>
				<li>Check whether <strong class="source-inline">value</strong> falls into the fourth category:<p class="source-code">case value &lt;= sensor.completelyDryThreshold-sensor.category*3:</p><p class="source-code">  return Wet</p></li>
				<li>Check <a id="_idIndexMarker208"/>whether <strong class="source-inline">value</strong> falls into the fifth category:<p class="source-code">case value &gt;= sensor.completelyDryThreshold-sensor.category*Ł4:</p><p class="source-code">  return VeryWet</p></li>
				<li>The only remaining possible state is <strong class="source-inline">Water</strong>, so we use the default case here:<p class="source-code">default:</p><p class="source-code">    return Water</p><p class="source-code">  }</p><p class="source-code">}</p></li>
				<li>Define a function named <strong class="source-inline">Configure</strong> that has a function receiver for a pointer of <strong class="source-inline">soilSensor</strong>. We use a pointer receiver as we set values on the <strong class="source-inline">soilSensor</strong> instance, which we would otherwise lose outside of this function scope:<p class="source-code">func (sensor *soilSensor) Configure() {</p></li>
				<li>Configure <strong class="source-inline">dataPin</strong> for ADC usage:<p class="source-code">    sensor.adc = machine.ADC{Pin: sensor.pin}</p><p class="source-code">    sensor.adc.Configure(machine.ADCConfig{}</p></li>
				<li>Configure<a id="_idIndexMarker209"/> the <strong class="source-inline">voltage</strong> pin as output and set it to <strong class="source-inline">Low</strong>:<p class="source-code">    sensor.voltage.Configure(machine.PinConfig{Mode: </p><p class="source-code">    machine.PinOutput})</p><p class="source-code">    sensor.voltage.Low()</p><p class="source-code">}</p></li>
				<li>Add a function to turn on the voltage:<p class="source-code">func (sensor *soilSensor) On() {</p><p class="source-code">    sensor.voltage.High()</p><p class="source-code">}</p></li>
				<li>Add a function to turn off the voltage:<p class="source-code">func (sensor *soilSensor) Off() {</p><p class="source-code">    sensor.voltage.Low()</p><p class="source-code">}</p></li>
			</ol>
			<p>This is the complete logic we need for our library. Let's test our code in the next section.</p>
			<h2 id="_idParaDest-89"><a id="_idTextAnchor089"/>Testing the library</h2>
			<p>Next, we will <a id="_idIndexMarker210"/>write an example to test the new library. To do so, we need to create a new folder named <strong class="source-inline">soil-moisture-sensor-example</strong> inside the <strong class="source-inline">Chapter04</strong> folder and create a <strong class="source-inline">main.go</strong> file with an empty <strong class="source-inline">main()</strong> function inside. Your project structure should now look like the following:</p>
			<div>
				<div id="_idContainer052" class="IMG---Figure">
					<img src="Images/Figure_4.7_B16555.jpg" alt="Figure 4.7 – Testing the soil moisture sensor library&#13;&#10;" width="267" height="106"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.7 – Testing the soil moisture sensor library</p>
			<p>To test our new library, follow these steps:</p>
			<ol>
				<li value="1">Import the <strong class="source-inline">machine</strong>, <strong class="source-inline">time</strong>, and <strong class="source-inline">soil-moisture-sensor</strong> packages as shown in the following code. Note that the path to your library will be a bit different, depending on where it lies on your filesystem:<p class="source-code">import (</p><p class="source-code">    "machine"</p><p class="source-code">    "time"</p><p class="source-code">    "github.com/PacktPublishing/Creative-DIY-Microcontroller-Projects-with-TinyGo-and-WebAssembly/</p><p class="source-code">    Chapter04/soil-moisture-sensor"</p><p class="source-code">)</p></li>
				<li>Inside the <strong class="source-inline">main</strong> function, initialize the ADC interface:<p class="source-code">machine.InitADC()</p></li>
				<li>Create a new instance of <strong class="source-inline">SoilSensor</strong>. The values in this example differ slightly from the ones measured in the last example. These values tend to trigger the <strong class="source-inline">Water</strong> and <strong class="source-inline">CompletelyDry</strong> states earlier:<p class="source-code">soilSensor := soil.NewSoilSensor(18000, 34800, machine.</p><p class="source-code">              ADC5, machine.D2)</p></li>
				<li>Now we call the <strong class="source-inline">Configure</strong> function, which initializes our pins:<p class="source-code">soilSensor.Configure()</p></li>
				<li>Start an<a id="_idIndexMarker211"/> endless loop and turn on the sensor, and wait a brief moment to let the readings stabilize a bit:<p class="source-code">for {</p><p class="source-code">    soilSensor.On()</p><p class="source-code">    time.Sleep(75 * time.Millisecond)</p></li>
				<li>Then switch over the result from the <strong class="source-inline">Get()</strong> function and print a string depending on the case:<p class="source-code">    switch soilSensor.Get() {</p><p class="source-code">    case soil.CompletelyDry:</p><p class="source-code">        println("completely dry")</p><p class="source-code">    case soil.VeryDry:</p><p class="source-code">        println("very dry")</p><p class="source-code">    case soil.Dry:</p><p class="source-code">        println("dry")</p><p class="source-code">    case soil.Wet:</p><p class="source-code">        println("wet")</p><p class="source-code">    case soil.VeryWet:</p><p class="source-code">        println("very wet")</p><p class="source-code">    case soil.Water:</p><p class="source-code">        println("pure water")</p><p class="source-code">}</p></li>
				<li>Turn the sensor off again and wait a second until the next reading starts:<p class="source-code">    soilSensor.Off()</p><p class="source-code">    time.Sleep(time.Second)</p><p class="source-code">  }</p><p class="source-code">}</p></li>
			</ol>
			<p>As we now<a id="_idIndexMarker212"/> have the complete code to test our library, let's flash it onto our Arduino and let's check the output in PuTTY. Use the following command to flash it: </p>
			<p class="source-code">tinygo flash –target=arduino Chapter04/soil-moisture-sensor-example/main.go</p>
			<p>The best thing to do now is to actually put the sensor in very dry soil while having an eye on the readings. Then add some water, to check whether you will see the <strong class="source-inline">Wet</strong>, <strong class="source-inline">Very Wet</strong>, and maybe the <strong class="source-inline">Water</strong> states. Before we continue with the next section, we should definitely check it. If the readings seem odd, try to adjust the thresholds, which are handled in the library in the <strong class="source-inline">NewSoilSensor</strong> function.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Keep in mind that you could harm plants by pouring too much water into the soil. Also, it is not necessary to stick the sensor all the way down into the soil until it reaches the white line. I suggest leaving some air between the white line and the soil so you have some buffer between the electronics and the soil. When I did my testing, I achieved good results when having about 1 cm of air as a buffer.</p>
			<p>We have now learned how to calibrate the Capacitive Soil Moisture sensor, used the ADC interface for the first time, and written a new library. Using this library, we are able to tell the humidity state of the soil. In the next section, we are going to learn how to use a water level sensor.</p>
			<h1 id="_idParaDest-90"><a id="_idTextAnchor090"/>Reading water level sensor data</h1>
			<p>As we plan to have a <a id="_idIndexMarker213"/>water tank later in the chapter, it will be beneficial to have a water level sensor, so we can tell when the tank is empty. We'll start off by adding the sensor to our existing circuit. Follow these steps to do so:</p>
			<ol>
				<li value="1">Connect pin <em class="italic">A4</em> from the Arduino with <em class="italic">F22</em> on the breadboard using a jumper cable.</li>
				<li>Connect pin <em class="italic">D3</em> from the Arduino with <em class="italic">F21</em> on the breadboard using a jumper cable.</li>
				<li>Connect <em class="italic">J22</em> on the breadboard with the <em class="italic">S</em> (Signal) port on the sensor using a jumper cable.</li>
				<li>Connect <em class="italic">J21</em> on the breadboard with the <em class="italic">+</em> (<em class="italic">VCC</em>) port on the sensor using a jumper cable.</li>
				<li>Connect <em class="italic">- GND</em> from the sensor with <em class="italic">GND</em> on the power bus.</li>
			</ol>
			<p>The result should now look like the following figure:</p>
			<div>
				<div id="_idContainer053" class="IMG---Figure">
					<img src="Images/Figure_4.8_B16555.jpg" alt="Figure 4.8 – Water level sensor – image is taken from Fritzing&#13;&#10;" width="1554" height="1103"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.8 – Water level sensor – image is taken from Fritzing</p>
			<p>After assembling this, we can continue to also create a small library for this sensor.</p>
			<h2 id="_idParaDest-91"><a id="_idTextAnchor091"/>Writing a water level sensor library </h2>
			<p>There are many <a id="_idIndexMarker214"/>different types of water level sensors. The cheap ones that are often part of Arduino Starter Kits often suffer from corrosion. To prevent that, we are going to also add the possibility to turn it on and off. But first, we are going to have a look at the technical data:</p>
			<ul>
				<li><strong class="bold">Operating voltage</strong>: 5 V</li>
				<li><strong class="bold">Operating current</strong>: Less than 20 mA</li>
				<li><strong class="bold">Working temperature</strong>: 10° to 30°</li>
			</ul>
			<p>So, having this sensor draws less than 20 mA current. We can again use a <em class="italic">GPIO</em> pin to power it.</p>
			<p>We start by creating a new folder named <strong class="source-inline">water-level-sensor</strong> inside the <strong class="source-inline">Chapter04</strong> folder. Inside the new folder, create a new file named <strong class="source-inline">driver.go</strong> and name the package <strong class="source-inline">waterlevel</strong>. The folder structure should now look like the following:</p>
			<div>
				<div id="_idContainer054" class="IMG---Figure">
					<img src="Images/Figure_4.9_B16555.jpg" alt="Figure 4.9 – Folder structure for water level sensor library&#13;&#10;" width="243" height="132"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.9 – Folder structure for water level sensor library</p>
			<p>As the project <a id="_idIndexMarker215"/>structure is now set up, we can go on to implement the actual library. Just follow these steps:</p>
			<ol>
				<li value="1">Import the <strong class="source-inline">machine</strong> package:<p class="source-code">import "machine"</p></li>
				<li>Define a new interface named <strong class="source-inline">WaterLevel</strong> with the following functions. The functions are going to be explained when we implement them:<p class="source-code">type WaterLevel interface {</p><p class="source-code">    IsEmpty() bool</p><p class="source-code">    Configure()</p><p class="source-code">    On()</p><p class="source-code">    Off()</p><p class="source-code">}</p></li>
				<li>Define a struct named <strong class="source-inline">waterLevel</strong> with the following members:<p class="source-code">type waterLevel struct {</p><p class="source-code">    dryThreshold uint16</p><p class="source-code">    pin machine.Pin</p><p class="source-code">    adc machine.ADC</p><p class="source-code">    voltage machine.Pin</p><p class="source-code">}</p></li>
				<li>Define a new constructor-like function that takes <strong class="source-inline">dryThreshold</strong>, <strong class="source-inline">dataPin</strong>, and <strong class="source-inline">voltagePin</strong>:<p class="source-code">func NewWaterLevel(dryThreshold uint16, dataPin, voltagePin machine.Pin) WaterLevel {</p><p class="source-code">    return &amp;waterLevel{</p><p class="source-code">        dryThreshold: dryThreshold,</p><p class="source-code">        pin: dataPin,</p><p class="source-code">        voltage: voltagePin,</p><p class="source-code">}</p><p class="source-code">}</p></li>
				<li>Add the <strong class="source-inline">IsEmpty</strong> check. We'll <a id="_idIndexMarker216"/>just check whether the sensor reading is lower than our threshold:<p class="source-code">func (sensor *waterLevel) IsEmpty() bool {</p><p class="source-code">    return sensor.adc.Get() &lt;= sensor.dryThreshold</p><p class="source-code">}</p></li>
				<li>Configure the sensor pin for ADC usage and configure the voltage pin as output:<p class="source-code">func (sensor *waterLevel) Configure() {</p><p class="source-code">    sensor.adc = machine.ADC{Pin: sensor.pin}</p><p class="source-code">    sensor.adc.Configure(machine.ADCConfig{})</p><p class="source-code">    sensor.voltage.Configure(machine.PinConfig{</p><p class="source-code">        Mode: machine.PinOutput,</p><p class="source-code">})</p><p class="source-code">    sensor.voltage.Low()</p><p class="source-code">}</p></li>
				<li>Turn the power on:<p class="source-code">func (sensor *waterLevel) On() {</p><p class="source-code">    sensor.voltage.High()</p><p class="source-code">}</p></li>
				<li>Turn the power off:<p class="source-code">func (sensor *waterLevel) Off() {</p><p class="source-code">    sensor.voltage.Low()</p><p class="source-code">}</p></li>
			</ol>
			<p>We have now <a id="_idIndexMarker217"/>written the library for the water level sensor.</p>
			<h3>Testing the library</h3>
			<p>Now let's write a<a id="_idIndexMarker218"/> small example program to test our library. To do so, we start by creating a new folder named <strong class="source-inline">water-level-sensor-example</strong> inside the <strong class="source-inline">Chapter04</strong> folder. Inside the new folder, create a new <strong class="source-inline">main.go</strong> file with an empty <strong class="source-inline">main</strong> function inside. The folder structure should now look like the following:</p>
			<div>
				<div id="_idContainer055" class="IMG---Figure">
					<img src="Images/Figure_4.10_B16555.jpg" alt="Figure 4.10 – Folder structure for testing the library&#13;&#10;" width="304" height="152"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.10 – Folder structure for testing the library</p>
			<p>As the project<a id="_idIndexMarker219"/> structure is now set up, we can go on to write the test code. To do so, follow these steps:</p>
			<ol>
				<li value="1">Initialize the ADC interface:<p class="source-code">machine.InitADC()</p></li>
				<li>Create a new instance of <strong class="source-inline">WaterLevelSensor</strong>:<p class="source-code">waterLevelSensor := waterlevel.NewWaterLevel(7000, </p><p class="source-code">                    machine.ADC4, machine.D3)</p></li>
				<li>Configure the pins:<p class="source-code">waterLevelSensor.Configure()</p></li>
				<li>We turn the sensor on and then wait a brief moment to let the readings of the sensor stabilize before we access it. Then, print the result of <strong class="source-inline">IsEmpty()</strong> every second:<p class="source-code">for {</p><p class="source-code">    waterLevelSensor.On()</p><p class="source-code">    time.Sleep(100 * time.Millisecond)</p><p class="source-code">    println("tank is empty", waterLevelSensor.IsEmpty())</p><p class="source-code">    waterLevelSensor.Off()</p><p class="source-code">    time.Sleep(time.Second)</p><p class="source-code">}</p></li>
			</ol>
			<p>When the water level sensor does not touch any water, the returned value should be <strong class="source-inline">0</strong>. We chose <strong class="source-inline">7000</strong> as <strong class="source-inline">dryThreshold</strong> in this case, so the tip of the sensor can be inside the water and still be able to tell us it's empty. That will be useful later on, in the case when we also need to pump water. This is for when the pump should not run when there is not enough water to pump. We should play around with this threshold value a bit. Do so by flashing the program to your Arduino, check the water presence with the sensor, and when it realizes that there is water, change the threshold value and flash again.</p>
			<p>Flash the program by using the following command:</p>
			<p class="source-code">tinygo flash –target=arduino Chapter04/water-level-sensor-example/main.go </p>
			<p>So we now have <a id="_idIndexMarker220"/>written a library that checks whether any kind of water tank is empty. In the next section, we are going to use a buzzer to have an audio signal when the water tank is empty.</p>
			<h1 id="_idParaDest-92"><a id="_idTextAnchor092"/>Controlling a buzzer</h1>
			<p>We are going to<a id="_idIndexMarker221"/> write a very simple buzzer library. We only want the buzzer to make any sound, regardless of the pitch. We start off by adding the buzzer to the circuit. To do so, follow these steps:</p>
			<ol>
				<li value="1">Connect <em class="italic">D4</em> from the Arduino to <em class="italic">A31</em> on the breadboard using a jumper wire.</li>
				<li>Use a <em class="italic">100</em> Ohm resistor to connect <em class="italic">E31</em> with <em class="italic">G31</em> on the breadboard.</li>
				<li>Connect the <em class="italic">VCC</em> pin from the buzzer with <em class="italic">J31</em>.</li>
				<li>Connect the <em class="italic">GND</em> pin to <em class="italic">GND</em> on the power bus.</li>
			</ol>
			<p>The circuit should now look like the following figure:</p>
			<div>
				<div id="_idContainer056" class="IMG---Figure">
					<img src="Images/Figure_4.11_B16555.jpg" alt="Figure 4.11 – Buzzer – image taken from Fritzing&#13;&#10;" width="1461" height="1201"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.11 – Buzzer – image taken from Fritzing</p>
			<p>As we have now<a id="_idIndexMarker222"/> added the buzzer to the circuit, we can now start to write our library.</p>
			<h2 id="_idParaDest-93"><a id="_idTextAnchor093"/>Writing a buzzer library</h2>
			<p>The <a id="_idIndexMarker223"/>buzzer library will have two functions: <strong class="source-inline">Configure()</strong>, which sets up the pin, and the <strong class="source-inline">Beep()</strong> function, which will make the sound.</p>
			<p>We start off by creating a new folder named <strong class="source-inline">buzzer</strong> inside the <strong class="source-inline">Chapter04</strong> folder. Inside the new folder, create a file named <strong class="source-inline">driver.go</strong> and name the package <strong class="source-inline">buzzer</strong>. The project structure should now look like the following:</p>
			<div>
				<div id="_idContainer057" class="IMG---Figure">
					<img src="Images/Figure_4.12_B16555.jpg" alt="FIgure 4.12 – Project structure for buzzer library&#13;&#10;" width="256" height="173"/>
				</div>
			</div>
			<p class="figure-caption">FIgure 4.12 – Project structure for buzzer library</p>
			<p>Now follow these<a id="_idIndexMarker224"/> steps to implement the driver:</p>
			<ol>
				<li value="1">Define an interface named <strong class="source-inline">Buzzer</strong> that has a <strong class="source-inline">Configure</strong> function and a <strong class="source-inline">Beep</strong> function:<p class="source-code">type Buzzer interface {</p><p class="source-code">    Configure()</p><p class="source-code">    Beep(highDuration time.Duration, amount uint8)</p><p class="source-code">}</p></li>
				<li>Create a <strong class="source-inline">struct</strong> named <strong class="source-inline">buzzer</strong> that holds <strong class="source-inline">machine.Pin</strong>:<p class="source-code">type buzzer struct {</p><p class="source-code">    pin machine.Pin</p><p class="source-code">}</p></li>
				<li>Add a function named <strong class="source-inline">NewBuzzer</strong> that returns <strong class="source-inline">Buzzer</strong>:<p class="source-code">func NewBuzzer(pin machine.Pin) Buzzer {</p><p class="source-code">    return buzzer{pin: pin}</p><p class="source-code">}</p></li>
				<li>Add a function named <strong class="source-inline">Configure</strong> that configures <strong class="source-inline">pin</strong> as output:<p class="source-code">func (buzzer buzzer) Configure() {</p><p class="source-code">    buzzer.pin.Configure(machine.PinConfig{</p><p class="source-code">        Mode: machine.PinOutput,</p><p class="source-code">    })</p><p class="source-code">}</p></li>
				<li>Define a function named <strong class="source-inline">Beep</strong>, which takes <strong class="source-inline">time.Duration</strong> and <strong class="source-inline">amount</strong> of the <strong class="source-inline">uint8</strong> type as parameters:<p class="source-code">func (buzzer buzzer) Beep(highDuration time.Duration, amount uint8) {</p></li>
				<li>Loop<a id="_idIndexMarker225"/> the amount of times and let the buzzer beep and sleep in between:<p class="source-code">for i := amount; i &gt; 0; i-- {</p><p class="source-code">    buzzer.pin.High()</p><p class="source-code">    time.Sleep(highDuration)</p><p class="source-code">    buzzer.pin.Low()</p><p class="source-code">    time.Sleep(highDuration)</p><p class="source-code">  }</p><p class="source-code">}</p></li>
			</ol>
			<p>That is all for the buzzer library. </p>
			<p>Now we are going to test the library with a small example project. </p>
			<p>To do so, we first create a new folder named <strong class="source-inline">buzzer-example</strong> inside the <strong class="source-inline">Chapter04</strong> folder. Inside the new folder, create a new <strong class="source-inline">main.go</strong> file with an empty <strong class="source-inline">main()</strong> function in it. The project structure should now look like the following:</p>
			<div>
				<div id="_idContainer058" class="IMG---Figure">
					<img src="Images/Figure_4.13_B16555.jpg" alt="Figure 4.13 – Testing the buzzer&#13;&#10;" width="286" height="201"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.13 – Testing the buzzer</p>
			<p>Now put the<a id="_idIndexMarker226"/> following inside the <strong class="source-inline">main</strong> function:</p>
			<ol>
				<li value="1">Get a new instance of <strong class="source-inline">buzzer</strong> and configure it:<p class="source-code">buzzer := buzzer.NewBuzzer(machine.D4)</p><p class="source-code">buzzer.Configure()</p></li>
				<li>Loop forever, beep three times for <strong class="source-inline">100</strong> milliseconds, and then sleep for <strong class="source-inline">3</strong> seconds:<p class="source-code">for {</p><p class="source-code">    buzzer.Beep(time.Millisecond*100, 3)</p><p class="source-code">    time.Sleep(3 * time.Second)</p><p class="source-code">}</p></li>
			</ol>
			<p>That's all the code we need to test the buzzer. To try this example, flash it by using the following command:</p>
			<p class="source-code">tinygo flash –target=arduino Chapter4/buzzer-example/main.go</p>
			<p>When the program runs, you should be able to hear the buzzer. If it does not start to make a sound after a brief amount of time, check all the cables and pins again. </p>
			<p>We have now successfully written a very simple buzzer library and tested it using an example project. In the next section, we are going to control a pump.</p>
			<h1 id="_idParaDest-94"><a id="_idTextAnchor094"/>Controlling a pump</h1>
			<p>As pumps tend <a id="_idIndexMarker227"/>to draw more current than simple sensors, we are not going to power the pump directly through a <em class="italic">GPIO</em> port. Drawing too much current could permanently damage the Arduino. So, we will use an external power supply and a relay to power the pump. Before we start assembling the circuit, let's have a brief look at how relays work.</p>
			<h2 id="_idParaDest-95"><a id="_idTextAnchor095"/>Working with relays</h2>
			<p>A relay that is <a id="_idIndexMarker228"/>used for microcontroller projects typically comes mounted on a board, which typically has six ports. It has three input ports: <em class="italic">VCC</em>, <em class="italic">GND</em>, and <em class="italic">Signal</em>. It also has three output ports: <em class="italic">normally open</em>, <em class="italic">common</em>, and <em class="italic">normally closed</em>.</p>
			<p>When a <em class="italic">high signal</em> is given, the current flows between <em class="italic">normally open</em> and <em class="italic">common</em>.</p>
			<p>When a <em class="italic">low signal</em> is given, the current flows between <em class="italic">normally closed</em> and <em class="italic">common</em>.</p>
			<p>As we now know how to use a relay, we can continue to add the new components to our circuit. To do so, follow these steps:</p>
			<ol>
				<li value="1">Connect the <em class="italic">GND</em> pin from the relay to <em class="italic">GND</em> on the power bus using a jumper wire.</li>
				<li>Connect the <em class="italic">VCC</em> pin from the relay to <em class="italic">VCC</em> on the power bus using a jumper wire. </li>
				<li>Connect the <em class="italic">Signal</em> (in) pin from the relay to <em class="italic">D5</em> on the Arduino using a jumper wire.</li>
				<li>Connect the <em class="italic">VCC</em> pin of the pump to the <em class="italic">normally open</em> port on the relay.</li>
				<li>Connect the <em class="italic">GND</em> pin of the pump to <em class="italic">GND</em> on the power bus.</li>
				<li>Connect the <em class="italic">common</em> pin of the relay with the <em class="italic">VCC</em> lane on the power bus.</li>
				<li>Connect <em class="italic">VIN</em> from the Arduino to <em class="italic">VCC</em> on the power bus using a jumper wire.</li>
			</ol>
			<p>Your circuit should now look similar to the one in the following figure:</p>
			<div>
				<div id="_idContainer059" class="IMG---Figure">
					<img src="Images/Figure_4.14_B16555.jpg" alt="Figure 4.14 – Full circuit including a pump – image taken from Fritzing&#13;&#10;" width="1650" height="1083"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.14 – Full circuit including a pump – image taken from Fritzing</p>
			<p>With this circuit, we <a id="_idIndexMarker229"/>will be able to power the Arduino using an external power supply. As we might want to water plants that are not anywhere near a USB port, we have connected the <em class="italic">VIN</em> pin on the Arduino with the <em class="italic">VCC</em> lane on the power bus, which is powered by our external power supply. We will now go on and write a library that is able to control the pump.</p>
			<h2 id="_idParaDest-96"><a id="_idTextAnchor096"/>Writing a pump library</h2>
			<p>The <a id="_idIndexMarker230"/>pump library is basically going to have two functions: <strong class="source-inline">Configure</strong>, which sets up the pin, and the <strong class="source-inline">Pump</strong> function, which pumps for a given duration and a given number of iterations.</p>
			<p>We start by creating a new folder named <strong class="source-inline">pump</strong> inside the <strong class="source-inline">Chapter04</strong> folder. Inside the new folder, create a <strong class="source-inline">driver.go</strong> file and name the package <strong class="source-inline">pump</strong>. The project structure should now look like the following:</p>
			<div>
				<div id="_idContainer060" class="IMG---Figure">
					<img src="Images/Figure_4.15_B16555.jpg" alt="FIgure 4.15 – Project structure for pump library&#13;&#10;" width="286" height="223"/>
				</div>
			</div>
			<p class="figure-caption">FIgure 4.15 – Project structure for pump library</p>
			<p>Now, as we<a id="_idIndexMarker231"/> have set up the project structure, we can go on to write the code to control the pump. To do so, follow these steps:</p>
			<ol>
				<li value="1">Define the interface named <strong class="source-inline">Pump</strong>, which has the <strong class="source-inline">Configure</strong> or <strong class="source-inline">Pump</strong> functions:<p class="source-code">type Pump interface {</p><p class="source-code">    Configure()</p><p class="source-code">    Pump(duration time.Duration, iterations uint8)</p><p class="source-code">}</p></li>
				<li>Define a new <strong class="source-inline">struct</strong> named <strong class="source-inline">pump</strong> that holds <strong class="source-inline">machine.Pin</strong>:<p class="source-code">type pump struct {</p><p class="source-code">    pin machine.Pin</p><p class="source-code">}</p></li>
				<li>Define a function named <strong class="source-inline">NewPump</strong> that takes <strong class="source-inline">machine.Pin</strong> and returns a new pointer to <strong class="source-inline">pump</strong>:<p class="source-code">func NewPump(pin machine.Pin) Pump {</p><p class="source-code">    return &amp;pump{</p><p class="source-code">        pin: pin,</p><p class="source-code">    }</p><p class="source-code">}</p></li>
				<li>Then <a id="_idIndexMarker232"/>define a function named <strong class="source-inline">Configure</strong> and set <strong class="source-inline">pin</strong> as the output pin:<p class="source-code">func (pump *pump) Configure() {</p><p class="source-code">    pump.pin.Configure(machine.PinConfig{</p><p class="source-code">    Mode: machine.PinOutput,</p><p class="source-code">    })</p><p class="source-code">}</p></li>
				<li>Next, define a function named <strong class="source-inline">Pump</strong> and loop it <strong class="source-inline">iterations</strong> times, to set <strong class="source-inline">pin</strong> to <strong class="source-inline">high</strong>, sleep for <strong class="source-inline">duration</strong>, and set it back to <strong class="source-inline">low</strong> again:<p class="source-code">func (pump *pump) Pump(duration time.Duration, iterations uint8) {</p><p class="source-code">    for i := iterations; i &gt; 0; i-- {</p><p class="source-code">        pump.pin.High()</p><p class="source-code">        time.Sleep(duration)</p><p class="source-code">        pump.pin.Low()</p><p class="source-code">        time.Sleep(duration)</p><p class="source-code">    }</p><p class="source-code">}</p></li>
			</ol>
			<p>This was everything we need for our <strong class="source-inline">pump</strong> library. We could now go on and create a small example project to test the library. To do so, we'll create a new folder named <strong class="source-inline">pump-example</strong> inside<a id="_idIndexMarker233"/> the <strong class="source-inline">Chapter04</strong> folder and create a <strong class="source-inline">main.go</strong> file with an empty <strong class="source-inline">main </strong>function inside. The project structure should now look like the following:</p>
			<div>
				<div id="_idContainer061" class="IMG---Figure">
					<img src="Images/Figure_4.16_B16555.jpg" alt="Figure 4.16 – Testing the pump&#13;&#10;" width="258" height="243"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.16 – Testing the pump</p>
			<p>Inside the <strong class="source-inline">main</strong> function, we add the following:</p>
			<ol>
				<li value="1">Create a new instance of <strong class="source-inline">pump</strong> by calling the <strong class="source-inline">NewPump</strong> function and hand in <strong class="source-inline">machine.D5</strong> as <strong class="source-inline">pin</strong>:<p class="source-code">pump := pump.NewPump(machine.D5)</p><p class="source-code">pump.Configure()</p></li>
				<li>Loop forever and <strong class="source-inline">pump 3</strong> times for <strong class="source-inline">350</strong> milliseconds and <strong class="source-inline">sleep</strong> for <strong class="source-inline">30</strong> seconds afterward, as follows:<p class="source-code">for {</p><p class="source-code">    pump.Pump(350*time.Millisecond, 3)</p><p class="source-code">    time.Sleep(30 * time.Second)</p><p class="source-code">}</p></li>
			</ol>
			<p>This is the <a id="_idIndexMarker234"/>complete example code to try out our pump.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Due to the laws of physics being the way they are, I would recommend that a possible receiving container should always be placed above the upper water level of the source container since the water will continue to flow even though the pump stopped pumping.</p>
			<p>Now put your pump in a glass of water or some other water tank and try it out by flashing the program using the following command:</p>
			<p class="source-code">tinygo flash –target=arduino Chapter04/pump-example/main.go</p>
			<p>Use this example to find out good pump duration and iteration times that don't pump too much water. Keep in mind that we want to water plants, so this is going to help us find good values.</p>
			<p>This was the last component we needed. We have learned how to use a relay to power and control a pump and we wrote a new library. We are now going to put everything together in the next section.</p>
			<h1 id="_idParaDest-97"><a id="_idTextAnchor097"/>Watering your plants</h1>
			<p>We are now going to <a id="_idIndexMarker235"/>utilize every component we created in the past sections. Putting everything together, we will be building a completely automated plant watering system.</p>
			<p>To start off, we need to create a new folder named <strong class="source-inline">plant-watering-system</strong> inside the <strong class="source-inline">Chapter04</strong> folder. Inside the new folder, create a new <strong class="source-inline">main.go</strong> file with an empty <strong class="source-inline">main()</strong> function inside. The final project structure should now look like the following:</p>
			<div>
				<div id="_idContainer062" class="IMG---Figure">
					<img src="Images/Figure_4.17_B16555.jpg" alt="Figure 4.17 – Project structure for plant watering system&#13;&#10;" width="272" height="110"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.17 – Project structure for plant watering system</p>
			<p>Now, <a id="_idIndexMarker236"/>inside the <strong class="source-inline">main</strong> function, follow these steps:</p>
			<ol>
				<li value="1">Initialize the <strong class="source-inline">ADC</strong> interface:<p class="source-code">machine.InitADC()</p></li>
				<li>Initialize a new <strong class="source-inline">soilSensor</strong>:<p class="source-code">soilSensor := soil.NewSoilSensor(18000, 34800, machine.</p><p class="source-code">              ADC5, machine.D2)</p><p class="source-code">soilSensor.Configure()</p></li>
				<li>Initialize a new <strong class="source-inline">waterLevelSensor</strong>:<p class="source-code">waterLevelSensor := waterlevel.NewWaterLevel(7000,</p><p class="source-code">                    machine.ADC4, machine.D3)</p><p class="source-code">waterLevelSensor.Configure()</p></li>
				<li>Initialize a new <strong class="source-inline">pump</strong>:<p class="source-code">pump := pump.NewPump(machine.D5)</p><p class="source-code">pump.Configure()</p></li>
				<li>Initialize a new <strong class="source-inline">buzzer</strong>:<p class="source-code">buzzer := buzzer.NewBuzzer(machine.D4)</p><p class="source-code">buzzer.Configure()</p></li>
				<li>Turn <strong class="source-inline">waterLevelSensor</strong> on and sleep for a brief amount so the readings can stabilize:<p class="source-code">for {</p><p class="source-code">    waterLevelSensor.On()</p><p class="source-code">    time.Sleep(100 * time.Millisecond)</p></li>
				<li>Check<a id="_idIndexMarker237"/> whether the water container is empty, turn the sensor off, beep 3 times, and then sleep for an hour, before continuing the <strong class="source-inline">for</strong> loop:<p class="source-code">    if waterLevelSensor.IsEmpty() {</p><p class="source-code">        waterLevelSensor.Off()</p><p class="source-code">        buzzer.Beep(150*time.Millisecond, 3)</p><p class="source-code">        time.Sleep(time.Hour)</p><p class="source-code">        continue</p><p class="source-code">}</p></li>
				<li>If the water container is not empty, turn off <strong class="source-inline">waterLevelSensor</strong>:<p class="source-code">waterLevelSensor.Off()</p></li>
				<li>Turn on <strong class="source-inline">soilSensor</strong> and sleep for a brief amount of time to let the readings stabilize:<p class="source-code">soilSensor.On()</p><p class="source-code">time.Sleep(100 * time.Millisecond)</p></li>
				<li>Then switch over the result of <strong class="source-inline">soilSensor.Get()</strong>:<p class="source-code">switch soilSensor.Get() {</p></li>
				<li>If the<a id="_idIndexMarker238"/> soil is <strong class="source-inline">VeryDry</strong> or  <strong class="source-inline">CompletelyDry</strong>, turn off the soil sensor and pump water:<p class="source-code">case soil.VeryDry, soil.CompletelyDry:</p><p class="source-code">    pump.Pump(350*time.Millisecond, 3)</p></li>
				<li>In all other cases, turn off <strong class="source-inline">soilSensor</strong> and sleep for an hour:<p class="source-code">default:</p><p class="source-code">    soilSensor.Off()</p><p class="source-code">    time.Sleep(time.Hour)</p><p class="source-code">}</p><p class="source-code">}</p></li>
			</ol>
			<p>This is everything we need for this final project. You can try out the program by flashing it onto your Arduino using the following command:</p>
			<p class="source-code">tinygo flash –target=arduino Chapter04/plant-watering-system/main.go</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">Keep in mind that every plant has other needs in terms of water. So, we will need to tweak the values for the amount of water pumped to fit the needs of the plant being watered.</p>
			<p>We have now successfully built a complete automated plant watering system and flashed it onto the Arduino. </p>
			<h1 id="_idParaDest-98"><a id="_idTextAnchor098"/>Summary</h1>
			<p>In this chapter, we learned how to read sensor values using the ADC interface. We also learned how the ADC interface translates voltage to digital values, and then we utilized this knowledge to write the <strong class="source-inline">soil moisture sensor</strong> library. </p>
			<p>We then wrote the <strong class="source-inline">water level sensor</strong> library by utilizing the knowledge we gathered in the first project of this chapter. Then we learned how to use a <strong class="bold">buzzer</strong> and wrote a very simple library that enables us to let a buzzer create warning sounds. After that, we learned how relays work and utilized this knowledge to control a <strong class="bold">pump</strong> using a library we wrote. At the end of this chapter, we put all the libraries in a single project and only had to add a small amount of control logic to build the automatic plant watering system.</p>
			<p>In the next chapter, we are going to learn how to use supersonic sensors and how to control seven-segment displays.</p>
			<h1 id="_idParaDest-99"><a id="_idTextAnchor099"/>Questions</h1>
			<ol>
				<li value="1">Why are the water level sensor and soil moisture sensor not permanently powered?</li>
				<li>When is the circuit between <em class="italic">normally open</em> and <em class="italic">GND</em> closed in a relay?</li>
			</ol>
			<h1 id="_idParaDest-100"><a id="_idTextAnchor100"/>References</h1>
			<p>The Capacitive Soil Moisture Sensor fritzing part was part of a collection from the following repository: <a href="https://github.com/OgreTransporter/fritzing-parts-extra">https://github.com/OgreTransporter/fritzing-parts-extra</a></p>
		</div>
	</div></body></html>