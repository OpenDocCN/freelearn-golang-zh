- en: Distributed Systems
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Using service discovery with Consul
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Implementing basic consensus using Raft
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using containerization with Docker
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Orchestration and deployment strategies
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Monitoring applications
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Collecting metrics
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduction
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Sometimes, application-level parallelism is not enough, and things that seem
    simple in development can become complex during deployment. Distributed systems
    provide a number of challenges not found when developing on a single machine.
    These applications have added complexity for things such as monitoring, writing
    applications that require strong consistency guarantees, and service discovery.
    In addition, you must always be mindful of single points of failure, such as a
    database. Otherwise your distributed applications can fail when this single component
    fails.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: This chapter will explore methods of managing distributed data, orchestration,
    containerization, metrics, and monitoring. These will become part of your toolbox
    for writing and maintaining microservices and large distributed applications.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: Using service discovery with Consul
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: When using the microservice approach to applications, you end up with a lot
    of servers listening on a variety of IPs, domains, and ports. These IP addresses
    will vary by environment (staging versus production), and it can be tricky to
    keep them static for configuration between services. You also want to know when
    a machine or service is down or unreachable due to a network partition. Consul
    is a tool that provides a lot of functionality, but we'll explore registering
    services with Consul and querying them from our other services.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Configure your environment according to these steps:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: "Download and install Go on your operating system from [https://golang.org/doc/install](https://golang.org/doc/install)\
    \ and [\uFEFF](https://golang.org/doc/install)configure your `GOPATH` environment\
    \ variable."
  id: totrans-15
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Open a terminal/console application.
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Navigate to `GOPATH/src` and create a project directory, for example, `$GOPATH/src/github.com/yourusername/customrepo`.
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: All code will be run and modified from this directory.
  id: totrans-18
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Optionally, install the latest tested version of the code by running the `go
    get github.com/agtorre/go-cookbook/` command.
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Install Consul from [https://www.consul.io/intro/getting-started/install.html](https://www.consul.io/intro/getting-started/install.html).
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `go get github.com/hashicorp/consul/api` command.
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-22
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: From your terminal/console application, create the `chapter10/discovery` directory
    and navigate to it.
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy tests from [https://github.com/agtorre/go-cookbook/tree/master/chapter10/discovery](https://github.com/agtorre/go-cookbook/tree/master/chapter10/discovery),
    or use this as an exercise to write some of your own code.
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file called `client.go` with the following content:'
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Create a file called `operations.go` with the following content:'
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-29
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Create a file called `exec.go` with the following content:'
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Create a new directory named `example` and navigate to it.
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file named `main.go` with the following content. Ensure that you modify
    the `channels` import to use the path you set up in step 2:'
  id: totrans-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Start Consul in a separate terminal using the `consul agent -dev -node=localhost`
    command.
  id: totrans-35
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `go run main.go` command.
  id: totrans-36
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'You may also run:'
  id: totrans-37
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'You should see the following output:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: If you copied or wrote your own tests, go up one directory and run `go test`.
    Ensure that all the tests pass.
  id: totrans-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-42
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Consul provides a robust Go API library. It can feel daunting when first starting,
    but this recipe shows how you might approach wrapping it. Configuring Consul further
    is beyond the scope of this recipe, but this shows the basic for registering a
    service and querying for other services given a key and tag.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: It would be possible using this to register new microservices at startup time,
    query for all dependent services, and deregister at shutdown. You might also want
    to cache this information so that you're not hitting Consul for every request,
    but this recipe provides the basic tools that you can expand upon. The Consul
    agent also makes these repeated requests fast and efficient ([https://www.consul.io/intro/getting-started/agent.html](https://www.consul.io/intro/getting-started/agent.html)).
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
- en: Implementing basic consensus using Raft
  id: totrans-45
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Raft is a consensus algorithm that allows distributed systems to keep a shared
    and managed state ([https://raft.github.io/](https://raft.github.io/)). Setting
    up a Raft system is complex in many ways, for one you need consensus for an election
    to occur and succeed. This can be difficult to bootstrap when working with multiple
    nodes and it can be difficult to get started. A basic cluster can be run on a
    single node/leader, but if you want redundancy, at least three nodes allows for
    a single node failure.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: This recipe implements a basic in-memory Raft cluster, constructs a state machine
    that can transition between certain allowed states, and connects the distributed
    state machine to a web handler that can trigger the transition. This can be useful
    when you're implementing the base finite state machine interface that Raft requires
    or when testing. This recipe uses [https://github.com/hashicorp/raft](https://github.com/hashicorp/raft)
    for the base Raft implementation.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-48
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Configure your environment according to these steps:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: Refer to the *Getting ready* section of the *Using service discovery with Consul*
    recipe in this chapter.
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `go get github.com/hashicorp/raft` command.
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-52
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: From your terminal/console application, create the `chapter10/consensus` directory
    and navigate to it.
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy tests from [https://github.com/agtorre/go-cookbook/tree/master/chapter10/consensus](https://github.com/agtorre/go-cookbook/tree/master/chapter10/consensus),
    or use this as an exercise to write some of your own code.
  id: totrans-55
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file called `state.go` with the following content:'
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Create a file called `config.go` with the following content:'
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Create a file called `fsm.go` with the following content:'
  id: totrans-60
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Create a file called `handler.go` with the following content:'
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Create a new directory named `example` and navigate to it.
  id: totrans-64
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file named `main.go` with the following content. Ensure that you modify
    the `channels` import to use the path you set up in step 2:'
  id: totrans-65
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Run the `go run main.go` command. Alternatively, you may also run the following
    commands:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'You should now see the following output by running the preceding command:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-70
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'In a separate terminal, run the following command:'
  id: totrans-71
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: If you copied or wrote your own tests, go up one directory and run `go test`.
    Ensure that all tests pass.
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-74
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: When the application starts, we initialize multiple Raft objects. These each
    have their own address and transport. The `InmemTransport{}` function also provides
    a method to connect the other transports called `Connect()`. Once these connections
    are established, the Raft cluster holds an election. When communicating to a Raft
    cluster, clients must communicate with the leader. In our case, one handler can
    talk to all of the nodes, so the handler is responsible for having the leader
    `Raft` object `call Apply()`. This in turn runs `apply()` on all of the other
    nodes.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: This recipe does not deal with snapshots and is only concerned with FSM state
    changes.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: The `InmemTransport{}` function simplifies the election and bootstrapping process
    by allowing everything to reside in memory. In practice, this isn't very helpful
    besides testing and proof of concepts since go routines can freely access shared
    memory.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: Using containerization with Docker
  id: totrans-78
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Docker is a container technology for packaging and shipping applications. Other
    advantages include portability, a container will run the same way regardless of
    the host OS. It provides a lot of the advantages of a virtual machine, in a more
    light-weight container. It's possible to limit resources consumption of individual
    containers and sandbox your environment. It can be extremely useful for having
    a common environment for your applications locally and when you ship your code
    to production. Docker is written in Go and is open source, so it's simple to take
    advantage of the client and libraries. This recipe will set up a Docker container
    for a basic Go application, store some version information about the container,
    and demonstrate hitting a handler from a Docker endpoint.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-80
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Configure your environment according to these steps:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: Refer to the *Getting ready* section of the *Using service discovery for Consul*
    recipe of this chapter.
  id: totrans-82
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Install Docker from [https://store.docker.com/search?type=edition&offering=community](https://store.docker.com/search?type=edition&offering=community).
    This will also include Docker compose.
  id: totrans-83
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-84
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
- en: From your terminal/console application, create the `chapter10/docker` directory
    and navigate to it.
  id: totrans-86
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy tests from [https://github.com/agtorre/go-cookbook/tree/master/chapter10/docker](https://github.com/agtorre/go-cookbook/tree/master/chapter10/docker)
    or use this as an exercise to write some of your own code.
  id: totrans-87
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file called `dockerfile` with the following content:'
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Create a file called `setup.sh` with the following content:'
  id: totrans-90
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Create a file called `version.go` with the following content:'
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Create a new directory named `example` and navigate to it.
  id: totrans-94
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file `main.go` with the following content. Ensure that you modify
    the `channels` import to use the path you set up in step 2:'
  id: totrans-95
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Navigate back to the starting directory.
  id: totrans-97
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run the following command:'
  id: totrans-98
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'You should now see the following output:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Run the following commands:'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: If you copied or wrote your own tests, go up one directory and run `go test`.
    Ensure that all the tests pass.
  id: totrans-104
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-105
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This recipe created a script that compiles the Go binary for the Linux architecture
    and sets a variety of private variables in `main.go`. These variables are used
    to return version information on a version endpoint. Once the binary is compiled,
    a Docker container is created that contains the binary. This allows us to use
    very small container images as the Go runtime is self contained in the binary.
    We then run the container while exposing the port on which the container is listening
    for HTTP traffic. Lastly, we curl the port on localhost and see our version information
    returned.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: Orchestration and deployment strategies
  id: totrans-107
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Docker makes orchestration and deployment much more simple. In this recipe,
    we'll set up a connection to MongoDB, inserting a document and querying it all
    from Docker containers. This recipe will set up the same environment as the *Using
    NoSQL with MongoDB and mgo* recipe, in [Chapter 5](e4c2a55e-c570-4490-b981-2685a89be7d2.xhtml),
    *All about Databases and Storage*, but will run the application and environment
    inside of containers and will use Docker compose to orchestrate and connect them.
    This can later be used in conjunction with Docker Swarm, an integrated Docker
    tool that allows you to manage a cluster, to create and deploy nodes that can
    be scaled up or down easily, and to manage load balancing ([https://docs.docker.com/engine/swarm/](https://docs.docker.com/engine/swarm/)).
    Another good example of container orchestration is Kubernetes ([https://kubernetes.io/](https://kubernetes.io/)),
    a container orchestration framework written by Google using the Go programming
    language.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-109
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Configure your environment according to these steps:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: Refer to the *Getting ready* section of the *Using containerization with Docker*
    recipe.
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `go get gopkg.in/mgo.v2` command.
  id: totrans-112
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `go get github.com/tools/godep` command.
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-114
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: From your terminal/console application, create the `chapter10/orchestrate` directory
    and navigate to it.
  id: totrans-116
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy tests from [https://github.com/agtorre/go-cookbook/tree/master/chapter10/orchestrate](https://github.com/agtorre/go-cookbook/tree/master/chapter10/orchestrate)
    or use this as an exercise to write some of your own code.
  id: totrans-117
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file called `dockerfile` with the following content:'
  id: totrans-118
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Create a file called `docker-compose.yml` with the following content:'
  id: totrans-120
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Create a file called `mongo.go` with the following content:'
  id: totrans-122
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Create a new directory named `example` and navigate to it.
  id: totrans-124
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a `main.go` file with the following content. Ensure that you modify
    the `orchestrate` import to use the path you set up in step 2:'
  id: totrans-125
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Navigate back to the starting directory.
  id: totrans-127
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `godep save ./...` command.
  id: totrans-128
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `docker-compose up -d` command.
  id: totrans-129
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `docker logs docker_app_1` command.
  id: totrans-130
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'You should now see the following output:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: If you copied or wrote your own tests, go up one directory and run `go test`.
    Ensure that all the tests pass.
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-134
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This configuration is good for local development. Once the `docker-compose up`
    command is run, the local directory is rebuilt, it establishes a connection to
    a MongoDB instance using the latest version and begins operating against it. This
    recipe uses godeps for dependency management so that the entire `GOPATH` environment
    variable doesn't need to be mounted by the `Dockerfile` file.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: This can provide a good baseline when starting on apps that require connections
    to external services, all of the [Chapter 5](e4c2a55e-c570-4490-b981-2685a89be7d2.xhtml),
    *All about Databases and Storage*, can make use of this approach rather than creating
    a local instance of the database. For production, you likely won't want to run
    your datastorage behind a Docker container, but you'll also generally have static
    host names for configuration.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: Monitoring applications
  id: totrans-137
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: There are a variety of ways to monitor Go applications. One of the easiest ways
    is to set up Prometheus, a monitoring application written in Go ([https://prometheus.io](https://prometheus.io)).
    This is an application that polls an endpoint based on your configuration file
    and collects a lot of information about your app, including the number of goroutines,
    memory usage, and much more. This app will use the techniques from the previous
    recipe to set up a Docker environment to host Prometheus and connect to it.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-139
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Configure your environment according to these steps:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: Refer to the *Getting ready* section of the *Using containerization with Docker*
    recipe.
  id: totrans-141
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `go get github.com/prometheus/client_golang/prometheus/promhttp` command.
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-143
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
- en: From your terminal/console application, create the `chapter10/monitoring` directory
    and navigate to it.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy tests from [https://github.com/agtorre/go-cookbook/tree/master/chapter10/monitoring](https://github.com/agtorre/go-cookbook/tree/master/chapter10/monitoring)
    or use this as an exercise to write some of your own code.
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file called `Dockerfile` with the following content:'
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Create a file called `docker-compose.yml` with the following content:'
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Create a file called `main.go` with the following content:'
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'Create a file called `prometheus.yml` with the following content:'
  id: totrans-153
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Run the `godep save ./...` command.
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `docker-compose up -d` command.
  id: totrans-156
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'You should now see the following:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-158
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: Navigate your browser to `http://localhost:9090/`. You should see a variety
    of metrics related to your app!
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-160
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The Prometheus client handler will return a variety of stats about your application
    to a Prometheus server. This allows you to point multiple Prometheus servers at
    an app without the need to reconfigure or deploy the app. Most of these stats
    are generic and beneficial for things such as detecting memory leaks. A lot of
    other solutions require you to periodically send information to a server instead.
    The next recipe, *Collecting metrics*, will demonstrate how to ship custom metrics
    to the Prometheus server.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
- en: Collecting metrics
  id: totrans-162
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In addition to general information about your app, it can be helpful to emit
    metrics that are app specific. For example, we might want to collect timing data
    or keep track of the number of times an event occurs.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
- en: This recipe will use the `github.com/rcrowley/go-metrics` package to collect
    metrics and expose them via an endpoint. There are various exporter tools to export
    metrics to places such as Prometheus and InfluxDB, also written in Go.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-165
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Configure your environment according to these steps:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
- en: Refer to the *Getting ready* section of the *Using service discovery with Consul*
    recipe in this chapter.
  id: totrans-167
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run the `go get github.com/rcrowley/go-metrics` command.
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-169
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
- en: From your terminal/console application, create the `chapter10/metrics` directory
    and navigate to it.
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy tests from [https://github.com/agtorre/go-cookbook/tree/master/chapter10/metrics](https://github.com/agtorre/go-cookbook/tree/master/chapter10/metrics),
    or use this as an exercise to write some of your own code.
  id: totrans-172
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file called `handler.go` with the following content:'
  id: totrans-173
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Create a file called `report.go` with the following content:'
  id: totrans-175
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE32]'
  id: totrans-176
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Create a new directory named `example` and navigate to it.
  id: totrans-177
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file named `main.go` with the following content. Ensure that you modify
    the `channels` import to use the path you set up in step 2:'
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE33]'
  id: totrans-179
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'Run `go run main.go`. Alternatively, you may also run the following:'
  id: totrans-180
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE34]'
  id: totrans-181
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'You should now see the following:'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  id: totrans-183
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'Run the following commands from a separate shell:'
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE36]'
  id: totrans-185
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: Try hitting all the endpoints a few more times to see how they change.
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If you copied or wrote your own tests, go up one directory and run `go test`.
    Ensure that all the tests pass.
  id: totrans-187
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-188
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The gometrics keeps all of your metrics in a registry. Once it's set up, you
    can use any of the metric omit options, such as counter or timer, and it will
    store this update in the registry. There are multiple exporters that will export
    metrics to third-party tools. In our case, we set up a handler that omits all
    the metrics in the JSON format.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: Gometrics 将所有度量存储在一个注册表中。一旦设置好，你可以使用任何度量选项，例如计数器或计时器，它将这个更新存储在注册表中。有多个导出器可以将度量导出到第三方工具。在我们的案例中，我们设置了一个处理器，将所有度量以
    JSON 格式导出。
- en: We set up three handlers--one that increments a counter, one that records the
    time to exit the handler, and one that prints a report (while also incrementing
    an additional counter). The `GetOrRegister` functions are useful for atomically
    getting or creating a metric emitter if it doesn't currently exist in a thread-safe
    way. Alternatively, you can register everything once in advance.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 我们设置了三个处理器——一个用于增加计数器，一个用于记录退出处理器的时间，还有一个用于打印报告（同时也会增加一个额外的计数器）。`GetOrRegister`
    函数在原子操作中获取或创建一个度量发射器非常有用，如果它当前不存在于线程安全的方式中。或者，你也可以预先一次性注册所有内容。
