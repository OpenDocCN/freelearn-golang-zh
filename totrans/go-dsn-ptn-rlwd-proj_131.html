<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Deferring function calls" id="1565U1-9c484ed022e64a0fb0e1aebf8e05d4fd"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec35" class="calibre1"/>Deferring function calls</h1></div></div></div><p class="calibre10">Go supports the notion of deferring a function call. Placing the keyword <code class="email">defer</code> before a function call has the interesting effect of pushing the function unto an internal stack, delaying its execution right before the enclosing function returns. To better explain this, let us start with the following simple program that illustrates the use of <code class="email">defer</code>:</p><pre class="programlisting">package main 
import "fmt" 
 
func do(steps ...string) { 
   defer fmt.Println("All done!") 
   for _, s := range steps { 
         defer fmt.Println(s) 
   } 
 
   fmt.Println("Starting") 
} 
 
func main() { 
   do( 
         "Find key", 
         "Aplly break", 
         "Put key in ignition", 
         "Start car", 
   ) 
} 
</pre><p class="calibre10">golang.fyi/ch05/defer1.go</p><p class="calibre10">The previous example defines the <code class="email">do</code> function that takes variadic parameter <code class="email">steps</code>. The function defers the statement with <code class="email">defer fmt.Println("All done!")</code>. Next, the function loops through slice <code class="email">steps</code> and defers the output of each element with <code class="email">defer fmt.Println(s).</code> The last statement in the function <code class="email">do</code> is a non-deferred call to <code class="email">fmt.Println("Starting").</code> Notice the order of the printed string values when the program is executed, as shown in the following output:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">$&gt; go run defer1.go</strong></span>
<span class="strong"><strong class="calibre2">Starting</strong></span>
<span class="strong"><strong class="calibre2">Start car</strong></span>
<span class="strong"><strong class="calibre2">Put key in ignition</strong></span>
<span class="strong"><strong class="calibre2">Aplly break</strong></span>
<span class="strong"><strong class="calibre2">Find key</strong></span>
<span class="strong"><strong class="calibre2">All done!</strong></span>
</pre><p class="calibre10">There are a couple facts that explain the reverse order of the printout. First, recall that deferred functions are executed right before their enclosing function returns. Therefore, the first value printed is generated by the last non-deferred method call. Next, as stated earlier, deferred statements are pushed into a stack. Therefore, deferred calls are executed using a last-in-first-out order. That is why <code class="email">"All done!"</code> is the last string value printed in the output.</p></div></body></html>