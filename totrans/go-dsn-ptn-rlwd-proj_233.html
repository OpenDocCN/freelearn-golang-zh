<html><head></head><body>
<div class="book" title="The sync package" id="1T1401-9c484ed022e64a0fb0e1aebf8e05d4fd">
<div class="book" title="Synchronizing access to composite values"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec163" class="calibre1"/>Synchronizing access to composite values</h2></div></div></div><p class="calibre10">The previous section discussed concurrency safety when sharing access to simple values. The same level of care must be applied when sharing access to composite type values such as maps and slices, since Go does not offer concurrency-safe version of these types, as illustrated in the following example:</p><pre class="programlisting">type Service struct { 
   started bool 
   stpCh   chan struct{} 
   mutex   sync.RWMutex 
   cache   map[int]string 
} 
 
func (s *Service) Start() { 
   ... 
   go func() { 
         s.mutex.Lock() 
         s.started = true 
         s.cache[1] = "Hello World" 
         ... 
         s.mutex.Unlock() 
         &lt;-s.stpCh // wait to be closed. 
   }() 
} 
... 
func (s *Service) Serve(id int) { 
   s.mutex.RLock() 
   msg := s.cache[id] 
   s.mutex.RUnlock() 
   if msg != "" { 
         fmt.Println(msg) 
   } else { 
         fmt.Println("Hello, goodbye!") 
   } 
} 
</pre><p class="calibre10">golang.fyi/ch09/sync4.go</p><p class="calibre10">The preceding code uses a <code class="email">sync.RWMutex</code> variable (see preceding section, <span class="strong"><em class="calibre11">Synchronizing with Mutex Locks</em></span>) to manage the locks when accessing the map variable <code class="email">cache</code>. The code wraps the update operation to the <code class="email">cache</code> variable within a pair of method calls, <code class="email">mutex.Lock()</code> and <code class="email">mutex.Unlock()</code>. However, when reading values from the <code class="email">cache</code> variable, the <code class="email">mutex.RLock()</code> and <code class="email">mutex.RUnlock()</code>methods are used to provide concurrency safety.</p></div></div></body></html>