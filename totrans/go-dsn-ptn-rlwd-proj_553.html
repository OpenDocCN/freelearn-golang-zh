<html><head></head><body>
<div class="book" title="Observer design pattern">
<div class="book" title="Implementation"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch07lvl2sec0194" class="calibre1"/>Implementation</h2></div></div></div><p class="calibre10">Our implementation is just to define the <code class="email">AddObserver</code>, the <code class="email">RemoveObserver</code>, and the <code class="email">NotifyObservers</code> methods:</p><pre class="programlisting">func (s *Publisher) AddObserver(o Observer) { 
  s.ObserversList = append(s.ObserversList, o) 
} 
</pre><p class="calibre10">The <code class="email">AddObserver</code> method adds the <code class="email">Observer</code> instance to the <code class="email">ObserversList</code> structure by appending the pointer to the current list of pointers. This one was very easy. The <code class="email">AddObserver</code> test must be passing now (but not the rest or we could have done something wrong):</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">go test -v</strong></span>
<span class="strong"><strong class="calibre2">=== RUN   TestSubject</strong></span>
<span class="strong"><strong class="calibre2">=== RUN   TestSubject/AddObserver</strong></span>
<span class="strong"><strong class="calibre2">=== RUN   TestSubject/RemoveObserver</strong></span>
<span class="strong"><strong class="calibre2">=== RUN   TestSubject/Notify</strong></span>
<span class="strong"><strong class="calibre2">--- FAIL: TestSubject (0.00s)</strong></span>
<span class="strong"><strong class="calibre2">    --- PASS: TestSubject/AddObserver (0.00s)</strong></span>
<span class="strong"><strong class="calibre2">    --- FAIL: TestSubject/RemoveObserver (0.00s)</strong></span>
<span class="strong"><strong class="calibre2">        observer_test.go:40: The size of the observer list is not the expected. 3 != 3</strong></span>
<span class="strong"><strong class="calibre2">    --- FAIL: TestSubject/Notify (0.00s)</strong></span>
<span class="strong"><strong class="calibre2">        observer_test.go:87: Expected message on observer 1 was not expected: 'default' != 'Hello World!'</strong></span>
<span class="strong"><strong class="calibre2">        observer_test.go:87: Expected message on observer 2 was not expected: 'default' != 'Hello World!'</strong></span>
<span class="strong"><strong class="calibre2">        observer_test.go:87: Expected message on observer 3 was not expected: 'default' != 'Hello World!'</strong></span>
<span class="strong"><strong class="calibre2">FAIL</strong></span>
<span class="strong"><strong class="calibre2">exit status 1</strong></span>
<span class="strong"><strong class="calibre2">FAIL</strong></span>
</pre><p class="calibre10">Excellent. Just the <code class="email">AddObserver</code> method has passed the test, so we can now continue to the <code class="email">RemoveObserver</code> method:</p><pre class="programlisting">func (s *Publisher) RemoveObserver(o Observer) { 
  var indexToRemove int 
 
  for i, observer := range s.ObserversList { 
    if observer == o { 
      indexToRemove = i 
      break 
    } 
  } 
 
  s.ObserversList = append(s.ObserversList[:indexToRemove], s.ObserversList[indexToRemove+1:]...) 
} 
</pre><p class="calibre10">The <code class="email">RemoveObserver</code> method will iterate for each element in the <code class="email">ObserversList</code> structure, comparing the <code class="email">Observer</code> object's <code class="email">o</code> variable with the ones stored in the list. If it finds a match, it saves the index  in the local variable, <code class="email">indexToRemove</code>, and stops the iteration. The way to remove indexes on a slice in Go is a bit tricky:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need to use slice indexing to return a new slice containing every object from the beginning of the slice to the index we want to remove (not included).</li><li class="listitem" value="2">Then, we get another slice from the index we want to remove (not included) to the last object in the slice</li><li class="listitem" value="3">Finally, we join the previous two new slices into a new one (the <code class="email">append</code> function)</li></ol><div class="calibre12"/></div><p class="calibre10">For example, in a list from 1 to 10 in which we want to remove the number 5, we have to create a new slice, joining a slice from 1 to 4 and a slice from 6 to 10.</p><p class="calibre10">This index removal is done with the <code class="email">append</code> function again because we are actually appending two lists together. Just take a closer look at the three dots at the end of the second argument of the <code class="email">append</code> function. The <code class="email">append</code> function adds an element (the second argument) to a slice (the first), but we want to append an entire list. This can be achieved using the three dots, which translate to something like <span class="strong"><em class="calibre11">keep adding elements until you finish the second array</em></span>.</p><p class="calibre10">Ok, let's run this test now:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">go test -v           
=== RUN   TestSubject 
=== RUN   TestSubject/AddObserver 
=== RUN   TestSubject/RemoveObserver 
=== RUN   TestSubject/Notify 
--- FAIL: TestSubject (0.00s) 
    --- PASS: TestSubject/AddObserver (0.00s) 
    --- PASS: TestSubject/RemoveObserver (0.00s) 
    --- FAIL: TestSubject/Notify (0.00s) 
        observer_test.go:87: Expected message on observer 1 was not expected: 'default' != 'Hello World!' 
        observer_test.go:87: Expected message on observer 3 was not expected: 'default' != 'Hello World!' 
FAIL 
exit status 1 
FAIL </strong></span>
</pre><p class="calibre10">We continue in the good path. The <code class="email">RemoveObserver</code> test has been fixed without fixing anything else. Now we have to finish our implementation by defining the <code class="email">NotifyObservers</code> method:</p><pre class="programlisting">func (s *Publisher) NotifyObservers(m string) { 
  fmt.Printf("Publisher received message '%s' to notify observers\n", m) 
  for _, observer := range s.ObserversList { 
    observer.Notify(m) 
  } 
} 
</pre><p class="calibre10">The <code class="email">NotifyObservers</code> method is quite simple because it prints a message to the console to announce that a particular message is going to be passed to the <code class="email">Observers</code>. After this, we use a for loop to iterate over <code class="email">ObserversList</code> structure and execute each <code class="email">Notify(string)</code> method by passing the argument <code class="email">m</code>. After executing this, all observers must have the message <code class="email">Hello World!</code> stored in their <code class="email">Message</code> field. Let's see if this is true by running the tests:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">go test -v 
=== RUN   TestSubject 
=== RUN   TestSubject/AddObserver 
=== RUN   TestSubject/RemoveObserver 
=== RUN   TestSubject/Notify 
Publisher received message 'Hello World!' to notify observers 
Observer 1: message 'Hello World!' received  
Observer 3: message 'Hello World!' received  
--- PASS: TestSubject (0.00s) 
    --- PASS: TestSubject/AddObserver (0.00s) 
    --- PASS: TestSubject/RemoveObserver (0.00s) 
    --- PASS: TestSubject/Notify (0.00s) 
PASS 
ok</strong></span>
</pre><p class="calibre10">Excellent! We can also see the outputs of the <code class="email">Publisher</code> and <code class="email">Observer</code> types on the console. The <code class="email">Publisher</code> structure prints the following message:</p><pre class="programlisting">hey! I have received the message  'Hello World!' and I'm going to pass the same message to the observers </pre><p class="calibre10">After this, all observers print their respective messages as follows:</p><pre class="programlisting">hey, I'm observer 1 and I have received the message 'Hello World!'</pre><p class="calibre10">And the same for the third observer.</p></div></div></body></html>