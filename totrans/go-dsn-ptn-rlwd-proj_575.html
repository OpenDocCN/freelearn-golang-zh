<html><head></head><body>
<div class="book" title="Using it all - concurrent singleton">
<div class="book" title="Unit test"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec0209" class="calibre1"/>Unit test</h2></div></div></div><p class="calibre10">To restrict concurrent access to the <code class="email">singleton</code> instance, just one Goroutine will be able to access it. We'll access it using channels--the first one to add one, the second one to get the current count, and the third one to stop the Goroutine.</p><p class="calibre10">We will add one 10,000 times using 10,000 different Goroutines launched from two different <code class="email">singleton</code> instances. Then, we'll introduce a loop to check the count of the <code class="email">singleton</code> until it is 5,000, but we'll write how much the count is before starting the loop.</p><p class="calibre10">Once the count has reached 5,000, the loop will exit and quit the running Goroutine-the test code looks like this:</p><pre class="programlisting">package channel_singleton 
import ( 
  "testing" 
  "time" 
  "fmt" 
) 
 
func TestStartInstance(t *testing.T) { 
  singleton := GetInstance() 
  singleton2 := GetInstance() 
 
  n := 5000 
 
  for i := 0; i &lt; n; i++ { 
    go singleton.AddOne() 
    go singleton2.AddOne() 
  } 
 
  fmt.Printf("Before loop, current count is %d\n", singleton.GetCount()) 
 
  var val int 
  for val != n*2 { 
    val = singleton.GetCount() 
    time.Sleep(10 * time.Millisecond) 
  } 
  singleton.Stop() 
} 
</pre><p class="calibre10">Here, we can see the full test we'll use. After creating two instances of the <code class="email">singleton</code>, we have created a <code class="email">for</code> loop that launches the <code class="email">AddOne</code> method 5,000 times from each instance. This is not happening yet; they are being scheduled and will be executed eventually. We are printing the count of the <code class="email">singleton</code> instance to clearly see this eventuality; depending on the computer, it will print some number greater than 0 and lower than 10,000.</p><p class="calibre10">The last step before stopping the Goroutine that is holding the count is to enter a loop that checks the value of the count and waits 10 milliseconds if the value is not the expected value (10,000). Once it reaches this value, the loop will exit and we can stop the <code class="email">singleton</code> instance.</p><p class="calibre10">We'll jump directly to the implementation as the requirement is quite simple.</p></div></div></body></html>