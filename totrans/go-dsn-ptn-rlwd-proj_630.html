<html><head></head><body>
<div class="book" title="Modeling a chat room and clients on the server">
<div class="book" title="Modeling a room"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec0010" class="calibre1"/>Modeling a room</h2></div></div></div><p class="calibre10">We need a way for clients to join and leave rooms in order to ensure that the <code class="email">c.room.forward &lt;- msg</code> code in the preceding section actually forwards the message to all the clients. To ensure that we are not trying to access the same data at the same time, a sensible approach is to use two channels: one that will add a client to the room and another that will remove it. Let's update our <code class="email">room.go</code> code to look like this:</p><pre class="programlisting">package main 
type room struct { 
  // forward is a channel that holds incoming messages 
  // that should be forwarded to the other clients. 
  forward chan []byte 
  // join is a channel for clients wishing to join the room. 
  join chan *client 
  // leave is a channel for clients wishing to leave the room. 
  leave chan *client 
  // clients holds all current clients in this room. 
  clients map[*client]bool 
} 
</pre><p class="calibre10">We have added three fields: two channels and a map. The <code class="email">join</code> and <code class="email">leave</code> channels exist simply to allow us to safely add and remove clients from the <code class="email">clients</code> map. If we were to access the map directly, it is possible that two goroutines running concurrently might try to modify the map at the same time, resulting in corrupt memory or unpredictable state.</p></div></div></body></html>