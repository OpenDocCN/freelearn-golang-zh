<html><head></head><body>
<div class="book" title="Implementing external logging in">
<div class="book" title="Presenting the user data"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec0026" class="calibre1"/>Presenting the user data</h2></div></div></div><p class="calibre10">Having the user data inside a cookie is a good start, but non-technical people will never even know it's there, so we must bring the data to the fore. We will do this by enhancing <code class="email">templateHandler</code> that first passes the user data to the template's <code class="email">Execute</code> method; this allows us to use template annotations in our HTML to display the user data to the users.</p><p class="calibre10">Update the <code class="email">ServeHTTP</code> method of <code class="email">templateHandler</code> in <code class="email">main.go</code>:</p><pre class="programlisting">func (t *templateHandler) ServeHTTP(w http.ResponseWriter, r  *http.Request) { 
  t.once.Do(func() { 
    t.templ =  template.Must(template.ParseFiles(filepath.Join("templates",  
    t.filename))) 
  }) 
  data := map[string]interface{}{ 
    "Host": r.Host, 
  } 
  if authCookie, err := r.Cookie("auth"); err == nil { 
    data["UserData"] = objx.MustFromBase64(authCookie.Value) 
  } 
  t.templ.Execute(w, data) 
} 
</pre><p class="calibre10">Instead of just passing the entire <code class="email">http.Request</code> object to our template as data, we are creating a new <code class="email">map[string]interface{}</code> definition for a data object that potentially has two fields: <code class="email">Host</code> and <code class="email">UserData</code> (the latter will only appear if an <code class="email">auth</code> cookie is present). By specifying the map type followed by curly braces, we are able to add the <code class="email">Host</code> entry at the same time as making our map while avoiding the <code class="email">make</code> keyword altogether. We then pass this new <code class="email">data</code> object as the second argument to the <code class="email">Execute</code> method on our template.</p><p class="calibre10">Now we add an HTML file to our template source to display the name. Update the <code class="email">chatbox</code> form in <code class="email">chat.html</code>:</p><pre class="programlisting">&lt;form id="chatbox"&gt; 
  {{.UserData.name}}:&lt;br/&gt; 
  &lt;textarea&gt;&lt;/textarea&gt; 
  &lt;input type="submit" value="Send" /&gt; 
&lt;/form&gt; 
</pre><p class="calibre10">The <code class="email">{{.UserData.name}}</code> annotation tells the template engine to insert our user's name before the <code class="email">textarea</code> control.</p><div class="informaltable" title="Tip"><h3 class="title2"><a id="tip36" class="calibre1"/>Tip</h3><p class="calibre10">Since we're using the <code class="email">objx</code> package, don't forget to run <code class="email">go get http://github.com/stretchr/objx</code> and import it. Additional dependencies add complexity to projects, so you may decide to copy and paste the appropriate functions from the package or even write your own code that marshals between Base64-encoded cookies and back.</p><p class="calibre10">Alternatively, you can <span class="strong"><strong class="calibre2">vendor</strong></span> the dependency by copying the whole source code to your project (inside a root-level folder called <code class="email">vendor</code>). Go will, at build time, first check the vendor folder for any imported packages before checking them in <code class="email">$GOPATH</code> (which were put there by <code class="email">go get</code>). This allows you to fix the exact version of a dependency rather than rely on the fact that the source package hasn't changed since you wrote your code.</p><p class="calibre10">For more information about using vendors in Go, check out Daniel Theophanes' post on the subject at <a class="calibre1" href="https://blog.gopheracademy.com/advent-2015/vendor-folder/">https://blog.gopheracademy.com/advent-2015/vendor-folder/</a> or search for <code class="email">vendoring in Go</code>.</p></div><p class="calibre10">Rebuild and run the chat application again and you will notice the addition of your name before the chat box:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">go build -o chat</strong></span>
<span class="strong"><strong class="calibre2">./chat -host=":8080"</strong></span>
</pre></div></div></body></html>