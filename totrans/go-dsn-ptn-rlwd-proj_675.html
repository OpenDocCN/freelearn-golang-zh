<html><head></head><body><div class="book" title="Combining all three implementations" id="506UG1-9c484ed022e64a0fb0e1aebf8e05d4fd"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec0022" class="calibre1"/>Combining all three implementations</h1></div></div></div><p class="calibre10">To close this chapter with a bang, we will implement a mechanism in which each <code class="email">Avatar</code> implementation takes a turn in trying to get a URL for a user. If the first implementation returns the <code class="email">ErrNoAvatarURL</code> error, we will try the next and so on until we find a useable value.</p><p class="calibre10">In <code class="email">avatar.go</code>, underneath the <code class="email">Avatar</code> type, add the following type definition:</p><pre class="programlisting">type TryAvatars []Avatar 
</pre><p class="calibre10">The <code class="email">TryAvatars</code> type is simply a slice of <code class="email">Avatar</code> objects that we are free to add methods to. Let's add the following <code class="email">GetAvatarURL</code> method:</p><pre class="programlisting">func (a TryAvatars) GetAvatarURL(u ChatUser) (string, error) { 
  for _, avatar := range a { 
    if url, err := avatar.GetAvatarURL(u); err == nil { 
      return url, nil 
    } 
  } 
  return "", ErrNoAvatarURL 
} 
</pre><p class="calibre10">This means that <code class="email">TryAvatars</code> is now a valid <code class="email">Avatar</code> implementation and can be used in place of any specific implementation. In the preceding method, we iterated over the slice of <code class="email">Avatar</code> objects in an order, calling <code class="email">GetAvatarURL</code> for each one. If no error is returned, we return the URL; otherwise, we carry on looking. Finally, if we are unable to find a value, we just return <code class="email">ErrNoAvatarURL</code> as per the interface design.</p><p class="calibre10">Update the <code class="email">avatars</code> global variable in <code class="email">main.go</code> to use our new implementation:</p><pre class="programlisting">var avatars Avatar = TryAvatars{ 
  UseFileSystemAvatar, 
  UseAuthAvatar, 
  UseGravatar} 
</pre><p class="calibre10">Here, we created a new instance of our <code class="email">TryAvatars</code> slice type while putting the other <code class="email">Avatar</code> implementations inside it. The order matters since it iterates over the objects in the order in which they appear in the slice. So, first our code will check whether the user has uploaded a picture; if they haven't, the code will check whether the auth service has a picture for us to use. If the approaches fail, a Gravatar URL will be generated, which in the worst case (for example, if the user hasn't added a Gravatar picture) will render a default placeholder image.</p><p class="calibre10">To see our new functionality in action, perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Build and rerun the application:<pre class="programlisting">
<span class="strong"><strong class="calibre2">go build -o chat</strong></span>
<span class="strong"><strong class="calibre2">./chat -host=:8080</strong></span>
</pre></li><li class="listitem" value="2">Log out by visiting <code class="email">http://localhost:8080/logout</code>.</li><li class="listitem" value="3">Delete all the pictures from the <code class="email">avatars</code> folder.</li><li class="listitem" value="4">Log back in by navigating to <code class="email">http://localhost:8080/chat</code>.</li><li class="listitem" value="5">Send some messages and take note of your profile picture.</li><li class="listitem" value="6">Visit <code class="email">http://localhost:8080/upload</code> and upload a new profile picture.</li><li class="listitem" value="7">Log out again and log back in as you did earlier.</li><li class="listitem" value="8">Send some more messages and note that your profile picture has been updated.</li></ol><div class="calibre12"/></div></div></body></html>