<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Counting votes"><div class="book" id="58PJI2-9c484ed022e64a0fb0e1aebf8e05d4fd"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec0031" class="calibre1"/>Counting votes</h1></div></div></div><p class="calibre10">The second program we are going to implement is the <code class="email">counter</code> tool, which will be responsible for watching out for votes in NSQ, counting them, and keeping MongoDB up to date with the latest numbers.</p><p class="calibre10">Create a new folder called <code class="email">counter</code> alongside <code class="email">twittervotes</code>, and add the following code to a new <code class="email">main.go</code> file:</p><pre class="programlisting">package main 
import ( 
  "flag" 
  "fmt" 
  "os" 
) 
var fatalErr error 
func fatal(e error) { 
  fmt.Println(e) 
  flag.PrintDefaults() 
  fatalErr = e 
} 
func main() { 
  defer func() { 
    if fatalErr != nil { 
      os.Exit(1) 
    } 
  }() 
} 
</pre><p class="calibre10">Normally when we encounter an error in our code, we use a call such as <code class="email">log.Fatal</code> or <code class="email">os.Exit</code>, which immediately terminates the program. Exiting the program with a nonzero exit code is important because it is our way of telling the operating system that something went wrong, and we didn't complete our task successfully. The problem with the normal approach is that any deferred functions we have scheduled (and therefore any teardown code we need to run) won't get a chance to execute.</p><p class="calibre10">The pattern employed in the preceding code snippet lets us call the <code class="email">fatal</code> function to record that an error has occurred. Note that only when our main function exits will the deferred function run, which in turn calls <code class="email">os.Exit(1)</code> to exit the program with an exit code of <code class="email">1</code>. Because the deferred statements are run in LIFO (last in, first out) order, the first function we defer will be the last function to be executed, which is why the first thing we do in the <code class="email">main</code> function is defer the exiting code. This allows us to be sure that other functions we defer will be called <span class="strong"><em class="calibre11">before</em></span> the program exits. We'll use this feature to ensure that our database connection gets closed regardless of any errors.</p></div></body></html>