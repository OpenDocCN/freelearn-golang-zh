<html><head></head><body>
<div class="book" title="Counting votes">
<div class="book" title="Connecting to the database"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec0056" class="calibre1"/>Connecting to the database</h2></div></div></div><p class="calibre10">The best time to think about cleaning up resources, such as database connections, is immediately after you have successfully obtained the resource; Go's <code class="email">defer</code> keyword makes this easy. At the bottom of the main function, add the following code:</p><pre class="programlisting">log.Println("Connecting to database...") 
db, err := mgo.Dial("localhost") 
if err != nil { 
  fatal(err) 
  return 
} 
defer func() { 
  log.Println("Closing database connection...") 
  db.Close() 
}() 
pollData := db.DB("ballots").C("polls") 
</pre><p class="calibre10">This code uses the familiar <code class="email">mgo.Dial</code> method to open a session to the locally running MongoDB instance and immediately defers a function that closes the session. We can be sure that this code will run before our previously deferred statement containing the exit code (because deferred functions are run in the reverse order in which they were called). Therefore, whatever happens in our program, we know that the database session will definitely and properly close.</p><div class="informaltable" title="Tip"><h3 class="title2"><a id="tip90" class="calibre1"/>Tip</h3><p class="calibre10">The log statements are optional, but they will help us see what's going on when we run and exit our program.</p></div><p class="calibre10">At the end of the snippet, we use the <code class="email">mgo</code> fluent API to keep a reference of the <code class="email">ballots.polls</code> data collection in the <code class="email">pollData</code> variable, which we will use later to make queries.</p></div></div></body></html>