<html><head></head><body><div class="book" title="Running our solution" id="59O441-9c484ed022e64a0fb0e1aebf8e05d4fd"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec0032" class="calibre1"/>Running our solution</h1></div></div></div><p class="calibre10">It's time to see our code in action. Ensure that you have <code class="email">nsqlookupd</code>, <code class="email">nsqd</code>, and <code class="email">mongod</code> running in separate terminal windows with the following:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">nsqlookupd</strong></span>
<span class="strong"><strong class="calibre2">nsqd --lookupd-tcp-address=127.0.0.1:4160</strong></span>
<span class="strong"><strong class="calibre2">mongod --dbpath ./db</strong></span>
</pre><p class="calibre10">If you haven't already done so, make sure the <code class="email">twittervotes</code> program is running too. Then, in the <code class="email">counter</code> folder, build and run our counting program:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">go build -o counter</strong></span>
<span class="strong"><strong class="calibre2">./counter</strong></span>
</pre><p class="calibre10">You should see a periodic output describing what work <code class="email">counter</code> is doing, such as the following:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">No new votes, skipping database update</strong></span>
<span class="strong"><strong class="calibre2">Updating database...</strong></span>
<span class="strong"><strong class="calibre2">map[win:2 happy:2 fail:1]</strong></span>
<span class="strong"><strong class="calibre2">Finished updating database...</strong></span>
<span class="strong"><strong class="calibre2">No new votes, skipping database update</strong></span>
<span class="strong"><strong class="calibre2">Updating database...</strong></span>
<span class="strong"><strong class="calibre2">map[win:3]</strong></span>
<span class="strong"><strong class="calibre2">Finished updating database...</strong></span>
</pre><div class="informaltable" title="Tip"><h3 class="title2"><a id="tip93" class="calibre1"/>Tip</h3><p class="calibre10">The output will, of course, vary since we are actually responding to real, live activity on Twitter.</p></div><p class="calibre10">We can see that our program is receiving vote data from NSQ and reports to update the database with the results. We can confirm this by opening the MongoDB shell and querying the poll data to see whether the <code class="email">results</code> map is being updated. In another terminal window, open the MongoDB shell:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">mongo</strong></span>
</pre><p class="calibre10">Ask it to use the ballots database:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">&gt; use ballots</strong></span>
<span class="strong"><strong class="calibre2">switched to db ballots</strong></span>
</pre><p class="calibre10">Use the <code class="email">find</code> method with no arguments to get all polls (add the <code class="email">pretty</code> method to the end to get nicely formatted JSON):</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">&gt; db.polls.find().pretty()</strong></span>
<span class="strong"><strong class="calibre2">{</strong></span>
<span class="strong"><strong class="calibre2">  "_id" : ObjectId("53e2a3afffbff195c2e09a02"),</strong></span>
<span class="strong"><strong class="calibre2">  "options" : [</strong></span>
<span class="strong"><strong class="calibre2">  "happy","sad","fail","win"</strong></span>
<span class="strong"><strong class="calibre2">  ],</strong></span>
<span class="strong"><strong class="calibre2">  "results" : {</strong></span>
<span class="strong"><strong class="calibre2">    "fail" : 159, "win" : 711,</strong></span>
<span class="strong"><strong class="calibre2">    "happy" : 233, "sad" : 166,</strong></span>
<span class="strong"><strong class="calibre2">  },</strong></span>
<span class="strong"><strong class="calibre2">  title" : "Test poll"</strong></span>
<span class="strong"><strong class="calibre2">}</strong></span>
</pre><p class="calibre10">The <code class="email">results</code> map is indeed updated, and at any point in time, it contains the total number of votes for each option.</p></div></body></html>