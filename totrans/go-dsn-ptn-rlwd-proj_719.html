<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Serving our API with one function" id="5HC8K1-9c484ed022e64a0fb0e1aebf8e05d4fd"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec0040" class="calibre1"/>Serving our API with one function</h1></div></div></div><p class="calibre10">A web service is nothing more than a simple Go program that binds to a specific HTTP address and port and serves requests, so we get to use all our command-line tool writing knowledge and techniques.</p><div class="informaltable" title="Tip"><h3 class="title2"><a id="tip98" class="calibre1"/>Tip</h3><p class="calibre10">We also want to ensure that our <code class="email">main</code> function is as simple and modest as possible, which is always a goal of coding, especially in Go.</p></div><p class="calibre10">Before writing our <code class="email">main</code> function, let's look at a few design goals of our API program:</p><div class="book"><ul class="itemizedlist"><li class="listitem">We should be able to specify the HTTP address and port to which our API listens and the address of the MongoDB instances without having to recompile the program (through command-line flags)<p class="calibre29">We want the program to gracefully shut down when we terminate it, allowing the in-flight requests (requests that are still being processed when the termination signal is sent to our program) to complete</p></li><li class="listitem">We want the program to log out status updates and report errors properly</li></ul></div><p class="calibre10">Atop the <code class="email">main.go</code> file, replace the <code class="email">main</code> function placeholder with the following code:</p><pre class="programlisting">func main() { 
  var ( 
    addr  = flag.String("addr", ":8080", "endpoint
     address") 
    mongo = flag.String("mongo", "localhost", "mongodb
     address") 
  ) 
  log.Println("Dialing mongo", *mongo) 
  db, err := mgo.Dial(*mongo) 
  if err != nil { 
    log.Fatalln("failed to connect to mongo:", err) 
  } 
  defer db.Close() 
  s := &amp;Server{ 
    db: db, 
  } 
  mux := http.NewServeMux() 
  mux.HandleFunc("/polls/",
   withCORS(withAPIKey(s.handlePolls))) 
  log.Println("Starting web server on", *addr) 
  http.ListenAndServe(":8080", mux) 
  log.Println("Stopping...") 
} 
</pre><p class="calibre10">This function is the entirety of our API <code class="email">main</code> function. The first thing we do is specify two command-line flags, <code class="email">addr</code> and <code class="email">mongo</code>, with some sensible defaults and ask the <code class="email">flag</code> package to parse them. We then attempt to dial the MongoDB database at the specified address. If we are unsuccessful, we abort with a call to <code class="email">log.Fatalln</code>. Assuming the database is running and we are able to connect, we store the reference in the  <code class="email">db</code> variable before deferring the closing of the connection. This ensures that our program properly disconnects and tidies up after itself when it ends.</p><div class="informaltable" title="Tip"><h3 class="title2"><a id="tip99" class="calibre1"/>Tip</h3><p class="calibre10">We create our server and specify the database dependency. We are calling our server <code class="email">s</code>, which some people think is a bad practice because it's difficult to read code referring to a single letter variable and know what it is. However, since the scope of this variable is so small, we can be sure that its use will be very near to its definition, removing the potential for confusion.</p></div><p class="calibre10">We then create a new <code class="email">http.ServeMux</code> object, which is a request multiplexer provided by the Go standard library, and register a single handler for all requests that begin with the <code class="email">/polls/</code> path. Note that the <code class="email">handlePolls</code> handler is a method on our server, and this is how it will be able to access the database.</p></div></body></html>