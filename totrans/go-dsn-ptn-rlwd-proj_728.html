<html><head></head><body>
<div class="book" title="A web client that consumes the API">
<div class="book" title="Showing the details of a poll"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec0069" class="calibre1"/>Showing the details of a poll</h2></div></div></div><p class="calibre10">The final page of our app we need to complete is the <code class="email">view.html</code> page, where users can see the details and live results of the poll. Create a new file called <code class="email">view.html</code> inside the <code class="email">public</code> folder and add the following HTML code to it:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; 
&lt;html&gt; 
&lt;head&gt; 
  &lt;title&gt;View Poll&lt;/title&gt; 
  &lt;link rel="stylesheet" 
   href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"&gt; 
&lt;/head&gt; 
&lt;body&gt; 
  &lt;div class="container"&gt; 
    &lt;div class="col-md-4"&gt;&lt;/div&gt; 
    &lt;div class="col-md-4"&gt; 
      &lt;h1 data-field="title"&gt;...&lt;/h1&gt; 
      &lt;ul id="options"&gt;&lt;/ul&gt; 
      &lt;div id="chart"&gt;&lt;/div&gt; 
      &lt;div&gt; 
        &lt;button class="btn btn-sm" id="delete"&gt;Delete this poll&lt;/button&gt; 
      &lt;/div&gt; 
    &lt;/div&gt; 
    &lt;div class="col-md-4"&gt;&lt;/div&gt; 
  &lt;/div&gt; 
&lt;/body&gt; 
&lt;/html&gt; 
</pre><p class="calibre10">This page is mostly similar to the other pages; it contains elements to present the title of the poll, the options, and a pie chart. We will be mashing up Google's Visualization API with our API to present the results. Underneath the final <code class="email">div</code> tag in <code class="email">view.html</code> (and above the closing <code class="email">body</code> tag), add the following <code class="email">script</code> tags:</p><pre class="programlisting">&lt;script src="//www.google.com/jsapi"&gt;&lt;/script&gt; 
&lt;script  src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"&gt;
&lt;/script&gt; 
&lt;script&gt; 
google.load('visualization', '1.0', {'packages':['corechart']}); 
google.setOnLoadCallback(function(){ 
  $(function(){ 
    var chart; 
    var poll = location.href.split("poll=")[1]; 
    var update = function(){ 
      $.get("http://localhost:8080/"+poll+"?key=abc123", null, null,
        "json") 
        .done(function(polls){ 
          var poll = polls[0]; 
          $('[data-field="title"]').text(poll.title); 
          $("#options").empty(); 
          for (var o in poll.results) { 
            $("#options").append( 
              $("&lt;li&gt;").append( 
                $("&lt;small&gt;").addClass("label label 
                default").text(poll.results[o]), 
                " ", o 
              ) 
            ) 
          } 
          if (poll.results) { 
            var data = new google.visualization.DataTable(); 
            data.addColumn("string","Option"); 
            data.addColumn("number","Votes"); 
            for (var o in poll.results) { 
              data.addRow([o, poll.results[o]]) 
            } 
            if (!chart) { 
              chart = new                 google.visualization.PieChart 
                (document.getElementById('chart')); 
            } 
            chart.draw(data, {is3D: true}); 
          } 
        } 
      ); 
      window.setTimeout(update, 1000); 
    }; 
    update(); 
    $("#delete").click(function(){ 
      if (confirm("Sure?")) { 
        $.ajax({ 
          url:"http://localhost:8080/"+poll+"?key=abc123", 
          type:"DELETE" 
        }) 
        .done(function(){ 
          location.href = "/"; 
        }) 
      } 
    }); 
  }); 
}); 
&lt;/script&gt; 
</pre><p class="calibre10">We include the dependencies we will need in order to power our page, jQuery and Bootstrap, and also the Google JavaScript API. The code loads the appropriate visualization libraries from Google and waits for the DOM elements to load before extracting the poll ID from the URL by splitting it on <code class="email">poll=</code>. We then create a variable called <code class="email">update</code> that represents a function responsible for generating the view of the page. This approach is taken to make it easy for us to use <code class="email">window.setTimeout</code> in order to issue regular calls to update the view. Inside the <code class="email">update</code> function, we use <code class="email">$.get</code> to make a <code class="email">GET</code> request to our <code class="email">/polls/{id}</code> endpoint, replacing <code class="email">{id}</code> with the actual ID we extracted from the URL earlier. Once the poll has loaded, we update the title on the page and iterate over the options to add them to the list. If there are results (remember, in the previous chapter, the <code class="email">results</code> map was only added to the data as votes started being counted), we create a new <code class="email">google.visualization.PieChart</code> object and build a <code class="email">google.visualization.DataTable</code> object containing the results. Calling <code class="email">draw</code> on the chart causes it to render the data and thus update the chart with the latest numbers. We then use <code class="email">setTimeout</code> to tell our code to call <code class="email">update</code> again in another second.</p><p class="calibre10">Finally, we bind to the <code class="email">click</code> event of the <code class="email">delete</code> button we added to our page, and after asking the user whether they are sure, make a <code class="email">DELETE</code> request to the polls URL and then redirect them back to the home page. It is this request that will actually cause the <code class="email">OPTIONS</code> request to be made first, asking for permission, which is why we added explicit support for it in our <code class="email">handlePolls</code> function earlier.</p></div></div></body></html>