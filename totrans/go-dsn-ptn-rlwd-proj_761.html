<html><head></head><body>
<div class="book" title="The daemon backup tool">
<div class="book" title="Updating filedb records"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch08lvl2sec0090" class="calibre1"/>Updating filedb records</h2></div></div></div><p class="calibre10">All that is left is for us is implement the <code class="email">check</code> function that should call the <code class="email">Now</code> method on the <code class="email">Monitor</code> type and update the database with new hashes if there are any.</p><p class="calibre10">Underneath the <code class="email">main</code> function, add the following code:</p><pre class="programlisting">func check(m *backup.Monitor, col *filedb.C) { 
  log.Println("Checking...") 
  counter, err := m.Now() 
  if err != nil { 
    log.Fatalln("failed to backup:", err) 
  } 
  if counter &gt; 0 { 
    log.Printf("  Archived %d directories\n", counter) 
    // update hashes 
    var path path 
    col.SelectEach(func(_ int, data []byte) (bool, []byte, bool) { 
      if err := json.Unmarshal(data, &amp;path); err != nil { 
        log.Println("failed to unmarshal data (skipping):", err) 
        return true, data, false 
      } 
      path.Hash, _ = m.Paths[path.Path] 
      newdata, err := json.Marshal(&amp;path) 
      if err != nil { 
        log.Println("failed to marshal data (skipping):", err) 
        return true, data, false 
      } 
      return true, newdata, false 
    }) 
  } else { 
    log.Println("  No changes") 
  } 
} 
</pre><p class="calibre10">The <code class="email">check</code> function first tells the user that a check is happening before immediately calling <code class="email">Now</code>. If the <code class="email">Monitor</code> type did any work for us, which is to ask whether it archived any files, we output them to the user and go on to update the database with the new values. The <code class="email">SelectEach</code> method allows us to change each record in the collection if we so wish by returning the replacement bytes. So we unmarshal the bytes to get the path structure, update the hash value, and return the marshaled bytes. This ensures that the next time we start a <code class="email">backupd</code> process, it will do so with the correct hash values.</p></div></div></body></html>