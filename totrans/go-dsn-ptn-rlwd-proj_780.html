<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Transactions in Google Cloud Datastore"><div class="book" id="63G3A2-9c484ed022e64a0fb0e1aebf8e05d4fd"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec0059" class="calibre1"/>Transactions in Google Cloud Datastore</h1></div></div></div><p class="calibre10">Transactions allow you to specify a series of changes to the data store and commit them as one. If any of the individual operations fails, the whole transaction will not be applied. This is extremely useful if you want to maintain counters or have multiple entities that depend on each other's state. During a transaction in Google Cloud Datastore, all entities that are read are locked (other code is prevented from making changes) until the transaction is complete, providing an additional sense of security and preventing data races.</p><div class="informaltable" title="Note"><h3 class="title2"><a id="note00143" class="calibre1"/>Note</h3><p class="calibre10">If you were building a bank (it seems crazy, but the guys at Monzo in London are indeed building a bank using Go), you might represent user accounts as an entity called <code class="email">Account</code>. To transfer money from one account to another, you'd need to make sure the money was deducted from account A and deposited into account B as a single transaction. If either fails, people aren't going to be happy (to be fair, if the deduction operation failed, the owner of account A would probably be happy because B would get the money without it costing A anything).</p></div><p class="calibre10">To see where we are going to use transactions, let's first add model answers to the questions.</p><p class="calibre10">Create a new file called <code class="email">answers.go</code> and add the following struct and validation method:</p><pre class="programlisting">type Answer struct { 
  Key    *datastore.Key `json:"id" datastore:"-"` 
  Answer string         `json:"answer"` 
  CTime  time.Time      `json:"created"` 
  User   UserCard       `json:"user"` 
  Score  int            `json:"score"` 
} 
func (a Answer) OK() error { 
  if len(a.Answer) &lt; 10 { 
    return errors.New("answer is too short") 
  } 
  return nil 
} 
</pre><p class="calibre10">
<code class="email">Answer</code> is similar to a question, has <code class="email">datastore.Key</code> (which will not be persisted), has <code class="email">CTime</code> to capture the timestamp, and embeds <code class="email">UserCard</code> (representing the person answering the question). It also has a <code class="email">Score</code> integer field, which will go up and down as users vote on the answers.</p></div></body></html>