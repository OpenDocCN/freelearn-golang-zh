<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Casting a vote" id="66BL01-9c484ed022e64a0fb0e1aebf8e05d4fd"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec0062" class="calibre1"/>Casting a vote</h1></div></div></div><p class="calibre10">Before our API is a complete feature, we need to add the ability for users to cast votes. We'll break this piece into two functions in order to increase the readability of our code.</p><p class="calibre10">Inside <code class="email">votes.go</code>, add the following function:</p><pre class="programlisting">func CastVote(ctx context.Context, answerKey *datastore.Key, score int) (*Vote, error) { 
  question, err := GetQuestion(ctx, answerKey.Parent()) 
  if err != nil { 
    return nil, err 
  } 
  user, err := UserFromAEUser(ctx) 
  if err != nil { 
    return nil, err 
  } 
  var vote Vote 
  err = datastore.RunInTransaction(ctx, func(ctx context.Context) error { 
    var err error 
    vote, err = castVoteInTransaction(ctx, answerKey, question, user, 
     score) 
    if err != nil { 
      return err 
    } 
    return nil 
  }, &amp;datastore.TransactionOptions{XG: true}) 
  if err != nil { 
    return nil, err 
  } 
  return &amp;vote, nil 
} 
</pre><p class="calibre10">The <code class="email">CastVote</code> function takes (along with the obligatory <code class="email">Context</code>) <code class="email">datastore.Key</code> for the answer that is being voted for and a score integer. It loads the question and the current user, starts a data store transaction, and passes execution off to the <code class="email">castVoteInTransaction</code> function.</p></div></body></html>