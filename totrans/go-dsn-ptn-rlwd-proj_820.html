<html><head></head><body>
<div class="book" title="Creating a server command">
<div class="book" title="Running the gRPC server"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch10lvl2sec00126" class="calibre1"/>Running the gRPC server</h2></div></div></div><p class="calibre10">There is a little more work to do in order to run the gRPC server, but it is still pretty simple. We must create a low-level TCP network listener and serve the gRPC server over that. Add the following code to the main function body:</p><pre class="programlisting">  go func() { 
    listener, err := net.Listen("tcp", *gRPCAddr) 
    if err != nil { 
      errChan &lt;- err 
      return 
    } 
    log.Println("grpc:", *gRPCAddr) 
    handler := vault.NewGRPCServer(ctx, endpoints) 
    gRPCServer := grpc.NewServer() 
    pb.RegisterVaultServer(gRPCServer, handler) 
    errChan &lt;- gRPCServer.Serve(listener) 
  }() 
</pre><p class="calibre10">We make the TCP listener on the <code class="email">gRPCAddr</code> endpoint specified, sending any errors down the <code class="email">errChan</code> error channel. We use <code class="email">vault.NewGRPCServer</code> to create the handler, again passing in the background context and the instance of <code class="email">Endpoints</code> we are exposing.</p><div class="informaltable" title="Tip"><h3 class="title2"><a id="tip172" class="calibre1"/>Tip</h3><p class="calibre10">Note how both the JSON/HTTP server and the gRPC server are actually exposing the same serviceâ€“literally the same instance.</p></div><p class="calibre10">We then create a new gRPC server from Google's <code class="email">grpc</code> package and register it using our own generated <code class="email">pb</code> package via the <code class="email">RegisterVaultServer</code> function.</p><div class="informaltable" title="Note"><h3 class="title2"><a id="note00173" class="calibre1"/>Note</h3><p class="calibre10">The <code class="email">RegisterVaultService</code> function just calls <code class="email">RegisterService</code> on our <code class="email">grpcServer</code> but hides the internals of the service description that was automatically generated. If you look in <code class="email">vault.pb.go</code> and search for the <code class="email">RegisterVaultServer</code> function, you will see that it makes a reference to something like <code class="email">&amp;_Vault_serviceDesc</code>, which is the description of the service. Feel free to dig around the generated code; the metadata is especially interesting, but out of scope for this book.</p></div><p class="calibre10">We then ask the server to <code class="email">Serve</code> itself, throwing any errors down the same error channel if they occur.</p><div class="informaltable" title="Tip"><h3 class="title2"><a id="tip174" class="calibre1"/>Tip</h3><p class="calibre10">It's out of scope for this chapter, but it is recommended that every service be delivered with <span class="strong"><strong class="calibre2">Transport Layer Security</strong></span> (<span class="strong"><strong class="calibre2">TLS</strong></span>), especially the ones dealing with passwords.</p></div></div></div></body></html>