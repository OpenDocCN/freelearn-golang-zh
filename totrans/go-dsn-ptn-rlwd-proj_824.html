<html><head></head><body>
<div class="book" title="Building a gRPC client">
<div class="book" title="A command-line tool to consume the service"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch10lvl2sec00129" class="calibre1"/>A command-line tool to consume the service</h2></div></div></div><p class="calibre10">In this section, we are going to write a command-line tool (or CLI-command-line interface), which will allow us to communicate with our service through the gRPC protocol. If we were writing another service in Go, we would use the vault client package in the same way as we will when we write our CLI tool.</p><p class="calibre10">Our tool will let you access the services in a fluent way on the command line by separating commands and arguments with spaces such that we can hash a password like this:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">vaultcli hash MyPassword</strong></span>
</pre><p class="calibre10">We will be able to validate a password with a hash like this:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">vaultcli hash MyPassword HASH_GOES_HERE</strong></span>
</pre><p class="calibre10">In the <code class="email">cmd</code> folder, create a new folder called <code class="email">vaultcli</code>. Add a main.go file and insert the following main function:</p><pre class="programlisting">func main() { 
  var ( 
    grpcAddr = flag.String("addr", ":8081",
     "gRPC address") 
  ) 
  flag.Parse() 
  ctx := context.Background() 
  conn, err := grpc.Dial(*grpcAddr, grpc.WithInsecure(),  
  grpc.WithTimeout(1*time.Second)) 
  if err != nil { 
    log.Fatalln("gRPC dial:", err) 
  } 
  defer conn.Close() 
  vaultService := grpcclient.New(conn) 
  args := flag.Args() 
  var cmd string 
  cmd, args = pop(args) 
  switch cmd { 
  case "hash": 
    var password string 
    password, args = pop(args) 
    hash(ctx, vaultService, password) 
  case "validate": 
    var password, hash string 
    password, args = pop(args) 
    hash, args = pop(args) 
    validate(ctx, vaultService, password, hash) 
  default: 
    log.Fatalln("unknown command", cmd) 
  } 
} 
</pre><p class="calibre10">Ensure that you import the <code class="email">vault/client/grpc</code> package as <code class="email">grpcclient</code> and <code class="email">google.golang.org/grpc</code> as <code class="email">grpc</code>. You'll also need to import the <code class="email">vault</code> package.</p><p class="calibre10">We parse the flags and get a background context as usual before dialing the gRPC endpoint to establish a connection. If all is well, we defer the closing of the connection and create our vault service client using that connection. Remember that this object implements our <code class="email">vault.Service</code> interface, so we can just call the methods as though they were normal Go methods, without worrying about the fact that communication is taking place over a network protocol.</p><p class="calibre10">Then, we start parsing the command-line arguments in order to decide which execution flow to take.</p></div></div></body></html>