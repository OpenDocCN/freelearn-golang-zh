<html><head></head><body>
<div class="book" title="Rate limiting with service middleware">
<div class="book" title="Manually testing the rate limiter"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch10lvl2sec00134" class="calibre1"/>Manually testing the rate limiter</h2></div></div></div><p class="calibre10">To see whether our rate limiter is working, and since we set such low thresholds, we can test it just using our command-line tool.</p><p class="calibre10">First, restart the server (so the new code runs) by hitting <span class="strong"><em class="calibre11">Ctrl + C</em></span> in the terminal window running the server. This signal will be trapped by our code, and an error will be sent down <code class="email">errChan</code>, causing the program to quit. Once it has terminated, restart it:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">go run main.go</strong></span>
</pre><p class="calibre10">Now, in another window, let's hash some passwords:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">vaultcli hash bourgon</strong></span>
</pre><p class="calibre10">Repeat this command a few timesâ€“in most terminals, you can press the up arrow key and return. You'll notice that the first few requests succeed because it's within the limits, but if you get a little more aggressive and issue more than five requests in a second, you'll notice that we get errors:</p><pre class="programlisting">
<span class="strong"><strong class="calibre2">$ vaultcli hash bourgon</strong></span>
<span class="strong"><strong class="calibre2">$2a$10$q3NTkjG0YFZhTG6gBU2WpenFmNzdN74oX0MDSTryiAqRXJ7RVw9sy</strong></span>
<span class="strong"><strong class="calibre2">$ vaultcli hash bourgon</strong></span>
<span class="strong"><strong class="calibre2">$2a$10$CdEEtxSDUyJEIFaykbMMl.EikxvV5921gs/./7If6VOdh2x0Q1oLW</strong></span>
<span class="strong"><strong class="calibre2">$ vaultcli hash bourgon</strong></span>
<span class="strong"><strong class="calibre2">$2a$10$1DSqQJJGCmVOptwIx6rrSOZwLlOhjHNC83OPVE8SdQ9q73Li5x2le</strong></span>
<span class="strong"><strong class="calibre2">$ vaultcli hash bourgon</strong></span>
<span class="strong"><strong class="calibre2">Invoke: rpc error: code = 2 desc = rate limit exceeded</strong></span>
<span class="strong"><strong class="calibre2">$ vaultcli hash bourgon</strong></span>
<span class="strong"><strong class="calibre2">Invoke: rpc error: code = 2 desc = rate limit exceeded</strong></span>
<span class="strong"><strong class="calibre2">$ vaultcli hash bourgon</strong></span>
<span class="strong"><strong class="calibre2">Invoke: rpc error: code = 2 desc = rate limit exceeded</strong></span>
<span class="strong"><strong class="calibre2">$ vaultcli hash bourgon</strong></span>
<span class="strong"><strong class="calibre2">$2a$10$kriTDXdyT6J4IrqZLwgBde663nLhoG3innhCNuf8H2nHf7kxnmSza</strong></span>
</pre><p class="calibre10">This shows that our rate limiter is working. We see errors until the token bucket fills back up, where our requests are fulfilled again.</p></div></div></body></html>