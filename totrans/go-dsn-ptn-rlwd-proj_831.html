<html><head></head><body>
<div class="book" title="Rate limiting with service middleware">
<div class="book" title="Graceful rate limiting"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch10lvl2sec00135" class="calibre1"/>Graceful rate limiting</h2></div></div></div><p class="calibre10">Rather than returning an error (which is a pretty harsh response), perhaps we would prefer the server to just hold onto our request and fulfill it when it can-called throttling. For this case, Go kit provides the <code class="email">NewTokenBucketThrottler</code> middleware.</p><p class="calibre10">Update the middleware code to use this middleware function instead:</p><pre class="programlisting">  hashEndpoint := vault.MakeHashEndpoint(srv) 
  { 
    hashEndpoint = ratelimitkit.NewTokenBucketThrottler(rlbucket,
     time.Sleep)(hashEndpoint) 
  } 
  validateEndpoint := vault.MakeValidateEndpoint(srv) 
  { 
    validateEndpoint = ratelimitkit.NewTokenBucketThrottler(rlbucket,
      time.Sleep)(validateEndpoint) 
  } 
  endpoints := vault.Endpoints{ 
    HashEndpoint:     hashEndpoint, 
    ValidateEndpoint: validateEndpoint, 
  } 
</pre><p class="calibre10">The first argument to <code class="email">NewTokenBucketThrottler</code> is the same endpoint as earlier, but now we have added a second argument of <code class="email">time.Sleep</code>.</p><div class="informaltable" title="Note"><h3 class="title2"><a id="note00177" class="calibre1"/>Note</h3><p class="calibre10">Go kit allows us to customize the behavior by specifying what should happen when the delay needs to take place. In our case, we're passing <code class="email">time.Sleep</code>, which is a function that will ask execution to pause for the specified amount of time. You could write your own function here if you wanted to do something different, but this works for now.</p></div><p class="calibre10">Now repeat the test from earlier, but this time, note that we never get an error-instead, the terminal will hang for a second until the request can be fulfilled.</p></div></div></body></html>