<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div id="_idContainer230">
			<h1 id="_idParaDest-496" class="chapter-number"><a id="_idTextAnchor2072"/>20</h1>
			<h1 id="_idParaDest-497"><a id="_idTextAnchor2073"/><a id="_idTextAnchor2074"/>Using Go Tools</h1>
			<p class="callout-heading"><a id="_idTextAnchor2075"/><a id="_idTextAnchor2076"/>Overview</p>
			<p class="callout">This chapter will teach you how to make use of the Go toolkit so that you can improve and build your code. It will also help you build and improve your code using Go tools and create binaries using <strong class="source-inline">go build</strong>. Furthermore, you’ll learn how to clean up library imports using <strong class="source-inline">goimports</strong>, detect suspicious constructs with <strong class="source-inline">go vet</strong>, and identify race conditions in your code using the Go <span class="No-Break">race detector.</span></p>
			<p class="callout">By the end of this chapter, you will be able to run code with <strong class="source-inline">go run</strong>, format code with <strong class="source-inline">gofmt</strong>, automatically generate documentation using <strong class="source-inline">go doc</strong>, and download third-party packages using <span class="No-Break"><strong class="source-inline">go get</strong></span><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-498"><a id="_idTextAnchor2077"/>Technical requirements</h1>
			<p>For this chapter, you’ll require Go version 1.21 or higher. The code for this chapter can be found <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Go-Programming-From-Beginner-to-Professional-Second-Edition-/tree/main/Chapter20"><span class="No-Break">https://github.com/PacktPublishing/Go-Programming-From-Beginner-to-Professional-Second-Edition-/tree/main/Chapter20</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-499"><a id="_idTextAnchor2078"/><a id="_idTextAnchor2079"/>Introduction</h1>
			<p>In the previous<a id="_idIndexMarker1310"/> chapters, you learned how to produce concurrent and well-tested code. Although Go makes the task of creating concurrent and tested code much easier compared to other languages, these tasks can be intrinsically complex. This is when learning to use tools to write better code that will simplify the complexity comes <span class="No-Break">in handy.</span></p>
			<p>In this chapter, you will learn about Go tools.<a id="_idTextAnchor2080"/> Go comes with several tools to help you write better code. For example, in the previous chapters, you came across <strong class="source-inline">go build</strong>, which you used to build your code into an executable. You also came across <strong class="source-inline">go test</strong>, which you used to test your code. There are also a few more tools that help in different ways. For example, the <strong class="source-inline">goimports</strong> tool will check if you have all the import statements required for your code to work and if not, it will add them. It can also check if any of your import statements are no longer needed and remove them. While this seems like a very simple thing, it means you no longer need to worry about the imports and can instead focus on the code you are writing. Alternatively, you can use the Go race detec<a id="_idTextAnchor2081"/>tor to find race conditions hidden in your code. This is an extremely valuable tool when you start writing <span class="No-Break">concurrent code.</span></p>
			<p>The tools provided with the Go language are one of the reasons for its popularity. They provide a standard way to check code for formatting issues, mistakes, and race conditions, which is very<a id="_idIndexMarker1311"/> useful when you are developing software in a professional setting. The exercises in this chapter provide practical examples of how to use these tools to improve <span class="No-Break">your code<a id="_idTextAnchor2082"/><a id="_idTextAnchor2083"/>.</span></p>
			<h1 id="_idParaDest-500"><a id="_idTextAnchor2084"/>The go build tool</h1>
			<p>The <strong class="source-inline">go build</strong> tool takes<a id="_idIndexMarker1312"/> Go source code and compiles it so that it can be executed. When creating software, you write code in a human-readable programming language. Then, the code needs to be translated into a machine-readable format so that it can be executed. This is done by a compiler that compiles the machine instructions from the source code. To do this with Go code, you can use <span class="No-Break"><strong class="source-inline">go buil<a id="_idTextAnchor2085"/><a id="_idTextAnchor2086"/>d</strong></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-501"><a id="_idTextAnchor2087"/>Exercise 20.01 – using the go build tool</h2>
			<p>In this exercise, you<a id="_idIndexMarker1313"/> will learn about the <strong class="source-inline">go build</strong> tool. This will take your Go source code and compile it into a binary. To use it, run the <strong class="source-inline">go build</strong> tool on the command line while using the <strong class="source-inline">–o</strong> flag to specify the output file or <span class="No-Break">executable name:</span></p>
			<pre class="source-code">
go build <strong class="source-inline">-o</strong> name_of_the_binary_to_create source_file.go</pre>			<p>If the <strong class="source-inline">–o</strong> flag is omitted, the output file will be named by the package or folder that contains the <span class="No-Break">source file.</span></p>
			<p>Let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>Create a new directory called <strong class="source-inline">Exercise20.01</strong>. Within that directory, create a new file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Run the following two commands to create the Go module for <span class="No-Break">the exercise:</span><pre class="source-code">
go mod init
go mod tidy</pre></li>				<li>Add the following code to the file to create a simple <strong class="source-inline">Hello </strong><span class="No-Break"><strong class="source-inline">World</strong></span><span class="No-Break"> progr<a id="_idTextAnchor2088"/><a id="_idTextAnchor2089"/>am:</span><pre class="source-code">
package main
import "fmt"
func main() {
  fmt.Println("Hello World")
}</pre></li>				<li>To run the program, you need to open your Terminal and navigate to the directory that you created the <strong class="source-inline">main.go</strong> file in. Then, run the <strong class="source-inline">go build</strong> tool by writing <span class="No-Break">the followi<a id="_idTextAnchor2090"/>ng:</span><pre class="source-code">
go build -o hello_world main.go</pre></li>				<li>This will create an executable called <strong class="source-inline">hello_world</strong> that you can execute the binary in by running it on the <span class="No-Break">command line:</span><pre class="source-code">
./hello_world</pre></li>			</ol>
			<p>The output will<a id="_idIndexMarker1314"/> look <span class="No-Break">as follows:</span></p>
			<pre class="console">
Hello World</pre>			<p>In this exercise, you used the <strong class="source-inline">go build</strong> tool to compile your code into a binary and <span class="No-Break">execute<a id="_idTextAnchor2091"/><a id="_idTextAnchor2092"/> it.</span></p>
			<h1 id="_idParaDest-502"><a id="_idTextAnchor2093"/>The go run tool</h1>
			<p>The <strong class="source-inline">go run</strong> tool is<a id="_idIndexMarker1315"/> similar to <strong class="source-inline">go build</strong> in that it compiles your Go code. However, the subtle difference is that <strong class="source-inline">go build</strong> will output a binary file that you can execute, whereas the <strong class="source-inline">go run</strong> tool doesn’t create a binary file that you need to execute. It compiles the code and runs it in a single step, with no binary file output in the end. This can be useful if you want to quickly check that your code does what you expect it to do, without the need to create and run a binary file. This would be commonly used when <a id="_idIndexMarker1316"/>you’re testing your code so that you can run it quickly without needing to create a binary <span class="No-Break">to ex<a id="_idTextAnchor2094"/><a id="_idTextAnchor2095"/>ecute.</span></p>
			<h2 id="_idParaDest-503"><a id="_idTextAnchor2096"/>Exercise 20.02 – using the go run tool</h2>
			<p>In this exercise, you<a id="_idIndexMarker1317"/> will learn about the <strong class="source-inline">go run</strong> tool. This is used as a shortcut to compile and run your code in a single step, which is useful if you want to quickly check that your code works. To use it, run the <strong class="source-inline">go run</strong> tool on the command line in the <span class="No-Break">following format:</span></p>
			<pre class="source-code">
go run source_file.go</pre>			<p>Perform the <span class="No-Break">following steps:</span></p>
			<ol>
				<li>Create a new directory called <strong class="source-inline">Exercise20.02</strong>. Within that directory, create a new file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Run the following two commands to create the Go module for <span class="No-Break">this exercise:</span><pre class="source-code">
go mod init
go mod tidy</pre></li>				<li>Add the following code to the file to create a simple <strong class="source-inline">Hello </strong><span class="No-Break"><strong class="source-inline">Packt</strong></span><span class="No-Break"> p<a id="_idTextAnchor2097"/><a id="_idTextAnchor2098"/>rogram:</span><pre class="source-code">
package main
import "fmt"
func main() {
  fmt.Println("Hello Packt")
}</pre></li>				<li>Now, you can run the program using the <strong class="source-inline">go </strong><span class="No-Break"><strong class="source-inline">run</strong></span><span class="No-Break"> tool:</span><pre class="source-code">
go run main.go</pre></li>			</ol>
			<p>This will execute the code and run it all in one step, giving you the <span class="No-Break">following output:</span></p>
			<pre class="console">
Hell<a id="_idTextAnchor2099"/>o Packt</pre>			<p>In this exercise, you used the <strong class="source-inline">go run</strong> tool to compile and run a simple Go program in a single step. This is <a id="_idIndexMarker1318"/>useful to quickly check whether your code does what <span class="No-Break">you<a id="_idTextAnchor2100"/><a id="_idTextAnchor2101"/> expect.</span></p>
			<h1 id="_idParaDest-504"><a id="_idTextAnchor2102"/>The gofmt tool</h1>
			<p>The <strong class="source-inline">gofmt</strong> tool is used to<a id="_idIndexMarker1319"/> keep your code neat and consistently styled. When working on a large software project, an important but often overlooked factor is code style. Having a consistent code style throughout your project is important for readability. When you must read someone else’s code, or even your own code months after writing it, having it in a consistent style makes you focus on the logic without much effort. Having to parse differing styles when reading code is just one more thing to worry about and leads to mistakes. To overcome this issue, Go comes with a tool to automatically format your code in a consistent way called <strong class="source-inline">gofmt</strong>. This means that, across your project, and even across other Go projects that use the <strong class="source-inline">gofmt</strong> tool, the code will be consistent. So, it will fix the formatting of the code by correcting the spacing and indentation, as well as trying to align the sections of <span class="No-Break">y<a id="_idTextAnchor2103"/><a id="_idTextAnchor2104"/>our code.</span></p>
			<h2 id="_idParaDest-505"><a id="_idTextAnchor2105"/>Exercise 20.03 – using the gofmt tool</h2>
			<p>In this exercise, you’ll learn <a id="_idIndexMarker1320"/>how to use the <strong class="source-inline">gofmt</strong> tool to format your code. When you run the <strong class="source-inline">gofmt</strong> tool, it will display how it thinks the file should look with the correct formatting, but it won’t change the file. If you would like <strong class="source-inline">gofmt</strong> to automatically change the file to the correct format, you can run <strong class="source-inline">gofmt</strong> with the <strong class="source-inline">-w</strong> option, which will update the file and save the changes. Let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>Create a new directory called <strong class="source-inline">Exercise20.03</strong>. Within that directory, create a new Go file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Run the following two commands to create the Go module for <span class="No-Break">this exercise:</span><pre class="source-code">
go mod init
go mod tidy</pre></li>				<li>Add the following code to the file to create a badly formatted <strong class="source-inline">Hello </strong><span class="No-Break"><strong class="source-inline">Pack<a id="_idTextAnchor2106"/><a id="_idTextAnchor2107"/>t</strong></span><span class="No-Break"> program:</span><pre class="source-code">
package main
import "fmt"
func main(){
  firstVar := 1
  seco<a id="_idTextAnchor2108"/><a id="_idTextAnchor2109"/>ndVar := 2
  fmt.Println(firstVar)
  fmt.Println(secondVar)
  fmt. Println("Hello Packt")
}</pre></li>				<li>Then, in your Terminal, run <strong class="source-inline">gofmt</strong> to see what the file will <span class="No-Break">look like:</span><pre class="source-code">
gofmt main.go</pre><p class="list-inset">This will display how <a id="_idIndexMarker1321"/>the file should be formatted to make it correct. Here is the <span class="No-Break">expect<a id="_idTextAnchor2110"/>ed output:</span></p></li>			</ol>
			<div>
				<div id="_idContainer222" class="IMG---Figure">
					<img src="image/B18621_20_1.jpg" alt="Figure 20.1: Expected output from gofmt" width="662" height="330"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 20.1: Expected output from gofmt</p>
			<p class="list-inset">However, this only shows the changes it would make; it doesn’t change the file. This is so that you can confirm you are happy with the changes it <span class="No-Break">will make.</span></p>
			<ol>
				<li value="5">To change the file and save those changes, you need to add the <strong class="source-inline">-</strong><span class="No-Break"><strong class="source-inline">w</strong></span><span class="No-Break"> option:</span><pre class="source-code">
gofmt <strong class="bold">-w</strong> main.go</pre><p class="list-inset">This will update the file and save the changes. Then, when you look at the file, it should look <span class="No-Break">like this:</span></p><pre class="source-code">package main
import "fmt"
func main() {
  firstVar := 1
  secondVar := 2
  fmt.Println(firstVar)
  fmt.Println(secondVar)
  fmt.Println("Hello Packt")
}</pre></li>			</ol>
			<p>You may observe that the badly formatted code has been realigned after using the <strong class="source-inline">gofmt</strong> tool. The spacing and indentation have been fixed, and the new line between <strong class="source-inline">func</strong> and <strong class="source-inline">main()</strong> has <span class="No-Break">been removed.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">Many <strong class="bold">integrated development environments</strong> (<strong class="bold">IDEs</strong>) come with a built-in way for you to use <strong class="source-inline">gofmt</strong> on your<a id="_idIndexMarker1322"/> code when you save. It is worth researching how to do this with your chosen IDE so that the <strong class="source-inline">gofmt</strong> tool will run automatically and fix any spacing or indentation mistakes in <span class="No-Break">your code.</span></p>
			<p>In this exercise, you<a id="_idIndexMarker1323"/> used the <strong class="source-inline">gofmt</strong> tool to reformat a badly formatted file into a neat state. This can seem pointless and annoying when you first start coding. However, as your skills improve and you start working on larger projects, you will start to appreciate the importance of a neat and consistent<a id="_idTextAnchor2111"/> <a id="_idTextAnchor2112"/><span class="No-Break">code style.</span></p>
			<h1 id="_idParaDest-506"><a id="_idTextAnchor2113"/>The goimports tool</h1>
			<p>Another useful tool<a id="_idIndexMarker1324"/> that comes with Go is <strong class="source-inline">goimports</strong>, which automatically adds the imports that are needed in your file. A key part of software engineering is not reinventing the wheel and reusing other people’s code. In Go, you do this by importing the libraries at the start of your file, in the <strong class="source-inline">import</strong> section. It can, however, be tedious to add these imports each time you need to use them. You can also accidentally leave in unused imports, which can pose a security risk. A better way to do this is to use <strong class="source-inline">goimports</strong> to automatically add the imports for you. It will also remove unused imports and <a id="_idIndexMarker1325"/>reorder the remaining imports into alphabetical order for <span class="No-Break">bette<a id="_idTextAnchor2114"/><a id="_idTextAnchor2115"/>r readability.</span></p>
			<h2 id="_idParaDest-507"><a id="_idTextAnchor2116"/>Exercise 20.04 – using the goimports tool</h2>
			<p>In this exercise, you <a id="_idIndexMarker1326"/>will learn how to use <strong class="source-inline">goimports</strong> to manage the imports in a simple Go program. When you run the <strong class="source-inline">goimports</strong> tool, it will output how it thinks the file should look with the imports fixed. Alternatively, you can run <strong class="source-inline">goimports</strong> with the <strong class="source-inline">-w</strong> option, which automatically updates the imports in the file and saves the changes. Let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>Create a new directory called <strong class="source-inline">Exercise20.04</strong>. Within that directory, create a new file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Run the following two commands to create the Go module for <span class="No-Break">this exercise:</span><pre class="source-code">
go mod init
go mod tidy</pre></li>				<li>Add the following code to the file to create a simple <strong class="source-inline">Hello Packt</strong> program with <span class="No-Break">incorrect imports:</span><pre class="source-code">
package main
import (
  "net/http"
  "fmt"
)
func main() {
  fmt.Println("Hello")
  log.Println("Packt")
}</pre><p class="list-inset">You will notice that the <strong class="source-inline">log</strong> library has not been imported and that the <strong class="source-inline">net/http</strong> import <span class="No-Break">is unused.</span></p></li>				<li>In your Terminal, run the <strong class="source-inline">goimports</strong> tool against your file to see how the <span class="No-Break">imports change:</span><pre class="source-code">
goimports main.go</pre><p class="list-inset">This will display the changes it would make to the file to correct it. Here is the <span class="No-Break">ex<a id="_idTextAnchor2117"/>pected output:</span></p></li>			</ol>
			<div>
				<div id="_idContainer223" class="IMG---Figure">
					<img src="image/B18621_20_2.jpg" alt="Figure 20.2: Expected output for goimports" width="987" height="306"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 20.2: Expected output for goimports</p>
			<p class="list-inset">This won’t have<a id="_idIndexMarker1327"/> changed the file but shows what the file will be changed to. As you can see, the <strong class="source-inline">net/http</strong> import has been removed and the <strong class="source-inline">log</strong> import has <span class="No-Break">been added.</span></p>
			<ol>
				<li value="5">To write these changes to the file, add the <strong class="source-inline">-</strong><span class="No-Break"><strong class="source-inline">w</strong></span><span class="No-Break"> option:</span><pre class="source-code">
goimports -w main.go</pre></li>				<li>This will update the file and make it look <span class="No-Break">as follows:</span><pre class="source-code">
package main
import (
  "fmt"
  "log"
)
func main() {
  fmt.Println("Hello")
  log.Println("Packt")
}</pre></li>			</ol>
			<p>In this exercise, you learned how to use the <strong class="source-inline">goimports</strong> tool. You can use this tool to detect incorrect and unused import statements and automatically correct them. Many IDEs come with a <a id="_idIndexMarker1328"/>built-in way to turn on <strong class="source-inline">goimports</strong> so that when you save your file, it will automatically correct the <a id="_idTextAnchor2118"/>im<a id="_idTextAnchor2119"/>ports <span class="No-Break">for you.</span></p>
			<h1 id="_idParaDest-508"><a id="_idTextAnchor2120"/>The go vet tool</h1>
			<p>The <strong class="source-inline">go vet</strong> tool is used <a id="_idIndexMarker1329"/>for static analysis of your Go code. While the Go compiler can find and inform you of mistakes you may have made, there are certain things it will miss. For this reason, the <strong class="source-inline">go vet</strong> tool was created. This might sound trivial, but some of these issues could go unnoticed for a long time after the code has been deployed, the most common of which is passing the wrong number of arguments when using the <strong class="source-inline">Printf</strong> function. It will also check for useless assignments, for example, if you set a variable and then never use that variable. Another particularly useful thing it detects is when a non-pointer interface is passed to an <strong class="source-inline">unmarshal</strong> function. The compiler won’t notice this as it is valid; however, the <strong class="source-inline">unmarshal</strong> function will be unable to write the data to the interface. This can be troublesome to debug but using the <strong class="source-inline">go vet</strong> tool allows you to catch it early and remediate the issue before it b<a id="_idTextAnchor2121"/><a id="_idTextAnchor2122"/>ecomes <span class="No-Break">a problem.</span></p>
			<h2 id="_idParaDest-509"><a id="_idTextAnchor2123"/>Exercise 20.05 – using the go vet tool</h2>
			<p>In this exercise, you <a id="_idIndexMarker1330"/>will use the <strong class="source-inline">go vet</strong> tool to find a common mistake that’s made when using the <strong class="source-inline">Printf</strong> function. You will use it to detect when the wrong number of arguments are being passed to a <strong class="source-inline">Printf</strong> function. Let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>Create a new directory called <strong class="source-inline">Exercise20.05</strong>. Within that directory, create a new go file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">:</span></li>
				<li>Run the following two commands to create the Go module for <span class="No-Break">this exercise:</span><pre class="source-code">
go mod init
go mod tidy</pre></li>				<li>Add the following code to the file to create a simple <strong class="source-inline">He<a id="_idTextAnchor2124"/><a id="_idTextAnchor2125"/>llo </strong><span class="No-Break"><strong class="source-inline">Packt</strong></span><span class="No-Break"> program:</span><pre class="source-code">
package main
import "fmt"
func main() {
  helloString := "Hello"
  pack<a id="_idTextAnchor2126"/><a id="_idTextAnchor2127"/>tString := "Packt"
  jointString := fmt.Sprintf("%s", helloString, packtString)
  fmt.Println(jointString)
}</pre><p class="list-inset">As you can see, the <strong class="source-inline">jointString</strong> variable makes use of <strong class="source-inline">fmt.Sprintf</strong> to join two strings into one. However, the <strong class="source-inline">%s</strong> format string is incorrect and only formats one <a id="_idIndexMarker1331"/>of the input strings. When you build this code, it will compile into a binary without any errors. However, when you run the program, the output will not be as expected. Luckily, the <strong class="source-inline">go vet</strong> tool was created for this <span class="No-Break">exact reason.</span></p></li>				<li>Run the <strong class="source-inline">go vet</strong> tool against the file <span class="No-Break">you created:</span><pre class="source-code">
go vet main.go</pre></li>				<li>This will display any issues it <a id="_idTextAnchor2128"/>finds in <span class="No-Break">the code:</span></li>
			</ol>
			<div>
				<div id="_idContainer224" class="IMG---Figure">
					<img src="image/B18621_20_3.jpg" alt="Figure 20.3: Expected output from go vet" width="919" height="89"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 20.3: Expected output from go vet</p>
			<p class="list-inset">As you can see, <strong class="source-inline">go vet</strong> has identified an issue on line 9 of the file. The <strong class="source-inline">Sprintf</strong> call needs <strong class="source-inline">1</strong> argument, but we have given <span class="No-Break">it </span><span class="No-Break"><strong class="source-inline">2</strong></span><span class="No-Break">.</span></p>
			<ol>
				<li value="6">Update the <strong class="source-inline">Sprintf</strong> call so that it can handle both arguments we want <span class="No-Break">to send:</span><pre class="source-code">
package main
import "fmt"
func main() {
  helloString := "Hello"
  packtString := "Packt"
  jointString := fmt.Sprintf("%s %s", helloString, packtString)
  fmt.Println(jointString)
}</pre></li>				<li>Now, you can run <strong class="source-inline">go vet</strong> again and check that there are no <span class="No-Break">more issues:</span><pre class="source-code">
go vet main.go</pre><p class="list-inset">It should return nothing, letting you know the file has no <span class="No-Break">more issues.</span></p></li>				<li>Now, run <span class="No-Break">the program:</span><pre class="source-code">
go run main.go</pre></li>			</ol>
			<p>Here’s the output after making the corrections in <span class="No-Break">the stri<a id="_idTextAnchor2129"/>ng:</span></p>
			<pre class="console">
Hello Packt</pre>			<p>In this exercise, you learned how to use the <strong class="source-inline">go vet</strong> tool to detect issues that the compiler might miss. While this is a very basic example, <strong class="source-inline">go vet</strong> can detect mistakes such as passing <a id="_idIndexMarker1332"/>a non-pointer to <strong class="source-inline">unmarshal</strong> functions or detecting unreachable code. You are encouraged to run <strong class="source-inline">go vet</strong> as part of your build process so that you can catch these issues before they make it<a id="_idTextAnchor2130"/><a id="_idTextAnchor2131"/> into <span class="No-Break">your program.</span></p>
			<h1 id="_idParaDest-510"><a id="_idTextAnchor2132"/>The Go race detector</h1>
			<p>The Go race detector <a id="_idIndexMarker1333"/>was added to Go so that developers can detect race conditions. As we mentioned in <a href="B18621_18.xhtml#_idTextAnchor1862"><span class="No-Break"><em class="italic">Chapter 18</em></span></a>, <em class="italic">Concurrent Work</em>, you can use goroutines to run parts of your code concurrently. However, even experienced programmers might make a mistake that allows different goroutines to access the same resource at the same time. This is called a race condition. A race condition is problematic because one goroutine can edit the resource in the middle of another reading it, meaning the resource could be corrupted. While Go has made concurrency a first-class citizen in the language, the mechanisms for concurrent code do not prevent race conditions. Also, due to the inherent nature of concurrency, a race condition might stay hidden until long after your code has been deployed. This also means they tend to be transient, making them devilishly difficult to debug and fix. This is why the Go race detector <span class="No-Break">was created.</span></p>
			<p>This tool works by using an algorithm that detects asynchronous memory access, but a drawback of this is that it can only do so when the code executes. So, you need to run the code to be able to<a id="_idIndexMarker1334"/> detect race conditions. Luckily, it has been integrated into the Go toolchain, so we can use <a id="_idTextAnchor2133"/>it <a id="_idTextAnchor2134"/>to do this <span class="No-Break">for us.</span></p>
			<h2 id="_idParaDest-511"><a id="_idTextAnchor2135"/>Exercise 20.06 – using the Go race detector</h2>
			<p>In this exercise, you will <a id="_idIndexMarker1335"/>create a basic program that contains a race condition. You will use the Go race detector on the program to find the race condition. You will learn how to identify where the problem lies and then learn ways to mitigate the race condition. Let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>Create a new directory called <strong class="source-inline">Exercise20.06</strong>. Within that directory, create a new file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Run the following two commands to create the Go module for <span class="No-Break">this exercise:</span><pre class="source-code">
go mod init
go mod tidy</pre></li>				<li>Add the following code to the file to create a simple program<a id="_idTextAnchor2136"/><a id="_idTextAnchor2137"/> with <span class="No-Break">race conditions:</span><pre class="source-code">
package main
import "fmt"
func main() {
  finished := make(chan bool)
  names := []string{"Packt"}
  go func() {
    names = append(names, "Electric")
    names = append(names, "Boogaloo")
    finished &lt;- true
  }()
  for _, name := range names {
    fmt.Println(name)
  }
  &lt;-finished
}</pre><p class="list-inset">As you can see, there is an array called <strong class="source-inline">names</strong> with one item in it. A goroutine then starts appending more names to it. At the same time, the main goroutine is attempting to print out all the items in the array. So, both goroutines are accessing the same resource at the same time, which is a <span class="No-Break">race condition.</span></p></li>				<li>Run the preceding <a id="_idIndexMarker1336"/>code with the <strong class="source-inline">race</strong> <span class="No-Break">flag activated:</span><pre class="source-code">
go run <strong class="bold">--race</strong> main.go</pre></li>			</ol>
			<p>Running this command will give us the <span class="No-Break">following output:</span></p>
			<pre class="console">
Packt
==================
WARNING: DATA RACE
Write at 0x00c0000aa000 by goroutine 6:
  main.main.func1()
      /Users/samcoyle/go/src/github.com/packt-book/Go-Programming---From-Beginner-to-Professional-Second-Edition-/Chapter20/Exercise20.06/main.go:10 +0xe0
Previous read at 0x00c0000aa000 by main goroutine:
  main.main()
      /Users/samcoyle/go/src/github.com/packt-book/Go-Programming---From-Beginner-to-Professional-Second-Edition-/Chapter20/Exercise20.06/main.go:14 +0x170
Goroutine 6 (running) created at:
  main.main()
      /Users/samcoyle/go/src/github.com/packt-book/Go-Programming---From-Beginner-to-Professional-Second-Edition-/Chapter20/Exercise20.06/main.go:9 +0x168
==================
Found 1 data race(s)
exit status 66</pre>			<p>In the output, you can see a warning, informing you about the race condition. It tells you that the same resource was read and written in the code on lines <strong class="source-inline">main.go:10</strong> and <strong class="source-inline">main.go:15</strong>, which look <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
  names = append(names, "Electric")
  for _, name := range names {</pre>			<p>As you can see, in both cases, it is the <strong class="source-inline">names</strong> array that is being accessed, so that is where the problem<a id="_idIndexMarker1337"/> lies. The reason this happens is that the program starts to print <strong class="source-inline">names</strong> before it waits for the <span class="No-Break"><strong class="source-inline">finished</strong></span><span class="No-Break"> channel.</span></p>
			<ol>
				<li>A solution could be to wait for the <strong class="source-inline">finished</strong> channel before printing <span class="No-Break">the items:</span><pre class="source-code">
  &lt;-finished
  for _, name := range names {
    fmt.Println(name)
  }</pre></li>				<li>This means that the items will have all been added to the array before you start to print them out. You can confirm this solution by running the program again with the <strong class="source-inline">--race</strong> <span class="No-Break">flag activated:</span><pre class="source-code">
go run <strong class="bold">--race</strong> main.go</pre></li>				<li>This should run the program as normal and show no race condition warnings. The expected output after the corrections have been made is <span class="No-Break">as follows:</span><pre class="source-code">
Packt
Electric
Boogaloo</pre><p class="list-inset">The final program with the race condition now fixed would look <span class="No-Break">as follows:</span></p><pre class="source-code">package main
import "fmt"
func main() {
  finished := make(chan bool)
  names := []string{"Packt"}
  go func() {
    names = append(names, "Electric")
    names = append(names, "Boogaloo")
    finished &lt;- true
  }()
  &lt;-finished
  for _, name := range names {
    fmt.Println(name)
  }
}</pre></li>			</ol>
			<p>While the program<a id="_idIndexMarker1338"/> in this exercise was quite simple, as was the solution, you are encouraged to return to <a href="B18621_18.xhtml#_idTextAnchor1862"><span class="No-Break"><em class="italic">Chapter 18</em></span></a>, <em class="italic">Concurrent Work</em>, and use the <strong class="source-inline">--race</strong> flag in the activities there. This will provide a better working example of how the Go race detector can <span class="No-Break">help you.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">The Go race detector is often used by professional software developers to confirm that their solution doesn’t contain an<a id="_idTextAnchor2138"/><a id="_idTextAnchor2139"/>y hidden <span class="No-Break">race conditions.</span></p>
			<h1 id="_idParaDest-512"><a id="_idTextAnchor2140"/>The go doc tool</h1>
			<p>The <strong class="source-inline">go doc</strong> tool is used to<a id="_idIndexMarker1339"/> generate documentation for packages and functions in Go. An often neglected part of many software projects is their documentation. This is because it can be tedious to write and even more tedious to keep up to date. So, Go comes with a tool to automatically generate documentation for package declarations and functions in your code. You simply need to add comments to the start of functions and packages. Then, these will be picked up and combined with the <span class="No-Break">function header.</span></p>
			<p>This can then be shared with others to help them understand how to use your code. To generate the documentation for a package and its function, you can use the <strong class="source-inline">go doc</strong> tool. Documentation like this helps when you are working on a large project and other people need to make use of your code. Often, in a professional setting, different teams will be working on different parts of a program; each team will need to communicate to the other teams about what functions are available in a package and how to call them. To do this, they could use <strong class="source-inline">go doc</strong> to generate the documentation for the code they’ve written and <a id="_idTextAnchor2141"/>shar<a id="_idTextAnchor2142"/>e it with <span class="No-Break">other teams.</span></p>
			<h2 id="_idParaDest-513"><a id="_idTextAnchor2143"/>Exercise 20.07 – implementing the go doc tool</h2>
			<p>In this exercise, you<a id="_idIndexMarker1340"/> will learn about the <strong class="source-inline">go doc</strong> tool and how it can be used to generate documentation for your code. Let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>Create a new directory called <strong class="source-inline">Exercise20.07</strong>. Within that directory, create a new file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Run the following two commands to create the Go module for <span class="No-Break">this exercise:</span><pre class="source-code">
go mod init
go mod tidy</pre></li>				<li>Add the following code to th<a id="_idTextAnchor2144"/><a id="_idTextAnchor2145"/>e <strong class="source-inline">main.go</strong> file <span class="No-Break">you created:</span><pre class="source-code">
package main
import "fmt"
// Add returns the total of <a id="_idTextAnchor2146"/><a id="_idTextAnchor2147"/>two integers added together
func Add(a, b int) int {
  return a + b
}
// Multiply returns the total of one integer multiplied by the other
func Multiply(a, b int) int {
  return a * b
}
func main() {
  fmt.Println(Add(1, 1))
  fmt.Println(Multiply(2, 2))
}</pre><p class="list-inset">This creates a simple program that contains two functions: one called <strong class="source-inline">Add</strong>, which adds two <a id="_idIndexMarker1341"/>numbers, and one called <strong class="source-inline">Multiply</strong>, which multiplies <span class="No-Break">two numbers.</span></p></li>				<li>Run the following command to compile and execute <span class="No-Break">the file:</span><pre class="source-code">
go run main.go</pre></li>				<li>The output will look <span class="No-Break">as follows:</span><pre class="source-code">
2
4</pre></li>				<li>You will notice that both functions have comments above them that begin with the name of the function. This is a Go convention to let you know that these comments can be used as documentation. What this means is that you can use the <strong class="source-inline">go doc</strong> tool to create documentation for the code. In the same directory as your <strong class="source-inline">main.go</strong> file, run <span class="No-Break">the following:</span><pre class="source-code">
<strong class="bold">go doc</strong> -all</pre></li>			</ol>
			<p>This will generate documentation for the code<a id="_idTextAnchor2148"/> and output it, <span class="No-Break">as follows:</span></p>
			<div>
				<div id="_idContainer225" class="IMG---Figure">
					<img src="image/B18621_20_4.jpg" alt="Figure 20.4: Expected output from go doc" width="978" height="259"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 20.4: Expected output from go doc</p>
			<p>In this exercise, you learned how to use the <strong class="source-inline">go doc</strong> tool to generate documentation on the Go package you created, as well as its functions. You can use this for other packages you have created and share the documentation with others if they would like to make use of your <a id="_idIndexMarker1342"/>code. If you would like to capture this documentation, you can use <strong class="source-inline">godo<a id="_idTextAnchor2149"/><a id="_idTextAnchor2150"/>c package/path <a id="_idTextAnchor2151"/>&gt; </strong><span class="No-Break"><strong class="source-inline">outp<a id="_idTextAnchor2152"/>ut.txt</strong></span><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-514"><a id="_idTextAnchor2153"/>The go get tool</h1>
			<p>The <strong class="source-inline">go get</strong> tool allows<a id="_idIndexMarker1343"/> you to download and use different libraries. While Go comes with a wide range of packages by default, it is dwarfed by the number of third-party packages that are available. These provide extra functionality that you can use in your code to enhance it. However, for your code to make use of these packages, you need to have them on your computer so that the compiler can include them when compiling your code. To download these packages,<a id="_idTextAnchor2154"/><a id="_idTextAnchor2155"/> you can use the <strong class="source-inline">go </strong><span class="No-Break"><strong class="source-inline">get</strong></span><span class="No-Break"> tool.</span></p>
			<h2 id="_idParaDest-515"><a id="_idTextAnchor2156"/>Exercise 20.08 – implementing the go get tool</h2>
			<p>In this exercise, you <a id="_idIndexMarker1344"/>will learn how to download a third-party package using <strong class="source-inline">go get</strong>. Let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>Create a new directory called <strong class="source-inline">Exercise20.08</strong>. Within that directory, create a new file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Run the following two commands to create the go module for <span class="No-Break">this exercise:</span><pre class="source-code">
go mod init
go mod tidy</pre></li>				<li>Add the following code to the <strong class="source-inline">main.go</strong> file <span class="No-Break">you <a id="_idTextAnchor2157"/><a id="_idTextAnchor2158"/>created:</span><pre class="source-code">
package main
import (
  "fmt"
  "log"
  "net/http"
  "github.com/gorilla/mux"
)
func exampleHandler(w http.ResponseWriter, r *http.Request) {
  w.WriteHeader(http.StatusOK)
  fmt.Fprintf(w, "Hello Packt")
}
func main() {
  r := mux.NewRouter()
  r.HandleFunc("/", exampleHandler)
  log.Fatal(http.ListenAndServe(":8888", r))
}</pre></li>				<li>This is a simple web<a id="_idIndexMarker1345"/> server that you can start by running the <span class="No-Break">following command:</span><pre class="source-code">
go run main.go</pre></li>				<li>However, the web server uses a third-party package called <strong class="source-inline">mux</strong>. In the import section, you will see that it has been imported from <strong class="source-inline">github.com/gorilla/mux</strong>. However, since we don’t have this package stored locally, an error will occur when we try to run <span class="No-Break">the program:</span><pre class="source-code">
main.go:8:2: no required module provides package github.com/gorilla/mux; to add it:
   go get github.com/gorilla/mux</pre></li>				<li>To get the third-party package, you can use <strong class="source-inline">go get</strong>. This will download it locally so that our Go code can make use <span class="No-Break">of it:</span><pre class="source-code">
go get github.com/gorilla/mux</pre></li>				<li>Now that you have downloaded the package, you can run the web <span class="No-Break">server again:</span><pre class="source-code">
go run main.go</pre><p class="list-inset">This time, it <a id="_idTextAnchor2159"/>should run without <span class="No-Break">any errors:</span></p></li>			</ol>
			<div>
				<div id="_idContainer226" class="IMG---Figure">
					<img src="image/B18621_20_5.jpg" alt="Figure 20.5: Expected output when running the web server" width="865" height="58"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 20.5: Expected output when running the web server</p>
			<ol>
				<li value="8">While the web server is running, you can open <strong class="source-inline">http://localhost:8888</strong> in your web bro<a id="_idTextAnchor2160"/>wser and check that <span class="No-Break">it works:</span></li>
			</ol>
			<div>
				<div id="_idContainer227" class="IMG---Figure">
					<img src="image/B18621_20_6.jpg" alt="Figure 20.6: Web server output when viewed in Firefox" width="722" height="76"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 20.6: Web server output w<a id="_idTextAnchor2161"/>hen viewed in Firefox</p>
			<p>In this exercise, you <a id="_idIndexMarker1346"/>learned how to download third-party packages using the <strong class="source-inline">go get</strong> tool. This allows the use of tools and packages beyond what come<a id="_idTextAnchor2162"/>s as a s<a id="_idTextAnchor2163"/>tandard package <span class="No-Break">in Go.</span></p>
			<h2 id="_idParaDest-516"><a id="_idTextAnchor2164"/>Activity 20.01 – using gofmt, goimport, go vet, and go get to correct a file</h2>
			<p>Imagine that you <a id="_idIndexMarker1347"/>are<a id="_idIndexMarker1348"/> working<a id="_idIndexMarker1349"/> on<a id="_idIndexMarker1350"/> a project with poorly written code. The file contains a badly formatted file, missing imports, and a log message in the wrong place. You want to use the Go tools you’ve learned about in this chapter to correct the file and find any issues with it. In this activity, you will use <strong class="source-inline">gofmt</strong>, <strong class="source-inline">goimport</strong>, <strong class="source-inline">go vet</strong>, and <strong class="source-inline">go get</strong> to fix the file and find any issues within it. The steps for this activity are <span class="No-Break">as follows:</span></p>
			<ol>
				<li>Create a directory <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">Activity20.01</strong></span><span class="No-Break">.</span></li>
				<li>Create a file <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Add the Go module for your <span class="No-Break">activity code.</span></li>
				<li>Add the code from the <strong class="source-inline">Activity20.01/example</strong> directory to <strong class="source-inline">main.go</strong> so that you can correct and properly format it and install <span class="No-Break">its dependencies.</span></li>
				<li>Fix any <span class="No-Break">formatting issues.</span></li>
				<li>Fix any missing imports <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">main.go</strong></span><span class="No-Break">.</span></li>
				<li>Check for any issues the compiler may miss by using <span class="No-Break"><strong class="source-inline">go vet</strong></span><span class="No-Break">.</span></li>
				<li>Ensure <a id="_idIndexMarker1351"/>the<a id="_idIndexMarker1352"/> third-party <strong class="source-inline">gorilla/mux</strong> package <a id="_idIndexMarker1353"/>has <a id="_idIndexMarker1354"/>been downloaded to your <span class="No-Break">local c<a id="_idTextAnchor2165"/>omputer.</span><p class="list-inset">Here is the <span class="No-Break">expected output:</span></p></li>
			</ol>
			<div>
				<div id="_idContainer228" class="IMG---Figure">
					<img src="image/B18621_20_7.jpg" alt="Figure 20.7: Expected output when running the code" width="971" height="58"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 20.7: Expected output when running the code</p>
			<p>You can check that this worked by going to <strong class="source-inline">http:/<a id="_idTextAnchor2166"/>/localhost:8888</strong> in your <span class="No-Break">web browser:</span></p>
			<div>
				<div id="_idContainer229" class="IMG---Figure">
					<img src="image/B18621_20_8.jpg" alt="Figure 20.8: Expected output when accessing the web server through Firefox" width="717" height="70"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 20.8: Expected output when accessing the web server through Firefox</p>
			<p class="callout-heading">Note</p>
			<p class="callout"> The solution for this activity can be found in this book’s GitHub repository <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Go-Programming-From-Beginner-to-Professional-Second-Edition-/tree/main/Chapter20/Activity20.01"><span class="No-Break">https://github.com/PacktPublishing/Go-Programming-From-Beginner-to-Professional-Second-Edition-/tree/main/Chapter20/Activity20.01</span></a><span class="No-Break">.</span></p>
			<p>Here <a id="_idIndexMarker1355"/>is<a id="_idIndexMarker1356"/> the example code <span class="No-Break">to correct:</span></p>
			<pre class="source-code">
package main
import (
  "log"
  "fmt"
  "github.com/gorilla/mux"
)
// ExampleHandler handles the http requests sent to this webserver
Func ExampleHandler(w http.ResponseWriter, r *http.Request) {
  w.WriteHeader(http.StatusOK)
  fmt.Fprintf(w, "Hello Packt")
  return
  log.Println("completed")
}
func main() {
  r := mux.NewRouter()
  r.HandleFunc("/", ExampleHandler)
  log.Fatal(http.ListenAndServe(":8888", r))
}</pre>			<p>You’ve now <a id="_idIndexMarker1357"/>seen<a id="_idIndexMarker1358"/> several of<a id="_idIndexMarker1359"/> the G<a id="_idTextAnchor2167"/><a id="_idTextAnchor2168"/>o tools in<a id="_idTextAnchor2169"/><a id="_idTextAnchor2170"/> action in one <span class="No-Break">coding</span><span class="No-Break"><a id="_idIndexMarker1360"/></span><span class="No-Break"> exercise.</span></p>
			<h1 id="_idParaDest-517"><a id="_idTextAnchor2171"/>Summary</h1>
			<p>Go tools are invaluable to a programmers when they’re writing code. In this chapter, you learned about <strong class="source-inline">go build</strong> and how to compile your code into executables. Then, you learned how consistent neat code is important when working on a project and how you can use <strong class="source-inline">gofmt</strong> to automatically neaten the code for you. This can be further improved with <strong class="source-inline">goimports</strong>, which can remove unnecessary imports for better security and automatically add imports you may have forgotten to <span class="No-Break">add yourself.</span></p>
			<p>After, you looked at <strong class="source-inline">go vet</strong> and how it can be used to help you find any mistakes that the compiler may have missed. You also learnt how to use the Go race detector to find race conditions hidden in your code. Then, you learned how to generate documentation for your code, which makes for easier collaboration when working on larger projects. Finally, you looked at downloading third-party packages using the <strong class="source-inline">go get</strong> tool, which allows you to make use of numerous Go packages that are available online to enhance <span class="No-Break">your code.</span></p>
			<p>In the next chapter, you will learn about running your Go code in the cloud, and considerations developers make when <span class="No-Break">this occurs.</span></p>
		</div>
	</div></div></body></html>