<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer148">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 class="chapterTitle" id="_idParaDest-262"><span class="koboSpan" id="kobo.2.1">Building Web Services</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">The core subject of this chapter is working with HTTP using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4.1">net/http</span></code><span class="koboSpan" id="kobo.5.1"> package—keep in mind that all web services require a web server to operate. </span><span class="koboSpan" id="kobo.5.2">Additionally, in this chapter, we are going to convert the statistics application into a web application that accepts HTTP connections and create a command line client to work with it. </span><span class="koboSpan" id="kobo.5.3">In the last part of the chapter, we are going to learn how to time out HTTP connections.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.6.1">In more detail, this chapter covers:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.8.1">net/http</span></code><span class="koboSpan" id="kobo.9.1"> package</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Creating a web server</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Updating the statistics application</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Developing web clients</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.13.1">Creating a client for the statistics service</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.14.1">Timing out HTTP connections</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-263"><span class="koboSpan" id="kobo.15.1">The net/http package</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.16.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.17.1">net/http</span></code><span class="koboSpan" id="kobo.18.1"> package </span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.19.1">offers functions that allow you to develop web servers and clients. </span><span class="koboSpan" id="kobo.19.2">For example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.20.1">http.Get()</span></code><span class="koboSpan" id="kobo.21.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.22.1">http.NewRequest()</span></code><span class="koboSpan" id="kobo.23.1"> are used by clients to make HTTP requests, whereas </span><code class="inlineCode"><span class="koboSpan" id="kobo.24.1">http.ListenAndServe()</span></code><span class="koboSpan" id="kobo.25.1"> is used to start web servers by specifying the IP address and the TCP port that the server listens to. </span><span class="koboSpan" id="kobo.25.2">Additionally, </span><code class="inlineCode"><span class="koboSpan" id="kobo.26.1">http.HandleFunc()</span></code><span class="koboSpan" id="kobo.27.1"> defines supported URLs as well as the functions that are going to handle these URLs.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.28.1">The next three subsections describe three important data structures of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.29.1">net/http</span></code><span class="koboSpan" id="kobo.30.1"> package—you can use these descriptions as a reference while reading this chapter.</span></p>
<h2 class="heading-2" id="_idParaDest-264"><span class="koboSpan" id="kobo.31.1">The http.Response type</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.32.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.33.1">http.Response</span></code><span class="koboSpan" id="kobo.34.1"> struct embodies</span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.35.1"> the response from an </span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.36.1">HTTP request—both </span><code class="inlineCode"><span class="koboSpan" id="kobo.37.1">http.Client</span></code><span class="koboSpan" id="kobo.38.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.39.1">http.Transport</span></code><span class="koboSpan" id="kobo.40.1"> return </span><code class="inlineCode"><span class="koboSpan" id="kobo.41.1">http.Response</span></code><span class="koboSpan" id="kobo.42.1"> values once the response headers have been received. </span><span class="koboSpan" id="kobo.42.2">Its definition can be found at </span><a href="https://go.dev/src/net/http/response.go"><span class="url"><span class="koboSpan" id="kobo.43.1">https://go.dev/src/net/http/response.go</span></span></a><span class="koboSpan" id="kobo.44.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.45.1">type</span></span><span class="koboSpan" id="kobo.46.1"> Response </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.47.1">struct</span></span><span class="koboSpan" id="kobo.48.1"> {
    Status     </span><span class="hljs-type"><span class="koboSpan" id="kobo.49.1">string</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.50.1">// e.g. </span><span class="koboSpan" id="kobo.50.2">"200 OK"</span></span><span class="koboSpan" id="kobo.51.1">
    StatusCode </span><span class="hljs-type"><span class="koboSpan" id="kobo.52.1">int</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.53.1">// e.g. </span><span class="koboSpan" id="kobo.53.2">200</span></span><span class="koboSpan" id="kobo.54.1">
    Proto      </span><span class="hljs-type"><span class="koboSpan" id="kobo.55.1">string</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.56.1">// e.g. </span><span class="koboSpan" id="kobo.56.2">"HTTP/1.0"</span></span><span class="koboSpan" id="kobo.57.1">
    ProtoMajor </span><span class="hljs-type"><span class="koboSpan" id="kobo.58.1">int</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.59.1">// e.g. </span><span class="koboSpan" id="kobo.59.2">1</span></span><span class="koboSpan" id="kobo.60.1">
    ProtoMinor </span><span class="hljs-type"><span class="koboSpan" id="kobo.61.1">int</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.62.1">// e.g. </span><span class="koboSpan" id="kobo.62.2">0</span></span><span class="koboSpan" id="kobo.63.1">
    Header Header
    Body io.ReadCloser 
    ContentLength </span><span class="hljs-type"><span class="koboSpan" id="kobo.64.1">int64</span></span><span class="koboSpan" id="kobo.65.1">
    TransferEncoding []</span><span class="hljs-type"><span class="koboSpan" id="kobo.66.1">string</span></span><span class="koboSpan" id="kobo.67.1">
    Close </span><span class="hljs-type"><span class="koboSpan" id="kobo.68.1">bool</span></span><span class="koboSpan" id="kobo.69.1">
    Uncompressed </span><span class="hljs-type"><span class="koboSpan" id="kobo.70.1">bool</span></span><span class="koboSpan" id="kobo.71.1">
    Trailer Header 
    Request *Request
    TLS *tls.ConnectionState
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.72.1">You do not have to use all the structure fields, but it is good to know that they exist. </span><span class="koboSpan" id="kobo.72.2">However, some of them, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.73.1">Status</span></code><span class="koboSpan" id="kobo.74.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.75.1">StatusCode</span></code><span class="koboSpan" id="kobo.76.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.77.1">Body</span></code><span class="koboSpan" id="kobo.78.1">, are more important than others. </span><span class="koboSpan" id="kobo.78.2">The Go source file, as well as the output of </span><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">go doc http.Response</span></code><span class="koboSpan" id="kobo.80.1">, contains more information about the purpose of each field, which is also the case with most </span><code class="inlineCode"><span class="koboSpan" id="kobo.81.1">struct</span></code><span class="koboSpan" id="kobo.82.1"> data types found in the standard Go library.</span></p>
<h2 class="heading-2" id="_idParaDest-265"><span class="koboSpan" id="kobo.83.1">The http.Request type</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.84.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.85.1">http.Request</span></code><span class="koboSpan" id="kobo.86.1"> structure</span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.87.1"> represents an HTTP request as </span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.88.1">constructed by a client in order to be sent or received by an HTTP server. </span><span class="koboSpan" id="kobo.88.2">The public fields of </span><code class="inlineCode"><span class="koboSpan" id="kobo.89.1">http.Request</span></code><span class="koboSpan" id="kobo.90.1"> are as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.91.1">type</span></span><span class="koboSpan" id="kobo.92.1"> Request </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.93.1">struct</span></span><span class="koboSpan" id="kobo.94.1"> {
    Method </span><span class="hljs-type"><span class="koboSpan" id="kobo.95.1">string</span></span><span class="koboSpan" id="kobo.96.1">
    URL *url.URL
    Proto  </span><span class="hljs-type"><span class="koboSpan" id="kobo.97.1">string</span></span><span class="koboSpan" id="kobo.98.1">
    ProtoMajor </span><span class="hljs-type"><span class="koboSpan" id="kobo.99.1">int</span></span><span class="koboSpan" id="kobo.100.1">
    ProtoMinor </span><span class="hljs-type"><span class="koboSpan" id="kobo.101.1">int</span></span><span class="koboSpan" id="kobo.102.1">
    Header Header
    Body io.ReadCloser
    GetBody </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.103.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.104.1">()</span></span><span class="koboSpan" id="kobo.105.1"> (io.ReadCloser, </span><span class="hljs-type"><span class="koboSpan" id="kobo.106.1">error</span></span><span class="koboSpan" id="kobo.107.1">)
    ContentLength </span><span class="hljs-type"><span class="koboSpan" id="kobo.108.1">int64</span></span><span class="koboSpan" id="kobo.109.1">
    TransferEncoding []</span><span class="hljs-type"><span class="koboSpan" id="kobo.110.1">string</span></span><span class="koboSpan" id="kobo.111.1">
    Close </span><span class="hljs-type"><span class="koboSpan" id="kobo.112.1">bool</span></span><span class="koboSpan" id="kobo.113.1">
    Host </span><span class="hljs-type"><span class="koboSpan" id="kobo.114.1">string</span></span><span class="koboSpan" id="kobo.115.1">
    Form url.Values
    PostForm url.Values
    MultipartForm *multipart.Form
    Trailer Header
    RemoteAddr </span><span class="hljs-type"><span class="koboSpan" id="kobo.116.1">string</span></span><span class="koboSpan" id="kobo.117.1">
    RequestURI </span><span class="hljs-type"><span class="koboSpan" id="kobo.118.1">string</span></span><span class="koboSpan" id="kobo.119.1">
    TLS *tls.ConnectionState
    Cancel &lt;-</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.120.1">chan</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.121.1">struct</span></span><span class="koboSpan" id="kobo.122.1">{}
    Response *Response
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.123.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.124.1">Body</span></code><span class="koboSpan" id="kobo.125.1"> field holds the body of the request. </span><span class="koboSpan" id="kobo.125.2">After reading the body of a request, you are allowed to</span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.126.1"> call </span><code class="inlineCode"><span class="koboSpan" id="kobo.127.1">GetBody()</span></code><span class="koboSpan" id="kobo.128.1">, which returns a new copy of the </span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.129.1">body—this is optional.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.130.1">Let us now present the </span><code class="inlineCode"><span class="koboSpan" id="kobo.131.1">http.Transport</span></code><span class="koboSpan" id="kobo.132.1"> structure.</span></p>
<h2 class="heading-2" id="_idParaDest-266"><span class="koboSpan" id="kobo.133.1">The http.Transport type</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.134.1">The</span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.135.1"> definition of </span><code class="inlineCode"><span class="koboSpan" id="kobo.136.1">http.Transport</span></code><span class="koboSpan" id="kobo.137.1">, which gives you more </span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.138.1">control over your HTTP connections, is fairly long and complex:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.139.1">type</span></span><span class="koboSpan" id="kobo.140.1"> Transport </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.141.1">struct</span></span><span class="koboSpan" id="kobo.142.1"> {
    Proxy </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.143.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.144.1">(*Request)</span></span><span class="koboSpan" id="kobo.145.1"> (*url.URL, </span><span class="hljs-type"><span class="koboSpan" id="kobo.146.1">error</span></span><span class="koboSpan" id="kobo.147.1">)
    DialContext </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.148.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.149.1">(ctx context.Context, network, addr </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.150.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.151.1">)</span></span><span class="koboSpan" id="kobo.152.1"> (net.Conn, </span><span class="hljs-type"><span class="koboSpan" id="kobo.153.1">error</span></span><span class="koboSpan" id="kobo.154.1">)
    Dial </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.155.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.156.1">(network, addr </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.157.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.158.1">)</span></span><span class="koboSpan" id="kobo.159.1"> (net.Conn, </span><span class="hljs-type"><span class="koboSpan" id="kobo.160.1">error</span></span><span class="koboSpan" id="kobo.161.1">)
    DialTLSContext </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.162.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.163.1">(ctx context.Context, network, addr </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.164.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.165.1">)</span></span><span class="koboSpan" id="kobo.166.1"> (net.Conn, </span><span class="hljs-type"><span class="koboSpan" id="kobo.167.1">error</span></span><span class="koboSpan" id="kobo.168.1">)
    DialTLS </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.169.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.170.1">(network, addr </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.171.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.172.1">)</span></span><span class="koboSpan" id="kobo.173.1"> (net.Conn, </span><span class="hljs-type"><span class="koboSpan" id="kobo.174.1">error</span></span><span class="koboSpan" id="kobo.175.1">)
    TLSClientConfig *tls.Config
    TLSHandshakeTimeout time.Duration
    DisableKeepAlives </span><span class="hljs-type"><span class="koboSpan" id="kobo.176.1">bool</span></span><span class="koboSpan" id="kobo.177.1">
    DisableCompression </span><span class="hljs-type"><span class="koboSpan" id="kobo.178.1">bool</span></span><span class="koboSpan" id="kobo.179.1">
    MaxIdleConns </span><span class="hljs-type"><span class="koboSpan" id="kobo.180.1">int</span></span><span class="koboSpan" id="kobo.181.1">
    MaxIdleConnsPerHost </span><span class="hljs-type"><span class="koboSpan" id="kobo.182.1">int</span></span><span class="koboSpan" id="kobo.183.1">
    MaxConnsPerHost </span><span class="hljs-type"><span class="koboSpan" id="kobo.184.1">int</span></span><span class="koboSpan" id="kobo.185.1">
    IdleConnTimeout time.Duration
    ResponseHeaderTimeout time.Duration
    ExpectContinueTimeout time.Duration
    TLSNextProto </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.186.1">map</span></span><span class="koboSpan" id="kobo.187.1">[</span><span class="hljs-type"><span class="koboSpan" id="kobo.188.1">string</span></span><span class="koboSpan" id="kobo.189.1">]</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.190.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.191.1">(authority </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.192.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.193.1">, c *tls.Conn)</span></span><span class="koboSpan" id="kobo.194.1"> RoundTripper
    ProxyConnectHeader Header
    GetProxyConnectHeader </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.195.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.196.1">(ctx context.Context, proxyURL *url.URL, target </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.197.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.198.1">)</span></span><span class="koboSpan" id="kobo.199.1"> (Header, </span><span class="hljs-type"><span class="koboSpan" id="kobo.200.1">error</span></span><span class="koboSpan" id="kobo.201.1">)
    MaxResponseHeaderBytes </span><span class="hljs-type"><span class="koboSpan" id="kobo.202.1">int64</span></span><span class="koboSpan" id="kobo.203.1">
    WriteBufferSize </span><span class="hljs-type"><span class="koboSpan" id="kobo.204.1">int</span></span><span class="koboSpan" id="kobo.205.1">
    ReadBufferSize </span><span class="hljs-type"><span class="koboSpan" id="kobo.206.1">int</span></span><span class="koboSpan" id="kobo.207.1">
    ForceAttemptHTTP2 </span><span class="hljs-type"><span class="koboSpan" id="kobo.208.1">bool</span></span><span class="koboSpan" id="kobo.209.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.210.1">Keep in mind that </span><code class="inlineCode"><span class="koboSpan" id="kobo.211.1">http.Transport</span></code><span class="koboSpan" id="kobo.212.1"> is </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.213.1">low-level</span></strong><span class="koboSpan" id="kobo.214.1"> compared to </span><code class="inlineCode"><span class="koboSpan" id="kobo.215.1">http.Client</span></code><span class="koboSpan" id="kobo.216.1">. </span><span class="koboSpan" id="kobo.216.2">The latter implements a high-level HTTP client—each </span><code class="inlineCode"><span class="koboSpan" id="kobo.217.1">http.Client</span></code><span class="koboSpan" id="kobo.218.1"> contains a </span><code class="inlineCode"><span class="koboSpan" id="kobo.219.1">Transport</span></code><span class="koboSpan" id="kobo.220.1"> field. </span><span class="koboSpan" id="kobo.220.2">If its value is </span><code class="inlineCode"><span class="koboSpan" id="kobo.221.1">nil</span></code><span class="koboSpan" id="kobo.222.1">, then </span><code class="inlineCode"><span class="koboSpan" id="kobo.223.1">DefaultTransport</span></code><span class="koboSpan" id="kobo.224.1"> is used. </span><span class="koboSpan" id="kobo.224.2">You do not need to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.225.1">http.Transport</span></code><span class="koboSpan" id="kobo.226.1"> in all of your programs, and you are not required to deal with all of its fields all the time. </span><span class="koboSpan" id="kobo.226.2">To learn</span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.227.1"> more</span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.228.1"> about </span><code class="inlineCode"><span class="koboSpan" id="kobo.229.1">DefaultTransport</span></code><span class="koboSpan" id="kobo.230.1">, type </span><code class="inlineCode"><span class="koboSpan" id="kobo.231.1">go doc http.DefaultTransport</span></code><span class="koboSpan" id="kobo.232.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.233.1">Let us now learn how to develop a web server.</span></p>
<h1 class="heading-1" id="_idParaDest-267"><span class="koboSpan" id="kobo.234.1">Creating a web server</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.235.1">This section presents a </span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.236.1">simple web server developed in Go to better understand the principles behind such applications. </span><span class="koboSpan" id="kobo.236.2">Although a web server programmed in Go can do many things efficiently and securely, if what you really need is a powerful web server that supports modules, multiple websites, and virtual hosts, then you would be better off using a web server such as Apache, Nginx, or Caddy that is written in Go. </span><span class="koboSpan" id="kobo.236.3">Those powerful web servers typically are in front of Go application servers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.237.1">You might ask why the presented web server uses HTTP instead of secure HTTP (HTTPS). </span><span class="koboSpan" id="kobo.237.2">The answer to this question is simple: most Go web servers are deployed as Docker images and are hidden behind web servers, such as Caddy and Nginx, that provide the secure HTTP operation part using the appropriate security credentials. </span><span class="koboSpan" id="kobo.237.3">It does not make any sense to use the secure HTTP protocol along with the required security credentials without knowing how, and under which domain name, an application is going to be deployed. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.238.1">This is a common practice in microservices as well as regular web applications that are deployed as Docker images. </span><span class="koboSpan" id="kobo.238.2">So this is a design decision that is a common practice for such cases. </span><span class="koboSpan" id="kobo.238.3">However, your requirements might differ.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.239.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.240.1">net/http</span></code><span class="koboSpan" id="kobo.241.1"> package offers functions and data types that allow you to develop powerful web servers and clients. </span><span class="koboSpan" id="kobo.241.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.242.1">http.Set()</span></code><span class="koboSpan" id="kobo.243.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.244.1">http.Get()</span></code><span class="koboSpan" id="kobo.245.1"> methods can be used to make HTTP and HTTPS requests, whereas </span><code class="inlineCode"><span class="koboSpan" id="kobo.246.1">http.ListenAndServe()</span></code><span class="koboSpan" id="kobo.247.1"> is used for creating web servers given the user-specified handler function or functions that handle incoming requests. </span><span class="koboSpan" id="kobo.247.2">As most web services require support for multiple endpoints, you end up needing multiple discrete functions to handle incoming requests, which also leads to the better design of your services.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.248.1">The simplest way to define the supported endpoints, as well as the handler function that responds to each client request, is with the use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.249.1">http.HandleFunc()</span></code><span class="koboSpan" id="kobo.250.1">, which can be called multiple times.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.251.1">After this quick and somewhat theoretical introduction, it is time to begin talking about more practical topics, beginning </span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.252.1">with the implementation of a simple web server, as illustrated in </span><code class="inlineCode"><span class="koboSpan" id="kobo.253.1">wwwServer.go</span></code><span class="koboSpan" id="kobo.254.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.255.1">package</span></span><span class="koboSpan" id="kobo.256.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.257.1">import</span></span><span class="koboSpan" id="kobo.258.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.259.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.260.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.261.1">"os"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.262.1">"time"</span></span><span class="koboSpan" id="kobo.263.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.264.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.265.1">myHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.266.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.267.1"> {
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.268.1">"Serving: %s\n"</span></span><span class="koboSpan" id="kobo.269.1">, r.URL.Path)
    fmt.Printf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.270.1">"Served: %s\n"</span></span><span class="koboSpan" id="kobo.271.1">, r.Host)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.272.1">This is a handler function that sends a message back to the client using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.273.1">w http.ResponseWriter</span></code><span class="koboSpan" id="kobo.274.1">, which is an interface that implements </span><code class="inlineCode"><span class="koboSpan" id="kobo.275.1">io.Writer</span></code><span class="koboSpan" id="kobo.276.1"> and is used to send the server response.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.277.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.278.1">timeHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.279.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.280.1"> {
    t := time.Now().Format(time.RFC1123)
    Body := </span><span class="hljs-string"><span class="koboSpan" id="kobo.281.1">"The current time is:"</span></span><span class="koboSpan" id="kobo.282.1">
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.283.1">"&lt;h1 align=\"center\"&gt;%s&lt;/h1&gt;"</span></span><span class="koboSpan" id="kobo.284.1">, Body)
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.285.1">"&lt;h2 align=\"center\"&gt;%s&lt;/h2&gt;\n"</span></span><span class="koboSpan" id="kobo.286.1">, t)
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.287.1">"Serving: %s\n"</span></span><span class="koboSpan" id="kobo.288.1">, r.URL.Path)
    fmt.Printf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.289.1">"Served time for: %s\n"</span></span><span class="koboSpan" id="kobo.290.1">, r.Host)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.291.1">This is another handler function called </span><code class="inlineCode"><span class="koboSpan" id="kobo.292.1">timeHandler</span></code><span class="koboSpan" id="kobo.293.1"> that returns the current time in the HTML format. </span><span class="koboSpan" id="kobo.293.2">All </span><code class="inlineCode"><span class="koboSpan" id="kobo.294.1">fmt.Fprintf()</span></code><span class="koboSpan" id="kobo.295.1"> calls send data back to the HTTP client, whereas the output of </span><code class="inlineCode"><span class="koboSpan" id="kobo.296.1">fmt.Printf()</span></code><span class="koboSpan" id="kobo.297.1"> is printed on the terminal that the web server runs on. </span><span class="koboSpan" id="kobo.297.2">The first argument of </span><code class="inlineCode"><span class="koboSpan" id="kobo.298.1">fmt.Fprintf()</span></code><span class="koboSpan" id="kobo.299.1"> is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.300.1">w http.ResponseWriter</span></code><span class="koboSpan" id="kobo.301.1">, which implements </span><code class="inlineCode"><span class="koboSpan" id="kobo.302.1">io.Writer</span></code><span class="koboSpan" id="kobo.303.1"> and, therefore, can accept data for writing.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.304.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.305.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.306.1">()</span></span><span class="koboSpan" id="kobo.307.1"> {
    PORT := </span><span class="hljs-string"><span class="koboSpan" id="kobo.308.1">":8001"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.309.1">This is where you define the port number that your web server is going to listen to.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.310.1">    arguments := os.Args
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.311.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.312.1">len</span></span><span class="koboSpan" id="kobo.313.1">(arguments) != </span><span class="hljs-number"><span class="koboSpan" id="kobo.314.1">1</span></span><span class="koboSpan" id="kobo.315.1"> {
        PORT = </span><span class="hljs-string"><span class="koboSpan" id="kobo.316.1">":"</span></span><span class="koboSpan" id="kobo.317.1"> + arguments[</span><span class="hljs-number"><span class="koboSpan" id="kobo.318.1">1</span></span><span class="koboSpan" id="kobo.319.1">]
    }
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.320.1">"Using port number: "</span></span><span class="koboSpan" id="kobo.321.1">, PORT)
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.322.1">If you use port number </span><code class="inlineCode"><span class="koboSpan" id="kobo.323.1">0</span></code><span class="koboSpan" id="kobo.324.1">, you are going to get a randomly selected free port, which is pretty handy for testing or when you do not want to specify the port yourself.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.325.1">If you do not want to use the predefined port number (</span><code class="inlineCode"><span class="koboSpan" id="kobo.326.1">8001</span></code><span class="koboSpan" id="kobo.327.1">), then you should provide </span><code class="inlineCode"><span class="koboSpan" id="kobo.328.1">wwwServer.go</span></code><span class="koboSpan" id="kobo.329.1"> with your</span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.330.1"> own port number as a command line argument.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.331.1">    http.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.332.1">"/time"</span></span><span class="koboSpan" id="kobo.333.1">, timeHandler)
    http.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.334.1">"/"</span></span><span class="koboSpan" id="kobo.335.1">, myHandler)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.336.1">So, the web server supports the </span><code class="inlineCode"><span class="koboSpan" id="kobo.337.1">/time</span></code><span class="koboSpan" id="kobo.338.1"> URL as well as </span><code class="inlineCode"><span class="koboSpan" id="kobo.339.1">/</span></code><span class="koboSpan" id="kobo.340.1">. </span><span class="koboSpan" id="kobo.340.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.341.1">/</span></code><span class="koboSpan" id="kobo.342.1"> path matches every URL not matched by other handlers. </span><span class="koboSpan" id="kobo.342.2">The fact that we associate </span><code class="inlineCode"><span class="koboSpan" id="kobo.343.1">myHandler()</span></code><span class="koboSpan" id="kobo.344.1"> with </span><code class="inlineCode"><span class="koboSpan" id="kobo.345.1">/</span></code><span class="koboSpan" id="kobo.346.1"> makes </span><code class="inlineCode"><span class="koboSpan" id="kobo.347.1">myHandler()</span></code><span class="koboSpan" id="kobo.348.1"> the default handler function.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.349.1">    err := http.ListenAndServe(PORT, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.350.1">nil</span></span><span class="koboSpan" id="kobo.351.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.352.1">if</span></span><span class="koboSpan" id="kobo.353.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.354.1">nil</span></span><span class="koboSpan" id="kobo.355.1"> {
        fmt.Fprintln(os.Stderr, err)
        os.Exit(</span><span class="hljs-number"><span class="koboSpan" id="kobo.356.1">1</span></span><span class="koboSpan" id="kobo.357.1">)
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.358.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.359.1">http.ListenAndServe()</span></code><span class="koboSpan" id="kobo.360.1"> call begins the HTTP server using the predefined port number. </span><span class="koboSpan" id="kobo.360.2">As there is no hostname given in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.361.1">PORT</span></code><span class="koboSpan" id="kobo.362.1"> string, the web server is going to listen to all available network interfaces. </span><span class="koboSpan" id="kobo.362.2">The port number and the hostname should be separated with a colon (</span><code class="inlineCode"><span class="koboSpan" id="kobo.363.1">:</span></code><span class="koboSpan" id="kobo.364.1">), which should be there even if there is no hostname—in that case, the server listens to all available network interfaces and, therefore, all supported hostnames. </span><span class="koboSpan" id="kobo.364.2">This is the reason that the value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.365.1">PORT</span></code><span class="koboSpan" id="kobo.366.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.367.1">:8001</span></code><span class="koboSpan" id="kobo.368.1"> instead of just </span><code class="inlineCode"><span class="koboSpan" id="kobo.369.1">8001</span></code><span class="koboSpan" id="kobo.370.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.371.1">Part of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.372.1">net/http</span></code><span class="koboSpan" id="kobo.373.1"> package is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.374.1">ServeMux</span></code><span class="koboSpan" id="kobo.375.1"> struct (</span><code class="inlineCode"><span class="koboSpan" id="kobo.376.1">go doc http.ServeMux</span></code><span class="koboSpan" id="kobo.377.1">), which is an HTTP request multiplexer that provides a slightly different way of defining handler functions and endpoints than the default one, which is used in </span><code class="inlineCode"><span class="koboSpan" id="kobo.378.1">wwwServer.go</span></code><span class="koboSpan" id="kobo.379.1">. </span><span class="koboSpan" id="kobo.379.2">So if we do not create and configure our own </span><code class="inlineCode"><span class="koboSpan" id="kobo.380.1">ServeMux</span></code><span class="koboSpan" id="kobo.381.1"> variable, then </span><code class="inlineCode"><span class="koboSpan" id="kobo.382.1">http.HandleFunc()</span></code><span class="koboSpan" id="kobo.383.1"> uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.384.1">DefaultServeMux</span></code><span class="koboSpan" id="kobo.385.1">, which is the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.386.1">ServeMux</span></code><span class="koboSpan" id="kobo.387.1">. </span><span class="koboSpan" id="kobo.387.2">So in this case, we are going to implement the web service using the default Go router—this is the reason that the second parameter of </span><code class="inlineCode"><span class="koboSpan" id="kobo.388.1">http.ListenAndServe()</span></code><span class="koboSpan" id="kobo.389.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.390.1">nil</span></code><span class="koboSpan" id="kobo.391.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.392.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.393.1">wwwServer.go</span></code><span class="koboSpan" id="kobo.394.1"> and interacting</span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.395.1"> with it using </span><code class="inlineCode"><span class="koboSpan" id="kobo.396.1">curl(1)</span></code><span class="koboSpan" id="kobo.397.1"> produces the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.398.1">$ </span></span><span class="koboSpan" id="kobo.399.1">go run wwwServer.go
Using port number:  :8001
Served: localhost:8001
Served time for: localhost:8001
Served: localhost:8001
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.400.1">Note that as </span><code class="inlineCode"><span class="koboSpan" id="kobo.401.1">wwwServer.go</span></code><span class="koboSpan" id="kobo.402.1"> does not terminate automatically, you need to stop it on your own.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.403.1">On the </span><code class="inlineCode"><span class="koboSpan" id="kobo.404.1">curl(1)</span></code><span class="koboSpan" id="kobo.405.1"> side, the interaction looks as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.406.1">$ </span></span><span class="koboSpan" id="kobo.407.1">curl localhost:8001
Serving: /
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.408.1">In this first case, we visit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.409.1">/</span></code><span class="koboSpan" id="kobo.410.1"> path of the web server, and we are served by </span><code class="inlineCode"><span class="koboSpan" id="kobo.411.1">myHandler()</span></code><span class="koboSpan" id="kobo.412.1">.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.413.1">$ </span></span><span class="koboSpan" id="kobo.414.1">curl localhost:8001/time
&lt;h1 align="center"&gt;The current time is:&lt;/h1&gt;&lt;h2 align="center"&gt;Thu, 31 Aug 2023 22:37:37 EEST&lt;/h2&gt;
Serving: /time
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.415.1">In this case, we visit </span><code class="inlineCode"><span class="koboSpan" id="kobo.416.1">/time</span></code><span class="koboSpan" id="kobo.417.1">, and we get HTML output back from </span><code class="inlineCode"><span class="koboSpan" id="kobo.418.1">timeHandler()</span></code><span class="koboSpan" id="kobo.419.1">.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.420.1">$ </span></span><span class="koboSpan" id="kobo.421.1">curl localhost:8001/doesNotExist
Serving: /doesNotExist
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.422.1">In this last case, we visit </span><code class="inlineCode"><span class="koboSpan" id="kobo.423.1">/doesNotExist</span></code><span class="koboSpan" id="kobo.424.1">, which does not exist. </span><span class="koboSpan" id="kobo.424.2">As this cannot be matched by any</span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.425.1"> other path, it is served by the default handler, which is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.426.1">myHandler()</span></code><span class="koboSpan" id="kobo.427.1"> function.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.428.1">The next section is about making the statistics application a web application!</span></p>
<h1 class="heading-1" id="_idParaDest-268"><span class="koboSpan" id="kobo.429.1">Updating the statistics application</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.430.1">This time, the statistics </span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.431.1">application is going to work as a web service. </span><span class="koboSpan" id="kobo.431.2">The two main tasks that need to be performed are defining the API along with the endpoints and implementing the API. </span><span class="koboSpan" id="kobo.431.3">A third task that needs to be determined concerns data exchange between the application server and its clients. </span><span class="koboSpan" id="kobo.431.4">There exist many approaches regarding data exchange between the server and its clients. </span><span class="koboSpan" id="kobo.431.5">We are going to discuss the following four ways:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.432.1">Using plain text</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.433.1">Using HTML</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.434.1">Using JSON</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.435.1">Using a hybrid approach that combines plain text and JSON data</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.436.1">As JSON is explored in </span><em class="chapterRef"><span class="koboSpan" id="kobo.437.1">Chapter 11</span></em><span class="koboSpan" id="kobo.438.1">, </span><em class="italic"><span class="koboSpan" id="kobo.439.1">Working with REST APIs</span></em><span class="koboSpan" id="kobo.440.1">, and HTML might not be the best option for a service because you need to separate the data from the HTML tags and parse the data, we are going to use the first approach. </span><span class="koboSpan" id="kobo.440.2">Therefore, the service is going to work with plain text data. </span><span class="koboSpan" id="kobo.440.3">We begin by defining the API that supports the operation of the statistics application.</span></p>
<h2 class="heading-2" id="_idParaDest-269"><span class="koboSpan" id="kobo.441.1">Defining the API</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.442.1">The API has</span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.443.1"> support</span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.444.1"> for the following URLs:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.445.1">/list</span></code><span class="koboSpan" id="kobo.446.1">: This lists all available entries.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.447.1">/insert/name/d1/d2/d3/.../</span></code><span class="koboSpan" id="kobo.448.1">: This inserts a new dataset. </span><span class="koboSpan" id="kobo.448.2">Later in this chapter, we are going to see how to extract the desired information from a URL that contains user data and parameters. </span><span class="koboSpan" id="kobo.448.3">The key point here is that the number of elements in a dataset varies so the URL is going to contain a variable number of values.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.449.1">/delete/name/</span></code><span class="koboSpan" id="kobo.450.1">: This deletes an entry based on the name of the dataset.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.451.1">/search/name/</span></code><span class="koboSpan" id="kobo.452.1">: This searches for an entry based on the dataset name.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.453.1">/status</span></code><span class="koboSpan" id="kobo.454.1">: This is an extra URL that returns the number of entries in the statistics application.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.455.1">The list of endpoints does not follow standard REST conventions—all these are going to be presented in </span><em class="chapterRef"><span class="koboSpan" id="kobo.456.1">Chapter 11</span></em><span class="koboSpan" id="kobo.457.1">, </span><em class="italic"><span class="koboSpan" id="kobo.458.1">Working with REST APIs</span></em><span class="koboSpan" id="kobo.459.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.460.1">This time, </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.461.1">we are not using the default Go router</span></strong><span class="koboSpan" id="kobo.462.1">, which means that we define and configure our own </span><code class="inlineCode"><span class="koboSpan" id="kobo.463.1">http.NewServeMux()</span></code><span class="koboSpan" id="kobo.464.1"> variable. </span><span class="koboSpan" id="kobo.464.2">This changes the way we provide handler functions: a handler function with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.465.1">func(http.ResponseWriter, *http.Request)</span></code><span class="koboSpan" id="kobo.466.1"> signature has to be converted into an </span><code class="inlineCode"><span class="koboSpan" id="kobo.467.1">http.HandlerFunc</span></code><span class="koboSpan" id="kobo.468.1"> type and used by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.469.1">ServeMux</span></code><span class="koboSpan" id="kobo.470.1"> type and its own </span><code class="inlineCode"><span class="koboSpan" id="kobo.471.1">Handle()</span></code><span class="koboSpan" id="kobo.472.1"> method. </span><span class="koboSpan" id="kobo.472.2">Therefore, when using a different </span><code class="inlineCode"><span class="koboSpan" id="kobo.473.1">ServeMux</span></code><span class="koboSpan" id="kobo.474.1"> than the default one, we should do that conversion explicitly by calling </span><code class="inlineCode"><span class="koboSpan" id="kobo.475.1">http.HandlerFunc()</span></code><span class="koboSpan" id="kobo.476.1">, which makes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.477.1">http.HandlerFunc</span></code><span class="koboSpan" id="kobo.478.1"> type act as an adapter that allows the use of ordinary functions as HTTP handlers, provided that they have the required signature. </span><span class="koboSpan" id="kobo.478.2">This is not a problem when using the default Go router (</span><code class="inlineCode"><span class="koboSpan" id="kobo.479.1">DefaultServeMux</span></code><span class="koboSpan" id="kobo.480.1">) because the </span><code class="inlineCode"><span class="koboSpan" id="kobo.481.1">http.HandleFunc()</span></code><span class="koboSpan" id="kobo.482.1"> function does that conversion automatically and internally. </span><span class="koboSpan" id="kobo.482.2">However, you can also use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.483.1">HandleFunc()</span></code><span class="koboSpan" id="kobo.484.1"> method from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.485.1">ServeMux</span></code><span class="koboSpan" id="kobo.486.1"> type to do the same implicit conversion.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.487.1">To make things clearer, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.488.1">http.HandlerFunc</span></code><span class="koboSpan" id="kobo.489.1"> type has support for a method named </span><code class="inlineCode"><span class="koboSpan" id="kobo.490.1">HandlerFunc()</span></code><span class="koboSpan" id="kobo.491.1">—both the type and method are defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.492.1">http</span></code><span class="koboSpan" id="kobo.493.1"> package. </span><span class="koboSpan" id="kobo.493.2">The similarly named </span><code class="inlineCode"><span class="koboSpan" id="kobo.494.1">http.HandleFunc()</span></code><span class="koboSpan" id="kobo.495.1"> function (without an </span><code class="inlineCode"><span class="koboSpan" id="kobo.496.1">r</span></code><span class="koboSpan" id="kobo.497.1">) is used with the default Go router.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.498.1">As an example, for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.499.1">/time</span></code><span class="koboSpan" id="kobo.500.1"> endpoint and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.501.1">timeHandler()</span></code><span class="koboSpan" id="kobo.502.1"> handler function, you should call </span><code class="inlineCode"><span class="koboSpan" id="kobo.503.1">mux.Handle()</span></code><span class="koboSpan" id="kobo.504.1"> as </span><code class="inlineCode"><span class="koboSpan" id="kobo.505.1">mux.Handle("/time", http.HandlerFunc(timeHandler))</span></code><span class="koboSpan" id="kobo.506.1">. </span><span class="koboSpan" id="kobo.506.2">If you </span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.507.1">were</span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.508.1"> using </span><code class="inlineCode"><span class="koboSpan" id="kobo.509.1">http.HandleFunc()</span></code><span class="koboSpan" id="kobo.510.1"> and, as a consequence, </span><code class="inlineCode"><span class="koboSpan" id="kobo.511.1">DefaultServeMux</span></code><span class="koboSpan" id="kobo.512.1">, then you should have called </span><code class="inlineCode"><span class="koboSpan" id="kobo.513.1">http.HandleFunc("/time", timeHandler)</span></code><span class="koboSpan" id="kobo.514.1"> instead.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.515.1">The subject of the next subsection is the implementation of the HTTP endpoints.</span></p>
<h2 class="heading-2" id="_idParaDest-270"><span class="koboSpan" id="kobo.516.1">Implementing the handlers</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.517.1">The new version</span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.518.1"> of the statistics application is </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.519.1">going to be created inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.520.1">~/go/src</span></code><span class="koboSpan" id="kobo.521.1">: </span><code class="inlineCode"><span class="koboSpan" id="kobo.522.1">~/go/src/github.com/mactsouk/mGo4th/ch09/server</span></code><span class="koboSpan" id="kobo.523.1">. </span><span class="koboSpan" id="kobo.523.2">As expected, you also need to do the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.524.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.525.1">cd</span></span><span class="koboSpan" id="kobo.526.1"> ~/go/src/github.com/mactsouk/mGo4th/ch09/server
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.527.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.528.1">touch</span></span><span class="koboSpan" id="kobo.529.1"> handlers.go
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.530.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.531.1">touch</span></span><span class="koboSpan" id="kobo.532.1"> stats.go
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.533.1">If you use the GitHub repository of the book, you are not going to need to create the server from scratch, as the Go code is already there.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.534.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.535.1">stats.go</span></code><span class="koboSpan" id="kobo.536.1"> file holds the code that defines the operation of the web server. </span><span class="koboSpan" id="kobo.536.2">Usually, handlers are put in a separate external package, but for reasons of simplicity, we have decided to put handlers in a separate file named </span><code class="inlineCode"><span class="koboSpan" id="kobo.537.1">handlers.go</span></code><span class="koboSpan" id="kobo.538.1"> within the same package. </span><span class="koboSpan" id="kobo.538.2">The contents of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.539.1">handlers.go</span></code><span class="koboSpan" id="kobo.540.1"> file, which contains all functionality related to the serving of the clients, are as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.541.1">package</span></span><span class="koboSpan" id="kobo.542.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.543.1">import</span></span><span class="koboSpan" id="kobo.544.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.545.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.546.1">"log"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.547.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.548.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.549.1">strconv"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.550.1">"strings"</span></span><span class="koboSpan" id="kobo.551.1">
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.552.1">All required packages for </span><code class="inlineCode"><span class="koboSpan" id="kobo.553.1">handlers.go</span></code><span class="koboSpan" id="kobo.554.1"> are imported, even if some of them have already been imported </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.555.1">by </span><code class="inlineCode"><span class="koboSpan" id="kobo.556.1">stats.go</span></code><span class="koboSpan" id="kobo.557.1">. </span><span class="koboSpan" id="kobo.557.2">Note that the name of the package is </span><code class="inlineCode"><span class="koboSpan" id="kobo.558.1">main</span></code><span class="koboSpan" id="kobo.559.1">, which is also the case for </span><code class="inlineCode"><span class="koboSpan" id="kobo.560.1">stats.go</span></code><span class="koboSpan" id="kobo.561.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.562.1">const</span></span><span class="koboSpan" id="kobo.563.1"> PORT = </span><span class="hljs-string"><span class="koboSpan" id="kobo.564.1">":1234"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.565.1">This is the default port number that the HTTP server listens to.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.566.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.567.1">defaultHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.568.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.569.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.570.1">"Serving:"</span></span><span class="koboSpan" id="kobo.571.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.572.1">"from"</span></span><span class="koboSpan" id="kobo.573.1">, r.Host)
    w.WriteHeader(http.StatusOK)
    body := </span><span class="hljs-string"><span class="koboSpan" id="kobo.574.1">"Thanks for visiting!\n"</span></span><span class="koboSpan" id="kobo.575.1">
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.576.1">"%s"</span></span><span class="koboSpan" id="kobo.577.1">, body)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.578.1">This is the default handler, which serves all requests that are not a match for any of the other handlers. </span><span class="koboSpan" id="kobo.578.2">Next is the handler for deleting entries:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.579.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.580.1">deleteHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.581.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.582.1"> {
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.583.1">// Get dataset</span></span><span class="koboSpan" id="kobo.584.1">
    paramStr := strings.Split(r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.585.1">"/"</span></span><span class="koboSpan" id="kobo.586.1">)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.587.1">"Path:"</span></span><span class="koboSpan" id="kobo.588.1">, paramStr)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.589.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.590.1">len</span></span><span class="koboSpan" id="kobo.591.1">(paramStr) &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.592.1">3</span></span><span class="koboSpan" id="kobo.593.1"> {
        w.WriteHeader(http.StatusNotFound)
        fmt.Fprintln(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.594.1">"Not found:"</span></span><span class="koboSpan" id="kobo.595.1">, r.URL.Path)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.596.1">return</span></span><span class="koboSpan" id="kobo.597.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.598.1">This is the handler function for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.599.1">/delete</span></code><span class="koboSpan" id="kobo.600.1"> path, which begins by splitting the URL in order to read the desired information. </span><span class="koboSpan" id="kobo.600.2">If we do not have enough parameters, we should send an error message back to the client with the appropriate HTTP code, which in this case is </span><code class="inlineCode"><span class="koboSpan" id="kobo.601.1">http.StatusNotFound</span></code><span class="koboSpan" id="kobo.602.1">. </span><span class="koboSpan" id="kobo.602.2">You can use any HTTP code you want as long as it makes sense. </span><span class="koboSpan" id="kobo.602.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.603.1">WriteHeader()</span></code><span class="koboSpan" id="kobo.604.1"> method sends back a header with the provided status code, before writing the body of the response.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.605.1">    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.606.1">"Serving:"</span></span><span class="koboSpan" id="kobo.607.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.608.1">"from"</span></span><span class="koboSpan" id="kobo.609.1">, r.Host)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.610.1">This is where </span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.611.1">the</span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.612.1"> HTTP server sends data to log files—this mainly happens for debugging reasons.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.613.1">    dataset := paramStr[</span><span class="hljs-number"><span class="koboSpan" id="kobo.614.1">2</span></span><span class="koboSpan" id="kobo.615.1">]
    err := deleteEntry(dataset)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.616.1">if</span></span><span class="koboSpan" id="kobo.617.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.618.1">nil</span></span><span class="koboSpan" id="kobo.619.1"> {
        fmt.Println(err)
        Body := err.Error() + </span><span class="hljs-string"><span class="koboSpan" id="kobo.620.1">"\n"</span></span><span class="koboSpan" id="kobo.621.1">
        w.WriteHeader(http.StatusNotFound)
        fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.622.1">"%s"</span></span><span class="koboSpan" id="kobo.623.1">, Body)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.624.1">return</span></span><span class="koboSpan" id="kobo.625.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.626.1">As the delete process is based on the dataset name, all that is required is a valid dataset name. </span><span class="koboSpan" id="kobo.626.2">This is where the parameter is read after splitting the provided URL. </span><span class="koboSpan" id="kobo.626.3">If the </span><code class="inlineCode"><span class="koboSpan" id="kobo.627.1">deleteEntry()</span></code><span class="koboSpan" id="kobo.628.1"> function returns an error, then we construct a fitting response and send it to the client.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.629.1">    body := dataset + </span><span class="hljs-string"><span class="koboSpan" id="kobo.630.1">" deleted!\n"</span></span><span class="koboSpan" id="kobo.631.1">
    w.WriteHeader(http.StatusOK)
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.632.1">"%s"</span></span><span class="koboSpan" id="kobo.633.1">, body)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.634.1">At this point, we know that the delete operation was successful, so we send a proper message to the client as well as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.635.1">http.StatusOK</span></code><span class="koboSpan" id="kobo.636.1"> status code. </span><span class="koboSpan" id="kobo.636.2">Type </span><code class="inlineCode"><span class="koboSpan" id="kobo.637.1">go doc http.StatusOK</span></code><span class="koboSpan" id="kobo.638.1"> for the list of codes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.639.1">Next up is the implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.640.1">listHandler()</span></code><span class="koboSpan" id="kobo.641.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.642.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.643.1">listHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.644.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.645.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.646.1">"Serving:"</span></span><span class="koboSpan" id="kobo.647.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.648.1">"from"</span></span><span class="koboSpan" id="kobo.649.1">, r.Host)
    w.WriteHeader(http.StatusOK)
    body := list()
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.650.1">"%s"</span></span><span class="koboSpan" id="kobo.651.1">, body)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.652.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.653.1">list()</span></code><span class="koboSpan" id="kobo.654.1"> helper function that is used in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.655.1">/list</span></code><span class="koboSpan" id="kobo.656.1"> path cannot fail. </span><span class="koboSpan" id="kobo.656.2">Therefore, </span><code class="inlineCode"><span class="koboSpan" id="kobo.657.1">http.StatusOK</span></code><span class="koboSpan" id="kobo.658.1"> is always returned when serving </span><code class="inlineCode"><span class="koboSpan" id="kobo.659.1">/list</span></code><span class="koboSpan" id="kobo.660.1">. </span><span class="koboSpan" id="kobo.660.2">However, sometimes the return value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.661.1">list()</span></code><span class="koboSpan" id="kobo.662.1"> can be the empty string.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.663.1">Next, we implement </span><code class="inlineCode"><span class="koboSpan" id="kobo.664.1">statusHandler()</span></code><span class="koboSpan" id="kobo.665.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.666.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.667.1">statusHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.668.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.669.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.670.1">"Serving:"</span></span><span class="koboSpan" id="kobo.671.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.672.1">"from"</span></span><span class="koboSpan" id="kobo.673.1">, r.Host)
    w.WriteHeader(http.StatusOK)
    body := fmt.Sprintf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.674.1">"Total entries: %d\n"</span></span><span class="koboSpan" id="kobo.675.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.676.1">len</span></span><span class="koboSpan" id="kobo.677.1">(data))
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.678.1">"%s"</span></span><span class="koboSpan" id="kobo.679.1">, body)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.680.1">The preceding </span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.681.1">code </span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.682.1">defines the handler function for </span><code class="inlineCode"><span class="koboSpan" id="kobo.683.1">/status</span></code><span class="koboSpan" id="kobo.684.1">. </span><span class="koboSpan" id="kobo.684.2">It just returns information about the total number of entries found in the statistics application. </span><span class="koboSpan" id="kobo.684.3">It can be used to verify that the web service works fine.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.685.1">Next, we present the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.686.1">insertHandler()</span></code><span class="koboSpan" id="kobo.687.1"> handler:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.688.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.689.1">insertHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.690.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.691.1"> {
    paramStr := strings.Split(r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.692.1">"/"</span></span><span class="koboSpan" id="kobo.693.1">)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.694.1">"Path:"</span></span><span class="koboSpan" id="kobo.695.1">, paramStr)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.696.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.697.1">len</span></span><span class="koboSpan" id="kobo.698.1">(paramStr) &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.699.1">4</span></span><span class="koboSpan" id="kobo.700.1"> {
        w.WriteHeader(http.StatusBadRequest)
        fmt.Fprintln(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.701.1">"Not enough arguments: "</span></span><span class="koboSpan" id="kobo.702.1">+r.URL.Path)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.703.1">return</span></span><span class="koboSpan" id="kobo.704.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.705.1">As before, we need to split the given URL in order to extract the information. </span><span class="koboSpan" id="kobo.705.2">In this case, we need at least four elements, as we are trying to insert a new dataset into the statistics service.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.706.1">    dataset := paramStr[</span><span class="hljs-number"><span class="koboSpan" id="kobo.707.1">2</span></span><span class="koboSpan" id="kobo.708.1">]
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.709.1">// These are string values</span></span><span class="koboSpan" id="kobo.710.1">
    dataStr := paramStr[</span><span class="hljs-number"><span class="koboSpan" id="kobo.711.1">3</span></span><span class="koboSpan" id="kobo.712.1">:]
    data := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.713.1">make</span></span><span class="koboSpan" id="kobo.714.1">([]</span><span class="hljs-type"><span class="koboSpan" id="kobo.715.1">float64</span></span><span class="koboSpan" id="kobo.716.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.717.1">0</span></span><span class="koboSpan" id="kobo.718.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.719.1">for</span></span><span class="koboSpan" id="kobo.720.1"> _, v := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.721.1">range</span></span><span class="koboSpan" id="kobo.722.1"> dataStr {
        val, err := strconv.ParseFloat(v, </span><span class="hljs-number"><span class="koboSpan" id="kobo.723.1">64</span></span><span class="koboSpan" id="kobo.724.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.725.1">if</span></span><span class="koboSpan" id="kobo.726.1"> err == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.727.1">nil</span></span><span class="koboSpan" id="kobo.728.1"> {
            data = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.729.1">append</span></span><span class="koboSpan" id="kobo.730.1">(data, val)
        }
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.731.1">In the previous code, we initialize the </span><code class="inlineCode"><span class="koboSpan" id="kobo.732.1">dataset</span></code><span class="koboSpan" id="kobo.733.1"> variable and read the data elements, which have a variable length. </span><span class="koboSpan" id="kobo.733.2">In this case, we also need to convert the data elements into </span><code class="inlineCode"><span class="koboSpan" id="kobo.734.1">float64</span></code><span class="koboSpan" id="kobo.735.1"> values</span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.736.1"> because they are read as</span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.737.1"> text.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.738.1">    entry := process(dataset, data)
    err := insert(&amp;entry)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.739.1">if</span></span><span class="koboSpan" id="kobo.740.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.741.1">nil</span></span><span class="koboSpan" id="kobo.742.1"> {
        w.WriteHeader(http.StatusNotModified)
        Body := </span><span class="hljs-string"><span class="koboSpan" id="kobo.743.1">"Failed to add record\n"</span></span><span class="koboSpan" id="kobo.744.1">
        fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.745.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.746.1">%s"</span></span><span class="koboSpan" id="kobo.747.1">, Body)
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.748.1">else</span></span><span class="koboSpan" id="kobo.749.1"> {
        Body := </span><span class="hljs-string"><span class="koboSpan" id="kobo.750.1">"New record added successfully\n"</span></span><span class="koboSpan" id="kobo.751.1">
        w.WriteHeader(http.StatusOK)
        fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.752.1">"%s"</span></span><span class="koboSpan" id="kobo.753.1">, Body)
    }
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.754.1">"Serving:"</span></span><span class="koboSpan" id="kobo.755.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.756.1">"from"</span></span><span class="koboSpan" id="kobo.757.1">, r.Host)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.758.1">This is the end of the handler for </span><code class="inlineCode"><span class="koboSpan" id="kobo.759.1">/insert</span></code><span class="koboSpan" id="kobo.760.1">. </span><span class="koboSpan" id="kobo.760.2">The last part of the implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.761.1">insertHandler()</span></code><span class="koboSpan" id="kobo.762.1"> deals with the return value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.763.1">insert()</span></code><span class="koboSpan" id="kobo.764.1">. </span><span class="koboSpan" id="kobo.764.2">If there was not an error, then </span><code class="inlineCode"><span class="koboSpan" id="kobo.765.1">http.StatusOK</span></code><span class="koboSpan" id="kobo.766.1"> is sent to the client. </span><span class="koboSpan" id="kobo.766.2">In the opposite case, </span><code class="inlineCode"><span class="koboSpan" id="kobo.767.1">http.StatusNotModified</span></code><span class="koboSpan" id="kobo.768.1"> is returned to signify that there was not a change in the statistics application. </span><span class="koboSpan" id="kobo.768.2">It is the job of the client to examine the status code of the interaction, but it is the job of the server to send an appropriate status code back to the client.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.769.1">Next, we implement </span><code class="inlineCode"><span class="koboSpan" id="kobo.770.1">searchHandler()</span></code><span class="koboSpan" id="kobo.771.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.772.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.773.1">searchHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.774.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.775.1"> {
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.776.1">// Get Search value from URL</span></span><span class="koboSpan" id="kobo.777.1">
    paramStr := strings.Split(r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.778.1">"/"</span></span><span class="koboSpan" id="kobo.779.1">)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.780.1">"Path:"</span></span><span class="koboSpan" id="kobo.781.1">, paramStr)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.782.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.783.1">len</span></span><span class="koboSpan" id="kobo.784.1">(paramStr) &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.785.1">3</span></span><span class="koboSpan" id="kobo.786.1"> {
        w.WriteHeader(http.StatusNotFound)
        fmt.Fprintln(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.787.1">"Not found: "</span></span><span class="koboSpan" id="kobo.788.1">+r.URL.Path)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.789.1">return</span></span><span class="koboSpan" id="kobo.790.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.791.1">var</span></span><span class="koboSpan" id="kobo.792.1"> body </span><span class="hljs-type"><span class="koboSpan" id="kobo.793.1">string</span></span><span class="koboSpan" id="kobo.794.1">
    dataset := paramStr[</span><span class="hljs-number"><span class="koboSpan" id="kobo.795.1">2</span></span><span class="koboSpan" id="kobo.796.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.797.1">At this point, we extract</span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.798.1"> the </span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.799.1">dataset name from the URL, as we did with </span><code class="inlineCode"><span class="koboSpan" id="kobo.800.1">/delete</span></code><span class="koboSpan" id="kobo.801.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.802.1">    t := search(dataset)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.803.1">if</span></span><span class="koboSpan" id="kobo.804.1"> t == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.805.1">nil</span></span><span class="koboSpan" id="kobo.806.1"> {
        w.WriteHeader(http.StatusNotFound)
        body = </span><span class="hljs-string"><span class="koboSpan" id="kobo.807.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.808.1">Could not be found: "</span></span><span class="koboSpan" id="kobo.809.1"> + dataset + </span><span class="hljs-string"><span class="koboSpan" id="kobo.810.1">"\n"</span></span><span class="koboSpan" id="kobo.811.1">
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.812.1">else</span></span><span class="koboSpan" id="kobo.813.1"> {
        w.WriteHeader(http.StatusOK)
        body = fmt.Sprintf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.814.1">"%s %d %f %f\n"</span></span><span class="koboSpan" id="kobo.815.1">, t.Name, t.Len, t.Mean, t.StdDev)
    }
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.816.1">"Serving:"</span></span><span class="koboSpan" id="kobo.817.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.818.1">"from"</span></span><span class="koboSpan" id="kobo.819.1">, r.Host)
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.820.1">"%s"</span></span><span class="koboSpan" id="kobo.821.1">, body)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.822.1">The last function of </span><code class="inlineCode"><span class="koboSpan" id="kobo.823.1">handlers.go</span></code><span class="koboSpan" id="kobo.824.1"> ends here and is about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.825.1">/search</span></code><span class="koboSpan" id="kobo.826.1"> endpoint. </span><span class="koboSpan" id="kobo.826.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.827.1">search()</span></code><span class="koboSpan" id="kobo.828.1"> helper function checks whether the given input exists in the data records or not and acts accordingly.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.829.1">Additionally, the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.830.1">main()</span></code><span class="koboSpan" id="kobo.831.1"> function, which can be found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.832.1">stats.go</span></code><span class="koboSpan" id="kobo.833.1">, is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.834.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.835.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.836.1">()</span></span><span class="koboSpan" id="kobo.837.1"> {
    err := readJSONFile(JSONFILE)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.838.1">if</span></span><span class="koboSpan" id="kobo.839.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.840.1">nil</span></span><span class="koboSpan" id="kobo.841.1"> &amp;&amp; err != io.EOF {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.842.1">"Error:"</span></span><span class="koboSpan" id="kobo.843.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.844.1">return</span></span><span class="koboSpan" id="kobo.845.1">
    }
    createIndex()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.846.1">This first part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.847.1">main()</span></code><span class="koboSpan" id="kobo.848.1"> relates to the proper initialization of the statistics application. </span><span class="koboSpan" id="kobo.848.2">Internally, data is stored in the JSON format.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.849.1">    mux := http.NewServeMux()
    s := &amp;http.Server{
        Addr:         PORT,
        Handler:      mux,
        IdleTimeout:  </span><span class="hljs-number"><span class="koboSpan" id="kobo.850.1">10</span></span><span class="koboSpan" id="kobo.851.1"> * time.Second,
        ReadTimeout:  time.Second,
        WriteTimeout: time.Second,
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.852.1">Here, we store the </span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.853.1">parameters of the HTTP server in</span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.854.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.855.1">http.Server</span></code><span class="koboSpan" id="kobo.856.1"> structure and use our own </span><code class="inlineCode"><span class="koboSpan" id="kobo.857.1">http.NewServeMux()</span></code><span class="koboSpan" id="kobo.858.1"> instead of the default one.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.859.1">    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.860.1">"/list"</span></span><span class="koboSpan" id="kobo.861.1">, http.HandlerFunc(listHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.862.1">"/insert/"</span></span><span class="koboSpan" id="kobo.863.1">, http.HandlerFunc(insertHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.864.1">"/insert"</span></span><span class="koboSpan" id="kobo.865.1">, http.HandlerFunc(insertHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.866.1">"/search"</span></span><span class="koboSpan" id="kobo.867.1">, http.HandlerFunc(searchHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.868.1">"/search/"</span></span><span class="koboSpan" id="kobo.869.1">, http.HandlerFunc(searchHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.870.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.871.1">/delete/"</span></span><span class="koboSpan" id="kobo.872.1">, http.HandlerFunc(deleteHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.873.1">"/status"</span></span><span class="koboSpan" id="kobo.874.1">, http.HandlerFunc(statusHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.875.1">"/"</span></span><span class="koboSpan" id="kobo.876.1">, http.HandlerFunc(defaultHandler))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.877.1">This is the list of the supported URLs. </span><span class="koboSpan" id="kobo.877.2">Note that </span><code class="inlineCode"><span class="koboSpan" id="kobo.878.1">/search</span></code><span class="koboSpan" id="kobo.879.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.880.1">/search/</span></code><span class="koboSpan" id="kobo.881.1"> are both handled by the same handler function even though </span><code class="inlineCode"><span class="koboSpan" id="kobo.882.1">/search</span></code><span class="koboSpan" id="kobo.883.1"> is going to fail, as it does not include the required data. </span><span class="koboSpan" id="kobo.883.2">On the other hand, </span><code class="inlineCode"><span class="koboSpan" id="kobo.884.1">/delete/</span></code><span class="koboSpan" id="kobo.885.1"> is handled differently—this will be apparent when testing the application. </span><span class="koboSpan" id="kobo.885.2">As we are using </span><code class="inlineCode"><span class="koboSpan" id="kobo.886.1">http.NewServeMux()</span></code><span class="koboSpan" id="kobo.887.1"> and not the default Go router, we need to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.888.1">http.HandlerFunc()</span></code><span class="koboSpan" id="kobo.889.1"> when defining the handler functions.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.890.1">    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.891.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.892.1">Ready to serve at"</span></span><span class="koboSpan" id="kobo.893.1">, PORT)
    err = s.ListenAndServe()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.894.1">if</span></span><span class="koboSpan" id="kobo.895.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.896.1">nil</span></span><span class="koboSpan" id="kobo.897.1"> {
        fmt.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.898.1">return</span></span><span class="koboSpan" id="kobo.899.1">
    }
}
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.900.1">As mentioned earlier in this chapter, each </span><code class="inlineCode"><span class="koboSpan" id="kobo.901.1">mux.Handle()</span></code><span class="koboSpan" id="kobo.902.1"> call can be replaced by an equivalent </span><code class="inlineCode"><span class="koboSpan" id="kobo.903.1">mux.HandleFunc()</span></code><span class="koboSpan" id="kobo.904.1"> call. </span><span class="koboSpan" id="kobo.904.2">So </span><code class="inlineCode"><span class="koboSpan" id="kobo.905.1">mux.Handle("/list", http.HandlerFunc(listHandler))</span></code><span class="koboSpan" id="kobo.906.1"> is going to become </span><code class="inlineCode"><span class="koboSpan" id="kobo.907.1">mux.HandleFunc("/list", listHandler)</span></code><span class="koboSpan" id="kobo.908.1">. </span><span class="koboSpan" id="kobo.908.2">The same applies to all the other </span><code class="inlineCode"><span class="koboSpan" id="kobo.909.1">mux.Handle()</span></code><span class="koboSpan" id="kobo.910.1"> calls.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.911.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.912.1">ListenAndServe()</span></code><span class="koboSpan" id="kobo.913.1"> method starts the HTTP server using the parameters defined previously in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.914.1">http.Server</span></code><span class="koboSpan" id="kobo.915.1"> structure. </span><span class="koboSpan" id="kobo.915.2">The rest of </span><code class="inlineCode"><span class="koboSpan" id="kobo.916.1">stats.go</span></code><span class="koboSpan" id="kobo.917.1"> contains helper functions related to the operation of the web service. </span><span class="koboSpan" id="kobo.917.2">Note that it is important to save and update the contents of the application as often as possible because this is a live application, and you might lose data if it crashes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.918.1">The next </span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.919.1">command </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.920.1">allows you to execute the application—you need to provide both files in </span><code class="inlineCode"><span class="koboSpan" id="kobo.921.1">go run</span></code><span class="koboSpan" id="kobo.922.1">:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.923.1">$ </span></span><span class="koboSpan" id="kobo.924.1">go run stats.go handlers.go
Ready to serve at :1234
2023/08/31 17:10:10 Serving: /list from localhost:1234
Path: [ delete d1]
2023/08/31 17:10:20 Serving: /delete/d1 from localhost:1234
Path: [ delete d2]
2023/08/31 17:10:22 Serving: /delete/d2 from localhost:1234
Path: [ delete d1]
2023/08/31 17:10:23 Serving: /delete/d1 from localhost:1234
d1 cannot be found!
</span><span class="koboSpan" id="kobo.924.2">2023/08/31 17:11:01 Serving: /status from localhost:1234
Path: [ search d3]
2023/08/31 17:11:26 Serving: /search/d3 from localhost:1234
Path: [ search d2]
2023/08/31 17:11:29 Serving: /search/d2 from localhost:1234
Path: [ search d5]
2023/08/31 17:11:30 Serving: /search/d5 from localhost:1234
Path: [ search d4]
2023/08/31 17:11:32 Serving: /search/d4 from localhost:1234
Path: [ insert v1 1.0 2 3 4 5 ]
2023/08/31 17:16:23 Serving: /insert/v1/1.0/2/3/4/5/ from localhost:1234
Path: [ insert v1 1.0 2 3 4 5 ]
2023/08/31 17:16:34 Serving: /insert/v1/1.0/2/3/4/5/ from localhost:1234
Path: [ insert v2 1.0 2 3 4 5 -5 -3 ]
2023/08/31 17:17:21 Serving: /insert/v2/1.0/2/3/4/5/-5/-3/ from localhost:1234
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.925.1">On the client side, which is </span><code class="inlineCode"><span class="koboSpan" id="kobo.926.1">curl(1)</span></code><span class="koboSpan" id="kobo.927.1">, we have the following interactions:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.928.1">$ </span></span><span class="koboSpan" id="kobo.929.1">curl localhost:1234/list
d6    4    2.325000    1.080220
d4    5    2.860000    1.441666
d1    6    2.216667    1.949715
d2    9    1.000000    0.000000
d0    12    0.333333    0.942809
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.930.1">Here, we get all entries from the statistics application by visiting </span><code class="inlineCode"><span class="koboSpan" id="kobo.931.1">/list</span></code><span class="koboSpan" id="kobo.932.1">:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.933.1">$ </span></span><span class="koboSpan" id="kobo.934.1">curl localhost:1234/delete/d1
d1 deleted!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.935.1">The previous</span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.936.1"> command is going to work if </span><code class="inlineCode"><span class="koboSpan" id="kobo.937.1">d1</span></code><span class="koboSpan" id="kobo.938.1"> is in the</span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.939.1"> list of existing datasets. </span><span class="koboSpan" id="kobo.939.2">If your list is empty or </span><code class="inlineCode"><span class="koboSpan" id="kobo.940.1">d1</span></code><span class="koboSpan" id="kobo.941.1"> does not exist, you should include it before deleting it.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.942.1">$ </span></span><span class="koboSpan" id="kobo.943.1">curl localhost:1234/delete/d2
d2 deleted!
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.944.1">$ </span></span><span class="koboSpan" id="kobo.945.1">curl localhost:1234/delete/d1
d1 cannot be found!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.946.1">In the previous part, we tried to delete the </span><code class="inlineCode"><span class="koboSpan" id="kobo.947.1">d1</span></code><span class="koboSpan" id="kobo.948.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.949.1">d2</span></code><span class="koboSpan" id="kobo.950.1"> datasets. </span><span class="koboSpan" id="kobo.950.2">Trying to delete </span><code class="inlineCode"><span class="koboSpan" id="kobo.951.1">d1</span></code><span class="koboSpan" id="kobo.952.1"> again fails.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.953.1">$ </span></span><span class="koboSpan" id="kobo.954.1">curl localhost:1234/status
Total entries: 3
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.955.1">Next, we visit </span><code class="inlineCode"><span class="koboSpan" id="kobo.956.1">/status</span></code><span class="koboSpan" id="kobo.957.1"> and get back the expected output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.958.1">$ </span></span><span class="koboSpan" id="kobo.959.1">curl localhost:1234/search/d3
Could not be found: d3
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.960.1">$ </span></span><span class="koboSpan" id="kobo.961.1">curl localhost:1234/search/d4
d4 5 2.860000 1.44166
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.962.1">First, we search for </span><code class="inlineCode"><span class="koboSpan" id="kobo.963.1">d3</span></code><span class="koboSpan" id="kobo.964.1">, which does not exist, and then for </span><code class="inlineCode"><span class="koboSpan" id="kobo.965.1">d4</span></code><span class="koboSpan" id="kobo.966.1">, which exists. </span><span class="koboSpan" id="kobo.966.2">In the latter case, the web service returns the data of </span><code class="inlineCode"><span class="koboSpan" id="kobo.967.1">d4</span></code><span class="koboSpan" id="kobo.968.1">. </span><span class="koboSpan" id="kobo.968.2">Now, let us try and visit </span><code class="inlineCode"><span class="koboSpan" id="kobo.969.1">/delete</span></code><span class="koboSpan" id="kobo.970.1"> instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.971.1">/delete/</span></code><span class="koboSpan" id="kobo.972.1">:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.973.1">$ </span></span><span class="koboSpan" id="kobo.974.1">curl localhost:1234/delete
&lt;a href="/delete/"&gt;Moved Permanently&lt;/a&gt;.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.975.1">The presented message was generated by the Go router and tells us that we should try </span><code class="inlineCode"><span class="koboSpan" id="kobo.976.1">/delete/</span></code><span class="koboSpan" id="kobo.977.1"> instead because </span><code class="inlineCode"><span class="koboSpan" id="kobo.978.1">/delete</span></code><span class="koboSpan" id="kobo.979.1"> was moved permanently. </span><span class="koboSpan" id="kobo.979.2">This is the kind of message that we get by not specifically defining both </span><code class="inlineCode"><span class="koboSpan" id="kobo.980.1">/delete</span></code><span class="koboSpan" id="kobo.981.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.982.1">/delete/</span></code><span class="koboSpan" id="kobo.983.1"> in the routes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.984.1">Now, let us insert two datasets:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.985.1">$ </span></span><span class="koboSpan" id="kobo.986.1">curl localhost:1234/insert/v1/1.0/2/3/4/5/
New record added successfully
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.987.1">$ </span></span><span class="koboSpan" id="kobo.988.1">curl localhost:1234/insert/v2/1.0/2/3/4/5/-5/-3/
New record added successfully
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.989.1">The previous commands are going to work if both </span><code class="inlineCode"><span class="koboSpan" id="kobo.990.1">v1</span></code><span class="koboSpan" id="kobo.991.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.992.1">v2</span></code><span class="koboSpan" id="kobo.993.1"> do not already exist. </span><span class="koboSpan" id="kobo.993.2">If we try to insert a dataset with a name that already exists, we get no response back other than </span><code class="inlineCode"><span class="koboSpan" id="kobo.994.1">304 – Not Modified</span></code><span class="koboSpan" id="kobo.995.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.996.1">Everything looks like it is working OK. </span><span class="koboSpan" id="kobo.996.2">We can now put the statistics web service online and interact with it using multiple HTTP requests, as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.997.1">http</span></code><span class="koboSpan" id="kobo.998.1"> package uses multiple goroutines to interact with clients—in practice, this means that the statistics application runs concurrently! </span><span class="koboSpan" id="kobo.998.2">However, in its current version, there is no protection against data races, which might take place if we try to insert the same dataset more than once at the exact same time.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.999.1">Later in this </span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.1000.1">chapter, we</span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.1001.1"> are going to create a command line client for the statistics server. </span><span class="koboSpan" id="kobo.1001.2">Additionally, </span><em class="chapterRef"><span class="koboSpan" id="kobo.1002.1">Chapter 12</span></em><span class="koboSpan" id="kobo.1003.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1004.1">Code Testing and Profiling</span></em><span class="koboSpan" id="kobo.1005.1">, shows how to test your code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1006.1">The next section shows how to build Docker images for server applications.</span></p>
<h2 class="heading-2" id="_idParaDest-271"><span class="koboSpan" id="kobo.1007.1">Creating a Docker image</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1008.1">This section shows </span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.1009.1">how to convert a Go application into</span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.1010.1"> a Docker image—the kind of application we are going to use is an HTTP server that interacts with the outer world. </span><span class="koboSpan" id="kobo.1010.2">In our case, it is going to be the statistical web service that we have just developed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1011.1">The contents of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1012.1">buildDocker</span></code><span class="koboSpan" id="kobo.1013.1">, which contains the steps to create a Docker image, are as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1014.1">FROM</span></span><span class="koboSpan" id="kobo.1015.1"> golang:alpine AS builder
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1016.1"># Install git.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1017.1"># Git is required for fetching the dependencies.</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1018.1">RUN</span></span><span class="koboSpan" id="kobo.1019.1"> apk update &amp;&amp; apk add --no-cache git
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1020.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1021.1">mkdir</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.1022.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1023.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1024.1">ADD</span></span><span class="koboSpan" id="kobo.1025.1"> ./stats.go </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1026.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1027.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1028.1">ADD</span></span><span class="koboSpan" id="kobo.1029.1"> ./handlers.go </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1030.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1031.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1032.1">WORKDIR</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.1033.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1034.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1035.1">RUN</span></span><span class="koboSpan" id="kobo.1036.1"> go mod init
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1037.1">RUN</span></span><span class="koboSpan" id="kobo.1038.1"> go mod tidy
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1039.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1040.1">mkdir</span></span><span class="koboSpan" id="kobo.1041.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1042.1">RUN</span></span><span class="koboSpan" id="kobo.1043.1"> go build -o /pro/server stats.go handlers.go
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1044.1">FROM</span></span><span class="koboSpan" id="kobo.1045.1"> alpine:latest
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1046.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1047.1">mkdir</span></span><span class="koboSpan" id="kobo.1048.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1049.1">COPY</span></span><span class="koboSpan" id="kobo.1050.1"> --from=builder /pro/server /pro/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1051.1">EXPOSE</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.1052.1">1234</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1053.1">WORKDIR</span></span><span class="koboSpan" id="kobo.1054.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1055.1">CMD</span></span><span class="koboSpan" id="kobo.1056.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.1057.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1058.1">/pro/server"</span></span><span class="koboSpan" id="kobo.1059.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1060.1">After that, we can</span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.1061.1"> use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1062.1">buildDocker</span></code><span class="koboSpan" id="kobo.1063.1"> file to build a Docker image, named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1064.1">goapp</span></code><span class="koboSpan" id="kobo.1065.1">, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1066.1">$ </span></span><span class="koboSpan" id="kobo.1067.1">docker build -f buildDocker -t goapp .
</span><span class="koboSpan" id="kobo.1067.2">. </span><span class="koboSpan" id="kobo.1067.3">. </span><span class="koboSpan" id="kobo.1067.4">.
</span><span class="koboSpan" id="kobo.1067.5">Successfully built 56d0b84b0ab5
Successfully tagged goapp:latest
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1068.1">The contents of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1069.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1070.1">, which allows us to use a Docker image, are as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1071.1">version:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1072.1">"3"</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1073.1">services:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1074.1">goapp:</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1075.1">image:</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1076.1">goapp</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1077.1">container_name:</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1078.1">goapp</span></strong></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1079.1">restart:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1080.1">always</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1081.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.1082.1">-</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.1083.1">1234</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1084.1">:1234</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1085.1">networks:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.1086.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1087.1">services</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1088.1">networks:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1089.1">services:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1090.1">driver:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1091.1">bridge</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1092.1">What is important in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1093.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1094.1"> file is to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1095.1">goapp</span></code><span class="koboSpan" id="kobo.1096.1"> image name that was created in the previous step.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1097.1">Having the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1098.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1099.1"> at hand, we can use it as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1100.1">$ </span></span><span class="koboSpan" id="kobo.1101.1">docker-compose up
[+] Running 2/0
  Network server_services  Created  0.0s
  Container goapp          Created  0.0s
Attaching to goapp
goapp  | Ready to serve at :1234
goapp  | 2023/08/31 13:32:54 Serving: /status from think:1234
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1102.1">After that, we are free to interact with the web service using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1103.1">curl(1)</span></code><span class="koboSpan" id="kobo.1104.1"> or any other similar tool. </span><span class="koboSpan" id="kobo.1104.2">When done, we can use </span><em class="keystroke"><span class="koboSpan" id="kobo.1105.1">Ctrl</span></em><span class="koboSpan" id="kobo.1106.1"> + </span><em class="keystroke"><span class="koboSpan" id="kobo.1107.1">C</span></em><span class="koboSpan" id="kobo.1108.1"> to stop the Docker image from running.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1109.1">The main disadvantage of this particular web service is that once you disable the Docker image, all data is lost—the solution to this problem is simple. </span><span class="koboSpan" id="kobo.1109.2">You can either store the data in an external database or link the internal Docker data file to a file in the local filesystem. </span><span class="koboSpan" id="kobo.1109.3">Implementing either of these two solutions is beyond the scope of this chapter.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1110.1">After</span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.1111.1"> learning </span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.1112.1">about HTTP servers, the next section shows how to develop HTTP clients.</span></p>
<h1 class="heading-1" id="_idParaDest-272"><span class="koboSpan" id="kobo.1113.1">Developing web clients</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1114.1">This section shows</span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.1115.1"> how to develop HTTP clients, starting with a simplistic version and continuing with a more advanced one. </span><span class="koboSpan" id="kobo.1115.2">In this simplistic version, all of the work is done by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1116.1">http.Get()</span></code><span class="koboSpan" id="kobo.1117.1"> call, which is pretty convenient when you do not want to deal with lots of options and parameters. </span><span class="koboSpan" id="kobo.1117.2">However, this type of call gives you no flexibility over the process. </span><span class="koboSpan" id="kobo.1117.3">Notice that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1118.1">http.Get()</span></code><span class="koboSpan" id="kobo.1119.1"> returns an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1120.1">http.Response</span></code><span class="koboSpan" id="kobo.1121.1"> value. </span><span class="koboSpan" id="kobo.1121.2">All this is illustrated in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1122.1">simpleClient.go</span></code><span class="koboSpan" id="kobo.1123.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1124.1">package</span></span><span class="koboSpan" id="kobo.1125.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1126.1">import</span></span><span class="koboSpan" id="kobo.1127.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1128.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1129.1">"io"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1130.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1131.1">"os"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1132.1">"path/filepath"</span></span><span class="koboSpan" id="kobo.1133.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1134.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1135.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1136.1">()</span></span><span class="koboSpan" id="kobo.1137.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1138.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1139.1">len</span></span><span class="koboSpan" id="kobo.1140.1">(os.Args) != </span><span class="hljs-number"><span class="koboSpan" id="kobo.1141.1">2</span></span><span class="koboSpan" id="kobo.1142.1"> {
        fmt.Printf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1143.1">"Usage: %s URL\n"</span></span><span class="koboSpan" id="kobo.1144.1">, filepath.Base(os.Args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1145.1">0</span></span><span class="koboSpan" id="kobo.1146.1">]))
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1147.1">return</span></span><span class="koboSpan" id="kobo.1148.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1149.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1150.1">filepath.Base()</span></code><span class="koboSpan" id="kobo.1151.1"> function returns the last element of a path. </span><span class="koboSpan" id="kobo.1151.2">When given </span><code class="inlineCode"><span class="koboSpan" id="kobo.1152.1">os.Args[0]</span></code><span class="koboSpan" id="kobo.1153.1"> as its parameter, it returns the name of the executable binary file.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1154.1">    URL := os.Args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1155.1">1</span></span><span class="koboSpan" id="kobo.1156.1">]
    data, err := http.Get(URL)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1157.1">In the previous two statements, we get the URL and its data using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1158.1">http.Get()</span></code><span class="koboSpan" id="kobo.1159.1">, which returns an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1160.1">*http.Response</span></code><span class="koboSpan" id="kobo.1161.1"> and an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1162.1">error</span></code><span class="koboSpan" id="kobo.1163.1"> variable. </span><span class="koboSpan" id="kobo.1163.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1164.1">*http.Response</span></code><span class="koboSpan" id="kobo.1165.1"> value contains all the information, so you do not need to make any additional calls to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1166.1">http.Get()</span></code><span class="koboSpan" id="kobo.1167.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1168.1">if</span></span><span class="koboSpan" id="kobo.1169.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1170.1">nil</span></span><span class="koboSpan" id="kobo.1171.1"> {
        fmt.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1172.1">return</span></span><span class="koboSpan" id="kobo.1173.1">
    }
    _, err = io.Copy(os.Stdout, data.Body)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1174.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1175.1">io.Copy()</span></code><span class="koboSpan" id="kobo.1176.1"> function reads from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1177.1">data.Body</span></code><span class="koboSpan" id="kobo.1178.1"> reader, which contains the body of the server response, and writes the data to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1179.1">os.Stdout</span></code><span class="koboSpan" id="kobo.1180.1">. </span><span class="koboSpan" id="kobo.1180.2">As </span><code class="inlineCode"><span class="koboSpan" id="kobo.1181.1">os.Stdout</span></code><span class="koboSpan" id="kobo.1182.1"> is always open, you do not need to open it for writing. </span><span class="koboSpan" id="kobo.1182.2">Therefore, all data is written to standard output, which is usually the terminal window:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1183.1">if</span></span><span class="koboSpan" id="kobo.1184.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1185.1">nil</span></span><span class="koboSpan" id="kobo.1186.1"> {
        fmt.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1187.1">return</span></span><span class="koboSpan" id="kobo.1188.1">
    }
    data.Body.Close()
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1189.1">Last, we close the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1190.1">data.Body</span></code><span class="koboSpan" id="kobo.1191.1"> reader to make the work of garbage collection easier.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1192.1">Working with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1193.1">simpleClient.go</span></code><span class="koboSpan" id="kobo.1194.1"> produces the following kind of output, which in this case is abbreviated:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1195.1">$ </span></span><span class="koboSpan" id="kobo.1196.1">go run simpleClient.go https://www.golang.org
&lt;!DOCTYPE html&gt;
&lt;html lang="en" data-theme="auto"&gt;
&lt;head&gt;
&lt;link rel="preconnect" href="https://www.googletagmanager.com"&gt;
...
</span><span class="koboSpan" id="kobo.1196.2">&lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1197.1">Although </span><code class="inlineCode"><span class="koboSpan" id="kobo.1198.1">simpleClient.go</span></code><span class="koboSpan" id="kobo.1199.1"> does the job of verifying that the given URL exists and is reachable, it offers</span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.1200.1"> no control over the process. </span><span class="koboSpan" id="kobo.1200.2">The next subsection develops an advanced HTTP client that processes the server response.</span></p>
<h2 class="heading-2" id="_idParaDest-273"><span class="koboSpan" id="kobo.1201.1">Using http.NewRequest() to improve the client</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1202.1">As the web client </span><a id="_idIndexMarker792"/><span class="koboSpan" id="kobo.1203.1">of the previous section is </span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.1204.1">relatively simplistic and does not give you any flexibility, in this subsection, you will learn how to read a URL without using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1205.1">http.Get()</span></code><span class="koboSpan" id="kobo.1206.1"> function and by having more options. </span><span class="koboSpan" id="kobo.1206.2">However, the extra flexibility comes at a cost, as you must write more code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1207.1">The code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1208.1">wwwClient.go</span></code><span class="koboSpan" id="kobo.1209.1"> is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1210.1">package</span></span><span class="koboSpan" id="kobo.1211.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1212.1">import</span></span><span class="koboSpan" id="kobo.1213.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1214.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1215.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1216.1">"net/http/httputil"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1217.1">"net/url"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1218.1">"os"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1219.1">"path/filepath"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1220.1">"strings"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1221.1">"time"</span></span><span class="koboSpan" id="kobo.1222.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1223.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1224.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1225.1">()</span></span><span class="koboSpan" id="kobo.1226.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1227.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1228.1">len</span></span><span class="koboSpan" id="kobo.1229.1">(os.Args) != </span><span class="hljs-number"><span class="koboSpan" id="kobo.1230.1">2</span></span><span class="koboSpan" id="kobo.1231.1"> {
        fmt.Printf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1232.1">"Usage: %s URL\n"</span></span><span class="koboSpan" id="kobo.1233.1">, filepath.Base(os.Args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1234.1">0</span></span><span class="koboSpan" id="kobo.1235.1">]))
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1236.1">return</span></span><span class="koboSpan" id="kobo.1237.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1238.1">Although using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1239.1">filepath.Base()</span></code><span class="koboSpan" id="kobo.1240.1"> is not necessary, it makes your output more professional.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1241.1">    URL, err := url.Parse(os.Args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1242.1">1</span></span><span class="koboSpan" id="kobo.1243.1">])
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1244.1">if</span></span><span class="koboSpan" id="kobo.1245.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1246.1">nil</span></span><span class="koboSpan" id="kobo.1247.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1248.1">"Error in parsing:"</span></span><span class="koboSpan" id="kobo.1249.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1250.1">return</span></span><span class="koboSpan" id="kobo.1251.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1252.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1253.1">url.Parse()</span></code><span class="koboSpan" id="kobo.1254.1"> function parses a string into a URL structure. </span><span class="koboSpan" id="kobo.1254.2">This means that if the given argument is not</span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.1255.1"> a valid URL, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1256.1">url.Parse()</span></code><span class="koboSpan" id="kobo.1257.1"> is going </span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.1258.1">to notice. </span><span class="koboSpan" id="kobo.1258.2">As usual, we need to check the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1259.1">error</span></code><span class="koboSpan" id="kobo.1260.1"> variable.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1261.1">    c := &amp;http.Client{
        Timeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1262.1">15</span></span><span class="koboSpan" id="kobo.1263.1"> * time.Second,
    }
    request, err := http.NewRequest(http.MethodGet, URL.String(), </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1264.1">nil</span></span><span class="koboSpan" id="kobo.1265.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1266.1">if</span></span><span class="koboSpan" id="kobo.1267.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1268.1">nil</span></span><span class="koboSpan" id="kobo.1269.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1270.1">"Get:"</span></span><span class="koboSpan" id="kobo.1271.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1272.1">return</span></span><span class="koboSpan" id="kobo.1273.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1274.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1275.1">http.NewRequest()</span></code><span class="koboSpan" id="kobo.1276.1"> function returns an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1277.1">http.Request</span></code><span class="koboSpan" id="kobo.1278.1"> object when provided with a method, a URL, and an optional body. </span><span class="koboSpan" id="kobo.1278.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1279.1">http.MethodGet</span></code><span class="koboSpan" id="kobo.1280.1"> parameter defines that we want to retrieve the data using a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1281.1">GET</span></code><span class="koboSpan" id="kobo.1282.1"> HTTP method, whereas </span><code class="inlineCode"><span class="koboSpan" id="kobo.1283.1">URL.String()</span></code><span class="koboSpan" id="kobo.1284.1"> returns the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1285.1">string</span></code><span class="koboSpan" id="kobo.1286.1"> value of an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1287.1">http.URL</span></code><span class="koboSpan" id="kobo.1288.1"> variable.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1289.1">    httpData, err := c.Do(request)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1290.1">if</span></span><span class="koboSpan" id="kobo.1291.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1292.1">nil</span></span><span class="koboSpan" id="kobo.1293.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1294.1">"Error in Do():"</span></span><span class="koboSpan" id="kobo.1295.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1296.1">return</span></span><span class="koboSpan" id="kobo.1297.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1298.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1299.1">http.Do()</span></code><span class="koboSpan" id="kobo.1300.1"> function sends an HTTP request (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1301.1">http.Request</span></code><span class="koboSpan" id="kobo.1302.1">) using an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1303.1">http.Client</span></code><span class="koboSpan" id="kobo.1304.1"> and gets an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1305.1">http.Response</span></code><span class="koboSpan" id="kobo.1306.1"> back. </span><span class="koboSpan" id="kobo.1306.2">So </span><code class="inlineCode"><span class="koboSpan" id="kobo.1307.1">http.Do()</span></code><span class="koboSpan" id="kobo.1308.1"> does the job of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1309.1">http.Get()</span></code><span class="koboSpan" id="kobo.1310.1"> in a more detailed way:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1311.1">    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1312.1">"Status code:"</span></span><span class="koboSpan" id="kobo.1313.1">, httpData.Status)
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1314.1">httpData.Status</span></code><span class="koboSpan" id="kobo.1315.1"> holds the HTTP status code of the response—this is important because it allows you to understand what really happened with the request.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1316.1">    header, _ := httputil.DumpResponse(httpData, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1317.1">false</span></span><span class="koboSpan" id="kobo.1318.1">)
    fmt.Print(</span><span class="hljs-type"><span class="koboSpan" id="kobo.1319.1">string</span></span><span class="koboSpan" id="kobo.1320.1">(header))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1321.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1322.1">httputil.DumpResponse()</span></code><span class="koboSpan" id="kobo.1323.1"> function is used here to get the response from the server and is mainly used for debugging purposes. </span><span class="koboSpan" id="kobo.1323.2">The second argument of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1324.1">httputil.DumpResponse()</span></code><span class="koboSpan" id="kobo.1325.1"> is a Boolean value that specifies whether the function is going to include the body or not in its output—in our case, it is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1326.1">false</span></code><span class="koboSpan" id="kobo.1327.1">, which excludes the response body from the output and only prints the header. </span><span class="koboSpan" id="kobo.1327.2">If you want to do the same on the </span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.1328.1">server side, you should </span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.1329.1">use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1330.1">httputil.DumpRequest()</span></code><span class="koboSpan" id="kobo.1331.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1332.1">    contentType := httpData.Header.Get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1333.1">"Content-Type"</span></span><span class="koboSpan" id="kobo.1334.1">)
    characterSet := strings.SplitAfter(contentType, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1335.1">"charset="</span></span><span class="koboSpan" id="kobo.1336.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1337.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1338.1">len</span></span><span class="koboSpan" id="kobo.1339.1">(characterSet) &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1340.1">1</span></span><span class="koboSpan" id="kobo.1341.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1342.1">"Character Set:"</span></span><span class="koboSpan" id="kobo.1343.1">, characterSet[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1344.1">1</span></span><span class="koboSpan" id="kobo.1345.1">])
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1346.1">Here, we find out about the character set of the response by searching the value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1347.1">Content-Type</span></code><span class="koboSpan" id="kobo.1348.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1349.1">if</span></span><span class="koboSpan" id="kobo.1350.1"> httpData.ContentLength == </span><span class="hljs-number"><span class="koboSpan" id="kobo.1351.1">-1</span></span><span class="koboSpan" id="kobo.1352.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1353.1">"ContentLength is unknown!"</span></span><span class="koboSpan" id="kobo.1354.1">)
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1355.1">else</span></span><span class="koboSpan" id="kobo.1356.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1357.1">"ContentLength:"</span></span><span class="koboSpan" id="kobo.1358.1">, httpData.ContentLength)
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1359.1">Next, we try to get the content length from the response by reading </span><code class="inlineCode"><span class="koboSpan" id="kobo.1360.1">httpData.ContentLength</span></code><span class="koboSpan" id="kobo.1361.1">. </span><span class="koboSpan" id="kobo.1361.2">However, if the value is not set, we print a relevant message:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1362.1">    length := </span><span class="hljs-number"><span class="koboSpan" id="kobo.1363.1">0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1364.1">var</span></span><span class="koboSpan" id="kobo.1365.1"> buffer [</span><span class="hljs-number"><span class="koboSpan" id="kobo.1366.1">1024</span></span><span class="koboSpan" id="kobo.1367.1">]</span><span class="hljs-type"><span class="koboSpan" id="kobo.1368.1">byte</span></span><span class="koboSpan" id="kobo.1369.1">
    r := httpData.Body
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1370.1">for</span></span><span class="koboSpan" id="kobo.1371.1"> {
        n, err := r.Read(buffer[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1372.1">0</span></span><span class="koboSpan" id="kobo.1373.1">:])
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1374.1">if</span></span><span class="koboSpan" id="kobo.1375.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1376.1">nil</span></span><span class="koboSpan" id="kobo.1377.1"> {
            fmt.Println(err)
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1378.1">break</span></span><span class="koboSpan" id="kobo.1379.1">
        }
        length = length + n
    }
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1380.1">"Calculated response data length:"</span></span><span class="koboSpan" id="kobo.1381.1">, length)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1382.1">In the last part of the program, we use a technique for discovering the size of the server HTTP response on our own. </span><span class="koboSpan" id="kobo.1382.2">If we wanted to display the HTML output on our screen, we could have printed the contents of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1383.1">r</span></code><span class="koboSpan" id="kobo.1384.1"> buffer variable.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1385.1">Working with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1386.1">wwwClient.go</span></code><span class="koboSpan" id="kobo.1387.1"> and visiting </span><a href="https://www.golang.org"><span class="url"><span class="koboSpan" id="kobo.1388.1">https://www.golang.org</span></span></a><span class="koboSpan" id="kobo.1389.1"> produces the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1390.1">$ </span></span><span class="koboSpan" id="kobo.1391.1">go run wwwClient.go https://www.golang.org
Status code: 200 OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1392.1">The previous is </span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.1393.1">the </span><a id="_idIndexMarker799"/><span class="koboSpan" id="kobo.1394.1">output of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1395.1">fmt.Println("Status code:", httpData.Status)</span></code><span class="koboSpan" id="kobo.1396.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1397.1">Next, we see the output of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1398.1">fmt.Print(string(header))</span></code><span class="koboSpan" id="kobo.1399.1"> statement with the header data of the HTTP server response:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1400.1">HTTP/2.0 200 OK
Cache-Control: private
Content-Security-Policy: connect-src 'self' www.google-analytics.com stats.g.doubleclick.net ; default-src 'self' ; font-src 'self' fonts.googleapis.com fonts.gstatic.com data: ; frame-ancestors 'self' ; frame-src 'self' www.google.com feedback.googleusercontent.com www.googletagmanager.com scone-pa.clients6.google.com www.youtube.com player.vimeo.com ; img-src 'self' www.google.com www.google-analytics.com ssl.gstatic.com www.gstatic.com gstatic.com data: * ; object-src 'none' ; script-src 'self' 'sha256-n6OdwTrm52KqKm6aHYgD0TFUdMgww4a0GQlIAVrMzck=' 'sha256-4ryYrf7Y5daLOBv0CpYtyBIcJPZkRD2eBPdfqsN3r1M=' 'sha256-sVKX08+SqOmnWhiySYk3xC7RDUgKyAkmbXV2GWts4fo=' www.google.com apis.google.com www.gstatic.com gstatic.com support.google.com www.googletagmanager.com www.google-analytics.com ssl.google-analytics.com tagmanager.google.com ; style-src 'self' 'unsafe-inline' fonts.googleapis.com feedback.googleusercontent.com www.gstatic.com gstatic.com tagmanager.google.com ;
Content-Type: text/html; charset=utf-8
Date: Fri, 01 Sep 2023 19:12:13 GMT
Server: Google Frontend
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
Vary: Accept-Encoding
X-Cloud-Trace-Context: 63a0ba25023e0ff4d5b5ccb87ef286bc
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1401.1">The last part of the output is about the character set of the interaction (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1402.1">utf-8</span></code><span class="koboSpan" id="kobo.1403.1">) and the content length of the response (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1404.1">61870</span></code><span class="koboSpan" id="kobo.1405.1">), as calculated by the code:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1406.1">Character Set: utf-8
ContentLength is unknown!
</span><span class="koboSpan" id="kobo.1406.2">EOF
Calculated response data length: 61870
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1407.1">Let us now see </span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.1408.1">a technique to fetch multiple </span><a id="_idIndexMarker801"/><span class="koboSpan" id="kobo.1409.1">addresses concurrently.</span></p>
<h2 class="heading-2" id="_idParaDest-274"><span class="koboSpan" id="kobo.1410.1">Using errGroup</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1411.1">In this section, we </span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.1412.1">are going to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1413.1">errGroup</span></code><span class="koboSpan" id="kobo.1414.1"> package to fetch </span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.1415.1">multiple URLs concurrently, using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1416.1">golang.org/x/sync/errgroup</span></code><span class="koboSpan" id="kobo.1417.1"> external package. </span><span class="koboSpan" id="kobo.1417.2">For that reason, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1418.1">eGroup.go</span></code><span class="koboSpan" id="kobo.1419.1"> is located at </span><code class="inlineCode"><span class="koboSpan" id="kobo.1420.1">~/go/src/github.com/mactsouk/mGo4th/ch09/eGroup</span></code><span class="koboSpan" id="kobo.1421.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1422.1">The code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1423.1">eGroup.go</span></code><span class="koboSpan" id="kobo.1424.1"> is presented in two parts. </span><span class="koboSpan" id="kobo.1424.2">The first part is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1425.1">package</span></span><span class="koboSpan" id="kobo.1426.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1427.1">import</span></span><span class="koboSpan" id="kobo.1428.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1429.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1430.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1431.1">"os"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1432.1">"golang.org/x/sync/errgroup"</span></span><span class="koboSpan" id="kobo.1433.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1434.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1435.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1436.1">()</span></span><span class="koboSpan" id="kobo.1437.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1438.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1439.1">len</span></span><span class="koboSpan" id="kobo.1440.1">(os.Args) == </span><span class="hljs-number"><span class="koboSpan" id="kobo.1441.1">1</span></span><span class="koboSpan" id="kobo.1442.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1443.1">"Not enough arguments!"</span></span><span class="koboSpan" id="kobo.1444.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1445.1">return</span></span><span class="koboSpan" id="kobo.1446.1">
    }
    g := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1447.1">new</span></span><span class="koboSpan" id="kobo.1448.1">(errgroup.Group)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1449.1">We use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1450.1">errgroup.Group</span></code><span class="koboSpan" id="kobo.1451.1"> variable, which is a collection of goroutines that work on parts of the same bigger task. </span><span class="koboSpan" id="kobo.1451.2">In general, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1452.1">errgroup</span></code><span class="koboSpan" id="kobo.1453.1"> package provides synchronization, error propagation, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1454.1">Context</span></code><span class="koboSpan" id="kobo.1455.1"> cancelation for goroutines that work on subtasks of the same task that we want to treat as a group.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1456.1">The second part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1457.1">eGroup.go</span></code><span class="koboSpan" id="kobo.1458.1"> comes with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1459.1">for</span></span><span class="koboSpan" id="kobo.1460.1"> _, url := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1461.1">range</span></span><span class="koboSpan" id="kobo.1462.1"> os.Args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1463.1">1</span></span><span class="koboSpan" id="kobo.1464.1">:] {
        url := url
        g.Go(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1465.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1466.1">()</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.1467.1">error</span></span><span class="koboSpan" id="kobo.1468.1"> {
            resp, err := http.Get(url)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1469.1">if</span></span><span class="koboSpan" id="kobo.1470.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1471.1">nil</span></span><span class="koboSpan" id="kobo.1472.1"> {
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1473.1">return</span></span><span class="koboSpan" id="kobo.1474.1"> err
            }
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1475.1">defer</span></span><span class="koboSpan" id="kobo.1476.1"> resp.Body.Close()
            fmt.Println(url, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1477.1">"is OK."</span></span><span class="koboSpan" id="kobo.1478.1">)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1479.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1480.1">nil</span></span><span class="koboSpan" id="kobo.1481.1">
        })
    }
    err := g.Wait()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1482.1">if</span></span><span class="koboSpan" id="kobo.1483.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1484.1">nil</span></span><span class="koboSpan" id="kobo.1485.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1486.1">"Error:"</span></span><span class="koboSpan" id="kobo.1487.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1488.1">return</span></span><span class="koboSpan" id="kobo.1489.1">
    }
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1490.1">"Everything went fine!"</span></span><span class="koboSpan" id="kobo.1491.1">)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1492.1">In this</span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.1493.1"> part, we</span><a id="_idIndexMarker805"/><span class="koboSpan" id="kobo.1494.1"> use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1495.1">g.Go()</span></code><span class="koboSpan" id="kobo.1496.1"> to call the desired function as a goroutine. </span><span class="koboSpan" id="kobo.1496.2">Additionally, we use a </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.1497.1">closured variable</span></strong><span class="koboSpan" id="kobo.1498.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1499.1">url</span></code><span class="koboSpan" id="kobo.1500.1"> variable so that each goroutine processes the desired URL correctly.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1501.1">As expected, we need to run the following two commands first:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1502.1">$ </span></span><span class="koboSpan" id="kobo.1503.1">go mod init
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1504.1">$ </span></span><span class="koboSpan" id="kobo.1505.1">go mod tidy
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1506.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1507.1">eGroup.go</span></code><span class="koboSpan" id="kobo.1508.1"> on my macOS machine generates the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1509.1">$ </span></span><span class="koboSpan" id="kobo.1510.1">go run eGroup.go https://golang.org https://www.mtsoukalos.eu/
https://www.mtsoukalos.eu/ is OK.
</span><span class="koboSpan" id="kobo.1510.2">https://golang.org is OK.
</span><span class="koboSpan" id="kobo.1510.3">Everything went fine!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1511.1">Running the same command on my Arch Linux machine produces a different output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1512.1">$ </span></span><span class="koboSpan" id="kobo.1513.1">go run eGroup.go https://golang.org https://www.mtsoukalos.eu/
https://golang.org is OK.
</span><span class="koboSpan" id="kobo.1513.2">Error: Get "https://www.mtsoukalos.eu/": tls: failed to verify certificate: x509: certificate signed by unknown authority
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1514.1">The next section </span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.1515.1">shows how to create a command line client for the </span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.1516.1">statistics web service we developed earlier.</span></p>
<h1 class="heading-1" id="_idParaDest-275"><span class="koboSpan" id="kobo.1517.1">Creating a client for the statistics service</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1518.1">In this</span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.1519.1"> subsection, we create a command line utility that interacts </span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.1520.1">with the statistics web service that was developed earlier in this chapter. </span><span class="koboSpan" id="kobo.1520.2">This version of the statistics client is going to be created using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1521.1">cobra</span></code><span class="koboSpan" id="kobo.1522.1"> package, and as expected, it is going to go under </span><code class="inlineCode"><span class="koboSpan" id="kobo.1523.1">~/go/src</span></code><span class="koboSpan" id="kobo.1524.1">: </span><code class="inlineCode"><span class="koboSpan" id="kobo.1525.1">~/go/src/github.com/mactsouk/mGo4th/ch09/client</span></code><span class="koboSpan" id="kobo.1526.1">. </span><span class="koboSpan" id="kobo.1526.2">The previous directory contains the final version of the client. </span><span class="koboSpan" id="kobo.1526.3">The initial steps for creating the client are the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1527.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.1528.1">cd</span></span><span class="koboSpan" id="kobo.1529.1"> ~/go/src/github.com/mactsouk/mGo4th/ch09/client
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1530.1">$ </span></span><span class="koboSpan" id="kobo.1531.1">go mod init
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1532.1">$ </span></span><span class="koboSpan" id="kobo.1533.1">~/go/bin/cobra init
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1534.1">$ </span></span><span class="koboSpan" id="kobo.1535.1">~/go/bin/cobra add search
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1536.1">$ </span></span><span class="koboSpan" id="kobo.1537.1">~/go/bin/cobra add insert
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1538.1">$ </span></span><span class="koboSpan" id="kobo.1539.1">~/go/bin/cobra add delete
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1540.1">$ </span></span><span class="koboSpan" id="kobo.1541.1">~/go/bin/cobra add status
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1542.1">$ </span></span><span class="koboSpan" id="kobo.1543.1">~/go/bin/cobra add list
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1544.1">So, we have a command line utility with five commands, named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1545.1">search</span></code><span class="koboSpan" id="kobo.1546.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1547.1">insert</span></code><span class="koboSpan" id="kobo.1548.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1549.1">delete</span></code><span class="koboSpan" id="kobo.1550.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1551.1">status</span></code><span class="koboSpan" id="kobo.1552.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1553.1">list</span></code><span class="koboSpan" id="kobo.1554.1">. </span><span class="koboSpan" id="kobo.1554.2">After that, we need to implement the commands and define their local parameters in order to interact with the statistics server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1555.1">Now, let us see the implementations of the commands, starting from the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1556.1">init()</span></code><span class="koboSpan" id="kobo.1557.1"> function of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1558.1">root.go</span></code><span class="koboSpan" id="kobo.1559.1"> file because this is where the global command line parameters are defined:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1560.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1561.1">init</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1562.1">()</span></span><span class="koboSpan" id="kobo.1563.1"> {
    rootCmd.PersistentFlags().StringP(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1564.1">"server"</span></span><span class="koboSpan" id="kobo.1565.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1566.1">"S"</span></span><span class="koboSpan" id="kobo.1567.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1568.1">"localhost"</span></span><span class="koboSpan" id="kobo.1569.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1570.1">"Server"</span></span><span class="koboSpan" id="kobo.1571.1">)
    rootCmd.PersistentFlags().StringP(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1572.1">"port"</span></span><span class="koboSpan" id="kobo.1573.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1574.1">"P"</span></span><span class="koboSpan" id="kobo.1575.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1576.1">"1234"</span></span><span class="koboSpan" id="kobo.1577.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1578.1">"Port number"</span></span><span class="koboSpan" id="kobo.1579.1">)
    viper.BindPFlag(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1580.1">"server"</span></span><span class="koboSpan" id="kobo.1581.1">, rootCmd.PersistentFlags().Lookup(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1582.1">"server"</span></span><span class="koboSpan" id="kobo.1583.1">))
    viper.BindPFlag(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1584.1">"port"</span></span><span class="koboSpan" id="kobo.1585.1">, rootCmd.PersistentFlags().Lookup(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1586.1">"port"</span></span><span class="koboSpan" id="kobo.1587.1">))
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1588.1">So, we define two global parameters named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1589.1">server</span></code><span class="koboSpan" id="kobo.1590.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1591.1">port</span></code><span class="koboSpan" id="kobo.1592.1">, which are the hostname and the port number of the server, respectively. </span><span class="koboSpan" id="kobo.1592.2">Both parameters have an alias and are handled by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1593.1">viper</span></code><span class="koboSpan" id="kobo.1594.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1595.1">Let us now examine</span><a id="_idIndexMarker810"/><span class="koboSpan" id="kobo.1596.1"> the</span><a id="_idIndexMarker811"/><span class="koboSpan" id="kobo.1597.1"> implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1598.1">status</span></code><span class="koboSpan" id="kobo.1599.1"> command as found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1600.1">status.go</span></code><span class="koboSpan" id="kobo.1601.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1602.1">SERVER := viper.GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1603.1">"server"</span></span><span class="koboSpan" id="kobo.1604.1">)
PORT := viper.GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1605.1">"port"</span></span><span class="koboSpan" id="kobo.1606.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1607.1">All commands read the values of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1608.1">server</span></code><span class="koboSpan" id="kobo.1609.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1610.1">port</span></code><span class="koboSpan" id="kobo.1611.1"> command line parameters to get information about the server, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1612.1">status</span></code><span class="koboSpan" id="kobo.1613.1"> command is no exception:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1614.1">// Create request</span></span><span class="koboSpan" id="kobo.1615.1">
URL := </span><span class="hljs-string"><span class="koboSpan" id="kobo.1616.1">"http://"</span></span><span class="koboSpan" id="kobo.1617.1"> + SERVER + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1618.1">":"</span></span><span class="koboSpan" id="kobo.1619.1"> + PORT + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1620.1">"/status"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1621.1">After that, we construct the full URL of the request.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1622.1">data, err := http.Get(URL)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1623.1">if</span></span><span class="koboSpan" id="kobo.1624.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1625.1">nil</span></span><span class="koboSpan" id="kobo.1626.1"> {
    fmt.Println(err)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1627.1">return</span></span><span class="koboSpan" id="kobo.1628.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1629.1">Then, we send a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1630.1">GET</span></code><span class="koboSpan" id="kobo.1631.1"> request to the server using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1632.1">http.Get()</span></code><span class="koboSpan" id="kobo.1633.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1634.1">// Check HTTP Status Code</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1635.1">if</span></span><span class="koboSpan" id="kobo.1636.1"> data.StatusCode != http.StatusOK {
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1637.1">"Status code:"</span></span><span class="koboSpan" id="kobo.1638.1">, data.StatusCode)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1639.1">return</span></span><span class="koboSpan" id="kobo.1640.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1641.1">After that, we check the HTTP status code of the request to make sure that everything is OK.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1642.1">// Read data</span></span><span class="koboSpan" id="kobo.1643.1">
responseData, err := io.ReadAll(data.Body)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1644.1">if</span></span><span class="koboSpan" id="kobo.1645.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1646.1">nil</span></span><span class="koboSpan" id="kobo.1647.1"> {
    fmt.Println(err)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1648.1">return</span></span><span class="koboSpan" id="kobo.1649.1">
}
fmt.Print(</span><span class="hljs-type"><span class="koboSpan" id="kobo.1650.1">string</span></span><span class="koboSpan" id="kobo.1651.1">(responseData))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1652.1">If everything is OK, we read the entire body of the server response, which is a byte slice, and print it onscreen as a string. </span><span class="koboSpan" id="kobo.1652.2">The implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1653.1">list</span></code><span class="koboSpan" id="kobo.1654.1"> is almost identical to the implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1655.1">status</span></code><span class="koboSpan" id="kobo.1656.1">. </span><span class="koboSpan" id="kobo.1656.2">The only differences are that the implementation is found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1657.1">list.go</span></code><span class="koboSpan" id="kobo.1658.1"> and that the</span><a id="_idIndexMarker812"/><span class="koboSpan" id="kobo.1659.1"> full </span><a id="_idIndexMarker813"/><span class="koboSpan" id="kobo.1660.1">URL is constructed as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1661.1">URL := </span><span class="hljs-string"><span class="koboSpan" id="kobo.1662.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1663.1">http://"</span></span><span class="koboSpan" id="kobo.1664.1"> + SERVER + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1665.1">":"</span></span><span class="koboSpan" id="kobo.1666.1"> + PORT + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1667.1">"/list"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1668.1">After that, let us see how the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1669.1">delete</span></code><span class="koboSpan" id="kobo.1670.1"> command is implemented in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1671.1">delete.go</span></code><span class="koboSpan" id="kobo.1672.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1673.1">        SERVER := viper.GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1674.1">"server"</span></span><span class="koboSpan" id="kobo.1675.1">)
        PORT := viper.GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1676.1">"port"</span></span><span class="koboSpan" id="kobo.1677.1">)
        dataset, _ := cmd.Flags().GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1678.1">"dataset"</span></span><span class="koboSpan" id="kobo.1679.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1680.1">if</span></span><span class="koboSpan" id="kobo.1681.1"> dataset == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1682.1">""</span></span><span class="koboSpan" id="kobo.1683.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1684.1">"Number is empty!"</span></span><span class="koboSpan" id="kobo.1685.1">)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1686.1">return</span></span><span class="koboSpan" id="kobo.1687.1">
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1688.1">Apart from reading the values of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1689.1">server</span></code><span class="koboSpan" id="kobo.1690.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1691.1">port</span></code><span class="koboSpan" id="kobo.1692.1"> global parameters, we read the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1693.1">dataset</span></code><span class="koboSpan" id="kobo.1694.1"> parameter. </span><span class="koboSpan" id="kobo.1694.2">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.1695.1">dataset</span></code><span class="koboSpan" id="kobo.1696.1"> has no value, the command returns this.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1697.1">        URL := </span><span class="hljs-string"><span class="koboSpan" id="kobo.1698.1">"http://"</span></span><span class="koboSpan" id="kobo.1699.1"> + SERVER + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1700.1">":"</span></span><span class="koboSpan" id="kobo.1701.1"> + PORT + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1702.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1703.1">/delete/"</span></span><span class="koboSpan" id="kobo.1704.1"> + dataset
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1705.1">Once again, we construct the full URL of the request before connecting to the server.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1706.1">        data, err := http.Get(URL)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1707.1">if</span></span><span class="koboSpan" id="kobo.1708.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1709.1">nil</span></span><span class="koboSpan" id="kobo.1710.1"> {
            fmt.Println(err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1711.1">return</span></span><span class="koboSpan" id="kobo.1712.1">
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1713.1">The previous code sends the client request to the server.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1714.1">if</span></span><span class="koboSpan" id="kobo.1715.1"> data.StatusCode != http.StatusOK {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1716.1">"Status code:"</span></span><span class="koboSpan" id="kobo.1717.1">, data.StatusCode)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1718.1">return</span></span><span class="koboSpan" id="kobo.1719.1">
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1720.1">If there is an error in the server response, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1721.1">delete</span></code><span class="koboSpan" id="kobo.1722.1"> command prints the HTTP error and terminates.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1723.1">        responseData, err := io.ReadAll(data.Body)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1724.1">if</span></span><span class="koboSpan" id="kobo.1725.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1726.1">nil</span></span><span class="koboSpan" id="kobo.1727.1"> {
            fmt.Println(err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1728.1">return</span></span><span class="koboSpan" id="kobo.1729.1">
        }
        fmt.Print(</span><span class="hljs-type"><span class="koboSpan" id="kobo.1730.1">string</span></span><span class="koboSpan" id="kobo.1731.1">(responseData))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1732.1">If everything was</span><a id="_idIndexMarker814"/><span class="koboSpan" id="kobo.1733.1"> fine, the </span><a id="_idIndexMarker815"/><span class="koboSpan" id="kobo.1734.1">server response text is printed on the screen.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1735.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1736.1">init()</span></code><span class="koboSpan" id="kobo.1737.1"> function of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1738.1">delete.go</span></code><span class="koboSpan" id="kobo.1739.1"> contains the definition of the local </span><code class="inlineCode"><span class="koboSpan" id="kobo.1740.1">dataset</span></code><span class="koboSpan" id="kobo.1741.1"> command line parameter to get the dataset name to delete.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1742.1">Next, let us learn more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1743.1">search</span></code><span class="koboSpan" id="kobo.1744.1"> command and how it is implemented in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1745.1">search.go</span></code><span class="koboSpan" id="kobo.1746.1">. </span><span class="koboSpan" id="kobo.1746.2">The implementation is the same as in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1747.1">delete</span></code><span class="koboSpan" id="kobo.1748.1"> except for the full request URL:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1749.1">URL := </span><span class="hljs-string"><span class="koboSpan" id="kobo.1750.1">"http://"</span></span><span class="koboSpan" id="kobo.1751.1"> + SERVER + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1752.1">":"</span></span><span class="koboSpan" id="kobo.1753.1"> + PORT + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1754.1">"/search/"</span></span><span class="koboSpan" id="kobo.1755.1"> + dataset
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1756.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1757.1">search</span></code><span class="koboSpan" id="kobo.1758.1"> command also supports the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1759.1">dataset</span></code><span class="koboSpan" id="kobo.1760.1"> command line parameter in getting the dataset name to search for—this is defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1761.1">init()</span></code><span class="koboSpan" id="kobo.1762.1"> function of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1763.1">search.go</span></code><span class="koboSpan" id="kobo.1764.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1765.1">The last command that is presented is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1766.1">insert</span></code><span class="koboSpan" id="kobo.1767.1"> command, which supports two local command line parameters that are defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1768.1">init()</span></code><span class="koboSpan" id="kobo.1769.1"> function in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1770.1">insert.go</span></code><span class="koboSpan" id="kobo.1771.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1772.1">    insertCmd.Flags().StringP(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1773.1">"dataset"</span></span><span class="koboSpan" id="kobo.1774.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1775.1">"d"</span></span><span class="koboSpan" id="kobo.1776.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1777.1">""</span></span><span class="koboSpan" id="kobo.1778.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1779.1">"Dataset name"</span></span><span class="koboSpan" id="kobo.1780.1">)
    insertCmd.Flags().StringP(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1781.1">"values"</span></span><span class="koboSpan" id="kobo.1782.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1783.1">"v"</span></span><span class="koboSpan" id="kobo.1784.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1785.1">""</span></span><span class="koboSpan" id="kobo.1786.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1787.1">"List of values"</span></span><span class="koboSpan" id="kobo.1788.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1789.1">These two parameters are needed to get the required user input. </span><span class="koboSpan" id="kobo.1789.2">However, the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1790.1">values</span></code><span class="koboSpan" id="kobo.1791.1"> parameter is expected to be a comma-separated list of floating-point values—this is the way we define how to get all the elements of a dataset.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1792.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1793.1">insert</span></code><span class="koboSpan" id="kobo.1794.1"> command is implemented using the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1795.1">    SERVER := viper.GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1796.1">"server"</span></span><span class="koboSpan" id="kobo.1797.1">)
    PORT := viper.GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1798.1">"port"</span></span><span class="koboSpan" id="kobo.1799.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1800.1">First, we read the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1801.1">server</span></code><span class="koboSpan" id="kobo.1802.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1803.1">port</span></code><span class="koboSpan" id="kobo.1804.1"> global parameters.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1805.1">        dataset, _ := cmd.Flags().GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1806.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1807.1">dataset"</span></span><span class="koboSpan" id="kobo.1808.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1809.1">if</span></span><span class="koboSpan" id="kobo.1810.1"> dataset == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1811.1">""</span></span><span class="koboSpan" id="kobo.1812.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1813.1">"Dataset is empty!"</span></span><span class="koboSpan" id="kobo.1814.1">)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1815.1">return</span></span><span class="koboSpan" id="kobo.1816.1">
        }
        values, _ := cmd.Flags().GetString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1817.1">"values"</span></span><span class="koboSpan" id="kobo.1818.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1819.1">if</span></span><span class="koboSpan" id="kobo.1820.1"> values == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1821.1">""</span></span><span class="koboSpan" id="kobo.1822.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1823.1">"No data!"</span></span><span class="koboSpan" id="kobo.1824.1">)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1825.1">return</span></span><span class="koboSpan" id="kobo.1826.1">
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1827.1">Then, we get the values of the two local command line parameters. </span><span class="koboSpan" id="kobo.1827.2">If either one of them has an empty</span><a id="_idIndexMarker816"/><span class="koboSpan" id="kobo.1828.1"> value, the</span><a id="_idIndexMarker817"/><span class="koboSpan" id="kobo.1829.1"> command returns without sending the request to the server.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1830.1">        VALS := strings.Split(values, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1831.1">","</span></span><span class="koboSpan" id="kobo.1832.1">)
        vSend := </span><span class="hljs-string"><span class="koboSpan" id="kobo.1833.1">""</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1834.1">for</span></span><span class="koboSpan" id="kobo.1835.1"> _, v := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1836.1">range</span></span><span class="koboSpan" id="kobo.1837.1"> VALS {
            _, err := strconv.ParseFloat(v, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1838.1">64</span></span><span class="koboSpan" id="kobo.1839.1">)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1840.1">if</span></span><span class="koboSpan" id="kobo.1841.1"> err == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1842.1">nil</span></span><span class="koboSpan" id="kobo.1843.1"> {
                vSend = vSend + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1844.1">"/"</span></span><span class="koboSpan" id="kobo.1845.1"> + v
            }
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1846.1">The previous code is very important, as it checks whether the given dataset elements are valid </span><code class="inlineCode"><span class="koboSpan" id="kobo.1847.1">float64</span></code><span class="koboSpan" id="kobo.1848.1"> values, and then it creates a string of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1849.1">/value1/value2/. </span><span class="koboSpan" id="kobo.1849.2">. </span><span class="koboSpan" id="kobo.1849.3">./valueN/</span></code><span class="koboSpan" id="kobo.1850.1"> form. </span><span class="koboSpan" id="kobo.1850.2">This </span><code class="inlineCode"><span class="koboSpan" id="kobo.1851.1">string</span></code><span class="koboSpan" id="kobo.1852.1"> value is attached to the end of the URL that holds the server request.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1853.1">        URL := </span><span class="hljs-string"><span class="koboSpan" id="kobo.1854.1">"http://"</span></span><span class="koboSpan" id="kobo.1855.1"> + SERVER + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1856.1">":"</span></span><span class="koboSpan" id="kobo.1857.1"> + PORT + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1858.1">"/insert/"</span></span><span class="koboSpan" id="kobo.1859.1">
        URL = URL + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1860.1">"/"</span></span><span class="koboSpan" id="kobo.1861.1"> + dataset + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1862.1">"/"</span></span><span class="koboSpan" id="kobo.1863.1"> + vSend + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1864.1">"/"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1865.1">Here, we create the server request in two steps for readability.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1866.1">data, err := http.Get(URL)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1867.1">if</span></span><span class="koboSpan" id="kobo.1868.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1869.1">nil</span></span><span class="koboSpan" id="kobo.1870.1"> {
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1871.1">"**"</span></span><span class="koboSpan" id="kobo.1872.1">, err)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1873.1">return</span></span><span class="koboSpan" id="kobo.1874.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1875.1">Then, we send the request to the server.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1876.1">if</span></span><span class="koboSpan" id="kobo.1877.1"> data.StatusCode != http.StatusOK {
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1878.1">"Status code:"</span></span><span class="koboSpan" id="kobo.1879.1">, data.StatusCode)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1880.1">return</span></span><span class="koboSpan" id="kobo.1881.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1882.1">Checking the HTTP status </span><a id="_idIndexMarker818"/><span class="koboSpan" id="kobo.1883.1">code</span><a id="_idIndexMarker819"/><span class="koboSpan" id="kobo.1884.1"> is always a good practice. </span><span class="koboSpan" id="kobo.1884.2">Therefore, if everything is OK with the server response, we continue by reading the data. </span><span class="koboSpan" id="kobo.1884.3">Otherwise, we print the status code, and we exit.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1885.1">responseData, err := io.ReadAll(data.Body)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1886.1">if</span></span><span class="koboSpan" id="kobo.1887.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1888.1">nil</span></span><span class="koboSpan" id="kobo.1889.1"> {
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1890.1">"*"</span></span><span class="koboSpan" id="kobo.1891.1">, err)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1892.1">return</span></span><span class="koboSpan" id="kobo.1893.1">
}
fmt.Print(</span><span class="hljs-type"><span class="koboSpan" id="kobo.1894.1">string</span></span><span class="koboSpan" id="kobo.1895.1">(responseData))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1896.1">After reading the body of the server response, which is stored in a byte slice, we print it onscreen as a string using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1897.1">string(responseData)</span></code><span class="koboSpan" id="kobo.1898.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1899.1">The client application generates the following kind of output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1900.1">$ </span></span><span class="koboSpan" id="kobo.1901.1">go run main.go list
List of entries:
d6    4    2.325000    1.080220
d4    5    2.860000    1.441666
d2    9    1.000000    0.000000
v1    5    3.000000    1.414214
v2    7    1.000000    3.422614
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1902.1">This is the output of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1903.1">list</span></code><span class="koboSpan" id="kobo.1904.1"> command.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1905.1">$ </span></span><span class="koboSpan" id="kobo.1906.1">go run main.go status
Total entries: 5
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1907.1">The output of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1908.1">status</span></code><span class="koboSpan" id="kobo.1909.1"> command informs us about the number of entries in the application.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1910.1">$ </span></span><span class="koboSpan" id="kobo.1911.1">go run main.go search -d v1
v1 5 3.000000 1.414214
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1912.1">The previous output shows the use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1913.1">search</span></code><span class="koboSpan" id="kobo.1914.1"> command when successfully finding a dataset.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1915.1">$ </span></span><span class="koboSpan" id="kobo.1916.1">go run main.go search -d notThere
Status code: 404
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1917.1">The previous output shows the use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1918.1">search</span></code><span class="koboSpan" id="kobo.1919.1"> command when not finding a dataset.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1920.1">$ </span></span><span class="koboSpan" id="kobo.1921.1">go run main.go delete -d v1
v1 deleted!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1922.1">This is the output of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1923.1">delete</span></code><span class="koboSpan" id="kobo.1924.1"> command.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1925.1">$ </span></span><span class="koboSpan" id="kobo.1926.1">go run main.go insert -d n1 -v 1,2,3,-4,0,0
New record added successfully
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1927.1">This is the operation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1928.1">insert</span></code><span class="koboSpan" id="kobo.1929.1"> command. </span><span class="koboSpan" id="kobo.1929.2">If you try to insert the same dataset name more than once, the </span><a id="_idIndexMarker820"/><span class="koboSpan" id="kobo.1930.1">server</span><a id="_idIndexMarker821"/><span class="koboSpan" id="kobo.1931.1"> output is going to be </span><code class="inlineCode"><span class="koboSpan" id="kobo.1932.1">Status code: 304</span></code><span class="koboSpan" id="kobo.1933.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1934.1">The next section explains how to time out HTTP connections.</span></p>
<h1 class="heading-1" id="_idParaDest-276"><span class="koboSpan" id="kobo.1935.1">Timing out HTTP connections</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1936.1">This section </span><a id="_idIndexMarker822"/><span class="koboSpan" id="kobo.1937.1">presents techniques for timing out HTTP connections that take too long to finish and work either on the server or the client side.</span></p>
<h2 class="heading-2" id="_idParaDest-277"><span class="koboSpan" id="kobo.1938.1">Using SetDeadline()</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1939.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1940.1">SetDeadline()</span></code><span class="koboSpan" id="kobo.1941.1"> function is</span><a id="_idIndexMarker823"/><span class="koboSpan" id="kobo.1942.1"> used by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1943.1">net</span></code><span class="koboSpan" id="kobo.1944.1"> to set the </span><a id="_idIndexMarker824"/><span class="koboSpan" id="kobo.1945.1">read and write deadlines of network connections. </span><span class="koboSpan" id="kobo.1945.2">Due to the way that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1946.1">SetDeadline()</span></code><span class="koboSpan" id="kobo.1947.1"> works, you need to call </span><code class="inlineCode"><span class="koboSpan" id="kobo.1948.1">SetDeadline()</span></code><span class="koboSpan" id="kobo.1949.1"> before any read or write operation. </span><span class="koboSpan" id="kobo.1949.2">Keep in mind that Go uses deadlines to implement timeouts, so you do not need to reset the timeout every time your application receives or sends any data. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1950.1">The use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1951.1">SetDeadline()</span></code><span class="koboSpan" id="kobo.1952.1"> is illustrated in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1953.1">withDeadline.go</span></code><span class="koboSpan" id="kobo.1954.1"> and, more specifically, in the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1955.1">Timeout()</span></code><span class="koboSpan" id="kobo.1956.1"> function:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1957.1">var</span></span><span class="koboSpan" id="kobo.1958.1"> timeout = time.Duration(time.Second)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1959.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1960.1">Timeout</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1961.1">(network, host </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1962.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1963.1">)</span></span><span class="koboSpan" id="kobo.1964.1"> (net.Conn, </span><span class="hljs-type"><span class="koboSpan" id="kobo.1965.1">error</span></span><span class="koboSpan" id="kobo.1966.1">) {
    conn, err := net.DialTimeout(network, host, timeout)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1967.1">if</span></span><span class="koboSpan" id="kobo.1968.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1969.1">nil</span></span><span class="koboSpan" id="kobo.1970.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1971.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1972.1">nil</span></span><span class="koboSpan" id="kobo.1973.1">, err
    }
    conn.SetDeadline(time.Now().Add(timeout))
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1974.1">return</span></span><span class="koboSpan" id="kobo.1975.1"> conn, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1976.1">nil</span></span><span class="koboSpan" id="kobo.1977.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1978.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1979.1">timeout</span></code><span class="koboSpan" id="kobo.1980.1"> global variable defines the timeout period used in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1981.1">SetDeadline()</span></code><span class="koboSpan" id="kobo.1982.1"> call. </span><span class="koboSpan" id="kobo.1982.2">The previous function is used in the following code inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.1983.1">main()</span></code><span class="koboSpan" id="kobo.1984.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1985.1">t := http.Transport{
    Dial: Timeout,
}
client := http.Client{
        Transport: &amp;t,
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1986.1">So, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1987.1">http.Transport</span></code><span class="koboSpan" id="kobo.1988.1"> uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.1989.1">Timeout()</span></code><span class="koboSpan" id="kobo.1990.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1991.1">Dial</span></code><span class="koboSpan" id="kobo.1992.1"> field, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1993.1">http.Client</span></code><span class="koboSpan" id="kobo.1994.1"> uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.1995.1">http.Transport</span></code><span class="koboSpan" id="kobo.1996.1">. </span><span class="koboSpan" id="kobo.1996.2">When you </span><a id="_idIndexMarker825"/><span class="koboSpan" id="kobo.1997.1">call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1998.1">client.Get()</span></code><span class="koboSpan" id="kobo.1999.1"> method </span><a id="_idIndexMarker826"/><span class="koboSpan" id="kobo.2000.1">with the desired URL, which is not shown here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2001.1">Timeout</span></code><span class="koboSpan" id="kobo.2002.1"> is automatically used because of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2003.1">http.Transport</span></code><span class="koboSpan" id="kobo.2004.1"> definition. </span><span class="koboSpan" id="kobo.2004.2">So, if the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2005.1">Timeout</span></code><span class="koboSpan" id="kobo.2006.1"> function returns before the server response is received, we have a timeout.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2007.1">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2008.1">withDeadline.go</span></code><span class="koboSpan" id="kobo.2009.1"> produces the following kind of output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2010.1">$ </span></span><span class="koboSpan" id="kobo.2011.1">go run withDeadline.go http://www.golang.org
Timeout value: 1s
&lt;!DOCTYPE html&gt;
...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2012.1">The call was successful and took less than 1 second to finish, so there was no timeout.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2013.1">$ </span></span><span class="koboSpan" id="kobo.2014.1">go run withDeadline.go http://localhost:80
Timeout value: 1s
Get "http://localhost:80": read tcp 127.0.0.1:52492-&gt;127.0.0.1:80: i/o timeout
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2015.1">This time, we have a timeout, as the server took too long to answer.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2016.1">Next, we show</span><a id="_idIndexMarker827"/><span class="koboSpan" id="kobo.2017.1"> how to time out a connection</span><a id="_idIndexMarker828"/><span class="koboSpan" id="kobo.2018.1"> using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2019.1">context</span></code><span class="koboSpan" id="kobo.2020.1"> package.</span></p>
<h2 class="heading-2" id="_idParaDest-278"><span class="koboSpan" id="kobo.2021.1">Setting the timeout period on the client side</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2022.1">This section</span><a id="_idIndexMarker829"/><span class="koboSpan" id="kobo.2023.1"> presents a technique for </span><a id="_idIndexMarker830"/><span class="koboSpan" id="kobo.2024.1">timing out network connections that take too long to finish </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.2025.1">on the client side</span></strong><span class="koboSpan" id="kobo.2026.1">. </span><span class="koboSpan" id="kobo.2026.2">So if the client does not receive a response from the server in the desired time, it closes the connection. </span><span class="koboSpan" id="kobo.2026.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2027.1">timeoutClient.go</span></code><span class="koboSpan" id="kobo.2028.1"> source file illustrates the technique.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2029.1">package</span></span><span class="koboSpan" id="kobo.2030.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2031.1">import</span></span><span class="koboSpan" id="kobo.2032.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2033.1">"context"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2034.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2035.1">"io"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2036.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2037.1">"os"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2038.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2039.1">strconv"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2040.1">"time"</span></span><span class="koboSpan" id="kobo.2041.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2042.1">var</span></span><span class="koboSpan" id="kobo.2043.1"> delay </span><span class="hljs-type"><span class="koboSpan" id="kobo.2044.1">int</span></span><span class="koboSpan" id="kobo.2045.1"> = </span><span class="hljs-number"><span class="koboSpan" id="kobo.2046.1">5</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2047.1">In the previous code, we define a global variable named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2048.1">delay</span></code><span class="koboSpan" id="kobo.2049.1"> that holds the delay value.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2050.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2051.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2052.1">()</span></span><span class="koboSpan" id="kobo.2053.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2054.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2055.1">len</span></span><span class="koboSpan" id="kobo.2056.1">(os.Args) == </span><span class="hljs-number"><span class="koboSpan" id="kobo.2057.1">1</span></span><span class="koboSpan" id="kobo.2058.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2059.1">"Need a URL and a delay!"</span></span><span class="koboSpan" id="kobo.2060.1">)
        os.Exit(</span><span class="hljs-number"><span class="koboSpan" id="kobo.2061.1">1</span></span><span class="koboSpan" id="kobo.2062.1">)
    }
    url := os.Args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.2063.1">1</span></span><span class="koboSpan" id="kobo.2064.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2065.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2066.1">len</span></span><span class="koboSpan" id="kobo.2067.1">(os.Args) == </span><span class="hljs-number"><span class="koboSpan" id="kobo.2068.1">3</span></span><span class="koboSpan" id="kobo.2069.1"> {
      t, err := strconv.Atoi(os.Args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.2070.1">2</span></span><span class="koboSpan" id="kobo.2071.1">])
      </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2072.1">if</span></span><span class="koboSpan" id="kobo.2073.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2074.1">nil</span></span><span class="koboSpan" id="kobo.2075.1"> {
         fmt.Println(err)
         </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2076.1">return</span></span><span class="koboSpan" id="kobo.2077.1">
      }
      delay = t
   }
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2078.1">"Delay:"</span></span><span class="koboSpan" id="kobo.2079.1">, delay)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2080.1">The URL is read directly because it is already a string value, whereas the delay period is converted into a numeric value using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2081.1">strconv.Atoi()</span></code><span class="koboSpan" id="kobo.2082.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2083.1">The rest of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2084.1">main()</span></code><span class="koboSpan" id="kobo.2085.1"> implementation is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2086.1">    ctx, cncl := context.WithTimeout(context.Background(), time.Second * time.Duration(delay))
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2087.1">defer</span></span><span class="koboSpan" id="kobo.2088.1"> cncl()
    req, err := http.NewRequestWithContext(ctx, http.MethodGet, url, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2089.1">nil</span></span><span class="koboSpan" id="kobo.2090.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2091.1">if</span></span><span class="koboSpan" id="kobo.2092.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2093.1">nil</span></span><span class="koboSpan" id="kobo.2094.1"> {
        fmt.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2095.1">return</span></span><span class="koboSpan" id="kobo.2096.1">
    }
    res, err := http.DefaultClient.Do(req.WithContext(ctx))
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2097.1">if</span></span><span class="koboSpan" id="kobo.2098.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2099.1">nil</span></span><span class="koboSpan" id="kobo.2100.1"> {
        fmt.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2101.1">return</span></span><span class="koboSpan" id="kobo.2102.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2103.1">defer</span></span><span class="koboSpan" id="kobo.2104.1"> res.Body.Close()
    body, err := io.ReadAll(res.Body)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2105.1">if</span></span><span class="koboSpan" id="kobo.2106.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2107.1">nil</span></span><span class="koboSpan" id="kobo.2108.1"> {
        fmt.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2109.1">return</span></span><span class="koboSpan" id="kobo.2110.1">
    }
    fmt.Println(</span><span class="hljs-type"><span class="koboSpan" id="kobo.2111.1">string</span></span><span class="koboSpan" id="kobo.2112.1">(body))
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2113.1">First, we </span><a id="_idIndexMarker831"/><span class="koboSpan" id="kobo.2114.1">initialize</span><a id="_idIndexMarker832"/><span class="koboSpan" id="kobo.2115.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2116.1">ctx</span></code><span class="koboSpan" id="kobo.2117.1"> context, and then we associate that context with the HTTP request using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2118.1">http.NewRequestWithContext()</span></code><span class="koboSpan" id="kobo.2119.1">. </span><span class="koboSpan" id="kobo.2119.2">If the timeout period is exceeded, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2120.1">context.Context</span></code><span class="koboSpan" id="kobo.2121.1"> created with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2122.1">WithTimeout()</span></code><span class="koboSpan" id="kobo.2123.1"> is going to expire.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2124.1">Working with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2125.1">timeoutClient.go</span></code><span class="koboSpan" id="kobo.2126.1"> and having a timeout situation generates the following kind of output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2127.1">$ </span></span><span class="koboSpan" id="kobo.2128.1">go run timeoutClient.go http://localhost:1234 5
Delay: 5
Get "http://localhost:1234": context deadline exceeded
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2129.1">The next </span><a id="_idIndexMarker833"/><span class="koboSpan" id="kobo.2130.1">subsection shows how to </span><a id="_idIndexMarker834"/><span class="koboSpan" id="kobo.2131.1">time out an HTTP request on the server side.</span></p>
<h2 class="heading-2" id="_idParaDest-279"><span class="koboSpan" id="kobo.2132.1">Setting the timeout period on the server side</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2133.1">This section presents</span><a id="_idIndexMarker835"/><span class="koboSpan" id="kobo.2134.1"> a technique for </span><a id="_idIndexMarker836"/><span class="koboSpan" id="kobo.2135.1">timing out network connections that take too long to finish </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.2136.1">on the server side</span></strong><span class="koboSpan" id="kobo.2137.1">. </span><span class="koboSpan" id="kobo.2137.2">This is much more important than the client side, as a server with too many open connections might not be able to process additional requests unless some of the already open connections close. </span><span class="koboSpan" id="kobo.2137.3">This usually happens for two reasons. </span><span class="koboSpan" id="kobo.2137.4">The first reason is software bugs, and the second reason is when a server</span><a id="_idIndexMarker837"/><span class="koboSpan" id="kobo.2138.1"> experiences a </span><strong class="keyWord"><span class="koboSpan" id="kobo.2139.1">Denial of Service</span></strong><span class="koboSpan" id="kobo.2140.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2141.1">DoS</span></strong><span class="koboSpan" id="kobo.2142.1">) attack!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2143.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2144.1">main()</span></code><span class="koboSpan" id="kobo.2145.1"> function in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2146.1">timeoutServer.go</span></code><span class="koboSpan" id="kobo.2147.1"> shows the technique:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2148.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2149.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2150.1">()</span></span><span class="koboSpan" id="kobo.2151.1"> {
    PORT := </span><span class="hljs-string"><span class="koboSpan" id="kobo.2152.1">":8001"</span></span><span class="koboSpan" id="kobo.2153.1">
    arguments := os.Args
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2154.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2155.1">len</span></span><span class="koboSpan" id="kobo.2156.1">(arguments) != </span><span class="hljs-number"><span class="koboSpan" id="kobo.2157.1">1</span></span><span class="koboSpan" id="kobo.2158.1"> {
        PORT = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2159.1">":"</span></span><span class="koboSpan" id="kobo.2160.1"> + arguments[</span><span class="hljs-number"><span class="koboSpan" id="kobo.2161.1">1</span></span><span class="koboSpan" id="kobo.2162.1">]
    }
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2163.1">"Using port number: "</span></span><span class="koboSpan" id="kobo.2164.1">, PORT)
    m := http.NewServeMux()
    srv := &amp;http.Server{
        Addr:         PORT,
        Handler:      m,
        ReadTimeout:  </span><span class="hljs-number"><span class="koboSpan" id="kobo.2165.1">3</span></span><span class="koboSpan" id="kobo.2166.1"> * time.Second,
        WriteTimeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.2167.1">3</span></span><span class="koboSpan" id="kobo.2168.1"> * time.Second,
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2169.1">This is where the timeout periods are defined. </span><span class="koboSpan" id="kobo.2169.2">Note that you can define timeout periods for both reading and writing processes. </span><span class="koboSpan" id="kobo.2169.3">The value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2170.1">ReadTimeout</span></code><span class="koboSpan" id="kobo.2171.1"> field specifies the maximum duration allowed to read the entire client request, including the body, whereas the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2172.1">WriteTimeout</span></code><span class="koboSpan" id="kobo.2173.1"> field specifies the maximum time duration before timing out the sending of the client response.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2174.1">    m.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2175.1">"/time"</span></span><span class="koboSpan" id="kobo.2176.1">, timeHandler)
    m.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2177.1">"/"</span></span><span class="koboSpan" id="kobo.2178.1">, myHandler)
    err := srv.ListenAndServe()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2179.1">if</span></span><span class="koboSpan" id="kobo.2180.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2181.1">nil</span></span><span class="koboSpan" id="kobo.2182.1"> {
        fmt.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2183.1">return</span></span><span class="koboSpan" id="kobo.2184.1">
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2185.1">Apart from the parameters in the definition of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2186.1">http.Server</span></code><span class="koboSpan" id="kobo.2187.1">, the rest of the code is as usual: it contains the handler functions and calls </span><code class="inlineCode"><span class="koboSpan" id="kobo.2188.1">ListenAndServe()</span></code><span class="koboSpan" id="kobo.2189.1"> to start the HTTP server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2190.1">Working with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2191.1">timeoutServer.go</span></code><span class="koboSpan" id="kobo.2192.1"> generates no output. </span><span class="koboSpan" id="kobo.2192.2">However, if a client connects to it without sending</span><a id="_idIndexMarker838"/><span class="koboSpan" id="kobo.2193.1"> any requests, the client </span><a id="_idIndexMarker839"/><span class="koboSpan" id="kobo.2194.1">connection will end after 3 seconds. </span><span class="koboSpan" id="kobo.2194.2">The same will happen if it takes the client more than 3 seconds to receive the server response.</span></p>
<h1 class="heading-1" id="_idParaDest-280"><span class="koboSpan" id="kobo.2195.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2196.1">In this chapter, we learned how to work with HTTP and how to create Docker images from Go code, as well as how to develop HTTP clients and servers. </span><span class="koboSpan" id="kobo.2196.2">We have also converted the statistics application into a web application and programmed a command line client for it. </span><span class="koboSpan" id="kobo.2196.3">Additionally, we learned how to time out HTTP connections.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2197.1">We are now ready to begin developing powerful and concurrent HTTP applications —however, we are not done yet with HTTP. </span><em class="chapterRef"><span class="koboSpan" id="kobo.2198.1">Chapter 11</span></em><span class="koboSpan" id="kobo.2199.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2200.1">Working with REST APIs</span></em><span class="koboSpan" id="kobo.2201.1">, is going to connect the dots and show how to develop powerful RESTful servers and clients.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2202.1">But first, we need to learn about working with TCP/IP, TCP, UDP, and WebSocket, which are the subjects of the next chapter.</span></p>
<h1 class="heading-1" id="_idParaDest-281"><span class="koboSpan" id="kobo.2203.1">Exercises</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2204.1">Modify </span><code class="inlineCode"><span class="koboSpan" id="kobo.2205.1">wwwClient.go</span></code><span class="koboSpan" id="kobo.2206.1"> to save the HTML output to an external file.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2207.1">Use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2208.1">sync.Mutex</span></code><span class="koboSpan" id="kobo.2209.1"> in order to avoid race conditions in the statistics application.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2210.1">Implement a simple version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2211.1">ab(1)</span></code><span class="koboSpan" id="kobo.2212.1"> using goroutines and channels. </span><code class="inlineCode"><span class="koboSpan" id="kobo.2213.1">ab(1)</span></code><span class="koboSpan" id="kobo.2214.1"> is an Apache HTTP server benchmarking tool.</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-282"><span class="koboSpan" id="kobo.2215.1">Additional resources</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2216.1">Caddy server: </span><a href="https://caddyserver.com/"><span class="url"><span class="koboSpan" id="kobo.2217.1">https://caddyserver.com/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2218.1">Nginx server: </span><a href="https://nginx.org/en/"><span class="url"><span class="koboSpan" id="kobo.2219.1">https://nginx.org/en/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2220.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2221.1">net/http</span></code><span class="koboSpan" id="kobo.2222.1"> package: </span><a href="https://pkg.go.dev/net/http"><span class="url"><span class="koboSpan" id="kobo.2223.1">https://pkg.go.dev/net/http</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2224.1">Official Docker Go images: </span><a href="https://hub.docker.com/_/golang/ "><span class="url"><span class="koboSpan" id="kobo.2225.1">https://hub.docker.com/_/golang/</span></span></a></li>
</ul>
<h1 class="heading-1"><span class="koboSpan" id="kobo.2226.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2227.1">Join our community’s Discord space for discussions with the authors and other readers:</span></p>
<p class="normal"><a href="https://discord.gg/FzuQbc8zd6 "><span class="url"><span class="koboSpan" id="kobo.2228.1">https://discord.gg/FzuQbc8zd6</span></span></a></p>
<p class="normal"><a href="https://discord.gg/FzuQbc8zd6 "><span class="url"><span class="koboSpan" id="kobo.2229.1"><img alt="" role="presentation" src="../Images/QR_Code2286825896190168453.png"/></span></span></a></p>
</div>
</body></html>