<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer164">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">11</span></h1>
<h1 class="chapterTitle" id="_idParaDest-308"><span class="koboSpan" id="kobo.2.1">Working with REST APIs</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">The subject of this chapter is the development of RESTful servers and clients with the Go programming language, which is one of the many areas where Go excels.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">REST is an acronym for </span><em class="italic"><span class="koboSpan" id="kobo.5.1">REpresentational State Transfer</span></em><span class="koboSpan" id="kobo.6.1"> and is primarily an architecture for designing web services that offers a standardized efficient way for clients to access data and use the provided server functionality.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.7.1">RESTful services usually use the JSON format to exchange information, which is well supported by Go. </span><span class="koboSpan" id="kobo.7.2">REST is not tied to any operating system or system architecture and is not a protocol; however, to implement a RESTful service, we need to use a protocol such as HTTP or HTTPS as REST is an API convention built on the HTTP(S) protocol.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.8.1">Although we are already familiar with most of the presented Go code, the ideas behind REST and the way Go code serves them are going to be new. </span><span class="koboSpan" id="kobo.8.2">The epicenter of the development of RESTful servers is the definition of the appropriate Go structures and the execution of the necessary marshaling and unmarshaling operations for supporting the exchange of JSON data between the clients and the server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.9.1">This truly important and practical chapter covers:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">An introduction to REST</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Developing RESTful servers and clients</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Creating a functional RESTful server</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.13.1">Creating a RESTful client</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-309"><span class="koboSpan" id="kobo.14.1">An introduction to REST</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.15.1">Most modern web applications work by exposing their APIs and allowing clients to use these APIs </span><a id="_idIndexMarker913"/><span class="koboSpan" id="kobo.16.1">to interact and communicate with them. </span><span class="koboSpan" id="kobo.16.2">Although REST is not tied to HTTP, most web services use HTTP as their underlying protocol. </span><span class="koboSpan" id="kobo.16.3">Additionally, although REST can work with any data format, usually REST means </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.17.1">JSON over HTTP</span></strong><span class="koboSpan" id="kobo.18.1"> because most of the time, data is exchanged in JSON format in RESTful services. </span><span class="koboSpan" id="kobo.18.2">There are also times when data is exchanged in plain text format, usually when the exchanged data is simple and there is no practical need for JSON records. </span><span class="koboSpan" id="kobo.18.3">Due to the way a RESTful service works, it should have an architecture that follows the subsequent principles:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.19.1">Client-server design</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.20.1">Stateless implementation (each interaction does not depend on previous ones)</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.21.1">Cacheable</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.22.1">Uniform interface</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.23.1">Layered system</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.24.1">According to </span><a id="_idIndexMarker914"/><span class="koboSpan" id="kobo.25.1">the HTTP protocol, we can perform the following operations on an HTTP server:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.26.1">POST</span></code><span class="koboSpan" id="kobo.27.1">: This is used for creating new resources.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.28.1">GET</span></code><span class="koboSpan" id="kobo.29.1">: This is used for reading (getting) existing resources.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.30.1">PUT</span></code><span class="koboSpan" id="kobo.31.1">: This is used for updating existing resources. </span><span class="koboSpan" id="kobo.31.2">As a convention, a </span><code class="inlineCode"><span class="koboSpan" id="kobo.32.1">PUT</span></code><span class="koboSpan" id="kobo.33.1"> request should contain the full and updated version of an existing resource.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.34.1">DELETE</span></code><span class="koboSpan" id="kobo.35.1">: This is used for deleting existing resources.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.36.1">PATCH</span></code><span class="koboSpan" id="kobo.37.1">: This is used for updating existing resources. </span><span class="koboSpan" id="kobo.37.2">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.38.1">PATCH</span></code><span class="koboSpan" id="kobo.39.1"> request only contains the modifications to an existing resource.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.40.1">The important thing here is that everything you do, especially when it is out of the ordinary, must be well documented. </span><span class="koboSpan" id="kobo.40.2">As a reference, keep in mind that the HTTP methods supported by Go are defined as constants in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.41.1">net/http</span></code><span class="koboSpan" id="kobo.42.1"> package:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.43.1">const</span></span><span class="koboSpan" id="kobo.44.1"> (
    MethodGet     = </span><span class="hljs-string"><span class="koboSpan" id="kobo.45.1">"GET"</span></span><span class="koboSpan" id="kobo.46.1">
    MethodHead    = </span><span class="hljs-string"><span class="koboSpan" id="kobo.47.1">"HEAD"</span></span><span class="koboSpan" id="kobo.48.1">
    MethodPost    = </span><span class="hljs-string"><span class="koboSpan" id="kobo.49.1">"POST"</span></span><span class="koboSpan" id="kobo.50.1">
    MethodPut     = </span><span class="hljs-string"><span class="koboSpan" id="kobo.51.1">"PUT"</span></span><span class="koboSpan" id="kobo.52.1">
    MethodPatch   = </span><span class="hljs-string"><span class="koboSpan" id="kobo.53.1">"PATCH"</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.54.1">// RFC 5789</span></span><span class="koboSpan" id="kobo.55.1">
    MethodDelete  = </span><span class="hljs-string"><span class="koboSpan" id="kobo.56.1">"DELETE"</span></span><span class="koboSpan" id="kobo.57.1">
    MethodConnect = </span><span class="hljs-string"><span class="koboSpan" id="kobo.58.1">"CONNECT"</span></span><span class="koboSpan" id="kobo.59.1">
    MethodOptions = </span><span class="hljs-string"><span class="koboSpan" id="kobo.60.1">"OPTIONS"</span></span><span class="koboSpan" id="kobo.61.1">
    MethodTrace   = </span><span class="hljs-string"><span class="koboSpan" id="kobo.62.1">"TRACE"</span></span><span class="koboSpan" id="kobo.63.1">
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.64.1">There also </span><a id="_idIndexMarker915"/><span class="koboSpan" id="kobo.65.1">exist conventions regarding the returning HTTP status code of each client request. </span><span class="koboSpan" id="kobo.65.2">The most popular HTTP status codes as well as their meanings are the following:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">200</span></code><span class="koboSpan" id="kobo.67.1"> means that everything went well and the specified action was executed successfully.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.68.1">201</span></code><span class="koboSpan" id="kobo.69.1"> means that the wanted resource was created.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.70.1">202</span></code><span class="koboSpan" id="kobo.71.1"> means that the request was accepted and is currently being processed. </span><span class="koboSpan" id="kobo.71.2">This is usually used when an action takes too much time to complete.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.72.1">301</span></code><span class="koboSpan" id="kobo.73.1"> means that the requested resource has been moved permanentlyâ€”the new URI should be part of the response. </span><span class="koboSpan" id="kobo.73.2">This is rarely used in RESTful services because API versioning is used instead. </span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.74.1">400</span></code><span class="koboSpan" id="kobo.75.1"> means that there was a bad request and that you should change your initial request before sending it again.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.76.1">401</span></code><span class="koboSpan" id="kobo.77.1"> means that the client tried to access a protected request without authorization.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.78.1">403</span></code><span class="koboSpan" id="kobo.79.1"> means that the client does not have the required permissions for accessing a resource even though the client is properly authorized. </span><span class="koboSpan" id="kobo.79.2">In UNIX terminology, </span><code class="inlineCode"><span class="koboSpan" id="kobo.80.1">403</span></code><span class="koboSpan" id="kobo.81.1"> means that the current user does not have the required privileges to perform an action.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.82.1">404</span></code><span class="koboSpan" id="kobo.83.1"> means that the resource was not found.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.84.1">405</span></code><span class="koboSpan" id="kobo.85.1"> means that the client used a method that is not allowed by the type of resource.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.86.1">500</span></code><span class="koboSpan" id="kobo.87.1"> means internal server errorâ€”it probably indicates a server failure.</span></li>
</ul>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.88.1">If you </span><a id="_idIndexMarker916"/><span class="koboSpan" id="kobo.89.1">want to learn more about the HTTP protocol, you should visit RFC 7231 at </span><a href="https://datatracker.ietf.org/doc/html/rfc7231"><span class="url"><span class="koboSpan" id="kobo.90.1">https://datatracker.ietf.org/doc/html/rfc7231</span></span></a><span class="koboSpan" id="kobo.91.1">.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.92.1">Now, let me tell you a personal story. </span><span class="koboSpan" id="kobo.92.2">A couple of years ago, I was developing a small RESTful client for a project I was working on. </span><span class="koboSpan" id="kobo.92.3">The client connected to a given server in order to get a list of usernames. </span><span class="koboSpan" id="kobo.92.4">For each username, I had to get a list of login and logout times by hitting another endpoint.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.93.1">What I can tell you from my personal experience is that most of the Go code was not about interacting with the RESTful server but about taking care of the data, transforming it to the desired format, and storing it in a databaseâ€”the two most tricky tasks that I needed to perform were getting a date and time in UNIX epoch format and truncating the information about the minutes and seconds from that epoch time, as well as inserting </span><a id="_idIndexMarker917"/><span class="koboSpan" id="kobo.94.1">a new record into a database table after making sure that a record with the same data was not already stored in that database. </span><span class="koboSpan" id="kobo.94.2">So, expect that most of the code you are going to write is going to be about confronting the logic of the service, which is true not only for RESTful services but for all services in general.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.95.1">The first section of this chapter contains general yet essential information about programming RESTful servers and clients.</span></p>
<h1 class="heading-1" id="_idParaDest-310"><span class="koboSpan" id="kobo.96.1">Developing RESTful servers and clients</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.97.1">This section is going to develop a RESTful server and a client for that server using the functionality </span><a id="_idIndexMarker918"/><span class="koboSpan" id="kobo.98.1">of the Go standard library to understand how things </span><a id="_idIndexMarker919"/><span class="koboSpan" id="kobo.99.1">really work behind the scenes. </span><span class="koboSpan" id="kobo.99.2">The functionality of the server is described in the following list of endpoints:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.100.1">/add</span></code><span class="koboSpan" id="kobo.101.1">: This endpoint is for adding new entries to the server.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.102.1">/delete</span></code><span class="koboSpan" id="kobo.103.1">: This endpoint is used for deleting an existing entry.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.104.1">/get</span></code><span class="koboSpan" id="kobo.105.1">: This endpoint is for getting information about an entry that already exists.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.106.1">/time</span></code><span class="koboSpan" id="kobo.107.1">: This endpoint returns the current date and time and is mainly used for testing the operation of the RESTful server.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.108.1">/</span></code><span class="koboSpan" id="kobo.109.1">: This endpoint is used for serving any request that is not a match to any other endpoint.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.110.1">An alternative and more professional way of defining the endpoints would have been the following:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.111.1">/users/</span></code><span class="koboSpan" id="kobo.112.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.113.1">GET</span></code><span class="koboSpan" id="kobo.114.1"> method: Get a list of all users.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.115.1">/users/:id</span></code><span class="koboSpan" id="kobo.116.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.117.1">GET</span></code><span class="koboSpan" id="kobo.118.1"> method: Get information about the user with the given ID value.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.119.1">/users/:id</span></code><span class="koboSpan" id="kobo.120.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.121.1">DELETE</span></code><span class="koboSpan" id="kobo.122.1"> method: Delete the user with the given ID.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.123.1">/users/</span></code><span class="koboSpan" id="kobo.124.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.125.1">POST</span></code><span class="koboSpan" id="kobo.126.1"> method: Create a new user.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.127.1">/users/:id</span></code><span class="koboSpan" id="kobo.128.1"> with either the </span><code class="inlineCode"><span class="koboSpan" id="kobo.129.1">PATCH</span></code><span class="koboSpan" id="kobo.130.1"> or the </span><code class="inlineCode"><span class="koboSpan" id="kobo.131.1">PUT</span></code><span class="koboSpan" id="kobo.132.1"> method: Update the user with the given ID value.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.133.1">The implementation of the alternative way is left as an exercise for the readerâ€”it should not </span><a id="_idIndexMarker920"/><span class="koboSpan" id="kobo.134.1">be that difficult to implement it given that the Go </span><a id="_idIndexMarker921"/><span class="koboSpan" id="kobo.135.1">code for the handlers is going to be the same and you must only redefine the part where we specify the handling of the endpoints.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.136.1">The next subsection presents the implementation of the RESTful server.</span></p>
<h2 class="heading-2" id="_idParaDest-311"><span class="koboSpan" id="kobo.137.1">A RESTful server</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.138.1">The purpose of the presented implementation is to understand how things work behind the scenes because the principles behind REST services remain the same.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.139.1">The logic </span><a id="_idIndexMarker922"/><span class="koboSpan" id="kobo.140.1">behind each handler function is simple. </span><span class="koboSpan" id="kobo.140.2">Each function reads user input and decides whether the given input and HTTP method are the desired ones before processing any data.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.141.1">The principles of each client interaction are also simple: The server should send appropriate error messages and HTTP codes back to the client so that everyone knows what really happened. </span><span class="koboSpan" id="kobo.141.2">Lastly, everything should be documented to communicate in a common language.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.142.1">The code of the server, which is saved as </span><code class="inlineCode"><span class="koboSpan" id="kobo.143.1">rServer.go</span></code><span class="koboSpan" id="kobo.144.1">, is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.145.1">package</span></span><span class="koboSpan" id="kobo.146.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.147.1">import</span></span><span class="koboSpan" id="kobo.148.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.149.1">"encoding/json"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.150.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.151.1">"io"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.152.1">"log"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.153.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.154.1">"os"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.155.1">"time"</span></span><span class="koboSpan" id="kobo.156.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.157.1">type</span></span><span class="koboSpan" id="kobo.158.1"> User </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.159.1">struct</span></span><span class="koboSpan" id="kobo.160.1"> {
    Username </span><span class="hljs-type"><span class="koboSpan" id="kobo.161.1">string</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.162.1">`json:"user"`</span></span><span class="koboSpan" id="kobo.163.1">
    Password </span><span class="hljs-type"><span class="koboSpan" id="kobo.164.1">string</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.165.1">`json:"password"`</span></span><span class="koboSpan" id="kobo.166.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.167.1">This is a structure that holds user data, so the use of JSON tags is mandatory as the JSON data format is different from the one we use in Go.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.168.1">var</span></span><span class="koboSpan" id="kobo.169.1"> user User
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.170.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.171.1">user</span></code><span class="koboSpan" id="kobo.172.1"> global variable holds the user data of the current interactionâ€”this is the input for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.173.1">/add</span></code><span class="koboSpan" id="kobo.174.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.175.1">/get</span></code><span class="koboSpan" id="kobo.176.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.177.1">/delete</span></code><span class="koboSpan" id="kobo.178.1"> endpoints and their simplistic implementations. </span><span class="koboSpan" id="kobo.178.2">As this global variable is shared by the entire program, our code is not concurrently safe, which is fine for a RESTful server used as a proof of concept.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.179.1">// PORT is where the web server listens to</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.180.1">var</span></span><span class="koboSpan" id="kobo.181.1"> PORT = </span><span class="hljs-string"><span class="koboSpan" id="kobo.182.1">":1234"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.183.1">A RESTful </span><a id="_idIndexMarker923"/><span class="koboSpan" id="kobo.184.1">server is just an HTTP server, so we need to define the TCP port number the server listens to.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.185.1">// DATA is the map that holds User records</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.186.1">var</span></span><span class="koboSpan" id="kobo.187.1"> DATA = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.188.1">make</span></span><span class="koboSpan" id="kobo.189.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.190.1">map</span></span><span class="koboSpan" id="kobo.191.1">[</span><span class="hljs-type"><span class="koboSpan" id="kobo.192.1">string</span></span><span class="koboSpan" id="kobo.193.1">]</span><span class="hljs-type"><span class="koboSpan" id="kobo.194.1">string</span></span><span class="koboSpan" id="kobo.195.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.196.1">The preceding code defines a global variable named </span><code class="inlineCode"><span class="koboSpan" id="kobo.197.1">DATA</span></code><span class="koboSpan" id="kobo.198.1"> that holds the data of the service.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.199.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.200.1">defaultHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.201.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.202.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.203.1">"Serving:"</span></span><span class="koboSpan" id="kobo.204.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.205.1">"from"</span></span><span class="koboSpan" id="kobo.206.1">, r.Host)
    w.WriteHeader(http.StatusNotFound)
    body := </span><span class="hljs-string"><span class="koboSpan" id="kobo.207.1">"Thanks for visiting!\n"</span></span><span class="koboSpan" id="kobo.208.1">
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.209.1">"%s"</span></span><span class="koboSpan" id="kobo.210.1">, body)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.211.1">This is the default handler of the service. </span><span class="koboSpan" id="kobo.211.2">On a production server, the default handler might print instructions about the operation of the server as well as the list of available endpoints.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.212.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.213.1">timeHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.214.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.215.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.216.1">"Serving:"</span></span><span class="koboSpan" id="kobo.217.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.218.1">"from"</span></span><span class="koboSpan" id="kobo.219.1">, r.Host)
    t := time.Now().Format(time.RFC1123)
    body := </span><span class="hljs-string"><span class="koboSpan" id="kobo.220.1">"The current time is: "</span></span><span class="koboSpan" id="kobo.221.1"> + t + </span><span class="hljs-string"><span class="koboSpan" id="kobo.222.1">"\n"</span></span><span class="koboSpan" id="kobo.223.1">
    fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.224.1">"%s"</span></span><span class="koboSpan" id="kobo.225.1">, body)
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.226.1">timeHandler()</span></code><span class="koboSpan" id="kobo.227.1"> is another simple handler that returns the current date and timeâ€”such modest handlers are usually used for testing the health of the server and are usually removed in the production version. </span><span class="koboSpan" id="kobo.227.2">A very popular endpoint with a similar purpose is </span><code class="inlineCode"><span class="koboSpan" id="kobo.228.1">/health</span></code><span class="koboSpan" id="kobo.229.1">, which is usually present in modern REST APIs with the purpose of providing a health status for the server, even in production.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.230.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.231.1">addHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.232.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.233.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.234.1">"Serving:"</span></span><span class="koboSpan" id="kobo.235.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.236.1">"from"</span></span><span class="koboSpan" id="kobo.237.1">, r.Host, r.Method)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.238.1">if</span></span><span class="koboSpan" id="kobo.239.1"> r.Method != http.MethodPost {
        fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.240.1">"%s\n"</span></span><span class="koboSpan" id="kobo.241.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.242.1">"Method not allowed!"</span></span><span class="koboSpan" id="kobo.243.1">)
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.244.1">"Error:"</span></span><span class="koboSpan" id="kobo.245.1">, http.StatusMethodNotAllowed)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.246.1">return</span></span><span class="koboSpan" id="kobo.247.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.248.1">This is the first time that you are seeing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.249.1">http.Error()</span></code><span class="koboSpan" id="kobo.250.1"> function. </span><span class="koboSpan" id="kobo.250.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.251.1">http.Error()</span></code><span class="koboSpan" id="kobo.252.1"> function sends </span><a id="_idIndexMarker924"/><span class="koboSpan" id="kobo.253.1">a reply to the client request that includes the specified error message, which should be in plain text, as well as the desired HTTP code. </span><span class="koboSpan" id="kobo.253.2">You still need to write the data you want to send back to the client using an </span><code class="inlineCode"><span class="koboSpan" id="kobo.254.1">fmt.Fprintf()</span></code><span class="koboSpan" id="kobo.255.1"> statement. </span><span class="koboSpan" id="kobo.255.2">However, </span><code class="inlineCode"><span class="koboSpan" id="kobo.256.1">http.Error()</span></code><span class="koboSpan" id="kobo.257.1"> needs to be called last as we should not perform any more writes to </span><code class="inlineCode"><span class="koboSpan" id="kobo.258.1">w</span></code><span class="koboSpan" id="kobo.259.1"> after using </span><code class="inlineCode"><span class="koboSpan" id="kobo.260.1">http.Error()</span></code><span class="koboSpan" id="kobo.261.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.262.1">    d, err := io.ReadAll(r.Body)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.263.1">if</span></span><span class="koboSpan" id="kobo.264.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.265.1">nil</span></span><span class="koboSpan" id="kobo.266.1"> {
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.267.1">"Error:"</span></span><span class="koboSpan" id="kobo.268.1">, http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.269.1">return</span></span><span class="koboSpan" id="kobo.270.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.271.1">We try to read all data from the client at once using </span><code class="inlineCode"><span class="koboSpan" id="kobo.272.1">io.ReadAll()</span></code><span class="koboSpan" id="kobo.273.1"> and we make sure that we read the data without any errors by checking the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.274.1">d</span></code><span class="koboSpan" id="kobo.275.1"> variable returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.276.1">io.ReadAll(r.Body)</span></code><span class="koboSpan" id="kobo.277.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.278.1">    err = json.Unmarshal(d, &amp;user)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.279.1">if</span></span><span class="koboSpan" id="kobo.280.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.281.1">nil</span></span><span class="koboSpan" id="kobo.282.1"> {
        log.Println(err)
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.283.1">"Error:"</span></span><span class="koboSpan" id="kobo.284.1">, http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.285.1">return</span></span><span class="koboSpan" id="kobo.286.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.287.1">After reading the data from the client, we put it into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.288.1">user</span></code><span class="koboSpan" id="kobo.289.1"> global variable â€“ although using global variables is not considered a good practice, I personally prefer to use global variables for important settings or data that needs to be shared among a Go source file when dealing with relatively small Go source code files. </span><span class="koboSpan" id="kobo.289.2">Where you want to store the data and what to do with it is decided by the server. </span><span class="koboSpan" id="kobo.289.3">There is no rule on how to interpret the data. </span><span class="koboSpan" id="kobo.289.4">Therefore, </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.290.1">the client should communicate with the server according to the wishes of the server</span></strong><span class="koboSpan" id="kobo.291.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.292.1">if</span></span><span class="koboSpan" id="kobo.293.1"> user.Username == </span><span class="hljs-string"><span class="koboSpan" id="kobo.294.1">""</span></span><span class="koboSpan" id="kobo.295.1"> {
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.296.1">"Error:"</span></span><span class="koboSpan" id="kobo.297.1">, http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.298.1">return</span></span><span class="koboSpan" id="kobo.299.1">
    }
    DATA[user.Username] = user.Password
    log.Println(DATA)
    w.WriteHeader(http.StatusCreated)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.300.1">If the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.301.1">Username</span></code><span class="koboSpan" id="kobo.302.1"> field is not empty, add the new structure to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.303.1">DATA</span></code><span class="koboSpan" id="kobo.304.1"> map. </span><span class="koboSpan" id="kobo.304.2">Data persistence is </span><a id="_idIndexMarker925"/><span class="koboSpan" id="kobo.305.1">not implemented for this sample serverâ€”each time you restart the RESTful server, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.306.1">DATA</span></code><span class="koboSpan" id="kobo.307.1"> map is initialized from scratch.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.308.1">If the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.309.1">username</span></code><span class="koboSpan" id="kobo.310.1"> field is empty, then we cannot add it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.311.1">DATA</span></code><span class="koboSpan" id="kobo.312.1"> map and the operation fails with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.313.1">http.StatusBadRequest</span></code><span class="koboSpan" id="kobo.314.1"> code.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.315.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.316.1">getHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.317.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.318.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.319.1">"Serving:"</span></span><span class="koboSpan" id="kobo.320.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.321.1">"from"</span></span><span class="koboSpan" id="kobo.322.1">, r.Host, r.Method)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.323.1">if</span></span><span class="koboSpan" id="kobo.324.1"> r.Method != http.MethodGet {
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.325.1">"Error:"</span></span><span class="koboSpan" id="kobo.326.1">, http.StatusMethodNotAllowed)
        fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.327.1">"%s\n"</span></span><span class="koboSpan" id="kobo.328.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.329.1">"Method not allowed!"</span></span><span class="koboSpan" id="kobo.330.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.331.1">return</span></span><span class="koboSpan" id="kobo.332.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.333.1">For the </span><code class="inlineCode"><span class="koboSpan" id="kobo.334.1">/get</span></code><span class="koboSpan" id="kobo.335.1"> endpoint, we need to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.336.1">http.MethodGet</span></code><span class="koboSpan" id="kobo.337.1">, so we have to make sure that this condition is met (</span><code class="inlineCode"><span class="koboSpan" id="kobo.338.1">if r.Method != http.MethodGet</span></code><span class="koboSpan" id="kobo.339.1">).</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.340.1">    d, err := io.ReadAll(r.Body)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.341.1">if</span></span><span class="koboSpan" id="kobo.342.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.343.1">nil</span></span><span class="koboSpan" id="kobo.344.1"> {
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.345.1">"ReadAll - Error"</span></span><span class="koboSpan" id="kobo.346.1">, http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.347.1">return</span></span><span class="koboSpan" id="kobo.348.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.349.1">After that, we still need to make sure that we can read the data from the client request without any issues.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.350.1">    err = json.Unmarshal(d, &amp;user)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.351.1">if</span></span><span class="koboSpan" id="kobo.352.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.353.1">nil</span></span><span class="koboSpan" id="kobo.354.1"> {
        log.Println(err)
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.355.1">"Unmarshal - Error"</span></span><span class="koboSpan" id="kobo.356.1">, http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.357.1">return</span></span><span class="koboSpan" id="kobo.358.1">
    }
    fmt.Println(user)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.359.1">Then, we use the client data and put it into a </span><code class="inlineCode"><span class="koboSpan" id="kobo.360.1">User</span></code><span class="koboSpan" id="kobo.361.1"> structure (the </span><code class="inlineCode"><span class="koboSpan" id="kobo.362.1">user</span></code><span class="koboSpan" id="kobo.363.1"> global variable). </span><span class="koboSpan" id="kobo.363.2">Once again, I have to mention that using a global variable for storing the data is a personal preference that works well for smaller source code files but should be avoided for larger programs.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.364.1">    _, ok := DATA[user.Username]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.365.1">if</span></span><span class="koboSpan" id="kobo.366.1"> ok &amp;&amp; user.Username != </span><span class="hljs-string"><span class="koboSpan" id="kobo.367.1">""</span></span><span class="koboSpan" id="kobo.368.1"> {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.369.1">"Found!"</span></span><span class="koboSpan" id="kobo.370.1">)
        w.WriteHeader(http.StatusOK)
        fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.371.1">"%s\n"</span></span><span class="koboSpan" id="kobo.372.1">, d)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.373.1">If the desired </span><a id="_idIndexMarker926"/><span class="koboSpan" id="kobo.374.1">user record is found, we send it back to the client using the data stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.375.1">d</span></code><span class="koboSpan" id="kobo.376.1"> variableâ€”remember that </span><code class="inlineCode"><span class="koboSpan" id="kobo.377.1">d</span></code><span class="koboSpan" id="kobo.378.1"> was initialized in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.379.1">io.ReadAll(r.Body)</span></code><span class="koboSpan" id="kobo.380.1"> call and already contains a JSON record that is marshaled.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.381.1">    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.382.1">else</span></span><span class="koboSpan" id="kobo.383.1"> {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.384.1">"Not found!"</span></span><span class="koboSpan" id="kobo.385.1">)
        w.WriteHeader(http.StatusNotFound)
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.386.1">"Map - Resource not found!"</span></span><span class="koboSpan" id="kobo.387.1">, http.StatusNotFound)
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.388.1">return</span></span><span class="koboSpan" id="kobo.389.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.390.1">Otherwise, we inform the client that the desired record was not found and return </span><code class="inlineCode"><span class="koboSpan" id="kobo.391.1">http.StatusNotFound</span></code><span class="koboSpan" id="kobo.392.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.393.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.394.1">deleteHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.395.1">(w http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.396.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.397.1">"Serving:"</span></span><span class="koboSpan" id="kobo.398.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.399.1">"from"</span></span><span class="koboSpan" id="kobo.400.1">, r.Host, r.Method)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.401.1">if</span></span><span class="koboSpan" id="kobo.402.1"> r.Method != http.MethodDelete {
        fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.403.1">"%s\n"</span></span><span class="koboSpan" id="kobo.404.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.405.1">"Method not allowed!"</span></span><span class="koboSpan" id="kobo.406.1">)
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.407.1">"Error:"</span></span><span class="koboSpan" id="kobo.408.1">, http.StatusMethodNotAllowed)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.409.1">return</span></span><span class="koboSpan" id="kobo.410.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.411.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.412.1">DELETE</span></code><span class="koboSpan" id="kobo.413.1"> HTTP method looks like a rational choice when deleting a resource, hence the </span><code class="inlineCode"><span class="koboSpan" id="kobo.414.1">r.Method != http.MethodDelete</span></code><span class="koboSpan" id="kobo.415.1"> check.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.416.1">    d, err := io.ReadAll(r.Body)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.417.1">if</span></span><span class="koboSpan" id="kobo.418.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.419.1">nil</span></span><span class="koboSpan" id="kobo.420.1"> {
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.421.1">"ReadAll - Error"</span></span><span class="koboSpan" id="kobo.422.1">, http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.423.1">return</span></span><span class="koboSpan" id="kobo.424.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.425.1">Again, we read the client input and store it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.426.1">d</span></code><span class="koboSpan" id="kobo.427.1"> variable.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.428.1">    err = json.Unmarshal(d, &amp;user)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.429.1">if</span></span><span class="koboSpan" id="kobo.430.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.431.1">nil</span></span><span class="koboSpan" id="kobo.432.1"> {
        log.Println(err)
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.433.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.434.1">Unmarshal - Error"</span></span><span class="koboSpan" id="kobo.435.1">, http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.436.1">return</span></span><span class="koboSpan" id="kobo.437.1">
    }
    log.Println(user)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.438.1">It is considered </span><a id="_idIndexMarker927"/><span class="koboSpan" id="kobo.439.1">a good practice to keep additional logging information when deleting resources.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.440.1">    _, ok := DATA[user.Username]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.441.1">if</span></span><span class="koboSpan" id="kobo.442.1"> ok &amp;&amp; user.Username != </span><span class="hljs-string"><span class="koboSpan" id="kobo.443.1">""</span></span><span class="koboSpan" id="kobo.444.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.445.1">if</span></span><span class="koboSpan" id="kobo.446.1"> user.Password == DATA[user.Username] {
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.447.1">For the delete process, we make sure that both the given username and password values are the same as the ones that exist in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.448.1">DATA</span></code><span class="koboSpan" id="kobo.449.1"> map before deleting the relevant entry.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-built_in"><span class="koboSpan" id="kobo.450.1">delete</span></span><span class="koboSpan" id="kobo.451.1">(DATA, user.Username)
            w.WriteHeader(http.StatusOK)
            fmt.Fprintf(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.452.1">"%s\n"</span></span><span class="koboSpan" id="kobo.453.1">, d)
            log.Println(DATA)
        }
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.454.1">else</span></span><span class="koboSpan" id="kobo.455.1"> {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.456.1">"User"</span></span><span class="koboSpan" id="kobo.457.1">, user.Username, </span><span class="hljs-string"><span class="koboSpan" id="kobo.458.1">"Not found!"</span></span><span class="koboSpan" id="kobo.459.1">)
        w.WriteHeader(http.StatusNotFound)
        http.Error(w, </span><span class="hljs-string"><span class="koboSpan" id="kobo.460.1">"Resource not found!"</span></span><span class="koboSpan" id="kobo.461.1">, http.StatusNotFound)
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.462.1">return</span></span><span class="koboSpan" id="kobo.463.1">
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.464.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.465.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.466.1">()</span></span><span class="koboSpan" id="kobo.467.1"> {
    arguments := os.Args
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.468.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.469.1">len</span></span><span class="koboSpan" id="kobo.470.1">(arguments) != </span><span class="hljs-number"><span class="koboSpan" id="kobo.471.1">1</span></span><span class="koboSpan" id="kobo.472.1"> {
        PORT = </span><span class="hljs-string"><span class="koboSpan" id="kobo.473.1">":"</span></span><span class="koboSpan" id="kobo.474.1"> + arguments[</span><span class="hljs-number"><span class="koboSpan" id="kobo.475.1">1</span></span><span class="koboSpan" id="kobo.476.1">]
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.477.1">The previous code presents a technique for defining the TCP port number of a web server while having a default value at hand. </span><span class="koboSpan" id="kobo.477.2">So, if there are no command line arguments, the default value will be used. </span><span class="koboSpan" id="kobo.477.3">Otherwise, the value given as a command line argument is used.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.478.1">    mux := http.NewServeMux()
    s := &amp;http.Server{
        Addr:         PORT,
        Handler:      mux,
        IdleTimeout:  </span><span class="hljs-number"><span class="koboSpan" id="kobo.479.1">10</span></span><span class="koboSpan" id="kobo.480.1"> * time.Second,
        ReadTimeout:  time.Second,
        WriteTimeout: time.Second,
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.481.1">The preceding </span><a id="_idIndexMarker928"/><span class="koboSpan" id="kobo.482.1">code block includes the details and the options for the web server.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.483.1">    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.484.1">"/time"</span></span><span class="koboSpan" id="kobo.485.1">, http.HandlerFunc(timeHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.486.1">"/add"</span></span><span class="koboSpan" id="kobo.487.1">, http.HandlerFunc(addHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.488.1">"/get"</span></span><span class="koboSpan" id="kobo.489.1">, http.HandlerFunc(getHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.490.1">"/delete"</span></span><span class="koboSpan" id="kobo.491.1">, http.HandlerFunc(deleteHandler))
    mux.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.492.1">"/"</span></span><span class="koboSpan" id="kobo.493.1">, http.HandlerFunc(defaultHandler))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.494.1">The previous code defines the endpoints of the web serverâ€”nothing special here as a RESTful server implements an HTTP server behind the scenes.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.495.1">    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.496.1">"Ready to serve at"</span></span><span class="koboSpan" id="kobo.497.1">, PORT)
    err := s.ListenAndServe()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.498.1">if</span></span><span class="koboSpan" id="kobo.499.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.500.1">nil</span></span><span class="koboSpan" id="kobo.501.1"> {
        fmt.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.502.1">return</span></span><span class="koboSpan" id="kobo.503.1">
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.504.1">The last step is about running the web server with the predefined options, which is common practice. </span><span class="koboSpan" id="kobo.504.2">After that, we test the RESTful server using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.505.1">curl(1)</span></code><span class="koboSpan" id="kobo.506.1"> utility, which is very handy when we do not have a client and we want to test the operation of a RESTful serverâ€”the good thing is that </span><code class="inlineCode"><span class="koboSpan" id="kobo.507.1">curl(1)</span></code><span class="koboSpan" id="kobo.508.1"> can send and receive JSON data.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.509.1">When working with a RESTful server, we need to add </span><code class="inlineCode"><span class="koboSpan" id="kobo.510.1">-H 'Content-Type: application/json'</span></code><span class="koboSpan" id="kobo.511.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.512.1">curl(1)</span></code><span class="koboSpan" id="kobo.513.1"> to specify that we are going to work using the JSON format. </span><span class="koboSpan" id="kobo.513.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.514.1">-d</span></code><span class="koboSpan" id="kobo.515.1"> option is used for passing data to a server and is equivalent to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.516.1">--data</span></code><span class="koboSpan" id="kobo.517.1"> option, whereas the </span><code class="inlineCode"><span class="koboSpan" id="kobo.518.1">-v</span></code><span class="koboSpan" id="kobo.519.1"> option generates more verbose output if we need more details to understand what is going on.</span></p>
</div>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.520.1">$ </span></span><span class="koboSpan" id="kobo.521.1">curl localhost:1234/
Thanks for visiting!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.522.1">The first </span><a id="_idIndexMarker929"/><span class="koboSpan" id="kobo.523.1">interaction with the RESTful server is to make sure that the server works as expected. </span><span class="koboSpan" id="kobo.523.2">The next interaction is for adding a new user to the serverâ€”the details of the user are in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.524.1">{"user": "mtsouk", "password" : "admin"}</span></code><span class="koboSpan" id="kobo.525.1"> JSON record:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.526.1">$ </span></span><span class="koboSpan" id="kobo.527.1">curl -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.528.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.529.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.530.1">'{"user": "mtsouk", "password" : "admin"}'</span></span><span class="koboSpan" id="kobo.531.1"> http://localhost:1234/add -v
*   Trying ::1...
</span><span class="koboSpan" id="kobo.531.2">* TCP_NODELAY set
* Connected to localhost (::1) port 1234 (#0)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.532.1">The previous output shows that </span><code class="inlineCode"><span class="koboSpan" id="kobo.533.1">curl(1)</span></code><span class="koboSpan" id="kobo.534.1"> has successfully connected to the server (</span><code class="inlineCode"><span class="koboSpan" id="kobo.535.1">localhost</span></code><span class="koboSpan" id="kobo.536.1">) using the desired TCP port (</span><code class="inlineCode"><span class="koboSpan" id="kobo.537.1">1234</span></code><span class="koboSpan" id="kobo.538.1">).</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.539.1">&gt; </span></span><span class="koboSpan" id="kobo.540.1">POST /add HTTP/1.1
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.541.1">&gt; </span></span><span class="koboSpan" id="kobo.542.1">Host: localhost:1234
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.543.1">&gt; </span></span><span class="koboSpan" id="kobo.544.1">User-Agent: curl/7.64.1
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.545.1">&gt; </span></span><span class="koboSpan" id="kobo.546.1">Accept: */*
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.547.1">&gt; </span></span><span class="koboSpan" id="kobo.548.1">Content-Type: application/json
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.549.1">&gt; </span></span><span class="koboSpan" id="kobo.550.1">Content-Length: 40
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.551.1">The previous output shows that </span><code class="inlineCode"><span class="koboSpan" id="kobo.552.1">curl(1)</span></code><span class="koboSpan" id="kobo.553.1"> is going to send data using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.554.1">POST</span></code><span class="koboSpan" id="kobo.555.1"> method and the length of the data is 40 bytes.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.556.1">&gt;</span></span><span class="koboSpan" id="kobo.557.1">
&lt; HTTP/1.1 200 OK
&lt; Date: Sat, 28 Oct 2023 19:56:45 GMT
&lt; Content-Length: 0
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.558.1">The previous output tells us that the data was sent and that the body of the server response is </span><code class="inlineCode"><span class="koboSpan" id="kobo.559.1">0</span></code><span class="koboSpan" id="kobo.560.1"> bytes.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.561.1">&lt;
* Connection #0 to host localhost left intact
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.562.1">The last part of the output tells us that after sending the data to the server, the connection was closed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.563.1">If we try to add the same user, the RESTful server is not going to complain:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.564.1">$ </span></span><span class="koboSpan" id="kobo.565.1">curl -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.566.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.567.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.568.1">'{"user": "mtsouk", "password" : "admin"}'</span></span><span class="koboSpan" id="kobo.569.1"> http://localhost:1234/add
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.570.1">Although this behavior might not be perfect, it is good if it is documented. </span><span class="koboSpan" id="kobo.570.2">This is not allowed on a </span><a id="_idIndexMarker930"/><span class="koboSpan" id="kobo.571.1">production server, but it is acceptable when experimenting. </span><span class="koboSpan" id="kobo.571.2">So, we are diverting from a standard practice here and you should not do that in production.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.572.1">$ </span></span><span class="koboSpan" id="kobo.573.1">curl -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.574.1">'</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.575.1">Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.576.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.577.1">'{"user": "mihalis", "password" : "admin"}'</span></span><span class="koboSpan" id="kobo.578.1"> http://localhost:1234/add
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.579.1">With the preceding command, we add another user as specified by </span><code class="inlineCode"><span class="koboSpan" id="kobo.580.1">{"user": "mihalis", "password" : "admin"}</span></code><span class="koboSpan" id="kobo.581.1">.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.582.1">$ </span></span><span class="koboSpan" id="kobo.583.1">curl -H -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.584.1">'{"user": "admin"}'</span></span><span class="koboSpan" id="kobo.585.1"> http://localhost:1234/add
curl: (3) URL using bad/illegal format or missing URL
Error:
Method not allowed!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.586.1">The previous output shows an erroneous interaction where </span><code class="inlineCode"><span class="koboSpan" id="kobo.587.1">-H</span></code><span class="koboSpan" id="kobo.588.1"> is not followed by a value. </span><span class="koboSpan" id="kobo.588.2">Although the request is sent to the server, it is rejected because </span><code class="inlineCode"><span class="koboSpan" id="kobo.589.1">/add</span></code><span class="koboSpan" id="kobo.590.1"> does not use the default HTTP method.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.591.1">$ </span></span><span class="koboSpan" id="kobo.592.1">curl -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.593.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.594.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.595.1">'</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.596.1">{"user": "admin", "password": "admin"}'</span></span><span class="koboSpan" id="kobo.597.1"> http://localhost:1234/get
Error:
Method not allowed!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.598.1">This time, the curl command is correct, but the HTTP method used is not set correctly. </span><span class="koboSpan" id="kobo.598.2">Therefore, the request is not served.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.599.1">$ </span></span><span class="koboSpan" id="kobo.600.1">curl -X GET -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.601.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.602.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.603.1">'{"user": "admin", "password" : "admin"}'</span></span><span class="koboSpan" id="kobo.604.1"> http://localhost:1234/get
Map - Resource not found!
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.605.1">$ </span></span><span class="koboSpan" id="kobo.606.1">curl -X GET -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.607.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.608.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.609.1">'{"user": "mtsouk", "password" : "admin"}'</span></span><span class="koboSpan" id="kobo.610.1"> http://localhost:1234/get
{"user": "mtsouk", "password" : "admin"}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.611.1">The previous two interactions use </span><code class="inlineCode"><span class="koboSpan" id="kobo.612.1">/get</span></code><span class="koboSpan" id="kobo.613.1"> to get information about an existing user. </span><span class="koboSpan" id="kobo.613.2">However, only the second user is found.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.614.1">$ </span></span><span class="koboSpan" id="kobo.615.1">curl -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.616.1">'</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.617.1">Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.618.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.619.1">'{"user": "mtsouk", "password" : "admin"}'</span></span><span class="koboSpan" id="kobo.620.1"> http://localhost:1234/delete -X DELETE
{"user": "mtsouk", "password" : "admin"}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.621.1">The last interaction successfully deletes the user specified by </span><code class="inlineCode"><span class="koboSpan" id="kobo.622.1">{"user": "mtsouk", "password" : "admin"}</span></code><span class="koboSpan" id="kobo.623.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.624.1">The output </span><a id="_idIndexMarker931"/><span class="koboSpan" id="kobo.625.1">generated by the server process for all previous interactions would look like the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.626.1">$ </span></span><span class="koboSpan" id="kobo.627.1">go run rServer.go
Ready to serve at :1234
2023/10/28 22:56:36 Serving: / from localhost:1234
2023/10/28 22:56:45 Serving: /add from localhost:1234 POST
2023/10/28 22:56:45 map[mtsouk:admin]
2023/10/28 22:57:44 Serving: /add from localhost:1234 POST
2023/10/28 22:57:44 map[mtsouk:admin]
2023/10/28 22:59:29 Serving: /add from localhost:1234 POST
2023/10/28 22:59:29 map[mihalis:admin mtsouk:admin]
2023/10/28 22:59:47 Serving: /add from localhost:1234 GET
2023/10/28 23:00:08 Serving: /get from localhost:1234 POST
2023/10/28 23:00:17 Serving: /get from localhost:1234 GET
{admin admin}
2023/10/28 23:00:17 Not found!
</span><span class="koboSpan" id="kobo.627.2">2023/10/28 23:00:32 Serving: /get from localhost:1234 GET
{mtsouk admin}
2023/10/28 23:00:32 Found!
</span><span class="koboSpan" id="kobo.627.3">2023/10/28 23:00:45 Serving: /delete from localhost:1234 DELETE
2023/10/28 23:00:45 {mtsouk admin}
2023/10/28 23:00:45 map[mihalis:admin]
2023/10/28 23:00:45 After: map[mihalis:admin]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.628.1">So far, we have a working RESTful server that has been tested with the help of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.629.1">curl(1)</span></code><span class="koboSpan" id="kobo.630.1"> utility. </span><span class="koboSpan" id="kobo.630.2">The next section is about developing a command line client for the RESTful server.</span></p>
<h2 class="heading-2" id="_idParaDest-312"><span class="koboSpan" id="kobo.631.1">A RESTful client</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.632.1">This subsection illustrates the development of a client for the RESTful server developed previously. </span><span class="koboSpan" id="kobo.632.2">However, in this case, the client acts as a testing program that tries the capabilities of </span><a id="_idIndexMarker932"/><span class="koboSpan" id="kobo.633.1">the RESTful serverâ€”later in this chapter, you are going to learn how to write proper clients using the cobra library. </span><span class="koboSpan" id="kobo.633.2">So, the code of the client, which can be found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.634.1">rClient.go</span></code><span class="koboSpan" id="kobo.635.1">, is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.636.1">package</span></span><span class="koboSpan" id="kobo.637.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.638.1">import</span></span><span class="koboSpan" id="kobo.639.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.640.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.641.1">bytes"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.642.1">"encoding/json"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.643.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.644.1">"io"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.645.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.646.1">"os"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.647.1">"time"</span></span><span class="koboSpan" id="kobo.648.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.649.1">type</span></span><span class="koboSpan" id="kobo.650.1"> User </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.651.1">struct</span></span><span class="koboSpan" id="kobo.652.1"> {
    Username </span><span class="hljs-type"><span class="koboSpan" id="kobo.653.1">string</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.654.1">`</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.655.1">json:"user"`</span></span><span class="koboSpan" id="kobo.656.1">
    Password </span><span class="hljs-type"><span class="koboSpan" id="kobo.657.1">string</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.658.1">`json:"password"`</span></span><span class="koboSpan" id="kobo.659.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.660.1">This same structure is found in the server implementation and is used for data exchange.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.661.1">var</span></span><span class="koboSpan" id="kobo.662.1"> u1 = User{</span><span class="hljs-string"><span class="koboSpan" id="kobo.663.1">"admin"</span></span><span class="koboSpan" id="kobo.664.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.665.1">"admin"</span></span><span class="koboSpan" id="kobo.666.1">}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.667.1">var</span></span><span class="koboSpan" id="kobo.668.1"> u2 = User{</span><span class="hljs-string"><span class="koboSpan" id="kobo.669.1">"tsoukalos"</span></span><span class="koboSpan" id="kobo.670.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.671.1">"pass"</span></span><span class="koboSpan" id="kobo.672.1">}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.673.1">var</span></span><span class="koboSpan" id="kobo.674.1"> u3 = User{</span><span class="hljs-string"><span class="koboSpan" id="kobo.675.1">""</span></span><span class="koboSpan" id="kobo.676.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.677.1">"pass"</span></span><span class="koboSpan" id="kobo.678.1">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.679.1">Here, we predefine three </span><code class="inlineCode"><span class="koboSpan" id="kobo.680.1">User</span></code><span class="koboSpan" id="kobo.681.1"> variables that are going to be used during testing.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.682.1">const</span></span><span class="koboSpan" id="kobo.683.1"> addEndPoint = </span><span class="hljs-string"><span class="koboSpan" id="kobo.684.1">"/add"</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.685.1">const</span></span><span class="koboSpan" id="kobo.686.1"> getEndPoint = </span><span class="hljs-string"><span class="koboSpan" id="kobo.687.1">"/get"</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.688.1">const</span></span><span class="koboSpan" id="kobo.689.1"> deleteEndPoint = </span><span class="hljs-string"><span class="koboSpan" id="kobo.690.1">"/delete"</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.691.1">const</span></span><span class="koboSpan" id="kobo.692.1"> timeEndPoint = </span><span class="hljs-string"><span class="koboSpan" id="kobo.693.1">"/time"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.694.1">The previous constants define the endpoints that are going to be used.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.695.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.696.1">deleteEndpoint</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.697.1">(server </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.698.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.699.1">, user User)</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.700.1">int</span></span><span class="koboSpan" id="kobo.701.1"> {
    userMarshall, err := json.Marshal(user)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.702.1">if</span></span><span class="koboSpan" id="kobo.703.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.704.1">nil</span></span><span class="koboSpan" id="kobo.705.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.706.1">"Error in req: "</span></span><span class="koboSpan" id="kobo.707.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.708.1">return</span></span><span class="koboSpan" id="kobo.709.1"> http.StatusInternalServerError
    }
    u := bytes.NewReader(userMarshall)
    req, err := http.NewRequest(http.MethodDelete, server+deleteEndPoint, u)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.710.1">We prepare a request that is going to access </span><code class="inlineCode"><span class="koboSpan" id="kobo.711.1">/delete</span></code><span class="koboSpan" id="kobo.712.1"> using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.713.1">DELETE</span></code><span class="koboSpan" id="kobo.714.1"> HTTP method.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.715.1">if</span></span><span class="koboSpan" id="kobo.716.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.717.1">nil</span></span><span class="koboSpan" id="kobo.718.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.719.1">"Error in req: "</span></span><span class="koboSpan" id="kobo.720.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.721.1">return</span></span><span class="koboSpan" id="kobo.722.1"> http.StatusBadRequest
    }
    req.Header.Set(</span><span class="hljs-string"><span class="koboSpan" id="kobo.723.1">"Content-Type"</span></span><span class="koboSpan" id="kobo.724.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.725.1">"application/json"</span></span><span class="koboSpan" id="kobo.726.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.727.1">This is the </span><a id="_idIndexMarker933"/><span class="koboSpan" id="kobo.728.1">correct way to specify that we want to use JSON data when interacting with the server.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.729.1">    c := &amp;http.Client{
        Timeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.730.1">15</span></span><span class="koboSpan" id="kobo.731.1"> * time.Second,
    }
    resp, err := c.Do(req)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.732.1">Then, we send the request and wait for the server response using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.733.1">Do()</span></code><span class="koboSpan" id="kobo.734.1"> method with a 15-second timeout.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.735.1">if</span></span><span class="koboSpan" id="kobo.736.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.737.1">nil</span></span><span class="koboSpan" id="kobo.738.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.739.1">"Error:"</span></span><span class="koboSpan" id="kobo.740.1">, err)
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.741.1">defer</span></span><span class="koboSpan" id="kobo.742.1"> resp.Body.Close()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.743.1">if</span></span><span class="koboSpan" id="kobo.744.1"> resp == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.745.1">nil</span></span><span class="koboSpan" id="kobo.746.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.747.1">return</span></span><span class="koboSpan" id="kobo.748.1"> http.StatusBadRequest
    }
    data, err := io.ReadAll(resp.Body)
    fmt.Print(</span><span class="hljs-string"><span class="koboSpan" id="kobo.749.1">"/delete returned: "</span></span><span class="koboSpan" id="kobo.750.1">, </span><span class="hljs-type"><span class="koboSpan" id="kobo.751.1">string</span></span><span class="koboSpan" id="kobo.752.1">(data))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.753.1">The reason for putting that </span><code class="inlineCode"><span class="koboSpan" id="kobo.754.1">fmt.Print()</span></code><span class="koboSpan" id="kobo.755.1"> here is that we want to get informed about the server response even if there is an error in the interaction.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.756.1">if</span></span><span class="koboSpan" id="kobo.757.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.758.1">nil</span></span><span class="koboSpan" id="kobo.759.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.760.1">"Error:"</span></span><span class="koboSpan" id="kobo.761.1">, err)
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.762.1">return</span></span><span class="koboSpan" id="kobo.763.1"> resp.StatusCode
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.764.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.765.1">resp.StatusCode</span></code><span class="koboSpan" id="kobo.766.1"> value specifies the response HTTP code from </span><code class="inlineCode"><span class="koboSpan" id="kobo.767.1">/delete</span></code><span class="koboSpan" id="kobo.768.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.769.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.770.1">getEndpoint</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.771.1">(server </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.772.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.773.1">, user User)</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.774.1">int</span></span><span class="koboSpan" id="kobo.775.1"> {
    userMarshall, err := json.Marshal(user)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.776.1">if</span></span><span class="koboSpan" id="kobo.777.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.778.1">nil</span></span><span class="koboSpan" id="kobo.779.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.780.1">"Error in unmarshalling: "</span></span><span class="koboSpan" id="kobo.781.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.782.1">return</span></span><span class="koboSpan" id="kobo.783.1"> http.StatusBadRequest
    }
    u := bytes.NewReader(userMarshall)
    req, err := http.NewRequest(http.MethodGet, server+getEndPoint, u)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.784.1">The previous code is going to access </span><code class="inlineCode"><span class="koboSpan" id="kobo.785.1">/get</span></code><span class="koboSpan" id="kobo.786.1"> using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.787.1">GET</span></code><span class="koboSpan" id="kobo.788.1"> HTTP method.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.789.1">if</span></span><span class="koboSpan" id="kobo.790.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.791.1">nil</span></span><span class="koboSpan" id="kobo.792.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.793.1">"Error in req: "</span></span><span class="koboSpan" id="kobo.794.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.795.1">return</span></span><span class="koboSpan" id="kobo.796.1"> http.StatusBadRequest
    }
    req.Header.Set(</span><span class="hljs-string"><span class="koboSpan" id="kobo.797.1">"Content-Type"</span></span><span class="koboSpan" id="kobo.798.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.799.1">"application/json"</span></span><span class="koboSpan" id="kobo.800.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.801.1">We specify </span><a id="_idIndexMarker934"/><span class="koboSpan" id="kobo.802.1">that we are going to interact with the server using the JSON format using </span><code class="inlineCode"><span class="koboSpan" id="kobo.803.1">Header.Set()</span></code><span class="koboSpan" id="kobo.804.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.805.1">    c := &amp;http.Client{
        Timeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.806.1">15</span></span><span class="koboSpan" id="kobo.807.1"> * time.Second,
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.808.1">The previous statements define a timeout period for the HTTP client in case the server is too busy responding.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.809.1">    resp, err := c.Do(req)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.810.1">if</span></span><span class="koboSpan" id="kobo.811.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.812.1">nil</span></span><span class="koboSpan" id="kobo.813.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.814.1">"Error:"</span></span><span class="koboSpan" id="kobo.815.1">, err)
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.816.1">defer</span></span><span class="koboSpan" id="kobo.817.1"> resp.Body.Close()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.818.1">if</span></span><span class="koboSpan" id="kobo.819.1"> resp == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.820.1">nil</span></span><span class="koboSpan" id="kobo.821.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.822.1">return</span></span><span class="koboSpan" id="kobo.823.1"> resp.StatusCode
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.824.1">The previous code sends the client request to the server using </span><code class="inlineCode"><span class="koboSpan" id="kobo.825.1">c.Do(req)</span></code><span class="koboSpan" id="kobo.826.1"> and saves the server response in </span><code class="inlineCode"><span class="koboSpan" id="kobo.827.1">resp</span></code><span class="koboSpan" id="kobo.828.1"> and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.829.1">error</span></code><span class="koboSpan" id="kobo.830.1"> value in </span><code class="inlineCode"><span class="koboSpan" id="kobo.831.1">err</span></code><span class="koboSpan" id="kobo.832.1">. </span><span class="koboSpan" id="kobo.832.2">If the value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.833.1">resp</span></code><span class="koboSpan" id="kobo.834.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.835.1">nil</span></code><span class="koboSpan" id="kobo.836.1">, then the server response is empty, which is an error condition.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.837.1">    data, err := io.ReadAll(resp.Body)
    fmt.Print(</span><span class="hljs-string"><span class="koboSpan" id="kobo.838.1">"/get returned: "</span></span><span class="koboSpan" id="kobo.839.1">, </span><span class="hljs-type"><span class="koboSpan" id="kobo.840.1">string</span></span><span class="koboSpan" id="kobo.841.1">(data))
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.842.1">if</span></span><span class="koboSpan" id="kobo.843.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.844.1">nil</span></span><span class="koboSpan" id="kobo.845.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.846.1">"Error:"</span></span><span class="koboSpan" id="kobo.847.1">, err)
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.848.1">return</span></span><span class="koboSpan" id="kobo.849.1"> resp.StatusCode
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.850.1">The value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.851.1">resp.StatusCode</span></code><span class="koboSpan" id="kobo.852.1">, which is specified and transferred by the RESTful server, determines whether the interaction was successful in an HTTP sense (logically) or not.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.853.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.854.1">addEndpoint</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.855.1">(server </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.856.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.857.1">, user User)</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.858.1">int</span></span><span class="koboSpan" id="kobo.859.1"> {
    userMarshall, err := json.Marshal(user)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.860.1">if</span></span><span class="koboSpan" id="kobo.861.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.862.1">nil</span></span><span class="koboSpan" id="kobo.863.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.864.1">"Error in unmarshalling: "</span></span><span class="koboSpan" id="kobo.865.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.866.1">return</span></span><span class="koboSpan" id="kobo.867.1"> http.StatusBadRequest
    }
    u := bytes.NewReader(userMarshall)
    req, err := http.NewRequest(</span><span class="hljs-string"><span class="koboSpan" id="kobo.868.1">"POST"</span></span><span class="koboSpan" id="kobo.869.1">, server+addEndPoint, u)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.870.1">We are going </span><a id="_idIndexMarker935"/><span class="koboSpan" id="kobo.871.1">to access </span><code class="inlineCode"><span class="koboSpan" id="kobo.872.1">/add</span></code><span class="koboSpan" id="kobo.873.1"> using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.874.1">POST</span></code><span class="koboSpan" id="kobo.875.1"> HTTP method. </span><span class="koboSpan" id="kobo.875.2">We can use </span><code class="inlineCode"><span class="koboSpan" id="kobo.876.1">http.MethodPost</span></code><span class="koboSpan" id="kobo.877.1"> instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.878.1">POST</span></code><span class="koboSpan" id="kobo.879.1">. </span><span class="koboSpan" id="kobo.879.2">As stated earlier in this chapter, there exist relevant global variables in http for the remaining HTTP methods (</span><code class="inlineCode"><span class="koboSpan" id="kobo.880.1">http.MethodGet</span></code><span class="koboSpan" id="kobo.881.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.882.1">http.MethodDelete</span></code><span class="koboSpan" id="kobo.883.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.884.1">http.MethodPut</span></code><span class="koboSpan" id="kobo.885.1">, etc.) and it is recommended that we use them for portability.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.886.1">if</span></span><span class="koboSpan" id="kobo.887.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.888.1">nil</span></span><span class="koboSpan" id="kobo.889.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.890.1">"Error in req: "</span></span><span class="koboSpan" id="kobo.891.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.892.1">return</span></span><span class="koboSpan" id="kobo.893.1"> http.StatusBadRequest
    }
    req.Header.Set(</span><span class="hljs-string"><span class="koboSpan" id="kobo.894.1">"Content-Type"</span></span><span class="koboSpan" id="kobo.895.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.896.1">"application/json"</span></span><span class="koboSpan" id="kobo.897.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.898.1">As before, we specify that we are going to interact with the server using the JSON format.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.899.1">    c := &amp;http.Client{
        Timeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.900.1">15</span></span><span class="koboSpan" id="kobo.901.1"> * time.Second,
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.902.1">Once again, we define a timeout period for the client in case the server is too busy replying.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.903.1">    resp, err := c.Do(req)
     </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.904.1">if</span></span><span class="koboSpan" id="kobo.905.1"> resp == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.906.1">nil</span></span><span class="koboSpan" id="kobo.907.1"> || (resp.StatusCode == http.StatusNotFound) {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.908.1">return</span></span><span class="koboSpan" id="kobo.909.1"> resp.StatusCode
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.910.1">defer</span></span><span class="koboSpan" id="kobo.911.1"> resp.Body.Close()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.912.1">return</span></span><span class="koboSpan" id="kobo.913.1"> resp.StatusCode
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.914.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.915.1">addEndpoint()</span></code><span class="koboSpan" id="kobo.916.1"> function is for testing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.917.1">/add</span></code><span class="koboSpan" id="kobo.918.1"> endpoint using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.919.1">POST</span></code><span class="koboSpan" id="kobo.920.1"> method.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.921.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.922.1">timeEndpoint</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.923.1">(server </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.924.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.925.1">)</span></span><span class="koboSpan" id="kobo.926.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.927.1">int</span></span><span class="koboSpan" id="kobo.928.1">, </span><span class="hljs-type"><span class="koboSpan" id="kobo.929.1">string</span></span><span class="koboSpan" id="kobo.930.1">) {
    req, err := http.NewRequest(http.MethodPost, server+timeEndPoint, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.931.1">nil</span></span><span class="koboSpan" id="kobo.932.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.933.1">We are going </span><a id="_idIndexMarker936"/><span class="koboSpan" id="kobo.934.1">to access the </span><code class="inlineCode"><span class="koboSpan" id="kobo.935.1">/time</span></code><span class="koboSpan" id="kobo.936.1"> endpoint using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.937.1">POST</span></code><span class="koboSpan" id="kobo.938.1"> HTTP method.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.939.1">if</span></span><span class="koboSpan" id="kobo.940.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.941.1">nil</span></span><span class="koboSpan" id="kobo.942.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.943.1">"Error in req: "</span></span><span class="koboSpan" id="kobo.944.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.945.1">return</span></span><span class="koboSpan" id="kobo.946.1"> http.StatusBadRequest, </span><span class="hljs-string"><span class="koboSpan" id="kobo.947.1">""</span></span><span class="koboSpan" id="kobo.948.1">
    }
    c := &amp;http.Client{
        Timeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.949.1">15</span></span><span class="koboSpan" id="kobo.950.1"> * time.Second,
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.951.1">As before, we define a timeout period for the client in case the server is too busy responding.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.952.1">    resp, err := c.Do(req)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.953.1">if</span></span><span class="koboSpan" id="kobo.954.1"> resp == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.955.1">nil</span></span><span class="koboSpan" id="kobo.956.1"> || (resp.StatusCode == http.StatusNotFound) {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.957.1">return</span></span><span class="koboSpan" id="kobo.958.1"> resp.StatusCode, </span><span class="hljs-string"><span class="koboSpan" id="kobo.959.1">""</span></span><span class="koboSpan" id="kobo.960.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.961.1">defer</span></span><span class="koboSpan" id="kobo.962.1"> resp.Body.Close()
    data, _ := io.ReadAll(resp.Body)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.963.1">return</span></span><span class="koboSpan" id="kobo.964.1"> resp.StatusCode, </span><span class="hljs-type"><span class="koboSpan" id="kobo.965.1">string</span></span><span class="koboSpan" id="kobo.966.1">(data)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.967.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.968.1">timeEndpoint()</span></code><span class="koboSpan" id="kobo.969.1"> function is for testing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.970.1">/time</span></code><span class="koboSpan" id="kobo.971.1"> endpointâ€”note that this endpoint does not require any data from the client, so the client request is empty. </span><span class="koboSpan" id="kobo.971.2">The server is going to return a string with the current time and date of the server.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.972.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.973.1">slashEndpoint</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.974.1">(server, URL </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.975.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.976.1">)</span></span><span class="koboSpan" id="kobo.977.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.978.1">int</span></span><span class="koboSpan" id="kobo.979.1">, </span><span class="hljs-type"><span class="koboSpan" id="kobo.980.1">string</span></span><span class="koboSpan" id="kobo.981.1">) {
    req, err := http.NewRequest(MethodPost, server+URL, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.982.1">nil</span></span><span class="koboSpan" id="kobo.983.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.984.1">We are going to access </span><code class="inlineCode"><span class="koboSpan" id="kobo.985.1">/</span></code><span class="koboSpan" id="kobo.986.1"> using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.987.1">POST</span></code><span class="koboSpan" id="kobo.988.1"> HTTP method.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.989.1">if</span></span><span class="koboSpan" id="kobo.990.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.991.1">nil</span></span><span class="koboSpan" id="kobo.992.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.993.1">"Error in req: "</span></span><span class="koboSpan" id="kobo.994.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.995.1">return</span></span><span class="koboSpan" id="kobo.996.1"> http.StatusBadRequest, </span><span class="hljs-string"><span class="koboSpan" id="kobo.997.1">""</span></span><span class="koboSpan" id="kobo.998.1">
    }
    c := &amp;http.Client{
        Timeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.999.1">15</span></span><span class="koboSpan" id="kobo.1000.1"> * time.Second,
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1001.1">It is considered </span><a id="_idIndexMarker937"/><span class="koboSpan" id="kobo.1002.1">a good practice to have a timeout period on the client side in case there are delays in the server response.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1003.1">    resp, err := c.Do(req)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1004.1">if</span></span><span class="koboSpan" id="kobo.1005.1"> resp == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1006.1">nil</span></span><span class="koboSpan" id="kobo.1007.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1008.1">return</span></span><span class="koboSpan" id="kobo.1009.1"> resp.StatusCode, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1010.1">""</span></span><span class="koboSpan" id="kobo.1011.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1012.1">defer</span></span><span class="koboSpan" id="kobo.1013.1"> resp.Body.Close()
    data, _ := io.ReadAll(resp.Body)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1014.1">return</span></span><span class="koboSpan" id="kobo.1015.1"> resp.StatusCode, </span><span class="hljs-type"><span class="koboSpan" id="kobo.1016.1">string</span></span><span class="koboSpan" id="kobo.1017.1">(data)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1018.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1019.1">slashEndpoint()</span></code><span class="koboSpan" id="kobo.1020.1"> function is for testing the default endpoint in the serverâ€”note that this endpoint does not require any data from the client.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1021.1">The next step is the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1022.1">main()</span></code><span class="koboSpan" id="kobo.1023.1"> function, which uses all previous functions to visit the RESTful server endpoints:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1024.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1025.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1026.1">()</span></span><span class="koboSpan" id="kobo.1027.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1028.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1029.1">len</span></span><span class="koboSpan" id="kobo.1030.1">(os.Args) != </span><span class="hljs-number"><span class="koboSpan" id="kobo.1031.1">2</span></span><span class="koboSpan" id="kobo.1032.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1033.1">"Wrong number of arguments!"</span></span><span class="koboSpan" id="kobo.1034.1">)
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1035.1">"Need: Server URL"</span></span><span class="koboSpan" id="kobo.1036.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1037.1">return</span></span><span class="koboSpan" id="kobo.1038.1">
    }
    server := os.Args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1039.1">1</span></span><span class="koboSpan" id="kobo.1040.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1041.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1042.1">server</span></code><span class="koboSpan" id="kobo.1043.1"> variable holds the server address and the port number that are going to be used.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1044.1">    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1045.1">"/add"</span></span><span class="koboSpan" id="kobo.1046.1">)
    httpCode := addEndpoint(server, u1)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1047.1">if</span></span><span class="koboSpan" id="kobo.1048.1"> HTTPcode != http.StatusOK {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1049.1">"u1 Return code:"</span></span><span class="koboSpan" id="kobo.1050.1">, httpCode)
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1051.1">else</span></span><span class="koboSpan" id="kobo.1052.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1053.1">"u1 Data added:"</span></span><span class="koboSpan" id="kobo.1054.1">, u1, httpCode)
    }
    httpCode = addEndpoint(server, u2)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1055.1">if</span></span><span class="koboSpan" id="kobo.1056.1"> httpCode != http.StatusOK {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1057.1">"u2 Return code:"</span></span><span class="koboSpan" id="kobo.1058.1">, httpCode)
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1059.1">else</span></span><span class="koboSpan" id="kobo.1060.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1061.1">"u2 Data added:"</span></span><span class="koboSpan" id="kobo.1062.1">, u2, httpCode)
    }
    httpCode = addEndpoint(server, u3)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1063.1">if</span></span><span class="koboSpan" id="kobo.1064.1"> httpCode != http.StatusOK {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1065.1">"u3 Return code:"</span></span><span class="koboSpan" id="kobo.1066.1">, httpCode)
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1067.1">else</span></span><span class="koboSpan" id="kobo.1068.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1069.1">"u3 Data added:"</span></span><span class="koboSpan" id="kobo.1070.1">, u3, httpCode)
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1071.1">All the previous </span><a id="_idIndexMarker938"/><span class="koboSpan" id="kobo.1072.1">code is used for testing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1073.1">/add</span></code><span class="koboSpan" id="kobo.1074.1"> endpoint using various types of data.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1075.1">    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1076.1">"/get"</span></span><span class="koboSpan" id="kobo.1077.1">)
    httpCode = getEndpoint(server, u1)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1078.1">"/get u1 return code:"</span></span><span class="koboSpan" id="kobo.1079.1">, httpCode)
    httpCode = getEndpoint(server, u2)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1080.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1081.1">/get u2 return code:"</span></span><span class="koboSpan" id="kobo.1082.1">, httpCode)
    httpCode = getEndpoint(server, u3)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1083.1">"/get u3 return code:"</span></span><span class="koboSpan" id="kobo.1084.1">, httpCode)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1085.1">All the previous code is used for testing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1086.1">/get</span></code><span class="koboSpan" id="kobo.1087.1"> endpoint using various types of input. </span><span class="koboSpan" id="kobo.1087.2">We only test for the return code because the HTTP code specifies the success or failure of the operation.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1088.1">    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1089.1">"/delete"</span></span><span class="koboSpan" id="kobo.1090.1">)
    httpCode = deleteEndpoint(server, u1)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1091.1">"/delete u1 return code:"</span></span><span class="koboSpan" id="kobo.1092.1">, httpCode)
    httpCode = deleteEndpoint(server, u1)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1093.1">"/delete u1 return code:"</span></span><span class="koboSpan" id="kobo.1094.1">, httpCode)
    httpCode = deleteEndpoint(server, u2)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1095.1">"/delete u2 return code:"</span></span><span class="koboSpan" id="kobo.1096.1">, httpCode)
    httpCode = deleteEndpoint(server, u3)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1097.1">"/delete u3 return code:"</span></span><span class="koboSpan" id="kobo.1098.1">, httpCode)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1099.1">All the previous code is used for testing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1100.1">/delete</span></code><span class="koboSpan" id="kobo.1101.1"> endpoint using various types of input. </span><span class="koboSpan" id="kobo.1101.2">Once again, we print the HTTP code of the interaction because the value of the HTTP code specifies the success or failure of the client request.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1102.1">    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1103.1">"/time"</span></span><span class="koboSpan" id="kobo.1104.1">)
    httpCode, myTime := timeEndpoint(server)
    fmt.Print(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1105.1">"/time returned: "</span></span><span class="koboSpan" id="kobo.1106.1">, httpCode, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1107.1">" "</span></span><span class="koboSpan" id="kobo.1108.1">, myTime)
    time.Sleep(time.Second)
    httpCode, myTime = timeEndpoint(server)
    fmt.Print(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1109.1">"/time returned: "</span></span><span class="koboSpan" id="kobo.1110.1">, httpCode, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1111.1">" "</span></span><span class="koboSpan" id="kobo.1112.1">, myTime)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1113.1">The previous </span><a id="_idIndexMarker939"/><span class="koboSpan" id="kobo.1114.1">code tests the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1115.1">/time</span></code><span class="koboSpan" id="kobo.1116.1"> endpointâ€”it prints the HTTP code as well as the rest of the server response.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1117.1">    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1118.1">"/"</span></span><span class="koboSpan" id="kobo.1119.1">)
    URL := </span><span class="hljs-string"><span class="koboSpan" id="kobo.1120.1">"/"</span></span><span class="koboSpan" id="kobo.1121.1">
    httpCode, response := slashEndpoint(server, URL)
    fmt.Print(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1122.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1123.1">/ returned: "</span></span><span class="koboSpan" id="kobo.1124.1">, httpCode, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1125.1">" with response: "</span></span><span class="koboSpan" id="kobo.1126.1">, response)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1127.1">"/what"</span></span><span class="koboSpan" id="kobo.1128.1">)
    URL = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1129.1">"/what"</span></span><span class="koboSpan" id="kobo.1130.1">
    httpCode, response = slashEndpoint(server, URL)
    fmt.Print(URL, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1131.1">" returned: "</span></span><span class="koboSpan" id="kobo.1132.1">, httpCode, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1133.1">" with response: "</span></span><span class="koboSpan" id="kobo.1134.1">, response)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1135.1">The last part of the program tries to connect to an endpoint that does not exist to verify the correct operation of the default handler function.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1136.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1137.1">rClient.go</span></code><span class="koboSpan" id="kobo.1138.1"> and interacting with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1139.1">rServer.go</span></code><span class="koboSpan" id="kobo.1140.1"> produces the next kind of output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1141.1">$ </span></span><span class="koboSpan" id="kobo.1142.1">go run rClient.go http://localhost:1234
/add
u1 Data added: {admin admin} 200
u2 Data added: {tsoukalos pass} 200
u3 Return code: 400
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1143.1">The previous part is related to the testing of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1144.1">/add</span></code><span class="koboSpan" id="kobo.1145.1"> endpoint. </span><span class="koboSpan" id="kobo.1145.2">The first two users were successfully added, whereas the third user (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1146.1">var u3 = User{"", "pass"}</span></code><span class="koboSpan" id="kobo.1147.1">) was not added because it does not contain all the required information.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1148.1">/get
/get returned: {"user":"admin","password":"admin"}
/get u1 return code: 200
/get returned: {"user":"tsoukalos","password":"pass"}
/get u2 return code: 200
/get returned: Map - Resource not found!
</span><span class="koboSpan" id="kobo.1148.2">/get u3 return code: 404
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1149.1">The previous part is related to the testing of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1150.1">/get</span></code><span class="koboSpan" id="kobo.1151.1"> endpoint. </span><span class="koboSpan" id="kobo.1151.2">The data of the first two users with </span><a id="_idIndexMarker940"/><span class="koboSpan" id="kobo.1152.1">the usernames </span><code class="inlineCode"><span class="koboSpan" id="kobo.1153.1">admin</span></code><span class="koboSpan" id="kobo.1154.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1155.1">tsoukalos</span></code><span class="koboSpan" id="kobo.1156.1"> was successfully returned, whereas the user stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1157.1">u3</span></code><span class="koboSpan" id="kobo.1158.1"> variable was not found.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1159.1">/delete
/delete returned: {"user":"admin","password":"admin"}
/delete u1 return code: 200
/delete returned: Delete - Resource not found!
</span><span class="koboSpan" id="kobo.1159.2">/delete u1 return code: 404
/delete returned: {"user":"tsoukalos","password":"pass"}
/delete u2 return code: 200
/delete returned: Delete - Resource not found!
</span><span class="koboSpan" id="kobo.1159.3">/delete u3 return code: 404
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1160.1">The previous output is related to the testing of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1161.1">/delete</span></code><span class="koboSpan" id="kobo.1162.1"> endpoint. </span><span class="koboSpan" id="kobo.1162.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1163.1">admin</span></code><span class="koboSpan" id="kobo.1164.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1165.1">tsoukalos</span></code><span class="koboSpan" id="kobo.1166.1"> users were deleted. </span><span class="koboSpan" id="kobo.1166.2">However, trying to delete </span><code class="inlineCode"><span class="koboSpan" id="kobo.1167.1">admin</span></code><span class="koboSpan" id="kobo.1168.1"> for the second time failed.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1169.1">/time
/time returned: 200 The current time is: Sat, 28 Oct 2023 23:03:39 EEST
/time returned: 200 The current time is: Sat, 28 Oct 2023 23:03:40 EEST
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1170.1">Similarly, the previous part is related to the testing of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1171.1">/time</span></code><span class="koboSpan" id="kobo.1172.1"> endpoint.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1173.1">/
/ returned: 404 with response: Thanks for visiting!
</span><span class="koboSpan" id="kobo.1173.2">/what
/what returned: 404 swith response: Thanks for visiting!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1174.1">The last part of the output is related to the operation of the default handler.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1175.1">It is important to realize that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1176.1">rClient.go</span></code><span class="koboSpan" id="kobo.1177.1"> can successfully interact with every RESTful server that supports the same endpoints without knowing the implementation details of the RESTful server. </span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1178.1">So far, both the RESTful server and the client can interact with each other. </span><span class="koboSpan" id="kobo.1178.2">However, neither of them performs a real job. </span><span class="koboSpan" id="kobo.1178.3">The next section shows how to develop a real-world RESTful server using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1179.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1180.1"> and a database backend for storing data.</span></p>
<h1 class="heading-1" id="_idParaDest-313"><span class="koboSpan" id="kobo.1181.1">Creating a functional RESTful server</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1182.1">This section illustrates how to develop a RESTful server in Go given a REST API. </span><span class="koboSpan" id="kobo.1182.2">The biggest difference between the presented RESTful service and the statistics application created in </span><em class="chapterRef"><span class="koboSpan" id="kobo.1183.1">Chapter 9</span></em><span class="koboSpan" id="kobo.1184.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1185.1">Building Web Services</span></em><span class="koboSpan" id="kobo.1186.1">, is that the RESTful service uses JSON messages for interacting with its clients, whereas the statistics application interacts and works using plain text messages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1187.1">If you are </span><a id="_idIndexMarker941"/><span class="koboSpan" id="kobo.1188.1">thinking of using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1189.1">net/http</span></code><span class="koboSpan" id="kobo.1190.1"> for the implementation of the RESTful server, please do not do so without first thinking about the requirements of your server! </span><span class="koboSpan" id="kobo.1190.2">This implementation uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1191.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1192.1"> package, which is a much better choice because it supports subrouters â€“ more about that in the </span><em class="italic"><span class="koboSpan" id="kobo.1193.1">Using gorilla/mux</span></em><span class="koboSpan" id="kobo.1194.1"> subsection. </span><span class="koboSpan" id="kobo.1194.2">However, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1195.1">net/http</span></code><span class="koboSpan" id="kobo.1196.1"> is still powerful and can be useful for many REST requirements.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1197.1">The purpose of the RESTful server is to implement a login/authentication system. </span><span class="koboSpan" id="kobo.1197.2">The purpose of the login system is to keep track of the users who are logged in, as well as their permissions. </span><span class="koboSpan" id="kobo.1197.3">The system comes with a default administrator user named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1198.1">admin</span></code><span class="koboSpan" id="kobo.1199.1">â€”the default password is also </span><code class="inlineCode"><span class="koboSpan" id="kobo.1200.1">admin</span></code><span class="koboSpan" id="kobo.1201.1"> and you should change it. </span><span class="koboSpan" id="kobo.1201.2">The application stores its data in an SQLite3 database, which means that if you restart it, the list of existing users is read from that database and is not lost. </span></p>
<h2 class="heading-2" id="_idParaDest-314"><span class="koboSpan" id="kobo.1202.1">The REST API</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1203.1">The API of an application helps you implement the functionality that you have in mind. </span><span class="koboSpan" id="kobo.1203.2">However, this is a job for the client, not the server. </span><span class="koboSpan" id="kobo.1203.3">The job of the server is to facilitate the job of </span><a id="_idIndexMarker942"/><span class="koboSpan" id="kobo.1204.1">its clients as much as possible by supporting a simple yet fully </span><a id="_idIndexMarker943"/><span class="koboSpan" id="kobo.1205.1">working functionality through a properly defined and implemented REST API. </span><span class="koboSpan" id="kobo.1205.2">Make sure that you understand that before trying to develop and use a RESTful server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1206.1">We are going to define the endpoints that are going to be used, the HTTP codes that are going to be returned, as well as the allowed method or methods. </span><span class="koboSpan" id="kobo.1206.2">Creating a RESTful server based on a REST API for production is a serious job that should not be taken lightly. </span><span class="koboSpan" id="kobo.1206.3">Creating a prototype to test and validate your ideas and designs is going to save you lots of time in the long run. </span><span class="koboSpan" id="kobo.1206.4">Always begin with a prototype.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1207.1">The supported </span><a id="_idIndexMarker944"/><span class="koboSpan" id="kobo.1208.1">endpoints as well as the supported HTTP methods and the parameters are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1209.1">/</span></code><span class="koboSpan" id="kobo.1210.1">: This is used for catching and serving everything that is not a match. </span><span class="koboSpan" id="kobo.1210.2">This endpoint works with all HTTP methods.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1211.1">/getall</span></code><span class="koboSpan" id="kobo.1212.1">: This is used for getting the full contents of the database. </span><span class="koboSpan" id="kobo.1212.2">Using this requires a user with administrative privileges. </span><span class="koboSpan" id="kobo.1212.3">This endpoint might return multiple JSON records and works with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1213.1">GET</span></code><span class="koboSpan" id="kobo.1214.1"> HTTP method.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1215.1">/getid/username</span></code><span class="koboSpan" id="kobo.1216.1">: This is used for getting the ID of a user identified by their username, which is passed to the endpoint. </span><span class="koboSpan" id="kobo.1216.2">This command should be issued by a user with administrative privileges and supports the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1217.1">GET</span></code><span class="koboSpan" id="kobo.1218.1"> HTTP method.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1219.1">/username/ID</span></code><span class="koboSpan" id="kobo.1220.1">: This is used for deleting or getting information about the user with an ID equal to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1221.1">ID</span></code><span class="koboSpan" id="kobo.1222.1">, depending on the HTTP method used. </span><span class="koboSpan" id="kobo.1222.2">Therefore, the actual action that is going to be performed depends on the HTTP method used. </span><span class="koboSpan" id="kobo.1222.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1223.1">DELETE</span></code><span class="koboSpan" id="kobo.1224.1"> method deletes the user, whereas the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1225.1">GET</span></code><span class="koboSpan" id="kobo.1226.1"> method returns the user information. </span><span class="koboSpan" id="kobo.1226.2">This endpoint should be issued by a user with administrative privileges.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1227.1">/logged</span></code><span class="koboSpan" id="kobo.1228.1">: This is used for getting a list of all logged-in users. </span><span class="koboSpan" id="kobo.1228.2">This endpoint might return multiple JSON records and requires the use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1229.1">GET</span></code><span class="koboSpan" id="kobo.1230.1"> HTTP method.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1231.1">/update</span></code><span class="koboSpan" id="kobo.1232.1">: This is used for updating the username, password, or admin status of a userâ€”the ID of the user in the database remains the same. </span><span class="koboSpan" id="kobo.1232.2">This endpoint works with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1233.1">PUT</span></code><span class="koboSpan" id="kobo.1234.1"> HTTP method only and the search for the user is based on the username.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1235.1">/login</span></code><span class="koboSpan" id="kobo.1236.1">: This is used for logging a user into the system, given a username and a password. </span><span class="koboSpan" id="kobo.1236.2">This endpoint works with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1237.1">POST</span></code><span class="koboSpan" id="kobo.1238.1"> HTTP method.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1239.1">/logout</span></code><span class="koboSpan" id="kobo.1240.1">: This is used for logging out a user, given a username and a password. </span><span class="koboSpan" id="kobo.1240.2">This endpoint works with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1241.1">POST</span></code><span class="koboSpan" id="kobo.1242.1"> HTTP method.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1243.1">/add</span></code><span class="koboSpan" id="kobo.1244.1">: This is used for adding a new user to the database. </span><span class="koboSpan" id="kobo.1244.2">This endpoint works with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1245.1">POST</span></code><span class="koboSpan" id="kobo.1246.1"> HTTP method and is issued by a user with administrative privileges.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1247.1">/time</span></code><span class="koboSpan" id="kobo.1248.1">: This is an endpoint used mainly for testing purposes. </span><span class="koboSpan" id="kobo.1248.2">It is the only endpoint that does not work with JSON data, does not require a valid account, and works with all HTTP methods.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1249.1">Now, let us discuss the capabilities and the functionality of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1250.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1251.1"> package.</span></p>
<h2 class="heading-2" id="_idParaDest-315"><span class="koboSpan" id="kobo.1252.1">Using gorilla/mux</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1253.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1254.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1255.1"> package (</span><a href="https://github.com/gorilla/mux"><span class="url"><span class="koboSpan" id="kobo.1256.1">https://github.com/gorilla/mux</span></span></a><span class="koboSpan" id="kobo.1257.1">) is a popular and powerful </span><a id="_idIndexMarker945"/><span class="koboSpan" id="kobo.1258.1">alternative to the default Go router that </span><a id="_idIndexMarker946"/><span class="koboSpan" id="kobo.1259.1">allows you to match incoming requests to their respective handler. </span><span class="koboSpan" id="kobo.1259.2">Although there exist many differences between the default Go router (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1260.1">http.ServeMux</span></code><span class="koboSpan" id="kobo.1261.1">) and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1262.1">mux.Router</span></code><span class="koboSpan" id="kobo.1263.1"> (the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1264.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1265.1"> router), the main difference is that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1266.1">mux.Router</span></code><span class="koboSpan" id="kobo.1267.1"> supports multiple conditions when matching a route with a handler function. </span><span class="koboSpan" id="kobo.1267.2">This means that you can write less code to handle some options such as the HTTP method used. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1268.1">Let us begin by presenting some matching examplesâ€”this functionality is not supported by the default Go router:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1269.1">r.HandleFunc("/url", UrlHandlerFunction)</span></code><span class="koboSpan" id="kobo.1270.1">: The previous command calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1271.1">UrlHandlerFunction</span></code><span class="koboSpan" id="kobo.1272.1"> function each time </span><code class="inlineCode"><span class="koboSpan" id="kobo.1273.1">/url</span></code><span class="koboSpan" id="kobo.1274.1"> is visited.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1275.1">r.HandleFunc("/url", UrlHandlerFunction).Methods(http.MethodPut)</span></code><span class="koboSpan" id="kobo.1276.1">: This example shows how you can tell Gorilla to match a specific HTTP method (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1277.1">PUT</span></code><span class="koboSpan" id="kobo.1278.1"> in this case, which is defined by the use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1279.1">http.MethodPut</span></code><span class="koboSpan" id="kobo.1280.1">), which saves you from having to write code to do that manually.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1281.1">mux.NotFoundHandler = http.HandlerFunc(handlers.DefaultHandler)</span></code><span class="koboSpan" id="kobo.1282.1">: With Gorilla, the right way to match anything that is not a match by any other path is by using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1283.1">mux.NotFoundHandler</span></code><span class="koboSpan" id="kobo.1284.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1285.1">mux.MethodNotAllowedHandler = notAllowed</span></code><span class="koboSpan" id="kobo.1286.1">: If a method is not allowed for an existing route, it is handled with the help of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1287.1">MethodNotAllowedHandler</span></code><span class="koboSpan" id="kobo.1288.1">. </span><span class="koboSpan" id="kobo.1288.2">This is specific to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1289.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1290.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1291.1">s.HandleFunc("/users/{id:[0-9]+}"), HandlerFunction)</span></code><span class="koboSpan" id="kobo.1292.1">: This last example shows that you can define a variable in a path using a name (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1293.1">id</span></code><span class="koboSpan" id="kobo.1294.1">) and a pattern â€“ Gorilla does the matching for you! </span><span class="koboSpan" id="kobo.1294.2">If there is not a regular expression, then the match is going to be anything from the beginning slash to the next slash in the path.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1295.1">Now, let us talk about another capability of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1296.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1297.1">, which is subrouters.</span></p>
<h2 class="heading-2" id="_idParaDest-316"><span class="koboSpan" id="kobo.1298.1">The use of subrouters</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1299.1">The server </span><a id="_idIndexMarker947"/><span class="koboSpan" id="kobo.1300.1">implementation uses subrouters. </span><span class="koboSpan" id="kobo.1300.2">A </span><em class="italic"><span class="koboSpan" id="kobo.1301.1">subrouter</span></em><span class="koboSpan" id="kobo.1302.1"> is a nested </span><a id="_idIndexMarker948"/><span class="koboSpan" id="kobo.1303.1">route that will only be examined for potential matches if the parent route matches the parameters of the subrouter. </span><span class="koboSpan" id="kobo.1303.2">The good thing is that the parent route can contain conditions that are common among all paths that are defined under a subrouter, which includes hosts, path prefixes, and, as it happens in our case, HTTP request methods. </span><span class="koboSpan" id="kobo.1303.3">As a result, our subrouters are divided based on the common request method of the endpoints that follow. </span><span class="koboSpan" id="kobo.1303.4">Not only does this optimize the request matchings, but it also makes the structure of the code easier to understand.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1304.1">As an example, the subrouter for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1305.1">DELETE</span></code><span class="koboSpan" id="kobo.1306.1"> HTTP method is as simple as the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1307.1">deleteMux := mux.Methods(http.MethodDelete).Subrouter()
deleteMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1308.1">"/username/{id:[0-9]+}"</span></span><span class="koboSpan" id="kobo.1309.1">, handlers.DeleteHandler)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1310.1">The first </span><a id="_idIndexMarker949"/><span class="koboSpan" id="kobo.1311.1">statement is for defining the common characteristics of the subrouter, which in </span><a id="_idIndexMarker950"/><span class="koboSpan" id="kobo.1312.1">this case is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1313.1">http.MethodDelete</span></code><span class="koboSpan" id="kobo.1314.1"> HTTP method, whereas the remaining statement, which in this case is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1315.1">deleteMux.HandleFunc(...)</span></code><span class="koboSpan" id="kobo.1316.1"> one, is for defining the supported paths.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1317.1">Yes, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1318.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1319.1"> might be more difficult to use than the default Go router, but by now you should understand the benefits of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1320.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1321.1"> package for working with HTTP services.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1322.1">The next subsection briefly presents the Gin framework, which is an alternative to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1323.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1324.1"> package.</span></p>
<h2 class="heading-2" id="_idParaDest-317"><span class="koboSpan" id="kobo.1325.1">The Gin HTTP framework</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1326.1">Gin is an </span><a id="_idIndexMarker951"/><span class="koboSpan" id="kobo.1327.1">open source web framework written in Go that can help you write powerful HTTP services. </span><span class="koboSpan" id="kobo.1327.2">The Gin GitHub repository can be found at </span><code class="inlineCode"><span class="koboSpan" id="kobo.1328.1">https://github.com/gin-gonic/gin</span></code><span class="koboSpan" id="kobo.1329.1">. </span><span class="koboSpan" id="kobo.1329.2">Gin uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.1330.1">httprouter</span></code><span class="koboSpan" id="kobo.1331.1"> as its HTTP router because </span><code class="inlineCode"><span class="koboSpan" id="kobo.1332.1">httprouter</span></code><span class="koboSpan" id="kobo.1333.1"> is optimized </span><a id="_idIndexMarker952"/><span class="koboSpan" id="kobo.1334.1">for high performance and small memory </span><a id="_idIndexMarker953"/><span class="koboSpan" id="kobo.1335.1">usage. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1336.1">httprouter</span></code><span class="koboSpan" id="kobo.1337.1"> is an HTTP router, just like the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.1338.1">mux</span></code><span class="koboSpan" id="kobo.1339.1"> from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1340.1">net/http</span></code><span class="koboSpan" id="kobo.1341.1"> package or the more advanced </span><code class="inlineCode"><span class="koboSpan" id="kobo.1342.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1343.1">. </span><span class="koboSpan" id="kobo.1343.2">You can learn more about it at </span><a href="https://github.com/julienschmidt/httprouter"><span class="url"><span class="koboSpan" id="kobo.1344.1">https://github.com/julienschmidt/httprouter</span></span></a><span class="koboSpan" id="kobo.1345.1"> and at </span><a href="https://pkg.go.dev/github.com/julienschmidt/httprouter"><span class="url"><span class="koboSpan" id="kobo.1346.1">https://pkg.go.dev/github.com/julienschmidt/httprouter</span></span></a><span class="koboSpan" id="kobo.1347.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-318"><span class="koboSpan" id="kobo.1348.1">Gin versus Gorilla</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1349.1">The biggest difference between Gin and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1350.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1351.1"> is that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1352.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1353.1"> is just an HTTP router </span><a id="_idIndexMarker954"/><span class="koboSpan" id="kobo.1354.1">and nothing more, whereas Gin can do what </span><code class="inlineCode"><span class="koboSpan" id="kobo.1355.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1356.1"> can plus JSON marshaling and unmarshaling, validation, customized response </span><a id="_idIndexMarker955"/><span class="koboSpan" id="kobo.1357.1">writing, and so on. </span><span class="koboSpan" id="kobo.1357.2">Put simply, Gin can do many more things than </span><code class="inlineCode"><span class="koboSpan" id="kobo.1358.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1359.1">. </span><span class="koboSpan" id="kobo.1359.2">In practice, you can consider Gin as being a higher-level framework than </span><code class="inlineCode"><span class="koboSpan" id="kobo.1360.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1361.1"> with more capabilities.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1362.1">So, the question </span><a id="_idIndexMarker956"/><span class="koboSpan" id="kobo.1363.1">here is which one should you choose. </span><span class="koboSpan" id="kobo.1363.2">It is not bad to try both starting with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1364.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1365.1">. </span><span class="koboSpan" id="kobo.1365.2">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.1366.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1367.1"> cannot do your job, then you definitely need to use Gin. </span><span class="koboSpan" id="kobo.1367.2">Put simply, if performance is critical, if you want middleware support, or if want minimalistic and fast routing, then use Gin.</span></p>
<h2 class="heading-2" id="_idParaDest-319"><span class="koboSpan" id="kobo.1368.1">Working with the database</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1369.1">In this subsection, we will show you how we work with the SQLite database that supports </span><a id="_idIndexMarker957"/><span class="koboSpan" id="kobo.1370.1">the functionality of the RESTful server. </span><span class="koboSpan" id="kobo.1370.2">The relevant file is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1371.1">./server/restdb.go</span></code><span class="koboSpan" id="kobo.1372.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1373.1">The RESTful server </span><a id="_idIndexMarker958"/><span class="koboSpan" id="kobo.1374.1">itself knows nothing about the SQLite database. </span><span class="koboSpan" id="kobo.1374.2">All related functionality is kept in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1375.1">restdb.go</span></code><span class="koboSpan" id="kobo.1376.1"> file, which means that if you change the database, the handler functions do not have to know about it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1377.1">The database name, the database table, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1378.1">admin</span></code><span class="koboSpan" id="kobo.1379.1"> user are created using the next </span><code class="inlineCode"><span class="koboSpan" id="kobo.1380.1">create_db.sql</span></code><span class="koboSpan" id="kobo.1381.1"> SQL file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1382.1">DROP</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1383.1">TABLE</span></span><span class="koboSpan" id="kobo.1384.1"> IF </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1385.1">EXISTS</span></span><span class="koboSpan" id="kobo.1386.1"> users;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1387.1">CREATE</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1388.1">TABLE</span></span><span class="koboSpan" id="kobo.1389.1"> users (
    UserID </span><span class="hljs-type"><span class="koboSpan" id="kobo.1390.1">INTEGER</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1391.1">PRIMARY</span></span><span class="koboSpan" id="kobo.1392.1"> KEY,
    username TEXT </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1393.1">NOT</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1394.1">NULL</span></span><span class="koboSpan" id="kobo.1395.1">,
    password TEXT </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1396.1">NOT</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1397.1">NULL</span></span><span class="koboSpan" id="kobo.1398.1">,
    lastlogin </span><span class="hljs-type"><span class="koboSpan" id="kobo.1399.1">INTEGER</span></span><span class="koboSpan" id="kobo.1400.1">,
    admin </span><span class="hljs-type"><span class="koboSpan" id="kobo.1401.1">INTEGER</span></span><span class="koboSpan" id="kobo.1402.1">,
    active </span><span class="hljs-type"><span class="koboSpan" id="kobo.1403.1">INTEGER</span></span><span class="koboSpan" id="kobo.1404.1">
);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1405.1">INSERT</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1406.1">INTO</span></span><span class="koboSpan" id="kobo.1407.1"> users (username, password, lastlogin, admin, active) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1408.1">VALUES</span></span><span class="koboSpan" id="kobo.1409.1"> (</span><span class="hljs-string"><span class="koboSpan" id="kobo.1410.1">'admin'</span></span><span class="koboSpan" id="kobo.1411.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1412.1">'admin'</span></span><span class="koboSpan" id="kobo.1413.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1414.1">1620922454</span></span><span class="koboSpan" id="kobo.1415.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1416.1">1</span></span><span class="koboSpan" id="kobo.1417.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1418.1">1</span></span><span class="koboSpan" id="kobo.1419.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1420.1">You can use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1421.1">create_db.sql</span></code><span class="koboSpan" id="kobo.1422.1"> as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1423.1">$ </span></span><span class="koboSpan" id="kobo.1424.1">sqlite3 REST.db
SQLite version 3.39.5 2022-10-14 20:58:05
Enter ".help" for usage hints.
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1425.1">sqlite&gt; </span></span><span class="koboSpan" id="kobo.1426.1">.</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.1427.1">read</span></span><span class="koboSpan" id="kobo.1428.1"> create_db.sql
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1429.1">We can </span><a id="_idIndexMarker959"/><span class="koboSpan" id="kobo.1430.1">verify that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1431.1">users</span></code><span class="koboSpan" id="kobo.1432.1"> table is </span><a id="_idIndexMarker960"/><span class="koboSpan" id="kobo.1433.1">created and contains the desired entry as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1434.1">$ </span></span><span class="koboSpan" id="kobo.1435.1">sqlite3 REST.db
SQLite version 3.39.5 2022-10-14 20:58:05
Enter ".help" for usage hints.
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1436.1">sqlite&gt; </span></span><span class="koboSpan" id="kobo.1437.1">.schema
CREATE TABLE users (
    UserID INTEGER PRIMARY KEY,
    username TEXT NOT NULL,
    password TEXT NOT NULL,
    lastlogin INTEGER,
    admin INTEGER,
    active INTEGER
);
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1438.1">sqlite&gt; </span></span><span class="koboSpan" id="kobo.1439.1">select * from </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.1440.1">users</span></span><span class="koboSpan" id="kobo.1441.1">;
1|admin|admin|1620922454|1|1
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1442.1">We are going to present the most important database-related functions, beginning with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1443.1">OpenConnection()</span></code><span class="koboSpan" id="kobo.1444.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1445.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1446.1">OpenConnection</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1447.1">()</span></span><span class="koboSpan" id="kobo.1448.1"> *sql.DB {
    db, err := sql.Open(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1449.1">"sqlite3"</span></span><span class="koboSpan" id="kobo.1450.1">, Filename)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1451.1">if</span></span><span class="koboSpan" id="kobo.1452.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1453.1">nil</span></span><span class="koboSpan" id="kobo.1454.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1455.1">"Error connecting:"</span></span><span class="koboSpan" id="kobo.1456.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1457.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1458.1">nil</span></span><span class="koboSpan" id="kobo.1459.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1460.1">return</span></span><span class="koboSpan" id="kobo.1461.1"> db
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1462.1">As we need to interact with SQLite3 all the time, we created a helper function that returns an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1463.1">*sql.DB</span></code><span class="koboSpan" id="kobo.1464.1"> variable, which is an open connection to SQLite3. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1465.1">Filename</span></code><span class="koboSpan" id="kobo.1466.1"> is a global variable that specifies the SQLite3 database file that is going to be used.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1467.1">Next, we present the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1468.1">DeleteUser()</span></code><span class="koboSpan" id="kobo.1469.1"> function:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1470.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1471.1">DeleteUser</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1472.1">(ID </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1473.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1474.1">)</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.1475.1">bool</span></span><span class="koboSpan" id="kobo.1476.1"> {
    db := OpenConnection()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1477.1">if</span></span><span class="koboSpan" id="kobo.1478.1"> db == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1479.1">nil</span></span><span class="koboSpan" id="kobo.1480.1"> {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1481.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1482.1">Cannot connect to SQLite3!"</span></span><span class="koboSpan" id="kobo.1483.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1484.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1485.1">false</span></span><span class="koboSpan" id="kobo.1486.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1487.1">defer</span></span><span class="koboSpan" id="kobo.1488.1"> db.Close()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1489.1">The preceding </span><a id="_idIndexMarker961"/><span class="koboSpan" id="kobo.1490.1">code is how we </span><a id="_idIndexMarker962"/><span class="koboSpan" id="kobo.1491.1">use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1492.1">OpenConnection()</span></code><span class="koboSpan" id="kobo.1493.1"> to get a database connection to work with.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1494.1">    t := FindUserID(ID)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1495.1">if</span></span><span class="koboSpan" id="kobo.1496.1"> t.ID == </span><span class="hljs-number"><span class="koboSpan" id="kobo.1497.1">0</span></span><span class="koboSpan" id="kobo.1498.1"> {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1499.1">"User"</span></span><span class="koboSpan" id="kobo.1500.1">, ID, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1501.1">"does not exist."</span></span><span class="koboSpan" id="kobo.1502.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1503.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1504.1">false</span></span><span class="koboSpan" id="kobo.1505.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1506.1">Here, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1507.1">FindUserID()</span></code><span class="koboSpan" id="kobo.1508.1"> helper function to make sure that the user with the given user ID exists in the database. </span><span class="koboSpan" id="kobo.1508.2">If the user does not exist, the function stops and returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.1509.1">false</span></code><span class="koboSpan" id="kobo.1510.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1511.1">    stmt, err := db.Prepare(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1512.1">"DELETE FROM users WHERE UserID = $1"</span></span><span class="koboSpan" id="kobo.1513.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1514.1">if</span></span><span class="koboSpan" id="kobo.1515.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1516.1">nil</span></span><span class="koboSpan" id="kobo.1517.1"> {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1518.1">"DeleteUser:"</span></span><span class="koboSpan" id="kobo.1519.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1520.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1521.1">false</span></span><span class="koboSpan" id="kobo.1522.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1523.1">This is the actual SQL statement for deleting the user. </span><span class="koboSpan" id="kobo.1523.2">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1524.1">Prepare()</span></code><span class="koboSpan" id="kobo.1525.1"> to construct the required SQL statement that we execute using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1526.1">Exec()</span></code><span class="koboSpan" id="kobo.1527.1">. </span><span class="koboSpan" id="kobo.1527.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1528.1">$1</span></code><span class="koboSpan" id="kobo.1529.1"> in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1530.1">Prepare()</span></code><span class="koboSpan" id="kobo.1531.1"> denotes a parameter that is going to be given in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1532.1">Exec()</span></code><span class="koboSpan" id="kobo.1533.1">. </span><span class="koboSpan" id="kobo.1533.2">If we wanted to have more parameters, we should have named them </span><code class="inlineCode"><span class="koboSpan" id="kobo.1534.1">$2</span></code><span class="koboSpan" id="kobo.1535.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1536.1">$3</span></code><span class="koboSpan" id="kobo.1537.1">, and so on.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1538.1">    _, err = stmt.Exec(ID)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1539.1">if</span></span><span class="koboSpan" id="kobo.1540.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1541.1">nil</span></span><span class="koboSpan" id="kobo.1542.1"> {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1543.1">"DeleteUser:"</span></span><span class="koboSpan" id="kobo.1544.1">, err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1545.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1546.1">false</span></span><span class="koboSpan" id="kobo.1547.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1548.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1549.1">true</span></span><span class="koboSpan" id="kobo.1550.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1551.1">This is where the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1552.1">DeleteUser()</span></code><span class="koboSpan" id="kobo.1553.1"> function ends. </span><span class="koboSpan" id="kobo.1553.2">The execution of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1554.1">stmt.Exec(ID)</span></code><span class="koboSpan" id="kobo.1555.1"> statement is what deletes a user from the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1556.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1557.1">ListAllUsers()</span></code><span class="koboSpan" id="kobo.1558.1"> function, which is presented next, returns a slice of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1559.1">User</span></code><span class="koboSpan" id="kobo.1560.1"> elements, which holds all users found in the RESTful server:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1561.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1562.1">ListAllUsers</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1563.1">()</span></span><span class="koboSpan" id="kobo.1564.1"> []User {
    db := OpenConnection()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1565.1">if</span></span><span class="koboSpan" id="kobo.1566.1"> db == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1567.1">nil</span></span><span class="koboSpan" id="kobo.1568.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1569.1">"Cannot connect to SQLite3!"</span></span><span class="koboSpan" id="kobo.1570.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1571.1">return</span></span><span class="koboSpan" id="kobo.1572.1"> []User{}
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1573.1">defer</span></span><span class="koboSpan" id="kobo.1574.1"> db.Close()
    rows, err := db.Query(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1575.1">"SELECT * FROM users \n"</span></span><span class="koboSpan" id="kobo.1576.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1577.1">if</span></span><span class="koboSpan" id="kobo.1578.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1579.1">nil</span></span><span class="koboSpan" id="kobo.1580.1"> {
        log.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1581.1">return</span></span><span class="koboSpan" id="kobo.1582.1"> []User{}
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1583.1">As </span><a id="_idIndexMarker963"/><span class="koboSpan" id="kobo.1584.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1585.1">SELECT</span></code><span class="koboSpan" id="kobo.1586.1"> query requires no parameters, we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1587.1">Query()</span></code><span class="koboSpan" id="kobo.1588.1"> to run it instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1589.1">Prepare()</span></code><span class="koboSpan" id="kobo.1590.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1591.1">Exec()</span></code><span class="koboSpan" id="kobo.1592.1">. </span><span class="koboSpan" id="kobo.1592.2">Keep in mind that this </span><a id="_idIndexMarker964"/><span class="koboSpan" id="kobo.1593.1">is a query that most likely returns multiple records.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1594.1">    all := []User{}
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1595.1">var</span></span><span class="koboSpan" id="kobo.1596.1"> c1 </span><span class="hljs-type"><span class="koboSpan" id="kobo.1597.1">int</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1598.1">var</span></span><span class="koboSpan" id="kobo.1599.1"> c2, c3 </span><span class="hljs-type"><span class="koboSpan" id="kobo.1600.1">string</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1601.1">var</span></span><span class="koboSpan" id="kobo.1602.1"> c4 </span><span class="hljs-type"><span class="koboSpan" id="kobo.1603.1">int64</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1604.1">var</span></span><span class="koboSpan" id="kobo.1605.1"> c5, c6 </span><span class="hljs-type"><span class="koboSpan" id="kobo.1606.1">int</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1607.1">for</span></span><span class="koboSpan" id="kobo.1608.1"> rows.Next() {
        err = rows.Scan(&amp;c1, &amp;c2, &amp;c3, &amp;c4, &amp;c5, &amp;c6)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1609.1">if</span></span><span class="koboSpan" id="kobo.1610.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1611.1">nil</span></span><span class="koboSpan" id="kobo.1612.1"> {
            log.Println(err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1613.1">return</span></span><span class="koboSpan" id="kobo.1614.1"> []User{}
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1615.1">This is how we read the values from a single record returned by the SQL query. </span><span class="koboSpan" id="kobo.1615.2">First, we define multiple variables for each one of the returned values and then we pass their pointers to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1616.1">Scan()</span></code><span class="koboSpan" id="kobo.1617.1">. </span><span class="koboSpan" id="kobo.1617.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1618.1">rows.Next()</span></code><span class="koboSpan" id="kobo.1619.1"> method keeps returning records as long as there are new results in the database.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1620.1">        temp := User{c1, c2, c3, c4, c5, c6}
        all = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1621.1">append</span></span><span class="koboSpan" id="kobo.1622.1">(all, temp)
    }
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1623.1">"All:"</span></span><span class="koboSpan" id="kobo.1624.1">, all)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1625.1">return</span></span><span class="koboSpan" id="kobo.1626.1"> all
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1627.1">So, as mentioned before, a slice of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1628.1">User</span></code><span class="koboSpan" id="kobo.1629.1"> structures is returned from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1630.1">ListAllUsers()</span></code><span class="koboSpan" id="kobo.1631.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1632.1">Lastly, we are going to present the implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1633.1">IsUserValid()</span></code><span class="koboSpan" id="kobo.1634.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1635.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1636.1">IsUserValid</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1637.1">(u User)</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.1638.1">bool</span></span><span class="koboSpan" id="kobo.1639.1"> {
    db := OpenConnection()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1640.1">if</span></span><span class="koboSpan" id="kobo.1641.1"> db == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1642.1">nil</span></span><span class="koboSpan" id="kobo.1643.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1644.1">"Cannot connect to SQLite3!"</span></span><span class="koboSpan" id="kobo.1645.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1646.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1647.1">false</span></span><span class="koboSpan" id="kobo.1648.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1649.1">defer</span></span><span class="koboSpan" id="kobo.1650.1"> db.Close()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1651.1">This is a </span><a id="_idIndexMarker965"/><span class="koboSpan" id="kobo.1652.1">common pattern: we call </span><code class="inlineCode"><span class="koboSpan" id="kobo.1653.1">OpenConnection()</span></code><span class="koboSpan" id="kobo.1654.1"> and wait </span><a id="_idIndexMarker966"/><span class="koboSpan" id="kobo.1655.1">to get a connection to use before continuing.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1656.1">    rows, err := db.Query(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1657.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1658.1">SELECT * FROM users WHERE username = $1 \n"</span></span><span class="koboSpan" id="kobo.1659.1">, u.Username)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1660.1">if</span></span><span class="koboSpan" id="kobo.1661.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1662.1">nil</span></span><span class="koboSpan" id="kobo.1663.1"> {
        log.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1664.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1665.1">false</span></span><span class="koboSpan" id="kobo.1666.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1667.1">Here, we pass our parameter to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1668.1">Query()</span></code><span class="koboSpan" id="kobo.1669.1"> without using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1670.1">Prepare()</span></code><span class="koboSpan" id="kobo.1671.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1672.1">Exec()</span></code><span class="koboSpan" id="kobo.1673.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1674.1">    temp := User{}
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1675.1">var</span></span><span class="koboSpan" id="kobo.1676.1"> c1 </span><span class="hljs-type"><span class="koboSpan" id="kobo.1677.1">int</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1678.1">var</span></span><span class="koboSpan" id="kobo.1679.1"> c2, c3 </span><span class="hljs-type"><span class="koboSpan" id="kobo.1680.1">string</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1681.1">var</span></span><span class="koboSpan" id="kobo.1682.1"> c4 </span><span class="hljs-type"><span class="koboSpan" id="kobo.1683.1">int64</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1684.1">var</span></span><span class="koboSpan" id="kobo.1685.1"> c5, c6 </span><span class="hljs-type"><span class="koboSpan" id="kobo.1686.1">int</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1687.1">Next, we create the required parameters to keep the return values of the SQL query.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.1688.1">// If there exist multiple users with the same username,</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1689.1">// we will get the FIRST ONE only.</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1690.1">for</span></span><span class="koboSpan" id="kobo.1691.1"> rows.Next() {
        err = rows.Scan(&amp;c1, &amp;c2, &amp;c3, &amp;c4, &amp;c5, &amp;c6)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1692.1">if</span></span><span class="koboSpan" id="kobo.1693.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1694.1">nil</span></span><span class="koboSpan" id="kobo.1695.1"> {
            log.Println(err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1696.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1697.1">false</span></span><span class="koboSpan" id="kobo.1698.1">
        }
        temp = User{c1, c2, c3, c4, c5, c6}
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1699.1">Once again, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1700.1">for</span></code><span class="koboSpan" id="kobo.1701.1"> loop keeps running for as long as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1702.1">rows.Next()</span></code><span class="koboSpan" id="kobo.1703.1"> returns new records.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1704.1">if</span></span><span class="koboSpan" id="kobo.1705.1"> u.Username == temp.Username &amp;&amp; u.Password == temp.Password {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1706.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1707.1">true</span></span><span class="koboSpan" id="kobo.1708.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1709.1">This is an important point: not only should the given user exist, but the given password should be the same as the one stored in the database for the given user to be valid.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1710.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1711.1">false</span></span><span class="koboSpan" id="kobo.1712.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1713.1">You can </span><a id="_idIndexMarker967"/><span class="koboSpan" id="kobo.1714.1">view the rest of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1715.1">restdb.go</span></code><span class="koboSpan" id="kobo.1716.1"> source code </span><a id="_idIndexMarker968"/><span class="koboSpan" id="kobo.1717.1">on your own. </span><span class="koboSpan" id="kobo.1717.2">Most functions are like the ones presented here. </span><span class="koboSpan" id="kobo.1717.3">The code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1718.1">restdb.go</span></code><span class="koboSpan" id="kobo.1719.1"> is going to be used in the implementation of the RESTful server that is presented next.</span></p>
<h2 class="heading-2" id="_idParaDest-320"><span class="koboSpan" id="kobo.1720.1">Implementing the RESTful server</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1721.1">We are now ready to begin explaining the implementation of the RESTful server. </span><span class="koboSpan" id="kobo.1721.2">The server code </span><a id="_idIndexMarker969"/><span class="koboSpan" id="kobo.1722.1">is split into three files that belong to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1723.1">main</span></code><span class="koboSpan" id="kobo.1724.1"> package. </span><span class="koboSpan" id="kobo.1724.2">So, apart from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1725.1">restdb.go</span></code><span class="koboSpan" id="kobo.1726.1">, we have </span><code class="inlineCode"><span class="koboSpan" id="kobo.1727.1">main.go</span></code><span class="koboSpan" id="kobo.1728.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1729.1">handlers.go</span></code><span class="koboSpan" id="kobo.1730.1">. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1731.1">The main reason for doing so is to not have to work with huge source code files and to separate the functionality of the server logically.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1732.1">The most important part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1733.1">main.go</span></code><span class="koboSpan" id="kobo.1734.1">, which belongs to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1735.1">main()</span></code><span class="koboSpan" id="kobo.1736.1"> function, is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1737.1">    rMux.NotFoundHandler = http.HandlerFunc(DefaultHandler)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1738.1">So, we define the default handler function. </span><span class="koboSpan" id="kobo.1738.2">Although this is not necessary, it is a good practice to have such a handler.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1739.1">    notAllowed := notAllowedHandler{}
    rMux.MethodNotAllowedHandler = notAllowed
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1740.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1741.1">MethodNotAllowedHandler</span></code><span class="koboSpan" id="kobo.1742.1"> handler is executed when you try to visit an endpoint using an unsupported HTTP method. </span><span class="koboSpan" id="kobo.1742.2">The actual implementation of the handler is found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1743.1">handlers.go</span></code><span class="koboSpan" id="kobo.1744.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1745.1">    rMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1746.1">"/time"</span></span><span class="koboSpan" id="kobo.1747.1">, TimeHandler)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1748.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1749.1">/time</span></code><span class="koboSpan" id="kobo.1750.1"> endpoint is supported by all HTTP methods, so it does not belong to any subrouter.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.1751.1">// Define Handler Functions</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1752.1">// Register GET</span></span><span class="koboSpan" id="kobo.1753.1">
    getMux := rMux.Methods(http.MethodGet).Subrouter()
    getMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1754.1">"/getall"</span></span><span class="koboSpan" id="kobo.1755.1">, GetAllHandler)
    getMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1756.1">"/getid/{username}"</span></span><span class="koboSpan" id="kobo.1757.1">, GetIDHandler)
    getMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1758.1">"/logged"</span></span><span class="koboSpan" id="kobo.1759.1">, LoggedUsersHandler)
    getMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1760.1">"/username/{id:[0-9]+}"</span></span><span class="koboSpan" id="kobo.1761.1">, GetUserDataHandler)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1762.1">First, we define </span><a id="_idIndexMarker970"/><span class="koboSpan" id="kobo.1763.1">a subrouter for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1764.1">GET</span></code><span class="koboSpan" id="kobo.1765.1"> HTTP method along with the supported endpoints. </span><span class="koboSpan" id="kobo.1765.2">Remember that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1766.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1767.1"> is responsible for making sure that only </span><code class="inlineCode"><span class="koboSpan" id="kobo.1768.1">GET</span></code><span class="koboSpan" id="kobo.1769.1"> requests are going to be served by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1770.1">getMux</span></code><span class="koboSpan" id="kobo.1771.1"> subrouter.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.1772.1">// Register PUT</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1773.1">// Update User</span></span><span class="koboSpan" id="kobo.1774.1">
    putMux := rMux.Methods(http.MethodPut).Subrouter()
    putMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1775.1">"/update"</span></span><span class="koboSpan" id="kobo.1776.1">, UpdateHandler)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1777.1">After that, we define a subrouter for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1778.1">PUT</span></code><span class="koboSpan" id="kobo.1779.1"> requests.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.1780.1">// Register POST</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1781.1">// Add User + Login + Logout</span></span><span class="koboSpan" id="kobo.1782.1">
    postMux := rMux.Methods(http.MethodPost).Subrouter()
    postMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1783.1">"/add"</span></span><span class="koboSpan" id="kobo.1784.1">, AddHandler)
    postMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1785.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1786.1">/login"</span></span><span class="koboSpan" id="kobo.1787.1">, LoginHandler)
    postMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1788.1">"/logout"</span></span><span class="koboSpan" id="kobo.1789.1">, LogoutHandler)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1790.1">Then, we define the subrouter for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1791.1">POST</span></code><span class="koboSpan" id="kobo.1792.1"> requests.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.1793.1">// Register DELETE</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1794.1">// Delete User</span></span><span class="koboSpan" id="kobo.1795.1">
    deleteMux := rMux.Methods(http.MethodDelete).Subrouter()
    deleteMux.HandleFunc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1796.1">"/username/{id:[0-9]+}"</span></span><span class="koboSpan" id="kobo.1797.1">, DeleteHandler)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1798.1">The last subrouter is for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1799.1">DELETE</span></code><span class="koboSpan" id="kobo.1800.1"> HTTP methods. </span><span class="koboSpan" id="kobo.1800.2">The code in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1801.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.1802.1"> is responsible for choosing the correct subrouter based on the details of the client request.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1803.1">go</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1804.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1805.1">()</span></span><span class="koboSpan" id="kobo.1806.1"> {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1807.1">"Listening to"</span></span><span class="koboSpan" id="kobo.1808.1">, PORT)
        err := s.ListenAndServe()
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1809.1">if</span></span><span class="koboSpan" id="kobo.1810.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1811.1">nil</span></span><span class="koboSpan" id="kobo.1812.1"> {
            log.Printf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1813.1">"Error starting server: %s\n"</span></span><span class="koboSpan" id="kobo.1814.1">, err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1815.1">return</span></span><span class="koboSpan" id="kobo.1816.1">
        }
    }()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1817.1">The HTTP server is executed as a goroutine because the program supports signal handlingâ€”refer to </span><em class="chapterRef"><span class="koboSpan" id="kobo.1818.1">Chapter 8</span></em><span class="koboSpan" id="kobo.1819.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1820.1">Go Concurrency</span></em><span class="koboSpan" id="kobo.1821.1">, for more details.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1822.1">    sigs := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1823.1">make</span></span><span class="koboSpan" id="kobo.1824.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1825.1">chan</span></span><span class="koboSpan" id="kobo.1826.1"> os.Signal, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1827.1">1</span></span><span class="koboSpan" id="kobo.1828.1">)
    signal.Notify(sigs, os.Interrupt)
    sig := &lt;-sigs
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1829.1">"Quitting after signal:"</span></span><span class="koboSpan" id="kobo.1830.1">, sig)
    time.Sleep(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1831.1">5</span></span><span class="koboSpan" id="kobo.1832.1"> * time.Second)
    s.Shutdown(</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1833.1">nil</span></span><span class="koboSpan" id="kobo.1834.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1835.1">Last, we add </span><a id="_idIndexMarker971"/><span class="koboSpan" id="kobo.1836.1">signal handling for gracefully terminating the HTTP server. </span><span class="koboSpan" id="kobo.1836.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1837.1">sig := &lt;-sigs</span></code><span class="koboSpan" id="kobo.1838.1"> statement prevents the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1839.1">main()</span></code><span class="koboSpan" id="kobo.1840.1"> function from exiting unless an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1841.1">os.Interrupt</span></code><span class="koboSpan" id="kobo.1842.1"> signal is received.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1843.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1844.1">handlers.go</span></code><span class="koboSpan" id="kobo.1845.1"> file contains the implementations for the handler functions and is also part of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1846.1">main</span></code><span class="koboSpan" id="kobo.1847.1"> packageâ€”its most important parts are the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1848.1">// AddHandler is for adding a new user</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1849.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1850.1">AddHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1851.1">(rw http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.1852.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1853.1">"AddHandler Serving:"</span></span><span class="koboSpan" id="kobo.1854.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1855.1">"from"</span></span><span class="koboSpan" id="kobo.1856.1">, r.Host)
    d, err := io.ReadAll(r.Body)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1857.1">if</span></span><span class="koboSpan" id="kobo.1858.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1859.1">nil</span></span><span class="koboSpan" id="kobo.1860.1"> {
        rw.WriteHeader(http.StatusBadRequest)
        log.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1861.1">return</span></span><span class="koboSpan" id="kobo.1862.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1863.1">This handler is for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1864.1">/add</span></code><span class="koboSpan" id="kobo.1865.1"> endpoint. </span><span class="koboSpan" id="kobo.1865.2">The server reads the client input using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1866.1">io.ReadAll()</span></code><span class="koboSpan" id="kobo.1867.1"> and makes sure that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1868.1">io.ReadAll()</span></code><span class="koboSpan" id="kobo.1869.1"> call was successful.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1870.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1871.1">len</span></span><span class="koboSpan" id="kobo.1872.1">(d) == </span><span class="hljs-number"><span class="koboSpan" id="kobo.1873.1">0</span></span><span class="koboSpan" id="kobo.1874.1"> {
        rw.WriteHeader(http.StatusBadRequest)
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1875.1">"No input!"</span></span><span class="koboSpan" id="kobo.1876.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1877.1">return</span></span><span class="koboSpan" id="kobo.1878.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1879.1">Then, the code makes sure that the body of the client request is not empty.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.1880.1">// We read two structures as an array:</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1881.1">// 1. </span><span class="koboSpan" id="kobo.1881.2">The user issuing the command</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1882.1">// 2. </span><span class="koboSpan" id="kobo.1882.2">The user to be added</span></span><span class="koboSpan" id="kobo.1883.1">
    users := []User{}
    err = json.Unmarshal(d, &amp;users)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1884.1">if</span></span><span class="koboSpan" id="kobo.1885.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1886.1">nil</span></span><span class="koboSpan" id="kobo.1887.1"> {
        log.Println(err)
        rw.WriteHeader(http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1888.1">return</span></span><span class="koboSpan" id="kobo.1889.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1890.1">As the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1891.1">/add</span></code><span class="koboSpan" id="kobo.1892.1"> endpoint </span><a id="_idIndexMarker972"/><span class="koboSpan" id="kobo.1893.1">requires two </span><code class="inlineCode"><span class="koboSpan" id="kobo.1894.1">User</span></code><span class="koboSpan" id="kobo.1895.1"> structures, the previous code uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.1896.1">json.Unmarshal()</span></code><span class="koboSpan" id="kobo.1897.1"> to put them into a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1898.1">[]User</span></code><span class="koboSpan" id="kobo.1899.1"> variableâ€”this means that the client should send these two JSON records using an array.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1900.1">    log.Println(users)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1901.1">if</span></span><span class="koboSpan" id="kobo.1902.1"> !IsUserAdmin(users[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1903.1">0</span></span><span class="koboSpan" id="kobo.1904.1">]) {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1905.1">"Issued by non-admin user:"</span></span><span class="koboSpan" id="kobo.1906.1">, users[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1907.1">0</span></span><span class="koboSpan" id="kobo.1908.1">].Username)
        rw.WriteHeader(http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1909.1">return</span></span><span class="koboSpan" id="kobo.1910.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1911.1">If the user issuing the command does not have administrative privileges, then the request fails. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1912.1">IsUserAdmin()</span></code><span class="koboSpan" id="kobo.1913.1"> is implemented in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1914.1">restdb.go</span></code><span class="koboSpan" id="kobo.1915.1"> as it has to do with the data stored in the database.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1916.1">    result := InsertUser(users[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1917.1">1</span></span><span class="koboSpan" id="kobo.1918.1">])
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1919.1">if</span></span><span class="koboSpan" id="kobo.1920.1"> !result {
        rw.WriteHeader(http.StatusBadRequest)
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1921.1">Otherwise, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1922.1">InsertUser()</span></code><span class="koboSpan" id="kobo.1923.1"> inserts the desired user into the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1924.1">Last, we present the handler for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1925.1">/getall</span></code><span class="koboSpan" id="kobo.1926.1"> endpoint.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1927.1">// GetAllHandler is for getting all data from the user database</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1928.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1929.1">GetAllHandler</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1930.1">(rw http.ResponseWriter, r *http.Request)</span></span><span class="koboSpan" id="kobo.1931.1"> {
    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1932.1">"GetAllHandler Serving:"</span></span><span class="koboSpan" id="kobo.1933.1">, r.URL.Path, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1934.1">"from"</span></span><span class="koboSpan" id="kobo.1935.1">, r.Host)
    d, err := io.ReadAll(r.Body)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1936.1">if</span></span><span class="koboSpan" id="kobo.1937.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1938.1">nil</span></span><span class="koboSpan" id="kobo.1939.1"> {
        rw.WriteHeader(http.StatusBadRequest)
        log.Println(err)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1940.1">return</span></span><span class="koboSpan" id="kobo.1941.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1942.1">Once again, we read the data from the client using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1943.1">io.ReadAll(r.Body)</span></code><span class="koboSpan" id="kobo.1944.1"> and we make sure that </span><a id="_idIndexMarker973"/><span class="koboSpan" id="kobo.1945.1">the process is error-free by examining the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1946.1">err</span></code><span class="koboSpan" id="kobo.1947.1"> variable.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1948.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1949.1">len</span></span><span class="koboSpan" id="kobo.1950.1">(d) == </span><span class="hljs-number"><span class="koboSpan" id="kobo.1951.1">0</span></span><span class="koboSpan" id="kobo.1952.1"> {
        rw.WriteHeader(http.StatusBadRequest)
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1953.1">"No input!"</span></span><span class="koboSpan" id="kobo.1954.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1955.1">return</span></span><span class="koboSpan" id="kobo.1956.1">
    }
    user := User{}
    err = json.Unmarshal(d, &amp;user)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1957.1">if</span></span><span class="koboSpan" id="kobo.1958.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1959.1">nil</span></span><span class="koboSpan" id="kobo.1960.1"> {
        log.Println(err)
        rw.WriteHeader(http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1961.1">return</span></span><span class="koboSpan" id="kobo.1962.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1963.1">Here, we put the client data into a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1964.1">User</span></code><span class="koboSpan" id="kobo.1965.1"> variable. </span><span class="koboSpan" id="kobo.1965.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1966.1">/getall</span></code><span class="koboSpan" id="kobo.1967.1"> endpoint requires a single </span><code class="inlineCode"><span class="koboSpan" id="kobo.1968.1">User</span></code><span class="koboSpan" id="kobo.1969.1"> record as input.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1970.1">if</span></span><span class="koboSpan" id="kobo.1971.1"> !IsUserAdmin(user) {
        log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1972.1">"User"</span></span><span class="koboSpan" id="kobo.1973.1">, user, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1974.1">"is not an admin!"</span></span><span class="koboSpan" id="kobo.1975.1">)
        rw.WriteHeader(http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1976.1">return</span></span><span class="koboSpan" id="kobo.1977.1">
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1978.1">Only admin users can visit </span><code class="inlineCode"><span class="koboSpan" id="kobo.1979.1">/getall</span></code><span class="koboSpan" id="kobo.1980.1"> and get the list of all users, hence the use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1981.1">IsUserAdmin()</span></code><span class="koboSpan" id="kobo.1982.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1983.1">    err = SliceToJSON(ListAllUsers(), rw)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1984.1">if</span></span><span class="koboSpan" id="kobo.1985.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1986.1">nil</span></span><span class="koboSpan" id="kobo.1987.1"> {
        log.Println(err)
        rw.WriteHeader(http.StatusBadRequest)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1988.1">return</span></span><span class="koboSpan" id="kobo.1989.1">
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1990.1">The last part of the code is about getting the desired data from the database and sending it to the client using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1991.1">SliceToJSON(ListAllUsers(), rw)</span></code><span class="koboSpan" id="kobo.1992.1"> call.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1993.1">Feel free to put each handler into a separate Go file. </span><span class="koboSpan" id="kobo.1993.2">The general idea is that if you have many handler functions, using a separate file for each handler function is a good practice. </span><span class="koboSpan" id="kobo.1993.3">Among </span><a id="_idIndexMarker974"/><span class="koboSpan" id="kobo.1994.1">other things, it allows multiple developers to work on multiple handler functions without bothering each other.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1995.1">Before developing a proper command line client, it would be a good idea to test the RESTful server using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1996.1">curl(1)</span></code><span class="koboSpan" id="kobo.1997.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-321"><span class="koboSpan" id="kobo.1998.1">Testing the RESTful server</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1999.1">This subsection shows how to test the RESTful server using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2000.1">curl(1)</span></code><span class="koboSpan" id="kobo.2001.1"> utility. </span><span class="koboSpan" id="kobo.2001.2">You should test </span><a id="_idIndexMarker975"/><span class="koboSpan" id="kobo.2002.1">the RESTful server as much and as extensively as possible to find bugs or unwanted behavior. </span><span class="koboSpan" id="kobo.2002.2">As we use three files for the server implementation, we need to run it as </span><code class="inlineCode"><span class="koboSpan" id="kobo.2003.1">go run main.go restdb.go handlers.go</span></code><span class="koboSpan" id="kobo.2004.1">. </span><span class="koboSpan" id="kobo.2004.2">We begin by testing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2005.1">/time</span></code><span class="koboSpan" id="kobo.2006.1"> handler, which works with all HTTP methods:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2007.1">$ </span></span><span class="koboSpan" id="kobo.2008.1">curl localhost:1234/time
The current time is: Mon, 30 Oct 2023 19:38:21 EET
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2009.1">Next, we test the default handler:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2010.1">$ </span></span><span class="koboSpan" id="kobo.2011.1">curl localhost:1234/
/ is not supported. </span><span class="koboSpan" id="kobo.2011.2">Thanks for visiting!
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2012.1">$ </span></span><span class="koboSpan" id="kobo.2013.1">curl localhost:1234/doesNotExist
/doesNotExist is not supported. </span><span class="koboSpan" id="kobo.2013.2">Thanks for visiting!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2014.1">Last, we see what happens if we use an unsupported HTTP method with a supported endpointâ€”in this case, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2015.1">/getall</span></code><span class="koboSpan" id="kobo.2016.1"> endpoint that works with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2017.1">GET</span></code><span class="koboSpan" id="kobo.2018.1"> only:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2019.1">$ </span></span><span class="koboSpan" id="kobo.2020.1">curl -s -X PUT -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2021.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2022.1"> localhost:1234/getall
Method not allowed!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2023.1">Although the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2024.1">/getall</span></code><span class="koboSpan" id="kobo.2025.1"> endpoint requires a valid user to operate, the fact that we are using an HTTP method that is not supported by that endpoint takes precedence and the call fails for the right reasons.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2026.1">It is important to look at the output of the RESTful server and the log entries that it generates during testing. </span><span class="koboSpan" id="kobo.2026.2">Not all information can be sent back to a client, but the server process is allowed to print anything we want. </span><span class="koboSpan" id="kobo.2026.3">This can be very helpful for debugging a server process such as our RESTful server.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2027.1">The next subsection tests all of the handlers that support the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2028.1">GET</span></code><span class="koboSpan" id="kobo.2029.1"> HTTP method.</span></p>
<h2 class="heading-2" id="_idParaDest-322"><span class="koboSpan" id="kobo.2030.1">Testing GET handlers</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2031.1">First, we test </span><a id="_idIndexMarker976"/><span class="koboSpan" id="kobo.2032.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2033.1">/getall</span></code><span class="koboSpan" id="kobo.2034.1"> endpointâ€”your output </span><a id="_idIndexMarker977"/><span class="koboSpan" id="kobo.2035.1">might vary depending on the contents of the SQLite database:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2036.1">$ </span></span><span class="koboSpan" id="kobo.2037.1">curl -s -X GET -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2038.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2039.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2040.1">'{"username": "admin", "password" : "justChanged"}'</span></span><span class="koboSpan" id="kobo.2041.1"> localhost:1234/getall
[{"id":1,"username":"admin","password":"justChanged","lastlogin":1620922454,"admin":1,"active":1},{"id":2,"username":"","password":"admin","lastlogin":0,"admin":0,"active":0},{"id":3,"username":"mihalis","password":"admin","lastlogin":0,"admin":0,"active":0},{"id":4,"username":"newUser","password":"aPass","lastlogin":0,"admin":0,"active":0}]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2042.1">The previous output is a list of all existing users found in the database in JSON format. </span><span class="koboSpan" id="kobo.2042.2">You can always process the generated output with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2043.1">jq(1)</span></code><span class="koboSpan" id="kobo.2044.1"> utility for a better-looking output.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2045.1">Then, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2046.1">/logged</span></code><span class="koboSpan" id="kobo.2047.1"> endpoint:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2048.1">$ </span></span><span class="koboSpan" id="kobo.2049.1">curl -X GET -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2050.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2051.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2052.1">'{"username": "admin", "password" : "justChanged"}'</span></span><span class="koboSpan" id="kobo.2053.1"> localhost:1234/logged
[{"id":1,"username":"admin","password":"justChanged","lastlogin":1620922454,"admin":1,"active":1}]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2054.1">After that, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2055.1">/username/{id}</span></code><span class="koboSpan" id="kobo.2056.1"> endpoint:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2057.1">$ </span></span><span class="koboSpan" id="kobo.2058.1">curl -X GET -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2059.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2060.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2061.1">'{"username": "admin", "password" : "justChanged"}'</span></span><span class="koboSpan" id="kobo.2062.1"> localhost:1234/username/3
{"id":3,"username":"mihalis","password":"admin","lastlogin":0,"admin":0,"active":0}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2063.1">Last, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2064.1">/getid/{username}</span></code><span class="koboSpan" id="kobo.2065.1"> endpoint:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2066.1">$ </span></span><span class="koboSpan" id="kobo.2067.1">curl -X GET -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2068.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2069.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2070.1">'{"username": "admin", "password" : "justChanged"}'</span></span><span class="koboSpan" id="kobo.2071.1"> localhost:1234/getid/mihalis
{"id":3,"username":"mihalis","password":"admin","lastlogin":0,"admin":0,"active":0}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2072.1">So, user </span><code class="inlineCode"><span class="koboSpan" id="kobo.2073.1">mihalis</span></code><span class="koboSpan" id="kobo.2074.1"> has a user ID of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2075.1">3</span></code><span class="koboSpan" id="kobo.2076.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2077.1">So far, we can get a list of existing users and a list of logged-in users and get information about specific usersâ€”all of these endpoints use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2078.1">GET</span></code><span class="koboSpan" id="kobo.2079.1"> method. </span><span class="koboSpan" id="kobo.2079.2">The next subsection tests all of the handlers that support the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2080.1">POST</span></code><span class="koboSpan" id="kobo.2081.1"> method.</span></p>
<h2 class="heading-2" id="_idParaDest-323"><span class="koboSpan" id="kobo.2082.1">Testing POST handlers</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2083.1">First, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2084.1">/add</span></code><span class="koboSpan" id="kobo.2085.1"> endpoint by adding the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2086.1">packt</span></code><span class="koboSpan" id="kobo.2087.1"> user, which does not have admin privileges:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2088.1">$ </span></span><span class="koboSpan" id="kobo.2089.1">curl -X POST -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2090.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2091.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2092.1">'[{"username": "admin", "password" : "justChanged", "admin":1}, {"username": "packt", "password" : "admin", "admin":0} ]'</span></span><span class="koboSpan" id="kobo.2093.1"> localhost:1234/add
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2094.1">The previous </span><a id="_idIndexMarker978"/><span class="koboSpan" id="kobo.2095.1">call passes an array of two JSON records to the server. </span><span class="koboSpan" id="kobo.2095.2">The second record comes with the details of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2096.1">packt</span></code><span class="koboSpan" id="kobo.2097.1"> user. </span><span class="koboSpan" id="kobo.2097.2">The command is issued by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2098.1">admin</span></code><span class="koboSpan" id="kobo.2099.1"> user as specified by the data in the first JSON record.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2100.1">If we try to </span><a id="_idIndexMarker979"/><span class="koboSpan" id="kobo.2101.1">add the same username more than once, the process is going to failâ€”this is revealed with the use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2102.1">-v</span></code><span class="koboSpan" id="kobo.2103.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2104.1">curl(1)</span></code><span class="koboSpan" id="kobo.2105.1"> command. </span><span class="koboSpan" id="kobo.2105.2">The relevant error message is going to be </span><code class="inlineCode"><span class="koboSpan" id="kobo.2106.1">HTTP/1.1 400 Bad Request</span></code><span class="koboSpan" id="kobo.2107.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2108.1">Additionally, if we try to add a new user using the credentials of a user that is not an administrator, the server is going to generate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2109.1">Command issued by non-admin user: packt</span></code><span class="koboSpan" id="kobo.2110.1"> message.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2111.1">Next, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2112.1">/login</span></code><span class="koboSpan" id="kobo.2113.1"> endpoint:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2114.1">$ </span></span><span class="koboSpan" id="kobo.2115.1">curl -X POST -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2116.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2117.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2118.1">'{"username": "packt", "password" : "admin"}'</span></span><span class="koboSpan" id="kobo.2119.1"> localhost:1234/login
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2120.1">The previous command is used for logging in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2121.1">packt</span></code><span class="koboSpan" id="kobo.2122.1"> user.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2123.1">Last, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2124.1">/logout</span></code><span class="koboSpan" id="kobo.2125.1"> endpoint:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2126.1">$ </span></span><span class="koboSpan" id="kobo.2127.1">curl -X POST -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2128.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2129.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2130.1">'{"username": "packt", "password" : "admin"}'</span></span><span class="koboSpan" id="kobo.2131.1"> localhost:1234/logout
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2132.1">The previous command is used for logging out the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2133.1">packt</span></code><span class="koboSpan" id="kobo.2134.1"> user. </span><span class="koboSpan" id="kobo.2134.2">You can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2135.1">/logged</span></code><span class="koboSpan" id="kobo.2136.1"> endpoint to verify the results of the previous two interactions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2137.1">Let us now test the only endpoint that supports the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2138.1">PUT</span></code><span class="koboSpan" id="kobo.2139.1"> HTTP method.</span></p>
<h2 class="heading-2" id="_idParaDest-324"><span class="koboSpan" id="kobo.2140.1">Testing the PUT handler</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2141.1">First, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2142.1">/update</span></code><span class="koboSpan" id="kobo.2143.1"> endpoint as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2144.1">$ </span></span><span class="koboSpan" id="kobo.2145.1">curl -X PUT -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2146.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2147.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2148.1">'[{"username": "admin", "password" : "admin", "admin":1}, {"username": "admin", "password" : "justChanged", "admin":1} ]'</span></span><span class="koboSpan" id="kobo.2149.1"> localhost:1234/update
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2150.1">The previous </span><a id="_idIndexMarker980"/><span class="koboSpan" id="kobo.2151.1">command changes the password </span><a id="_idIndexMarker981"/><span class="koboSpan" id="kobo.2152.1">of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2153.1">admin</span></code><span class="koboSpan" id="kobo.2154.1"> user from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2155.1">admin</span></code><span class="koboSpan" id="kobo.2156.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2157.1">justChanged</span></code><span class="koboSpan" id="kobo.2158.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2159.1">Then, we try to change a user password using the credentials of a non-admin user (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2160.1">packt</span></code><span class="koboSpan" id="kobo.2161.1">):</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2162.1">$ </span></span><span class="koboSpan" id="kobo.2163.1">curl -X PUT -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2164.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2165.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2166.1">'[{"Username":"packt","Password":"admin"}, {"username": "admin", "password" : "justChanged", "admin":1} ]'</span></span><span class="koboSpan" id="kobo.2167.1"> localhost:1234/update
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2168.1">The generated log message is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2169.1">Command issued by non-admin user: packt</span></code><span class="koboSpan" id="kobo.2170.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2171.1">We might consider the fact that a non-admin user cannot even change their password as a flawâ€”it might be, but this is the way the RESTful server is implemented. </span><span class="koboSpan" id="kobo.2171.2">The idea is that non-admin users should not issue dangerous commands directly. </span><span class="koboSpan" id="kobo.2171.3">Additionally, this flaw can be easily fixed as follows: Generally speaking, regular users are not going to interact in this way with the server and are going to be offered a web interface for doing so. </span><span class="koboSpan" id="kobo.2171.4">After that, an admin user can send the user request to the server. </span><span class="koboSpan" id="kobo.2171.5">Therefore, this can be implemented in a different way that is more secure and does not give unnecessary privileges to regular users.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2172.1">Lastly, we are going to test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2173.1">DELETE</span></code><span class="koboSpan" id="kobo.2174.1"> HTTP method.</span></p>
<h2 class="heading-2" id="_idParaDest-325"><span class="koboSpan" id="kobo.2175.1">Testing the DELETE handler</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2176.1">For the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2177.1">DELETE</span></code><span class="koboSpan" id="kobo.2178.1"> HTTP method, we need to test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2179.1">/username/{id}</span></code><span class="koboSpan" id="kobo.2180.1"> endpoint. </span><span class="koboSpan" id="kobo.2180.2">As this endpoint </span><a id="_idIndexMarker982"/><span class="koboSpan" id="kobo.2181.1">does not return any output, using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2182.1">-v</span></code><span class="koboSpan" id="kobo.2183.1"> in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2184.1">curl(1)</span></code><span class="koboSpan" id="kobo.2185.1"> is going </span><a id="_idIndexMarker983"/><span class="koboSpan" id="kobo.2186.1">to reveal the returned HTTP status code:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2187.1">$ </span></span><span class="koboSpan" id="kobo.2188.1">curl -X DELETE -H </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2189.1">'Content-Type: application/json'</span></span><span class="koboSpan" id="kobo.2190.1"> -d </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2191.1">'{"username": "admin", "password" : "justChanged"}'</span></span><span class="koboSpan" id="kobo.2192.1"> localhost:1234/username/4 -v
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2193.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2194.1">HTTP/1.1 200 OK</span></code><span class="koboSpan" id="kobo.2195.1"> status code verifies that the user was deleted successfully. </span><span class="koboSpan" id="kobo.2195.2">If we try to delete the same user again, the request is going to fail, and the returned message is going to be </span><code class="inlineCode"><span class="koboSpan" id="kobo.2196.1">HTTP/1.1 404 Not Found</span></code><span class="koboSpan" id="kobo.2197.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2198.1">So far, we </span><a id="_idIndexMarker984"/><span class="koboSpan" id="kobo.2199.1">know that the RESTful server works as </span><a id="_idIndexMarker985"/><span class="koboSpan" id="kobo.2200.1">expected. </span><span class="koboSpan" id="kobo.2200.2">However, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2201.1">curl(1)</span></code><span class="koboSpan" id="kobo.2202.1"> is far from perfect for working with the RESTful server on a daily basis. </span><span class="koboSpan" id="kobo.2202.2">The next section shows how to develop a command line client for the RESTful server.</span></p>
<h1 class="heading-1" id="_idParaDest-326"><span class="koboSpan" id="kobo.2203.1">Creating a RESTful client</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2204.1">Creating a RESTful client is much easier than programming a server mainly because you do not have </span><a id="_idIndexMarker986"/><span class="koboSpan" id="kobo.2205.1">to work with the database on the client side. </span><span class="koboSpan" id="kobo.2205.2">The only thing that the client needs to do is send the right amount and kind of data to the server and receive back and interpret the server response. </span><span class="koboSpan" id="kobo.2205.3">The full RESTful client implementation can be found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2206.1">./ch11/client</span></code><span class="koboSpan" id="kobo.2207.1"> of the book GitHub repository.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2208.1">The supported first-level cobra commands are going to be the following:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2209.1">list</span></code><span class="koboSpan" id="kobo.2210.1">: This command accesses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2211.1">/getall</span></code><span class="koboSpan" id="kobo.2212.1"> endpoint and returns the list of all available users.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2213.1">time</span></code><span class="koboSpan" id="kobo.2214.1">: This command is for visiting the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2215.1">/time</span></code><span class="koboSpan" id="kobo.2216.1"> endpoint.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2217.1">update</span></code><span class="koboSpan" id="kobo.2218.1">: This command is for updating user recordsâ€”the user ID cannot change.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2219.1">logged</span></code><span class="koboSpan" id="kobo.2220.1">: This command lists all logged-in users.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2221.1">delete</span></code><span class="koboSpan" id="kobo.2222.1">: This command deletes an existing user.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2223.1">login</span></code><span class="koboSpan" id="kobo.2224.1">: This command is for logging in a user.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2225.1">logout</span></code><span class="koboSpan" id="kobo.2226.1">: This command is for logging out a user.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2227.1">add</span></code><span class="koboSpan" id="kobo.2228.1">: This command is for adding a new user to the system.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2229.1">getid</span></code><span class="koboSpan" id="kobo.2230.1">: This command returns the ID of a user, identified by their username.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2231.1">search</span></code><span class="koboSpan" id="kobo.2232.1">: This command displays information about a given user, identified by their ID.</span></li>
</ul>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2233.1">A client like the one we are about to present is much better than working with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2234.1">curl(1)</span></code><span class="koboSpan" id="kobo.2235.1"> because it can process the received information but, most importantly, it can interpret the HTTP return codes and preprocess data before sending it to the server. </span><span class="koboSpan" id="kobo.2235.2">The price you pay is the extra time needed for developing and debugging the RESTful client.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2236.1">There exist two command line flags for passing the username and the password of the user issuing the command: </span><code class="inlineCode"><span class="koboSpan" id="kobo.2237.1">username</span></code><span class="koboSpan" id="kobo.2238.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2239.1">password</span></code><span class="koboSpan" id="kobo.2240.1">. </span><span class="koboSpan" id="kobo.2240.2">As you are going to see in their implementations, they have the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2241.1">-u</span></code><span class="koboSpan" id="kobo.2242.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2243.1">-p</span></code><span class="koboSpan" id="kobo.2244.1"> shortcuts, respectively. </span><span class="koboSpan" id="kobo.2244.2">Additionally, as the JSON record that holds user information has a small number of fields, all the fields are going to be given </span><a id="_idIndexMarker987"/><span class="koboSpan" id="kobo.2245.1">using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2246.1">data</span></code><span class="koboSpan" id="kobo.2247.1"> flag or the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2248.1">-d</span></code><span class="koboSpan" id="kobo.2249.1"> shortcutâ€”this is implemented in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2250.1">./cmd/root.go</span></code><span class="koboSpan" id="kobo.2251.1">. </span><span class="koboSpan" id="kobo.2251.2">Each command is going to read the desired flags only and the desired fields of the input JSON recordâ€”this is implemented in the source code file of each command. </span><span class="koboSpan" id="kobo.2251.3">Lastly, the utility is going to return JSON records, when this makes sense, or a text message related to the endpoint that was visited. </span><span class="koboSpan" id="kobo.2251.4">Now, let us continue with the structure of the client and the implementation of the commands.</span></p>
<h2 class="heading-2" id="_idParaDest-327"><span class="koboSpan" id="kobo.2252.1">Creating the structure of the command line client</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2253.1">This </span><a id="_idIndexMarker988"/><span class="koboSpan" id="kobo.2254.1">subsection uses the cobra utility to create the structure for the command line utility. </span><span class="koboSpan" id="kobo.2254.2">But first, we are going to create a proper cobra project with Go modules:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2255.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.2256.1">cd</span></span><span class="koboSpan" id="kobo.2257.1"> ~/go/src/github.com/mactsouk/mGo4th/ch11
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2258.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.2259.1">mkdir</span></span><span class="koboSpan" id="kobo.2260.1"> client
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2261.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.2262.1">cd</span></span><span class="koboSpan" id="kobo.2263.1"> client
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2264.1">$ </span></span><span class="koboSpan" id="kobo.2265.1">go mod init
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2266.1">$ </span></span><span class="koboSpan" id="kobo.2267.1">~/go/bin/cobra init
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2268.1">$ </span></span><span class="koboSpan" id="kobo.2269.1">go mod tidy
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2270.1">$ </span></span><span class="koboSpan" id="kobo.2271.1">go run main.go
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2272.1">You do not need to execute the last command, but it makes sure that everything is fine so far. </span><span class="koboSpan" id="kobo.2272.2">After that, we are ready to define the commands that the utility is going to support by running the following cobra commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2273.1">$ </span></span><span class="koboSpan" id="kobo.2274.1">~/go/bin/cobra add add
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2275.1">$ </span></span><span class="koboSpan" id="kobo.2276.1">~/go/bin/cobra add delete
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2277.1">$ </span></span><span class="koboSpan" id="kobo.2278.1">~/go/bin/cobra add list
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2279.1">$ </span></span><span class="koboSpan" id="kobo.2280.1">~/go/bin/cobra add logged
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2281.1">$ </span></span><span class="koboSpan" id="kobo.2282.1">~/go/bin/cobra add login
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2283.1">$ </span></span><span class="koboSpan" id="kobo.2284.1">~/go/bin/cobra add logout
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2285.1">$ </span></span><span class="koboSpan" id="kobo.2286.1">~/go/bin/cobra add search
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2287.1">$ </span></span><span class="koboSpan" id="kobo.2288.1">~/go/bin/cobra add getid
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2289.1">$ </span></span><span class="koboSpan" id="kobo.2290.1">~/go/bin/cobra add time
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2291.1">$ </span></span><span class="koboSpan" id="kobo.2292.1">~/go/bin/cobra add update
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2293.1">Now that we have the desired structure, we can begin implementing the commands and maybe remove some of the comments inserted by cobra, which is the subject of the next subsection.</span></p>
<h2 class="heading-2" id="_idParaDest-328"><span class="koboSpan" id="kobo.2294.1">Implementing the RESTful client commands</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2295.1">As there is no point in displaying the entire code, we are going to present the most characteristic </span><a id="_idIndexMarker989"/><span class="koboSpan" id="kobo.2296.1">code found in some of the commands, starting with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2297.1">root.go</span></code><span class="koboSpan" id="kobo.2298.1">, which is where the next global variables are defined:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2299.1">var</span></span><span class="koboSpan" id="kobo.2300.1"> SERVER </span><span class="hljs-type"><span class="koboSpan" id="kobo.2301.1">string</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2302.1">var</span></span><span class="koboSpan" id="kobo.2303.1"> PORT </span><span class="hljs-type"><span class="koboSpan" id="kobo.2304.1">string</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2305.1">var</span></span><span class="koboSpan" id="kobo.2306.1"> data </span><span class="hljs-type"><span class="koboSpan" id="kobo.2307.1">string</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2308.1">var</span></span><span class="koboSpan" id="kobo.2309.1"> username </span><span class="hljs-type"><span class="koboSpan" id="kobo.2310.1">string</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2311.1">var</span></span><span class="koboSpan" id="kobo.2312.1"> password </span><span class="hljs-type"><span class="koboSpan" id="kobo.2313.1">string</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2314.1">These global variables hold the values of the command line options of the utility and are accessible from anywhere in the utility code.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2315.1">type</span></span><span class="koboSpan" id="kobo.2316.1"> User </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2317.1">struct</span></span><span class="koboSpan" id="kobo.2318.1"> {
    ID        </span><span class="hljs-type"><span class="koboSpan" id="kobo.2319.1">int</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2320.1">`json:"id"`</span></span><span class="koboSpan" id="kobo.2321.1">
    Username  </span><span class="hljs-type"><span class="koboSpan" id="kobo.2322.1">string</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2323.1">`json:"username"`</span></span><span class="koboSpan" id="kobo.2324.1">
    Password  </span><span class="hljs-type"><span class="koboSpan" id="kobo.2325.1">string</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2326.1">`json:"password"`</span></span><span class="koboSpan" id="kobo.2327.1">
    LastLogin </span><span class="hljs-type"><span class="koboSpan" id="kobo.2328.1">int64</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2329.1">`json:"lastlogin"`</span></span><span class="koboSpan" id="kobo.2330.1">
    Admin     </span><span class="hljs-type"><span class="koboSpan" id="kobo.2331.1">int</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2332.1">`json:"admin"`</span></span><span class="koboSpan" id="kobo.2333.1">
    Active    </span><span class="hljs-type"><span class="koboSpan" id="kobo.2334.1">int</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2335.1">`json:"active"`</span></span><span class="koboSpan" id="kobo.2336.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2337.1">We define the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2338.1">User</span></code><span class="koboSpan" id="kobo.2339.1"> structure for sending and receiving data.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2340.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2341.1">init</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2342.1">()</span></span><span class="koboSpan" id="kobo.2343.1"> {
    rootCmd.PersistentFlags().StringVarP(&amp;username, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2344.1">"username"</span></span><span class="koboSpan" id="kobo.2345.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2346.1">"u"</span></span><span class="koboSpan" id="kobo.2347.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2348.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2349.1">username"</span></span><span class="koboSpan" id="kobo.2350.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2351.1">"The username"</span></span><span class="koboSpan" id="kobo.2352.1">)
    rootCmd.PersistentFlags().StringVarP(&amp;password, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2353.1">"password"</span></span><span class="koboSpan" id="kobo.2354.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2355.1">"p"</span></span><span class="koboSpan" id="kobo.2356.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2357.1">"admin"</span></span><span class="koboSpan" id="kobo.2358.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2359.1">"The password"</span></span><span class="koboSpan" id="kobo.2360.1">)
    rootCmd.PersistentFlags().StringVarP(&amp;data, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2361.1">"data"</span></span><span class="koboSpan" id="kobo.2362.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2363.1">"d"</span></span><span class="koboSpan" id="kobo.2364.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2365.1">"{}"</span></span><span class="koboSpan" id="kobo.2366.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2367.1">"JSON Record"</span></span><span class="koboSpan" id="kobo.2368.1">)
    rootCmd.PersistentFlags().StringVarP(&amp;SERVER, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2369.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2370.1">server"</span></span><span class="koboSpan" id="kobo.2371.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2372.1">"s"</span></span><span class="koboSpan" id="kobo.2373.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2374.1">"http://localhost"</span></span><span class="koboSpan" id="kobo.2375.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2376.1">"RESTful server hostname"</span></span><span class="koboSpan" id="kobo.2377.1">)
    rootCmd.PersistentFlags().StringVarP(&amp;PORT, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2378.1">"port"</span></span><span class="koboSpan" id="kobo.2379.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2380.1">"P"</span></span><span class="koboSpan" id="kobo.2381.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2382.1">":1234"</span></span><span class="koboSpan" id="kobo.2383.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2384.1">"Port of RESTful Server"</span></span><span class="koboSpan" id="kobo.2385.1">)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2386.1">We present the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2387.1">init()</span></code><span class="koboSpan" id="kobo.2388.1"> function that holds the definitions of the command line options. </span><span class="koboSpan" id="kobo.2388.2">The values of the command line flags are automatically stored in the variables that are passed as the first argument to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2389.1">rootCmd.PersistentFlags().StringVarP()</span></code><span class="koboSpan" id="kobo.2390.1">. </span><span class="koboSpan" id="kobo.2390.2">So, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2391.1">username</span></code><span class="koboSpan" id="kobo.2392.1"> flag, which has the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2393.1">-u</span></code><span class="koboSpan" id="kobo.2394.1"> alias, stores its value in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2395.1">username</span></code><span class="koboSpan" id="kobo.2396.1"> global variable.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2397.1">The next </span><a id="_idIndexMarker990"/><span class="koboSpan" id="kobo.2398.1">part is the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2399.1">list</span></code><span class="koboSpan" id="kobo.2400.1"> command as found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2401.1">list.go</span></code><span class="koboSpan" id="kobo.2402.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2403.1">var</span></span><span class="koboSpan" id="kobo.2404.1"> listCmd = &amp;cobra.Command{
    Use:   </span><span class="hljs-string"><span class="koboSpan" id="kobo.2405.1">"list"</span></span><span class="koboSpan" id="kobo.2406.1">,
    Short: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2407.1">"List all available users"</span></span><span class="koboSpan" id="kobo.2408.1">,
    Long:  </span><span class="hljs-string"><span class="koboSpan" id="kobo.2409.1">`The list command lists all available users.`</span></span><span class="koboSpan" id="kobo.2410.1">,
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2411.1">This part is about the help messages that are displayed for the command. </span><span class="koboSpan" id="kobo.2411.2">Although they are optional, it is good to have an accurate description of the command. </span><span class="koboSpan" id="kobo.2411.3">We continue with the actual implementation:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2412.1">    Run: </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2413.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2414.1">(cmd *cobra.Command, args []</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.2415.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2416.1">)</span></span><span class="koboSpan" id="kobo.2417.1"> {
        endpoint := </span><span class="hljs-string"><span class="koboSpan" id="kobo.2418.1">"/getall"</span></span><span class="koboSpan" id="kobo.2419.1">
        user := User{Username: username, Password: password}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2420.1">First, we construct a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2421.1">User</span></code><span class="koboSpan" id="kobo.2422.1"> variable named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2423.1">user</span></code><span class="koboSpan" id="kobo.2424.1"> that holds the username and the password of the user issuing the commandâ€”the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2425.1">user</span></code><span class="koboSpan" id="kobo.2426.1"> variable is going to be passed to the server.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.2427.1">// bytes.Buffer is both a Reader and a Writer</span></span><span class="koboSpan" id="kobo.2428.1">
        buf := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2429.1">new</span></span><span class="koboSpan" id="kobo.2430.1">(bytes.Buffer)
        err := user.ToJSON(buf)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2431.1">if</span></span><span class="koboSpan" id="kobo.2432.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2433.1">nil</span></span><span class="koboSpan" id="kobo.2434.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2435.1">"JSON:"</span></span><span class="koboSpan" id="kobo.2436.1">, err)
            
            os.Exit(</span><span class="hljs-number"><span class="koboSpan" id="kobo.2437.1">1</span></span><span class="koboSpan" id="kobo.2438.1">)
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2439.1">We need to encode the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2440.1">user</span></code><span class="koboSpan" id="kobo.2441.1"> variable before transferring it to the RESTful server, which is the purpose of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2442.1">ToJSON()</span></code><span class="koboSpan" id="kobo.2443.1"> method. </span><span class="koboSpan" id="kobo.2443.2">The implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2444.1">ToJSON()</span></code><span class="koboSpan" id="kobo.2445.1"> method is found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2446.1">root.go</span></code><span class="koboSpan" id="kobo.2447.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2448.1">        req, err := http.NewRequest(http.MethodGet,
                               SERVER+PORT+endpoint, buf)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2449.1">if</span></span><span class="koboSpan" id="kobo.2450.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2451.1">nil</span></span><span class="koboSpan" id="kobo.2452.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2453.1">"GetAll â€“ Error in req: "</span></span><span class="koboSpan" id="kobo.2454.1">, err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2455.1">return</span></span><span class="koboSpan" id="kobo.2456.1">
        }
        req.Header.Set(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2457.1">"Content-Type"</span></span><span class="koboSpan" id="kobo.2458.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2459.1">"application/json"</span></span><span class="koboSpan" id="kobo.2460.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2461.1">Here, we create the request using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2462.1">SERVER</span></code><span class="koboSpan" id="kobo.2463.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2464.1">PORT</span></code><span class="koboSpan" id="kobo.2465.1"> global variables followed by the endpoint, using the desired HTTP method (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2466.1">http.MethodGet</span></code><span class="koboSpan" id="kobo.2467.1">), and declare that we are going to send JSON data using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2468.1">Header.Set()</span></code><span class="koboSpan" id="kobo.2469.1"> statement.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2470.1">        c := &amp;http.Client{
            Timeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.2471.1">15</span></span><span class="koboSpan" id="kobo.2472.1"> * time.Second,
        }
        resp, err := c.Do(req)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2473.1">if</span></span><span class="koboSpan" id="kobo.2474.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2475.1">nil</span></span><span class="koboSpan" id="kobo.2476.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2477.1">"Do:"</span></span><span class="koboSpan" id="kobo.2478.1">, err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2479.1">return</span></span><span class="koboSpan" id="kobo.2480.1">
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2481.1">After that, we </span><a id="_idIndexMarker991"/><span class="koboSpan" id="kobo.2482.1">send our data to the server using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2483.1">Do()</span></code><span class="koboSpan" id="kobo.2484.1"> and get the server response.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2485.1">if</span></span><span class="koboSpan" id="kobo.2486.1"> resp.StatusCode != http.StatusOK {
            fmt.Println(resp)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2487.1">return</span></span><span class="koboSpan" id="kobo.2488.1">
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2489.1">If the status code of the response is not </span><code class="inlineCode"><span class="koboSpan" id="kobo.2490.1">http.StatusOK</span></code><span class="koboSpan" id="kobo.2491.1">, then the request has failed.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2492.1">        users := []User{}
        SliceFromJSON(&amp;users, resp.Body)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2493.1">if</span></span><span class="koboSpan" id="kobo.2494.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2495.1">nil</span></span><span class="koboSpan" id="kobo.2496.1"> {
            fmt.Println(err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2497.1">return</span></span><span class="koboSpan" id="kobo.2498.1">
        }
        data, err := PrettyJSON(users)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2499.1">if</span></span><span class="koboSpan" id="kobo.2500.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2501.1">nil</span></span><span class="koboSpan" id="kobo.2502.1"> {
            fmt.Println(err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2503.1">return</span></span><span class="koboSpan" id="kobo.2504.1">
        }
        fmt.Print(data)
    },
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2505.1">If the status code is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2506.1">http.StatusOK</span></code><span class="koboSpan" id="kobo.2507.1">, then we prepare to read a slice of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2508.1">User</span></code><span class="koboSpan" id="kobo.2509.1"> variables. </span><span class="koboSpan" id="kobo.2509.2">As these variables hold JSON records, we need to decode them using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2510.1">SliceFromJSON()</span></code><span class="koboSpan" id="kobo.2511.1">, which is defined in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2512.1">root.go</span></code><span class="koboSpan" id="kobo.2513.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2514.1">Last is the code of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2515.1">add</span></code><span class="koboSpan" id="kobo.2516.1"> command, as found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2517.1">add.go</span></code><span class="koboSpan" id="kobo.2518.1">. </span><span class="koboSpan" id="kobo.2518.2">The difference between </span><code class="inlineCode"><span class="koboSpan" id="kobo.2519.1">add</span></code><span class="koboSpan" id="kobo.2520.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2521.1">list</span></code><span class="koboSpan" id="kobo.2522.1"> is that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2523.1">add</span></code><span class="koboSpan" id="kobo.2524.1"> command needs to send two JSON records to the RESTful server; the first one holds the data of the user issuing the command, and the second holds the data </span><a id="_idIndexMarker992"/><span class="koboSpan" id="kobo.2525.1">for the user that is about to be added to the system. </span><span class="koboSpan" id="kobo.2525.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2526.1">username</span></code><span class="koboSpan" id="kobo.2527.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2528.1">password</span></code><span class="koboSpan" id="kobo.2529.1"> flags hold the data for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2530.1">Username</span></code><span class="koboSpan" id="kobo.2531.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2532.1">Password</span></code><span class="koboSpan" id="kobo.2533.1"> fields of the first record, whereas the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2534.1">data</span></code><span class="koboSpan" id="kobo.2535.1"> command line flag holds the data for the second record.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2536.1">var</span></span><span class="koboSpan" id="kobo.2537.1"> addCmd = &amp;cobra.Command{
    Use:   </span><span class="hljs-string"><span class="koboSpan" id="kobo.2538.1">"add"</span></span><span class="koboSpan" id="kobo.2539.1">,
    Short: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2540.1">"Add a new user"</span></span><span class="koboSpan" id="kobo.2541.1">,
    Long:  </span><span class="hljs-string"><span class="koboSpan" id="kobo.2542.1">`Add a new user to the system.`</span></span><span class="koboSpan" id="kobo.2543.1">,
    Run: </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2544.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2545.1">(cmd *cobra.Command, args []</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.2546.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2547.1">)</span></span><span class="koboSpan" id="kobo.2548.1"> {
        endpoint := </span><span class="hljs-string"><span class="koboSpan" id="kobo.2549.1">"/add"</span></span><span class="koboSpan" id="kobo.2550.1">
        u1 := User{Username: username, Password: password}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2551.1">As before, we get the information about the user issuing the command and put it into a structure.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.2552.1">// Convert data string to User Structure</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2553.1">var</span></span><span class="koboSpan" id="kobo.2554.1"> u2 User
        err := json.Unmarshal([]</span><span class="hljs-type"><span class="koboSpan" id="kobo.2555.1">byte</span></span><span class="koboSpan" id="kobo.2556.1">(data), &amp;u2)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2557.1">if</span></span><span class="koboSpan" id="kobo.2558.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2559.1">nil</span></span><span class="koboSpan" id="kobo.2560.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2561.1">"Unmarshal:"</span></span><span class="koboSpan" id="kobo.2562.1">, err)
            
            os.Exit(</span><span class="hljs-number"><span class="koboSpan" id="kobo.2563.1">1</span></span><span class="koboSpan" id="kobo.2564.1">)
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2565.1">As the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2566.1">data</span></code><span class="koboSpan" id="kobo.2567.1"> command line flag holds a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2568.1">string</span></code><span class="koboSpan" id="kobo.2569.1"> value, we need to convert that string value to a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2570.1">User</span></code><span class="koboSpan" id="kobo.2571.1"> structureâ€”this is the purpose of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2572.1">json.Unmarshal()</span></code><span class="koboSpan" id="kobo.2573.1"> call.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2574.1">        users := []User{}
        users = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2575.1">append</span></span><span class="koboSpan" id="kobo.2576.1">(users, u1)
        users = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2577.1">append</span></span><span class="koboSpan" id="kobo.2578.1">(users, u2)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2579.1">Then, we create a slice of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2580.1">User</span></code><span class="koboSpan" id="kobo.2581.1"> variables that are going to be sent to the server. </span><span class="koboSpan" id="kobo.2581.2">The order you put the structures in that slice is important: first, the user issuing the command, and then the data of the user that is going to be created. </span><span class="koboSpan" id="kobo.2581.3">This was decided by the RESTful server.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2582.1">        buf := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2583.1">new</span></span><span class="koboSpan" id="kobo.2584.1">(bytes.Buffer)
        err = SliceToJSON(users, buf)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2585.1">if</span></span><span class="koboSpan" id="kobo.2586.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2587.1">nil</span></span><span class="koboSpan" id="kobo.2588.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2589.1">"JSON:"</span></span><span class="koboSpan" id="kobo.2590.1">, err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2591.1">return</span></span><span class="koboSpan" id="kobo.2592.1">
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2593.1">Then, we encode </span><a id="_idIndexMarker993"/><span class="koboSpan" id="kobo.2594.1">that slice before sending it to the RESTful server through the HTTP request.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2595.1">        req, err := http.NewRequest(http.MethodPost,
                                    SERVER+PORT+endpoint, buf)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2596.1">if</span></span><span class="koboSpan" id="kobo.2597.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2598.1">nil</span></span><span class="koboSpan" id="kobo.2599.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2600.1">"GetAll â€“ Error in req: "</span></span><span class="koboSpan" id="kobo.2601.1">, err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2602.1">return</span></span><span class="koboSpan" id="kobo.2603.1">
        }
        req.Header.Set(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2604.1">"Content-Type"</span></span><span class="koboSpan" id="kobo.2605.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2606.1">"application/json"</span></span><span class="koboSpan" id="kobo.2607.1">)
        c := &amp;http.Client{
            Timeout: </span><span class="hljs-number"><span class="koboSpan" id="kobo.2608.1">15</span></span><span class="koboSpan" id="kobo.2609.1"> * time.Second,
        }
        resp, err := c.Do(req)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2610.1">if</span></span><span class="koboSpan" id="kobo.2611.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2612.1">nil</span></span><span class="koboSpan" id="kobo.2613.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2614.1">"Do:"</span></span><span class="koboSpan" id="kobo.2615.1">, err)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2616.1">return</span></span><span class="koboSpan" id="kobo.2617.1">
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2618.1">We prepare the request and send it to the server. </span><span class="koboSpan" id="kobo.2618.2">The server is responsible for decoding the provided data and acting accordingly, in this case, by adding a new user to the system. </span><span class="koboSpan" id="kobo.2618.3">The client just needs to visit the correct endpoint using the appropriate HTTP method (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2619.1">http.MethodPost</span></code><span class="koboSpan" id="kobo.2620.1">) and check the returned HTTP status code.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2621.1">if</span></span><span class="koboSpan" id="kobo.2622.1"> resp.StatusCode != http.StatusOK {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2623.1">"Status code:"</span></span><span class="koboSpan" id="kobo.2624.1">, resp.Status)
        }
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2625.1">"User"</span></span><span class="koboSpan" id="kobo.2626.1">, u2.Username, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2627.1">"added."</span></span><span class="koboSpan" id="kobo.2628.1">)
        }
    },
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2629.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2630.1">add</span></code><span class="koboSpan" id="kobo.2631.1"> command does not return any data back to the clientâ€”what interests us is the HTTP status code because this is what determines the success or failure of the command.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2632.1">The rest of </span><a id="_idIndexMarker994"/><span class="koboSpan" id="kobo.2633.1">the commands have a similar implementation, which is not presented here. </span><span class="koboSpan" id="kobo.2633.2">Feel free to look at the Go source code files in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2634.1">cmd</span></code><span class="koboSpan" id="kobo.2635.1"> directory.</span></p>
<h2 class="heading-2" id="_idParaDest-329"><span class="koboSpan" id="kobo.2636.1">Using the RESTful client</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2637.1">We are now going to use the command line utility to interact with the RESTful server. </span><span class="koboSpan" id="kobo.2637.2">This type of </span><a id="_idIndexMarker995"/><span class="koboSpan" id="kobo.2638.1">utility can be used for administering a RESTful server, creating automated tasks, and carrying out CI/CD jobs. </span><span class="koboSpan" id="kobo.2638.2">For reasons of simplicity, the client and the server reside on the same machine, and we mostly work with the default user (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2639.1">admin</span></code><span class="koboSpan" id="kobo.2640.1">)â€”this makes the presented commands shorter. </span><span class="koboSpan" id="kobo.2640.2">Additionally, we execute </span><code class="inlineCode"><span class="koboSpan" id="kobo.2641.1">go build -o rest-cli</span></code><span class="koboSpan" id="kobo.2642.1"> to create a binary executable and avoid using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2643.1">go</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.2644.1">run</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.2645.1">main.go</span></code><span class="koboSpan" id="kobo.2646.1"> all the time.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2647.1">First, we get the time from the server:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2648.1">$ </span></span><span class="koboSpan" id="kobo.2649.1">./rest-cli time
The current time is: Wed, 01 Nov 2023 07:37:49 EET
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2650.1">Next, we list all users. </span><span class="koboSpan" id="kobo.2650.2">As the output depends on the contents of the database, we print a small part of the output. </span><span class="koboSpan" id="kobo.2650.3">Note that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2651.1">list</span></code><span class="koboSpan" id="kobo.2652.1"> command needs to be issued by a user with admin privileges:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2653.1">$ </span></span><span class="koboSpan" id="kobo.2654.1">./rest-cli list -u admin -p admin
[
    {
        "id": 3,
        "username": "mihalis",
        "password": "admin",
        "lastlogin": 0,
        "admin": 0,
        "active": 0
    }
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2655.1">Keep in mind that you should use the active password of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2656.1">admin</span></code><span class="koboSpan" id="kobo.2657.1"> user for the previous command to be executed correctly. </span><span class="koboSpan" id="kobo.2657.2">In my case, the active password was also </span><code class="inlineCode"><span class="koboSpan" id="kobo.2658.1">admin</span></code><span class="koboSpan" id="kobo.2659.1"> but this depends on your current status of the database.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2660.1">Next, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2661.1">logged</span></code><span class="koboSpan" id="kobo.2662.1"> command when issued with an invalid password:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2663.1">$ </span></span><span class="koboSpan" id="kobo.2664.1">./rest-cli logged -u admin -p notPass
&amp;{400 Bad Request 400 HTTP/1.1 1 1 map[Content-Length:[0] Date:[Wed, 01 Nov 2023 05:39:38 GMT]] 0x14000204020 0 [] false false map[] 0x14000132c00 &lt;nil&gt;}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2665.1">As expected, the command failsâ€”this output is used for debugging purposes. </span><span class="koboSpan" id="kobo.2665.2">After making sure </span><a id="_idIndexMarker996"/><span class="koboSpan" id="kobo.2666.1">that the command works as expected, you might want to print a more appropriate error message.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2667.1">After that, we test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2668.1">add</span></code><span class="koboSpan" id="kobo.2669.1"> command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2670.1">$ </span></span><span class="koboSpan" id="kobo.2671.1">./rest-cli add -u admin -p admin --data </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2672.1">'{"Username":"newUser", "Password":"aPass"}'</span></span><span class="koboSpan" id="kobo.2673.1">
User newUser added.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2674.1">Trying to add the same user again is going to fail:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2675.1">$ </span></span><span class="koboSpan" id="kobo.2676.1">./rest-cli add -u admin -p admin --data </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2677.1">'</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2678.1">{"Username":"newUser", "Password":"aPass"}'</span></span><span class="koboSpan" id="kobo.2679.1">
Status code: 400 Bad Request
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2680.1">Next, we are going to delete </span><code class="inlineCode"><span class="koboSpan" id="kobo.2681.1">newUser</span></code><span class="koboSpan" id="kobo.2682.1">â€”but first, we need to find the user ID of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2683.1">newUser</span></code><span class="koboSpan" id="kobo.2684.1">:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2685.1">$ </span></span><span class="koboSpan" id="kobo.2686.1">./rest-cli getid -u admin -p admin --data </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2687.1">'{"Username":"newUser"}'</span></span><span class="koboSpan" id="kobo.2688.1">
User newUser has ID: 4
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2689.1">$ </span></span><span class="koboSpan" id="kobo.2690.1">./rest-cli delete -u admin -p admin --data </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2691.1">'{"ID":4}'</span></span><span class="koboSpan" id="kobo.2692.1">
User with ID 4 deleted.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2693.1">Feel free to continue testing the RESTful client and let me know if you find any bugs!</span></p>
<h2 class="heading-2" id="_idParaDest-330"><span class="koboSpan" id="kobo.2694.1">Working with multiple REST API versions</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2695.1">A REST API </span><a id="_idIndexMarker997"/><span class="koboSpan" id="kobo.2696.1">can change and evolve </span><a id="_idIndexMarker998"/><span class="koboSpan" id="kobo.2697.1">over time. </span><span class="koboSpan" id="kobo.2697.2">There exist various approaches on how to implement REST API versioning, including the following:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2698.1">Using a custom HTTP header (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2699.1">version-used</span></code><span class="koboSpan" id="kobo.2700.1">) to define the version used</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2701.1">Using a different subdomain for each version (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2702.1">v1.servername</span></code><span class="koboSpan" id="kobo.2703.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2704.1">v2.servername</span></code><span class="koboSpan" id="kobo.2705.1">)</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2706.1">Using a combination of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2707.1">Accept</span></code><span class="koboSpan" id="kobo.2708.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2709.1">Content-Type</span></code><span class="koboSpan" id="kobo.2710.1"> headersâ€”this method is based on content negotiation</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2711.1">Using a different path for each version (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2712.1">/v1</span></code><span class="koboSpan" id="kobo.2713.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2714.1">/v2</span></code><span class="koboSpan" id="kobo.2715.1"> if the RESTful server supports two REST API versions)</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2716.1">Using a query parameter to reference the desired version (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2717.1">..../endpoint?version=v1</span></code><span class="koboSpan" id="kobo.2718.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.2719.1">..../endpoint?v=1</span></code><span class="koboSpan" id="kobo.2720.1">)</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2721.1">There is no </span><a id="_idIndexMarker999"/><span class="koboSpan" id="kobo.2722.1">correct answer for how to </span><a id="_idIndexMarker1000"/><span class="koboSpan" id="kobo.2723.1">implement REST API versioning. </span><span class="koboSpan" id="kobo.2723.2">Use what seems more natural to you and your users. </span><span class="koboSpan" id="kobo.2723.3">What is important is to be consistent and use the same approach everywhere. </span><span class="koboSpan" id="kobo.2723.4">Personally, I prefer to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2724.1">/v1/...</span></code><span class="koboSpan" id="kobo.2725.1"> for supporting the endpoints of version 1, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2726.1">/v2/...</span></code><span class="koboSpan" id="kobo.2727.1"> for supporting the endpoints of version 2, and so on.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2728.1">The development of our RESTful servers and clients has come to an end here. </span><span class="koboSpan" id="kobo.2728.2">With the knowledge presented in this chapter, you can create powerful RESTful services!</span></p>
<h1 class="heading-1" id="_idParaDest-331"><span class="koboSpan" id="kobo.2729.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2730.1">Go is widely used for developing RESTful clients and servers and this chapter illustrated how to program professional RESTful clients and servers in Go. </span><span class="koboSpan" id="kobo.2730.2">Although you can develop a RESTful server using the Standard Go library, this can be a really tedious task. </span><span class="koboSpan" id="kobo.2730.3">External packages such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.2731.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.2732.1">, which was used in this chapter, and Gin can save you time by providing advanced features that would otherwise require lots of code when implemented with the functionality offered by the standard Go library.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2733.1">Remember that defining a proper REST API and implementing a server and clients for it is a process that takes time and requires small adjustments and modifications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2734.1">Behind an efficient and productive RESTful service are properly defined JSON records and HTTP endpoints that support the desired operations. </span><span class="koboSpan" id="kobo.2734.2">Given these two items, the Go code should offer support for the exchange of the JSON records between the server and the clients.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2735.1">The next chapter is about code testing, profiling, cross-compilation, and creating example functions. </span><span class="koboSpan" id="kobo.2735.2">Among other things, we are going to write code for testing the HTTP handlers developed in this chapter.</span></p>
<h1 class="heading-1" id="_idParaDest-332"><span class="koboSpan" id="kobo.2736.1">Exercises</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2737.1">Try to make </span><code class="inlineCode"><span class="koboSpan" id="kobo.2738.1">rServer.go</span></code><span class="koboSpan" id="kobo.2739.1"> use Gin instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2740.1">net/http</span></code><span class="koboSpan" id="kobo.2741.1">. </span><span class="koboSpan" id="kobo.2741.2">Does </span><code class="inlineCode"><span class="koboSpan" id="kobo.2742.1">rClient.go</span></code><span class="koboSpan" id="kobo.2743.1"> still work with the updated </span><code class="inlineCode"><span class="koboSpan" id="kobo.2744.1">rServer.go</span></code><span class="koboSpan" id="kobo.2745.1">? </span><span class="koboSpan" id="kobo.2745.2">Why? </span><span class="koboSpan" id="kobo.2745.3">Is that a good thing?</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2746.1">Change the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2747.1">server/restdb.go</span></code><span class="koboSpan" id="kobo.2748.1"> file to support PostgreSQL instead of SQLite.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2749.1">Change the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2750.1">server/restdb.go</span></code><span class="koboSpan" id="kobo.2751.1"> file to support MySQL instead of SQLite.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2752.1">Put the handler functions from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2753.1">server/handlers.go</span></code><span class="koboSpan" id="kobo.2754.1"> into separate files.</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-333"><span class="koboSpan" id="kobo.2755.1">Additional resources</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2756.1">You can find more about </span><code class="inlineCode"><span class="koboSpan" id="kobo.2757.1">gorilla/mux</span></code><span class="koboSpan" id="kobo.2758.1"> at </span><a href="https://github.com/gorilla/mux"><span class="url"><span class="koboSpan" id="kobo.2759.1">https://github.com/gorilla/mux</span></span></a><span class="koboSpan" id="kobo.2760.1"> and </span><a href="https://www.gorillatoolkit.org/pkg/mux"><span class="url"><span class="koboSpan" id="kobo.2761.1">https://www.gorillatoolkit.org/pkg/mux</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2762.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2763.1">go-querystring</span></code><span class="koboSpan" id="kobo.2764.1"> library is for encoding Go structures into URL query parameters: </span><a href="https://github.com/google/go-querystring"><span class="url"><span class="koboSpan" id="kobo.2765.1">https://github.com/google/go-querystring</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2766.1">Tutorial: Developing a RESTful API with Go and Gin: </span><a href="https://go.dev/doc/tutorial/web-service-gin"><span class="url"><span class="koboSpan" id="kobo.2767.1">https://go.dev/doc/tutorial/web-service-gin</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2768.1">If you want to validate JSON input, have a look at the Go </span><code class="inlineCode"><span class="koboSpan" id="kobo.2769.1">validator</span></code><span class="koboSpan" id="kobo.2770.1"> package at </span><a href="https://github.com/go-playground/validator"><span class="url"><span class="koboSpan" id="kobo.2771.1">https://github.com/go-playground/validator</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2772.1">You might find the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2773.1">jq(1)</span></code><span class="koboSpan" id="kobo.2774.1"> command line utility pretty handy when working with JSON records: </span><a href="https://stedolan.github.io/jq/"><span class="url"><span class="koboSpan" id="kobo.2775.1">https://stedolan.github.io/jq/</span></span></a><span class="koboSpan" id="kobo.2776.1"> and </span><a href="https://jqplay.org/"><span class="url"><span class="koboSpan" id="kobo.2777.1">https://jqplay.org/</span></span></a></li>
</ul>
<h1 class="heading-1"><span class="koboSpan" id="kobo.2778.1">Leave a review!</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2779.1">Enjoying this book? </span><span class="koboSpan" id="kobo.2779.2">Help readers like you by leaving an Amazon review. </span><span class="koboSpan" id="kobo.2779.3">Scan the QR code below to get a free eBook of your choice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2780.1"><img alt="" role="presentation" src="../Images/Review_QR_Code.png"/></span></p>
</div>
</body></html>