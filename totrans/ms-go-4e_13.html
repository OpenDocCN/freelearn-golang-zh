<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer194">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">13</span></h1>
<h1 class="chapterTitle" id="_idParaDest-365"><span class="koboSpan" id="kobo.2.1">Fuzz Testing and Observability</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">The subject of this chapter is twofold. </span><span class="koboSpan" id="kobo.3.2">First, we are going to talk about </span><em class="italic"><span class="koboSpan" id="kobo.4.1">fuzz testing</span></em><span class="koboSpan" id="kobo.5.1">, which is a recent Go feature that improves the testing process, and second, we are going to talk about </span><em class="italic"><span class="koboSpan" id="kobo.6.1">observability</span></em><span class="koboSpan" id="kobo.7.1">, which can help you understand what is going on when everything is working as expected but slower than desired.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.8.1">With fuzz testing, we bring the unexpected to testing. </span><span class="koboSpan" id="kobo.8.2">The main benefit is that you get to test your code using random and unpredicted values and data, which might lead to detecting unknown vulnerabilities. </span><span class="koboSpan" id="kobo.8.3">This also leads to improved test coverage, better automation and efficiency in testing, better continuous testing, improved software quality, and cost-effective security testing.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.9.1">Observability refers to the ability to understand, measure, and analyze the internal state and behavior of a system based on its external outputs or observable signals. </span><span class="koboSpan" id="kobo.9.2">In the context of computer systems and software applications, observability is crucial for monitoring, troubleshooting, and maintaining the health and performance of the system. </span><span class="koboSpan" id="kobo.9.3">So, observability helps us find out more about the unseen sides of a program.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.10.1">The first rule of observability is </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.11.1">knowing what you are looking for</span></strong><span class="koboSpan" id="kobo.12.1">. </span><span class="koboSpan" id="kobo.12.2">This means that if you do not know what to look for, you might end up collecting the wrong data, overlook the useful metrics, and concentrate on the irrelevant ones!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.13.1">Additionally, reading metrics without storing and visualizing them is not effective. </span><span class="koboSpan" id="kobo.13.2">Therefore, this chapter also illustrates how to expose your metrics to Prometheus and how to visualize data stored in Prometheus using Grafana. </span><span class="koboSpan" id="kobo.13.3">Keep in mind that Prometheus is not the only software for storing time series data. </span><span class="koboSpan" id="kobo.13.4">One alternative to Prometheus is Elasticsearch. </span><span class="koboSpan" id="kobo.13.5">In that case, you might need to use Kibana instead of Grafana. </span><span class="koboSpan" id="kobo.13.6">What is important is that the key ideas remain the same.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.14.1">In this chapter, we will cover the following topics:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.15.1">Fuzz testing</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.16.1">Observability</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.17.1">Exposing metrics to Prometheus </span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.18.1">We begin this chapter with fuzz testing.</span></p>
<h1 class="heading-1" id="_idParaDest-366"><span class="koboSpan" id="kobo.19.1">Fuzz testing</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.20.1">As software engineers, we worry , not when things go as expected, but when unexpected things happen. </span><span class="koboSpan" id="kobo.20.2">One way to deal with the unexpected is fuzzing. </span><span class="koboSpan" id="kobo.20.3">Fuzzing (or fuzz testing) is a testing technique that generates invalid, unexpected, or random data on </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.21.1">programs that require input</span></strong><span class="koboSpan" id="kobo.22.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.23.1">Fuzz testing is good at discovering security and vulnerability issues with code—manual testing is not always ideal as those tests may not account for all potential untrusted inputs, specifically invalid inputs that may break a system. </span><span class="koboSpan" id="kobo.23.2">However, fuzz testing cannot replace unit testing. </span><span class="koboSpan" id="kobo.23.3">This means that fuzz testing is not a panacea and cannot replace all other testing techniques. </span><span class="koboSpan" id="kobo.23.4">So, fuzz testing is more suitable for </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.24.1">testing code that parses input</span></strong><span class="koboSpan" id="kobo.25.1">, which includes cases such as buffer overflow and SQL injection.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.26.1">The main advantages of fuzzing include the following:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.27.1">You can make sure that the code can handle invalid or random input.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.28.1">Bugs that are discovered with fuzzing may be severe and might indicate security risks.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.29.1">Malicious attackers often use fuzzing to locate vulnerabilities, so it is good to be prepared.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.30.1">With fuzzing comes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.31.1">testing.F</span></code><span class="koboSpan" id="kobo.32.1"> data type in the same way that we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.33.1">testing.T</span></code><span class="koboSpan" id="kobo.34.1"> for testing and </span><code class="inlineCode"><span class="koboSpan" id="kobo.35.1">testing.B</span></code><span class="koboSpan" id="kobo.36.1"> for benchmarking—benchmarking Go code is covered in </span><em class="chapterRef"><span class="koboSpan" id="kobo.37.1">Chapter 14</span></em><span class="koboSpan" id="kobo.38.1">, </span><em class="italic"><span class="koboSpan" id="kobo.39.1">Efficiency and Performance</span></em><span class="koboSpan" id="kobo.40.1">. </span><span class="koboSpan" id="kobo.40.2">Additionally, fuzz testing functions begin with </span><code class="inlineCode"><span class="koboSpan" id="kobo.41.1">Fuzz</span></code><span class="koboSpan" id="kobo.42.1"> just like testing functions begin with </span><code class="inlineCode"><span class="koboSpan" id="kobo.43.1">Test</span></code><span class="koboSpan" id="kobo.44.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.45.1">When a fuzz testing run fails, the data that generated the issue is saved on disk under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.46.1">testdata</span></code><span class="koboSpan" id="kobo.47.1"> directory, and after that, even regular tests are going to fail—because they are going to use that data automatically—until we correct the relevant issues or bugs. </span><span class="koboSpan" id="kobo.47.2">Feel free to delete that </span><code class="inlineCode"><span class="koboSpan" id="kobo.48.1">testdata</span></code><span class="koboSpan" id="kobo.49.1"> directory if you need to rerun your regular tests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.50.1">The next subsection presents a simple example of fuzz testing.</span></p>
<h2 class="heading-2" id="_idParaDest-367"><span class="koboSpan" id="kobo.51.1">A simple fuzz testing example</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.52.1">In this subsection, we</span><a id="_idIndexMarker1106"/><span class="koboSpan" id="kobo.53.1"> are going to create a simple example that uses fuzz testing in order to better understand it. </span><span class="koboSpan" id="kobo.53.2">The relevant code is found under </span><code class="inlineCode"><span class="koboSpan" id="kobo.54.1">ch13/fuzz</span></code><span class="koboSpan" id="kobo.55.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.56.1">For the purposes of this simple example, we are going to see code that tests a simple Go function that is found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.57.1">code.go</span></code><span class="koboSpan" id="kobo.58.1">. </span><span class="koboSpan" id="kobo.58.2">The contents of </span><code class="inlineCode"><span class="koboSpan" id="kobo.59.1">code.go</span></code><span class="koboSpan" id="kobo.60.1"> are the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.61.1">package</span></span><span class="koboSpan" id="kobo.62.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.63.1">import</span></span><span class="koboSpan" id="kobo.64.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.65.1">"fmt"</span></span><span class="koboSpan" id="kobo.66.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.67.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.68.1">AddInt</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.69.1">(x, y </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.70.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.71.1">)</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.72.1">int</span></span><span class="koboSpan" id="kobo.73.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.74.1">for</span></span><span class="koboSpan" id="kobo.75.1"> i := </span><span class="hljs-number"><span class="koboSpan" id="kobo.76.1">0</span></span><span class="koboSpan" id="kobo.77.1">; i &lt; x; i++ {
        y = y + </span><span class="hljs-number"><span class="koboSpan" id="kobo.78.1">1</span></span><span class="koboSpan" id="kobo.79.1">
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.80.1">return</span></span><span class="koboSpan" id="kobo.81.1"> y
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.82.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.83.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.84.1">()</span></span><span class="koboSpan" id="kobo.85.1"> {
    fmt.Println(AddInt(</span><span class="hljs-number"><span class="koboSpan" id="kobo.86.1">5</span></span><span class="koboSpan" id="kobo.87.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.88.1">4</span></span><span class="koboSpan" id="kobo.89.1">))
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.90.1">There is an issue here: </span><code class="inlineCode"><span class="koboSpan" id="kobo.91.1">AddInt()</span></code><span class="koboSpan" id="kobo.92.1"> is not implemented properly because the </span><code class="inlineCode"><span class="koboSpan" id="kobo.93.1">for</span></code><span class="koboSpan" id="kobo.94.1"> loop is not going to work when the </span><code class="inlineCode"><span class="koboSpan" id="kobo.95.1">x</span></code><span class="koboSpan" id="kobo.96.1"> parameter has a negative value.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.97.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.98.1">code_test.go</span></code><span class="koboSpan" id="kobo.99.1"> file with the tests is going to be presented in two parts. </span><span class="koboSpan" id="kobo.99.2">The first part comes with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.100.1">package</span></span><span class="koboSpan" id="kobo.101.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.102.1">import</span></span><span class="koboSpan" id="kobo.103.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.104.1">"testing"</span></span><span class="koboSpan" id="kobo.105.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.106.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.107.1">TestAddInt</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.108.1">(t *testing.T)</span></span><span class="koboSpan" id="kobo.109.1"> {
    testCases := []</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.110.1">struct</span></span><span class="koboSpan" id="kobo.111.1"> {
        x, y, want </span><span class="hljs-type"><span class="koboSpan" id="kobo.112.1">int</span></span><span class="koboSpan" id="kobo.113.1">
    }{
        {</span><span class="hljs-number"><span class="koboSpan" id="kobo.114.1">1</span></span><span class="koboSpan" id="kobo.115.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.116.1">2</span></span><span class="koboSpan" id="kobo.117.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.118.1">3</span></span><span class="koboSpan" id="kobo.119.1">},
        {</span><span class="hljs-number"><span class="koboSpan" id="kobo.120.1">1</span></span><span class="koboSpan" id="kobo.121.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.122.1">0</span></span><span class="koboSpan" id="kobo.123.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.124.1">1</span></span><span class="koboSpan" id="kobo.125.1">},
        {</span><span class="hljs-number"><span class="koboSpan" id="kobo.126.1">100</span></span><span class="koboSpan" id="kobo.127.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.128.1">10</span></span><span class="koboSpan" id="kobo.129.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.130.1">110</span></span><span class="koboSpan" id="kobo.131.1">},
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.132.1">for</span></span><span class="koboSpan" id="kobo.133.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.134.1">range</span></span><span class="koboSpan" id="kobo.135.1"> testCases {
        result := AddInt(tc.x, tc.y)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.136.1">if</span></span><span class="koboSpan" id="kobo.137.1"> result != tc.want {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.138.1">"X: %d, Y: %d, want %d"</span></span><span class="koboSpan" id="kobo.139.1">, tc.x, tc.y, tc.want)
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.140.1">This first part implements a testing function in the usual way. </span><span class="koboSpan" id="kobo.140.2">However, in this case, we are only testing </span><code class="inlineCode"><span class="koboSpan" id="kobo.141.1">AddInt()</span></code><span class="koboSpan" id="kobo.142.1"> using positive integers (natural numbers), which means that it is going to work without any issues.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.143.1">The second part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.144.1">code_test.go</span></code><span class="koboSpan" id="kobo.145.1"> contains the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.146.1">func</span></span><span class="hljs-function"> </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.147.1">FuzzAddInt</span></strong></span><span class="hljs-params"><span class="koboSpan" id="kobo.148.1">(f *testing.F)</span></span><span class="koboSpan" id="kobo.149.1"> {
    testCases := []</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.150.1">struct</span></span><span class="koboSpan" id="kobo.151.1"> {
        x, y </span><span class="hljs-type"><span class="koboSpan" id="kobo.152.1">int</span></span><span class="koboSpan" id="kobo.153.1">
    }{
        {</span><span class="hljs-number"><span class="koboSpan" id="kobo.154.1">0</span></span><span class="koboSpan" id="kobo.155.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.156.1">1</span></span><span class="koboSpan" id="kobo.157.1">},
        {</span><span class="hljs-number"><span class="koboSpan" id="kobo.158.1">0</span></span><span class="koboSpan" id="kobo.159.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.160.1">100</span></span><span class="koboSpan" id="kobo.161.1">},
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.162.1">for</span></span><span class="koboSpan" id="kobo.163.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.164.1">range</span></span><span class="koboSpan" id="kobo.165.1"> testCases {
        f.Add(tc.x, tc.y)
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.166.1">This part implements a fuzz testing function named </span><code class="inlineCode"><span class="koboSpan" id="kobo.167.1">FuzzAddInt()</span></code><span class="koboSpan" id="kobo.168.1">, which can be verified by the use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.169.1">testing.F</span></code><span class="koboSpan" id="kobo.170.1"> data type as well as its name beginning with </span><code class="inlineCode"><span class="koboSpan" id="kobo.171.1">Fuzz</span></code><span class="koboSpan" id="kobo.172.1">. </span><span class="koboSpan" id="kobo.172.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.173.1">testing.F</span></code><span class="koboSpan" id="kobo.174.1"> data type provides</span><a id="_idIndexMarker1107"/><span class="koboSpan" id="kobo.175.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.176.1">Add()</span></code><span class="koboSpan" id="kobo.177.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.178.1">Fuzz()</span></code><span class="koboSpan" id="kobo.179.1"> methods, which are used for providing the (optional) starting input and for running the actual fuzz tests, respectively.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.180.1">The </span><em class="italic"><span class="koboSpan" id="kobo.181.1">corpus</span></em><span class="koboSpan" id="kobo.182.1"> is a collection of inputs that guide the fuzz testing process and is composed of two parts. </span><span class="koboSpan" id="kobo.182.2">The first part is the </span><em class="italic"><span class="koboSpan" id="kobo.183.1">seed corpus</span></em><span class="koboSpan" id="kobo.184.1">, and the second part is the </span><em class="italic"><span class="koboSpan" id="kobo.185.1">generated corpus</span></em><span class="koboSpan" id="kobo.186.1">. </span><span class="koboSpan" id="kobo.186.2">The </span><em class="italic"><span class="koboSpan" id="kobo.187.1">seed corpus</span></em><span class="koboSpan" id="kobo.188.1"> can be provided by </span><code class="inlineCode"><span class="koboSpan" id="kobo.189.1">Add()</span></code><span class="koboSpan" id="kobo.190.1"> function calls and/or data in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.191.1">testdata/fuzz</span></code><span class="koboSpan" id="kobo.192.1"> directory. </span><span class="koboSpan" id="kobo.192.2">The </span><em class="italic"><span class="koboSpan" id="kobo.193.1">generated corpus</span></em><span class="koboSpan" id="kobo.194.1"> is completely machine generated. </span><span class="koboSpan" id="kobo.194.2">It is not mandatory to have a seed corpus.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.195.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.196.1">Add()</span></code><span class="koboSpan" id="kobo.197.1"> function adds data to the </span><em class="italic"><span class="koboSpan" id="kobo.198.1">seed corpus</span></em><span class="koboSpan" id="kobo.199.1"> and can be called as many times as you want—in this case, we call </span><code class="inlineCode"><span class="koboSpan" id="kobo.200.1">Add()</span></code><span class="koboSpan" id="kobo.201.1"> two times.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.202.1">    f.Fuzz(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.203.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.204.1">(t *testing.T, x, y </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.205.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.206.1">)</span></span><span class="koboSpan" id="kobo.207.1"> {
        result := AddInt(x, y)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.208.1">if</span></span><span class="koboSpan" id="kobo.209.1"> result != x+y {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.210.1">"X: %d, Y: %d, Result %d, want %d"</span></span><span class="koboSpan" id="kobo.211.1">, x, y, result, x+y)
        }
    })
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.212.1">After the (optional) </span><code class="inlineCode"><span class="koboSpan" id="kobo.213.1">Add()</span></code><span class="koboSpan" id="kobo.214.1"> function, we need to call </span><code class="inlineCode"><span class="koboSpan" id="kobo.215.1">Fuzz()</span></code><span class="koboSpan" id="kobo.216.1">, which requires a </span><code class="inlineCode"><span class="koboSpan" id="kobo.217.1">*testing.T</span></code><span class="koboSpan" id="kobo.218.1"> variable as well as a list of fuzzing arguments, which should be the same number and have the same data type as the ones used in </span><code class="inlineCode"><span class="koboSpan" id="kobo.219.1">Add()</span></code><span class="koboSpan" id="kobo.220.1">, which are usually the same as the number of arguments in the function that is being tested.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.221.1">Put simply, we embed regular testing functions in fuzz testing functions—it is the input for those regular testing functions that are provided by the fuzz testing process based on the generated corpus.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.222.1">So, we tell </span><code class="inlineCode"><span class="koboSpan" id="kobo.223.1">f.Fuzz()</span></code><span class="koboSpan" id="kobo.224.1"> that we need two additional </span><code class="inlineCode"><span class="koboSpan" id="kobo.225.1">int</span></code><span class="koboSpan" id="kobo.226.1"> parameters apart from the compulsory </span><code class="inlineCode"><span class="koboSpan" id="kobo.227.1">*testing.T</span></code><span class="koboSpan" id="kobo.228.1">, which are named </span><code class="inlineCode"><span class="koboSpan" id="kobo.229.1">x</span></code><span class="koboSpan" id="kobo.230.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.231.1">y</span></code><span class="koboSpan" id="kobo.232.1">. </span><span class="koboSpan" id="kobo.232.2">These two parameters are the input of the tests. </span><span class="koboSpan" id="kobo.232.3">Because of </span><a id="_idIndexMarker1108"/><span class="koboSpan" id="kobo.233.1">that, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.234.1">f.Add()</span></code><span class="koboSpan" id="kobo.235.1"> call should also have two parameters.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.236.1">Running the regular tests is as simple as executing the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.237.1">$ </span></span><span class="koboSpan" id="kobo.238.1">go </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.239.1">test</span></span><span class="koboSpan" id="kobo.240.1"> *.go
ok    command-line-arguments    0.427s
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.241.1">So, the testing function revealed no issues with </span><code class="inlineCode"><span class="koboSpan" id="kobo.242.1">AddInt()</span></code><span class="koboSpan" id="kobo.243.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.244.1">Running the fuzz test requires the use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.245.1">-fuzz</span></code><span class="koboSpan" id="kobo.246.1"> command line parameter followed by the name of the fuzz function. </span><span class="koboSpan" id="kobo.246.2">So, we need to execute the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.247.1">$ </span></span><span class="koboSpan" id="kobo.248.1">go </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.249.1">test</span></span><span class="koboSpan" id="kobo.250.1"> -fuzz=FuzzAddInt *.go
fuzz: elapsed: 0s, gathering baseline coverage: 0/2 completed
fuzz: elapsed: 0s, gathering baseline coverage: 2/2 completed, now fuzzing with 10 workers
fuzz: elapsed: 0s, execs: 6 (410/sec), new interesting: 2 (total: 4)
--- FAIL: FuzzAddInt (0.02s)
    --- FAIL: FuzzAddInt (0.00s)
        code_test.go:40: X: -63, Y: 32, Result 32, want -31
    </span><span class="code-highlight"><strong class="hljs-con-slc"><span class="koboSpan" id="kobo.251.1">Failing input written to testdata/fuzz/FuzzAddInt/b403d5353f8afe03</span></strong></span><span class="koboSpan" id="kobo.252.1">
    To re-run:
    go test -run=FuzzAddInt/b403d5353f8afe03
FAIL
exit status 1
FAIL    command-line-arguments    0.222s
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.253.1">So, the fuzz test caught the error with </span><code class="inlineCode"><span class="koboSpan" id="kobo.254.1">AddInt()</span></code><span class="koboSpan" id="kobo.255.1">. </span><span class="koboSpan" id="kobo.255.2">Put simply, the fuzz testing process included negative integers in the testing and caught a logical error generated by the use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.256.1">for</span></code><span class="koboSpan" id="kobo.257.1"> loop—we did not!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.258.1">The contents of </span><code class="inlineCode"><span class="koboSpan" id="kobo.259.1">testdata/fuzz/FuzzAddInt/b403d5353f8afe03</span></code><span class="koboSpan" id="kobo.260.1"> are the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.261.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.262.1">cat</span></span><span class="koboSpan" id="kobo.263.1"> testdata/fuzz/FuzzAddInt/b403d5353f8afe03
go test fuzz v1
int(-63)
int(32) 
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.264.1">Fixing </span><code class="inlineCode"><span class="koboSpan" id="kobo.265.1">AddInt()</span></code><span class="koboSpan" id="kobo.266.1"> is left as an exercise for you—as a hint, consider using different code when the</span><a id="_idIndexMarker1109"/><span class="koboSpan" id="kobo.267.1"> parameter used in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.268.1">for</span></code><span class="koboSpan" id="kobo.269.1"> loop is negative. </span><span class="koboSpan" id="kobo.269.2">In our case, the function parameter that causes the error condition is </span><code class="inlineCode"><span class="koboSpan" id="kobo.270.1">x</span></code><span class="koboSpan" id="kobo.271.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.272.1">The next subsection presents a more practical fuzz testing example.</span></p>
<h2 class="heading-2" id="_idParaDest-368"><span class="koboSpan" id="kobo.273.1">An advanced fuzz testing example</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.274.1">In this subsection, we</span><a id="_idIndexMarker1110"/><span class="koboSpan" id="kobo.275.1"> present a more advanced fuzz testing example. </span><span class="koboSpan" id="kobo.275.2">The relevant code is found under </span><code class="inlineCode"><span class="koboSpan" id="kobo.276.1">ch13/reverse</span></code><span class="koboSpan" id="kobo.277.1">. </span><span class="koboSpan" id="kobo.277.2">The code in </span><code class="inlineCode"><span class="koboSpan" id="kobo.278.1">reverse.go</span></code><span class="koboSpan" id="kobo.279.1"> is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.280.1">package</span></span><span class="koboSpan" id="kobo.281.1"> main
</span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.282.1">// This version has bugs</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.283.1">import</span></span><span class="koboSpan" id="kobo.284.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.285.1">"fmt"</span></span><span class="koboSpan" id="kobo.286.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.287.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.288.1">R1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.289.1">(s </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.290.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.291.1">)</span></span><span class="koboSpan" id="kobo.292.1"> []</span><span class="hljs-type"><span class="koboSpan" id="kobo.293.1">byte</span></span><span class="koboSpan" id="kobo.294.1"> {
    sAr := []</span><span class="hljs-type"><span class="koboSpan" id="kobo.295.1">byte</span></span><span class="koboSpan" id="kobo.296.1">(sAr)
    rev := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.297.1">make</span></span><span class="koboSpan" id="kobo.298.1">([]</span><span class="hljs-type"><span class="koboSpan" id="kobo.299.1">byte</span></span><span class="koboSpan" id="kobo.300.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.301.1">len</span></span><span class="koboSpan" id="kobo.302.1">(s))
    l := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.303.1">len</span></span><span class="koboSpan" id="kobo.304.1">(sAr)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.305.1">for</span></span><span class="koboSpan" id="kobo.306.1"> i := </span><span class="hljs-number"><span class="koboSpan" id="kobo.307.1">0</span></span><span class="koboSpan" id="kobo.308.1">; i &lt; l; i++ {
        rev[i] = sAr[l</span><span class="hljs-number"><span class="koboSpan" id="kobo.309.1">-1</span></span><span class="koboSpan" id="kobo.310.1">-i]
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.311.1">return</span></span><span class="koboSpan" id="kobo.312.1"> rev
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.313.1">In this first part, we implement a function named </span><code class="inlineCode"><span class="koboSpan" id="kobo.314.1">R1()</span></code><span class="koboSpan" id="kobo.315.1"> that reverses a string. </span><span class="koboSpan" id="kobo.315.2">Internally, the function converts the input </span><code class="inlineCode"><span class="koboSpan" id="kobo.316.1">string</span></code><span class="koboSpan" id="kobo.317.1"> value into a byte slice and returns a byte slice.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.318.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.319.1">R2</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.320.1">(s </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.321.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.322.1">)</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.323.1">string</span></span><span class="koboSpan" id="kobo.324.1"> {
    b := []</span><span class="hljs-type"><span class="koboSpan" id="kobo.325.1">byte</span></span><span class="koboSpan" id="kobo.326.1">(s)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.327.1">for</span></span><span class="koboSpan" id="kobo.328.1"> i, j := </span><span class="hljs-number"><span class="koboSpan" id="kobo.329.1">0</span></span><span class="koboSpan" id="kobo.330.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.331.1">len</span></span><span class="koboSpan" id="kobo.332.1">(b)</span><span class="hljs-number"><span class="koboSpan" id="kobo.333.1">-1</span></span><span class="koboSpan" id="kobo.334.1">; i &lt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.335.1">len</span></span><span class="koboSpan" id="kobo.336.1">(b)/</span><span class="hljs-number"><span class="koboSpan" id="kobo.337.1">2</span></span><span class="koboSpan" id="kobo.338.1">; i, j = i+</span><span class="hljs-number"><span class="koboSpan" id="kobo.339.1">1</span></span><span class="koboSpan" id="kobo.340.1">, j</span><span class="hljs-number"><span class="koboSpan" id="kobo.341.1">-1</span></span><span class="koboSpan" id="kobo.342.1"> {
        b[i], b[j] = b[j], b[i]
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.343.1">return</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.344.1">string</span></span><span class="koboSpan" id="kobo.345.1">(b)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.346.1">In this part, we implement a function named </span><code class="inlineCode"><span class="koboSpan" id="kobo.347.1">R2()</span></code><span class="koboSpan" id="kobo.348.1"> that also reverses a string. </span><span class="koboSpan" id="kobo.348.2">Internally, the function works </span><a id="_idIndexMarker1111"/><span class="koboSpan" id="kobo.349.1">with a byte slice but returns a </span><code class="inlineCode"><span class="koboSpan" id="kobo.350.1">string</span></code><span class="koboSpan" id="kobo.351.1"> value.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.352.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.353.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.354.1">()</span></span><span class="koboSpan" id="kobo.355.1"> {
    str := </span><span class="hljs-string"><span class="koboSpan" id="kobo.356.1">"1234567890"</span></span><span class="koboSpan" id="kobo.357.1">
    fmt.Println(</span><span class="hljs-type"><span class="koboSpan" id="kobo.358.1">string</span></span><span class="koboSpan" id="kobo.359.1">(R1(str)))
    fmt.Println(R2(str))
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.360.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.361.1">main()</span></code><span class="koboSpan" id="kobo.362.1"> function calls both </span><code class="inlineCode"><span class="koboSpan" id="kobo.363.1">R1()</span></code><span class="koboSpan" id="kobo.364.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.365.1">R2()</span></code><span class="koboSpan" id="kobo.366.1"> in order to reverse the </span><code class="inlineCode"><span class="koboSpan" id="kobo.367.1">"1234567890"</span></code><span class="koboSpan" id="kobo.368.1"> string—this is a naive way of testing the implemented functionality.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.369.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.370.1">reverse.go</span></code><span class="koboSpan" id="kobo.371.1"> generates the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.372.1">$ </span></span><span class="koboSpan" id="kobo.373.1">go run reverse.go
0987654321
0987654321
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.374.1">So, at first, the code looks correct and produces the expected output. </span><span class="koboSpan" id="kobo.374.2">Now, let us write some tests for the two functions in </span><code class="inlineCode"><span class="koboSpan" id="kobo.375.1">reverse.go</span></code><span class="koboSpan" id="kobo.376.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.377.1">The code in </span><code class="inlineCode"><span class="koboSpan" id="kobo.378.1">reverse_test.go</span></code><span class="koboSpan" id="kobo.379.1"> is presented in three parts. </span><span class="koboSpan" id="kobo.379.2">The first part is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.380.1">package</span></span><span class="koboSpan" id="kobo.381.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.382.1">import</span></span><span class="koboSpan" id="kobo.383.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.384.1">"testing"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.385.1">"unicode/utf8"</span></span><span class="koboSpan" id="kobo.386.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.387.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.388.1">TestR1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.389.1">(t *testing.T)</span></span><span class="koboSpan" id="kobo.390.1"> {
    testCases := []</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.391.1">struct</span></span><span class="koboSpan" id="kobo.392.1"> {
        in, want </span><span class="hljs-type"><span class="koboSpan" id="kobo.393.1">string</span></span><span class="koboSpan" id="kobo.394.1">
    }{
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.395.1">" "</span></span><span class="koboSpan" id="kobo.396.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.397.1">" "</span></span><span class="koboSpan" id="kobo.398.1">},
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.399.1">"!12345@"</span></span><span class="koboSpan" id="kobo.400.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.401.1">"@54321!"</span></span><span class="koboSpan" id="kobo.402.1">},
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.403.1">"Mastering Go"</span></span><span class="koboSpan" id="kobo.404.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.405.1">"oG gniretsaM"</span></span><span class="koboSpan" id="kobo.406.1">},
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.407.1">for</span></span><span class="koboSpan" id="kobo.408.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.409.1">range</span></span><span class="koboSpan" id="kobo.410.1"> testCases {
        rev := R1(tc.in)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.411.1">if</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.412.1">string</span></span><span class="koboSpan" id="kobo.413.1">(rev) != tc.want {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.414.1">"Reverse: %q, want %q"</span></span><span class="koboSpan" id="kobo.415.1">, rev, tc.want)
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.416.1">The preceding is a test</span><a id="_idIndexMarker1112"/><span class="koboSpan" id="kobo.417.1"> function for </span><code class="inlineCode"><span class="koboSpan" id="kobo.418.1">R1()</span></code><span class="koboSpan" id="kobo.419.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.420.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.421.1">TestR2</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.422.1">(t *testing.T)</span></span><span class="koboSpan" id="kobo.423.1"> {
    testCases := []</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.424.1">struct</span></span><span class="koboSpan" id="kobo.425.1"> {
        in, want </span><span class="hljs-type"><span class="koboSpan" id="kobo.426.1">string</span></span><span class="koboSpan" id="kobo.427.1">
    }{
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.428.1">" "</span></span><span class="koboSpan" id="kobo.429.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.430.1">" "</span></span><span class="koboSpan" id="kobo.431.1">},
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.432.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.433.1">!12345@"</span></span><span class="koboSpan" id="kobo.434.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.435.1">"@54321!"</span></span><span class="koboSpan" id="kobo.436.1">},
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.437.1">"Mastering Go"</span></span><span class="koboSpan" id="kobo.438.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.439.1">"oG gniretsaM"</span></span><span class="koboSpan" id="kobo.440.1">},
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.441.1">for</span></span><span class="koboSpan" id="kobo.442.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.443.1">range</span></span><span class="koboSpan" id="kobo.444.1"> testCases {
        rev := R2(tc.in)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.445.1">if</span></span><span class="koboSpan" id="kobo.446.1"> rev != tc.want {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.447.1">"Reverse: %q, want %q"</span></span><span class="koboSpan" id="kobo.448.1">, rev, tc.want)
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.449.1">The preceding is a test function for </span><code class="inlineCode"><span class="koboSpan" id="kobo.450.1">R2()</span></code><span class="koboSpan" id="kobo.451.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.452.1">Both </span><code class="inlineCode"><span class="koboSpan" id="kobo.453.1">TestR1()</span></code><span class="koboSpan" id="kobo.454.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.455.1">TestR2()</span></code><span class="koboSpan" id="kobo.456.1"> are regular testing functions that use user-defined tests, which are stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.457.1">testCases</span></code><span class="koboSpan" id="kobo.458.1"> structure. </span><span class="koboSpan" id="kobo.458.2">The first field is the original string, whereas the second field is the reversed string.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.459.1">The second part contains the fuzz testing functions and is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.460.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.461.1">FuzzR1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.462.1">(f *testing.F)</span></span><span class="koboSpan" id="kobo.463.1"> {
    testCases := []</span><span class="hljs-type"><span class="koboSpan" id="kobo.464.1">string</span></span><span class="koboSpan" id="kobo.465.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.466.1">"Hello, world"</span></span><span class="koboSpan" id="kobo.467.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.468.1">" "</span></span><span class="koboSpan" id="kobo.469.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.470.1">"!12345"</span></span><span class="koboSpan" id="kobo.471.1">}
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.472.1">for</span></span><span class="koboSpan" id="kobo.473.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.474.1">range</span></span><span class="koboSpan" id="kobo.475.1"> testCases {
        f.Add(tc)
    }
    f.Fuzz(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.476.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.477.1">(t *testing.T, orig </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.478.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.479.1">)</span></span><span class="koboSpan" id="kobo.480.1"> {
        rev := R1(orig)
        doubleRev := R1(</span><span class="hljs-type"><span class="koboSpan" id="kobo.481.1">string</span></span><span class="koboSpan" id="kobo.482.1">(rev))
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.483.1">if</span></span><span class="koboSpan" id="kobo.484.1"> orig != </span><span class="hljs-type"><span class="koboSpan" id="kobo.485.1">string</span></span><span class="koboSpan" id="kobo.486.1">(doubleRev) {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.487.1">"Before: %q, after: %q"</span></span><span class="koboSpan" id="kobo.488.1">, orig, doubleRev)
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.489.1">if</span></span><span class="koboSpan" id="kobo.490.1"> utf8.ValidString(orig) &amp;&amp; !utf8.ValidString(</span><span class="hljs-type"><span class="koboSpan" id="kobo.491.1">string</span></span><span class="koboSpan" id="kobo.492.1">(rev)) {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.493.1">"Reverse: invalid UTF-8 string %q"</span></span><span class="koboSpan" id="kobo.494.1">, rev)
        }
    })
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.495.1">This is a fuzz testing</span><a id="_idIndexMarker1113"/><span class="koboSpan" id="kobo.496.1"> function for testing </span><code class="inlineCode"><span class="koboSpan" id="kobo.497.1">R1()</span></code><span class="koboSpan" id="kobo.498.1">. </span><span class="koboSpan" id="kobo.498.2">We add three strings to the seed corpus, which are saved in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.499.1">testCases</span></code><span class="koboSpan" id="kobo.500.1"> slice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.501.1">The last part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.502.1">reverse_test.go</span></code><span class="koboSpan" id="kobo.503.1"> contains the code for testing </span><code class="inlineCode"><span class="koboSpan" id="kobo.504.1">R2()</span></code><span class="koboSpan" id="kobo.505.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.506.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.507.1">FuzzR2</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.508.1">(f *testing.F)</span></span><span class="koboSpan" id="kobo.509.1"> {
    testCases := []</span><span class="hljs-type"><span class="koboSpan" id="kobo.510.1">string</span></span><span class="koboSpan" id="kobo.511.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.512.1">"Hello, world"</span></span><span class="koboSpan" id="kobo.513.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.514.1">" "</span></span><span class="koboSpan" id="kobo.515.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.516.1">"!12345"</span></span><span class="koboSpan" id="kobo.517.1">}
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.518.1">for</span></span><span class="koboSpan" id="kobo.519.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.520.1">range</span></span><span class="koboSpan" id="kobo.521.1"> testCases {
        f.Add(tc)
    }
    f.Fuzz(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.522.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.523.1">(t *testing.T, orig </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.524.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.525.1">)</span></span><span class="koboSpan" id="kobo.526.1"> {
        rev := R2(orig)
        doubleRev := R2(rev)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.527.1">if</span></span><span class="koboSpan" id="kobo.528.1"> orig != doubleRev {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.529.1">"Before: %q, after: %q"</span></span><span class="koboSpan" id="kobo.530.1">, orig, doubleRev)
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.531.1">if</span></span><span class="koboSpan" id="kobo.532.1"> utf8.ValidString(orig) &amp;&amp; !utf8.ValidString(rev) {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.533.1">"Reverse: invalid UTF-8 string %q"</span></span><span class="koboSpan" id="kobo.534.1">, rev)
        }
    })
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.535.1">This is a fuzz testing function for testing </span><code class="inlineCode"><span class="koboSpan" id="kobo.536.1">R2()</span></code><span class="koboSpan" id="kobo.537.1">. </span><span class="koboSpan" id="kobo.537.2">As before, we add three strings to the seed corpus using the values stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.538.1">testCases</span></code><span class="koboSpan" id="kobo.539.1"> slice.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.540.1">Both fuzz testing functions reverse the given string two times and compare it with </span><code class="inlineCode"><span class="koboSpan" id="kobo.541.1">orig</span></code><span class="koboSpan" id="kobo.542.1"> itself to make sure that they are the same. </span><span class="koboSpan" id="kobo.542.2">This happens because, when you reverse a string twice, you should get the original string back.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.543.1">Running tests without fuzzing produces the following results:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.544.1">$ </span></span><span class="koboSpan" id="kobo.545.1">go </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.546.1">test</span></span><span class="koboSpan" id="kobo.547.1"> *.go
ok    command-line-arguments    0.103s
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.548.1">So, it looks like</span><a id="_idIndexMarker1114"/><span class="koboSpan" id="kobo.549.1"> everything is working as expected. </span><span class="koboSpan" id="kobo.549.2">But is this the case?</span></p>
<p class="normal"><span class="koboSpan" id="kobo.550.1">Let us run tests with fuzzing. </span><span class="koboSpan" id="kobo.550.2">First, we are going to run </span><code class="inlineCode"><span class="koboSpan" id="kobo.551.1">FuzzR1()</span></code><span class="koboSpan" id="kobo.552.1"> as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.553.1">$ </span></span><span class="koboSpan" id="kobo.554.1">go </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.555.1">test</span></span><span class="koboSpan" id="kobo.556.1"> -fuzz=FuzzR1 *.go
fuzz: elapsed: 0s, gathering baseline coverage: 0/7 completed
fuzz: elapsed: 0s, gathering baseline coverage: 7/7 completed, now fuzzing with 10 workers
fuzz: minimizing 30-byte failing input file
fuzz: elapsed: 0s, minimizing
--- FAIL: FuzzR1 (0.03s)
    --- FAIL: FuzzR1 (0.00s)
        reverse_test.go:55: Reverse: invalid UTF-8 string "\x94\xd4"
    Failing input written to testdata/fuzz/FuzzR1/a256ceb5e3bf582f
    To re-run:
    go test -run=FuzzR1/a256ceb5e3bf582f
FAIL
exit status 1
FAIL    command-line-arguments    0.493s
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.557.1">So, in this case, the fuzz test found an issue with the code. </span><span class="koboSpan" id="kobo.557.2">The failing input is saved in </span><code class="inlineCode"><span class="koboSpan" id="kobo.558.1">testdata/fuzz/FuzzR1/42f418307d5ef745</span></code><span class="koboSpan" id="kobo.559.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.560.1">The contents of </span><code class="inlineCode"><span class="koboSpan" id="kobo.561.1">testdata/fuzz/FuzzR1/a256ceb5e3bf582f</span></code><span class="koboSpan" id="kobo.562.1"> are the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.563.1">$ </span></span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.564.1">cat</span></span><span class="koboSpan" id="kobo.565.1"> testdata/fuzz/FuzzR1/a256ceb5e3bf582f
go test fuzz v1
string("Ԕ")
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.566.1">Put simply, the string stored in </span><code class="inlineCode"><span class="koboSpan" id="kobo.567.1">testdata/fuzz/FuzzR1/a256ceb5e3bf582f</span></code><span class="koboSpan" id="kobo.568.1"> is not being reversed successfully.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.569.1">Next, we are going to run </span><code class="inlineCode"><span class="koboSpan" id="kobo.570.1">FuzzR2()</span></code><span class="koboSpan" id="kobo.571.1"> with fuzzing:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.572.1">$ </span></span><span class="koboSpan" id="kobo.573.1">go </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.574.1">test</span></span><span class="koboSpan" id="kobo.575.1"> -fuzz=FuzzR2 *.go
--- FAIL: FuzzR1 (0.00s)
    --- FAIL: FuzzR1/a256ceb5e3bf582f (0.00s)
        reverse_test.go:55: Reverse: invalid UTF-8 string "\x94\xd4"
FAIL
exit status 1
FAIL    command-line-arguments    0.253s
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.576.1">As there exists a </span><code class="inlineCode"><span class="koboSpan" id="kobo.577.1">testdata</span></code><span class="koboSpan" id="kobo.578.1"> directory from the failure of </span><code class="inlineCode"><span class="koboSpan" id="kobo.579.1">FuzzR1()</span></code><span class="koboSpan" id="kobo.580.1">, the second fuzz testing fails because </span><a id="_idIndexMarker1115"/><span class="koboSpan" id="kobo.581.1">of the data found in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.582.1">testdata</span></code><span class="koboSpan" id="kobo.583.1"> directory. </span><span class="koboSpan" id="kobo.583.2">In the subsection that follows, we are going to correct the bug.</span></p>
<h2 class="heading-2" id="_idParaDest-369"><span class="koboSpan" id="kobo.584.1">Correcting the bug</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.585.1">What we should do</span><a id="_idIndexMarker1116"/><span class="koboSpan" id="kobo.586.1"> now is </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.587.1">correct the bug</span></strong><span class="koboSpan" id="kobo.588.1">. </span><span class="koboSpan" id="kobo.588.2">The improved version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.589.1">reverse.go</span></code><span class="koboSpan" id="kobo.590.1"> is called </span><code class="inlineCode"><span class="koboSpan" id="kobo.591.1">correct.go</span></code><span class="koboSpan" id="kobo.592.1"> and is found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.593.1">ch13/reverse/correct</span></code><span class="koboSpan" id="kobo.594.1">. </span><span class="koboSpan" id="kobo.594.2">Its code is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.595.1">package</span></span><span class="koboSpan" id="kobo.596.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.597.1">import</span></span><span class="koboSpan" id="kobo.598.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.599.1">"errors"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.600.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.601.1">fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.602.1">"unicode/utf8"</span></span><span class="koboSpan" id="kobo.603.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.604.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.605.1">R1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.606.1">(s </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.607.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.608.1">)</span></span><span class="koboSpan" id="kobo.609.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.610.1">string</span></span><span class="koboSpan" id="kobo.611.1">, </span><span class="hljs-type"><span class="koboSpan" id="kobo.612.1">error</span></span><span class="koboSpan" id="kobo.613.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.614.1">if</span></span><span class="koboSpan" id="kobo.615.1"> !utf8.ValidString(s) {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.616.1">return</span></span><span class="koboSpan" id="kobo.617.1"> s, errors.New(</span><span class="hljs-string"><span class="koboSpan" id="kobo.618.1">"Invalid UTF-8"</span></span><span class="koboSpan" id="kobo.619.1">)
    }
    a := []</span><span class="hljs-type"><span class="koboSpan" id="kobo.620.1">byte</span></span><span class="koboSpan" id="kobo.621.1">(s)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.622.1">for</span></span><span class="koboSpan" id="kobo.623.1"> i, j := </span><span class="hljs-number"><span class="koboSpan" id="kobo.624.1">0</span></span><span class="koboSpan" id="kobo.625.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.626.1">len</span></span><span class="koboSpan" id="kobo.627.1">(s)</span><span class="hljs-number"><span class="koboSpan" id="kobo.628.1">-1</span></span><span class="koboSpan" id="kobo.629.1">; i &lt; j; i++ {
        a[i], a[j] = a[j], a[i]
        j--
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.630.1">return</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.631.1">string</span></span><span class="koboSpan" id="kobo.632.1">(a), </span><span class="hljs-literal"><span class="koboSpan" id="kobo.633.1">nil</span></span><span class="koboSpan" id="kobo.634.1">
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.635.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.636.1">R2</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.637.1">(s </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.638.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.639.1">)</span></span><span class="koboSpan" id="kobo.640.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.641.1">string</span></span><span class="koboSpan" id="kobo.642.1">, </span><span class="hljs-type"><span class="koboSpan" id="kobo.643.1">error</span></span><span class="koboSpan" id="kobo.644.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.645.1">if</span></span><span class="koboSpan" id="kobo.646.1"> !utf8.ValidString(s) {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.647.1">return</span></span><span class="koboSpan" id="kobo.648.1"> s, errors.New(</span><span class="hljs-string"><span class="koboSpan" id="kobo.649.1">"Invalid UTF-8"</span></span><span class="koboSpan" id="kobo.650.1">)
    }
    r := []</span><span class="hljs-type"><span class="koboSpan" id="kobo.651.1">rune</span></span><span class="koboSpan" id="kobo.652.1">(s)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.653.1">for</span></span><span class="koboSpan" id="kobo.654.1"> i, j := </span><span class="hljs-number"><span class="koboSpan" id="kobo.655.1">0</span></span><span class="koboSpan" id="kobo.656.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.657.1">len</span></span><span class="koboSpan" id="kobo.658.1">(r)</span><span class="hljs-number"><span class="koboSpan" id="kobo.659.1">-1</span></span><span class="koboSpan" id="kobo.660.1">; i &lt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.661.1">len</span></span><span class="koboSpan" id="kobo.662.1">(r)/</span><span class="hljs-number"><span class="koboSpan" id="kobo.663.1">2</span></span><span class="koboSpan" id="kobo.664.1">; i, j = i+</span><span class="hljs-number"><span class="koboSpan" id="kobo.665.1">1</span></span><span class="koboSpan" id="kobo.666.1">, j</span><span class="hljs-number"><span class="koboSpan" id="kobo.667.1">-1</span></span><span class="koboSpan" id="kobo.668.1"> {
        r[i], r[j] = r[j], r[i]
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.669.1">return</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.670.1">string</span></span><span class="koboSpan" id="kobo.671.1">(r), </span><span class="hljs-literal"><span class="koboSpan" id="kobo.672.1">nil</span></span><span class="koboSpan" id="kobo.673.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.674.1">Notice that in the implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.675.1">R2()</span></code><span class="koboSpan" id="kobo.676.1">, we now work with </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.677.1">runes instead of bytes</span></strong><span class="koboSpan" id="kobo.678.1">. </span><span class="koboSpan" id="kobo.678.2">Additionally, both </span><code class="inlineCode"><span class="koboSpan" id="kobo.679.1">R1()</span></code><span class="koboSpan" id="kobo.680.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.681.1">R2()</span></code><span class="koboSpan" id="kobo.682.1"> verify that we are dealing with a valid UTF-8 string using the functionality of </span><code class="inlineCode"><span class="koboSpan" id="kobo.683.1">utf8.ValidString()</span></code><span class="koboSpan" id="kobo.684.1"> prior to doing any processing. </span><span class="koboSpan" id="kobo.684.2">When the input is an invalid UTF-8 string, an </span><code class="inlineCode"><span class="koboSpan" id="kobo.685.1">error</span></code><span class="koboSpan" id="kobo.686.1"> message is returned—we did not do that in </span><code class="inlineCode"><span class="koboSpan" id="kobo.687.1">reverse.go</span></code><span class="koboSpan" id="kobo.688.1">, which is</span><a id="_idIndexMarker1117"/><span class="koboSpan" id="kobo.689.1"> what caused the bug.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.690.1">The remaining code is about the implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.691.1">main()</span></code><span class="koboSpan" id="kobo.692.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.693.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.694.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.695.1">()</span></span><span class="koboSpan" id="kobo.696.1"> {
    str := </span><span class="hljs-string"><span class="koboSpan" id="kobo.697.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.698.1">1234567890"</span></span><span class="koboSpan" id="kobo.699.1">
    R1ret, _ := R1(str)
    fmt.Println(R1ret)
    R2ret, _ := R2(str)
    fmt.Println(R2ret)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.700.1">As explained earlier, the main difference in this improved version is that the two functions also return an </span><code class="inlineCode"><span class="koboSpan" id="kobo.701.1">error</span></code><span class="koboSpan" id="kobo.702.1"> variable to make sure that we are dealing with valid UTF-8 strings. </span><span class="koboSpan" id="kobo.702.2">However, this also means that the test functions as well as the fuzz testing functions should be modified in order to adjust to the change in the function signatures.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.703.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.704.1">correct.go</span></code><span class="koboSpan" id="kobo.705.1"> produces the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.706.1">$ </span></span><span class="koboSpan" id="kobo.707.1">go run correct.go
0987654321
0987654321
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.708.1">So, it looks like the basic functionality is still implemented correctly.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.709.1">The improved test version is called </span><code class="inlineCode"><span class="koboSpan" id="kobo.710.1">correct_test.go</span></code><span class="koboSpan" id="kobo.711.1"> and is also found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.712.1">ch13/reverse/correct</span></code><span class="koboSpan" id="kobo.713.1">—it is going to be presented in two parts. </span><span class="koboSpan" id="kobo.713.2">The first part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.714.1">correct_test.go</span></code><span class="koboSpan" id="kobo.715.1"> contains</span><a id="_idIndexMarker1118"/><span class="koboSpan" id="kobo.716.1"> the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.717.1">package</span></span><span class="koboSpan" id="kobo.718.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.719.1">import</span></span><span class="koboSpan" id="kobo.720.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.721.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.722.1">testing"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.723.1">"unicode/utf8"</span></span><span class="koboSpan" id="kobo.724.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.725.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.726.1">TestR1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.727.1">(t *testing.T)</span></span><span class="koboSpan" id="kobo.728.1"> {
    testCases := []</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.729.1">struct</span></span><span class="koboSpan" id="kobo.730.1"> {
        in, want </span><span class="hljs-type"><span class="koboSpan" id="kobo.731.1">string</span></span><span class="koboSpan" id="kobo.732.1">
    }{
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.733.1">" "</span></span><span class="koboSpan" id="kobo.734.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.735.1">" "</span></span><span class="koboSpan" id="kobo.736.1">},
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.737.1">"!12345@"</span></span><span class="koboSpan" id="kobo.738.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.739.1">"@54321!"</span></span><span class="koboSpan" id="kobo.740.1">},
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.741.1">"Mastering Go"</span></span><span class="koboSpan" id="kobo.742.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.743.1">"oG gniretsaM"</span></span><span class="koboSpan" id="kobo.744.1">},
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.745.1">for</span></span><span class="koboSpan" id="kobo.746.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.747.1">range</span></span><span class="koboSpan" id="kobo.748.1"> testCases {
        rev, err := R1(tc.in)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.749.1">if</span></span><span class="koboSpan" id="kobo.750.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.751.1">nil</span></span><span class="koboSpan" id="kobo.752.1"> {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.753.1">return</span></span><span class="koboSpan" id="kobo.754.1">
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.755.1">if</span></span><span class="koboSpan" id="kobo.756.1"> rev != tc.want {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.757.1">"Reverse: %q, want %q"</span></span><span class="koboSpan" id="kobo.758.1">, rev, tc.want)
        }
    }
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.759.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.760.1">TestR2</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.761.1">(t *testing.T)</span></span><span class="koboSpan" id="kobo.762.1"> {
    testCases := []</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.763.1">struct</span></span><span class="koboSpan" id="kobo.764.1"> {
        in, want </span><span class="hljs-type"><span class="koboSpan" id="kobo.765.1">string</span></span><span class="koboSpan" id="kobo.766.1">
    }{
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.767.1">" "</span></span><span class="koboSpan" id="kobo.768.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.769.1">" "</span></span><span class="koboSpan" id="kobo.770.1">},
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.771.1">"!12345@"</span></span><span class="koboSpan" id="kobo.772.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.773.1">"@54321!"</span></span><span class="koboSpan" id="kobo.774.1">},
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.775.1">"Mastering Go"</span></span><span class="koboSpan" id="kobo.776.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.777.1">"oG gniretsaM"</span></span><span class="koboSpan" id="kobo.778.1">},
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.779.1">for</span></span><span class="koboSpan" id="kobo.780.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.781.1">range</span></span><span class="koboSpan" id="kobo.782.1"> testCases {
        rev, err := R2(tc.in)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.783.1">if</span></span><span class="koboSpan" id="kobo.784.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.785.1">nil</span></span><span class="koboSpan" id="kobo.786.1"> {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.787.1">return</span></span><span class="koboSpan" id="kobo.788.1">
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.789.1">if</span></span><span class="koboSpan" id="kobo.790.1"> rev != tc.want {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.791.1">"Reverse: %q, want %q"</span></span><span class="koboSpan" id="kobo.792.1">, rev, tc.want)
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.793.1">The logic of both </span><code class="inlineCode"><span class="koboSpan" id="kobo.794.1">TestR1()</span></code><span class="koboSpan" id="kobo.795.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.796.1">TestR2()</span></code><span class="koboSpan" id="kobo.797.1"> is the same as before: we use the values stored in a slice of structures (</span><code class="inlineCode"><span class="koboSpan" id="kobo.798.1">testCases</span></code><span class="koboSpan" id="kobo.799.1">) to verify the correctness of </span><code class="inlineCode"><span class="koboSpan" id="kobo.800.1">R1()</span></code><span class="koboSpan" id="kobo.801.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.802.1">R2()</span></code><span class="koboSpan" id="kobo.803.1">. </span><span class="koboSpan" id="kobo.803.2">However, this time, we take into consideration the </span><code class="inlineCode"><span class="koboSpan" id="kobo.804.1">error</span></code><span class="koboSpan" id="kobo.805.1"> value returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.806.1">R1()</span></code><span class="koboSpan" id="kobo.807.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.808.1">R2()</span></code><span class="koboSpan" id="kobo.809.1">. </span><span class="koboSpan" id="kobo.809.2">If there is an error with </span><code class="inlineCode"><span class="koboSpan" id="kobo.810.1">R1()</span></code><span class="koboSpan" id="kobo.811.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.812.1">R2()</span></code><span class="koboSpan" id="kobo.813.1">, both test functions return immediately, which makes the test</span><a id="_idIndexMarker1119"/><span class="koboSpan" id="kobo.814.1"> successful.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.815.1">The second part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.816.1">correct_test.go</span></code><span class="koboSpan" id="kobo.817.1"> is the implementation of the fuzz testing functions:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.818.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.819.1">FuzzR1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.820.1">(f *testing.F)</span></span><span class="koboSpan" id="kobo.821.1"> {
    testCases := []</span><span class="hljs-type"><span class="koboSpan" id="kobo.822.1">string</span></span><span class="koboSpan" id="kobo.823.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.824.1">"Hello, world"</span></span><span class="koboSpan" id="kobo.825.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.826.1">" "</span></span><span class="koboSpan" id="kobo.827.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.828.1">"!12345"</span></span><span class="koboSpan" id="kobo.829.1">}
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.830.1">for</span></span><span class="koboSpan" id="kobo.831.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.832.1">range</span></span><span class="koboSpan" id="kobo.833.1"> testCases {
        f.Add(tc)
    }
    f.Fuzz(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.834.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.835.1">(t *testing.T, orig </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.836.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.837.1">)</span></span><span class="koboSpan" id="kobo.838.1"> {
        rev, err := R1(orig)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.839.1">if</span></span><span class="koboSpan" id="kobo.840.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.841.1">nil</span></span><span class="koboSpan" id="kobo.842.1"> {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.843.1">return</span></span><span class="koboSpan" id="kobo.844.1">
        }
        doubleRev, err := R1(rev)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.845.1">if</span></span><span class="koboSpan" id="kobo.846.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.847.1">nil</span></span><span class="koboSpan" id="kobo.848.1"> {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.849.1">return</span></span><span class="koboSpan" id="kobo.850.1">
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.851.1">if</span></span><span class="koboSpan" id="kobo.852.1"> orig != doubleRev {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.853.1">"Before: %q, after: %q"</span></span><span class="koboSpan" id="kobo.854.1">, orig, doubleRev)
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.855.1">if</span></span><span class="koboSpan" id="kobo.856.1"> utf8.ValidString(orig) &amp;&amp; !utf8.ValidString(</span><span class="hljs-type"><span class="koboSpan" id="kobo.857.1">string</span></span><span class="koboSpan" id="kobo.858.1">(rev)) {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.859.1">"Reverse: invalid UTF-8 string %q"</span></span><span class="koboSpan" id="kobo.860.1">, rev)
        }
    })
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.861.1">FuzzR1()</span></code><span class="koboSpan" id="kobo.862.1"> uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.863.1">error</span></code><span class="koboSpan" id="kobo.864.1"> value returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.865.1">R1()</span></code><span class="koboSpan" id="kobo.866.1"> to make sure that we are dealing with a valid string. </span><span class="koboSpan" id="kobo.866.2">If the string is not valid, then it returns. </span><span class="koboSpan" id="kobo.866.3">Additionally, it reverses the given string—which is stored in the automatically generated </span><code class="inlineCode"><span class="koboSpan" id="kobo.867.1">orig</span></code><span class="koboSpan" id="kobo.868.1"> parameter—two times and compares it with </span><code class="inlineCode"><span class="koboSpan" id="kobo.869.1">orig</span></code><span class="koboSpan" id="kobo.870.1"> itself to make sure that they are the same.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.871.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.872.1">FuzzR2</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.873.1">(f *testing.F)</span></span><span class="koboSpan" id="kobo.874.1"> {
    testCases := []</span><span class="hljs-type"><span class="koboSpan" id="kobo.875.1">string</span></span><span class="koboSpan" id="kobo.876.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.877.1">"Hello, world"</span></span><span class="koboSpan" id="kobo.878.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.879.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.880.1"> "</span></span><span class="koboSpan" id="kobo.881.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.882.1">"!12345"</span></span><span class="koboSpan" id="kobo.883.1">}
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.884.1">for</span></span><span class="koboSpan" id="kobo.885.1"> _, tc := </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.886.1">range</span></span><span class="koboSpan" id="kobo.887.1"> testCases {
        f.Add(tc)
    }
    f.Fuzz(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.888.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.889.1">(t *testing.T, orig </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.890.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.891.1">)</span></span><span class="koboSpan" id="kobo.892.1"> {
        rev, err := R2(orig)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.893.1">if</span></span><span class="koboSpan" id="kobo.894.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.895.1">nil</span></span><span class="koboSpan" id="kobo.896.1"> {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.897.1">return</span></span><span class="koboSpan" id="kobo.898.1">
        }
        doubleRev, err := R2(</span><span class="code-highlight"><strong class="hljs-type-slc"><span class="koboSpan" id="kobo.899.1">string</span></strong></span><span class="koboSpan" id="kobo.900.1">(rev))
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.901.1">if</span></span><span class="koboSpan" id="kobo.902.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.903.1">nil</span></span><span class="koboSpan" id="kobo.904.1"> {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.905.1">return</span></span><span class="koboSpan" id="kobo.906.1">
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.907.1">if</span></span><span class="koboSpan" id="kobo.908.1"> orig != doubleRev {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.909.1">"Before: %q, after: %q"</span></span><span class="koboSpan" id="kobo.910.1">, orig, doubleRev)
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.911.1">if</span></span><span class="koboSpan" id="kobo.912.1"> utf8.ValidString(orig) &amp;&amp; !utf8.ValidString(rev) {
            t.Errorf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.913.1">"Reverse: invalid UTF-8 string %q"</span></span><span class="koboSpan" id="kobo.914.1">, rev)
        }
    })
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.915.1">FuzzR2()</span></code><span class="koboSpan" id="kobo.916.1"> also uses</span><a id="_idIndexMarker1120"/><span class="koboSpan" id="kobo.917.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.918.1">error</span></code><span class="koboSpan" id="kobo.919.1"> value returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.920.1">R2()</span></code><span class="koboSpan" id="kobo.921.1"> to make sure that we are dealing with a valid string. </span><span class="koboSpan" id="kobo.921.2">If the string is not valid, then it also returns. </span><span class="koboSpan" id="kobo.921.3">The remaining implementation follows the logic of </span><code class="inlineCode"><span class="koboSpan" id="kobo.922.1">FuzzR1()</span></code><span class="koboSpan" id="kobo.923.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.924.1">Running the regular tests produces the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.925.1">$ </span></span><span class="koboSpan" id="kobo.926.1">go </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.927.1">test</span></span><span class="koboSpan" id="kobo.928.1"> *.go
ok    command-line-arguments    0.609s
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.929.1">Performing the fuzzing test for </span><code class="inlineCode"><span class="koboSpan" id="kobo.930.1">R1()</span></code><span class="koboSpan" id="kobo.931.1"> generates the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.932.1">$ </span></span><span class="koboSpan" id="kobo.933.1">go </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.934.1">test</span></span><span class="koboSpan" id="kobo.935.1"> -fuzz=FuzzR1 *.go -fuzztime 10s
fuzz: elapsed: 0s, gathering baseline coverage: 0/15 completed
fuzz: elapsed: 0s, gathering baseline coverage: 15/15 completed, now fuzzing with 10 workers
fuzz: elapsed: 3s, execs: 1129701 (376437/sec), new interesting: 31 (total: 46)
fuzz: elapsed: 6s, execs: 2527522 (466068/sec), new interesting: 34 (total: 49)
fuzz: elapsed: 9s, execs: 3808349 (426919/sec), new interesting: 37 (total: 52)
fuzz: elapsed: 11s, execs: 4208389 (199790/sec), new interesting: 37 (total: 52)
PASS
ok    command-line-arguments    11.508s
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.936.1">The use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.937.1">-fuzztime 10s</span></code><span class="koboSpan" id="kobo.938.1"> makes sure that the tests are going to stop after they exceed the given time limit or when there is an error.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.939.1">Running the </span><a id="_idIndexMarker1121"/><span class="koboSpan" id="kobo.940.1">fuzzing test for </span><code class="inlineCode"><span class="koboSpan" id="kobo.941.1">R2()</span></code><span class="koboSpan" id="kobo.942.1"> generates the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.943.1">$ </span></span><span class="koboSpan" id="kobo.944.1">go </span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.945.1">test</span></span><span class="koboSpan" id="kobo.946.1"> -fuzz=FuzzR2 *.go -fuzztime 10s
fuzz: elapsed: 0s, gathering baseline coverage: 0/3 completed
fuzz: elapsed: 0s, gathering baseline coverage: 3/3 completed, now fuzzing with 10 workers
fuzz: elapsed: 3s, execs: 1271973 (423844/sec), new interesting: 38 (total: 41)
fuzz: elapsed: 6s, execs: 2638924 (455741/sec), new interesting: 39 (total: 42)
fuzz: elapsed: 9s, execs: 4044955 (468745/sec), new interesting: 39 (total: 42)
fuzz: elapsed: 10s, execs: 4495553 (413586/sec), new interesting: 39 (total: 42)
PASS
ok    command-line-arguments    10.396s
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.947.1">So, everything works as expected and the bug was corrected!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.948.1">The next section is </span><a id="_idIndexMarker1122"/><span class="koboSpan" id="kobo.949.1">about observability, which is a systematic way of collecting data related to the efficiency and the internals of a system.</span></p>
<h1 class="heading-1" id="_idParaDest-370"><span class="koboSpan" id="kobo.950.1">Observability</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.951.1">Observability is the</span><a id="_idIndexMarker1123"/><span class="koboSpan" id="kobo.952.1"> measurement of the internal state of a system in relation to external operations. </span><span class="koboSpan" id="kobo.952.2">In practical terms, observability is about understanding how well the resources of a computer system are being utilized while a given software or application is being executed on a system.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.953.1">In Go terminology, and in relation to the content of this book, observability is about learning </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.954.1">how Go uses the available resources and how an application performs while the application is executed</span></strong><span class="koboSpan" id="kobo.955.1"> in order to understand the efficiency of the Go application as well as the Go runtime itself. </span><span class="koboSpan" id="kobo.955.2">The purpose of this process is to improve the efficiency of a Go application and maybe modify the resources available to that particular Go application in order to improve its overall operation.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.956.1">If it is still unclear, let me explain it in a more practical way. </span><span class="koboSpan" id="kobo.956.2">Let us say that a Go application runs slow. </span><span class="koboSpan" id="kobo.956.3">We need to discover why this happens. </span><span class="koboSpan" id="kobo.956.4">For that, we measure the appropriate internal Go metrics as well as application-specific metrics and try to make sense of them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.957.1">The key components of observability include:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.958.1">Logs</span></strong><span class="koboSpan" id="kobo.959.1">: Recording events, activities, and</span><a id="_idIndexMarker1124"/><span class="koboSpan" id="kobo.960.1"> messages generated by a system. </span><span class="koboSpan" id="kobo.960.2">Logs provide a historical record of what has happened and are useful for debugging and auditing.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.961.1">Metrics</span></strong><span class="koboSpan" id="kobo.962.1">: Quantitative measurements that provide insight into the system’s performance and behavior. </span><span class="koboSpan" id="kobo.962.2">Metrics examples include response times, error rates, and resource utilization.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.963.1">Traces</span></strong><span class="koboSpan" id="kobo.964.1">: Sequences of events or transactions that allow you to trace the flow of a request through a system. </span><span class="koboSpan" id="kobo.964.2">Tracing helps in understanding the latency and dependencies between different components.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.965.1">Monitoring</span></strong><span class="koboSpan" id="kobo.966.1">: Continuous tracking of metrics and logs to identify patterns, anomalies, and potential issues. </span><span class="koboSpan" id="kobo.966.2">Monitoring systems can generate alerts when predefined thresholds are exceeded. </span><span class="koboSpan" id="kobo.966.3">This is a complex task, especially when having to deal with a large number of metrics.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.967.1">Alerting</span></strong><span class="koboSpan" id="kobo.968.1">: Notification mechanisms that inform administrators or operators about potential issues or irregularities in the system. </span><span class="koboSpan" id="kobo.968.2">Alerts help in responding quickly to problems and minimizing downtime.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.969.1">Distributed tracing</span></strong><span class="koboSpan" id="kobo.970.1">: Tracking and visualizing requests as they traverse through various components in a distributed system. </span><span class="koboSpan" id="kobo.970.2">This is particularly important in </span><a id="_idIndexMarker1125"/><span class="koboSpan" id="kobo.971.1">microservices architectures and is extremely challenging.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.972.1">This chapter is going to deal with metrics. </span><span class="koboSpan" id="kobo.972.2">Code profiling and tracing were covered in </span><em class="chapterRef"><span class="koboSpan" id="kobo.973.1">Chapter 12</span></em><span class="koboSpan" id="kobo.974.1">, </span><em class="italic"><span class="koboSpan" id="kobo.975.1">Code Testing and Profiling</span></em><span class="koboSpan" id="kobo.976.1">. </span><span class="koboSpan" id="kobo.976.2">Additionally, logging was covered in </span><em class="chapterRef"><span class="koboSpan" id="kobo.977.1">Chapter 1</span></em><span class="koboSpan" id="kobo.978.1">, </span><em class="italic"><span class="koboSpan" id="kobo.979.1">A Quick Introduction to Go</span></em><span class="koboSpan" id="kobo.980.1">, and </span><em class="chapterRef"><span class="koboSpan" id="kobo.981.1">Chapter 7</span></em><span class="koboSpan" id="kobo.982.1">, </span><em class="italic"><span class="koboSpan" id="kobo.983.1">Telling a UNIX System What to Do</span></em><span class="koboSpan" id="kobo.984.1">. </span><span class="koboSpan" id="kobo.984.2">Dealing with the remaining components is beyond the scope of this book.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.985.1">We begin by </span><a id="_idIndexMarker1126"/><span class="koboSpan" id="kobo.986.1">explaining the use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.987.1">runtime/metrics</span></code><span class="koboSpan" id="kobo.988.1"> package, which provides Go runtime-related metrics.</span></p>
<h2 class="heading-2" id="_idParaDest-371"><span class="koboSpan" id="kobo.989.1">The runtime/metrics package</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.990.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.991.1">runtime/metrics</span></code><span class="koboSpan" id="kobo.992.1"> package</span><a id="_idIndexMarker1127"/><span class="koboSpan" id="kobo.993.1"> makes metrics exported by the</span><a id="_idIndexMarker1128"/><span class="koboSpan" id="kobo.994.1"> Go runtime available to the developer. </span><span class="koboSpan" id="kobo.994.2">Each metric name is specified by a path. </span><span class="koboSpan" id="kobo.994.3">As an example, the number of live goroutines is accessed as </span><code class="inlineCode"><span class="koboSpan" id="kobo.995.1">/sched/goroutines:goroutines</span></code><span class="koboSpan" id="kobo.996.1">. </span><span class="koboSpan" id="kobo.996.2">However, if you want to collect all available metrics, you should use </span><code class="inlineCode"><span class="koboSpan" id="kobo.997.1">metrics.All()</span></code><span class="koboSpan" id="kobo.998.1">—this saves you from having to write lots of code in order to collect each individual metric.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.999.1">Metrics are saved using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1000.1">metrics.Sample</span></code><span class="koboSpan" id="kobo.1001.1"> data type. </span><span class="koboSpan" id="kobo.1001.2">The definition of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1002.1">metrics.Sample</span></code><span class="koboSpan" id="kobo.1003.1"> data structure is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1004.1">type</span></span><span class="koboSpan" id="kobo.1005.1"> Sample </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1006.1">struct</span></span><span class="koboSpan" id="kobo.1007.1"> {
    Name </span><span class="hljs-type"><span class="koboSpan" id="kobo.1008.1">string</span></span><span class="koboSpan" id="kobo.1009.1">
    Value Value
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1010.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1011.1">Name</span></code><span class="koboSpan" id="kobo.1012.1"> value must correspond to the name of one of the metric descriptions returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1013.1">metrics.All()</span></code><span class="koboSpan" id="kobo.1014.1">. </span><span class="koboSpan" id="kobo.1014.2">If you already know the metric description, there is no need to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1015.1">metrics.All()</span></code><span class="koboSpan" id="kobo.1016.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1017.1">The use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1018.1">runtime/metrics</span></code><span class="koboSpan" id="kobo.1019.1"> package is illustrated in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1020.1">metrics.go</span></code><span class="koboSpan" id="kobo.1021.1">. </span><span class="koboSpan" id="kobo.1021.2">The presented code gets the value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1022.1">/sched/goroutines:goroutines</span></code><span class="koboSpan" id="kobo.1023.1"> and prints it on screen:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1024.1">package</span></span><span class="koboSpan" id="kobo.1025.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1026.1">import</span></span><span class="koboSpan" id="kobo.1027.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1028.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1029.1">"runtime/metrics"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1030.1">"sync"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1031.1">"time"</span></span><span class="koboSpan" id="kobo.1032.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1033.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1034.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1035.1">()</span></span><span class="koboSpan" id="kobo.1036.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1037.1">const</span></span><span class="koboSpan" id="kobo.1038.1"> nGo = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1039.1">"/sched/goroutines:goroutines"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1040.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1041.1">nGo</span></code><span class="koboSpan" id="kobo.1042.1"> variable holds the path of the metric we want to collect.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1043.1">    getMetric := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1044.1">make</span></span><span class="koboSpan" id="kobo.1045.1">([]metrics.Sample, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1046.1">1</span></span><span class="koboSpan" id="kobo.1047.1">)
    getMetric[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1048.1">0</span></span><span class="koboSpan" id="kobo.1049.1">].Name = nGo
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1050.1">After that, we create a slice of type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1051.1">metrics.Sample</span></code><span class="koboSpan" id="kobo.1052.1"> in order to keep the metric value. </span><span class="koboSpan" id="kobo.1052.2">The initial size of the slice is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1053.1">1</span></code><span class="koboSpan" id="kobo.1054.1"> because we are only collecting values for a single metric. </span><span class="koboSpan" id="kobo.1054.2">We set the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1055.1">Name</span></code><span class="koboSpan" id="kobo.1056.1"> value to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1057.1">/sched/goroutines:goroutines</span></code><span class="koboSpan" id="kobo.1058.1"> as stored in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1059.1">nGo</span></code><span class="koboSpan" id="kobo.1060.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1061.1">var</span></span><span class="koboSpan" id="kobo.1062.1"> wg sync.WaitGroup
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1063.1">for</span></span><span class="koboSpan" id="kobo.1064.1"> i := </span><span class="hljs-number"><span class="koboSpan" id="kobo.1065.1">0</span></span><span class="koboSpan" id="kobo.1066.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1067.1">3</span></span><span class="koboSpan" id="kobo.1068.1">; i++ {
        wg.Add(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1069.1">1</span></span><span class="koboSpan" id="kobo.1070.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1071.1">go</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1072.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1073.1">()</span></span><span class="koboSpan" id="kobo.1074.1"> {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1075.1">defer</span></span><span class="koboSpan" id="kobo.1076.1"> wg.Done()
            time.Sleep(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1077.1">4</span></span><span class="koboSpan" id="kobo.1078.1"> * time.Second)
        }()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1079.1">Here, we manually create three goroutines so that the program has relevant data to collect.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.1080.1">// Get actual data</span></span><span class="koboSpan" id="kobo.1081.1">
        metrics.Read(getMetric)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1082.1">if</span></span><span class="koboSpan" id="kobo.1083.1"> getMetric[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1084.1">0</span></span><span class="koboSpan" id="kobo.1085.1">].Value.Kind() == metrics.KindBad {
            fmt.Printf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1086.1">"metric %q no longer supported\n"</span></span><span class="koboSpan" id="kobo.1087.1">, nGo)
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1088.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1089.1">metrics.Read()</span></code><span class="koboSpan" id="kobo.1090.1"> function </span><a id="_idIndexMarker1129"/><span class="koboSpan" id="kobo.1091.1">collects the desired metrics based </span><a id="_idIndexMarker1130"/><span class="koboSpan" id="kobo.1092.1">on the data in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1093.1">getMetric</span></code><span class="koboSpan" id="kobo.1094.1"> slice.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1095.1">        mVal := getMetric[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1096.1">0</span></span><span class="koboSpan" id="kobo.1097.1">].Value.Uint64()
        fmt.Printf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1098.1">"Number of goroutines: %d\n"</span></span><span class="koboSpan" id="kobo.1099.1">, mVal)
    }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1100.1">After reading the desired metric, we convert it into a numeric value (unsigned </span><code class="inlineCode"><span class="koboSpan" id="kobo.1101.1">int64</span></code><span class="koboSpan" id="kobo.1102.1"> here) in order to use it in our program.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1103.1">    wg.Wait()
    metrics.Read(getMetric)
    mVal := getMetric[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1104.1">0</span></span><span class="koboSpan" id="kobo.1105.1">].Value.Uint64()
    fmt.Printf(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1106.1">"Before exiting: %d\n"</span></span><span class="koboSpan" id="kobo.1107.1">, mVal)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1108.1">The last lines of the code verify that, after all goroutines have finished, the value of the metric is going to be </span><code class="inlineCode"><span class="koboSpan" id="kobo.1109.1">1</span></code><span class="koboSpan" id="kobo.1110.1">, which is the goroutine used for running the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1111.1">main()</span></code><span class="koboSpan" id="kobo.1112.1"> function.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1113.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1114.1">metrics.go</span></code><span class="koboSpan" id="kobo.1115.1"> produces the next output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1116.1">$ </span></span><span class="koboSpan" id="kobo.1117.1">go run metrics.go
Number of goroutines: 2
Number of goroutines: 3
Number of goroutines: 4
Before exiting: 1
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1118.1">We have created three goroutines and we already have a goroutine for running the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1119.1">main()</span></code><span class="koboSpan" id="kobo.1120.1"> function. </span><span class="koboSpan" id="kobo.1120.2">Therefore, the maximum number of goroutines is indeed four.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1121.1">The following subsection </span><a id="_idIndexMarker1131"/><span class="koboSpan" id="kobo.1122.1">presents a technique for measuring</span><a id="_idIndexMarker1132"/><span class="koboSpan" id="kobo.1123.1"> the execution time of a Go function, which is not something that is directly supported by Go.</span></p>
<h2 class="heading-2" id="_idParaDest-372"><span class="koboSpan" id="kobo.1124.1">Measuring the execution time of a function</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1125.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1126.1">runtime/metrics</span></code><span class="koboSpan" id="kobo.1127.1"> package </span><a id="_idIndexMarker1133"/><span class="koboSpan" id="kobo.1128.1">provides a list</span><a id="_idIndexMarker1134"/><span class="koboSpan" id="kobo.1129.1"> of metrics that you can find on the help page of the package. </span><span class="koboSpan" id="kobo.1129.2">However, there are times when we want to measure the time of a specific operation, which is a request not supported by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1130.1">runtime/metrics</span></code><span class="koboSpan" id="kobo.1131.1"> package. </span><span class="koboSpan" id="kobo.1131.2">In our example, we are going to do exactly that and store the information in a log entry.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1132.1">In this example, we are going to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1133.1">log/slog</span></code><span class="koboSpan" id="kobo.1134.1"> package of the standard library. </span><span class="koboSpan" id="kobo.1134.2">You can use any logging package you want as long as it is simple and readable, but most importantly, as long as it is efficient and does not introduce extra load to the system.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1135.1">The code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1136.1">functionTime.go</span></code><span class="koboSpan" id="kobo.1137.1"> is presented in two parts. </span><span class="koboSpan" id="kobo.1137.2">The first part is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1138.1">package</span></span><span class="koboSpan" id="kobo.1139.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1140.1">import</span></span><span class="koboSpan" id="kobo.1141.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1142.1">"log/slog"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1143.1">"os"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1144.1">"time"</span></span><span class="koboSpan" id="kobo.1145.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1146.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1147.1">myFunction</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1148.1">()</span></span><span class="koboSpan" id="kobo.1149.1"> {
    j := </span><span class="hljs-number"><span class="koboSpan" id="kobo.1150.1">0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1151.1">for</span></span><span class="koboSpan" id="kobo.1152.1"> i := </span><span class="hljs-number"><span class="koboSpan" id="kobo.1153.1">1</span></span><span class="koboSpan" id="kobo.1154.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1155.1">100000000</span></span><span class="koboSpan" id="kobo.1156.1">; i++ {
        j = j % i
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1157.1">This is where we define the function that we want to measure—this can be any function or operation you want.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1158.1">The second part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1159.1">functionTime.go</span></code><span class="koboSpan" id="kobo.1160.1"> comes with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1161.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1162.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1163.1">()</span></span><span class="koboSpan" id="kobo.1164.1"> {
    handler := slog.NewTextHandler(os.Stdout, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1165.1">nil</span></span><span class="koboSpan" id="kobo.1166.1">)
    logger := slog.New(handler)
    logger.Debug(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1167.1">"This is a DEBUG message"</span></span><span class="koboSpan" id="kobo.1168.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1169.1">for</span></span><span class="koboSpan" id="kobo.1170.1"> i := </span><span class="hljs-number"><span class="koboSpan" id="kobo.1171.1">0</span></span><span class="koboSpan" id="kobo.1172.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1173.1">5</span></span><span class="koboSpan" id="kobo.1174.1">; i++ {
        now := time.Now()
        myFunction()
        elapsed := time.Since(now)
        logger.Info(
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.1175.1">"Observability"</span></span><span class="koboSpan" id="kobo.1176.1">,
            slog.Int64(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1177.1">"time_taken"</span></span><span class="koboSpan" id="kobo.1178.1">, </span><span class="hljs-type"><span class="koboSpan" id="kobo.1179.1">int64</span></span><span class="koboSpan" id="kobo.1180.1">(elapsed)),
        )
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1181.1">The use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1182.1">time.Now()</span></code><span class="koboSpan" id="kobo.1183.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1184.1">time.Since()</span></code><span class="koboSpan" id="kobo.1185.1"> calls that surround the execution of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1186.1">myFunction()</span></code><span class="koboSpan" id="kobo.1187.1"> is how</span><a id="_idIndexMarker1135"/><span class="koboSpan" id="kobo.1188.1"> we measure the execution</span><a id="_idIndexMarker1136"/><span class="koboSpan" id="kobo.1189.1"> time of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1190.1">myFunction()</span></code><span class="koboSpan" id="kobo.1191.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1192.1">Remember that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1193.1">time.Duration</span></code><span class="koboSpan" id="kobo.1194.1"> data type holds nanoseconds and is, in reality, an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1195.1">int64</span></code><span class="koboSpan" id="kobo.1196.1"> value, hence the use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1197.1">slog.Int64()</span></code><span class="koboSpan" id="kobo.1198.1"> as well as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1199.1">int64(elapsed)</span></code><span class="koboSpan" id="kobo.1200.1"> cast for converting the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1201.1">time.Duration</span></code><span class="koboSpan" id="kobo.1202.1"> value into an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1203.1">int64</span></code><span class="koboSpan" id="kobo.1204.1"> one.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1205.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1206.1">functionTime.go</span></code><span class="koboSpan" id="kobo.1207.1"> generates the following kind of output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1208.1">$ </span></span><span class="koboSpan" id="kobo.1209.1">go run functionTime.go
time=2023-12-30T11:33:36.471+02:00 level=INFO msg=Observability time_taken=51243083
time=2023-12-30T11:33:36.505+02:00 level=INFO msg=Observability time_taken=34088708
time=2023-12-30T11:33:36.536+02:00 level=INFO msg=Observability time_taken=31203083
time=2023-12-30T11:33:36.568+02:00 level=INFO msg=Observability time_taken=31224625
time=2023-12-30T11:33:36.599+02:00 level=INFO msg=Observability time_taken=31206208
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1210.1">Keep in mind that on a busy system, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1211.1">time_taken</span></code><span class="koboSpan" id="kobo.1212.1"> values are not going to be so similar because </span><a id="_idIndexMarker1137"/><span class="koboSpan" id="kobo.1213.1">of the OS scheduler as well as the</span><a id="_idIndexMarker1138"/><span class="koboSpan" id="kobo.1214.1"> Go scheduler operations.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1215.1">The next subsection is a handy introduction to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1216.1">expvar</span></code><span class="koboSpan" id="kobo.1217.1"> package.</span></p>
<h2 class="heading-2" id="_idParaDest-373"><span class="koboSpan" id="kobo.1218.1">The expvar package</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1219.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1220.1">expvar</span></code><span class="koboSpan" id="kobo.1221.1"> package </span><a id="_idIndexMarker1139"/><span class="koboSpan" id="kobo.1222.1">allows you to expose variables and functions to </span><a id="_idIndexMarker1140"/><span class="koboSpan" id="kobo.1223.1">servers, which includes custom metrics. </span><span class="koboSpan" id="kobo.1223.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1224.1">expvar</span></code><span class="koboSpan" id="kobo.1225.1"> package exposes these variables via HTTP at </span><code class="inlineCode"><span class="koboSpan" id="kobo.1226.1">/debug/vars</span></code><span class="koboSpan" id="kobo.1227.1"> in JSON format.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1228.1">The code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1229.1">expvarUse.go</span></code><span class="koboSpan" id="kobo.1230.1"> is presented in two parts. </span><span class="koboSpan" id="kobo.1230.2">The first part is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1231.1">package</span></span><span class="koboSpan" id="kobo.1232.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1233.1">import</span></span><span class="koboSpan" id="kobo.1234.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1235.1">"expvar"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1236.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1237.1">"net/http"</span></span><span class="koboSpan" id="kobo.1238.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1239.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1240.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1241.1">()</span></span><span class="koboSpan" id="kobo.1242.1"> {
    intVar := expvar.NewInt(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1243.1">"intVar"</span></span><span class="koboSpan" id="kobo.1244.1">)
    intVar.Set(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1245.1">1234</span></span><span class="koboSpan" id="kobo.1246.1">)
    expvar.Publish(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1247.1">"customFunction"</span></span><span class="koboSpan" id="kobo.1248.1">, expvar.Func(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1249.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1250.1">()</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1251.1">interface</span></span><span class="koboSpan" id="kobo.1252.1">{} {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1253.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1254.1">"Hi from Mastering Go!"</span></span><span class="koboSpan" id="kobo.1255.1">
    }))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1256.1">The previous code does two things. </span><span class="koboSpan" id="kobo.1256.2">First, it registers an integer variable named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1257.1">intVar</span></code><span class="koboSpan" id="kobo.1258.1"> to be exposed and, second, it registers a function named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1259.1">customFunction</span></code><span class="koboSpan" id="kobo.1260.1"> to be exposed using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1261.1">expvar.NewInt()</span></code><span class="koboSpan" id="kobo.1262.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1263.1">expvar.Publish()</span></code><span class="koboSpan" id="kobo.1264.1">, respectively. </span><span class="koboSpan" id="kobo.1264.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1265.1">Publish()</span></code><span class="koboSpan" id="kobo.1266.1"> function takes two arguments in its signature, which are the name of the variable that the function is going to expose and the function that we want to expose. </span><span class="koboSpan" id="kobo.1266.2">In this case, we use an anonymous function that is implemented inline.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1267.1">The second part of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1268.1">expvarUse.go</span></code><span class="koboSpan" id="kobo.1269.1"> is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1270.1">    http.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1271.1">"/debug/expvars"</span></span><span class="koboSpan" id="kobo.1272.1">, expvar.Handler())
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1273.1">go</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1274.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1275.1">()</span></span><span class="koboSpan" id="kobo.1276.1"> {
        fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1277.1">"HTTP server listening on :8080"</span></span><span class="koboSpan" id="kobo.1278.1">)
        err := http.ListenAndServe(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1279.1">":8080"</span></span><span class="koboSpan" id="kobo.1280.1">, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1281.1">nil</span></span><span class="koboSpan" id="kobo.1282.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1283.1">if</span></span><span class="koboSpan" id="kobo.1284.1"> err != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1285.1">nil</span></span><span class="koboSpan" id="kobo.1286.1"> {
            fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1287.1">"Error starting HTTP server:"</span></span><span class="koboSpan" id="kobo.1288.1">, err)
        }
    }()
    intVar.Add(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1289.1">10</span></span><span class="koboSpan" id="kobo.1290.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1291.1">select</span></span><span class="koboSpan" id="kobo.1292.1"> {}
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1293.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1294.1">http.Handle()</span></code><span class="koboSpan" id="kobo.1295.1"> function allows us to install an additional handler in a non-standard location, which, in this case, is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1296.1">/debug/expvars</span></code><span class="koboSpan" id="kobo.1297.1">. </span><span class="koboSpan" id="kobo.1297.2">So, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1298.1">/debug/expvars</span></code><span class="koboSpan" id="kobo.1299.1"> path to also access the registered variable and function, we start the HTTP server that listens on port number </span><code class="inlineCode"><span class="koboSpan" id="kobo.1300.1">8080</span></code><span class="koboSpan" id="kobo.1301.1">, we modify </span><code class="inlineCode"><span class="koboSpan" id="kobo.1302.1">intVar</span></code><span class="koboSpan" id="kobo.1303.1"> using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1304.1">intVar.Add()</span></code><span class="koboSpan" id="kobo.1305.1">, and we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1306.1">select {}</span></code><span class="koboSpan" id="kobo.1307.1"> to prevent the program from terminating because it blocks the program.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1308.1">In this case, we mimic the application logic, which we should replace with our own logic, by updating the value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1309.1">intVar</span></code><span class="koboSpan" id="kobo.1310.1"> manually using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1311.1">intVar.Add(10)</span></code><span class="koboSpan" id="kobo.1312.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1313.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1314.1">expvarUse.go</span></code><span class="koboSpan" id="kobo.1315.1"> is not going to produce any output but it is going to start the HTTP server. </span><span class="koboSpan" id="kobo.1315.2">We can access the exposed variable and function by visiting </span><code class="inlineCode"><span class="koboSpan" id="kobo.1316.1">http://localhost:8080/debug/vars</span></code><span class="koboSpan" id="kobo.1317.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1318.1">http://localhost:8080/debug/expvars</span></code><span class="koboSpan" id="kobo.1319.1"> in a web browser or </span><a id="_idIndexMarker1141"/><span class="koboSpan" id="kobo.1320.1">by </span><a id="_idIndexMarker1142"/><span class="koboSpan" id="kobo.1321.1">making an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.1322.1">GET</span></code><span class="koboSpan" id="kobo.1323.1"> request using a tool such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1324.1">curl(1)</span></code><span class="koboSpan" id="kobo.1325.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1326.1">wget(1)</span></code><span class="koboSpan" id="kobo.1327.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1328.1">In our case, we are going to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1329.1">curl(1)</span></code><span class="koboSpan" id="kobo.1330.1"> and we are going to get the following kind of output (some output is omitted for brevity):</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1331.1">$ </span></span><span class="koboSpan" id="kobo.1332.1">curl -X GET http://localhost:8080/debug/expvars
{
"cmdline": ["/var/folders/sk/ltk8cnw50lzdtr2hxcj5sv2m0000gn/T/go-build4228023601/b001/exe/expvarUse"],
"customFunction": "Hi from Mastering Go!",
"intVar": 1244,
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1333.1">The next subsection </span><a id="_idIndexMarker1143"/><span class="koboSpan" id="kobo.1334.1">covers learning about the CPU of a machine and its characteristics.</span></p>
<h2 class="heading-2" id="_idParaDest-374"><span class="koboSpan" id="kobo.1335.1">Learning about CPU characteristics</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1336.1">There are times</span><a id="_idIndexMarker1144"/><span class="koboSpan" id="kobo.1337.1"> when we need to learn about the details of the </span><a id="_idIndexMarker1145"/><span class="koboSpan" id="kobo.1338.1">CPU at runtime and maybe expose them in order to collect the relevant metrics. </span><span class="koboSpan" id="kobo.1338.2">For such times, the </span><a href="https://github.com/klauspost/cpuid"><span class="url"><span class="koboSpan" id="kobo.1339.1">https://github.com/klauspost/cpuid</span></span></a><span class="koboSpan" id="kobo.1340.1"> package can really come in handy.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1341.1">We are going to put all relevant code inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.1342.1">~/go/src/github.com/mactsouk/mGo4th/ch13/cpuid</span></code><span class="koboSpan" id="kobo.1343.1"> because we are going to utilize an external package.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1344.1">The Go code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1345.1">cpuid.go</span></code><span class="koboSpan" id="kobo.1346.1"> is the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1347.1">package</span></span><span class="koboSpan" id="kobo.1348.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1349.1">import</span></span><span class="koboSpan" id="kobo.1350.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1351.1">"fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1352.1">"strings"</span></span><span class="koboSpan" id="kobo.1353.1">
    . </span><span class="hljs-string"><span class="koboSpan" id="kobo.1354.1">"github.com/klauspost/cpuid/v2"</span></span><span class="koboSpan" id="kobo.1355.1">
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1356.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1357.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1358.1">()</span></span><span class="koboSpan" id="kobo.1359.1"> {
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1360.1">// Print basic CPU information:</span></span><span class="koboSpan" id="kobo.1361.1">
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1362.1">"Name:"</span></span><span class="koboSpan" id="kobo.1363.1">, CPU.BrandName)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1364.1">"PhysicalCores:"</span></span><span class="koboSpan" id="kobo.1365.1">, CPU.PhysicalCores)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1366.1">"LogicalCores:"</span></span><span class="koboSpan" id="kobo.1367.1">, CPU.LogicalCores)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1368.1">"ThreadsPerCore:"</span></span><span class="koboSpan" id="kobo.1369.1">, CPU.ThreadsPerCore)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1370.1">"Family"</span></span><span class="koboSpan" id="kobo.1371.1">, CPU.Family, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1372.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1373.1">Model:"</span></span><span class="koboSpan" id="kobo.1374.1">, CPU.Model, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1375.1">"Vendor ID:"</span></span><span class="koboSpan" id="kobo.1376.1">, CPU.VendorID)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1377.1">"Features:"</span></span><span class="koboSpan" id="kobo.1378.1">, strings.Join(CPU.FeatureSet(), </span><span class="hljs-string"><span class="koboSpan" id="kobo.1379.1">","</span></span><span class="koboSpan" id="kobo.1380.1">))
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1381.1">"Cacheline bytes:"</span></span><span class="koboSpan" id="kobo.1382.1">, CPU.CacheLine)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1383.1">"L1 Data Cache:"</span></span><span class="koboSpan" id="kobo.1384.1">, CPU.Cache.L1D, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1385.1">"bytes"</span></span><span class="koboSpan" id="kobo.1386.1">)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1387.1">"L1 Instruction Cache:"</span></span><span class="koboSpan" id="kobo.1388.1">, CPU.Cache.L1I, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1389.1">"bytes"</span></span><span class="koboSpan" id="kobo.1390.1">)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1391.1">"L2 Cache:"</span></span><span class="koboSpan" id="kobo.1392.1">, CPU.Cache.L2, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1393.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1394.1">bytes"</span></span><span class="koboSpan" id="kobo.1395.1">)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1396.1">"L3 Cache:"</span></span><span class="koboSpan" id="kobo.1397.1">, CPU.Cache.L3, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1398.1">"bytes"</span></span><span class="koboSpan" id="kobo.1399.1">)
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1400.1">"Frequency"</span></span><span class="koboSpan" id="kobo.1401.1">, CPU.Hz, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1402.1">"hz"</span></span><span class="koboSpan" id="kobo.1403.1">)
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1404.1">The code is standard, and you should not need to make any changes to it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1405.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1406.1">cpuid.go</span></code><span class="koboSpan" id="kobo.1407.1"> on my macOS machine with a M1 Max CPU produces the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1408.1">Name: Apple M1 Max
PhysicalCores: 10
LogicalCores: 10
ThreadsPerCore: 1
Family 458787763 Model: 0 Vendor ID: VendorUnknown
Features: AESARM,ASIMD,ASIMDDP,ASIMDHP,ASIMDRDM,ATOMICS,CRC32,DCPOP,FCMA,FP,FPHP,GPA,JSCVT,LRCPC,PMULL,SHA1,SHA2,SHA3,SHA512
Cacheline bytes: 128
L1 Data Cache: 65536 bytes
L1 Instruction Cache: 131072 bytes
L2 Cache: 4194304 bytes
L3 Cache: -1 bytes
Frequency 0 hz
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1409.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1410.1">cpuid.go</span></code><span class="koboSpan" id="kobo.1411.1"> on a </span><a id="_idIndexMarker1146"/><span class="koboSpan" id="kobo.1412.1">Linux machine with an Intel i7 processor </span><a id="_idIndexMarker1147"/><span class="koboSpan" id="kobo.1413.1">produces the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1414.1">Name: Intel(R) Core(TM) i7-10510U CPU @ 1.80GHz
PhysicalCores: 4
LogicalCores: 8
ThreadsPerCore: 2
Family 6 Model: 142 Vendor ID: Intel
Features: ADX,AESNI,AVX,AVX2,BMI1,BMI2,CLMUL,CMOV,CMPXCHG8,CX16,ERMS,F16C,FLUSH_L1D,FMA3,FXSR,FXSROPT,HTT,IA32_ARCH_CAP,IBPB,LAHF,LZCNT,MD_CLEAR,MMX,MOVBE,MPX,NX,OSXSAVE,POPCNT,RDRAND,RDSEED,RDTSCP,SGX,SPEC_CTRL_SSBD,SSE,SSE2,SSE3,SSE4,SSE42,SSSE3,STIBP,SYSCALL,SYSEE,VMX,X87,XGETBV1,XSAVE,XSAVEC,XSAVEOPT,XSAVES
Cacheline bytes: 64
L1 Data Cache: 32768 bytes
L1 Instruction Cache: 32768 bytes
L2 Cache: 262144 bytes
L3 Cache: 8388608 bytes
Frequency 2300000000 hz
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1415.1">By comparing the outputs, we can see that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1416.1">cpuid</span></code><span class="koboSpan" id="kobo.1417.1"> works better on the Linux machine with the Intel CPU as it displays the frequency of the CPU, which is not the case for the MacBook </span><a id="_idIndexMarker1148"/><span class="koboSpan" id="kobo.1418.1">Pro </span><a id="_idIndexMarker1149"/><span class="koboSpan" id="kobo.1419.1">machine.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1420.1">The next section is about how to expose metrics to Prometheus and how to plot the metrics in Grafana.</span></p>
<h1 class="heading-1" id="_idParaDest-375"><span class="koboSpan" id="kobo.1421.1">Exposing metrics to Prometheus</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1422.1">Imagine that you have an</span><a id="_idIndexMarker1150"/><span class="koboSpan" id="kobo.1423.1"> application that writes files to disk and </span><a id="_idIndexMarker1151"/><span class="koboSpan" id="kobo.1424.1">you want to get metrics for that application to better understand how the writing of multiple files influences the general performance—you need to gather performance data to understand the behavior of your application. </span><span class="koboSpan" id="kobo.1424.2">A good way to store such metrics is by using Prometheus.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1425.1">The list of supported data types for metrics by Prometheus is the following:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1426.1">Counter</span></strong><span class="koboSpan" id="kobo.1427.1">: This is a </span><a id="_idIndexMarker1152"/><span class="koboSpan" id="kobo.1428.1">cumulative value that is used for representing increasing counters—the value of a counter can stay the same, go up, or be reset to zero, but it cannot decrease. </span><span class="koboSpan" id="kobo.1428.2">Counters are usually used for representing cumulative values such as the number of requests served so far, the total number of errors, and so on.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1429.1">Gauge</span></strong><span class="koboSpan" id="kobo.1430.1">: This is a single numerical value that is allowed to increase or decrease. </span><span class="koboSpan" id="kobo.1430.2">Gauges are usually used for representing values that can go up or down such as the number of requests and time durations.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1431.1">Histogram</span></strong><span class="koboSpan" id="kobo.1432.1">: A histogram is used for sampling observations and creating counts and buckets. </span><span class="koboSpan" id="kobo.1432.2">Histograms are usually used for counting request durations, response times, and so on.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1433.1">Summary</span></strong><span class="koboSpan" id="kobo.1434.1">: A summary is like a histogram but can also calculate quantiles over sliding windows that work with times.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1435.1">Both histograms and summaries are useful for performing statistical calculations and properties. </span><span class="koboSpan" id="kobo.1435.2">Usually, a counter or a gauge is all that you need for storing your system metrics.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1436.1">The subsections that follow illustrate how to make any metric you collect available to Prometheus.</span></p>
<h2 class="heading-2" id="_idParaDest-376"><span class="koboSpan" id="kobo.1437.1">Exposing metrics</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1438.1">Collecting metrics is a</span><a id="_idIndexMarker1153"/><span class="koboSpan" id="kobo.1439.1"> totally different task from exposing them for </span><a id="_idIndexMarker1154"/><span class="koboSpan" id="kobo.1440.1">Prometheus to collect them. </span><span class="koboSpan" id="kobo.1440.2">This subsection shows how to make the metrics available to Prometheus for collection. </span><span class="koboSpan" id="kobo.1440.3">For reasons of simplicity, the presented application is going to generate random values.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1441.1">The code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1442.1">samplePro.go</span></code><span class="koboSpan" id="kobo.1443.1"> is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1444.1">package</span></span><span class="koboSpan" id="kobo.1445.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1446.1">import</span></span><span class="koboSpan" id="kobo.1447.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1448.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1449.1">fmt"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1450.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1451.1">"math/rand"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1452.1">"time"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1453.1">"github.com/prometheus/client_golang/prometheus"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1454.1">"github.com/prometheus/client_golang/prometheus/promhttp"</span></span><span class="koboSpan" id="kobo.1455.1">
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1456.1">We need to use two external packages for communicating with Prometheus.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1457.1">var</span></span><span class="koboSpan" id="kobo.1458.1"> PORT = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1459.1">":1234"</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1460.1">var</span></span><span class="koboSpan" id="kobo.1461.1"> counter = prometheus.NewCounter(
    prometheus.CounterOpts{
        Namespace: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1462.1">"mtsouk"</span></span><span class="koboSpan" id="kobo.1463.1">,
        Name:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1464.1">"my_counter"</span></span><span class="koboSpan" id="kobo.1465.1">,
        Help:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1466.1">"This is my counter"</span></span><span class="koboSpan" id="kobo.1467.1">,
    })
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1468.1">Bear in mind that I use global variables here to denote important settings and that is a personal preference and my way of easily finding those settings. </span><span class="koboSpan" id="kobo.1468.2">The same applies for the use of all caps for naming the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1469.1">PORT</span></code><span class="koboSpan" id="kobo.1470.1"> variable.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1471.1">This is how we define a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1472.1">counter</span></code><span class="koboSpan" id="kobo.1473.1"> variable and specify the desired options. </span><span class="koboSpan" id="kobo.1473.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1474.1">Namespace</span></code><span class="koboSpan" id="kobo.1475.1"> field is very important as it allows you to group metrics in sets. </span><span class="koboSpan" id="kobo.1475.2">The name of the first metric is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1476.1">my_counter</span></code><span class="koboSpan" id="kobo.1477.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1478.1">var</span></span><span class="koboSpan" id="kobo.1479.1"> gauge = prometheus.NewGauge(
    prometheus.GaugeOpts{
        Namespace: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1480.1">"mtsouk"</span></span><span class="koboSpan" id="kobo.1481.1">,
        Name:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1482.1">"my_gauge"</span></span><span class="koboSpan" id="kobo.1483.1">,
        Help:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1484.1">"This is my gauge"</span></span><span class="koboSpan" id="kobo.1485.1">,
    })
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1486.1">This is how we define a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1487.1">gauge</span></code><span class="koboSpan" id="kobo.1488.1"> variable and specify the desired options—the name of the metric is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1489.1">my_gauge</span></code><span class="koboSpan" id="kobo.1490.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1491.1">var</span></span><span class="koboSpan" id="kobo.1492.1"> histogram = prometheus.NewHistogram(
    prometheus.HistogramOpts{
        Namespace: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1493.1">"mtsouk"</span></span><span class="koboSpan" id="kobo.1494.1">,
        Name:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1495.1">"my_histogram"</span></span><span class="koboSpan" id="kobo.1496.1">,
        Help:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1497.1">"This is my histogram"</span></span><span class="koboSpan" id="kobo.1498.1">,
    })
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1499.1">This is how we define a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1500.1">histogram</span></code><span class="koboSpan" id="kobo.1501.1"> variable and specify the desired options.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1502.1">var</span></span><span class="koboSpan" id="kobo.1503.1"> summary = prometheus.NewSummary(
    prometheus.SummaryOpts{
        Namespace: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1504.1">"mtsouk"</span></span><span class="koboSpan" id="kobo.1505.1">,
        Name:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1506.1">"my_summary"</span></span><span class="koboSpan" id="kobo.1507.1">,
        Help:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1508.1">"This is my summary"</span></span><span class="koboSpan" id="kobo.1509.1">,
    })
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1510.1">This is how we define a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1511.1">summary</span></code><span class="koboSpan" id="kobo.1512.1"> variable and specify the desired options. </span><span class="koboSpan" id="kobo.1512.2">However, as you are </span><a id="_idIndexMarker1155"/><span class="koboSpan" id="kobo.1513.1">going to see, defining a metric variable is not </span><a id="_idIndexMarker1156"/><span class="koboSpan" id="kobo.1514.1">enough. </span><span class="koboSpan" id="kobo.1514.2">You also need to register it.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1515.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1516.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1517.1">()</span></span><span class="koboSpan" id="kobo.1518.1"> {
    prometheus.MustRegister(counter)
    prometheus.MustRegister(gauge)
    prometheus.MustRegister(histogram)
    prometheus.MustRegister(summary)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1519.1">In these four </span><code class="inlineCode"><span class="koboSpan" id="kobo.1520.1">prometheus.MustRegister()</span></code><span class="koboSpan" id="kobo.1521.1"> statements, you register the four metric variables. </span><span class="koboSpan" id="kobo.1521.2">Now, when Prometheus connects to the server and the namespace, it is going to know about them.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1522.1">go</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1523.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1524.1">()</span></span><span class="koboSpan" id="kobo.1525.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1526.1">for</span></span><span class="koboSpan" id="kobo.1527.1"> {
            counter.Add(rand.Float64() * </span><span class="hljs-number"><span class="koboSpan" id="kobo.1528.1">5</span></span><span class="koboSpan" id="kobo.1529.1">)
            gauge.Add(rand.Float64()*</span><span class="hljs-number"><span class="koboSpan" id="kobo.1530.1">15</span></span><span class="koboSpan" id="kobo.1531.1"> - </span><span class="hljs-number"><span class="koboSpan" id="kobo.1532.1">5</span></span><span class="koboSpan" id="kobo.1533.1">)
            histogram.Observe(rand.Float64() * </span><span class="hljs-number"><span class="koboSpan" id="kobo.1534.1">10</span></span><span class="koboSpan" id="kobo.1535.1">)
            summary.Observe(rand.Float64() * </span><span class="hljs-number"><span class="koboSpan" id="kobo.1536.1">10</span></span><span class="koboSpan" id="kobo.1537.1">)
            time.Sleep(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1538.1">2</span></span><span class="koboSpan" id="kobo.1539.1"> * time.Second)
        }
    }()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1540.1">This goroutine runs for as long as the web server runs with the help of the endless </span><code class="inlineCode"><span class="koboSpan" id="kobo.1541.1">for</span></code><span class="koboSpan" id="kobo.1542.1"> loop. </span><span class="koboSpan" id="kobo.1542.2">In this goroutine, the metrics are updated every 2 seconds due to the use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1543.1">time.Sleep(2 * time.Second)</span></code><span class="koboSpan" id="kobo.1544.1"> statement.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1545.1">    http.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1546.1">"/metrics"</span></span><span class="koboSpan" id="kobo.1547.1">, promhttp.Handler())
    fmt.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1548.1">"Listening to port"</span></span><span class="koboSpan" id="kobo.1549.1">, PORT)
    fmt.Println(http.ListenAndServe(PORT, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1550.1">nil</span></span><span class="koboSpan" id="kobo.1551.1">))
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1552.1">As you already know, each URL is handled by a handler function that you usually implement on your own. </span><span class="koboSpan" id="kobo.1552.2">However, in this case, we are using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1553.1">promhttp.Handler()</span></code><span class="koboSpan" id="kobo.1554.1"> handler function that comes with the </span><a href="https://github.com/prometheus/client_golang/prometheus/promhttp"><span class="url"><span class="koboSpan" id="kobo.1555.1">github.com/prometheus/client_golang/prometheus/promhttp</span></span></a><span class="koboSpan" id="kobo.1556.1"> package—this saves us from having to write our own code. </span><span class="koboSpan" id="kobo.1556.2">However, we still need to register the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1557.1">promhttp.Handler()</span></code><span class="koboSpan" id="kobo.1558.1"> handler function using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1559.1">http.Handle()</span></code><span class="koboSpan" id="kobo.1560.1"> before we start the web server. </span><span class="koboSpan" id="kobo.1560.2">Note that the metrics are found under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1561.1">/metrics</span></code><span class="koboSpan" id="kobo.1562.1"> path—Prometheus knows how to find that.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1563.1">With </span><code class="inlineCode"><span class="koboSpan" id="kobo.1564.1">samplePro.go</span></code><span class="koboSpan" id="kobo.1565.1"> running, getting </span><a id="_idIndexMarker1157"/><span class="koboSpan" id="kobo.1566.1">the list of metrics that belong to </span><a id="_idIndexMarker1158"/><span class="koboSpan" id="kobo.1567.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1568.1">mtsouk</span></code><span class="koboSpan" id="kobo.1569.1"> namespace is as simple as running the next </span><code class="inlineCode"><span class="koboSpan" id="kobo.1570.1">curl(1)</span></code><span class="koboSpan" id="kobo.1571.1"> command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1572.1">$ </span></span><span class="koboSpan" id="kobo.1573.1">curl localhost:1234/metrics --silent | grep mtsouk
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1574.1"># </span></span><span class="koboSpan" id="kobo.1575.1">HELP mtsouk_my_counter This is my counter
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1576.1"># </span></span><span class="koboSpan" id="kobo.1577.1">TYPE mtsouk_my_counter counter
mtsouk_my_counter 19.948239343027772
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1578.1">This is the output from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1579.1">counter</span></code><span class="koboSpan" id="kobo.1580.1"> variable. </span><span class="koboSpan" id="kobo.1580.2">If the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1581.1">| grep mtsouk</span></code><span class="koboSpan" id="kobo.1582.1"> part is omitted, then you are going to get the list of all available metrics.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1583.1"># </span></span><span class="koboSpan" id="kobo.1584.1">HELP mtsouk_my_gauge This is my gauge
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1585.1"># </span></span><span class="koboSpan" id="kobo.1586.1">TYPE mtsouk_my_gauge gauge
mtsouk_my_gauge 29.335329668135287
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1587.1">This is the output from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1588.1">gauge</span></code><span class="koboSpan" id="kobo.1589.1"> variable.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1590.1"># </span></span><span class="koboSpan" id="kobo.1591.1">HELP mtsouk_my_histogram This is my histogram
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1592.1"># </span></span><span class="koboSpan" id="kobo.1593.1">TYPE mtsouk_my_histogram histogram
mtsouk_my_histogram_bucket{le="0.005"} 0
mtsouk_my_histogram_bucket{le="0.01"} 0
mtsouk_my_histogram_bucket{le="0.025"} 0
. </span><span class="koboSpan" id="kobo.1593.2">. </span><span class="koboSpan" id="kobo.1593.3">.
</span><span class="koboSpan" id="kobo.1593.4">mtsouk_my_histogram_bucket{le="5"} 4
mtsouk_my_histogram_bucket{le="10"} 9
mtsouk_my_histogram_bucket{le="+Inf"} 9
mtsouk_my_histogram_sum 44.52262035556937
mtsouk_my_histogram_count 9
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1594.1">This is the output from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1595.1">histogram</span></code><span class="koboSpan" id="kobo.1596.1"> variable. </span><span class="koboSpan" id="kobo.1596.2">Histograms contain buckets, hence the large number of output lines.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1597.1"># </span></span><span class="koboSpan" id="kobo.1598.1">HELP mtsouk_my_summary This is my summary
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1599.1"># </span></span><span class="koboSpan" id="kobo.1600.1">TYPE mtsouk_my_summary summary
mtsouk_my_summary_sum 19.407554729772105
mtsouk_my_summary_count 9
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1601.1">The last lines of the output are for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1602.1">summary</span></code><span class="koboSpan" id="kobo.1603.1"> data type.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1604.1">So, the metrics are there and ready to be pulled by Prometheus—in practice, this means that every production Go application can export metrics that can be used for measuring its performance and</span><a id="_idIndexMarker1159"/><span class="koboSpan" id="kobo.1605.1"> discovering its bottlenecks. </span><span class="koboSpan" id="kobo.1605.2">However, we are not</span><a id="_idIndexMarker1160"/><span class="koboSpan" id="kobo.1606.1"> done yet as we need to learn about building Docker images for Go applications.</span></p>
<h2 class="heading-2" id="_idParaDest-377"><span class="koboSpan" id="kobo.1607.1">Creating a Docker image for a Go server</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1608.1">This subsection </span><a id="_idIndexMarker1161"/><span class="koboSpan" id="kobo.1609.1">shows how to create a Docker </span><a id="_idIndexMarker1162"/><span class="koboSpan" id="kobo.1610.1">image for a Go application. </span><span class="koboSpan" id="kobo.1610.2">The main </span><a id="_idIndexMarker1163"/><span class="koboSpan" id="kobo.1611.1">benefit you get from this is that you can deploy it in a Docker environment without worrying about compiling it and having the required resources—everything is included in the Docker image.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1612.1">Still, you might ask, “Why not use a normal Go binary instead of a Docker image?” </span><span class="koboSpan" id="kobo.1612.2">The answer is simple: Docker images can be put in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1613.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1614.1"> files and can be deployed using Kubernetes. </span><span class="koboSpan" id="kobo.1614.2">The same is not true for Go binaries. </span><span class="koboSpan" id="kobo.1614.3">Additionally, Docker images can provide consistent shared libraries when this is needed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1615.1">When creating a new Docker image, you usually start with a base Docker image that already includes Go and create the desired binary in there. </span><span class="koboSpan" id="kobo.1615.2">The key point here is that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1616.1">samplePro.go</span></code><span class="koboSpan" id="kobo.1617.1"> uses an external package that should be downloaded in the Docker image before building the executable binary.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1618.1">The process must start with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1619.1">go mod init</span></code><span class="koboSpan" id="kobo.1620.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1621.1">go mod tidy</span></code><span class="koboSpan" id="kobo.1622.1">. </span><span class="koboSpan" id="kobo.1622.2">The contents of the relevant Docker file, which is named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1623.1">dFilev2</span></code><span class="koboSpan" id="kobo.1624.1">, are as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1625.1">FROM</span></span><span class="koboSpan" id="kobo.1626.1"> golang:alpine AS builder
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1627.1">RUN</span></span><span class="koboSpan" id="kobo.1628.1"> apk update &amp;&amp; apk add --no-cache git
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1629.1">As </span><code class="inlineCode"><span class="koboSpan" id="kobo.1630.1">golang:alpine</span></code><span class="koboSpan" id="kobo.1631.1"> uses the latest Go version, which does not come with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1632.1">git</span></code><span class="koboSpan" id="kobo.1633.1">, we install </span><code class="inlineCode"><span class="koboSpan" id="kobo.1634.1">git</span></code><span class="koboSpan" id="kobo.1635.1"> manually.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1636.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1637.1">mkdir</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.1638.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1639.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1640.1">ADD</span></span><span class="koboSpan" id="kobo.1641.1"> ./samplePro.go </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1642.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1643.1">/src/server
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1644.1">If you want to use Go modules, you should put your code in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1645.1">$GOPATH/src</span></code><span class="koboSpan" id="kobo.1646.1">, which is what we do here.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1647.1">WORKDIR</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.1648.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1649.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1650.1">RUN</span></span><span class="koboSpan" id="kobo.1651.1"> go mod init
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1652.1">RUN</span></span><span class="koboSpan" id="kobo.1653.1"> go mod tidy
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1654.1">RUN</span></span><span class="koboSpan" id="kobo.1655.1"> go mod download
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1656.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1657.1">mkdir</span></span><span class="koboSpan" id="kobo.1658.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1659.1">RUN</span></span><span class="koboSpan" id="kobo.1660.1"> go build -o /pro/server samplePro.go
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1661.1">We download the required dependencies using various </span><code class="inlineCode"><span class="koboSpan" id="kobo.1662.1">go mod</span></code><span class="koboSpan" id="kobo.1663.1"> commands. </span><span class="koboSpan" id="kobo.1663.2">The building of the binary</span><a id="_idIndexMarker1164"/><span class="koboSpan" id="kobo.1664.1"> file</span><a id="_idIndexMarker1165"/><span class="koboSpan" id="kobo.1665.1"> is</span><a id="_idIndexMarker1166"/><span class="koboSpan" id="kobo.1666.1"> the same as before.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1667.1">FROM</span></span><span class="koboSpan" id="kobo.1668.1"> alpine:latest
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1669.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1670.1">mkdir</span></span><span class="koboSpan" id="kobo.1671.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1672.1">COPY</span></span><span class="koboSpan" id="kobo.1673.1"> --from=builder /pro/server /pro/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1674.1">EXPOSE</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.1675.1">1234</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1676.1">WORKDIR</span></span><span class="koboSpan" id="kobo.1677.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1678.1">CMD</span></span><span class="koboSpan" id="kobo.1679.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.1680.1">"/pro/server"</span></span><span class="koboSpan" id="kobo.1681.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1682.1">In this second stage, we put the binary file into the desired location </span><code class="inlineCode"><span class="koboSpan" id="kobo.1683.1">(/pro</span></code><span class="koboSpan" id="kobo.1684.1">) and expose the desired port, which, in this case, is port number </span><code class="inlineCode"><span class="koboSpan" id="kobo.1685.1">1234</span></code><span class="koboSpan" id="kobo.1686.1">. </span><span class="koboSpan" id="kobo.1686.2">The port number depends on the code in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1687.1">samplePro.go</span></code><span class="koboSpan" id="kobo.1688.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1689.1">The previous process is a </span><strong class="bold-italic" style="font-style: italic;"><span class="koboSpan" id="kobo.1690.1">two-step process that makes the final Docker image smaller in size</span></strong><span class="koboSpan" id="kobo.1691.1">, hence the use of the second </span><code class="inlineCode"><span class="koboSpan" id="kobo.1692.1">FROM</span></code><span class="koboSpan" id="kobo.1693.1"> command with a Docker image that does not include the Go tools and is just used for running the generated Go binary.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1694.1">Building a Docker image using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1695.1">dFilev2</span></code><span class="koboSpan" id="kobo.1696.1"> is as simple as running the next command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1697.1">$ </span></span><span class="koboSpan" id="kobo.1698.1">docker build -f dFilev2 -t go-app122 .
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1699.1">Although previous versions of Docker used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1700.1">docker build</span></code><span class="koboSpan" id="kobo.1701.1"> command for building images, recent versions of Docker also support the use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1702.1">buildx</span></code><span class="koboSpan" id="kobo.1703.1"> for the same task. </span><span class="koboSpan" id="kobo.1703.2">You might need to install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1704.1">buildkit</span></code><span class="koboSpan" id="kobo.1705.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1706.1">docker-buildx</span></code><span class="koboSpan" id="kobo.1707.1"> packages to enable the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1708.1">buildx</span></code><span class="koboSpan" id="kobo.1709.1"> command.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1710.1">So, if you want to go the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1711.1">docker buildx</span></code><span class="koboSpan" id="kobo.1712.1"> way, you should execute the following command instead:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1713.1">$ </span></span><span class="koboSpan" id="kobo.1714.1">docker buildx build -f dFilev2 -t go-app122 .
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1715.1">The results from both </span><code class="inlineCode"><span class="koboSpan" id="kobo.1716.1">docker build</span></code><span class="koboSpan" id="kobo.1717.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1718.1">docker buildx</span></code><span class="koboSpan" id="kobo.1719.1"> are exactly the same.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1720.1">Once the Docker image has been successfully created, there is no difference in the way you should use it in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1721.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1722.1"> file—a relevant entry in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1723.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1724.1"> file would look as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-attr"><span class="koboSpan" id="kobo.1725.1">goapp:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1726.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1727.1">go-app122</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1728.1">container_name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1729.1">goapp-int</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1730.1">restart:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1731.1">always</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1732.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.1733.1">-</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.1734.1">1234</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1735.1">:1234</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1736.1">networks:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.1737.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1738.1">monitoring</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1739.1">The name of the Docker image is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1740.1">go-app122</span></code><span class="koboSpan" id="kobo.1741.1">, whereas the internal name of the container would be </span><code class="inlineCode"><span class="koboSpan" id="kobo.1742.1">goapp-int</span></code><span class="koboSpan" id="kobo.1743.1">. </span><span class="koboSpan" id="kobo.1743.2">So, if a different container from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1744.1">monitoring</span></code><span class="koboSpan" id="kobo.1745.1"> network wants to access that</span><a id="_idIndexMarker1167"/><span class="koboSpan" id="kobo.1746.1"> container, it should </span><a id="_idIndexMarker1168"/><span class="koboSpan" id="kobo.1747.1">use</span><a id="_idIndexMarker1169"/><span class="koboSpan" id="kobo.1748.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1749.1">goapp-int</span></code><span class="koboSpan" id="kobo.1750.1"> hostname. </span><span class="koboSpan" id="kobo.1750.2">Last, the only open port is port number </span><code class="inlineCode"><span class="koboSpan" id="kobo.1751.1">1234</span></code><span class="koboSpan" id="kobo.1752.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1753.1">The next subsection illustrates how you can expose the chosen metrics to Prometheus.</span></p>
<h2 class="heading-2" id="_idParaDest-378"><span class="koboSpan" id="kobo.1754.1">Specifying the metrics to expose</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1755.1">This section illustrates </span><a id="_idIndexMarker1170"/><span class="koboSpan" id="kobo.1756.1">how to expose the desired </span><a id="_idIndexMarker1171"/><span class="koboSpan" id="kobo.1757.1">metrics from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1758.1">runtime/metrics</span></code><span class="koboSpan" id="kobo.1759.1"> package to Prometheus. </span><span class="koboSpan" id="kobo.1759.2">In our case, we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1760.1">/sched/goroutines:goroutines</span></code><span class="koboSpan" id="kobo.1761.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1762.1">/memory/classes/total:bytes</span></code><span class="koboSpan" id="kobo.1763.1">. </span><span class="koboSpan" id="kobo.1763.2">You already know about the former, which is the total number of goroutines. </span><span class="koboSpan" id="kobo.1763.3">The latter metric is the amount of memory mapped by the Go runtime into the current process as read-write.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1764.1">As the presented code uses external packages, it should be put inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.1765.1">~/go/src</span></code><span class="koboSpan" id="kobo.1766.1"> and Go modules should be enabled using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1767.1">go mod init</span></code><span class="koboSpan" id="kobo.1768.1">. </span><span class="koboSpan" id="kobo.1768.2">In our case, the code can be found in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1769.1">ch13/prom/</span></code><span class="koboSpan" id="kobo.1770.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1771.1">The Go code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1772.1">prometheus.go</span></code><span class="koboSpan" id="kobo.1773.1"> is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1774.1">package</span></span><span class="koboSpan" id="kobo.1775.1"> main
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1776.1">import</span></span><span class="koboSpan" id="kobo.1777.1"> (
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1778.1">"log"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1779.1">"math/rand"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1780.1">"net/http"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1781.1">"runtime"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1782.1">"runtime/metrics"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1783.1">"time"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1784.1">"github.com/prometheus/client_golang/prometheus"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1785.1">"github.com/prometheus/client_golang/prometheus/promhttp"</span></span><span class="koboSpan" id="kobo.1786.1">
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1787.1">The first external package is the Go client library for Prometheus and the second package is for </span><a id="_idIndexMarker1172"/><span class="koboSpan" id="kobo.1788.1">using</span><a id="_idIndexMarker1173"/><span class="koboSpan" id="kobo.1789.1"> the default handler function (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1790.1">promhttp.Handler()</span></code><span class="koboSpan" id="kobo.1791.1">).</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1792.1">var</span></span><span class="koboSpan" id="kobo.1793.1"> PORT = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1794.1">":1234"</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1795.1">var</span></span><span class="koboSpan" id="kobo.1796.1"> nGoroutines = prometheus.NewGauge(
    prometheus.GaugeOpts{
        Namespace: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1797.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1798.1">packt"</span></span><span class="koboSpan" id="kobo.1799.1">,
        Name:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1800.1">"n_goroutines"</span></span><span class="koboSpan" id="kobo.1801.1">,
        Help:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1802.1">"Number of goroutines"</span></span><span class="koboSpan" id="kobo.1803.1">})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1804.1">var</span></span><span class="koboSpan" id="kobo.1805.1"> nMemory = prometheus.NewGauge(
    prometheus.GaugeOpts{
        Namespace: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1806.1">"packt"</span></span><span class="koboSpan" id="kobo.1807.1">,
        Name:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1808.1">"n_memory"</span></span><span class="koboSpan" id="kobo.1809.1">,
        Help:      </span><span class="hljs-string"><span class="koboSpan" id="kobo.1810.1">"Memory usage"</span></span><span class="koboSpan" id="kobo.1811.1">})
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1812.1">Here, we define the two Prometheus metrics.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1813.1">func</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1814.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1815.1">()</span></span><span class="koboSpan" id="kobo.1816.1"> {
    prometheus.MustRegister(nGoroutines)
    prometheus.MustRegister(nMemory)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1817.1">const</span></span><span class="koboSpan" id="kobo.1818.1"> nGo = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1819.1">"/sched/goroutines:goroutines"</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1820.1">const</span></span><span class="koboSpan" id="kobo.1821.1"> nMem = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1822.1">"/memory/classes/heap/free:bytes"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1823.1">This is where you register the variables for the metrics in Prometheus and define the metrics you want to read from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1824.1">runtime/metrics</span></code><span class="koboSpan" id="kobo.1825.1"> package.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1826.1">    getMetric := </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1827.1">make</span></span><span class="koboSpan" id="kobo.1828.1">([]metrics.Sample, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1829.1">2</span></span><span class="koboSpan" id="kobo.1830.1">)
    getMetric[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1831.1">0</span></span><span class="koboSpan" id="kobo.1832.1">].Name = nGo
    getMetric[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1833.1">1</span></span><span class="koboSpan" id="kobo.1834.1">].Name = nMem
    http.Handle(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1835.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1836.1">/metrics"</span></span><span class="koboSpan" id="kobo.1837.1">, promhttp.Handler())
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1838.1">This is where you register the handler function for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1839.1">/metrics</span></code><span class="koboSpan" id="kobo.1840.1"> path. </span><span class="koboSpan" id="kobo.1840.2">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1841.1">promhttp.Handler()</span></code><span class="koboSpan" id="kobo.1842.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1843.1">go</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1844.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1845.1">()</span></span><span class="koboSpan" id="kobo.1846.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1847.1">for</span></span><span class="koboSpan" id="kobo.1848.1"> {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1849.1">for</span></span><span class="koboSpan" id="kobo.1850.1"> i := </span><span class="hljs-number"><span class="koboSpan" id="kobo.1851.1">1</span></span><span class="koboSpan" id="kobo.1852.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1853.1">4</span></span><span class="koboSpan" id="kobo.1854.1">; i++ {
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1855.1">go</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1856.1">func</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1857.1">()</span></span><span class="koboSpan" id="kobo.1858.1"> {
                    _ = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1859.1">make</span></span><span class="koboSpan" id="kobo.1860.1">([]</span><span class="hljs-type"><span class="koboSpan" id="kobo.1861.1">int</span></span><span class="koboSpan" id="kobo.1862.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1863.1">1000000</span></span><span class="koboSpan" id="kobo.1864.1">)
                    time.Sleep(time.Duration(rand.Intn(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1865.1">10</span></span><span class="koboSpan" id="kobo.1866.1">)) * time.Second)
                }()
            }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1867.1">Note that such a program should definitely have at least two goroutines: one for running the HTTP server and another one for collecting the metrics. </span><span class="koboSpan" id="kobo.1867.2">Usually, the HTTP server is on the goroutine that runs the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1868.1">main()</span></code><span class="koboSpan" id="kobo.1869.1"> function and the metric collection happens in a user-defined goroutine.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1870.1">The outer </span><code class="inlineCode"><span class="koboSpan" id="kobo.1871.1">for</span></code><span class="koboSpan" id="kobo.1872.1"> loop </span><a id="_idIndexMarker1174"/><span class="koboSpan" id="kobo.1873.1">makes sure that the goroutine </span><a id="_idIndexMarker1175"/><span class="koboSpan" id="kobo.1874.1">runs forever, whereas the inner </span><code class="inlineCode"><span class="koboSpan" id="kobo.1875.1">for</span></code><span class="koboSpan" id="kobo.1876.1"> loop creates additional goroutines so that the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1877.1">/sched/goroutines:goroutines</span></code><span class="koboSpan" id="kobo.1878.1"> metric changes all the time.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1879.1">            runtime.GC()
            metrics.Read(getMetric)
            goVal := getMetric[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1880.1">0</span></span><span class="koboSpan" id="kobo.1881.1">].Value.Uint64()
            memVal := getMetric[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1882.1">1</span></span><span class="koboSpan" id="kobo.1883.1">].Value.Uint64()
            time.Sleep(time.Duration(rand.Intn(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1884.1">15</span></span><span class="koboSpan" id="kobo.1885.1">)) * time.Second)
            </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1886.1">nGoroutines.Set</span></strong></span><span class="koboSpan" id="kobo.1887.1">(</span><span class="hljs-type"><span class="koboSpan" id="kobo.1888.1">float64</span></span><span class="koboSpan" id="kobo.1889.1">(goVal))
            </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1890.1">nMemory.Set</span></strong></span><span class="koboSpan" id="kobo.1891.1">(</span><span class="hljs-type"><span class="koboSpan" id="kobo.1892.1">float64</span></span><span class="koboSpan" id="kobo.1893.1">(memVal))
        }
    }()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1894.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1895.1">runtime.GC()</span></code><span class="koboSpan" id="kobo.1896.1"> function tells the Go garbage collector to run and is called for changing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1897.1">/memory/classes/heap/free:bytes</span></code><span class="koboSpan" id="kobo.1898.1"> metric. </span><span class="koboSpan" id="kobo.1898.2">The two </span><code class="inlineCode"><span class="koboSpan" id="kobo.1899.1">Set()</span></code><span class="koboSpan" id="kobo.1900.1"> calls update the values of the metrics.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1901.1">You can read more about the operation of the Go garbage collector in </span><em class="chapterRef"><span class="koboSpan" id="kobo.1902.1">Appendix A</span></em><span class="koboSpan" id="kobo.1903.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1904.1">Go Garbage Collector</span></em><span class="koboSpan" id="kobo.1905.1">.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1906.1">    log.Println(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1907.1">"Listening to port"</span></span><span class="koboSpan" id="kobo.1908.1">, PORT)
    log.Println(http.ListenAndServe(PORT, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1909.1">nil</span></span><span class="koboSpan" id="kobo.1910.1">))
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1911.1">The last statement runs the web server using the default Go router. </span><span class="koboSpan" id="kobo.1911.2">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1912.1">prometheus.go</span></code><span class="koboSpan" id="kobo.1913.1"> from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1914.1">ch13/prom</span></code><span class="koboSpan" id="kobo.1915.1"> directory requires executing the next commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1916.1">$ </span></span><span class="koboSpan" id="kobo.1917.1">go mod init
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1918.1">$ </span></span><span class="koboSpan" id="kobo.1919.1">go mod tidy
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1920.1">$ </span></span><span class="koboSpan" id="kobo.1921.1">go mod download
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1922.1">$ </span></span><span class="koboSpan" id="kobo.1923.1">go run prometheus.go
2024/01/01 19:18:11 Listening to port :1234
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1924.1">Although </span><code class="inlineCode"><span class="koboSpan" id="kobo.1925.1">prometheus.go</span></code><span class="koboSpan" id="kobo.1926.1"> generates no output apart from the previous line, the next subsection </span><a id="_idIndexMarker1176"/><span class="koboSpan" id="kobo.1927.1">illustrates</span><a id="_idIndexMarker1177"/><span class="koboSpan" id="kobo.1928.1"> how to read the desired metrics from it using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1929.1">curl(1)</span></code><span class="koboSpan" id="kobo.1930.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-379"><span class="koboSpan" id="kobo.1931.1">Getting the metrics</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1932.1">You can get a</span><a id="_idIndexMarker1178"/><span class="koboSpan" id="kobo.1933.1"> list of </span><a id="_idIndexMarker1179"/><span class="koboSpan" id="kobo.1934.1">the available metrics from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1935.1">prometheus.go</span></code><span class="koboSpan" id="kobo.1936.1"> using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1937.1">curl(1)</span></code><span class="koboSpan" id="kobo.1938.1"> in order to make sure that the application works as expected. </span><span class="koboSpan" id="kobo.1938.2">I always test the operation of such an application with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1939.1">curl(1)</span></code><span class="koboSpan" id="kobo.1940.1"> or some other similar utility such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1941.1">wget(1)</span></code><span class="koboSpan" id="kobo.1942.1"> before trying to get the metrics with Prometheus.</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1943.1">$ </span></span><span class="koboSpan" id="kobo.1944.1">curl localhost:1234/metrics --silent | grep packt
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1945.1"># </span></span><span class="koboSpan" id="kobo.1946.1">HELP packt_n_goroutines Number of goroutines
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1947.1"># </span></span><span class="koboSpan" id="kobo.1948.1">TYPE packt_n_goroutines gauge
packt_n_goroutines 6
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1949.1"># </span></span><span class="koboSpan" id="kobo.1950.1">HELP packt_n_memory Memory usage
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1951.1"># </span></span><span class="koboSpan" id="kobo.1952.1">TYPE packt_n_memory gauge
packt_n_memory 4.8799744e+07
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1953.1">The previous command assumes that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1954.1">curl(1)</span></code><span class="koboSpan" id="kobo.1955.1"> is executed on the same machine as the HTTP server and that the server listens to TCP port number </span><code class="inlineCode"><span class="koboSpan" id="kobo.1956.1">1234</span></code><span class="koboSpan" id="kobo.1957.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1958.1">Next, we must enable Prometheus to pull the metrics—it is much easier to run Prometheus from a Docker image. </span><span class="koboSpan" id="kobo.1958.2">The easiest way for a Prometheus Docker image to be able to see the Go application with the metrics is to execute both as Docker images. </span><span class="koboSpan" id="kobo.1958.3">We are going to use the following Dockerfile (which is similar to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1959.1">dFilev2</span></code><span class="koboSpan" id="kobo.1960.1"> used previously) to convert </span><code class="inlineCode"><span class="koboSpan" id="kobo.1961.1">prometheus.go</span></code><span class="koboSpan" id="kobo.1962.1"> into a Docker image:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1963.1">FROM</span></span><span class="koboSpan" id="kobo.1964.1"> golang:alpine AS builder
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1965.1">This is the name of the base Docker image that is used for building the binary. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1966.1">golang:alpine</span></code><span class="koboSpan" id="kobo.1967.1"> always contains the latest Go version as long as you update it regularly.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1968.1">RUN</span></span><span class="koboSpan" id="kobo.1969.1"> apk update &amp;&amp; apk add --no-cache git
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1970.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1971.1">mkdir</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.1972.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1973.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1974.1">ADD</span></span><span class="koboSpan" id="kobo.1975.1"> ./prometheus.go </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1976.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1977.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1978.1">WORKDIR</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.1979.1">$GOPATH</span></span><span class="koboSpan" id="kobo.1980.1">/src/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1981.1">RUN</span></span><span class="koboSpan" id="kobo.1982.1"> go mod init
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1983.1">RUN</span></span><span class="koboSpan" id="kobo.1984.1"> go mod tidy
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1985.1">RUN</span></span><span class="koboSpan" id="kobo.1986.1"> go mod download
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1987.1">The previous commands download the required dependencies before trying to build the binary.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1988.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1989.1">mkdir</span></span><span class="koboSpan" id="kobo.1990.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1991.1">RUN</span></span><span class="koboSpan" id="kobo.1992.1"> go build -o /pro/server prometheus.go
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1993.1">FROM</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1994.1"> alpine:latest</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1995.1">RUN</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1996.1">mkdir</span></span><span class="koboSpan" id="kobo.1997.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1998.1">COPY</span></span><span class="koboSpan" id="kobo.1999.1"> --from=builder /pro/server /pro/server
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2000.1">EXPOSE</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2001.1">1234</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2002.1">WORKDIR</span></span><span class="koboSpan" id="kobo.2003.1"> /pro
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2004.1">CMD</span></span><span class="koboSpan" id="kobo.2005.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.2006.1">"/pro/server"</span></span><span class="koboSpan" id="kobo.2007.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2008.1">Building the</span><a id="_idIndexMarker1180"/><span class="koboSpan" id="kobo.2009.1"> desired </span><a id="_idIndexMarker1181"/><span class="koboSpan" id="kobo.2010.1">Docker image, which is going to be named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2011.1">goapp</span></code><span class="koboSpan" id="kobo.2012.1">, is as simple as running the next command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2013.1">$ </span></span><span class="koboSpan" id="kobo.2014.1">docker build -f Dockerfile -t goapp .
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2015.1">If you prefer to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2016.1">docker buildx</span></code><span class="koboSpan" id="kobo.2017.1">, you should execute the following command instead:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2018.1">$ </span></span><span class="koboSpan" id="kobo.2019.1">docker buildx build -f Dockerfile -t goapp .
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2020.1">As usual, the output of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2021.1">docker images</span></code><span class="koboSpan" id="kobo.2022.1"> verifies the successful creation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2023.1">goapp</span></code><span class="koboSpan" id="kobo.2024.1"> Docker image—in my case, the relevant entry looks as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2025.1">goapp             latest           6f63d9a27185   2 minutes ago   17.8MB
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2026.1">Let us now discuss </span><a id="_idIndexMarker1182"/><span class="koboSpan" id="kobo.2027.1">how to configure Prometheus to pull the </span><a id="_idIndexMarker1183"/><span class="koboSpan" id="kobo.2028.1">desired metrics.</span></p>
<h2 class="heading-2" id="_idParaDest-380"><span class="koboSpan" id="kobo.2029.1">Putting the metrics in Prometheus</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2030.1">To be able to pull the</span><a id="_idIndexMarker1184"/><span class="koboSpan" id="kobo.2031.1"> metrics, Prometheus needs a proper</span><a id="_idIndexMarker1185"/><span class="koboSpan" id="kobo.2032.1"> configuration file that specifies the source of the metrics. </span><span class="koboSpan" id="kobo.2032.2">The configuration file that is going to be used is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.2033.1"># prometheus.yml</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2034.1">scrape_configs:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2035.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.2036.1">job_name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2037.1">GoServer</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2038.1">scrape_interval:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2039.1">5s</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2040.1">static_configs:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2041.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.2042.1">targets:</span></span><span class="koboSpan" id="kobo.2043.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.2044.1">'goapp:1234'</span></span><span class="koboSpan" id="kobo.2045.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2046.1">We tell Prometheus to connect to a host named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2047.1">goapp</span></code><span class="koboSpan" id="kobo.2048.1"> using port number </span><code class="inlineCode"><span class="koboSpan" id="kobo.2049.1">1234</span></code><span class="koboSpan" id="kobo.2050.1">. </span><span class="koboSpan" id="kobo.2050.2">Prometheus pulls data every five seconds, according to the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2051.1">scrape_interval</span></code><span class="koboSpan" id="kobo.2052.1"> field. </span><span class="koboSpan" id="kobo.2052.2">You should put </span><code class="inlineCode"><span class="koboSpan" id="kobo.2053.1">prometheus.yml</span></code><span class="koboSpan" id="kobo.2054.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2055.1">prometheus</span></code><span class="koboSpan" id="kobo.2056.1"> directory, which should be under the same root directory as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2057.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.2058.1"> file that is presented next.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2059.1">Prometheus, as well as Grafana and the Go application, are going to run as Docker containers using the next </span><code class="inlineCode"><span class="koboSpan" id="kobo.2060.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.2061.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.2062.1">version:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2063.1">"3"</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2064.1">services:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2065.1">goapp:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2066.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2067.1">goapp</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2068.1">container_name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2069.1">goapp</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2070.1">restart:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2071.1">always</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2072.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2073.1">-</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2074.1">1234</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2075.1">:1234</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2076.1">networks:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2077.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2078.1">monitoring</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2079.1">This is the part that deals with the Go application that collects the metrics. </span><span class="koboSpan" id="kobo.2079.2">The Docker image name, as well as the internal hostname of the Docker container, is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2080.1">goapp</span></code><span class="koboSpan" id="kobo.2081.1">. </span><span class="koboSpan" id="kobo.2081.2">You should define the port number that is going to be open for connections. </span><span class="koboSpan" id="kobo.2081.3">In this case, both the internal and external port numbers are </span><code class="inlineCode"><span class="koboSpan" id="kobo.2082.1">1234</span></code><span class="koboSpan" id="kobo.2083.1">. </span><span class="koboSpan" id="kobo.2083.2">The internal one is mapped to the external one. </span><span class="koboSpan" id="kobo.2083.3">Additionally, you should put all Docker images under the same network, which, in this case, is called </span><code class="inlineCode"><span class="koboSpan" id="kobo.2084.1">monitoring</span></code><span class="koboSpan" id="kobo.2085.1"> and is defined in a while.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-attr"><span class="koboSpan" id="kobo.2086.1">prometheus:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2087.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2088.1">prom/prometheus:latest</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2089.1">container_name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2090.1">prometheus</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2091.1">restart:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2092.1">always</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2093.1">user:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2094.1">"0"</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2095.1">volumes:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2096.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2097.1">./prometheus/:/etc/prometheus/</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2098.1">This is how you pass your own copy of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2099.1">prometheus.yml</span></code><span class="koboSpan" id="kobo.2100.1"> to the Docker image to be used by Prometheus. </span><span class="koboSpan" id="kobo.2100.2">So, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2101.1">./prometheus/prometheus.yml</span></code><span class="koboSpan" id="kobo.2102.1"> from the local machine can be accessed as </span><code class="inlineCode"><span class="koboSpan" id="kobo.2103.1">/etc/prometheus/prometheus.yml</span></code><span class="koboSpan" id="kobo.2104.1"> from within the Docker image.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-bullet"><span class="koboSpan" id="kobo.2105.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2106.1">./prometheus_data/:/prometheus/</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2107.1">command:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2108.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2109.1">'--config.file=/etc/prometheus/prometheus.yml'</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2110.1">This is where you tell Prometheus which configuration file to use.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-bullet"><span class="koboSpan" id="kobo.2111.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2112.1">'--storage.tsdb.path=/prometheus'</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2113.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2114.1">'--web.console.libraries=/etc/prometheus/console_libraries'</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2115.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2116.1">'--web.console.templates=/etc/prometheus/consoles'</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2117.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2118.1">'--storage.tsdb.retention.time=200h'</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2119.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2120.1">'--web.enable-lifecycle'</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2121.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2122.1">-</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2123.1">9090</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2124.1">:9090</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2125.1">networks:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2126.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2127.1">monitoring</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2128.1">This is where </span><a id="_idIndexMarker1186"/><span class="koboSpan" id="kobo.2129.1">the </span><a id="_idIndexMarker1187"/><span class="koboSpan" id="kobo.2130.1">definition of the Prometheus part of the scenario ends. </span><span class="koboSpan" id="kobo.2130.2">The Docker image used is called </span><code class="inlineCode"><span class="koboSpan" id="kobo.2131.1">prom/prometheus:latest</span></code><span class="koboSpan" id="kobo.2132.1"> and the internal name of it is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2133.1">prometheus</span></code><span class="koboSpan" id="kobo.2134.1">. </span><span class="koboSpan" id="kobo.2134.2">Prometheus listens to port number </span><code class="inlineCode"><span class="koboSpan" id="kobo.2135.1">9090</span></code><span class="koboSpan" id="kobo.2136.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2137.1">Last, we present the Grafana part. </span><span class="koboSpan" id="kobo.2137.2">Grafana listens to port number </span><code class="inlineCode"><span class="koboSpan" id="kobo.2138.1">3000</span></code><span class="koboSpan" id="kobo.2139.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-attr"><span class="koboSpan" id="kobo.2140.1">grafana:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2141.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2142.1">grafana/grafana</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2143.1">container_name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2144.1">grafana</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2145.1">depends_on:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2146.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2147.1">prometheus</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2148.1">restart:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2149.1">always</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2150.1">user:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2151.1">"0"</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2152.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2153.1">-</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2154.1">3000</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2155.1">:3000</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2156.1">environment:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2157.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2158.1">GF_SECURITY_ADMIN_PASSWORD=helloThere</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2159.1">This is the current password of the admin user (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2160.1">helloThere</span></code><span class="koboSpan" id="kobo.2161.1">)—you need that for connecting to Grafana.</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-bullet"><span class="koboSpan" id="kobo.2162.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2163.1">GF_USERS_ALLOW_SIGN_UP=false</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2164.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2165.1">GF_PANELS_DISABLE_SANITIZE_HTML=true</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2166.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2167.1">GF_SECURITY_ALLOW_EMBEDDING=true</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2168.1">networks:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2169.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2170.1">monitoring</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2171.1">volumes:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.2172.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2173.1">./grafana_data/:/var/lib/grafana/</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2174.1">volumes:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2175.1">grafana_data:</span></span><span class="koboSpan" id="kobo.2176.1"> {}
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2177.1">prometheus_data:</span></span><span class="koboSpan" id="kobo.2178.1"> {}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2179.1">The preceding two lines in combination with the two </span><code class="inlineCode"><span class="koboSpan" id="kobo.2180.1">volumes</span></code><span class="koboSpan" id="kobo.2181.1"> fields allow both Grafana and Prometheus to save their data locally so that data is not lost each time you restart the Docker images.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.2182.1">networks:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2183.1">monitoring:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2184.1">driver:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2185.1">bridge</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2186.1">Internally, all three</span><a id="_idIndexMarker1188"/><span class="koboSpan" id="kobo.2187.1"> containers are known by the value of </span><a id="_idIndexMarker1189"/><span class="koboSpan" id="kobo.2188.1">their </span><code class="inlineCode"><span class="koboSpan" id="kobo.2189.1">container_name</span></code><span class="koboSpan" id="kobo.2190.1"> field. </span><span class="koboSpan" id="kobo.2190.2">However, externally, you can connect to the open ports from your local machine as </span><code class="inlineCode"><span class="koboSpan" id="kobo.2191.1">http://localhost:port</span></code><span class="koboSpan" id="kobo.2192.1"> or from another machine using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2193.1">http://hostname:port</span></code><span class="koboSpan" id="kobo.2194.1">—the second way is not very secure and should be blocked by a firewall. </span><span class="koboSpan" id="kobo.2194.2">Lastly, you need to run </span><code class="inlineCode"><span class="koboSpan" id="kobo.2195.1">docker-compose up</span></code><span class="koboSpan" id="kobo.2196.1"> and you are done! </span><span class="koboSpan" id="kobo.2196.2">The Go application begins exposing data and Prometheus begins collecting it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2197.1">The next figure shows the Prometheus UI (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2198.1">http://hostname:9090</span></code><span class="koboSpan" id="kobo.2199.1">) displaying a simple plot of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2200.1">packt_n_goroutines</span></code><span class="koboSpan" id="kobo.2201.1">:</span></p>
<figure class="mediaobject"> <span class="koboSpan" id="kobo.2202.1"><img alt="A screenshot of a graph  Description automatically generated" src="../Images/B21003_13_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2203.1">Figure 13.1: The Prometheus UI when displaying packt_n_goroutines</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2204.1">This output, which shows the values of the metrics in a graphical way, is very handy for debugging purposes, but it is far from being truly professional as Prometheus is not a visualization</span><a id="_idIndexMarker1190"/><span class="koboSpan" id="kobo.2205.1"> tool. </span><span class="koboSpan" id="kobo.2205.2">The </span><a id="_idIndexMarker1191"/><span class="koboSpan" id="kobo.2206.1">next subsection shows how you can connect Prometheus with Grafana and use Grafana to create impressive plots.</span></p>
<h2 class="heading-2" id="_idParaDest-381"><span class="koboSpan" id="kobo.2207.1">Visualizing Prometheus metrics in Grafana</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2208.1">There is no</span><a id="_idIndexMarker1192"/><span class="koboSpan" id="kobo.2209.1"> point in collecting metrics without doing </span><a id="_idIndexMarker1193"/><span class="koboSpan" id="kobo.2210.1">something with them, and by something, I mean visualizing them. </span><span class="koboSpan" id="kobo.2210.2">Prometheus and Grafana work very well together, so we are going to use Grafana for the visualization part. </span><span class="koboSpan" id="kobo.2210.3">The single most important task that you should perform in Grafana is connecting it with your Prometheus instance. </span><span class="koboSpan" id="kobo.2210.4">In Grafana terminology, you should create a Grafana data source that allows Grafana to get data from Prometheus.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2211.1">The steps for creating a data source with our Prometheus installation are the following:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2212.1">First, go to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2213.1">http://localhost:3000</span></code><span class="koboSpan" id="kobo.2214.1"> to connect to Grafana, because Grafana needs to learn about the data stored in Prometheus.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2215.1">The username of the administrator is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2216.1">admin</span></code><span class="koboSpan" id="kobo.2217.1">, whereas the password is defined in the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2218.1">GF_SECURITY_ADMIN_PASSWORD</span></code><span class="koboSpan" id="kobo.2219.1"> parameter of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2220.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.2221.1"> file.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2222.1">Then, select </span><strong class="screenText"><span class="koboSpan" id="kobo.2223.1">Add your first data source</span></strong><span class="koboSpan" id="kobo.2224.1">. </span><span class="koboSpan" id="kobo.2224.2">From the list of data sources, select </span><strong class="screenText"><span class="koboSpan" id="kobo.2225.1">Prometheus</span></strong><span class="koboSpan" id="kobo.2226.1">, which is usually at the top of the list.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2227.1">Put </span><code class="inlineCode"><span class="koboSpan" id="kobo.2228.1">http://prometheus:9090</span></code><span class="koboSpan" id="kobo.2229.1"> in the </span><strong class="screenText"><span class="koboSpan" id="kobo.2230.1">URL</span></strong><span class="koboSpan" id="kobo.2231.1"> field and then press the </span><strong class="screenText"><span class="koboSpan" id="kobo.2232.1">Save &amp; Test</span></strong><span class="koboSpan" id="kobo.2233.1"> button. </span><span class="koboSpan" id="kobo.2233.2">Due to the internal network that exists between the Docker images, the Grafana container knows the Prometheus container by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2234.1">prometheus</span></code><span class="koboSpan" id="kobo.2235.1"> hostname—this is the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2236.1">container_name</span></code><span class="koboSpan" id="kobo.2237.1"> field. </span><span class="koboSpan" id="kobo.2237.2">As you already know, you can also connect to Prometheus from your local machine using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2238.1">http://localhost:9090</span></code><span class="koboSpan" id="kobo.2239.1">. </span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2240.1">We are done! </span><span class="koboSpan" id="kobo.2240.2">The name of the data source is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2241.1">Prometheus</span></code><span class="koboSpan" id="kobo.2242.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2243.1">After these steps, create a new dashboard from the initial Grafana screen and put a new visualization on it. </span><span class="koboSpan" id="kobo.2243.2">Select </span><strong class="screenText"><span class="koboSpan" id="kobo.2244.1">Prometheus</span></strong><span class="koboSpan" id="kobo.2245.1"> as the data source of the panel if it is not already selected. </span><span class="koboSpan" id="kobo.2245.2">Then, go to the </span><strong class="screenText"><span class="koboSpan" id="kobo.2246.1">Metrics</span></strong><span class="koboSpan" id="kobo.2247.1"> drop-down menu and select the desired metrics. </span><span class="koboSpan" id="kobo.2247.2">Click </span><strong class="screenText"><span class="koboSpan" id="kobo.2248.1">Save</span></strong><span class="koboSpan" id="kobo.2249.1"> and you are done. </span><span class="koboSpan" id="kobo.2249.2">Create as many panels as you want.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2250.1">The next figure shows Grafana visualizing two metrics from Prometheus as exposed by </span><code class="inlineCode"><span class="koboSpan" id="kobo.2251.1">prometheus.go</span></code><span class="koboSpan" id="kobo.2252.1">.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2253.1"><img alt="A screenshot of a computer screen  Description automatically generated" src="../Images/B21003_13_02.png"/></span> </figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2254.1">Figure 13.2: Visualizing metrics in Grafana</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2255.1">Grafana has many </span><a id="_idIndexMarker1194"/><span class="koboSpan" id="kobo.2256.1">more capabilities than the ones </span><a id="_idIndexMarker1195"/><span class="koboSpan" id="kobo.2257.1">presented here—if you are working with system metrics and want to check the performance of your Go applications, Prometheus and Grafana are good and popular choices.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2258.1">In this section, we learned how to send metrics to Prometheus from a Go application and how to visualize the metrics in Grafana. </span><span class="koboSpan" id="kobo.2258.2">However, nothing is going to make sense if we do not know what metrics to collect, what a metric means, or how to collect metrics without sacrificing the overall performance of an application.</span></p>
<h1 class="heading-1" id="_idParaDest-382"><span class="koboSpan" id="kobo.2259.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2260.1">This chapter was about a recent addition to Go testing, which is fuzz testing. </span><span class="koboSpan" id="kobo.2260.2">Fuzz testing can help you find bugs in your code by generating test data on its own. </span><span class="koboSpan" id="kobo.2260.3">While fuzz testing offers several benefits, it is important to note that it is not a silver bullet. </span><span class="koboSpan" id="kobo.2260.4">This means that it should be used in conjunction with other testing techniques and security practices to ensure comprehensive coverage and robust security measures.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2261.1">You might say that after making sure that your software has no bugs, you may need to make it faster. </span><span class="koboSpan" id="kobo.2261.2">In such cases, you need to understand how your resources are being used—observability is about collecting performance-related information that helps you identify the behavior of your application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2262.1">Observability is crucial in modern, complex systems where traditional monitoring methods may fall short. </span><span class="koboSpan" id="kobo.2262.2">It enables engineers and operators to gain insights into the inner workings of a system, diagnose problems, and improve the overall system reliability and performance. </span><span class="koboSpan" id="kobo.2262.3">The concept is closely related to DevOps and </span><strong class="keyWord"><span class="koboSpan" id="kobo.2263.1">Site Reliability Engineering</span></strong><span class="koboSpan" id="kobo.2264.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2265.1">SRE</span></strong><span class="koboSpan" id="kobo.2266.1">) practices, emphasizing the importance of understanding, and managing systems in real-world, production environments.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2267.1">In the next chapter, which is about efficiency and performance, we are going to learn how to avoid memory leaks, how to benchmark Go code, and about Go memory management.</span></p>
<h1 class="heading-1" id="_idParaDest-383"><span class="koboSpan" id="kobo.2268.1">Exercises</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2269.1">Try to do the following exercises on your own:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2270.1">Run </span><code class="inlineCode"><span class="koboSpan" id="kobo.2271.1">cpuid.go</span></code><span class="koboSpan" id="kobo.2272.1"> on your own machine and see the capabilities and features of your hardware.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2273.1">Create a version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2274.1">cpuid.go</span></code><span class="koboSpan" id="kobo.2275.1"> that writes the desired information in logs.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2276.1">Fix the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2277.1">AddInt()</span></code><span class="koboSpan" id="kobo.2278.1"> function from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2279.1">fuzz</span></code><code class="inlineCode"><span class="koboSpan" id="kobo.2280.1">/code.go</span></code><span class="koboSpan" id="kobo.2281.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2282.1">Create a function for integer multiplication that uses a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2283.1">for</span></code><span class="koboSpan" id="kobo.2284.1"> loop in its implementation. </span><span class="koboSpan" id="kobo.2284.2">Write testing functions and fuzz testing functions for it.</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-384"><span class="koboSpan" id="kobo.2285.1">Additional resources</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2286.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2287.1">runtime/metrics</span></code><span class="koboSpan" id="kobo.2288.1"> package: </span><a href="https://pkg.go.dev/runtime/metrics"><span class="url"><span class="koboSpan" id="kobo.2289.1">https://pkg.go.dev/runtime/metrics</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2290.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2291.1">expvar</span></code><span class="koboSpan" id="kobo.2292.1"> package: </span><a href="https://pkg.go.dev/expvar"><span class="url"><span class="koboSpan" id="kobo.2293.1">https://pkg.go.dev/expvar</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2294.1">Prometheus: </span><a href="https://prometheus.io/"><span class="url"><span class="koboSpan" id="kobo.2295.1">https://prometheus.io/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2296.1">Grafana: </span><a href="https://grafana.com/"><span class="url"><span class="koboSpan" id="kobo.2297.1">https://grafana.com/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2298.1">Kibana: </span><a href="https://www.elastic.co/kibana/"><span class="url"><span class="koboSpan" id="kobo.2299.1">https://www.elastic.co/kibana/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2300.1">Elasticsearch: </span><a href="https://www.elastic.co/ "><span class="url"><span class="koboSpan" id="kobo.2301.1">https://www.elastic.co/</span></span></a></li>
</ul>
<h1 class="heading-1"><span class="koboSpan" id="kobo.2302.1">Leave a review!</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2303.1">Enjoying this book? </span><span class="koboSpan" id="kobo.2303.2">Help readers like you by leaving an Amazon review. </span><span class="koboSpan" id="kobo.2303.3">Scan the QR code below to get a free eBook of your choice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2304.1"><img alt="" role="presentation" src="../Images/Review_QR_Code.png"/></span></p>
</div>
</body></html>