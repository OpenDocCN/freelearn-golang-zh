<html><head></head><body>
<div id="_idContainer065">
<h1 class="chapter-number" id="_idParaDest-162"><a id="_idTextAnchor161"/><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 id="_idParaDest-163"><a id="_idTextAnchor162"/><span class="koboSpan" id="kobo.2.1">Automation Frameworks</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Most engineers start their automation journey by writing small ad hoc scripts. </span><span class="koboSpan" id="kobo.3.2">Over time, as these scripts grow in size and number, we need to think about the operating model for the solutions we create and how strong the foundations we are building upon are. </span><span class="koboSpan" id="kobo.3.3">Ultimately, we have to coordinate automation practices across different teams to generate business outcomes </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">at scale.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">To reduce the time and effort spent automating their use cases, some organizations try to standardize their tools and reuse generic components in their solutions, which often leads them to </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">automation frameworks.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">Automation frameworks allow different teams to come together under the same umbrella, break silos that may lead to inefficiencies, embrace common practices and code reusability, and enforce policies across domains to make the developed solutions </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">more secure.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">When choosing what best fits your environment and use cases, make sure you evaluate different automation frameworks. </span><span class="koboSpan" id="kobo.9.2">In this chapter, we will review some of them and focus specifically on how they can integrate with Go. </span><span class="koboSpan" id="kobo.9.3">In particular, we will look at </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">How Go programs can become </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">Ansible modules</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">The development of a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">Terraform provider</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">An overview of the rest of the well-known </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">Go-based frameworks</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.17.1">We close this chapter by looking at the current trends in the industry and how the new generation of automation frameworks may develop in </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">the future.</span></span></p>
<h1 id="_idParaDest-164"><a id="_idTextAnchor163"/><span class="koboSpan" id="kobo.19.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.20.1">You can find the code examples for this chapter in the book’s GitHub repository (see the </span><em class="italic"><span class="koboSpan" id="kobo.21.1">Further reading</span></em><span class="koboSpan" id="kobo.22.1"> section), in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.23.1">ch07</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.24.1"> folder.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.25.1">Important Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.26.1">We recommend you execute the Go programs in this chapter in a virtual lab environment. </span><span class="koboSpan" id="kobo.26.2">Refer to the appendix for the prerequisites and instructions on how to </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">build it.</span></span></p>
<h1 id="_idParaDest-165"><a id="_idTextAnchor164"/><span class="koboSpan" id="kobo.28.1">Ansible</span></h1>
<p><span class="koboSpan" id="kobo.29.1">Ansible is an open source project, framework, and automation platform. </span><span class="koboSpan" id="kobo.29.2">Its descriptive automation language has captured the</span><a id="_idIndexMarker630"/><span class="koboSpan" id="kobo.30.1"> attention of many network engineers who see it as an introduction with minimal friction into the world of network automation and something that can help them become productive </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">relatively quickly.</span></span></p>
<p><span class="koboSpan" id="kobo.32.1">Ansible has an agentless push-based architecture. </span><span class="koboSpan" id="kobo.32.2">It connects to the hosts it manages via SSH and runs a series of tasks. </span><span class="koboSpan" id="kobo.32.3">These tasks are small programs that we call Ansible modules, which are the units of code that Ansible abstracts away from the user. </span><span class="koboSpan" id="kobo.32.4">A user only has to give the input arguments and can rely on Ansible modules to do all the heavy work for them. </span><span class="koboSpan" id="kobo.32.5">Although the level of abstraction may vary, Ansible modules allow users to focus more on the desired state of their infrastructure and less on the individual commands required to achieve </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">that state.</span></span></p>
<h2 id="_idParaDest-166"><a id="_idTextAnchor165"/><span class="koboSpan" id="kobo.34.1">Overview of Ansible components</span></h2>
<p><span class="koboSpan" id="kobo.35.1">Playbooks are at the core of </span><a id="_idIndexMarker631"/><span class="koboSpan" id="kobo.36.1">Ansible. </span><span class="koboSpan" id="kobo.36.2">These text-based declarative YAML files define a set of automation tasks that you can group in different plays. </span><span class="koboSpan" id="kobo.36.3">Each task runs a module that comes from either the Ansible code base or a third-party </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">content collection:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer062">
<span class="koboSpan" id="kobo.38.1"><img alt="Figure 7.1 – Ansible high-level diagram" src="image/B16971_07_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.39.1">Figure 7.1 – Ansible high-level diagram</span></p>
<p><span class="koboSpan" id="kobo.40.1">We use an Ansible </span><a id="_idIndexMarker632"/><span class="koboSpan" id="kobo.41.1">inventory to describe the hosts or network devices we want to manage with Ansible. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.42.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.43.1">.1</span></em><span class="koboSpan" id="kobo.44.1"> provides a high-level overview of </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">these elements.</span></span></p>
<h3><span class="koboSpan" id="kobo.46.1">Inventory</span></h3>
<p><span class="koboSpan" id="kobo.47.1">An inventory is a list of</span><a id="_idIndexMarker633"/><span class="koboSpan" id="kobo.48.1"> managed hosts you can define statically in a text file or pull dynamically from an external system. </span><span class="koboSpan" id="kobo.48.2">You can manage hosts individually or collectively using groups. </span><span class="koboSpan" id="kobo.48.3">The following code snippet shows an Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">inventory file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.50.1">[eos]
</span><span class="Code_Red"><span class="koboSpan" id="kobo.51.1">clab-netgo-ceos</span></span>
<span class="Green-Dark"><span class="koboSpan" id="kobo.52.1">[eos:vars]</span></span>
<span class="Code_Red"><span class="koboSpan" id="kobo.53.1">ansible_user</span></span><span class="Code_Blue"><span class="koboSpan" id="kobo.54.1">=admin</span></span>
<span class="Code_Red"><span class="koboSpan" id="kobo.55.1">ansible_password</span></span><span class="Code_Blue"><span class="koboSpan" id="kobo.56.1">=admin</span></span>
<span class="Code_Red"><span class="koboSpan" id="kobo.57.1">ansible_connection</span></span><span class="Code_Blue"><span class="koboSpan" id="kobo.58.1">=ansible.netcommon.network_cli</span></span></pre>
<p><span class="koboSpan" id="kobo.59.1">You can also use inventory </span><a id="_idIndexMarker634"/><span class="koboSpan" id="kobo.60.1">to define group- and host-level variables that become available to </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">Ansible playbooks.</span></span></p>
<h3><span class="koboSpan" id="kobo.62.1">Playbooks, plays, and tasks</span></h3>
<p><span class="koboSpan" id="kobo.63.1">Ansible playbooks are files that you </span><a id="_idIndexMarker635"/><span class="koboSpan" id="kobo.64.1">write using a YAML-based </span><strong class="bold"><span class="koboSpan" id="kobo.65.1">Domain-Specific Language</span></strong><span class="koboSpan" id="kobo.66.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.67.1">DSL</span></strong><span class="koboSpan" id="kobo.68.1">). </span><span class="koboSpan" id="kobo.68.2">A playbook can </span><a id="_idIndexMarker636"/><span class="koboSpan" id="kobo.69.1">have one or more plays on it. </span><span class="koboSpan" id="kobo.69.2">Each Ansible play targets a host or a group of hosts from an inventory to perform a series of tasks in a </span><a id="_idIndexMarker637"/><span class="koboSpan" id="kobo.70.1">specific order. </span><span class="koboSpan" id="kobo.70.2">The following code output shows an</span><a id="_idIndexMarker638"/><span class="koboSpan" id="kobo.71.1"> example of a playbook with a single play and </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">two tasks:</span></span></p>
<pre class="source-code"><span class="Code_Blue"><span class="koboSpan" id="kobo.73.1">- name: </span></span><span class="koboSpan" id="kobo.74.1">First Play - Configure Routers
  </span><span class="Code_Blue"><span class="koboSpan" id="kobo.75.1">hosts:</span></span><span class="koboSpan" id="kobo.76.1"> routers
  </span><span class="Code_Blue"><span class="koboSpan" id="kobo.77.1">gather_facts: </span></span><span class="Code_Purple"><span class="koboSpan" id="kobo.78.1">true</span></span><span class="koboSpan" id="kobo.79.1">
  </span><span class="Code_Blue"><span class="koboSpan" id="kobo.80.1">tasks:</span></span><span class="koboSpan" id="kobo.81.1">
    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.82.1">- name: </span></span><span class="koboSpan" id="kobo.83.1">Run Nokia Go module on local system with Go
      </span><span class="Code_Blue"><span class="koboSpan" id="kobo.84.1">go_srl:</span></span><span class="koboSpan" id="kobo.85.1">
        </span><span class="Code_Blue"><span class="koboSpan" id="kobo.86.1">host:</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.87.1">"{{ inventory_hostname }}"</span></span><span class="koboSpan" id="kobo.88.1">
        </span><span class="Code_Blue"><span class="koboSpan" id="kobo.89.1">user:</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.90.1">"{{ ansible_user }}"</span></span><span class="koboSpan" id="kobo.91.1">
        </span><span class="Code_Blue"><span class="koboSpan" id="kobo.92.1">password:</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.93.1">"{{ ansible_password }}"</span></span><span class="koboSpan" id="kobo.94.1">
        </span><span class="Code_Blue"><span class="koboSpan" id="kobo.95.1">input:</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.96.1">"{{ hostvars[inventory_hostname] | string | b64encode }}"</span></span><span class="koboSpan" id="kobo.97.1">
      </span><span class="Code_Blue"><span class="koboSpan" id="kobo.98.1">delegate_to: </span></span><span class="koboSpan" id="kobo.99.1">localhost
      </span><span class="Code_Blue"><span class="koboSpan" id="kobo.100.1">when:</span></span><span class="koboSpan" id="kobo.101.1"> (</span><span class="Code_Red"><span class="koboSpan" id="kobo.102.1">'srl'</span></span><span class="koboSpan" id="kobo.103.1"> in group_names)
    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.104.1">- name:</span></span><span class="koboSpan" id="kobo.105.1"> Run NVIDIA compiled Go module on remote system without Go
      </span><span class="Code_Blue"><span class="koboSpan" id="kobo.106.1">go_cvx:</span></span><span class="koboSpan" id="kobo.107.1">
        </span><span class="Code_Blue"><span class="koboSpan" id="kobo.108.1">host:</span></span><span class="koboSpan" id="kobo.109.1"> localhost
        </span><span class="Code_Blue"><span class="koboSpan" id="kobo.110.1">user:</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.111.1">"{{ ansible_user }}"</span></span><span class="koboSpan" id="kobo.112.1">
        </span><span class="Code_Blue"><span class="koboSpan" id="kobo.113.1">password:</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.114.1">"{{ ansible_password }}"</span></span><span class="koboSpan" id="kobo.115.1">
        </span><span class="Code_Blue"><span class="koboSpan" id="kobo.116.1">input:</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.117.1">"{{ hostvars[inventory_hostname] | string | b64encode }}"</span></span><span class="koboSpan" id="kobo.118.1">
      </span><span class="Code_Blue"><span class="koboSpan" id="kobo.119.1">when:</span></span><span class="koboSpan" id="kobo.120.1"> (</span><span class="Code_Red"><span class="koboSpan" id="kobo.121.1">'cvx'</span></span><span class="Code_Green"> </span><span class="koboSpan" id="kobo.122.1">in group_names)</span></pre>
<p><span class="koboSpan" id="kobo.123.1">The last example is a snippet from a larger</span><a id="_idIndexMarker639"/><span class="koboSpan" id="kobo.124.1"> playbook (see </span><em class="italic"><span class="koboSpan" id="kobo.125.1">Further reading</span></em><span class="koboSpan" id="kobo.126.1">) included in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">ch07/ansible</span></strong><span class="koboSpan" id="kobo.128.1"> folder of this book’s GitHub repository. </span><span class="koboSpan" id="kobo.128.2">That playbook has four tasks spread across two different plays. </span><span class="koboSpan" id="kobo.128.3">We use that playbook to review different concepts throughout </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">this section.</span></span></p>
<h3><span class="koboSpan" id="kobo.130.1">Modules</span></h3>
<p><span class="koboSpan" id="kobo.131.1">Each task executes an Ansible</span><a id="_idIndexMarker640"/><span class="koboSpan" id="kobo.132.1"> module. </span><span class="koboSpan" id="kobo.132.2">Although implementations may vary, the goal of an Ansible module is to be idempotent, so no matter how many times you run it against the same set of hosts, you always get the </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">same outcome.</span></span></p>
<p><span class="koboSpan" id="kobo.134.1">Ansible ships with several modules written mostly in Python, but it doesn’t stop you from using another programming language, which is what we explore in </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">this section.</span></span></p>
<h2 id="_idParaDest-167"><a id="_idTextAnchor166"/><span class="koboSpan" id="kobo.136.1">Working with Ansible modules</span></h2>
<p><span class="koboSpan" id="kobo.137.1">The code of an Ansible module can</span><a id="_idIndexMarker641"/><span class="koboSpan" id="kobo.138.1"> execute either on a remote node, for hosts such as Linux servers, or locally, on the node running the playbook. </span><span class="koboSpan" id="kobo.138.2">The latter is what we typically do when the managed node is an API service or a network device because they both lack an execution environment with dependencies such as Linux shell and Python. </span><span class="koboSpan" id="kobo.138.3">Luckily, modern network operating systems meet those requirements, which give us both options of running the code locally </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">or remotely.</span></span></p>
<p><span class="koboSpan" id="kobo.140.1">If you look at the preceding playbook snippet, you can see how we implemented these two options. </span><span class="koboSpan" id="kobo.140.2">The first task invokes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">go_srl</span></strong><span class="koboSpan" id="kobo.142.1"> module that gets delegated to the localhost. </span><span class="koboSpan" id="kobo.142.2">This means it runs from the machine running Ansible and targets a remote host provided in the host argument. </span><span class="koboSpan" id="kobo.142.3">The second task executes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">go_cvx</span></strong><span class="koboSpan" id="kobo.144.1"> module, which is not delegated and</span><a id="_idIndexMarker642"/><span class="koboSpan" id="kobo.145.1"> thus runs on a remote node, targeting its API calls at </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">the localhost.</span></span></p>
<p><span class="koboSpan" id="kobo.147.1">The rest of the playbook uses a combination of local and remote execution environments, as denoted by the gear symbols in the </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">following diagram:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer063">
<span class="koboSpan" id="kobo.149.1"><img alt="Figure 7.2 – Playbook example" src="image/B16971_07_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.150.1">Figure 7.2 – Playbook example</span></p>
<p><span class="koboSpan" id="kobo.151.1">The Ansible playbook first runs an Ansible play to configure each node of the topology with these high-level objectives: </span></p>
<ul>
<li><span class="koboSpan" id="kobo.152.1">Configure the SR Linux node (</span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">srl</span></strong><span class="koboSpan" id="kobo.154.1">) using a compiled Go code we execute locally on the machine </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">running Ansible</span></span></li>
<li><span class="koboSpan" id="kobo.156.1">Configure the NVIDIA Cumulus node (</span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">cvx</span></strong><span class="koboSpan" id="kobo.158.1">) using a compiled Go code we execute on the </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">remote node</span></span></li>
<li><span class="koboSpan" id="kobo.160.1">Configure the Arista EOS node (</span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">ceos</span></strong><span class="koboSpan" id="kobo.162.1">) using a compiled Go code we execute locally on the machine </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">running Ansible</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.164.1">The choice of local or remote execution environments in the preceding playbook is random and only serves to show the two different approaches. </span><span class="koboSpan" id="kobo.164.2">Since all our lab devices are Linux-based, we can </span><a id="_idIndexMarker643"/><span class="koboSpan" id="kobo.165.1">change this behavior without reworking the Ansible modules </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">we use.</span></span></p>
<p><span class="koboSpan" id="kobo.167.1">The second play has a single task that verifies the configured state on all three devices using a non-compiled code we execute using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">go run</span></strong><span class="koboSpan" id="kobo.169.1"> command. </span><span class="koboSpan" id="kobo.169.2">We use this last task to show an alternative approach to concurrency that uses Go native primitives instead of Ansible forks to execute tasks on several nodes at the same time. </span><span class="koboSpan" id="kobo.169.3">We discuss this later in </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">this section.</span></span></p>
<h2 id="_idParaDest-168"><a id="_idTextAnchor167"/><span class="koboSpan" id="kobo.171.1">Developing an Ansible module</span></h2>
<p><span class="koboSpan" id="kobo.172.1">While Ansible developers</span><a id="_idIndexMarker644"/><span class="koboSpan" id="kobo.173.1"> write most Ansible modules in Python, there are different reasons to write a module in another </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">programming language:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.175.1">Your company might use another programming </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">language already.</span></span></li>
<li><span class="koboSpan" id="kobo.177.1">Maybe you know or feel more comfortable writing in a </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">different language.</span></span></li>
<li><span class="koboSpan" id="kobo.179.1">The code is already available and there is no business justification to rewrite it in another </span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">programming language.</span></span></li>
<li><span class="koboSpan" id="kobo.181.1">You want to take advantage of a feature that is not available </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">in Python.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.183.1">Ansible’s role is not to rip and replace everything that you have, especially if it’s working for you already. </span><span class="koboSpan" id="kobo.183.2">To illustrate this, we will take a set of Go programs from other chapters and turn them into Ansible modules we can execute in a playbook to configure our </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">lab topology.</span></span></p>
<h3><span class="koboSpan" id="kobo.185.1">Ansible module interface</span></h3>
<p><span class="koboSpan" id="kobo.186.1">You can extend Ansible by adding custom modules. </span><span class="koboSpan" id="kobo.186.2">Their implementation code should go into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">library</span></strong><span class="koboSpan" id="kobo.188.1"> folder. </span><span class="koboSpan" id="kobo.188.2">When Ansible</span><a id="_idIndexMarker645"/><span class="koboSpan" id="kobo.189.1"> runs into a task with a module that is not installed in the system, it looks for a file with the module’s name in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">library</span></strong><span class="koboSpan" id="kobo.191.1"> folder and tries to run it as a module, going through the following sequence </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">of steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.193.1">It saves all module arguments in a temporary file, for </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">/tmp/foo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.197.1">It executes that module as a child process, passing it the filename as the first and only argument, for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">./</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">library/my_module /tmp/foo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.201.1">It waits for the process to complete and expects to receive a structured response in its </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">standard output.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.203.1">While Ansible always expects a response in a JSON format, the input file format Ansible passes to the module depends on whether the module is a script or a binary. </span><span class="koboSpan" id="kobo.203.2">All binary modules get their input arguments as a JSON file, while script modules receive their input arguments as Bash files or just a list of </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">key-value pairs.</span></span></p>
<p><span class="koboSpan" id="kobo.205.1">From Go’s code perspective, to make this input behavior uniform, we normalize the input format to JSON before running any non-compiled Go programs. </span><span class="koboSpan" id="kobo.205.2">We do this using a wrapper Bash script that transforms the Bash input into JSON before calling the </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">go run</span></strong><span class="koboSpan" id="kobo.207.1"> command, as you can see in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">ch07/ansible/library/go_state</span></strong><span class="koboSpan" id="kobo.209.1"> file of this book’s GitHub repository (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.210.1">Further reading</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">).</span></span></p>
<h3><span class="koboSpan" id="kobo.212.1">Adapting your Go code to interact with Ansible</span></h3>
<p><span class="koboSpan" id="kobo.213.1">Ultimately, a custom Ansible module can do anything as long as it understands how to parse the input arguments and knows how to return the expected output. </span><span class="koboSpan" id="kobo.213.2">We would need to change the Go programs from other chapters to make them an Ansible module. </span><span class="koboSpan" id="kobo.213.3">But the amount of changes necessary is minimal. </span><span class="koboSpan" id="kobo.213.4">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">examine this.</span></span></p>
<p><span class="koboSpan" id="kobo.215.1">First, for this example, we need to create a struct to parse the module arguments we receive in the input JSON file. </span><span class="koboSpan" id="kobo.215.2">These arguments include login credentials and the input </span><span class="No-Break"><span class="koboSpan" id="kobo.216.1">data model:</span></span></p>
<pre class="source-code"><span class="Code_Brown"><span class="koboSpan" id="kobo.217.1">// ModuleArgs are the module inputs</span></span>
<span class="Code_Purple"><span class="koboSpan" id="kobo.218.1">type</span></span><span class="koboSpan" id="kobo.219.1"> ModuleArgs </span><span class="Code_Purple"><span class="koboSpan" id="kobo.220.1">struct</span></span><span class="koboSpan" id="kobo.221.1"> {
  Host     </span><span class="Code_Purple"><span class="koboSpan" id="kobo.222.1">string</span></span><span class="koboSpan" id="kobo.223.1">
  User     </span><span class="Code_Purple"><span class="koboSpan" id="kobo.224.1">string</span></span><span class="koboSpan" id="kobo.225.1">
  Password </span><span class="Code_Purple"><span class="koboSpan" id="kobo.226.1">string</span></span><span class="koboSpan" id="kobo.227.1">
  Input    </span><span class="Code_Purple"><span class="koboSpan" id="kobo.228.1">string</span></span><span class="koboSpan" id="kobo.229.1">
}
</span><span class="Code_Purple"><span class="koboSpan" id="kobo.230.1">func</span></span><span class="koboSpan" id="kobo.231.1"> main() {
  </span><span class="Code_Purple"><span class="koboSpan" id="kobo.232.1">if</span></span> <span class="Code_Blue"><span class="koboSpan" id="kobo.233.1">len</span></span><span class="koboSpan" id="kobo.234.1">(os.Args) </span><span class="Code_Red"><span class="koboSpan" id="kobo.235.1">!=</span></span> <span class="Code_Green"><span class="koboSpan" id="kobo.236.1">2</span></span><span class="koboSpan" id="kobo.237.1"> {
   </span><span class="Code_Brown"><span class="koboSpan" id="kobo.238.1"> // generate error</span></span><span class="koboSpan" id="kobo.239.1">
  }
  argsFile :</span><span class="Code_Red"><span class="koboSpan" id="kobo.240.1">=</span></span><span class="koboSpan" id="kobo.241.1"> os.Args[</span><span class="Code_Green"><span class="koboSpan" id="kobo.242.1">1</span></span><span class="koboSpan" id="kobo.243.1">]
  text, err :</span><span class="Code_Red"><span class="koboSpan" id="kobo.244.1">=</span></span><span class="koboSpan" id="kobo.245.1"> os.ReadFile(argsFile)
</span><span class="Code_Brown"><span class="koboSpan" id="kobo.246.1">  // check error</span></span><span class="koboSpan" id="kobo.247.1">
  </span><span class="Code_Purple"><span class="koboSpan" id="kobo.248.1">var</span></span><span class="koboSpan" id="kobo.249.1"> moduleArgs ModuleArgs
  err </span><span class="Code_Red"><span class="koboSpan" id="kobo.250.1">=</span></span><span class="koboSpan" id="kobo.251.1"> json.Unmarshal(text, </span><span class="Code_Red"><span class="koboSpan" id="kobo.252.1">&amp;</span></span><span class="koboSpan" id="kobo.253.1">moduleArgs)
</span><span class="Code_Brown"><span class="koboSpan" id="kobo.254.1">  // check error</span></span>
<span class="Code_Brown"><span class="koboSpan" id="kobo.255.1">  /* ... </span><span class="koboSpan" id="kobo.255.2">&lt;continues next &gt; ... </span><span class="koboSpan" id="kobo.255.3">*/</span></span></pre>
<p><span class="koboSpan" id="kobo.256.1">The input data model we use for Ansible remains the same as the one that we used in other chapters. </span><span class="koboSpan" id="kobo.256.2">This data is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">ch07/ansible/host_vars</span></strong><span class="koboSpan" id="kobo.258.1"> directory for this example. </span><span class="koboSpan" id="kobo.258.2">With Ansible, this data model becomes just a subset of all variables defined for each host. </span><span class="koboSpan" id="kobo.258.3">We pass it, along with the</span><a id="_idIndexMarker646"/><span class="koboSpan" id="kobo.259.1"> rest of the host variables, as a base64-encoded string. </span><span class="koboSpan" id="kobo.259.2">Inside our module, we decode the input string and decode it into the same </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">Model</span></strong><span class="koboSpan" id="kobo.261.1"> struct we </span><span class="No-Break"><span class="koboSpan" id="kobo.262.1">used before:</span></span></p>
<pre class="source-code"><span class="Code_Purple"><span class="koboSpan" id="kobo.263.1">import</span></span><span class="koboSpan" id="kobo.264.1"> (
 </span><span class="Code_Red"><span class="koboSpan" id="kobo.265.1"> "encoding/base64"</span></span>
<span class="Code_Red"><span class="koboSpan" id="kobo.266.1">  "gopkg.in/yaml.v2"</span></span><span class="koboSpan" id="kobo.267.1">
)
</span><span class="Code_Purple"><span class="koboSpan" id="kobo.268.1">type</span></span><span class="koboSpan" id="kobo.269.1"> Model </span><span class="Code_Purple"><span class="koboSpan" id="kobo.270.1">struct</span></span><span class="koboSpan" id="kobo.271.1"> {
  Uplinks  []Link </span><span class="Code_Red"><span class="koboSpan" id="kobo.272.1">`yaml:"uplinks"`</span></span><span class="koboSpan" id="kobo.273.1">
  Peers    []Peer </span><span class="Code_Red"><span class="koboSpan" id="kobo.274.1">`yaml:"peers"`</span></span><span class="koboSpan" id="kobo.275.1">
  ASN      </span><span class="Code_Purple"><span class="koboSpan" id="kobo.276.1">int</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.277.1">    `yaml:"asn"`</span></span><span class="koboSpan" id="kobo.278.1">
  Loopback Addr   </span><span class="Code_Red"><span class="koboSpan" id="kobo.279.1">`yaml:"loopback"`</span></span><span class="koboSpan" id="kobo.280.1">
}
</span><span class="Code_Purple"><span class="koboSpan" id="kobo.281.1">func</span></span><span class="koboSpan" id="kobo.282.1"> main() {
  </span><span class="Code_Brown"><span class="koboSpan" id="kobo.283.1">/* ... </span><span class="koboSpan" id="kobo.283.2">&lt;continues from before &gt; ... </span><span class="koboSpan" id="kobo.283.3">*/</span></span><span class="koboSpan" id="kobo.284.1">
  src, err :</span><span class="Code_Red"><span class="koboSpan" id="kobo.285.1">=</span></span><span class="koboSpan" id="kobo.286.1">
      base64.StdEncoding.DecodeString(moduleArgs.Input)
  </span><span class="Code_Brown"><span class="koboSpan" id="kobo.287.1">// check error</span></span><span class="koboSpan" id="kobo.288.1">
  reader :</span><span class="Code_Red"><span class="koboSpan" id="kobo.289.1">=</span></span><span class="koboSpan" id="kobo.290.1"> bytes.NewReader(src)
  d :</span><span class="Code_Red"><span class="koboSpan" id="kobo.291.1">=</span></span><span class="koboSpan" id="kobo.292.1"> yaml.NewDecoder(reader)
  </span><span class="Code_Purple"><span class="koboSpan" id="kobo.293.1">var</span></span><span class="koboSpan" id="kobo.294.1"> input Model
  d.Decode(</span><span class="Code_Red"><span class="koboSpan" id="kobo.295.1">&amp;</span></span><span class="koboSpan" id="kobo.296.1">input)
</span><span class="Code_Brown"><span class="koboSpan" id="kobo.297.1">  /* ... </span><span class="koboSpan" id="kobo.297.2">&lt;continues next &gt; ... </span><span class="koboSpan" id="kobo.297.3">*/</span></span></pre>
<p><span class="koboSpan" id="kobo.298.1">At this point, we’ve parsed enough information for our Go program to configure a network device. </span><span class="koboSpan" id="kobo.298.2">This part of the </span><a id="_idIndexMarker647"/><span class="koboSpan" id="kobo.299.1">Go code does not require any modifications. </span><span class="koboSpan" id="kobo.299.2">The only thing you need to be mindful of is that instead of logging to the console, you now need to send any log messages as a response </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">to Ansible.</span></span></p>
<p><span class="koboSpan" id="kobo.301.1">When all the work is complete, we need to prepare and print the response object for Ansible. </span><span class="koboSpan" id="kobo.301.2">The following code snippet shows the </span><em class="italic"><span class="koboSpan" id="kobo.302.1">happy path</span></em><span class="koboSpan" id="kobo.303.1"> when all changes have </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">gone through:</span></span></p>
<pre class="source-code"><span class="Code_Brown"><span class="koboSpan" id="kobo.305.1">// Response is the values returned from the module</span></span>
<span class="Code_Purple"><span class="koboSpan" id="kobo.306.1">type</span></span><span class="koboSpan" id="kobo.307.1"> Response </span><span class="Code_Purple"><span class="koboSpan" id="kobo.308.1">struct</span></span><span class="koboSpan" id="kobo.309.1"> {
  Msg     </span><span class="Code_Purple"><span class="koboSpan" id="kobo.310.1">string</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.311.1"> `json:"msg"`</span></span><span class="koboSpan" id="kobo.312.1">
  Busy    </span><span class="Code_Purple"><span class="koboSpan" id="kobo.313.1">bool</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.314.1">   `json:"busy"`</span></span><span class="koboSpan" id="kobo.315.1">
  Changed </span><span class="Code_Purple"><span class="koboSpan" id="kobo.316.1">bool</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.317.1">   `json:"changed"`</span></span><span class="koboSpan" id="kobo.318.1">
  Failed  </span><span class="Code_Purple"><span class="koboSpan" id="kobo.319.1">bool</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.320.1">   `json:"failed"`</span></span><span class="koboSpan" id="kobo.321.1">
}
</span><span class="Code_Purple"><span class="koboSpan" id="kobo.322.1">func</span></span><span class="koboSpan" id="kobo.323.1"> main() {
  </span><span class="Code_Brown"><span class="koboSpan" id="kobo.324.1">/* ... </span><span class="koboSpan" id="kobo.324.2">&lt;continues from before &gt; ... </span><span class="koboSpan" id="kobo.324.3">*/</span></span><span class="koboSpan" id="kobo.325.1">
  </span><span class="Code_Purple"><span class="koboSpan" id="kobo.326.1">var</span></span><span class="koboSpan" id="kobo.327.1"> r Response
  r.Msg </span><span class="Code_Red"><span class="koboSpan" id="kobo.328.1">= "Device Configured Successfully"</span></span><span class="koboSpan" id="kobo.329.1">
  r.Changed </span><span class="Code_Red"><span class="koboSpan" id="kobo.330.1">=</span></span> <span class="Code_Blue"><span class="koboSpan" id="kobo.331.1">true</span></span><span class="koboSpan" id="kobo.332.1">
  r.Failed </span><span class="Code_Red"><span class="koboSpan" id="kobo.333.1">=</span></span> <span class="Code_Blue"><span class="koboSpan" id="kobo.334.1">false</span></span><span class="koboSpan" id="kobo.335.1">
  response, err </span><span class="Code_Red"><span class="koboSpan" id="kobo.336.1">=</span></span><span class="koboSpan" id="kobo.337.1"> json.Marshal(r)
 </span><span class="Code_Brown"><span class="koboSpan" id="kobo.338.1"> // check error</span></span><span class="koboSpan" id="kobo.339.1">
  fmt.Println(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.340.1">string</span></span><span class="koboSpan" id="kobo.341.1">(response))
  os.Exit(</span><span class="Code_Green"><span class="koboSpan" id="kobo.342.1">0</span></span><span class="koboSpan" id="kobo.343.1">)
}</span></pre>
<p><span class="koboSpan" id="kobo.344.1">Using a similar pattern to what</span><a id="_idIndexMarker648"/><span class="koboSpan" id="kobo.345.1"> we just described, we have created a custom module for each one of the three lab devices and one module to verify the state of the lab topology as we did in </span><a href="B16971_06.xhtml#_idTextAnchor144"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.346.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.347.1">, </span><em class="italic"><span class="koboSpan" id="kobo.348.1">Configuration Management</span></em><span class="koboSpan" id="kobo.349.1">. </span><span class="koboSpan" id="kobo.349.2">You can find these modules in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">ch07/ansible/</span></strong><span class="koboSpan" id="kobo.351.1">{</span><strong class="source-inline"><span class="koboSpan" id="kobo.352.1">srl</span></strong><span class="koboSpan" id="kobo.353.1">|</span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">cvx</span></strong><span class="koboSpan" id="kobo.355.1">|</span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">ceos</span></strong><span class="koboSpan" id="kobo.357.1">|</span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">state</span></strong><span class="koboSpan" id="kobo.359.1">} directories of this book’s GitHub repository (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.360.1">Further reading</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.362.1">Before we move on to the execution, we want to show one way we can make use of Go’s built-in features to speed up and optimize concurrent task execution </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">in Ansible.</span></span></p>
<h3><span class="koboSpan" id="kobo.364.1">Taking advantage of Go’s concurrency</span></h3>
<p><span class="koboSpan" id="kobo.365.1">Ansible’s default behavior is to run</span><a id="_idIndexMarker649"/><span class="koboSpan" id="kobo.366.1"> each task on all hosts before moving on to the next one (linear strategy). </span><span class="koboSpan" id="kobo.366.2">Of course, it doesn’t just run one task on one host at a time; instead, it uses several independent processes attempting to run simultaneously on as many hosts as the number of forks you define in the Ansible configuration. </span><span class="koboSpan" id="kobo.366.3">Whether these processes run in parallel depends on the hardware resources available </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">to them.</span></span></p>
<p><span class="koboSpan" id="kobo.368.1">A less expensive approach from a resource utilization perspective is to leverage Go concurrency. </span><span class="koboSpan" id="kobo.368.2">This is what we do in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.369.1">go_state</span></strong><span class="koboSpan" id="kobo.370.1"> Ansible module, where we target a single node from the inventory, the implicit localhost, and leave the concurrent communication with the remote nodes </span><span class="No-Break"><span class="koboSpan" id="kobo.371.1">to Go.</span></span></p>
<p><span class="koboSpan" id="kobo.372.1">For the following module, we reuse the code example from the </span><em class="italic"><span class="koboSpan" id="kobo.373.1">State validation</span></em><span class="koboSpan" id="kobo.374.1"> section of </span><a href="B16971_06.xhtml#_idTextAnchor144"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.375.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.376.1">, </span><em class="italic"><span class="koboSpan" id="kobo.377.1">Configuration Management</span></em><span class="koboSpan" id="kobo.378.1"> that has the access details embedded in the code already, but you could also pass these access details as arguments to the module to achieve the </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">same result:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.380.1">  </span><span class="Code_Blue"><span class="koboSpan" id="kobo.381.1">- name: </span></span><span class="koboSpan" id="kobo.382.1">Run Validate module on Systems with Go installed
    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.383.1">go_state:</span></span><span class="koboSpan" id="kobo.384.1">
      </span><span class="Code_Blue"><span class="koboSpan" id="kobo.385.1">host:</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.386.1">"{{ inventory_hostname }}"</span></span></pre>
<p><span class="koboSpan" id="kobo.387.1">The trade - off of this approach is that we gain speed and get more efficient use of resources, but we lose the inventory management side of Ansible. </span><span class="koboSpan" id="kobo.387.2">Be mindful of this when trying to decide whether this is the right fit for your </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">use case.</span></span></p>
<h2 id="_idParaDest-169"><a id="_idTextAnchor168"/><span class="koboSpan" id="kobo.389.1">Running the playbook</span></h2>
<p><span class="koboSpan" id="kobo.390.1">You can find the complete </span><a id="_idIndexMarker650"/><span class="koboSpan" id="kobo.391.1">example involving four Go Ansible modules in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">ch07/ansible</span></strong><span class="koboSpan" id="kobo.393.1"> directory. </span><span class="koboSpan" id="kobo.393.2">To run it, first make sure the lab topology is running from the root folder of the repository with </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">make lab-up</span></strong><span class="koboSpan" id="kobo.395.1">, then run the playbook with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">ansible-playbook</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.397.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.398.1">ch07/ansible</span><span class="Code_Blue"><span class="koboSpan" id="kobo.399.1">$ ansible-playbook</span></span><span class="koboSpan" id="kobo.400.1"> playbook.yml 
</span><span class="Code_Brown"><span class="koboSpan" id="kobo.401.1"># output omitted for brevity.</span></span><span class="koboSpan" id="kobo.402.1">
PLAY RECAP *********************************************************************************************************************************************************
clab-netgo-ceos            : </span><span class="Code_Blue"><span class="koboSpan" id="kobo.403.1">ok</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.404.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.405.1">5</span></span><span class="koboSpan" id="kobo.406.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.407.1">changed</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.408.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.409.1">0</span></span><span class="koboSpan" id="kobo.410.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.411.1">unreachable</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.412.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.413.1">0</span></span><span class="koboSpan" id="kobo.414.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.415.1">failed</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.416.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.417.1">0</span></span><span class="koboSpan" id="kobo.418.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.419.1">skipped</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.420.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.421.1">4</span></span><span class="koboSpan" id="kobo.422.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.423.1">rescued</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.424.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.425.1">0</span></span><span class="koboSpan" id="kobo.426.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.427.1">ignored</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.428.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.429.1">0</span></span><span class="koboSpan" id="kobo.430.1">   
clab-netgo-cvx             : </span><span class="Code_Blue"><span class="koboSpan" id="kobo.431.1">ok</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.432.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.433.1">2</span></span><span class="koboSpan" id="kobo.434.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.435.1">changed</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.436.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.437.1">1</span></span><span class="koboSpan" id="kobo.438.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.439.1">unreachable</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.440.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.441.1">0</span></span><span class="koboSpan" id="kobo.442.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.443.1">failed</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.444.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.445.1">0</span></span><span class="koboSpan" id="kobo.446.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.447.1">skipped</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.448.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.449.1">7</span></span><span class="koboSpan" id="kobo.450.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.451.1">rescued</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.452.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.453.1">0</span></span><span class="koboSpan" id="kobo.454.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.455.1">ignored</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.456.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.457.1">0</span></span><span class="koboSpan" id="kobo.458.1">   
clab-netgo-srl             : </span><span class="Code_Blue"><span class="koboSpan" id="kobo.459.1">ok</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.460.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.461.1">2</span></span><span class="koboSpan" id="kobo.462.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.463.1">changed</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.464.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.465.1">1</span></span><span class="koboSpan" id="kobo.466.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.467.1">unreachable</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.468.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.469.1">0</span></span><span class="koboSpan" id="kobo.470.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.471.1">failed</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.472.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.473.1">0</span></span><span class="koboSpan" id="kobo.474.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.475.1">skipped</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.476.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.477.1">7</span></span><span class="koboSpan" id="kobo.478.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.479.1">rescued</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.480.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.481.1">0</span></span><span class="koboSpan" id="kobo.482.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.483.1">ignored</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.484.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.485.1">0</span></span><span class="koboSpan" id="kobo.486.1">   
localhost                  : </span><span class="Code_Blue"><span class="koboSpan" id="kobo.487.1">ok</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.488.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.489.1">1</span></span><span class="koboSpan" id="kobo.490.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.491.1">changed</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.492.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.493.1">0</span></span><span class="koboSpan" id="kobo.494.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.495.1">unreachable</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.496.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.497.1">0</span></span><span class="koboSpan" id="kobo.498.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.499.1">failed</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.500.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.501.1">0</span></span><span class="koboSpan" id="kobo.502.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.503.1">skipped</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.504.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.505.1">0</span></span><span class="koboSpan" id="kobo.506.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.507.1">rescued</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.508.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.509.1">0</span></span><span class="koboSpan" id="kobo.510.1">    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.511.1">ignored</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.512.1">=</span></span><span class="Code_Green"><span class="koboSpan" id="kobo.513.1">0</span></span></pre>
<p><span class="koboSpan" id="kobo.514.1">Now that we’ve covered how</span><a id="_idIndexMarker651"/><span class="koboSpan" id="kobo.515.1"> Go programs can integrate with Ansible, we will move on to another popular automation </span><span class="No-Break"><span class="koboSpan" id="kobo.516.1">framework: Terraform.</span></span></p>
<h1 id="_idParaDest-170"><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.517.1">Terraform</span></h1>
<p><span class="koboSpan" id="kobo.518.1">Terraform is an open source software solution for declarative infrastructure management. </span><span class="koboSpan" id="kobo.518.2">It allows you to express </span><a id="_idIndexMarker652"/><span class="koboSpan" id="kobo.519.1">and manage the desired state of your infrastructure with code. </span><span class="koboSpan" id="kobo.519.2">It has gained initial popularity as a framework to automate public cloud infrastructure but now supports a variety of on-premises and public cloud resources, platforms, services—almost anything that has </span><span class="No-Break"><span class="koboSpan" id="kobo.520.1">an API.</span></span></p>
<p><span class="koboSpan" id="kobo.521.1">One of the key distinctions of Terraform is the way it manages state. </span><span class="koboSpan" id="kobo.521.2">Once it creates a remote resource initially, it saves the resulting state in a file and relies on that state to be there for its next runs. </span><span class="koboSpan" id="kobo.521.3">As you update and develop your infrastructure code, the state file enables Terraform to manage the entire life cycle of a remote resource, calculating the precise sequence of API calls to transition between states. </span><span class="koboSpan" id="kobo.521.4">This ability to manage state and the declarative configuration language and the agentless, API-first architecture allowed Terraform to become deeply entrenched in the cloud infrastructure space and become a critical part of DevOps and </span><span class="No-Break"><span class="koboSpan" id="kobo.522.1">Infrastructure-as-Code toolchains.</span></span></p>
<p><span class="koboSpan" id="kobo.523.1">If we look at the Terraform registry (see </span><em class="italic"><span class="koboSpan" id="kobo.524.1">Further reading</span></em><span class="koboSpan" id="kobo.525.1">), we can see over a hundred providers in the networking category ranging from SDN appliances and firewalls to various cloud services. </span><span class="koboSpan" id="kobo.525.2">This number is on a rising trend, as more people adopt a declarative approach to</span><a id="_idIndexMarker653"/><span class="koboSpan" id="kobo.526.1"> manage their infrastructure as code. </span><span class="koboSpan" id="kobo.526.2">This is why we believe it’s important for network automation engineers to know Terraform and be able to extend its capabilities </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">using Go.</span></span></p>
<h2 id="_idParaDest-171"><a id="_idTextAnchor170"/><span class="koboSpan" id="kobo.528.1">Overview of Terraform components</span></h2>
<p><span class="koboSpan" id="kobo.529.1">The entire Terraform</span><a id="_idIndexMarker654"/><span class="koboSpan" id="kobo.530.1"> ecosystem is a collection of Go packages. </span><span class="koboSpan" id="kobo.530.2">They distribute the main CLI tool, often referred to as </span><em class="italic"><span class="koboSpan" id="kobo.531.1">Terraform Core</span></em><span class="koboSpan" id="kobo.532.1">, as a statically compiled binary. </span><span class="koboSpan" id="kobo.532.2">This binary implements the command-line interface and can parse and evaluate</span><a id="_idIndexMarker655"/><span class="koboSpan" id="kobo.533.1"> instructions written in </span><strong class="bold"><span class="koboSpan" id="kobo.534.1">Hashicorp Configuration Language</span></strong><span class="koboSpan" id="kobo.535.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.536.1">HCL</span></strong><span class="koboSpan" id="kobo.537.1">). </span><span class="koboSpan" id="kobo.537.2">On every invocation, it builds a resource graph and generates an execution plan to reach the desired state described in the</span><a id="_idIndexMarker656"/><span class="koboSpan" id="kobo.538.1"> configuration file. </span><span class="koboSpan" id="kobo.538.2">The main binary only includes a few plugins but can discover and download the </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">required dependencies.</span></span></p>
<p><span class="koboSpan" id="kobo.540.1">Terraform plugins are also distributed as standalone binaries. </span><span class="koboSpan" id="kobo.540.2">Terraform Core starts and terminates the required plugins as child processes and interacts with them using an internal gRPC-based protocol. </span><span class="koboSpan" id="kobo.540.3">Terraform defines two types </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">of plugins:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.542.1">Providers</span></strong><span class="koboSpan" id="kobo.543.1">: Interact with a remote</span><a id="_idIndexMarker657"/><span class="koboSpan" id="kobo.544.1"> infrastructure provider and implement the </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">required changes</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.546.1">Provisioners</span></strong><span class="koboSpan" id="kobo.547.1">: Implement a set of</span><a id="_idIndexMarker658"/><span class="koboSpan" id="kobo.548.1"> imperative actions, declared as a set of terminal commands, to bootstrap a resource that a provider </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">created before</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.550.1">The following diagram demonstrates what we have described and shows how different Terraform components communicate internally </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">and externally:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer064">
<span class="koboSpan" id="kobo.552.1"><img alt="Figure 7.3 – Terraform high-level diagram" src="image/B16971_07_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.553.1">Figure 7.3 – Terraform high-level diagram</span></p>
<p><span class="koboSpan" id="kobo.554.1">The vast majority of Terraform</span><a id="_idIndexMarker659"/><span class="koboSpan" id="kobo.555.1"> plugins are providers as they implement the declarative resource actuation and communicate with an upstream API. </span><span class="koboSpan" id="kobo.555.2">A provider defines two types of objects that you can use to interact with a </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">remote API:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.557.1">Resources</span></strong><span class="koboSpan" id="kobo.558.1">: Represent the actual </span><a id="_idIndexMarker660"/><span class="koboSpan" id="kobo.559.1">managed infrastructure objects, such as virtual machines, firewall policies, and </span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">DNS records</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.561.1">Data Sources</span></strong><span class="koboSpan" id="kobo.562.1">: Offer a way to </span><a id="_idIndexMarker661"/><span class="koboSpan" id="kobo.563.1">query information that is not managed by Terraform, such as a list of </span><a id="_idIndexMarker662"/><span class="koboSpan" id="kobo.564.1">supported cloud regions, VM images, or </span><strong class="bold"><span class="koboSpan" id="kobo.565.1">Identity and Access Management</span></strong><span class="koboSpan" id="kobo.566.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.567.1">IAM</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">) roles</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.569.1">It’s up to the Terraform provider maintainers to decide what resources and data sources to implement, so the coverage may vary, especially between official and </span><span class="No-Break"><span class="koboSpan" id="kobo.570.1">community-supported providers.</span></span></p>
<h2 id="_idParaDest-172"><a id="_idTextAnchor171"/><span class="koboSpan" id="kobo.571.1">Working with Terraform</span></h2>
<p><span class="koboSpan" id="kobo.572.1">A typical Terraform workflow involves </span><a id="_idIndexMarker663"/><span class="koboSpan" id="kobo.573.1">several stages that need to happen in sequence. </span><span class="koboSpan" id="kobo.573.2">We first need to define a provider that determines what infrastructure we would manage, and then describe the state of our infrastructure using a combination of resources and data sources. </span><span class="koboSpan" id="kobo.573.3">We will walk through these stages by following a configuration file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">ch07/terraform/main.tf</span></strong><span class="koboSpan" id="kobo.575.1">, we’ve created in this book’s GitHub repository (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.576.1">Further reading</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.577.1">).</span></span></p>
<h3><span class="koboSpan" id="kobo.578.1">Defining a provider</span></h3>
<p><span class="koboSpan" id="kobo.579.1">Providers define connection</span><a id="_idIndexMarker664"/><span class="koboSpan" id="kobo.580.1"> details for the upstream API. </span><span class="koboSpan" id="kobo.580.2">They can point at the public AWS API URL or an address of a private vCenter instance. </span><span class="koboSpan" id="kobo.580.3">In the next example, we show how</span><a id="_idIndexMarker665"/><span class="koboSpan" id="kobo.581.1"> to manage the demo instance of Nautobot running </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">at </span></span><a href="https://demo.nautobot.com/"><span class="No-Break"><span class="koboSpan" id="kobo.583.1">https://demo.nautobot.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.584.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.585.1">Terraform expects to find a list of required providers, along with their definition, in one file in the current working directory. </span><span class="koboSpan" id="kobo.585.2">For the sake of simplicity, we include those details at the top of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">main.tf</span></strong><span class="koboSpan" id="kobo.587.1"> file and define credentials in the same file. </span><span class="koboSpan" id="kobo.587.2">In production environments, these details may live in a separate file, and you should source credentials externally, for example, from </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">environment variables:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.589.1">terraform {
  required_providers {
    nautobot = {
      version = "0.2.4"
      source  = "nleiva/nautobot"
    }
  }
}
provider "nautobot" {
  url = "https://demo.nautobot.com/api/"
  token = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
}</span></pre>
<p><span class="koboSpan" id="kobo.590.1">With this information defined, we</span><a id="_idIndexMarker666"/><span class="koboSpan" id="kobo.591.1"> can initialize Terraform. </span><span class="koboSpan" id="kobo.591.2">The following command instructs Terraform to perform plugin discovery and download any dependencies into a local </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">./</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">terraform</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.594.1"> directory:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.595.1">ch07/terraform</span><span class="Code_Blue"><span class="koboSpan" id="kobo.596.1">$ terraform</span></span><span class="koboSpan" id="kobo.597.1"> init </span><span class="Code_Blue"><span class="koboSpan" id="kobo.598.1">-upgrade</span></span><span class="koboSpan" id="kobo.599.1">
Initializing the backend...
</span><span class="koboSpan" id="kobo.599.2">Initializing provider plugins...
</span><span class="koboSpan" id="kobo.599.3">- Finding nleiva/nautobot versions matching </span><span class="Code_Red"><span class="koboSpan" id="kobo.600.1">"0.2.4"</span></span><span class="koboSpan" id="kobo.601.1">...
</span><span class="koboSpan" id="kobo.601.2">- Installing nleiva/nautobot v0.2.4...
</span><span class="koboSpan" id="kobo.601.3">- Installed nleiva/nautobot v0.2.4 (self-signed, key ID A33D26E300F155FF)</span></pre>
<p><span class="koboSpan" id="kobo.602.1">At the end of this step, Terraform creates a lock file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">.terraform.lock.hcl</span></strong><span class="koboSpan" id="kobo.604.1">, to record the provider selections it just made. </span><span class="koboSpan" id="kobo.604.2">Include this file in your version control repository so that Terraform can guarantee to make the same selections by default when you run </span><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">terraform init</span></strong><span class="koboSpan" id="kobo.606.1"> on a </span><span class="No-Break"><span class="koboSpan" id="kobo.607.1">different machine.</span></span></p>
<h3><span class="koboSpan" id="kobo.608.1">Creating a resource</span></h3>
<p><span class="koboSpan" id="kobo.609.1">To create a resource, we define it in a </span><a id="_idIndexMarker667"/><span class="koboSpan" id="kobo.610.1">configuration block with zero or more arguments that assign values to resource fields. </span><span class="koboSpan" id="kobo.610.2">The following resource creates a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.611.1">Manufacturer</span></strong><span class="koboSpan" id="kobo.612.1"> object in Nautobot with the specified name </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">and description:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.614.1">resource "nautobot_manufacturer" "new" {
  description = "Created with Terraform"
  name        = "New Vendor"
}</span></pre>
<p><span class="koboSpan" id="kobo.615.1">Now we can run </span><strong class="source-inline"><span class="koboSpan" id="kobo.616.1">terraform plan</span></strong><span class="koboSpan" id="kobo.617.1"> to check whether the current configuration matches the existing state. </span><span class="koboSpan" id="kobo.617.2">If they don’t match, Terraform creates an execution plan with the proposed changes to make the remote objects match the current configuration. </span><span class="koboSpan" id="kobo.617.3">We could skip the </span><strong class="source-inline"><span class="koboSpan" id="kobo.618.1">terraform plan</span></strong><span class="koboSpan" id="kobo.619.1"> command and move straight to </span><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">terraform apply</span></strong><span class="koboSpan" id="kobo.621.1">, which</span><a id="_idIndexMarker668"/><span class="koboSpan" id="kobo.622.1"> generates the plan and also executes it in a </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">single step:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.624.1">ch07/terraform</span><span class="Code_Blue"><span class="koboSpan" id="kobo.625.1">$ terraform</span></span><span class="koboSpan" id="kobo.626.1"> apply </span><span class="Code_Blue"><span class="koboSpan" id="kobo.627.1">--auto-approve</span></span><span class="koboSpan" id="kobo.628.1">
Terraform used the selected providers to generate the following execution plan. </span><span class="koboSpan" id="kobo.628.2">Resource actions
are indicated with the following symbols:
  + create
Terraform will perform the following actions:
  </span><span class="Code_Brown"><span class="koboSpan" id="kobo.629.1"># nautobot_manufacturer.new will be created</span></span><span class="koboSpan" id="kobo.630.1">
  + resource </span><span class="Code_Red"><span class="koboSpan" id="kobo.631.1">"nautobot_manufacturer" "new"</span></span><span class="Code_Blue"> </span><span class="koboSpan" id="kobo.632.1">{
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.633.1">+</span></span><span class="koboSpan" id="kobo.634.1"> created             </span><span class="Code_Red"><span class="koboSpan" id="kobo.635.1">=</span></span><span class="koboSpan" id="kobo.636.1"> (known after apply)
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.637.1">+</span></span><span class="koboSpan" id="kobo.638.1"> description         </span><span class="Code_Red"><span class="koboSpan" id="kobo.639.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.640.1">"Created with Terraform"</span></span><span class="koboSpan" id="kobo.641.1">
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.642.1">+</span></span><span class="koboSpan" id="kobo.643.1"> devicetype_count    </span><span class="Code_Red"><span class="koboSpan" id="kobo.644.1">=</span></span><span class="koboSpan" id="kobo.645.1"> (known after apply)
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.646.1">+</span></span><span class="koboSpan" id="kobo.647.1"> display             </span><span class="Code_Red"><span class="koboSpan" id="kobo.648.1">=</span></span><span class="koboSpan" id="kobo.649.1"> (known after apply)
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.650.1">+</span></span><span class="koboSpan" id="kobo.651.1"> id                  </span><span class="Code_Red"><span class="koboSpan" id="kobo.652.1">=</span></span><span class="koboSpan" id="kobo.653.1"> (known after apply)
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.654.1">+</span></span><span class="koboSpan" id="kobo.655.1"> inventoryitem_count </span><span class="Code_Red"><span class="koboSpan" id="kobo.656.1">=</span></span><span class="koboSpan" id="kobo.657.1"> (known after apply)
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.658.1">+</span></span><span class="koboSpan" id="kobo.659.1"> last_updated        </span><span class="Code_Red"><span class="koboSpan" id="kobo.660.1">=</span></span><span class="koboSpan" id="kobo.661.1"> (known after apply)
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.662.1">+</span></span><span class="koboSpan" id="kobo.663.1"> name                </span><span class="Code_Red"><span class="koboSpan" id="kobo.664.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.665.1">"New Vendor"</span></span><span class="koboSpan" id="kobo.666.1">
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.667.1">+</span></span><span class="koboSpan" id="kobo.668.1"> platform_count      </span><span class="Code_Red"><span class="koboSpan" id="kobo.669.1">=</span></span><span class="koboSpan" id="kobo.670.1"> (known after apply)
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.671.1">+</span></span><span class="koboSpan" id="kobo.672.1"> slug                </span><span class="Code_Red"><span class="koboSpan" id="kobo.673.1">=</span></span><span class="koboSpan" id="kobo.674.1"> (known after apply)
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.675.1">+</span></span><span class="koboSpan" id="kobo.676.1"> url                 </span><span class="Code_Red"><span class="koboSpan" id="kobo.677.1">=</span></span><span class="koboSpan" id="kobo.678.1"> (known after apply)
    }
Plan: </span><span class="Code_Green"><span class="koboSpan" id="kobo.679.1">1</span></span><span class="koboSpan" id="kobo.680.1"> to add, </span><span class="Code_Green"><span class="koboSpan" id="kobo.681.1">0</span></span><span class="koboSpan" id="kobo.682.1"> to change, </span><span class="Code_Green"><span class="koboSpan" id="kobo.683.1">0</span></span><span class="koboSpan" id="kobo.684.1"> to destroy.</span></pre>
<p><span class="koboSpan" id="kobo.685.1">You can see the result of running</span><a id="_idIndexMarker669"/><span class="koboSpan" id="kobo.686.1"> this plan in Nautobot’s web UI at </span><a href="https://demo.nautobot.com/dcim/manufacturers/new-vendor/"><span class="koboSpan" id="kobo.687.1">https://demo.nautobot.com/dcim/manufacturers/new-vendor/</span></a><span class="koboSpan" id="kobo.688.1">, or you can check the resulting state using the </span><span class="No-Break"><span class="koboSpan" id="kobo.689.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.690.1">ch07/terraform</span><span class="Code_Blue"><span class="koboSpan" id="kobo.691.1">$ terraform</span></span><span class="koboSpan" id="kobo.692.1"> state show </span><span class="Code_Red"><span class="koboSpan" id="kobo.693.1">'nautobot_manufacturer.new'</span></span>
<span class="Code_Brown"><span class="koboSpan" id="kobo.694.1"># nautobot_manufacturer.new:</span></span><span class="koboSpan" id="kobo.695.1">
resource </span><span class="Code_Red"><span class="koboSpan" id="kobo.696.1">"nautobot_manufacturer" "new"</span></span><span class="Code_Blue"> </span><span class="koboSpan" id="kobo.697.1">{
    created             </span><span class="Code_Red"><span class="koboSpan" id="kobo.698.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.699.1">"2022-05-04"</span></span><span class="koboSpan" id="kobo.700.1">
    description         </span><span class="Code_Red"><span class="koboSpan" id="kobo.701.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.702.1">"Created with Terraform"</span></span><span class="koboSpan" id="kobo.703.1">
    devicetype_count    </span><span class="Code_Red"><span class="koboSpan" id="kobo.704.1">=</span></span> <span class="Code_Green"><span class="koboSpan" id="kobo.705.1">0</span></span><span class="koboSpan" id="kobo.706.1">
    display             </span><span class="Code_Red"><span class="koboSpan" id="kobo.707.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.708.1">"New Vendor"</span></span><span class="koboSpan" id="kobo.709.1">
    id                  </span><span class="Code_Red"><span class="koboSpan" id="kobo.710.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.711.1">"09219670-3e28-..."</span></span><span class="koboSpan" id="kobo.712.1">
    inventoryitem_count </span><span class="Code_Red"><span class="koboSpan" id="kobo.713.1">=</span></span> <span class="Code_Green"><span class="koboSpan" id="kobo.714.1">0</span></span><span class="koboSpan" id="kobo.715.1">
    last_updated        </span><span class="Code_Red"><span class="koboSpan" id="kobo.716.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.717.1">"2022-05-04T18:29:06.241771Z"</span></span><span class="koboSpan" id="kobo.718.1">
    name                </span><span class="Code_Red"><span class="koboSpan" id="kobo.719.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.720.1">"New Vendor"</span></span><span class="koboSpan" id="kobo.721.1">
    platform_count      </span><span class="Code_Red"><span class="koboSpan" id="kobo.722.1">=</span></span> <span class="Code_Green"><span class="koboSpan" id="kobo.723.1">0</span></span><span class="koboSpan" id="kobo.724.1">
    slug                </span><span class="Code_Red"><span class="koboSpan" id="kobo.725.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.726.1">"new-vendor"</span></span><span class="koboSpan" id="kobo.727.1">
    url                 </span><span class="Code_Red"><span class="koboSpan" id="kobo.728.1">=</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.729.1">"https://demo.nautobot.com/api/dcim/manufacturers/09219670-3e28-.../"</span></span><span class="koboSpan" id="kobo.730.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.731.1">At the time of writing, there was no Terraform provider available for Nautobot, so the last example used a custom provider we created specifically for this book. </span><span class="koboSpan" id="kobo.731.2">Creating a new provider can enable many </span><a id="_idIndexMarker670"/><span class="koboSpan" id="kobo.732.1">new use cases and it involves writing Go code, so this is what we </span><span class="No-Break"><span class="koboSpan" id="kobo.733.1">cover next.</span></span></p>
<h2 id="_idParaDest-173"><a id="_idTextAnchor172"/><span class="koboSpan" id="kobo.734.1">Developing a Terraform provider</span></h2>
<p><span class="koboSpan" id="kobo.735.1">Eventually, you may come </span><a id="_idIndexMarker671"/><span class="koboSpan" id="kobo.736.1">across a provider with limited or missing capabilities, or a provider may not even exist for a platform that is part of your infrastructure. </span><span class="koboSpan" id="kobo.736.2">This is when knowing how to build a provider can make a difference, to either extend or fix a provider or build a brand new one. </span><span class="koboSpan" id="kobo.736.3">The only prerequisite to get started is the availability of a Go SDK for the target platform. </span><span class="koboSpan" id="kobo.736.4">For example, Nautobot has a Go client package that gets automatically generated from its OpenAPI model, which we used already in the </span><em class="italic"><span class="koboSpan" id="kobo.737.1">Getting config inputs from other systems via HTTP</span></em><span class="koboSpan" id="kobo.738.1"> section of </span><a href="B16971_06.xhtml#_idTextAnchor144"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.739.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.740.1">, </span><em class="italic"><span class="koboSpan" id="kobo.741.1">Configuration Management</span></em><span class="koboSpan" id="kobo.742.1">, so we have all we need to develop its </span><span class="No-Break"><span class="koboSpan" id="kobo.743.1">Terraform provider.</span></span></p>
<p><span class="koboSpan" id="kobo.744.1">The recommended way to create a new Terraform provider is to start with the terraform-provider-scaffolding project (see </span><em class="italic"><span class="koboSpan" id="kobo.745.1">Further reading</span></em><span class="koboSpan" id="kobo.746.1">). </span><span class="koboSpan" id="kobo.746.2">This repository provides enough boilerplate</span><a id="_idIndexMarker672"/><span class="koboSpan" id="kobo.747.1"> to allow you to focus on the internal logic while it provides function stubs and implements </span><strong class="bold"><span class="koboSpan" id="kobo.748.1">Remote Procedure Call</span></strong><span class="koboSpan" id="kobo.749.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.750.1">RPC</span></strong><span class="koboSpan" id="kobo.751.1">) integration. </span><span class="koboSpan" id="kobo.751.2">We used this template to create the Nautobot provider, so you can compare our final result with the template to see what changes </span><span class="No-Break"><span class="koboSpan" id="kobo.752.1">we made.</span></span></p>
<p><span class="koboSpan" id="kobo.753.1">As a by-product of developing a Terraform provider using the scaffolding project, you can register your Git repository in the Terraform registry and get the benefit of automatically rendered provider documentation (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.754.1">Further reading</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">).</span></span></p>
<h3><span class="koboSpan" id="kobo.756.1">Defining a provider</span></h3>
<p><span class="koboSpan" id="kobo.757.1">The provider’s internal code (</span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">internal/provider/provider.go</span></strong><span class="koboSpan" id="kobo.759.1"> (see </span><em class="italic"><span class="koboSpan" id="kobo.760.1">Further reading</span></em><span class="koboSpan" id="kobo.761.1">)) starts with a schema </span><a id="_idIndexMarker673"/><span class="koboSpan" id="kobo.762.1">definition for the provider itself as well as its managed resources and data sources. </span><span class="koboSpan" id="kobo.762.2">Inside the provider’s schema, we define two input arguments—</span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">url</span></strong><span class="koboSpan" id="kobo.764.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.765.1">token</span></strong><span class="koboSpan" id="kobo.766.1">. </span><span class="koboSpan" id="kobo.766.2">You can extend each schema struct with more constraints, default values, and </span><span class="No-Break"><span class="koboSpan" id="kobo.767.1">validation functions:</span></span></p>
<pre class="source-code"><span class="Code_Purple"><span class="koboSpan" id="kobo.768.1">func</span></span><span class="koboSpan" id="kobo.769.1"> New(version </span><span class="Code_Purple"><span class="koboSpan" id="kobo.770.1">string</span></span><span class="koboSpan" id="kobo.771.1">) </span><span class="Code_Purple"><span class="koboSpan" id="kobo.772.1">func</span></span><span class="koboSpan" id="kobo.773.1">() </span><span class="Code_Red"><span class="koboSpan" id="kobo.774.1">*</span></span><span class="koboSpan" id="kobo.775.1">schema.Provider {
  </span><span class="Code_Purple"><span class="koboSpan" id="kobo.776.1">return func</span></span><span class="koboSpan" id="kobo.777.1">() </span><span class="Code_Red"><span class="koboSpan" id="kobo.778.1">*</span></span><span class="koboSpan" id="kobo.779.1">schema.Provider {
    p :</span><span class="Code_Red"><span class="koboSpan" id="kobo.780.1">= &amp;</span></span><span class="koboSpan" id="kobo.781.1">schema.Provider{
      Schema: </span><span class="Code_Purple"><span class="koboSpan" id="kobo.782.1">map</span></span><span class="koboSpan" id="kobo.783.1">[</span><span class="Code_Purple"><span class="koboSpan" id="kobo.784.1">string</span></span><span class="koboSpan" id="kobo.785.1">]</span><span class="Code_Red"><span class="koboSpan" id="kobo.786.1">*</span></span><span class="koboSpan" id="kobo.787.1">schema.Schema{
        </span><span class="Code_Red"><span class="koboSpan" id="kobo.788.1">"url"</span></span><span class="koboSpan" id="kobo.789.1">: {
          Type:         schema.TypeString,
          Required:     </span><span class="Code_Blue"><span class="koboSpan" id="kobo.790.1">true</span></span><span class="koboSpan" id="kobo.791.1">,
          DefaultFunc:
          schema.EnvDefaultFunc(</span><span class="Code_Red"><span class="koboSpan" id="kobo.792.1">"NAUTOBOT_URL"</span></span><span class="koboSpan" id="kobo.793.1">, </span><span class="Code_Blue"><span class="koboSpan" id="kobo.794.1">nil</span></span><span class="koboSpan" id="kobo.795.1">),
          ValidateFunc: validation.IsURLWithHTTPorHTTPS,
          Description:  </span><span class="Code_Red"><span class="koboSpan" id="kobo.796.1">"Nautobot API URL"</span></span><span class="koboSpan" id="kobo.797.1">,
        },
        </span><span class="Code_Red"><span class="koboSpan" id="kobo.798.1">"token"</span></span><span class="koboSpan" id="kobo.799.1">: {
          Type:        schema.TypeString,
          Required:    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.800.1">true</span></span><span class="koboSpan" id="kobo.801.1">,
          Sensitive:   </span><span class="Code_Blue"><span class="koboSpan" id="kobo.802.1">true</span></span><span class="koboSpan" id="kobo.803.1">,
          DefaultFunc:
            schema.EnvDefaultFunc(</span><span class="Code_Red"><span class="koboSpan" id="kobo.804.1">"NAUTOBOT_TOKEN"</span></span><span class="koboSpan" id="kobo.805.1">, </span><span class="Code_Blue"><span class="koboSpan" id="kobo.806.1">nil</span></span><span class="koboSpan" id="kobo.807.1">),
          Description:</span><span class="Code_Blue"> </span><span class="Code_Red"><span class="koboSpan" id="kobo.808.1">"Admin API token"</span></span><span class="koboSpan" id="kobo.809.1">,
        },
      },
      DataSourcesMap: </span><span class="Code_Purple"><span class="koboSpan" id="kobo.810.1">map</span></span><span class="koboSpan" id="kobo.811.1">[</span><span class="Code_Purple"><span class="koboSpan" id="kobo.812.1">string</span></span><span class="koboSpan" id="kobo.813.1">]</span><span class="Code_Red"><span class="koboSpan" id="kobo.814.1">*</span></span><span class="koboSpan" id="kobo.815.1">schema.Resource{
        </span><span class="Code_Red"><span class="koboSpan" id="kobo.816.1">"nautobot_manufacturers"</span></span><span class="koboSpan" id="kobo.817.1">:
            dataSourceManufacturers(),
      },
      ResourcesMap: </span><span class="Code_Purple"><span class="koboSpan" id="kobo.818.1">map</span></span><span class="koboSpan" id="kobo.819.1">[</span><span class="Code_Purple"><span class="koboSpan" id="kobo.820.1">string</span></span><span class="koboSpan" id="kobo.821.1">]</span><span class="Code_Red"><span class="koboSpan" id="kobo.822.1">*</span></span><span class="koboSpan" id="kobo.823.1">schema.Resource{
        </span><span class="Code_Red"><span class="koboSpan" id="kobo.824.1">"nautobot_manufacturer"</span></span><span class="koboSpan" id="kobo.825.1">: resourceManufacturer(),
      },
    }
    p.ConfigureContextFunc = configure(version, p)
    </span><span class="Code_Purple"><span class="koboSpan" id="kobo.826.1">return</span></span><span class="koboSpan" id="kobo.827.1"> p
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.828.1">With login information defined, the provider can initialize an API client for the target platform. </span><span class="koboSpan" id="kobo.828.2">This happens inside a</span><a id="_idIndexMarker674"/><span class="koboSpan" id="kobo.829.1"> local function where </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">url</span></strong><span class="koboSpan" id="kobo.831.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">token</span></strong><span class="koboSpan" id="kobo.833.1"> get passed to the Nautobot’s Go SDK, which creates a fully authenticated HTTP client. </span><span class="koboSpan" id="kobo.833.2">We save this client in a special </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">apiClient</span></strong><span class="koboSpan" id="kobo.835.1"> struct, which gets passed as an argument to all provider resources, as we show </span><span class="No-Break"><span class="koboSpan" id="kobo.836.1">later on:</span></span></p>
<pre class="source-code"><span class="Code_Purple"><span class="koboSpan" id="kobo.837.1">import</span></span><span class="koboSpan" id="kobo.838.1"> nb </span><span class="Code_Red"><span class="koboSpan" id="kobo.839.1">"github.com/nautobot/go-nautobot"</span></span>
<span class="Code_Purple"><span class="koboSpan" id="kobo.840.1">type</span></span><span class="koboSpan" id="kobo.841.1"> apiClient </span><span class="Code_Purple"><span class="koboSpan" id="kobo.842.1">struct</span></span><span class="koboSpan" id="kobo.843.1"> {
  Client </span><span class="Code_Red"><span class="koboSpan" id="kobo.844.1">*</span></span><span class="koboSpan" id="kobo.845.1">nb.ClientWithResponses
  Server </span><span class="Code_Purple"><span class="koboSpan" id="kobo.846.1">string</span></span><span class="koboSpan" id="kobo.847.1">
}
</span><span class="Code_Purple"><span class="koboSpan" id="kobo.848.1">func</span></span><span class="koboSpan" id="kobo.849.1"> configure(
  version </span><span class="Code_Purple"><span class="koboSpan" id="kobo.850.1">string</span></span><span class="koboSpan" id="kobo.851.1">,
  p </span><span class="Code_Red"><span class="koboSpan" id="kobo.852.1">*</span></span><span class="koboSpan" id="kobo.853.1">schema.Provider,
) </span><span class="Code_Purple"><span class="koboSpan" id="kobo.854.1">func</span></span><span class="koboSpan" id="kobo.855.1">(context.Context, </span><span class="Code_Red"><span class="koboSpan" id="kobo.856.1">*</span></span><span class="koboSpan" id="kobo.857.1">schema.ResourceData) (</span><span class="Code_Purple"><span class="koboSpan" id="kobo.858.1">interface</span></span><span class="koboSpan" id="kobo.859.1">{}, diag.Diagnostics) {
  </span><span class="Code_Purple"><span class="koboSpan" id="kobo.860.1">return func</span></span><span class="koboSpan" id="kobo.861.1">(ctx context.Context, d </span><span class="Code_Red"><span class="koboSpan" id="kobo.862.1">*</span></span><span class="koboSpan" id="kobo.863.1">schema.ResourceData) (</span><span class="Code_Purple"><span class="koboSpan" id="kobo.864.1">interface</span></span><span class="koboSpan" id="kobo.865.1">{}, diag.Diagnostics) {
    serverURL :</span><span class="Code_Red"><span class="koboSpan" id="kobo.866.1">=</span></span><span class="koboSpan" id="kobo.867.1"> d.Get(</span><span class="Code_Red"><span class="koboSpan" id="kobo.868.1">"url"</span></span><span class="koboSpan" id="kobo.869.1">).(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.870.1">string</span></span><span class="koboSpan" id="kobo.871.1">)
    _, hasToken :</span><span class="Code_Red"><span class="koboSpan" id="kobo.872.1">=</span></span><span class="koboSpan" id="kobo.873.1"> d.GetOk(</span><span class="Code_Red"><span class="koboSpan" id="kobo.874.1">"token"</span></span><span class="koboSpan" id="kobo.875.1">)
    </span><span class="Code_Brown"><span class="koboSpan" id="kobo.876.1">/* ... </span><span class="koboSpan" id="kobo.876.2">&lt;omitted for brevity &gt; ... </span><span class="koboSpan" id="kobo.876.3">*/</span></span><span class="koboSpan" id="kobo.877.1">
    token, _ :</span><span class="Code_Red"><span class="koboSpan" id="kobo.878.1">=</span></span><span class="koboSpan" id="kobo.879.1">
        NewSecurityProviderNautobotToken(
          d.Get(</span><span class="Code_Red"><span class="koboSpan" id="kobo.880.1">"token"</span></span><span class="koboSpan" id="kobo.881.1">).(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.882.1">string</span></span><span class="koboSpan" id="kobo.883.1">))
    c, err :</span><span class="Code_Red"><span class="koboSpan" id="kobo.884.1">=</span></span><span class="koboSpan" id="kobo.885.1"> nb.NewClientWithResponses(
              serverURL,
              nb.WithRequestEditorFn(token.Intercept),
            )
    </span><span class="Code_Brown"><span class="koboSpan" id="kobo.886.1">// process error</span></span><span class="koboSpan" id="kobo.887.1">
    </span><span class="Code_Purple"><span class="koboSpan" id="kobo.888.1">return</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.889.1">&amp;</span></span><span class="koboSpan" id="kobo.890.1">apiClient{
      Client: c,
      Server: serverURL,
    }, diags
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.891.1">Now that we have</span><a id="_idIndexMarker675"/><span class="koboSpan" id="kobo.892.1"> prepared a remote API client, we can start writing code for our </span><span class="No-Break"><span class="koboSpan" id="kobo.893.1">managed resources.</span></span></p>
<h3><span class="koboSpan" id="kobo.894.1">Defining resources</span></h3>
<p><span class="koboSpan" id="kobo.895.1">Just like how we defined a </span><a id="_idIndexMarker676"/><span class="koboSpan" id="kobo.896.1">schema for our provider, we now need to define a schema for each managed resource and data source. </span><span class="koboSpan" id="kobo.896.2">For educational purposes, we only implement a single resource type, </span><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">Manufacturer</span></strong><span class="koboSpan" id="kobo.898.1">, and a corresponding data source you can use to retrieve the list of all existing manufacturers </span><span class="No-Break"><span class="koboSpan" id="kobo.899.1">in Nautobot.</span></span></p>
<p><span class="koboSpan" id="kobo.900.1">When we define a schema, our goal is to match the upstream API as closely as possible. </span><span class="koboSpan" id="kobo.900.2">This should reduce the </span><a id="_idIndexMarker677"/><span class="koboSpan" id="kobo.901.1">number of required data transformations and make the implementation work much easier. </span><span class="koboSpan" id="kobo.901.2">Let’s look at Nautobot’s Go </span><span class="No-Break"><span class="koboSpan" id="kobo.902.1">SDK code:</span></span></p>
<pre class="source-code"><span class="Code_Purple"><span class="koboSpan" id="kobo.903.1">type</span></span><span class="koboSpan" id="kobo.904.1"> Manufacturer </span><span class="Code_Purple"><span class="koboSpan" id="kobo.905.1">struct</span></span><span class="koboSpan" id="kobo.906.1"> {
  Created       </span><span class="Code_Red"><span class="koboSpan" id="kobo.907.1">*</span></span><span class="koboSpan" id="kobo.908.1">openapi_types.Date
    </span><span class="Code_Red"><span class="koboSpan" id="kobo.909.1">`json:"created,omitempty"`</span></span><span class="koboSpan" id="kobo.910.1">
  CustomFields  *Manufacturer_CustomFields
    </span><span class="Code_Red"><span class="koboSpan" id="kobo.911.1">`json:"custom_fields,omitempty"`</span></span><span class="koboSpan" id="kobo.912.1">
  Description   *</span><span class="Code_Purple"><span class="koboSpan" id="kobo.913.1">string</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.914.1"> `json:"description,omitempty"`</span></span><span class="koboSpan" id="kobo.915.1">
  </span><span class="Code_Brown"><span class="koboSpan" id="kobo.916.1">/* ... </span><span class="koboSpan" id="kobo.916.2">&lt;omitted for brevity &gt; ... </span><span class="koboSpan" id="kobo.916.3">*/</span></span><span class="koboSpan" id="kobo.917.1">
  Url           *</span><span class="Code_Purple"><span class="koboSpan" id="kobo.918.1">string</span></span><span class="Code_Red"><span class="koboSpan" id="kobo.919.1"> `json:"url,omitempty"`</span></span><span class="koboSpan" id="kobo.920.1">
}
</span><span class="Code_Purple"><span class="koboSpan" id="kobo.921.1">type</span></span><span class="koboSpan" id="kobo.922.1"> Manufacturer_CustomFields </span><span class="Code_Purple"><span class="koboSpan" id="kobo.923.1">struct</span></span><span class="koboSpan" id="kobo.924.1"> {
  AdditionalProperties </span><span class="Code_Purple"><span class="koboSpan" id="kobo.925.1">map</span></span><span class="koboSpan" id="kobo.926.1">[</span><span class="Code_Purple"><span class="koboSpan" id="kobo.927.1">string</span></span><span class="koboSpan" id="kobo.928.1">]</span><span class="Code_Purple"><span class="koboSpan" id="kobo.929.1">interface</span></span><span class="koboSpan" id="kobo.930.1">{} </span><span class="Code_Red"><span class="koboSpan" id="kobo.931.1">`json:"-"`</span></span><span class="koboSpan" id="kobo.932.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.933.1">The schema that we define for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">Manufacturer</span></strong><span class="koboSpan" id="kobo.935.1"> resource in </span><strong class="source-inline"><span class="koboSpan" id="kobo.936.1">resource_manufacturer.go</span></strong><span class="koboSpan" id="kobo.937.1"> closely follows the fields and types defined in the </span><span class="No-Break"><span class="koboSpan" id="kobo.938.1">preceding output:</span></span></p>
<pre class="source-code"><span class="Code_Purple"><span class="koboSpan" id="kobo.939.1">func</span></span><span class="koboSpan" id="kobo.940.1"> resourceManufacturer() </span><span class="Code_Red"><span class="koboSpan" id="kobo.941.1">*</span></span><span class="koboSpan" id="kobo.942.1">schema.Resource {
  </span><span class="Code_Purple"><span class="koboSpan" id="kobo.943.1">return</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.944.1">&amp;</span></span><span class="koboSpan" id="kobo.945.1">schema.Resource{
    Description: </span><span class="Code_Red"><span class="koboSpan" id="kobo.946.1">"This object manages a manufacturer"</span></span><span class="koboSpan" id="kobo.947.1">,
    CreateContext: resourceManufacturerCreate,
    ReadContext:   resourceManufacturerRead,
    UpdateContext: resourceManufacturerUpdate,
    DeleteContext: resourceManufacturerDelete,
    Schema: </span><span class="Code_Purple"><span class="koboSpan" id="kobo.948.1">map</span></span><span class="koboSpan" id="kobo.949.1">[</span><span class="Code_Purple"><span class="koboSpan" id="kobo.950.1">string</span></span><span class="koboSpan" id="kobo.951.1">]</span><span class="Code_Red"><span class="koboSpan" id="kobo.952.1">*</span></span><span class="koboSpan" id="kobo.953.1">schema.Schema{
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.954.1">"created"</span></span><span class="koboSpan" id="kobo.955.1">: {
        Description: </span><span class="Code_Red"><span class="koboSpan" id="kobo.956.1">"Manufacturer's creation date."</span></span><span class="koboSpan" id="kobo.957.1">,
        Type:        schema.TypeString,
        Computed:    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.958.1">true</span></span><span class="koboSpan" id="kobo.959.1">,
      },
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.960.1">"description"</span></span><span class="koboSpan" id="kobo.961.1">: {
        Description: </span><span class="Code_Red"><span class="koboSpan" id="kobo.962.1">"Manufacturer's description."</span></span><span class="koboSpan" id="kobo.963.1">,
        Type:        schema.TypeString,
        Optional:    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.964.1">true</span></span><span class="koboSpan" id="kobo.965.1">,
      },
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.966.1">"custom_fields"</span></span><span class="koboSpan" id="kobo.967.1">: {
        Description: </span><span class="Code_Red"><span class="koboSpan" id="kobo.968.1">"Manufacturer custom fields."</span></span><span class="koboSpan" id="kobo.969.1">,
        Type:        schema.TypeMap,
        Optional:    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.970.1">true</span></span><span class="koboSpan" id="kobo.971.1">,
      },
      </span><span class="Code_Brown"><span class="koboSpan" id="kobo.972.1">/* ... </span><span class="koboSpan" id="kobo.972.2">&lt;omitted for brevity &gt; ... </span><span class="koboSpan" id="kobo.972.3">*/</span></span><span class="koboSpan" id="kobo.973.1">
      </span><span class="Code_Red"><span class="koboSpan" id="kobo.974.1">"url"</span></span><span class="koboSpan" id="kobo.975.1">: {
        Description: </span><span class="Code_Red"><span class="koboSpan" id="kobo.976.1">"Manufacturer's URL."</span></span><span class="koboSpan" id="kobo.977.1">,
        Type:        schema.TypeString,
        Optional:    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.978.1">true</span></span><span class="koboSpan" id="kobo.979.1">,
        Computed:    </span><span class="Code_Blue"><span class="koboSpan" id="kobo.980.1">true</span></span><span class="koboSpan" id="kobo.981.1">,
      },
    },
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.982.1">Once we have defined all schemas with their constraints, types, and descriptions, we can start implementing</span><a id="_idIndexMarker678"/><span class="koboSpan" id="kobo.983.1"> resource operations. </span><span class="koboSpan" id="kobo.983.2">The scaffolding project provides stubs for each one of the CRUD functions, so we only need to fill them out </span><span class="No-Break"><span class="koboSpan" id="kobo.984.1">with code.</span></span></p>
<h3><span class="koboSpan" id="kobo.985.1">The create operation</span></h3>
<p><span class="koboSpan" id="kobo.986.1">We first look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.987.1">resourceManufacturerCreate</span></strong><span class="koboSpan" id="kobo.988.1"> function, which gets invoked when Terraform</span><a id="_idIndexMarker679"/><span class="koboSpan" id="kobo.989.1"> determines that it must create a new object. </span><span class="koboSpan" id="kobo.989.2">This function has two very </span><span class="No-Break"><span class="koboSpan" id="kobo.990.1">important arguments:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.991.1">meta</span></strong><span class="koboSpan" id="kobo.992.1">: Stores the API client we </span><span class="No-Break"><span class="koboSpan" id="kobo.993.1">created earlier</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.994.1">d</span></strong><span class="koboSpan" id="kobo.995.1">: Stores all resource arguments defined in the HCL </span><span class="No-Break"><span class="koboSpan" id="kobo.996.1">configuration file</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.997.1">We extract the user-defined configuration from </span><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">d</span></strong><span class="koboSpan" id="kobo.999.1"> and use it to build a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">nb.Manufacturer</span></strong><span class="koboSpan" id="kobo.1001.1"> object from the Nautobot’s SDK. </span><span class="koboSpan" id="kobo.1001.2">We can then use the API client to send that object to Nautobot and save the returned </span><span class="No-Break"><span class="koboSpan" id="kobo.1002.1">object ID:</span></span></p>
<pre class="source-code"><span class="Code_Purple"><span class="koboSpan" id="kobo.1003.1">func</span></span><span class="koboSpan" id="kobo.1004.1"> resourceManufacturerCreate(ctx context.Context, d </span><span class="Code_Red"><span class="koboSpan" id="kobo.1005.1">*</span></span><span class="koboSpan" id="kobo.1006.1">schema.ResourceData, meta </span><span class="Code_Purple"><span class="koboSpan" id="kobo.1007.1">interface</span></span><span class="koboSpan" id="kobo.1008.1">{}) diag.Diagnostics {
    c :</span><span class="Code_Red"><span class="koboSpan" id="kobo.1009.1">=</span></span><span class="koboSpan" id="kobo.1010.1"> meta.(</span><span class="Code_Red"><span class="koboSpan" id="kobo.1011.1">*</span></span><span class="koboSpan" id="kobo.1012.1">apiClient).Client
    </span><span class="Code_Purple"><span class="koboSpan" id="kobo.1013.1">var</span></span><span class="koboSpan" id="kobo.1014.1"> m nb.Manufacturer
    name, ok :</span><span class="Code_Red"><span class="koboSpan" id="kobo.1015.1">=</span></span><span class="koboSpan" id="kobo.1016.1"> d.GetOk(</span><span class="Code_Red"><span class="koboSpan" id="kobo.1017.1">"name"</span></span><span class="koboSpan" id="kobo.1018.1">)
    n :</span><span class="Code_Red"><span class="koboSpan" id="kobo.1019.1">=</span></span><span class="koboSpan" id="kobo.1020.1"> name.(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.1021.1">string</span></span><span class="koboSpan" id="kobo.1022.1">)
    </span><span class="Code_Purple"><span class="koboSpan" id="kobo.1023.1">if</span></span><span class="koboSpan" id="kobo.1024.1"> ok {
        m.Name </span><span class="Code_Red"><span class="koboSpan" id="kobo.1025.1">=</span></span><span class="koboSpan" id="kobo.1026.1"> n
    }
</span><span class="Code_ligh-Blue"><span class="koboSpan" id="kobo.1027.1">    </span></span><span class="Code_Brown"><span class="koboSpan" id="kobo.1028.1">/* ... </span><span class="koboSpan" id="kobo.1028.2">&lt;omitted for brevity &gt; ... </span><span class="koboSpan" id="kobo.1028.3">*/</span></span><span class="koboSpan" id="kobo.1029.1">
    rsp, err :</span><span class="Code_Red"><span class="koboSpan" id="kobo.1030.1">=</span></span><span class="koboSpan" id="kobo.1031.1"> c.DcimManufacturersCreateWithResponse(
        ctx,
        nb.DcimManufacturersCreateJSONRequestBody(m))
</span><span class="Code_ligh-Blue"><span class="koboSpan" id="kobo.1032.1">    </span></span><span class="Code_Brown"><span class="koboSpan" id="kobo.1033.1">// process error</span></span>
<span class="Code_Brown"><span class="koboSpan" id="kobo.1034.1">    // process returned HTTP response</span></span><span class="koboSpan" id="kobo.1035.1">
    d.SetId(id.String())
    </span><span class="Code_Purple"><span class="koboSpan" id="kobo.1036.1">return</span></span><span class="koboSpan" id="kobo.1037.1"> resourceManufacturerRead(ctx, d, meta)
}</span></pre>
<p><span class="koboSpan" id="kobo.1038.1">Typically, we don’t define all optional fields when we create a new object. </span><span class="koboSpan" id="kobo.1038.2">A remote provider assigns the unique ID and initializes default values as it creates a new object. </span><span class="koboSpan" id="kobo.1038.3">Some platforms return</span><a id="_idIndexMarker680"/><span class="koboSpan" id="kobo.1039.1"> the newly created object back, but there is no guarantee of that. </span><span class="koboSpan" id="kobo.1039.2">Hence, it’s a common pattern in Terraform provider implementations to call a read function at the end of the create function to synchronize and update a </span><span class="No-Break"><span class="koboSpan" id="kobo.1040.1">local state.</span></span></p>
<h3><span class="koboSpan" id="kobo.1041.1">The read operation</span></h3>
<p><span class="koboSpan" id="kobo.1042.1">The read function updates the local state to reflect the latest state of an upstream resource. </span><span class="koboSpan" id="kobo.1042.2">We’ve seen in the preceding</span><a id="_idIndexMarker681"/><span class="koboSpan" id="kobo.1043.1"> example how the create function calls the read at the end of its execution to update the state of a newly </span><span class="No-Break"><span class="koboSpan" id="kobo.1044.1">created object.</span></span></p>
<p><span class="koboSpan" id="kobo.1045.1">But the most important use of read is to detect configuration drift. </span><span class="koboSpan" id="kobo.1045.2">When you do </span><strong class="source-inline"><span class="koboSpan" id="kobo.1046.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1047.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1048.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1049.1">, read is the first thing that Terraform executes and its goal is to retrieve the current upstream state and compare it with the state file. </span><span class="koboSpan" id="kobo.1049.2">This allows Terraform to understand whether users have manually changed a remote object, so it needs to reconcile its state, or whether it’s up to date and no updates </span><span class="No-Break"><span class="koboSpan" id="kobo.1050.1">are necessary.</span></span></p>
<p><span class="koboSpan" id="kobo.1051.1">Read has the same signature as the rest of the CRUD functions, which means it gets the latest version of a</span><a id="_idIndexMarker682"/><span class="koboSpan" id="kobo.1052.1"> managed resource as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1053.1">*schema.ResourceData</span></strong><span class="koboSpan" id="kobo.1054.1"> and an API client stored in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1055.1">meta</span></strong><span class="koboSpan" id="kobo.1056.1">. </span><span class="koboSpan" id="kobo.1056.2">The first thing we need to do in this function is fetch the </span><span class="No-Break"><span class="koboSpan" id="kobo.1057.1">upstream object:</span></span></p>
<pre class="source-code"><span class="Code_Purple"><span class="koboSpan" id="kobo.1058.1">import</span></span> <span class="Code_Red"><span class="koboSpan" id="kobo.1059.1">"github.com/deepmap/oapi-codegen/pkg/types"</span></span>
<span class="Code_Purple"><span class="koboSpan" id="kobo.1060.1">func</span></span><span class="koboSpan" id="kobo.1061.1"> resourceManufacturerRead(ctx context.Context, d </span><span class="Code_Red"><span class="koboSpan" id="kobo.1062.1">*</span></span><span class="koboSpan" id="kobo.1063.1">schema.ResourceData, meta </span><span class="Code_Purple"><span class="koboSpan" id="kobo.1064.1">interface</span></span><span class="koboSpan" id="kobo.1065.1">{}) diag.Diagnostics {
    c :</span><span class="Code_Red"><span class="koboSpan" id="kobo.1066.1">=</span></span><span class="koboSpan" id="kobo.1067.1"> meta.(</span><span class="Code_Red"><span class="koboSpan" id="kobo.1068.1">*</span></span><span class="koboSpan" id="kobo.1069.1">apiClient).Client
    id :</span><span class="Code_Red"><span class="koboSpan" id="kobo.1070.1">=</span></span><span class="koboSpan" id="kobo.1071.1"> d.Get(</span><span class="Code_Red"><span class="koboSpan" id="kobo.1072.1">"id"</span></span><span class="koboSpan" id="kobo.1073.1">).(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.1074.1">string</span></span><span class="koboSpan" id="kobo.1075.1">)
    rsp, err :</span><span class="Code_Red"><span class="koboSpan" id="kobo.1076.1">=</span></span><span class="koboSpan" id="kobo.1077.1"> c.DcimManufacturersListWithResponse(
        ctx,
        </span><span class="Code_Red"><span class="koboSpan" id="kobo.1078.1">&amp;</span></span><span class="koboSpan" id="kobo.1079.1">nb.DcimManufacturersListParams{
            IdIe: </span><span class="Code_Red"><span class="koboSpan" id="kobo.1080.1">&amp;</span></span><span class="koboSpan" id="kobo.1081.1">[]types.UUID{types.UUID(id)},
        })
  </span><span class="Code_Brown"><span class="koboSpan" id="kobo.1082.1">/* ... </span><span class="koboSpan" id="kobo.1082.2">&lt;continues next &gt; ... </span><span class="koboSpan" id="kobo.1082.3">*/</span></span><span class="koboSpan" id="kobo.1083.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.1084.1">We use the data we get back to update the local </span><span class="No-Break"><span class="koboSpan" id="kobo.1085.1">Terraform state:</span></span></p>
<pre class="source-code"><span class="Code_Purple"><span class="koboSpan" id="kobo.1086.1">func</span></span><span class="koboSpan" id="kobo.1087.1"> resourceManufacturerRead(ctx context.Context, d </span><span class="Code_Red"><span class="koboSpan" id="kobo.1088.1">*</span></span><span class="koboSpan" id="kobo.1089.1">schema.ResourceData, meta </span><span class="Code_Purple"><span class="koboSpan" id="kobo.1090.1">interface</span></span><span class="koboSpan" id="kobo.1091.1">{}) diag.Diagnostics {
    </span><span class="Code_Brown"><span class="koboSpan" id="kobo.1092.1">/* ... </span><span class="koboSpan" id="kobo.1092.2">&lt;continues from before &gt; ... </span><span class="koboSpan" id="kobo.1092.3">*/</span></span><span class="koboSpan" id="kobo.1093.1">
    d.Set(</span><span class="Code_Red"><span class="koboSpan" id="kobo.1094.1">"name"</span></span><span class="koboSpan" id="kobo.1095.1">, item[</span><span class="Code_Red"><span class="koboSpan" id="kobo.1096.1">"name"</span></span><span class="koboSpan" id="kobo.1097.1">].(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.1098.1">string</span></span><span class="koboSpan" id="kobo.1099.1">))
    d.Set(</span><span class="Code_Red"><span class="koboSpan" id="kobo.1100.1">"created"</span></span><span class="koboSpan" id="kobo.1101.1">, item[</span><span class="Code_Red"><span class="koboSpan" id="kobo.1102.1">"created"</span></span><span class="koboSpan" id="kobo.1103.1">].(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.1104.1">string</span></span><span class="koboSpan" id="kobo.1105.1">))
    d.Set(</span><span class="Code_Red"><span class="koboSpan" id="kobo.1106.1">"description"</span></span><span class="koboSpan" id="kobo.1107.1">, item[</span><span class="Code_Red"><span class="koboSpan" id="kobo.1108.1">"description"</span></span><span class="koboSpan" id="kobo.1109.1">].(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.1110.1">string</span></span><span class="koboSpan" id="kobo.1111.1">))
    d.Set(</span><span class="Code_Red"><span class="koboSpan" id="kobo.1112.1">"display"</span></span><span class="koboSpan" id="kobo.1113.1">, item[</span><span class="Code_Red"><span class="koboSpan" id="kobo.1114.1">"display"</span></span><span class="koboSpan" id="kobo.1115.1">].(</span><span class="Code_Purple"><span class="koboSpan" id="kobo.1116.1">string</span></span><span class="koboSpan" id="kobo.1117.1">))
    </span><span class="Code_Brown"><span class="koboSpan" id="kobo.1118.1">/* ... </span><span class="koboSpan" id="kobo.1118.2">&lt;omitted for brevity &gt; ... </span><span class="koboSpan" id="kobo.1118.3">*/</span></span><span class="koboSpan" id="kobo.1119.1">
    </span><span class="Code_Purple"><span class="koboSpan" id="kobo.1120.1">return</span></span><span class="koboSpan" id="kobo.1121.1"> diags
}</span></pre>
<p><span class="koboSpan" id="kobo.1122.1">At this stage, our local state should be </span><a id="_idIndexMarker683"/><span class="koboSpan" id="kobo.1123.1">in sync with the upstream and Terraform can decide whether any changes are necessary as </span><span class="No-Break"><span class="koboSpan" id="kobo.1124.1">a result.</span></span></p>
<h3><span class="koboSpan" id="kobo.1125.1">Remaining implementations</span></h3>
<p><span class="koboSpan" id="kobo.1126.1">In this chapter, we only </span><a id="_idIndexMarker684"/><span class="koboSpan" id="kobo.1127.1">cover a subset of the Nautobot provider code. </span><span class="koboSpan" id="kobo.1127.2">The remaining sections we need to implement include </span><span class="No-Break"><span class="koboSpan" id="kobo.1128.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1129.1">The resource </span><strong class="bold"><span class="koboSpan" id="kobo.1130.1">update</span></strong><span class="koboSpan" id="kobo.1131.1"> and </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1132.1">delete</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1133.1"> functions</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1134.1">Data </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1135.1">source</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1136.1"> implementation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1137.1">For the sake of brevity, we don’t include this code in the book, but the full implementation for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1138.1">Manufacturer</span></strong><span class="koboSpan" id="kobo.1139.1"> resource and data source is available in our demo Nautobot provider repository (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1140.1">Further reading</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1141.1">).</span></span></p>
<h2 id="_idParaDest-174"><a id="_idTextAnchor173"/><span class="koboSpan" id="kobo.1142.1">Networking providers</span></h2>
<p><span class="koboSpan" id="kobo.1143.1">Writing a provider and</span><a id="_idIndexMarker685"/><span class="koboSpan" id="kobo.1144.1"> keeping it up to date is a major undertaking. </span><span class="koboSpan" id="kobo.1144.2">At the beginning of this section, we mentioned that Terraform has several providers in the networking category of the Terraform registry (see </span><em class="italic"><span class="koboSpan" id="kobo.1145.1">Further reading</span></em><span class="koboSpan" id="kobo.1146.1">). </span><span class="koboSpan" id="kobo.1146.2">We invite you to explore them and always check whether there’s an existing provider before implementing </span><span class="No-Break"><span class="koboSpan" id="kobo.1147.1">your own.</span></span></p>
<p><span class="koboSpan" id="kobo.1148.1">Terraform’s guarantees of declarative configuration and state management are very appealing to network engineers trying to adopt DevOps and GitOps practices. </span><span class="koboSpan" id="kobo.1148.2">As the interest grows, so does the number of new network-related providers, with the following notable </span><span class="No-Break"><span class="koboSpan" id="kobo.1149.1">recent additions:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1150.1">JUNOS Terraform Automation Framework</span></strong><span class="koboSpan" id="kobo.1151.1"> (see </span><em class="italic"><span class="koboSpan" id="kobo.1152.1">Further reading</span></em><span class="koboSpan" id="kobo.1153.1">): Allows you to create a custom JunOS Terraform </span><a id="_idIndexMarker686"/><span class="koboSpan" id="kobo.1154.1">provider from </span><span class="No-Break"><span class="koboSpan" id="kobo.1155.1">YANG files</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1156.1">Terraform Provider for Cisco IOS XE</span></strong><span class="koboSpan" id="kobo.1157.1"> (see </span><em class="italic"><span class="koboSpan" id="kobo.1158.1">Further reading</span></em><span class="koboSpan" id="kobo.1159.1">): Manages the configuration of Cisco </span><a id="_idIndexMarker687"/><span class="koboSpan" id="kobo.1160.1">Catalyst IOS XE devices including switches, routers, and wireless </span><span class="No-Break"><span class="koboSpan" id="kobo.1161.1">LAN controllers</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1162.1">terraform-provider-junos</span></strong><span class="koboSpan" id="kobo.1163.1"> (see </span><em class="italic"><span class="koboSpan" id="kobo.1164.1">Further reading</span></em><span class="koboSpan" id="kobo.1165.1">): An unofficial Terraform provider for Junos OS devices with</span><a id="_idIndexMarker688"/><span class="koboSpan" id="kobo.1166.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.1167.1">NETCONF protocol</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1168.1">terraform-provider-ciscoasa</span></strong><span class="koboSpan" id="kobo.1169.1"> (see </span><em class="italic"><span class="koboSpan" id="kobo.1170.1">Further reading</span></em><span class="koboSpan" id="kobo.1171.1">): DevNet </span><a id="_idIndexMarker689"/><span class="koboSpan" id="kobo.1172.1">provider to configure Cisco ASA </span><span class="No-Break"><span class="koboSpan" id="kobo.1173.1">firewall rules</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1174.1">This completes the</span><a id="_idIndexMarker690"/><span class="koboSpan" id="kobo.1175.1"> overview of Terraform and its network-related use cases. </span><span class="koboSpan" id="kobo.1175.2">We hope that its adoption continues to increase and the number of networking providers grows. </span><span class="koboSpan" id="kobo.1175.3">In the next section, we wrap up with a brief overview of a few other </span><span class="No-Break"><span class="koboSpan" id="kobo.1176.1">automation frameworks.</span></span></p>
<h1 id="_idParaDest-175"><a id="_idTextAnchor174"/><span class="koboSpan" id="kobo.1177.1">Other automation frameworks</span></h1>
<p><span class="koboSpan" id="kobo.1178.1">Our industry has many</span><a id="_idIndexMarker691"/><span class="koboSpan" id="kobo.1179.1"> more automation frameworks and solutions that we would have liked to cover in this chapter. </span><span class="koboSpan" id="kobo.1179.2">The best we can do is just scratch the surface, leaving much of the exploration up to you. </span><span class="koboSpan" id="kobo.1179.3">At the same time, we don’t want to leave you thinking there’s nothing out there besides Ansible and Terraform. </span><span class="koboSpan" id="kobo.1179.4">This section gives you an overview of other automation frameworks and solutions that you can use or adapt to use within a </span><span class="No-Break"><span class="koboSpan" id="kobo.1180.1">networking context.</span></span></p>
<h2 id="_idParaDest-176"><a id="_idTextAnchor175"/><span class="koboSpan" id="kobo.1181.1">Gornir</span></h2>
<p><span class="koboSpan" id="kobo.1182.1">Nornir (see </span><em class="italic"><span class="koboSpan" id="kobo.1183.1">Further reading</span></em><span class="koboSpan" id="kobo.1184.1">) is a popular</span><a id="_idIndexMarker692"/><span class="koboSpan" id="kobo.1185.1"> network automation framework for Python that offers a pure programming experience by ditching DSL in favor of the Python API. </span><span class="koboSpan" id="kobo.1185.2">It has </span><a id="_idIndexMarker693"/><span class="koboSpan" id="kobo.1186.1">a pluggable architecture where you can replace or extend almost any element of the framework, from inventory to device connections. </span><span class="koboSpan" id="kobo.1186.2">It also has a flexible way to parallelize groups of tasks without having to deal with Python’s concurrency </span><span class="No-Break"><span class="koboSpan" id="kobo.1187.1">primitives directly.</span></span></p>
<p><span class="koboSpan" id="kobo.1188.1">Gornir (see </span><em class="italic"><span class="koboSpan" id="kobo.1189.1">Further reading</span></em><span class="koboSpan" id="kobo.1190.1">) is a Nornir implementation</span><a id="_idIndexMarker694"/><span class="koboSpan" id="kobo.1191.1"> in Go. </span><span class="koboSpan" id="kobo.1191.2">Keeping with the same principles, it offers things such as inventory management, concurrent execution of tasks, and pluggable connection drivers. </span><span class="koboSpan" id="kobo.1191.3">Gornir ships with a minimal set of drivers, but its core provides Go interfaces to improve upon and extend this feature. </span><span class="koboSpan" id="kobo.1191.4">If you’re coming to Go from Python and are </span><a id="_idIndexMarker695"/><span class="koboSpan" id="kobo.1192.1">familiar with Nornir, Gornir may offer a very smooth transition through a familiar API </span><span class="No-Break"><span class="koboSpan" id="kobo.1193.1">and workflows.</span></span></p>
<h2 id="_idParaDest-177"><a id="_idTextAnchor176"/><span class="koboSpan" id="kobo.1194.1">Consul-Terraform-Sync</span></h2>
<p><span class="koboSpan" id="kobo.1195.1">In the preceding section, we examined how you can use Terraform to manage resources declaratively on a remote target, using Nautobot as an example. </span><span class="koboSpan" id="kobo.1195.2">Hashicorp, the same company behind Terraform, has developed another automation solution that builds on top of it. </span><span class="koboSpan" id="kobo.1195.3">It’s called </span><a id="_idIndexMarker696"/><span class="koboSpan" id="kobo.1196.1">Consul-Terraform-Sync (see </span><em class="italic"><span class="koboSpan" id="kobo.1197.1">Further reading</span></em><span class="koboSpan" id="kobo.1198.1">) and it enables automatic infrastructure management by combining Terraform with Consul and linking them together with a </span><span class="No-Break"><span class="koboSpan" id="kobo.1199.1">synchronization agent.</span></span></p>
<p><span class="koboSpan" id="kobo.1200.1">Consul is a</span><a id="_idIndexMarker697"/><span class="koboSpan" id="kobo.1201.1"> distributed key/value store </span><a id="_idIndexMarker698"/><span class="koboSpan" id="kobo.1202.1">used for service discovery, load balancing, and access control. </span><span class="koboSpan" id="kobo.1202.2">It works by setting up a cluster of nodes that use the Raft consensus protocol to have a consistent view of their internal state. </span><span class="koboSpan" id="kobo.1202.3">Server nodes communicate with their clients and broadcast relevant updates to make sure clients have an up-to-date version of the relevant part of the internal state. </span><span class="koboSpan" id="kobo.1202.4">All this happens behind the scenes, with minimal configuration, which makes Consul a very popular choice for service discovery and </span><span class="No-Break"><span class="koboSpan" id="kobo.1203.1">data storage.</span></span></p>
<p><span class="koboSpan" id="kobo.1204.1">The main idea of the Consul-Terraform-Sync solution is to use Consul as a backend for Terraform configuration and state. </span><span class="koboSpan" id="kobo.1204.2">The synchronization agent connects to Consul, waits for updates, and automatically triggers Terraform reconciliation as it detects </span><span class="No-Break"><span class="koboSpan" id="kobo.1205.1">any changes.</span></span></p>
<p><span class="koboSpan" id="kobo.1206.1">Consul-Terraform-Sync allows you to automate Terraform deployments for any of these providers and ensures that your state always matches your intent thanks to the automated </span><span class="No-Break"><span class="koboSpan" id="kobo.1207.1">reconciliation process.</span></span></p>
<h2 id="_idParaDest-178"><a id="_idTextAnchor177"/><span class="koboSpan" id="kobo.1208.1">mgmt</span></h2>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1209.1">mgmt</span></strong><span class="koboSpan" id="kobo.1210.1"> (see </span><em class="italic"><span class="koboSpan" id="kobo.1211.1">Further reading</span></em><span class="koboSpan" id="kobo.1212.1">) is another </span><a id="_idIndexMarker699"/><span class="koboSpan" id="kobo.1213.1">infrastructure automation and management framework written completely in Go. </span><span class="koboSpan" id="kobo.1213.2">It has its</span><a id="_idIndexMarker700"/><span class="koboSpan" id="kobo.1214.1"> own DSL and synchronizes its state using a baked-in etcd cluster. </span><span class="koboSpan" id="kobo.1214.2">It uses a few interesting ideas, such as a declarative and functional DSL, resource graphs, and dynamic state transitions triggered by closed-loop feedback. </span><span class="koboSpan" id="kobo.1214.3">Just like Gornir, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1215.1">mgmt</span></strong><span class="koboSpan" id="kobo.1216.1"> ships with a set of plugins that users can extend, but none of these plugins is specifically for network devices since the main use case for mgmt is Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.1217.1">server management.</span></span></p>
<h2 id="_idParaDest-179"><a id="_idTextAnchor178"/><span class="koboSpan" id="kobo.1218.1">Looking into the future</span></h2>
<p><span class="koboSpan" id="kobo.1219.1">In this chapter, we have covered popular network automation frameworks in use today. </span><span class="koboSpan" id="kobo.1219.2">All these frameworks are at a different </span><a id="_idIndexMarker701"/><span class="koboSpan" id="kobo.1220.1">stage of development—some have already reached their peak while others are still crossing the chasm (see </span><em class="italic"><span class="koboSpan" id="kobo.1221.1">Further reading</span></em><span class="koboSpan" id="kobo.1222.1">). </span><span class="koboSpan" id="kobo.1222.2">But it’s important to remember that automation frameworks are not a solved problem with well-established projects and well-understood workflows. </span><span class="koboSpan" id="kobo.1222.3">This field is constantly developing, and new automation approaches are emerging on </span><span class="No-Break"><span class="koboSpan" id="kobo.1223.1">the horizon.</span></span></p>
<p><span class="koboSpan" id="kobo.1224.1">These alternative approaches do not resemble what we had seen before. </span><span class="koboSpan" id="kobo.1224.2">One big trend that we’re seeing lately is the departure from an imperative automation paradigm, where a human operator manually triggers actions and tasks. </span><span class="koboSpan" id="kobo.1224.3">We briefly discussed this trend in </span><a href="B16971_05.xhtml#_idTextAnchor128"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1225.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.1226.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1227.1">Network Automation</span></em><span class="koboSpan" id="kobo.1228.1">, and we want to revisit it here to show how the </span><em class="italic"><span class="koboSpan" id="kobo.1229.1">closed-loop</span></em><span class="koboSpan" id="kobo.1230.1"> automation approach changes the landscape of infrastructure management systems. </span><span class="koboSpan" id="kobo.1230.2">Most modern </span><a id="_idIndexMarker702"/><span class="koboSpan" id="kobo.1231.1">automation frameworks develop into systems that exhibit some or all the </span><span class="No-Break"><span class="koboSpan" id="kobo.1232.1">following characteristics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1233.1">Focus on the complete life cycle management of a system as opposed to individual stages, such as bootstrapping, provisioning, </span><span class="No-Break"><span class="koboSpan" id="kobo.1234.1">or decommissioning.</span></span></li>
<li><span class="koboSpan" id="kobo.1235.1">Exclusive use of declarative state definition and automatic reconciliation, or self-healing </span><span class="No-Break"><span class="koboSpan" id="kobo.1236.1">implemented internally.</span></span></li>
<li><span class="koboSpan" id="kobo.1237.1">Separation of state definitions from the platform managing this state through practices such </span><span class="No-Break"><span class="koboSpan" id="kobo.1238.1">as GitOps.</span></span></li>
<li><span class="koboSpan" id="kobo.1239.1">Offer a cloud-native self-service experience via APIs, reducing the friction in consuming of these services both manually </span><span class="No-Break"><span class="koboSpan" id="kobo.1240.1">and programmatically.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1241.1">We’re currently at a point when these systems and their building blocks are becoming a reality, with some notable examples including Crossplane, Nokia Edge Network Controller, and Anthos Config Sync. </span><span class="koboSpan" id="kobo.1241.2">They build these systems as Kubernetes controllers, leveraging the Operator model, allowing them to expose their APIs in a standard way, so other systems can talk to them with the same set of tools. </span><span class="koboSpan" id="kobo.1241.3">We still don’t know whether these systems could become mainstream and displace the incumbent frameworks, since they increase the level of complexity and they introduce a steep learning curve. </span><span class="koboSpan" id="kobo.1241.4">Regardless of that, it’s an area to explore, like other potential new trends that might develop, since infrastructure management is far from being a </span><span class="No-Break"><span class="koboSpan" id="kobo.1242.1">solved problem.</span></span></p>
<h1 id="_idParaDest-180"><a id="_idTextAnchor179"/><span class="koboSpan" id="kobo.1243.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1244.1">Whether to choose Ansible, Terraform, or a programming language to solve a particular use case depends on many variables. </span><span class="koboSpan" id="kobo.1244.2">But don’t fall into the trap of looking at this as a binary decision. </span><span class="koboSpan" id="kobo.1244.3">Most times, different technologies complement each other to offer solutions, as we showed in this chapter. </span><span class="koboSpan" id="kobo.1244.4">In the next chapter, we will explore newer and more advanced techniques to interact with networking devices </span><span class="No-Break"><span class="koboSpan" id="kobo.1245.1">and Go.</span></span></p>
<h1 id="_idParaDest-181"><a id="_idTextAnchor180"/><span class="koboSpan" id="kobo.1246.1">Further reading</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.1247.1">This book’s GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.1248.1">repository: </span></span><span class="No-Break"><span class="koboSpan" id="kobo.1249.1">https://github.com/PacktPublishing/Network-Automation-with-Go</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1250.1">Playbook: </span></span><span class="No-Break"><span class="koboSpan" id="kobo.1251.1">https://github.com/PacktPublishing/Network-Automation-with-Go/blob/main/ch07/ansible/playbook.yml</span></span></li>
<li><span class="koboSpan" id="kobo.1252.1">Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.1253.1">registry: </span></span><a href="https://registry.terraform.io/browse/providers?category=networking "><span class="No-Break"><span class="koboSpan" id="kobo.1254.1">https://registry.terraform.io/browse/providers?category=networking</span></span></a></li>
<li><span class="koboSpan" id="kobo.1255.1">terraform-provider-scaffolding </span><span class="No-Break"><span class="koboSpan" id="kobo.1256.1">project: </span></span><a href="https://github.com/hashicorp/terraform-provider-scaffolding "><span class="No-Break"><span class="koboSpan" id="kobo.1257.1">https://github.com/hashicorp/terraform-provider-scaffolding</span></span></a></li>
<li><span class="koboSpan" id="kobo.1258.1">Provider </span><span class="No-Break"><span class="koboSpan" id="kobo.1259.1">documentation: </span></span><a href="https://registry.terraform.io/providers/nleiva/nautobot/latest/docs?pollNotifications=true "><span class="No-Break"><span class="koboSpan" id="kobo.1260.1">https://registry.terraform.io/providers/nleiva/nautobot/latest/docs?pollNotifications=true</span></span></a></li>
<li><span class="koboSpan" id="kobo.1261.1">Provider’s internal </span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1">code: </span></span><a href="https://github.com/nleiva/terraform-provider-nautobot/blob/main/internal/provider/provider.go "><span class="No-Break"><span class="koboSpan" id="kobo.1263.1">https://github.com/nleiva/terraform-provider-nautobot/blob/main/internal/provider/provider.go</span></span></a></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1264.1">resource_manufacturer.go</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1265.1">: </span></span><a href="https://github.com/nleiva/terraform-provider-nautobot/blob/main/internal/provider/resource_manufacturer.go "><span class="No-Break"><span class="koboSpan" id="kobo.1266.1">https://github.com/nleiva/terraform-provider-nautobot/blob/main/internal/provider/resource_manufacturer.go</span></span></a></li>
<li><span class="koboSpan" id="kobo.1267.1">Nautobot provider </span><span class="No-Break"><span class="koboSpan" id="kobo.1268.1">repository: </span></span><a href="https://github.com/nleiva/terraform-provider-nautobot "><span class="No-Break"><span class="koboSpan" id="kobo.1269.1">https://github.com/nleiva/terraform-provider-nautobot</span></span></a></li>
<li><span class="koboSpan" id="kobo.1270.1">JUNOS Terraform Automation </span><span class="No-Break"><span class="koboSpan" id="kobo.1271.1">Framework: </span></span><a href="https://github.com/Juniper/junos-terraform "><span class="No-Break"><span class="koboSpan" id="kobo.1272.1">https://github.com/Juniper/junos-terraform</span></span></a></li>
<li><span class="koboSpan" id="kobo.1273.1">Terraform Provider for Cisco IOS </span><span class="No-Break"><span class="koboSpan" id="kobo.1274.1">XE: </span></span><a href="https://github.com/CiscoDevNet/terraform-provider-iosxe "><span class="No-Break"><span class="koboSpan" id="kobo.1275.1">https://github.com/CiscoDevNet/terraform-provider-iosxe</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1276.1">terraform-provider-junos: </span></span><a href="https://github.com/jeremmfr/terraform-provider-junos "><span class="No-Break"><span class="koboSpan" id="kobo.1277.1">https://github.com/jeremmfr/terraform-provider-junos</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1278.1">terraform-provider-ciscoasa: </span></span><span class="No-Break"><span class="koboSpan" id="kobo.1279.1">https://github.com/CiscoDevNet/terraform-provider-ciscoasa</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1280.1">Nornir: </span></span><a href="https://github.com/nornir-automation/nornir/ "><span class="No-Break"><span class="koboSpan" id="kobo.1281.1">https://github.com/nornir-automation/nornir/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1282.1">Gornir: </span></span><a href="https://github.com/nornir-automation/gornir "><span class="No-Break"><span class="koboSpan" id="kobo.1283.1">https://github.com/nornir-automation/gornir</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1284.1">Consul-Terraform-Sync: </span></span><a href="https://learn.hashicorp.com/tutorials/consul/consul-terraform-sync-intro?in=consul/network-infrastructure-automation "><span class="No-Break"><span class="koboSpan" id="kobo.1285.1">https://learn.hashicorp.com/tutorials/consul/consul-terraform-sync-intro?in=consul/network-infrastructure-automation</span></span></a></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1286.1">mgmt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1287.1">: </span></span><a href="https://github.com/purpleidea/mgmt"><span class="No-Break"><span class="koboSpan" id="kobo.1288.1">https://github.com/purpleidea/mgmt</span></span></a></li>
<li><a href="https://en.wikipedia.org/wiki/Diffusion_of_innovations"><span class="No-Break"><span class="koboSpan" id="kobo.1289.1">https://en.wikipedia.org/wiki/Diffusion_of_innovations</span></span></a></li>
</ul>
</div>


<div class="Content" id="_idContainer066">
<h1 id="_idParaDest-182"><a id="_idTextAnchor181"/><span class="koboSpan" id="kobo.1.1">Part 3: Interacting with APIs</span></h1>
<p><span class="koboSpan" id="kobo.2.1">As the way that networks are built, deployed, and operated has evolved, new protocols and interfaces have emerged to facilitate machine-to-machine communication as an enabler of network automation. </span><span class="koboSpan" id="kobo.2.2">In these chapters, we will navigate through some of these new capabilities and how to take advantage of them </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">with Go.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">This part of the book comprises the </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">following chapters:</span></span></p>
<ul>
<li><a href="B16971_08.xhtml#_idTextAnchor182"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Network APIs</span></em></li>
<li><a href="B16971_09.xhtml#_idTextAnchor209"><em class="italic"><span class="koboSpan" id="kobo.9.1">Chapter 9</span></em></a><span class="koboSpan" id="kobo.10.1">, </span><em class="italic"><span class="koboSpan" id="kobo.11.1">OpenConfig </span></em></li>
<li><a href="B16971_10.xhtml#_idTextAnchor225"><em class="italic"><span class="koboSpan" id="kobo.12.1">Chapter 10</span></em></a><span class="koboSpan" id="kobo.13.1">, </span><em class="italic"><span class="koboSpan" id="kobo.14.1">Network Monitoring</span></em></li>
<li><a href="B16971_11.xhtml#_idTextAnchor247"><em class="italic"><span class="koboSpan" id="kobo.15.1">Chapter 11</span></em></a><span class="koboSpan" id="kobo.16.1">, </span><em class="italic"><span class="koboSpan" id="kobo.17.1">Expert Insights</span></em></li>
<li><a href="B16971_12.xhtml#_idTextAnchor279"><em class="italic"><span class="koboSpan" id="kobo.18.1">Chapter 12</span></em></a><span class="koboSpan" id="kobo.19.1">, </span><em class="italic"><span class="koboSpan" id="kobo.20.1">Appendix: Building a Testing Environment</span></em></li>
</ul>
</div>
<div>
<div id="_idContainer067">
</div>
</div>
</body></html>